import{r as a,c as e,o as t,A as l,s,a2 as n,g as o,E as c,e as u,w as i,_ as r,C as d,K as p,ae as v,i as f,f as g,h as m,j as b,F as y,G as k,H as _,k as h,T as w,u as C,q as T,M as A,n as j,t as x,a3 as N,V as S,l as $,m as M,J as q,x as I}from"./index-DZtLzZ3A.js";import{_ as z}from"./uni-load-more.BvkDUI9A.js";import{r as L}from"./uni-app.es.CpsDs8gT.js";import{a as R}from"./taskApplications.MAaxBfY8.js";import{t as E}from"./team.VNekZ19c.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const U=F({__name:"application",setup(F){const U=r.baseUrl,B=a(!1),D=a(!1),G=a(!1),H=a(1),V=a(10),J={contentdown:"上拉显示更多",contentrefresh:"正在加载...",contentnomore:"已经到底啦"},K=a("applicant"),O=a([{name:"我发起的",badge:0,role:"applicant"},{name:"待我处理",badge:0,role:"creator"}]),Y=a(0),P=a([{label:"全部",value:"all"},{label:"任务申请",value:"task"},{label:"队伍申请",value:"team"},{label:"徽章申请",value:"badge"}]),Q=e((()=>1===Y.value?P.value.filter((a=>"badge"!==a.value)):P.value)),W=a([{label:"全部",value:"all"},{label:"待处理",value:"pending"},{label:"已通过",value:"approved"},{label:"已拒绝",value:"rejected"},{label:"已取消",value:"canceled"}]),X=a([{label:"全部",value:"all"},{label:"未处理",value:"pending"},{label:"已处理",value:"processed"}]),Z=a("all"),aa=a("all"),ea=a([]),ta=e((()=>{let a=ea.value.map((a=>{let e="";switch(a.status){case"pending":e="待处理";break;case"approved":e="已通过";break;case"rejected":e="已拒绝";break;case"canceled":e="已取消";break;case"returned":e="已退回";break;default:e="未知状态"}return{...a,statusText:e}}));return"all"!==aa.value&&(a="processed"===aa.value?a.filter((a=>"approved"===a.status||"rejected"===a.status||"canceled"===a.status)):a.filter((a=>a.status===aa.value))),"all"!==Z.value&&(a=a.filter((a=>a.type===Z.value))),a}));t((()=>{let a={};if("h5"===l().platform)a=function(){const a={},e=window.location.search.substring(1).split("&");for(let t=0;t<e.length;t++){const l=e[t].split("=");a[decodeURIComponent(l[0])]=decodeURIComponent(l[1]||"")}return a}();else{const e=d();e&&e.proxy&&e.proxy.$mp&&e.proxy.$mp.query&&(a=e.proxy.$mp.query)}!function(a){if(console.log("处理URL参数:",a),void 0!==a.tab){const e=parseInt(a.tab);!isNaN(e)&&e>=0&&e<O.value.length&&da(e)}if(a.type){const e=a.type;["task","team","badge","all"].includes(e)&&(Z.value=e)}a.id&&(la.value=a.id)}(a),ua(),ca(!0)}));const la=a(null);function sa(){la.value&&setTimeout((()=>{const a=`.application-card[data-id="${la.value}"]`,e=p();e.select(a).boundingClientRect(),e.selectViewport().scrollOffset(),e.exec((a=>{a[0]&&(v({scrollTop:a[1].scrollTop+a[0].top-100,duration:300}),function(a){const e=document.querySelector(`.application-card[data-id="${a}"]`);if(!e)return;e.classList.add("highlight-application"),setTimeout((()=>{e.classList.remove("highlight-application")}),3e3)}(la.value))})),la.value=null}),500)}function na(a){return a&&a.type?"task"===a.type?a.taskTitle||"任务申请":"team"===a.type?a.teamName||"队伍申请":"badge"===a.type?a.badgeTitle||"徽章申请":"申请":"申请"}function oa(a){return"task"===a?"task-type":"team"===a?"team-type":"badge"===a?"badge-type":""}async function ca(a=!1){if(a&&(H.value=1,G.value=!1,ea.value=[]),!D.value){D.value=!0;try{0===Y.value?K.value="applicant":1===Y.value&&(K.value="creator"),"all"!==Z.value&&"task"!==Z.value||await async function(a){try{const e={pageNum:H.value,pageSize:V.value};"all"!==aa.value&&"processed"!==aa.value&&(e.status=aa.value),e.role=K.value;const t=await R.getTaskApplicationList(e);if(t&&200===t.code&&t.data){const e=(t.data.list||[]).map((a=>({...a,type:"task"})));a?("task"===Z.value||"all"===Z.value)&&(ea.value=e):ea.value=[...ea.value,...e],"task"===Z.value&&(G.value=!t.data.hasNext),console.log("任务申请列表:",e)}}catch(e){console.error("获取任务申请列表失败:",e),s({title:"获取任务申请失败",icon:"none"})}}(a),"all"!==Z.value&&"team"!==Z.value||await async function(a){try{const e={pageNum:H.value,pageSize:V.value};let t;if("all"!==aa.value&&"processed"!==aa.value&&(e.status=aa.value),"applicant"===K.value?t=await E.getMyApplications(e):"creator"!==K.value&&"leader"!==K.value||(t=await E.getTeamApplications(e)),t&&200===t.code&&t.data){const e=(t.data.list||[]).map((a=>({...a,type:"team"})));a?"team"===Z.value?ea.value=e:"all"===Z.value&&(ea.value=[...ea.value,...e]):ea.value=[...ea.value,...e],"team"===Z.value&&(G.value=!t.data.hasNext),console.log("队伍申请列表:",e)}}catch(e){console.error("获取队伍申请列表失败:",e),s({title:"获取队伍申请失败",icon:"none"})}}(a),"all"!==Z.value&&"badge"!==Z.value||0!==Y.value||await async function(a){try{const t={pageNum:H.value,pageSize:V.value};let l;"all"!==aa.value&&"processed"!==aa.value&&(t.status=aa.value);try{l=await n({url:`${U}/badge/approvals/my-applications`,method:"GET",data:t,header:{Authorization:`Bearer ${o("token")}`}})}catch(e){console.error("徽章申请请求失败:",e),l={statusCode:500,data:null}}if(200===l.statusCode&&l.data&&200===l.data.code){const e=(l.data.data.records||[]).map((a=>({...a,id:a.approvalId,type:"badge",status:a.currentStatus,appliedAt:a.createdAt,reviewedAt:a.updatedAt,message:a.reviewMessage,reviewNotes:a.adminFeedback,badgeTitle:"徽章申请 "+(a.requestedBadge?`#${a.requestedBadge}`:""),applicantName:"team"===a.applicantType?"团队申请":"个人申请"})));if(a?"badge"===Z.value?ea.value=e:"all"===Z.value&&(ea.value=[...ea.value,...e]):ea.value=[...ea.value,...e],"badge"===Z.value){const a=Math.ceil(l.data.data.total/V.value);G.value=H.value>=a}console.log("徽章申请列表:",e)}}catch(e){console.error("获取徽章申请列表失败:",e),s({title:"获取徽章申请失败",icon:"none"})}}(a),console.log("加载完成的应用列表数据：",ea.value),la.value&&sa()}catch(e){console.error("获取申请列表失败:",e),s({title:"网络异常，请稍后重试",icon:"none"})}finally{D.value=!1,B.value&&(B.value=!1)}}}async function ua(){try{const a={status:"pending",role:"creator",pageSize:1},e=await R.getTaskApplicationList(a),t={status:"pending",pageSize:1},l=await E.getTeamApplications(t);let s=0;if(e&&200===e.code&&e.data&&void 0!==e.data.pendingCount&&(s+=e.data.pendingCount),l&&200===l.code&&l.data)if(void 0!==l.data.pendingCount)s+=l.data.pendingCount;else if(void 0!==l.data.total)s+=l.data.total;else{s+=(l.data.list||[]).filter((a=>"pending"===a.status)).length}console.log("更新待处理数量角标:",s),O.value[1].badge=s}catch(a){console.error("获取待处理数量失败:",a)}}function ia(){B.value=!0,ua(),ca(!0)}function ra(){D.value||G.value||(H.value++,ca(!1))}function da(a){Y.value!==a&&(Y.value=a,aa.value="all",1===a&&"badge"===Z.value&&(Z.value="all"),0===a?K.value="applicant":1===a&&(K.value="creator"),ca(!0))}function pa(a){aa.value!==a&&(aa.value=a,ca(!0))}function va(a){switch(a){case"pending":return"status-pending";case"approved":return"status-approved";case"rejected":return"status-rejected";case"canceled":return"status-canceled";default:return""}}function fa(a){if(!a)return"-";try{const e=new Date(a),t=e.getFullYear(),l=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0");return`${t}-${l}-${s} ${n}:${String(e.getMinutes()).padStart(2,"0")}`}catch(e){return a}}async function ga(a,e,t){a&&t?"badge"!==t?S({title:"approved"===e?"通过申请":"拒绝申请",content:"approved"===e?"确定通过该申请吗？":"确定拒绝该申请吗？",success:async l=>{if(l.confirm)try{let l;if($({title:"处理中..."}),"task"===t)l=await R.updateTaskApplication(a,{status:e,reviewNotes:"approved"===e?"申请已通过":"申请已拒绝"});else{if("team"!==t)throw new Error("未知的申请类型");l=await E.handleApplication(a,{status:e,reviewNotes:"approved"===e?"申请已通过":"申请已拒绝"})}M(),l&&200===l.code&&l.data&&l.data.success?(s({title:"approved"===e?"已通过申请":"已拒绝申请",icon:"success"}),ca(!0),ua()):s({title:(null==l?void 0:l.message)||"操作失败",icon:"none"})}catch(n){M(),console.error("处理申请失败:",n),s({title:"网络异常，请稍后重试",icon:"none"})}}}):s({title:"徽章申请处理功能开发中",icon:"none"}):s({title:"参数错误",icon:"none"})}function ma(a){"task"===a.type?q({url:`/pages/task-square/detail?id=${a.taskId}`}):"team"===a.type?q({url:`/pages/team/detail?id=${a.teamId}`}):"badge"===a.type&&s({title:"徽章申请详情功能开发中",icon:"none"})}function ba(){w()}return(a,e)=>{const t=C,l=f,n=I,o=T,r=L(c("uni-load-more"),z),d=A;return g(),u(l,{class:"application-container"},{default:i((()=>[m(l,{class:"fixed-area"},{default:i((()=>[m(l,{class:"nav-bar"},{default:i((()=>[m(l,{class:"back-btn",onClick:ba},{default:i((()=>[m(t,{class:"iconfont icon-arrow-left"})])),_:1}),m(t,{class:"page-title"},{default:i((()=>[b("申请管理")])),_:1}),m(l,{class:"placeholder-right"})])),_:1}),m(l,{class:"tabs"},{default:i((()=>[(g(!0),y(_,null,k(O.value,((a,e)=>(g(),u(l,{key:e,class:j(["tab",{active:Y.value===e}]),onClick:a=>da(e)},{default:i((()=>[b(x(a.name)+" ",1),a.badge&&a.badge>0?(g(),u(l,{key:0,class:"badge"},{default:i((()=>[b(x(a.badge),1)])),_:2},1024)):h("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1}),m(l,{class:"filter-tabs"},{default:i((()=>[m(l,{class:"filter-options"},{default:i((()=>[(g(!0),y(_,null,k(Q.value,((a,e)=>(g(),u(l,{key:e,class:j(["filter-tab",{active:Z.value===a.value}]),onClick:e=>function(a){Z.value!==a&&(1!==Y.value||"badge"!==a?(Z.value=a,H.value=1,G.value=!1,ea.value=[],ca(!0)):s({title:"待处理列表中不包含徽章申请",icon:"none"}))}(a.value)},{default:i((()=>[b(x(a.label),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1}),m(l,{class:"filter-tabs status-tabs"},{default:i((()=>[m(l,{class:"filter-options"},{default:i((()=>[1===Y.value?(g(!0),y(_,{key:0},k(X.value,((a,e)=>(g(),u(l,{key:e,class:j(["filter-tab",{active:aa.value===a.value}]),onClick:e=>pa(a.value)},{default:i((()=>[b(x(a.label),1)])),_:2},1032,["class","onClick"])))),128)):(g(!0),y(_,{key:1},k(W.value,((a,e)=>(g(),u(l,{key:e,class:j(["filter-tab",{active:aa.value===a.value}]),onClick:e=>pa(a.value)},{default:i((()=>[b(x(a.label),1)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})])),_:1}),m(d,{class:"application-list","scroll-y":"","refresher-enabled":"",onRefresherrefresh:ia,"refresher-triggered":B.value,onScrolltolower:ra},{default:i((()=>[(g(!0),y(_,null,k(ta.value,((a,e)=>{return g(),u(l,{key:e,class:j(["application-card",[(o=a.type,o?"task"===o?"card-task":"team"===o?"card-team":"badge"===o?"card-badge":"card-task":"card-task"),va(a.status)]]),"data-id":a.id},{default:i((()=>[m(l,{class:j(["status-corner",va(a.status)])},{default:i((()=>[b(x(a.statusText),1)])),_:2},1032,["class"]),m(l,{class:"card-content"},{default:i((()=>[m(l,{class:"card-title"},{default:i((()=>[b(x(na(a))+" ",1),m(t,{class:j(["type-tag",oa(a.type)])},{default:i((()=>[b(x("task"===a.type?"任务":"team"===a.type?"队伍":"badge"===a.type?"徽章":"未知"),1)])),_:2},1032,["class"])])),_:2},1024),m(l,{class:"card-info"},{default:i((()=>["creator"===K.value||"leader"===K.value?(g(),u(l,{key:0,class:"info-item"},{default:i((()=>[m(t,{class:"info-label"},{default:i((()=>[b("申请人：")])),_:1}),m(t,{class:"info-value"},{default:i((()=>[b(x(a.applicantName)+" "+x(a.applicantMajor?"· "+a.applicantMajor:""),1)])),_:2},1024)])),_:2},1024)):h("",!0),"team"===a.type&&a.roleName?(g(),u(l,{key:1,class:"info-item"},{default:i((()=>[m(t,{class:"info-label"},{default:i((()=>[b("申请角色：")])),_:1}),m(t,{class:"info-value"},{default:i((()=>[b(x(a.roleName),1)])),_:2},1024)])),_:2},1024)):h("",!0),m(l,{class:"info-item"},{default:i((()=>[m(t,{class:"info-label"},{default:i((()=>[b("申请时间：")])),_:1}),m(t,{class:"info-value"},{default:i((()=>[b(x(fa(a.appliedAt)),1)])),_:2},1024)])),_:2},1024),a.message?(g(),u(l,{key:2,class:"info-item"},{default:i((()=>[m(t,{class:"info-label"},{default:i((()=>[b("申请理由：")])),_:1}),m(t,{class:"info-value"},{default:i((()=>[b(x(a.message),1)])),_:2},1024)])),_:2},1024)):h("",!0),a.reviewNotes&&"pending"!==a.status?(g(),u(l,{key:3,class:"info-item"},{default:i((()=>[m(t,{class:"info-label"},{default:i((()=>[b("审核备注：")])),_:1}),m(t,{class:"info-value"},{default:i((()=>[b(x(a.reviewNotes),1)])),_:2},1024)])),_:2},1024)):h("",!0)])),_:2},1024)])),_:2},1024),"creator"!==K.value&&"leader"!==K.value||"pending"!==a.status?"applicant"===K.value&&"pending"===a.status?(g(),u(l,{key:1,class:"card-footer"},{default:i((()=>[m(l,{class:"btn-group"},{default:i((()=>[m(n,{class:"btn btn-reject",onClick:N((e=>async function(a,e){a&&e?"badge"!==e?S({title:"取消申请",content:"确定要取消该申请吗？",success:async t=>{if(t.confirm)try{let t;if($({title:"处理中..."}),"task"===e)t=await R.cancelTaskApplication(a);else{if("team"!==e)throw new Error("未知的申请类型");t=await E.cancelApplication(a)}M(),t&&200===t.code&&t.data&&t.data.success?(s({title:"已取消申请",icon:"success"}),ca(!0),ua()):s({title:(null==t?void 0:t.message)||"操作失败",icon:"none"})}catch(l){M(),console.error("取消申请失败:",l),s({title:"网络异常，请稍后重试",icon:"none"})}}}):s({title:"徽章申请取消功能开发中",icon:"none"}):s({title:"参数错误",icon:"none"})}(a.id,a.type)),["stop"])},{default:i((()=>[b("取消申请")])),_:2},1032,["onClick"]),m(n,{class:"btn btn-detail",onClick:N((e=>ma(a)),["stop"])},{default:i((()=>[b("查看详情")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)):(g(),u(l,{key:2,class:"card-footer"},{default:i((()=>[m(l,{class:"btn-group"},{default:i((()=>[m(n,{class:"btn btn-detail",onClick:N((e=>ma(a)),["stop"])},{default:i((()=>[b("查看详情")])),_:2},1032,["onClick"])])),_:2},1024),a.reviewedAt?(g(),u(t,{key:0,class:"process-time"},{default:i((()=>[b("处理时间："+x(fa(a.reviewedAt)),1)])),_:2},1024)):h("",!0)])),_:2},1024)):(g(),u(l,{key:0,class:"card-footer"},{default:i((()=>[m(l,{class:"btn-group"},{default:i((()=>[m(n,{class:"btn btn-approve",onClick:N((e=>ga(a.id,"approved",a.type)),["stop"])},{default:i((()=>[b("通过")])),_:2},1032,["onClick"]),m(n,{class:"btn btn-reject",onClick:N((e=>ga(a.id,"rejected",a.type)),["stop"])},{default:i((()=>[b("拒绝")])),_:2},1032,["onClick"]),m(n,{class:"btn btn-detail",onClick:N((e=>ma(a)),["stop"])},{default:i((()=>[b("查看详情")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024))])),_:2},1032,["class","data-id"]);var o})),128)),0!==ta.value.length||D.value?h("",!0):(g(),u(l,{key:0,class:"empty-state"},{default:i((()=>[m(o,{class:"empty-image",src:"/static/images/empty.png",mode:"aspectFit"}),m(t,{class:"empty-text"},{default:i((()=>[b("暂无申请记录")])),_:1})])),_:1})),D.value&&!B.value?(g(),u(l,{key:1,class:"loading-more"},{default:i((()=>[m(r,{status:"loading",contentText:J})])),_:1})):h("",!0),G.value&&!D.value&&ta.value.length>0?(g(),u(l,{key:2,class:"no-more"},{default:i((()=>[m(r,{status:"noMore",contentText:J})])),_:1})):h("",!0),m(l,{class:"safe-area-bottom"})])),_:1},8,["refresher-triggered"])])),_:1})}}},[["__scopeId","data-v-760533ab"]]);export{U as default};
