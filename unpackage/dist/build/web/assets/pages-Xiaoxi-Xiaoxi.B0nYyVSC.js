import{r as e,c as a,o as t,ak as l,al as n,a9 as i,am as c,e as s,w as o,aa as u,an as r,s as d,ao as v,ap as f,i as p,f as m,h as g,j as y,k as _,n as h,t as k,F as b,G as T,H as w,Y as C,V as D,u as x,q as I,M as N,a3 as S,J as M,x as R}from"./index-DZtLzZ3A.js";import{_ as B}from"./_plugin-vue_export-helper.BCo6x5W8.js";const $=B({__name:"Xiaoxi",setup(B){const $=C(),A=e(!1),j=e("unread"),E=e(0),z=e([]),q=e([]),F=e({current:1,size:10,total:0,pages:0}),U=e(!1),L=e(!1),H=e(!0),Y=e(!1),G=e([]),J=a((()=>{const e="unread"===j.value?z.value:q.value;return e.length>0&&G.value.length===e.length}));function O(){Y.value=!Y.value,Y.value||(G.value=[])}function V(e){const a=G.value.indexOf(e);-1===a?G.value.push(e):G.value.splice(a,1)}function X(){const e="unread"===j.value?z.value:q.value;J.value?G.value=[]:G.value=e.map((e=>e.id))}function K(){0!==G.value.length?D({title:"删除通知",content:`确定要删除选中的${G.value.length}条通知吗？`,success:e=>{e.confirm&&(!async function(e){if(!e||0===e.length)return;try{U.value=!0;const a=await u.batchDeleteNotifications(e);200===a.code?(e.forEach((e=>{const a=z.value.findIndex((a=>a.id===e));-1!==a&&(z.value.splice(a,1),E.value--);const t=q.value.findIndex((a=>a.id===e));-1!==t&&q.value.splice(t,1)})),$&&$.globalData&&($.globalData.unreadNotificationCount=E.value,$.updateMessageBadge&&$.updateMessageBadge()),d({title:"删除成功",icon:"success"})):d({title:a.message||"删除失败",icon:"none"})}catch(a){console.error("批量删除通知失败:",a),d({title:"操作失败，请稍后重试",icon:"none"})}finally{U.value=!1}}(G.value),O())}}):d({title:"请先选择要删除的通知",icon:"none"})}function P(e){return{system_announcement:"/static/avatars/system.png",team_application_received:"/static/avatars/team.png",team_invite:"/static/avatars/team.png",task_application:"/static/avatars/task.png",task_update:"/static/avatars/task.png",badge_application:"/static/avatars/badge.png",friend_request:"/static/avatars/user.png"}[e]||"/static/avatars/system.png"}async function Q(){try{U.value=!0;const e=await u.markAllAsRead();200===e.code?(z.value.forEach((e=>{const a=q.value.findIndex((a=>a.id===e.id));-1!==a&&(q.value[a].read=!0)})),z.value=[],E.value=0,$&&$.resetUnreadNotificationCount&&$.resetUnreadNotificationCount(),d({title:"已全部标记为已读",icon:"success"})):d({title:e.message||"操作失败",icon:"none"})}catch(e){console.error("标记全部已读失败:",e),d({title:"操作失败，请稍后重试",icon:"none"})}finally{U.value=!1}}const W=["system_announcement","team_invite","task_application"];function Z(e){if(!e||!e.originalData)return;le(e.id),function(e){if(!e||!e.originalData||!W.includes(e.originalData.typeId))return;const a=`${e.type}：${e.message}`;if(window.speechSynthesis){const e=new SpeechSynthesisUtterance;e.text=a,e.lang="zh-CN",e.volume=.7,e.rate=1,e.pitch=1,window.speechSynthesis.speak(e)}}(e);const a=e.originalData.typeId,t=e.originalData.relatedId;if(console.log("准备导航，通知类型:",a,"关联ID:",t),"team_invite"===a||a.includes("team_application"))if("team_application_received"===a){console.log("收到队伍申请，正在跳转到待我处理标签页");const e=`/pages/application/application?tab=1&type=team&id=${t}`;console.log("跳转URL:",e),M({url:e,success:function(){console.log("跳转成功")},fail:function(e){console.error("跳转失败:",e)}})}else M({url:`/pages/application/application?tab=0&type=team&id=${t}`});else a.includes("task_application")||a.includes("task_update")?M({url:`/pages/application/application?type=task&id=${t}`}):M("system_announcement"===a?{url:`/pages/notification/detail?id=${e.id}`}:"badge_application"===a?{url:`/pages/application/application?type=badge&id=${t}`}:{url:"/pages/application/application"})}function ee(e,a){e.read||(e.isReading=!0,e.viewStartTime=Date.now(),e.viewTimer=setTimeout((()=>{le(e.id)}),2e3))}function ae(e){e.isReading=!1,e.viewTimer&&(clearTimeout(e.viewTimer),e.viewTimer=null),e.read||e.viewStartTime&&Date.now()-e.viewStartTime>1e3&&le(e.id)}function te(){if(Y.value)return;const e="unread"===j.value?z.value:q.value;document.querySelectorAll(".notification-item").forEach(((a,t)=>{if(t<e.length&&function(e){if(!e)return!1;const a=e.getBoundingClientRect(),t=window.innerHeight||document.documentElement.clientHeight;return a.top>=0&&a.bottom<=t&&a.height>0}(a)){const a=e[t];a.read||a.scrollTimer||(a.scrollTimer=setTimeout((()=>{le(a.id),a.scrollTimer=null}),3e3))}}))}async function le(e){const a=z.value.findIndex((a=>a.id===e));if(-1!==a)try{if(-1!==a){const e=z.value.splice(a,1)[0];e.read=!0,q.value.unshift(e),E.value--,$&&$.globalData&&($.globalData.unreadNotificationCount=Math.max(0,$.globalData.unreadNotificationCount-1),$.updateMessageBadge&&$.updateMessageBadge())}await u.markAsRead(e)}catch(t){console.error("标记已读失败:",t)}}async function ne(e=!1){if(!U.value)try{U.value=!0,e&&(F.value.current=1,L.value=!0);const a=await u.getNotificationList({pageNum:F.value.current,pageSize:F.value.size,onlyUnread:"unread"===j.value,onlyRead:"read"===j.value});if(200===a.code&&a.data){const t=(a.data.records||[]).map((e=>({id:e.id,type:e.typeName,message:e.content||e.title,time:ce(e.createdAt),avatar:P(e.typeId),read:e.isRead,actions:ie(e),originalData:e,isReading:!1,viewStartTime:null,viewTimer:null,scrollTimer:null})));if(F.value={current:a.data.current,size:a.data.size,total:a.data.total,pages:a.data.pages},H.value=F.value.current<F.value.pages,e)"unread"===j.value?z.value=t.filter((e=>!e.read)):"read"===j.value&&(q.value=t.filter((e=>e.read)));else if("unread"===j.value){const e=t.filter((e=>!e.read));z.value=[...z.value,...e]}else if("read"===j.value){const e=t.filter((e=>e.read));q.value=[...q.value,...e]}("unread"===j.value||e)&&(E.value="unread"===j.value?z.value.length:t.filter((e=>!e.read)).length,$&&$.globalData&&($.globalData.unreadNotificationCount=E.value,function(e){if(!$||!$.updateMessageBadge)return;try{$.updateMessageBadge()}catch(a){try{e>0?v({index:4,text:e.toString()}).catch((e=>{console.log("设置TabBar徽标失败，可能不在TabBar页面",e)})):f({index:4}).catch((e=>{console.log("移除TabBar徽标失败，可能不在TabBar页面",e)}))}catch(t){console.log("TabBar操作失败，可能不在TabBar页面")}}}(E.value)))}else d({title:a.message||"获取通知失败",icon:"none"})}catch(a){console.error("获取通知列表失败:",a),d({title:"获取通知失败",icon:"none"})}finally{U.value=!1,L.value=!1}}function ie(e){return e.typeId.includes("team_application")&&!e.isRead?[{name:"接受",type:"accept",primary:!0},{name:"拒绝",type:"reject",primary:!1}]:"team_invite"!==e.typeId||e.isRead?[{name:"查看",type:"view",primary:!0}]:[{name:"接受",type:"accept",primary:!0},{name:"拒绝",type:"reject",primary:!1}]}function ce(e){try{const a=new Date(e),t=new Date-a;if(t<6e4)return"刚刚";if(t<36e5)return Math.floor(t/6e4)+"分钟前";if(t<864e5)return Math.floor(t/36e5)+"小时前";if(t<2592e6)return Math.floor(t/864e5)+"天前";{const e=a.getFullYear(),t=String(a.getMonth()+1).padStart(2,"0");return`${e}-${t}-${String(a.getDate()).padStart(2,"0")}`}}catch(a){return console.error("格式化时间错误",a),e}}function se(e){j.value!==e&&(j.value=e,ne(!0))}function oe(){ne(!0)}function ue(){!U.value&&H.value&&(F.value.current++,ne(!1))}return t((()=>{ne(!0),function(){const e=setInterval((()=>{A.value=r.isConnected()}),5e3);i((()=>{clearInterval(e)}))}();const e=document.querySelector(".notification-list");e&&e.addEventListener("scroll",te),l("newNotification",(e=>{console.log("消息页面接收到新通知:",e),function(e){if(!e)return;const a={id:e.id,type:e.typeName,message:e.content||e.title,time:e.time||ce(e.createdAt||new Date),avatar:P(e.typeId),read:e.isRead||!1,actions:e.actions||ie(e),originalData:e,isReading:!1,viewStartTime:null,viewTimer:null,scrollTimer:null};a.read?-1===q.value.findIndex((e=>e.id===a.id))&&q.value.unshift(a):-1===z.value.findIndex((e=>e.id===a.id))&&(z.value.unshift(a),E.value++),function(){try{const e=n();e.src="/static/sounds/notification.mp3",e.play()}catch(e){console.log("播放通知提示音失败",e)}}()}(e)})),console.log("通知页面加载完成")})),i((()=>{const e=document.querySelector(".notification-list");e&&e.removeEventListener("scroll",te);[...z.value,...q.value].forEach((e=>{e.viewTimer&&clearTimeout(e.viewTimer),e.scrollTimer&&clearTimeout(e.scrollTimer)})),c("newNotification")})),(e,a)=>{const t=p,l=x,n=I,i=R,c=N;return m(),s(t,{class:"container"},{default:o((()=>[g(t,{class:"header"},{default:o((()=>[g(t,{class:"navbar"},{default:o((()=>[g(t,{class:"title"},{default:o((()=>[y("通知")])),_:1}),g(t,{class:"actions"},{default:o((()=>[Y.value?_("",!0):(m(),s(t,{key:0,class:"mark-read",onClick:Q},{default:o((()=>[g(l,{class:"iconfont icon-check"}),g(l,{class:"mark-text"},{default:o((()=>[y("全部标记为已读")])),_:1})])),_:1})),Y.value?(m(),s(t,{key:2,class:"edit-actions"},{default:o((()=>[g(t,{class:"cancel-btn",onClick:O},{default:o((()=>[g(l,null,{default:o((()=>[y("取消")])),_:1})])),_:1}),g(t,{class:"delete-btn",onClick:K},{default:o((()=>[g(l,{class:"iconfont icon-delete"}),g(l,null,{default:o((()=>[y("删除")])),_:1})])),_:1})])),_:1})):(m(),s(t,{key:1,class:"edit-btn",onClick:O},{default:o((()=>[g(l,{class:"iconfont icon-edit"}),g(l,{class:"edit-text"},{default:o((()=>[y("编辑")])),_:1})])),_:1}))])),_:1})])),_:1})])),_:1}),g(t,{class:"tabs"},{default:o((()=>[g(t,{class:h(["tab-item","unread"===j.value?"tab-active":""]),onClick:a[0]||(a[0]=e=>se("unread"))},{default:o((()=>[g(l,null,{default:o((()=>[y("未读")])),_:1}),E.value>0?(m(),s(l,{key:0,class:"badge"},{default:o((()=>[y(k(E.value),1)])),_:1})):_("",!0)])),_:1},8,["class"]),g(t,{class:h(["tab-item","read"===j.value?"tab-active":""]),onClick:a[1]||(a[1]=e=>se("read"))},{default:o((()=>[g(l,null,{default:o((()=>[y("已读")])),_:1})])),_:1},8,["class"])])),_:1}),g(c,{"scroll-y":"",class:"notification-list","refresher-enabled":"","refresher-triggered":L.value,onRefresherrefresh:oe,onScrolltolower:ue},{default:o((()=>["unread"===j.value?(m(),s(t,{key:0},{default:o((()=>[(m(!0),b(w,null,T(z.value,((e,a)=>(m(),s(t,{class:h(["notification-item unread",{"item-selected":Y.value&&G.value.includes(e.id),reading:e.isReading}]),key:a,onMouseenter:a=>!Y.value&&ee(e),onMouseleave:a=>!Y.value&&ae(e),onTouchstart:a=>!Y.value&&ee(e),onTouchend:a=>!Y.value&&ae(e)},{default:o((()=>[Y.value?(m(),s(t,{key:0,class:"select-box",onClick:S((a=>V(e.id)),["stop"])},{default:o((()=>[g(t,{class:h(["checkbox",{checked:G.value.includes(e.id)}])},{default:o((()=>[G.value.includes(e.id)?(m(),s(l,{key:0,class:"iconfont icon-check"})):_("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"])):_("",!0),g(t,{class:"notification-avatar"},{default:o((()=>[g(n,{src:e.avatar||"/static/default-avatar.png",mode:"aspectFill"},null,8,["src"])])),_:2},1024),g(t,{class:"notification-content",onClick:a=>Y.value?V(e.id):Z(e)},{default:o((()=>[g(t,{class:"notification-type"},{default:o((()=>[y(k(e.type),1)])),_:2},1024),g(t,{class:"notification-message"},{default:o((()=>[y(k(e.message),1)])),_:2},1024),g(t,{class:"notification-time"},{default:o((()=>[y(k(e.time),1)])),_:2},1024),!Y.value&&e.actions?(m(),s(t,{key:0,class:"notification-actions"},{default:o((()=>[(m(!0),b(w,null,T(e.actions,((a,t)=>(m(),s(i,{key:t,class:h(["action-btn",a.primary?"btn-primary":"btn-default"]),onClick:S((t=>function(e,a){const t=("unread"===j.value?z.value:q.value).find((e=>e.id===a));t&&("accept"===e?D({title:"接受申请",content:`确定接受此${t.type}？`,success:async function(e){var l,n;if(e.confirm)try{U.value=!0;const e=await u.handleNotificationAction(a,"accept",{relatedId:null==(l=t.originalData)?void 0:l.relatedId,relatedType:null==(n=t.originalData)?void 0:n.relatedType});200===e.code?(removeNotification(a),d({title:"已接受",icon:"success"})):d({title:e.message||"操作失败",icon:"none"})}catch(i){console.error("接受操作失败:",i),d({title:"操作失败，请稍后重试",icon:"none"})}finally{U.value=!1}}}):"reject"===e?D({title:"拒绝申请",content:`确定拒绝此${t.type}？`,success:async function(e){var l,n;if(e.confirm)try{U.value=!0;const e=await u.handleNotificationAction(a,"reject",{relatedId:null==(l=t.originalData)?void 0:l.relatedId,relatedType:null==(n=t.originalData)?void 0:n.relatedType});200===e.code?(removeNotification(a),d({title:"已拒绝",icon:"none"})):d({title:e.message||"操作失败",icon:"none"})}catch(i){console.error("拒绝操作失败:",i),d({title:"操作失败，请稍后重试",icon:"none"})}finally{U.value=!1}}}):"view"===e&&(Z(t),removeNotification(a)))}(a.type,e.id)),["stop"])},{default:o((()=>[y(k(a.name),1)])),_:2},1032,["class","onClick"])))),128))])),_:2},1024)):_("",!0)])),_:2},1032,["onClick"])])),_:2},1032,["class","onMouseenter","onMouseleave","onTouchstart","onTouchend"])))),128))])),_:1})):_("",!0),"read"===j.value?(m(),s(t,{key:1},{default:o((()=>[(m(!0),b(w,null,T(q.value,((e,a)=>(m(),s(t,{class:h(["notification-item read",{"item-selected":Y.value&&G.value.includes(e.id)}]),key:a},{default:o((()=>[Y.value?(m(),s(t,{key:0,class:"select-box",onClick:S((a=>V(e.id)),["stop"])},{default:o((()=>[g(t,{class:h(["checkbox",{checked:G.value.includes(e.id)}])},{default:o((()=>[G.value.includes(e.id)?(m(),s(l,{key:0,class:"iconfont icon-check"})):_("",!0)])),_:2},1032,["class"])])),_:2},1032,["onClick"])):_("",!0),g(t,{class:"notification-avatar"},{default:o((()=>[g(n,{src:e.avatar||"/static/default-avatar.png",mode:"aspectFill"},null,8,["src"])])),_:2},1024),g(t,{class:"notification-content",onClick:a=>Y.value?V(e.id):Z(e)},{default:o((()=>[g(t,{class:"notification-type"},{default:o((()=>[y(k(e.type),1)])),_:2},1024),g(t,{class:"notification-message"},{default:o((()=>[y(k(e.message),1)])),_:2},1024),g(t,{class:"notification-time"},{default:o((()=>[y(k(e.time),1)])),_:2},1024)])),_:2},1032,["onClick"])])),_:2},1032,["class"])))),128))])),_:1})):_("",!0),U.value&&!L.value?(m(),s(t,{key:2,class:"loading-more"},{default:o((()=>[g(l,null,{default:o((()=>[y("加载中...")])),_:1})])),_:1})):_("",!0),U.value||H.value||!("unread"===j.value?z.value.length>0:q.value.length>0)?_("",!0):(m(),s(t,{key:3,class:"no-more"},{default:o((()=>[g(l,null,{default:o((()=>[y("没有更多了")])),_:1})])),_:1})),!U.value&&"unread"===j.value&&0===z.value.length||"read"===j.value&&0===q.value.length?(m(),s(t,{key:4,class:"empty-state"},{default:o((()=>[g(n,{class:"empty-image",src:"/static/empty-notification.png",mode:"aspectFit"}),g(l,{class:"empty-text"},{default:o((()=>[y("暂无"+k("unread"===j.value?"未读":"已读")+"通知",1)])),_:1})])),_:1})):_("",!0)])),_:1},8,["refresher-triggered"]),Y.value?(m(),s(t,{key:0,class:"bottom-action-bar"},{default:o((()=>[g(t,{class:"select-all",onClick:X},{default:o((()=>[g(t,{class:h(["checkbox",{checked:J.value}])},{default:o((()=>[J.value?(m(),s(l,{key:0,class:"iconfont icon-check"})):_("",!0)])),_:1},8,["class"]),g(l,null,{default:o((()=>[y("全选")])),_:1})])),_:1}),g(t,{class:h(["batch-delete",{disabled:0===G.value.length}]),onClick:K},{default:o((()=>[g(l,null,{default:o((()=>[y("删除("+k(G.value.length)+")",1)])),_:1})])),_:1},8,["class"])])),_:1})):_("",!0)])),_:1})}}},[["__scopeId","data-v-aa7bed97"]]);export{$ as default};
