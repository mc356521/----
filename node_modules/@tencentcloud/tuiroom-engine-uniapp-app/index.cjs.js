function e(e,t,n,o){var i,s=arguments.length,a=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var r=e.length-1;r>=0;r--)(i=e[r])&&(a=(s<3?i(a):s>3?i(t,n,a):i(t,n))||a);return s>3&&a&&Object.defineProperty(t,n,a),a}function t(e,t,n,o){return new(n||(n=Promise))((function(i,s){function a(e){try{c(o.next(e))}catch(t){s(t)}}function r(e){try{c(o.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,r)}c((o=o.apply(e,t||[])).next())}))}var n,o,i,s,a,r,c,u,l,d,p,_,h,g,f,m,v,I,y,M,C,T,E,D,R,S,L,A;Object.defineProperty(exports,"__esModule",{value:!0}),"function"==typeof SuppressedError&&SuppressedError,exports.TUIErrorCode=void 0,(n=exports.TUIErrorCode||(exports.TUIErrorCode={}))[n.ERR_SUCC=0]="ERR_SUCC",n[n.ERR_FAILED=-1]="ERR_FAILED",n[n.ERR_FREQ_LIMIT=-2]="ERR_FREQ_LIMIT",n[n.ERR_REPEAT_OPERATION=-3]="ERR_REPEAT_OPERATION",n[n.ERR_SDKAPPID_NOT_FOUND=-1e3]="ERR_SDKAPPID_NOT_FOUND",n[n.ERR_INVALID_PARAMETER=-1001]="ERR_INVALID_PARAMETER",n[n.ERR_SDK_NOT_INITIALIZED=-1002]="ERR_SDK_NOT_INITIALIZED",n[n.ERR_PERMISSION_DENIED=-1003]="ERR_PERMISSION_DENIED",n[n.ERR_REQUIRE_PAYMENT=-1004]="ERR_REQUIRE_PAYMENT",n[n.ERR_CAMERA_START_FAILED=-1100]="ERR_CAMERA_START_FAILED",n[n.ERR_CAMERA_NOT_AUTHORIZED=-1101]="ERR_CAMERA_NOT_AUTHORIZED",n[n.ERR_CAMERA_OCCUPIED=-1102]="ERR_CAMERA_OCCUPIED",n[n.ERR_CAMERA_DEVICE_EMPTY=-1103]="ERR_CAMERA_DEVICE_EMPTY",n[n.ERR_MICROPHONE_START_FAILED=-1104]="ERR_MICROPHONE_START_FAILED",n[n.ERR_MICROPHONE_NOT_AUTHORIZED=-1105]="ERR_MICROPHONE_NOT_AUTHORIZED",n[n.ERR_MICROPHONE_OCCUPIED=-1106]="ERR_MICROPHONE_OCCUPIED",n[n.ERR_MICROPHONE_DEVICE_EMPTY=-1107]="ERR_MICROPHONE_DEVICE_EMPTY",n[n.ERR_GET_SCREEN_SHARING_TARGET_FAILED=-1108]="ERR_GET_SCREEN_SHARING_TARGET_FAILED",n[n.ERR_START_SCREEN_SHARING_FAILED=-1109]="ERR_START_SCREEN_SHARING_FAILED",n[n.ERR_ROOM_ID_NOT_EXIST=-2100]="ERR_ROOM_ID_NOT_EXIST",n[n.ERR_OPERATION_INVALID_BEFORE_ENTER_ROOM=-2101]="ERR_OPERATION_INVALID_BEFORE_ENTER_ROOM",n[n.ERR_EXIT_NOT_SUPPORTED_FOR_ROOM_OWNER=-2102]="ERR_EXIT_NOT_SUPPORTED_FOR_ROOM_OWNER",n[n.ERR_OPERATION_NOT_SUPPORTED_IN_CURRENT_ROOM_TYPE=-2103]="ERR_OPERATION_NOT_SUPPORTED_IN_CURRENT_ROOM_TYPE",n[n.ERR_ROOM_ID_INVALID=-2105]="ERR_ROOM_ID_INVALID",n[n.ERR_ROOM_ID_OCCUPIED=-2106]="ERR_ROOM_ID_OCCUPIED",n[n.ERR_ROOM_NAME_INVALID=-2107]="ERR_ROOM_NAME_INVALID",n[n.ERR_ALREADY_IN_OTHER_ROOM=-2108]="ERR_ALREADY_IN_OTHER_ROOM",n[n.ERR_NEED_PASSWORD=-2109]="ERR_NEED_PASSWORD",n[n.ERR_WRONG_PASSWORD=-2110]="ERR_WRONG_PASSWORD",n[n.ERR_ROOM_USER_FULL=-2111]="ERR_ROOM_USER_FULL",n[n.ERR_USER_NOT_EXIST=-2200]="ERR_USER_NOT_EXIST",n[n.ERR_USER_NOT_ENTERED=-2201]="ERR_USER_NOT_ENTERED",n[n.ERR_NEED_OWNER_PERMISSION=-2300]="ERR_NEED_OWNER_PERMISSION",n[n.ERR_NEED_ADMIN_PERMISSION=-2301]="ERR_NEED_ADMIN_PERMISSION",n[n.ERR_REQUEST_NO_PERMISSION=-2310]="ERR_REQUEST_NO_PERMISSION",n[n.ERR_REQUEST_ID_INVALID=-2311]="ERR_REQUEST_ID_INVALID",n[n.ERR_REQUEST_ID_REPEAT=-2312]="ERR_REQUEST_ID_REPEAT",n[n.ERR_REQUEST_ID_CONFLICT=-2313]="ERR_REQUEST_ID_CONFLICT",n[n.ERR_MAX_SEAT_COUNT_LIMIT=-2340]="ERR_MAX_SEAT_COUNT_LIMIT",n[n.ERR_ALREADY_IN_SEAT=-2341]="ERR_ALREADY_IN_SEAT",n[n.ERR_SEAT_OCCUPIED=-2342]="ERR_SEAT_OCCUPIED",n[n.ERR_SEAT_LOCKED=-2343]="ERR_SEAT_LOCKED",n[n.ERR_SEAT_INDEX_NOT_EXIST=-2344]="ERR_SEAT_INDEX_NOT_EXIST",n[n.ERR_USER_NOT_IN_SEAT=-2345]="ERR_USER_NOT_IN_SEAT",n[n.ERR_ALL_SEAT_OCCUPIED=-2346]="ERR_ALL_SEAT_OCCUPIED",n[n.ERR_SEAT_NOT_SUPPORT_LINK_MIC=-2347]="ERR_SEAT_NOT_SUPPORT_LINK_MIC",n[n.ERR_OPEN_MICROPHONE_NEED_SEAT_UNLOCK=-2360]="ERR_OPEN_MICROPHONE_NEED_SEAT_UNLOCK",n[n.ERR_OPEN_MICROPHONE_NEED_PERMISSION_FROM_ADMIN=-2361]="ERR_OPEN_MICROPHONE_NEED_PERMISSION_FROM_ADMIN",n[n.ERR_OPEN_CAMERA_NEED_SEAT_UNLOCK=-2370]="ERR_OPEN_CAMERA_NEED_SEAT_UNLOCK",n[n.ERR_OPEN_CAMERA_NEED_PERMISSION_FROM_ADMIN=-2371]="ERR_OPEN_CAMERA_NEED_PERMISSION_FROM_ADMIN",n[n.ERR_OPEN_SCREEN_SHARE_NEED_SEAT_UNLOCK=-2372]="ERR_OPEN_SCREEN_SHARE_NEED_SEAT_UNLOCK",n[n.ERR_OPEN_SCREEN_SHARE_NEED_PERMISSION_FROM_ADMIN=-2373]="ERR_OPEN_SCREEN_SHARE_NEED_PERMISSION_FROM_ADMIN",n[n.ERR_SEND_MESSAGE_DISABLED_FOR_ALL=-2380]="ERR_SEND_MESSAGE_DISABLED_FOR_ALL",n[n.ERR_SEND_MESSAGE_DISABLED_FOR_CURRENT=-2381]="ERR_SEND_MESSAGE_DISABLED_FOR_CURRENT",exports.TUIRole=void 0,(o=exports.TUIRole||(exports.TUIRole={}))[o.kRoomOwner=0]="kRoomOwner",o[o.kAdministrator=1]="kAdministrator",o[o.kGeneralUser=2]="kGeneralUser",exports.TUIVideoQuality=void 0,(i=exports.TUIVideoQuality||(exports.TUIVideoQuality={}))[i.kVideoQuality_360p=1]="kVideoQuality_360p",i[i.kVideoQuality_540p=2]="kVideoQuality_540p",i[i.kVideoQuality_720p=3]="kVideoQuality_720p",i[i.kVideoQuality_1080p=4]="kVideoQuality_1080p",exports.TUIAudioQuality=void 0,(s=exports.TUIAudioQuality||(exports.TUIAudioQuality={}))[s.kAudioProfileSpeech=0]="kAudioProfileSpeech",s[s.kAudioProfileDefault=1]="kAudioProfileDefault",s[s.kAudioProfileMusic=2]="kAudioProfileMusic",exports.TUIVideoStreamType=void 0,(a=exports.TUIVideoStreamType||(exports.TUIVideoStreamType={}))[a.kCameraStream=0]="kCameraStream",a[a.kScreenStream=1]="kScreenStream",a[a.kCameraStreamLow=2]="kCameraStreamLow",exports.TUINetworkQuality=void 0,(r=exports.TUINetworkQuality||(exports.TUINetworkQuality={}))[r.kQualityUnknown=0]="kQualityUnknown",r[r.kQualityExcellent=1]="kQualityExcellent",r[r.kQualityGood=2]="kQualityGood",r[r.kQualityPoor=3]="kQualityPoor",r[r.kQualityBad=4]="kQualityBad",r[r.kQualityVeryBad=5]="kQualityVeryBad",r[r.kQualityDown=6]="kQualityDown",exports.TUIRoomType=void 0,(c=exports.TUIRoomType||(exports.TUIRoomType={}))[c.kConference=1]="kConference",c[c.kLive=2]="kLive",exports.TUISeatMode=void 0,(u=exports.TUISeatMode||(exports.TUISeatMode={}))[u.kFreeToTake=1]="kFreeToTake",u[u.kApplyToTake=2]="kApplyToTake",exports.TUIMediaDevice=void 0,(l=exports.TUIMediaDevice||(exports.TUIMediaDevice={}))[l.kMicrophone=1]="kMicrophone",l[l.kCamera=2]="kCamera",l[l.kScreen=3]="kScreen",exports.TUICaptureSourceType=void 0,(d=exports.TUICaptureSourceType||(exports.TUICaptureSourceType={}))[d.kWindow=0]="kWindow",d[d.kScreen=1]="kScreen",exports.TUIChangeReason=void 0,(p=exports.TUIChangeReason||(exports.TUIChangeReason={}))[p.kChangedBySelf=0]="kChangedBySelf",p[p.kChangedByAdmin=1]="kChangedByAdmin",exports.TUIKickedOutOfRoomReason=void 0,(_=exports.TUIKickedOutOfRoomReason||(exports.TUIKickedOutOfRoomReason={}))[_.kKickedByAdmin=0]="kKickedByAdmin",_[_.kKickedByLoggedOnOtherDevice=1]="kKickedByLoggedOnOtherDevice",_[_.kKickedByServer=2]="kKickedByServer",exports.TUIRequestAction=void 0,(h=exports.TUIRequestAction||(exports.TUIRequestAction={}))[h.kInvalidAction=0]="kInvalidAction",h[h.kRequestToOpenRemoteCamera=1]="kRequestToOpenRemoteCamera",h[h.kRequestToOpenRemoteMicrophone=2]="kRequestToOpenRemoteMicrophone",h[h.kRequestToConnectOtherRoom=3]="kRequestToConnectOtherRoom",h[h.kRequestToTakeSeat=4]="kRequestToTakeSeat",h[h.kRequestRemoteUserOnSeat=5]="kRequestRemoteUserOnSeat",h[h.kApplyToAdminToOpenLocalCamera=6]="kApplyToAdminToOpenLocalCamera",h[h.kApplyToAdminToOpenLocalMicrophone=7]="kApplyToAdminToOpenLocalMicrophone",h[h.kApplyToAdminToOpenLocalScreenShare=8]="kApplyToAdminToOpenLocalScreenShare",exports.TUIRequestCallbackType=void 0,(g=exports.TUIRequestCallbackType||(exports.TUIRequestCallbackType={}))[g.kRequestAccepted=0]="kRequestAccepted",g[g.kRequestRejected=1]="kRequestRejected",g[g.kRequestCancelled=2]="kRequestCancelled",g[g.kRequestTimeout=3]="kRequestTimeout",g[g.kRequestError=4]="kRequestError",g[g.kRequestId=5]="kRequestId",exports.TRTCRole=void 0,(f=exports.TRTCRole||(exports.TRTCRole={}))[f.kAnchor=0]="kAnchor",f[f.kAudience=1]="kAudience",exports.TUIResolutionMode=void 0,(m=exports.TUIResolutionMode||(exports.TUIResolutionMode={}))[m.kResolutionMode_Landscape=0]="kResolutionMode_Landscape",m[m.kResolutionMode_Portrait=1]="kResolutionMode_Portrait",exports.TUIMediaDeviceType=void 0,(v=exports.TUIMediaDeviceType||(exports.TUIMediaDeviceType={}))[v.kMediaDeviceTypeUnknown=-1]="kMediaDeviceTypeUnknown",v[v.kMediaDeviceTypeAudioInput=0]="kMediaDeviceTypeAudioInput",v[v.kMediaDeviceTypeAudioOutput=1]="kMediaDeviceTypeAudioOutput",v[v.kMediaDeviceTypeVideoCamera=2]="kMediaDeviceTypeVideoCamera",exports.TUIMediaDeviceState=void 0,(I=exports.TUIMediaDeviceState||(exports.TUIMediaDeviceState={}))[I.kMediaDeviceStateAdd=0]="kMediaDeviceStateAdd",I[I.kMediaDeviceStateRemove=1]="kMediaDeviceStateRemove",I[I.kMediaDeviceStateActive=2]="kMediaDeviceStateActive",exports.TUIAudioRoute=void 0,(y=exports.TUIAudioRoute||(exports.TUIAudioRoute={}))[y.kAudioRouteSpeakerphone=0]="kAudioRouteSpeakerphone",y[y.kAudioRouteEarpiece=1]="kAudioRouteEarpiece",exports.TUIConferenceStatus=void 0,(M=exports.TUIConferenceStatus||(exports.TUIConferenceStatus={}))[M.kConferenceStatusNone=0]="kConferenceStatusNone",M[M.kConferenceStatusNotStarted=1]="kConferenceStatusNotStarted",M[M.kConferenceStatusRunning=2]="kConferenceStatusRunning",exports.TUIConferenceCancelReason=void 0,(C=exports.TUIConferenceCancelReason||(exports.TUIConferenceCancelReason={}))[C.kConferenceCancelReasonCancelledByAdmin=0]="kConferenceCancelReasonCancelledByAdmin",C[C.kConferenceCancelReasonRemovedFromAttendees=1]="kConferenceCancelReasonRemovedFromAttendees",exports.TUIInvitationStatus=void 0,(T=exports.TUIInvitationStatus||(exports.TUIInvitationStatus={}))[T.kNone=0]="kNone",T[T.kPending=1]="kPending",T[T.kTimeout=2]="kTimeout",T[T.kAccepted=3]="kAccepted",T[T.kRejected=4]="kRejected",exports.TUIInvitationCode=void 0,(E=exports.TUIInvitationCode||(exports.TUIInvitationCode={}))[E.kSuccess=0]="kSuccess",E[E.kAlreadyInInvitationList=1]="kAlreadyInInvitationList",E[E.kAlreadyInConference=2]="kAlreadyInConference",exports.TUIInvitationRejectedReason=void 0,(D=exports.TUIInvitationRejectedReason||(exports.TUIInvitationRejectedReason={}))[D.kRejectToEnter=0]="kRejectToEnter",D[D.kInOtherConference=1]="kInOtherConference",exports.TUIRoomEvents=void 0,(R=exports.TUIRoomEvents||(exports.TUIRoomEvents={})).onError="onError",R.onKickedOutOfRoom="onKickedOutOfRoom",R.onKickedOffLine="onKickedOffLine",R.onUserSigExpired="onUserSigExpired",R.onRoomDismissed="onRoomDismissed",R.onRoomNameChanged="onRoomNameChanged",R.onRoomSeatModeChanged="onRoomSeatModeChanged",R.onAllUserCameraDisableChanged="onAllUserCameraDisableChanged",R.onAllUserMicrophoneDisableChanged="onAllUserMicrophoneDisableChanged",R.onScreenShareForAllUserDisableChanged="onScreenShareForAllUserDisableChanged",R.onSendMessageForAllUserDisableChanged="onSendMessageForAllUserDisableChanged",R.onRoomMaxSeatCountChanged="onRoomMaxSeatCountChanged",R.onRemoteUserEnterRoom="onRemoteUserEnterRoom",R.onRemoteUserLeaveRoom="onRemoteUserLeaveRoom",R.onUserInfoChanged="onUserInfoChanged",R.onUserRoleChanged="onUserRoleChanged",R.onUserVideoStateChanged="onUserVideoStateChanged",R.onUserAudioStateChanged="onUserAudioStateChanged",R.onSendMessageForUserDisableChanged="onSendMessageForUserDisableChanged",R.onUserVoiceVolumeChanged="onUserVoiceVolumeChanged",R.onUserNetworkQualityChanged="onUserNetworkQualityChanged",R.onSeatListChanged="onSeatListChanged",R.onKickedOffSeat="onKickedOffSeat",R.onRequestReceived="onRequestReceived",R.onRequestCancelled="onRequestCancelled",R.onRequestProcessed="onRequestProcessed",R.onReceiveTextMessage="onReceiveTextMessage",R.onReceiveCustomMessage="onReceiveCustomMessage",R.onDeviceChange="onDeviceChange",R.onUserScreenCaptureStopped="onUserScreenCaptureStopped",R.onUserScreenCapturePaused="onUserScreenCapturePaused",R.onUserScreenCaptureResumed="onUserScreenCaptureResumed",exports.TUIRoomDeviceMangerEvents=void 0,(S=exports.TUIRoomDeviceMangerEvents||(exports.TUIRoomDeviceMangerEvents={})).onDeviceChanged="onDeviceChanged",S.onTestMicVolume="onTestMicVolume",S.onTestSpeakerVolume="onTestSpeakerVolume",exports.TUIConferenceListManagerEvents=void 0,(L=exports.TUIConferenceListManagerEvents||(exports.TUIConferenceListManagerEvents={})).onConferenceScheduled="onConferenceScheduled",L.onConferenceWillStart="onConferenceWillStart",L.onConferenceCancelled="onConferenceCancelled",L.onConferenceInfoChanged="onConferenceInfoChanged",L.onScheduleAttendeesChanged="onScheduleAttendeesChanged",L.onConferenceStatusChanged="onConferenceStatusChanged",exports.TUIConferenceInvitationManagerEvents=void 0,(A=exports.TUIConferenceInvitationManagerEvents||(exports.TUIConferenceInvitationManagerEvents={})).onReceiveInvitation="onReceiveInvitation",A.onInvitationHandledByOtherDevice="onInvitationHandledByOtherDevice",A.onInvitationCancelled="onInvitationCancelled",A.onInvitationAccepted="onInvitationAccepted",A.onInvitationRejected="onInvitationRejected",A.onInvitationTimeout="onInvitationTimeout",A.onInvitationRevokedByAdmin="onInvitationRevokedByAdmin",A.onInvitationAdded="onInvitationAdded",A.onInvitationRemoved="onInvitationRemoved",A.onInvitationStatusChanged="onInvitationStatusChanged";const k=e=>"function"==typeof e,O=e=>void 0===e,N=e=>"string"==typeof e,P=e=>"number"==typeof e;function G(e){return Reflect.apply(Object.prototype.toString,e,[]).replace(/^\[object\s(\w+)\]$/,"$1").toLowerCase()}const U=function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;const t=Object.getPrototypeOf(e);if(null===t)return!0;const n=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&Function.prototype.toString.call(n)===Function.prototype.toString.call(Object)};function b(e){if("string"!=typeof e)return e;let t;try{const n=JSON.parse(e);t="object"==typeof n&&n?n:e}catch(n){t=e}return t}class w extends Error{constructor(e){const{code:t,message:n,name:o}=e;super(n),this.code=t,this.message=n,this.name=o||""}}const F="INVALID_PARAMETER_REQUIRED",q="INVALID_PARAMETER_TYPE",x="INVALID_PARAMETER_EMPTY",V="INVALID_PARAMETER_INSTANCE",B="INVALID_PARAMETER_RANGE",H="CANNOT_LESS_THAN_ZERO",K={INVALID_PARAMETER_REQUIRED:e=>{const{key:t,rule:n,fnName:o,value:i}=e;return`'${t||n.name}' is a required param when calling ${o}(), received: ${i}.`},INVALID_PARAMETER_TYPE:e=>{const{key:t,rule:n,fnName:o,value:i}=e,s=`${t||n.name}`;let a="";return a=Array.isArray(n.type)?n.type.join("|"):n.type,`'${s}' must be type of ${a} when calling ${o}(), received type: ${G(i)}.`},INVALID_PARAMETER_EMPTY:e=>{const{key:t,rule:n,fnName:o,value:i}=e;return`'${t||n.name}' cannot be '${i}' when calling ${o}().`},INVALID_PARAMETER_INSTANCE:e=>{const{key:t,rule:n,fnName:o,value:i}=e;return`'${`${t||n.name}`}' must be instanceof ${`${n.instanceOf.name||n.instanceOf}`} when calling ${o}(), received type: ${G(i)}.`},INVALID_PARAMETER_RANGE:e=>{const{key:t,rule:n,fnName:o,value:i}=e;return`'${t||n.name}' must be one of ${n.values.join("|")} when calling ${o}(), received: ${i}.`},CANNOT_LESS_THAN_ZERO:e=>{const{key:t,rule:n,fnName:o,value:i}=e;return`'${t||n.name}' cannot be less than 0 when calling ${o}().`},xxx:"lajfl "};function W(e){const{key:t,data:n}=e;return K[t]?k(K[t])?K[t](n):N(K[t])?K[t]:"":""}function Y(...e){return function(t,n,o){const i=o.value;return o.value=function(...t){return J.call(this,e,t,n,this.className),i.apply(this,t)},o}}function j(...e){return function(n,o,i){const s=i.value;return i.value=function(...n){return t(this,void 0,void 0,(function*(){return J.call(this,e,n,o,this.className),s.apply(this,n)}))},i}}function J(e,t,n,o){try{for(let i=0;i<e.length;i++)z.call(this,{rule:e[i],value:t[i],key:e[i].name,fnName:n,className:o})}catch(i){throw console.error(i,i.code,i.message),i}}function z(e){const{rule:t,value:n,key:o,fnName:i,className:s}=e;if(O(n)){if(t.required)throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:F,data:{key:o,rule:t,fnName:i,value:n}})});return}if(Array.isArray(t.type)){if(!t.type.map((e=>e.toLowerCase())).includes(G(n)))throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:q,data:{key:o,rule:t,fnName:i,value:n}})})}else if(!O(t.type)&&G(n)!==t.type)throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:q,data:{key:o,rule:t,fnName:i,value:n}})});if(!1===t.allowEmpty){const e=P(n)&&(0===n||Number.isNaN(n)),s=N(n)&&""===n.trim();if(e||s)throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:x,data:{key:o,rule:t,fnName:i,value:n}})})}if(t.notLessThanZero&&P(n)&&n<0)throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:H,data:{key:o,rule:t,fnName:i,value:n}})});if(N(t.instanceOf)){if(!n||n.name_!==t.instanceOf)throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:V,data:{key:o,rule:t,fnName:i,value:n}})})}else if(k(t.instanceOf)&&!(n instanceof t.instanceOf))throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:V,data:{key:o,rule:t,fnName:i,value:n}})});if(t.values&&!t.values.includes(n))throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:W({key:B,data:{key:o,rule:t,fnName:i,value:n}})});const{properties:a}=t;U(a)&&"object"===G(n)&&Object.keys(a).forEach((e=>{z.call(this,{rule:a[e],value:n&&n[e],key:`${o}.${e}`,fnName:i,className:s})}));const{arrayItem:r}=t;U(r)&&(e=>"array"===G(e))(n)&&n.forEach(((e,t)=>{z.call(this,{rule:r,value:e,key:`${o}[${t}]`,fnName:i,className:s})})),k(t.validate)&&t.validate.call(this,n,o,i,s,this)}const X=new WeakMap;function Q(){return function(e,t,n){const o=n.value,i=e=>{const{fn:t,args:n,context:o,resolve:s,reject:a}=e;t.apply(o,n).then(s,a).finally((()=>{const e=X.get(o);e&&(e.shift(),e[0]&&i(Object.assign({},e[0])))}))};return n.value=function(...e){return new Promise(((n,s)=>{if(X.has(this)){const a=X.get(this),{length:r}=a;a.push({fn:o,args:e,context:this,resolve:n,reject:s,name:t}),0===r&&i({fn:o,args:e,context:this,resolve:n,reject:s})}else X.set(this,[{fn:o,args:e,context:this,resolve:n,reject:s,name:t}]),i({fn:o,args:e,context:this,resolve:n,reject:s})}))},n}}const Z="string",$="number",ee="boolean",te="array",ne="object",oe="null",ie="uniapp",se=1,ae={login:{name:"options",required:!0,type:ne,properties:{sdkAppId:{required:!0,type:$,allowEmpty:!1},userId:{required:!0,type:Z,allowEmpty:!1},userSig:{required:!0,type:Z,allowEmpty:!1}}},setSelfInfo:{name:"options",required:!0,type:ne,properties:{userName:{required:!0,type:Z},avatarUrl:{required:!0,type:Z},customInfo:{required:!1,type:ne,allowEmpty:!1}}},createRoom:{name:"options",required:!0,type:ne,properties:{roomId:{required:!0,type:Z,allowEmpty:!1},roomName:{type:Z,allowEmpty:!1},roomType:{instanceof:exports.TUIRoomType},isMicrophoneDisableForAllUser:{type:ee},isScreenShareDisableForAllUser:{type:ee},isCameraDisableForAllUser:{type:ee},isMessageDisableForAllUser:{type:ee},maxSeatCount:{type:$},password:{type:Z}}},enterRoom:{name:"options",required:!0,type:ne,properties:{roomId:{required:!0,type:Z,allowEmpty:!1},roomType:{instanceof:exports.TUIRoomType},options:{type:ne,properties:{password:{type:Z}}}}},updateRoomNameByAdmin:{name:"options",require:!0,type:ne,properties:{roomName:{require:!0,type:Z,allowEmpty:!1}}},setRoomMaxSeatCount:{name:"options",require:!0,type:ne,properties:{maxSeatCount:{require:!0,type:$}}},getUserList:{name:"options",required:!1,type:ne,properties:{nextSequence:{type:Z}}},getUserInfo:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1}}},setCustomInfoForUser:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},customInfo:{required:!0,type:ne,allowEmpty:!1}}},takeSeat:{name:"options",required:!0,type:ne,properties:{seatIndex:{required:!0,type:$},timeout:{required:!0,type:$},requestCallback:{instanceof:Function}}},getSeatList:{},openRemoteDeviceByAdmin:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},timeout:{required:!0,type:$},device:{require:!0,instanceof:exports.TUIMediaDevice}}},closeRemoteDeviceByAdmin:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},device:{required:!0,instanceof:exports.TUIMediaDevice}}},takeUserOnSeatByAdmin:{name:"options",required:!0,type:ne,properties:{seatIndex:{required:!0,type:$},userId:{required:!0,type:Z,allowEmpty:!1},timeout:{required:!0,type:$},requestCallback:{instanceof:Function}}},kickUserOffSeatByAdmin:{name:"options",required:!0,type:ne,properties:{seatIndex:{required:!0,type:$},userId:{required:!0,type:Z,allowEmpty:!1}}},cancelRequest:{name:"options",required:!0,type:ne,properties:{requestId:{required:!0,type:Z,allowEmpty:!1}}},responseRemoteRequest:{name:"options",required:!0,type:ne,properties:{requestId:{required:!0,type:Z,allowEmpty:!1},agree:{required:!0,type:ee}}},setLocalVideoView:{name:"options",required:!1,type:ne,properties:{view:{required:!1,type:[Z,te,oe],allowEmpty:!1,validate:e=>{if(e instanceof Array){if(e.some((e=>null===e)))throw new w({code:exports.TUIErrorCode.ERR_INVALID_PARAMETER,message:"When calling the setLocalVideoView interface with the view parameter as an array, the array content cannot contain null."})}}}}},openLocalCamera:{name:"options",type:ne,properties:{isFrontCamera:{type:ee,allowEmpty:!1}}},closeLocalCamera:{},openLocalMicrophone:{},closeLocalMicrophone:{},setVideoResolutionMode:{name:"options",required:!0,type:ne,properties:{streamType:{required:!0,instanceof:exports.TUIVideoStreamType},resolutionMode:{required:!0,instanceof:exports.TUIResolutionMode}}},updateVideoQuality:{name:"options",required:!0,type:ne,properties:{quality:{required:!0,instanceof:exports.TUIVideoQuality}}},updateVideoQualityEx:{name:"options",required:!0,type:ne,properties:{streamType:{required:!0,instanceof:exports.TUIVideoStreamType},encoderParams:{required:!0,properties:{quality:{instanceof:exports.TUIVideoQuality},fps:{type:$},bitrate:{type:$},resolutionMode:{instanceof:exports.TUIResolutionMode}}}}},updateAudioQuality:{name:"options",required:!0,type:ne,properties:{quality:{required:!0,instanceof:exports.TUIAudioQuality}}},muteRemoteAudioStream:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},isMute:{required:!0,type:ee}}},startPushLocalVideo:{},stopPushLocalVideo:{},startPushLocalAudio:{},stopPushLocalAudio:{},setRemoteVideoView:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},streamType:{required:!0,instanceof:exports.TUIVideoStreamType},view:{required:!0,type:[Z,te],allowEmpty:!1}}},startPlayRemoteVideo:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},streamType:{required:!0,instanceof:exports.TUIVideoStreamType}}},stopPlayRemoteVideo:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},streamType:{required:!0,instanceof:exports.TUIVideoStreamType}}},changeUserRole:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},userRole:{required:!0,instanceof:exports.TUIRole}}},changeUserNameCard:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1},nameCard:{required:!0,type:Z}}},kickRemoteUserOutOfRoom:{name:"options",required:!0,type:ne,properties:{userId:{required:!0,type:Z,allowEmpty:!1}}},sendTextMessage:{name:"options",required:!0,type:ne,properties:{messageText:{require:!0,type:Z,allowEmpty:!1}}},sendCustomMessage:{name:"options",required:!0,type:ne,properties:{messageText:{require:!0,type:Z,allowEmpty:!1}}},startScreenSharing:{name:"options",type:ne,properties:{screenAudio:{type:ee},view:{type:Z}}},stopScreenSharing:{},startScreenSharingElectron:{name:"options",required:!0,type:[ne,"string"],properties:{targetId:{require:!0,type:Z},view:{type:Z}}},selectScreenSharingTarget:{name:"options",required:!0,type:[ne,"string"],properties:{targetId:{require:!0,type:Z}}},setCurrentCameraDevice:{name:"options",required:!0,type:ne,properties:{deviceId:{require:!0,type:Z}}},setCurrentMicDevice:{name:"options",required:!0,type:ne,properties:{deviceId:{require:!0,type:Z}}},setCurrentSpeakerDevice:{name:"options",required:!0,type:ne,properties:{deviceId:{require:!0,type:Z}}},disableDeviceForAllUserByAdmin:{name:"options",required:!0,type:ne,properties:{isDisable:{require:!0,type:ee},device:{require:!0,instanceof:exports.TUIMediaDevice}}},disableSendingMessageForAllUser:{name:"options",required:!0,type:ne,properties:{isDisable:{require:!0,type:ee}}},disableSendingMessageByAdmin:{name:"options",required:!0,type:ne,properties:{userId:{require:!0,instanceof:Z},isDisable:{require:!0,type:ee}}},updateRoomSeatModeByAdmin:{name:"options",required:!0,type:ne,properties:{seatMode:{require:!0,instanceof:exports.TUISeatMode}}},updateRoomPasswordByAdmin:{name:"options",required:!0,type:ne,properties:{password:{required:!0,type:Z,allowEmpty:!1}}},applyToAdminToOpenLocalDevice:{name:"options",required:!0,type:ne,properties:{timeout:{required:!0,type:$},device:{require:!0,instanceof:exports.TUIMediaDevice}}},setMaxSeatCount:{name:"options",required:!0,type:ne,properties:{maxSeatCount:{require:!0,type:$}}},lockSeatByAdmin:{name:"options",required:!0,type:ne,properties:{seatIndex:{required:!0,type:$},lockParams:{require:!0,type:ne,properties:{lockSeat:{require:!0,type:ee},lockVideo:{require:!0,type:ee},lockAudio:{require:!0,type:ee}}}}}},re="iOS"===plus.os.name;var ce={judgeIosPermission:function(e){return"location"==e?function(){let e=!1;const t=plus.ios.import("CLLocationManager");return e=2!=t.authorizationStatus(),console.log(`定位权限开启：${e}`),plus.ios.deleteObject(t),e}():"camera"==e?function(){let e=!1;const t=plus.ios.import("AVCaptureDevice"),n=t.authorizationStatusForMediaType("vide");return console.log(`authStatus:${n}`),3==n?(e=!0,console.log("相机权限已经开启")):console.log("相机权限没有开启"),plus.ios.deleteObject(t),e}():"photoLibrary"==e?function(){let e=!1;const t=plus.ios.import("PHPhotoLibrary"),n=t.authorizationStatus();return console.log(`authStatus:${n}`),3==n?(e=!0,console.log("相册权限已经开启")):console.log("相册权限没有开启"),plus.ios.deleteObject(t),e}():"record"==e?function(){let e=!1;const t=plus.ios.import("AVAudioSession"),n=t.sharedInstance().recordPermission();return console.log(`permissionStatus:${n}`),1684369017==n||1970168948==n?console.log("麦克风权限没有开启"):(e=!0,console.log("麦克风权限已经开启")),plus.ios.deleteObject(t),e}():"push"==e?function(){let e=!1;const t=plus.ios.import("UIApplication"),n=t.sharedApplication();let o=0;if(n.currentUserNotificationSettings){const t=n.currentUserNotificationSettings();o=t.plusGetAttribute("types"),console.log(`enabledTypes1:${o}`),0==o?console.log("推送权限没有开启"):(e=!0,console.log("已经开启推送功能!")),plus.ios.deleteObject(t)}else o=n.enabledRemoteNotificationTypes(),0==o?console.log("推送权限没有开启!"):(e=!0,console.log("已经开启推送功能!")),console.log(`enabledTypes2:${o}`);return plus.ios.deleteObject(n),plus.ios.deleteObject(t),e}():"contact"==e?function(){let e=!1;const t=plus.ios.import("CNContactStore");return 3==t.authorizationStatusForEntityType(0)?(e=!0,console.log("通讯录权限已经开启")):console.log("通讯录权限没有开启"),plus.ios.deleteObject(t),e}():"calendar"==e?function(){let e=!1;const t=plus.ios.import("EKEventStore");return 3==t.authorizationStatusForEntityType(0)?(e=!0,console.log("日历权限已经开启")):console.log("日历权限没有开启"),plus.ios.deleteObject(t),e}():"memo"==e&&function(){let e=!1;const t=plus.ios.import("EKEventStore");return 3==t.authorizationStatusForEntityType(1)?(e=!0,console.log("备忘录权限已经开启")):console.log("备忘录权限没有开启"),plus.ios.deleteObject(t),e}()},requestAndroidPermission:function(e){return new Promise(((t,n)=>{plus.android.requestPermissions([e],(e=>{let n=0;for(let t=0;t<e.granted.length;t++){const o=e.granted[t];console.log(`已获取的权限：${o}`),n=1}for(let t=0;t<e.deniedPresent.length;t++){const o=e.deniedPresent[t];console.log(`拒绝本次申请的权限：${o}`),n=0}for(let t=0;t<e.deniedAlways.length;t++){const o=e.deniedAlways[t];console.log(`永久拒绝申请的权限：${o}`),n=-1}t(n)}),(e=>{console.log(`申请权限错误：${e.code} = ${e.message}`),t({code:e.code,message:e.message})}))}))},checkSystemEnableLocation:function(){if(re){let e=!1;const t=plus.ios.import("CLLocationManager");return e=t.locationServicesEnabled(),console.log(`系统定位开启:${e}`),plus.ios.deleteObject(t),e}const e=plus.android.importClass("android.content.Context"),t=plus.android.importClass("android.location.LocationManager"),n=plus.android.runtimeMainActivity().getSystemService(e.LOCATION_SERVICE).isProviderEnabled(t.GPS_PROVIDER);return console.log(`系统定位开启:${n}`),n},gotoAppPermissionSetting:function(){if(re){const e=plus.ios.import("UIApplication").sharedApplication(),t=plus.ios.import("NSURL"),n=t.URLWithString("app-settings:");e.openURL(n),plus.ios.deleteObject(n),plus.ios.deleteObject(t),plus.ios.deleteObject(e)}else{const e=plus.android.importClass("android.content.Intent"),t=plus.android.importClass("android.provider.Settings"),n=plus.android.importClass("android.net.Uri"),o=plus.android.runtimeMainActivity(),i=new e;i.setAction(t.ACTION_APPLICATION_DETAILS_SETTINGS);const s=n.fromParts("package",o.getPackageName(),null);i.setData(s),o.startActivity(i)}}},ue="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},le={};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function o(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,o,s,a){if("function"!=typeof o)throw new TypeError("The listener must be a function");var r=new i(o,s||e,a),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],r]:e._events[c].push(r):(e._events[c]=r,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function r(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(n=!1)),r.prototype.eventNames=function(){var e,o,i=[];if(0===this._eventsCount)return i;for(o in e=this._events)t.call(e,o)&&i.push(n?o.slice(1):o);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},r.prototype.listeners=function(e){var t=n?n+e:e,o=this._events[t];if(!o)return[];if(o.fn)return[o.fn];for(var i=0,s=o.length,a=new Array(s);i<s;i++)a[i]=o[i].fn;return a},r.prototype.listenerCount=function(e){var t=n?n+e:e,o=this._events[t];return o?o.fn?1:o.length:0},r.prototype.emit=function(e,t,o,i,s,a){var r=n?n+e:e;if(!this._events[r])return!1;var c,u,l=this._events[r],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,o),!0;case 4:return l.fn.call(l.context,t,o,i),!0;case 5:return l.fn.call(l.context,t,o,i,s),!0;case 6:return l.fn.call(l.context,t,o,i,s,a),!0}for(u=1,c=new Array(d-1);u<d;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var p,_=l.length;for(u=0;u<_;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,o);break;case 4:l[u].fn.call(l[u].context,t,o,i);break;default:if(!c)for(p=1,c=new Array(d-1);p<d;p++)c[p-1]=arguments[p];l[u].fn.apply(l[u].context,c)}}return!0},r.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},r.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},r.prototype.removeListener=function(e,t,o,i){var s=n?n+e:e;if(!this._events[s])return this;if(!t)return a(this,s),this;var r=this._events[s];if(r.fn)r.fn!==t||i&&!r.once||o&&r.context!==o||a(this,s);else{for(var c=0,u=[],l=r.length;c<l;c++)(r[c].fn!==t||i&&!r[c].once||o&&r[c].context!==o)&&u.push(r[c]);u.length?this._events[s]=1===u.length?u[0]:u:a(this,s)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new o,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=n,r.EventEmitter=r,e.exports=r}({get exports(){return le},set exports(e){le=e}});var de=le;class pe{constructor(e){const{Module:t,logger:n}=e;this.deviceManager||(this.logger=n,this.deviceManager=t)}static getInstance(e){return pe.instance||(pe.instance=new pe(e)),pe.instance}JSCallNativeFunctionSync(e,t){return this.deviceManager[e](t)}switchCamera(e){return t(this,void 0,void 0,(function*(){this.logger.info("deviceManager.switchCamera with options: ",e);const{isFrontCamera:t}=e,n={frontCamera:t};yield this.JSCallNativeFunctionSync("switchCamera",n)}))}}class _e{constructor(e){const{Module:t,logger:n}=e;this.trtcCloud||(this.logger=n,this.trtcCloud=t)}static getInstance(e){return _e.instance||(_e.instance=new _e(e)),_e.instance}JSCallNativeFunctionSync(e,t){return this.trtcCloud[e](t)}setLocalRenderParams(e){return t(this,void 0,void 0,(function*(){this.logger.info("deviceManager.setLocalRenderParams with options: ",e),yield this.JSCallNativeFunctionSync("setLocalRenderParams",e)}))}}var he={};({get exports(){return he},set exports(e){he=e}}).exports=function(){function e(e,t){var n,o=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)),o}function t(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?e(Object(o),!0).forEach((function(e){a(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function s(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(s){return!1}}function d(e,t,n){return(d=l()?Reflect.construct:function(e,t,n){var o=[null];return o.push.apply(o,t),t=new(Function.bind.apply(e,o)),n&&u(t,n.prototype),t}).apply(null,arguments)}function p(e){var t="function"==typeof Map?new Map:void 0;return function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return d(e,arguments,c(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),u(n,e)}(e)}function _(e,t){if(null==e)return{};var n,o=function(e,t){if(null==e)return{};for(var n,o={},i=Object.keys(e),s=0;s<i.length;s++)n=i[s],0<=t.indexOf(n)||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols)for(var i=Object.getOwnPropertySymbols(e),s=0;s<i.length;s++)n=i[s],0<=t.indexOf(n)||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n]);return o}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e){var t=l();return function(){var n,o=c(e);if(n=t?(n=c(this).constructor,Reflect.construct(o,arguments,n)):o.apply(this,arguments),o=this,n&&("object"==typeof n||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return h(o)}}function f(e,t){return v(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,i,s=[],a=!0,r=!1;try{for(n=n.call(e);!(a=(o=n.next()).done)&&(s.push(o.value),!t||s.length!==t);a=!0);}catch(e){r=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(r)throw i}}return s}}(e,t)||y(e,t)||C()}function m(e){return function(e){if(Array.isArray(e))return M(e)}(e)||I(e)||y(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(e){if(Array.isArray(e))return e}function I(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function y(e,t){if(e){if("string"==typeof e)return M(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?M(e,t):void 0}}function M(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=new Array(t);n<t;n++)o[n]=e[n];return o}function C(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function T(e,t){var n,o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=y(e))||t&&e&&"number"==typeof e.length)return o&&(e=o),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==o.return||o.return()}finally{if(a)throw i}}}}var E={SDK_READY:"sdkStateReady",SDK_NOT_READY:"sdkStateNotReady",SDK_DESTROY:"sdkDestroy",MESSAGE_RECEIVED:"onMessageReceived",ROOM_CUSTOM_DATA_RECEIVED:"onRoomCustomDataReceived",MESSAGE_MODIFIED:"onMessageModified",MESSAGE_REVOKED:"onMessageRevoked",MESSAGE_READ_BY_PEER:"onMessageReadByPeer",MESSAGE_READ_RECEIPT_RECEIVED:"onMessageReadReceiptReceived",MESSAGE_EXTENSIONS_UPDATED:"onMessageExtensionsUpdated",MESSAGE_EXTENSIONS_DELETED:"onMessageExtensionsDeleted",MESSAGE_REACTIONS_UPDATED:"onMessageReactionsUpdated",CONVERSATION_LIST_UPDATED:"onConversationListUpdated",TOTAL_UNREAD_MESSAGE_COUNT_UPDATED:"onTotalUnreadMessageCountUpdated",CONVERSATION_GROUP_LIST_UPDATED:"onConversationGroupListUpdated",CONVERSATION_IN_GROUP_UPDATED:"onConversationInGroupUpdated",GROUP_LIST_UPDATED:"onGroupListUpdated",GROUP_ATTRIBUTES_UPDATED:"groupAttributesUpdated",GROUP_COUNTER_UPDATED:"onGroupCounterUpdated",TOPIC_CREATED:"onTopicCreated",TOPIC_DELETED:"onTopicDeleted",TOPIC_UPDATED:"onTopicUpdated",PROFILE_UPDATED:"onProfileUpdated",USER_STATUS_UPDATED:"onUserStatusUpdated",BLACKLIST_UPDATED:"blacklistUpdated",FRIEND_LIST_UPDATED:"onFriendListUpdated",FRIEND_GROUP_LIST_UPDATED:"onFriendGroupListUpdated",FRIEND_APPLICATION_LIST_UPDATED:"onFriendApplicationListUpdated",MY_FOLLOWERS_LIST_UPDATED:"onMyFollowersListUpdated",MY_FOLLOWING_LIST_UPDATED:"onMyFollowingListUpdated",MUTUAL_FOLLOWERS_LIST_UPDATED:"onMutualFollowersListUpdated",KICKED_OUT:"kickedOut",ERROR:"error",NET_STATE_CHANGE:"netStateChange",ALL_RECEIVE_MESSAGE_OPT_UPDATED:"onAllReceiveMessageOptUpdated"},D={MSG_TEXT:"TIMTextElem",MSG_IMAGE:"TIMImageElem",MSG_SOUND:"TIMSoundElem",MSG_AUDIO:"TIMSoundElem",MSG_FILE:"TIMFileElem",MSG_FACE:"TIMFaceElem",MSG_VIDEO:"TIMVideoFileElem",MSG_GEO:"TIMLocationElem",MSG_LOCATION:"TIMLocationElem",MSG_GRP_TIP:"TIMGroupTipElem",MSG_GRP_SYS_NOTICE:"TIMGroupSystemNoticeElem",MSG_CUSTOM:"TIMCustomElem",MSG_MERGER:"TIMRelayElem",MSG_PRIORITY_HIGH:"High",MSG_PRIORITY_NORMAL:"Normal",MSG_PRIORITY_LOW:"Low",MSG_PRIORITY_LOWEST:"Lowest",CONV_C2C:"C2C",CONV_GROUP:"GROUP",CONV_TOPIC:"TOPIC",CONV_SYSTEM:"@TIM#SYSTEM",CONV_AT_ME:1,CONV_AT_ALL:2,CONV_AT_ALL_AT_ME:3,CONV_MARK_TYPE_STAR:1,CONV_MARK_TYPE_UNREAD:2,CONV_MARK_TYPE_FOLD:4,CONV_MARK_TYPE_HIDE:8,GRP_PRIVATE:"Private",GRP_WORK:"Private",GRP_PUBLIC:"Public",GRP_CHATROOM:"ChatRoom",GRP_MEETING:"ChatRoom",GRP_AVCHATROOM:"AVChatRoom",GRP_COMMUNITY:"Community",GRP_ROOM:"Room",GRP_LIVE:"Live",GRP_MBR_ROLE_OWNER:"Owner",GRP_MBR_ROLE_ADMIN:"Admin",GRP_MBR_ROLE_MEMBER:"Member",GRP_MBR_ROLE_CUSTOM:"Custom",GRP_TIP_MBR_JOIN:1,GRP_TIP_MBR_QUIT:2,GRP_TIP_MBR_KICKED_OUT:3,GRP_TIP_MBR_SET_ADMIN:4,GRP_TIP_MBR_CANCELED_ADMIN:5,GRP_TIP_GRP_PROFILE_UPDATED:6,GRP_TIP_MBR_PROFILE_UPDATED:7,GRP_TIP_BAN_AVCHATROOM_MEMBER:10,GRP_TIP_UNBAN_AVCHATROOM_MEMBER:11,MSG_REMIND_ACPT_AND_NOTE:"AcceptAndNotify",MSG_REMIND_ACPT_NOT_NOTE:"AcceptNotNotify",MSG_REMIND_DISCARD:"Discard",RECEIVE_WITH_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT:"AcceptNotNotifyExceptAt",NOT_RECEIVE_MSG_EXCEPT_AT:"NotReceiveMsgExceptAt",GENDER_UNKNOWN:"Gender_Type_Unknown",GENDER_FEMALE:"Gender_Type_Female",GENDER_MALE:"Gender_Type_Male",KICKED_OUT_MULT_ACCOUNT:"multipleAccount",KICKED_OUT_MULT_DEVICE:"multipleDevice",KICKED_OUT_USERSIG_EXPIRED:"userSigExpired",KICKED_OUT_REST_API:"REST_API_Kick",ALLOW_TYPE_ALLOW_ANY:"AllowType_Type_AllowAny",ALLOW_TYPE_NEED_CONFIRM:"AllowType_Type_NeedConfirm",ALLOW_TYPE_DENY_ANY:"AllowType_Type_DenyAny",FORBID_TYPE_NONE:"AdminForbid_Type_None",FORBID_TYPE_SEND_OUT:"AdminForbid_Type_SendOut",JOIN_OPTIONS_FREE_ACCESS:"FreeAccess",JOIN_OPTIONS_NEED_PERMISSION:"NeedPermission",JOIN_OPTIONS_DISABLE_APPLY:"DisableApply",JOIN_STATUS_SUCCESS:"JoinedSuccess",JOIN_STATUS_ALREADY_IN_GROUP:"AlreadyInGroup",JOIN_STATUS_WAIT_APPROVAL:"WaitAdminApproval",INVITE_OPTIONS_DISABLE_INVITE:"DisableInvite",INVITE_OPTIONS_NEED_PERMISSION:"NeedPermission",INVITE_OPTIONS_FREE_ACCESS:"FreeAccess",GRP_PROFILE_OWNER_ID:"ownerID",GRP_PROFILE_CREATE_TIME:"createTime",GRP_PROFILE_LAST_INFO_TIME:"lastInfoTime",GRP_PROFILE_MEMBER_NUM:"memberNum",GRP_PROFILE_MAX_MEMBER_NUM:"maxMemberNum",GRP_PROFILE_JOIN_OPTION:"joinOption",GRP_PROFILE_INVITE_OPTION:"inviteOption",GRP_PROFILE_INTRODUCTION:"introduction",GRP_PROFILE_NOTIFICATION:"notification",GRP_PROFILE_MUTE_ALL_MBRS:"muteAllMembers",SNS_ADD_TYPE_SINGLE:"Add_Type_Single",SNS_ADD_TYPE_BOTH:"Add_Type_Both",SNS_DELETE_TYPE_SINGLE:"Delete_Type_Single",SNS_DELETE_TYPE_BOTH:"Delete_Type_Both",SNS_APPLICATION_TYPE_BOTH:"Pendency_Type_Both",SNS_APPLICATION_SENT_TO_ME:"Pendency_Type_ComeIn",SNS_APPLICATION_SENT_BY_ME:"Pendency_Type_SendOut",SNS_APPLICATION_AGREE:"Response_Action_Agree",SNS_APPLICATION_AGREE_AND_ADD:"Response_Action_AgreeAndAdd",SNS_CHECK_TYPE_BOTH:"CheckResult_Type_Both",SNS_CHECK_TYPE_SINGLE:"CheckResult_Type_Single",SNS_TYPE_NO_RELATION:"CheckResult_Type_NoRelation",SNS_TYPE_A_WITH_B:"CheckResult_Type_AWithB",SNS_TYPE_B_WITH_A:"CheckResult_Type_BWithA",SNS_TYPE_BOTH_WAY:"CheckResult_Type_BothWay",NET_STATE_CONNECTED:"connected",NET_STATE_CONNECTING:"connecting",NET_STATE_DISCONNECTED:"disconnected",MSG_AT_ALL:"__kImSDK_MesssageAtALL__",READ_ALL_C2C_MSG:"readAllC2CMessage",READ_ALL_GROUP_MSG:"readAllGroupMessage",READ_ALL_MSG:"readAllMessage",USER_STATUS_UNKNOWN:0,USER_STATUS_ONLINE:1,USER_STATUS_OFFLINE:2,USER_STATUS_UNLOGINED:3,IOS_OFFLINE_PUSH_NO_SOUND:"push.no_sound",IOS_OFFLINE_PUSH_DEFAULT_SOUND:"default"},R={NEW_INVITATION_RECEIVED:"newInvitationReceived",INVITEE_ACCEPTED:"ts_invitee_accepted",INVITEE_REJECTED:"ts_invitee_rejected",INVITATION_CANCELLED:"ts_invitation_cancelled",INVITATION_TIMEOUT:"ts_invitation_timeout",INVITATION_MODIFIED:"ts_invitation_modified",ACTION_TYPE_UNKNOWN:0,ACTION_TYPE_INVITE:1,ACTION_TYPE_CANCEL_INVITE:2,ACTION_TYPE_ACCEPT_INVITE:3,ACTION_TYPE_REJECT_INVITE:4,ACTION_TYPE_INVITE_TIMEOUT:5},S=(s(x,[{key:"use",value:function(e){if("function"!=typeof e)throw"middleware must be a function";return this.cache.push(e),this}},{key:"next",value:function(e){if(this.middlewares&&0<this.middlewares.length)return this.middlewares.shift().call(this,this.options,this.next.bind(this))}},{key:"run",value:function(e){return this.middlewares=this.cache.map((function(e){return e})),this.options=e,this.next()}}]),x),L=(s(q,[{key:"equal",value:function(e){return null!==e&&this.low===e.low&&this.high===e.high}},{key:"toString",value:function(){var e=Number(this.high).toString(16),t=Number(this.low).toString(16);if(t.length<8)for(var n=8-t.length;n;)t="0"+t,n--;return e+t}}]),q),A={TEST:{CHINA:{DEFAULT:"wss://wss-dev.tim.qq.com"},OVERSEA:{DEFAULT:"wss://wss-dev.tim.qq.com"},SINGAPORE:{DEFAULT:"wss://wsssgp-dev.im.qcloud.com"},KOREA:{DEFAULT:"wss://wsskr-dev.im.qcloud.com"},GERMANY:{DEFAULT:"wss://wssger-dev.im.qcloud.com"},IND:{DEFAULT:"wss://wssind-dev.im.qcloud.com"},JPN:{DEFAULT:"wss://wssjpn-dev.im.qcloud.com"},USA:{DEFAULT:"wss://wssusa-dev.im.qcloud.com"},INDONESIA:{DEFAULT:"wss://wssidn-dev.im.qcloud.com"}},PRODUCTION:{CHINA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",IPV6:"wss://wssv6.im.qcloud.com",BACKUP:"wss://wss.tim.qq.com",STAT:"https://events.im.qcloud.com",ANYCAST:"wss://162.14.13.203"},OVERSEA:{DEFAULT0:"wss://*w4c.my-imcloud.com",DEFAULT:"wss://wss.im.qcloud.com",BACKUP:"wss://wss.my-imcloud.com",STAT:"https://api.my-imcloud.com"},SINGAPORE:{DEFAULT0:"wss://*w4s.my-imcloud.com",DEFAULT:"wss://wsssgp.im.qcloud.com",IPV6:"wss://wsssgpv6.im.qcloud.com",BACKUP:"wss://wsssgp.my-imcloud.com",STAT:"https://apisgp.my-imcloud.com",ANYCAST:"wss://162.14.19.159"},KOREA:{DEFAULT0:"wss://*w4k.my-imcloud.com",DEFAULT:"wss://wsskr.im.qcloud.com",IPV6:"wss://wsskrv6.im.qcloud.com",BACKUP:"wss://wsskr.my-imcloud.com",STAT:"https://apikr.my-imcloud.com",ANYCAST:"wss://162.14.13.104"},GERMANY:{DEFAULT0:"wss://*w4g.my-imcloud.com",DEFAULT:"wss://wssger.im.qcloud.com",IPV6:"wss://wssgerv6.im.qcloud.com",BACKUP:"wss://wssger.my-imcloud.com",STAT:"https://apiger.my-imcloud.com",ANYCAST:"wss://162.14.3.17"},IND:{DEFAULT0:"wss://*w4i.my-imcloud.com",DEFAULT:"wss://wssind.my-imcloud.com",IPV6:"wss://wssindv6.im.qcloud.com",BACKUP:"wss://wssind.im.qcloud.com",STAT:"https://apiind.my-imcloud.com",ANYCAST:"wss://162.14.19.46"},JPN:{DEFAULT0:"wss://*w4j.my-imcloud.com",DEFAULT:"wss://wssjpn.im.qcloud.com",IPV6:"wss://wssjpnv6.im.qcloud.com",BACKUP:"wss://wssjpn.my-imcloud.com",STAT:"https://apijpn.my-imcloud.com"},USA:{DEFAULT0:"wss://*w4u.my-imcloud.com",DEFAULT:"wss://wssusa.im.qcloud.com",IPV6:"wss://wssusav6.im.qcloud.com",BACKUP:"wss://wssusa.my-imcloud.com",STAT:"https://apiusa.my-imcloud.com",ANYCAST:"wss://162.14.10.42"},INDONESIA:{DEFAULT0:"wss://*w4y.my-imcloud.com",DEFAULT:"wss://wssidn.im.qcloud.com",IPV6:"wss://wssidnv6.im.qcloud.com",BACKUP:"wss://wssidn.my-imcloud.com",STAT:"https://apiidn.my-imcloud.com",ANYCAST:"wss://43.129.34.169"}}},k={ANDROID:2,IOS:3,MAC:4,WEB:7,WX_MP:8,QQ_MP:9,TT_MP:10,BAIDU_MP:11,ALI_MP:12,IPAD:13,UNI_NATIVE_APP:15,DONUT_NATIVE_APP:19,NS_NATIVE_APP:20,RN_NATIVE_APP:21},O="1.7.3",N=537048168,P="CHINA",G={HOST:{CURRENT:{DEFAULT:"wss://wss.im.qcloud.com",STAT:"https://events.im.qcloud.com"},setCurrent:function(){this.CURRENT=A.PRODUCTION[0<arguments.length&&void 0!==arguments[0]?arguments[0]:P]}},NAME:{OPEN_IM:"openim",OPEN_IM_MSG_EXT:"openim_msg_ext_http_svc",GRP:"group_open_http_svc",GRP_AV:"group_open_avchatroom_http_svc",GRP_COMMUNITY:"million_group_open_http_svc",GRP_ATTR:"group_open_attr_http_svc",FD:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GRP_NO_AUTH:"group_open_http_noauth_svc",BIG_GRP_POLLING:"group_open_long_polling_http_svc",BIG_GRP_POLLING_NO_AUTH:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat",WEB_IM:"webim",IM_COS_SIGN:"im_cos_sign_svr",CUSTOM_UPLOAD:"im_cos_msg",HEARTBEAT:"heartbeat",IM_OPEN_PUSH:"im_open_push",IM_OPEN_STATUS:"im_open_status",IM_LONG_MSG:"im_long_msg",IM_CONFIG_MANAGER:"im_sdk_config_mgr",STAT_SERVICE:"StatSvc",OVERLOAD_PUSH:"OverLoadPush",IM_MSG_AUDIT_MGR:"im_msg_audit_mgr",TUIROOM_SVR:"tui_room_svr",IM_OPEN_TRANSLATE:"im_open_translate",IM_OPEN_SPEECH:"im_open_speech",MSG_SEARCH:"message_search",GRP_SEARCH:"group_search",GRP_MEMBER_SEARCH:"group_member_search",USER_SEARCH:"user_search",FOLLOW:"follow",OFFLINE_PUSH_REPORT:"offline_push_report",IM_MSG_LOGIC:"im_msg_db_logic"}},U={SEARCH_GRP_SNS:new L(0,Math.pow(2,1)).toString(),AV_HISTORY_MSG:new L(0,Math.pow(2,2)).toString(),GRP_COMMUNITY:new L(0,Math.pow(2,3)).toString(),MSG_TO_SPECIFIED_GRP_MBR:new L(0,Math.pow(2,4)).toString(),AV_MBR_LIST:new L(0,Math.pow(2,6)).toString(),USER_STATUS:new L(0,Math.pow(2,7)).toString(),CONV_MARK:new L(0,Math.pow(2,9)).toString(),CONV_GROUP:new L(0,Math.pow(2,10)).toString(),AV_BAN_MBR:new L(0,Math.pow(2,11)).toString(),MSG_EXT:new L(0,Math.pow(2,13)).toString(),GRP_COUNTER:new L(0,Math.pow(2,15)).toString(),PLUGIN_TRANSLATE:new L(Math.pow(2,6)).toString(),PLUGIN_VOICE_TO_TEXT:new L(Math.pow(2,7)).toString(),PLUGIN_CS:new L(Math.pow(2,8)).toString(),PLUGIN_PUSH:new L(Math.pow(2,9)).toString(),PLUGIN_BOT:new L(Math.pow(2,10)).toString(),MSG_REACTION:new L(Math.pow(2,16)).toString(),FOLLOW:new L(Math.pow(2,20)).toString()},b="group_profile",w=["Type","Name","Introduction","Notification","FaceUrl","Owner_Account","CreateTime","InfoSeq","LastInfoTime","LastMsgTime","MemberNum","MaxMemberNum","ApplyJoinOption","NextMsgSeq","ShutUpAllMember","InviteJoinOption"],F=["Role","JoinTime","MsgSeq","MsgFlag"];function q(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;o(this,q),this.high=e,this.low=t}function x(){o(this,x),this.cache=[],this.options=null}G.HOST.setCurrent(P);for(var V,B="undefined"!=typeof wx&&"function"==typeof wx.getSystemInfoSync&&Boolean(wx.getSystemInfoSync().fontSizeSetting),H=B&&"function"==typeof wx.createGamePortal,K="undefined"!=typeof qq&&"function"==typeof qq.getSystemInfoSync&&Boolean(qq.getSystemInfoSync().fontSizeSetting),W="undefined"!=typeof tt&&"function"==typeof tt.getSystemInfoSync&&Boolean(tt.getSystemInfoSync().fontSizeSetting),Y="undefined"!=typeof swan&&"function"==typeof swan.getSystemInfoSync&&Boolean(swan.getSystemInfoSync().fontSizeSetting),j="undefined"!=typeof my&&"function"==typeof my.getSystemInfoSync&&Boolean(my.getSystemInfoSync().fontSizeSetting),J="undefined"!=typeof jd&&"function"==typeof jd.getSystemInfoSync,z="undefined"!=typeof uni&&"undefined"==typeof window&&"function"==typeof uni.requireNativePlugin,X=B&&"object"===n(wx.miniapp),Q="undefined"!=typeof uni,Z=B||K||W||Y||j||z||J,$="undefined"==typeof window&&!Z&&void 0!==ue&&void 0!==ue.NativeScriptGlobals,ee=void 0!==ue&&(void 0!==ue.nativeModuleProxy||void 0!==ue.ReactNative),te="undefined"!=typeof uni?!Z:"undefined"!=typeof window&&!Z&&!ee,ne=K?qq:W?tt:Y?swan:j?my:B?wx:z?uni:J?jd:{},oe=te&&window&&window.navigator&&window.navigator.userAgent||"",ie=(J="WEB",/(micromessenger|webbrowser)/i.test(oe)?J="WEB":K?J="QQ_MP":W?J="TT_MP":Y?J="BAIDU_MP":j?J="ALI_MP":B?J=X?"DONUT_NATIVE_APP":"WX_MP":z?J="UNI_NATIVE_APP":$?J="NS_NATIVE_APP":ee&&(J="RN_NATIVE_APP"),k[J]),se=(X=/iPad/i.test(oe),$=/iPhone/i.test(oe)&&!X,J=/iPod/i.test(oe),$||X||J),ae=($=oe.match(/OS (\d+)_/i))&&$[1]?$[1]:null,re=/Android/i.test(oe),ce=function(){var e=oe.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;var t=e[1]&&parseFloat(e[1]),n=e[2]&&parseFloat(e[2]);return t&&n?parseFloat(e[1]+"."+e[2]):t||null}(),le=(J=!(X=/Edge/i.test(oe))&&/Chrome/i.test(oe),/MSIE/.test(oe)||-1<oe.indexOf("Trident")&&-1<oe.indexOf("rv:11.0")),de=$=!($=($=/MSIE\s(\d+)\.\d/.exec(oe))&&parseFloat($[1]))&&/Trident\/7.0/i.test(oe)&&/rv:11.0/.test(oe)?11:$,pe=/Safari/i.test(oe)&&!J&&!re&&!X,_e=/Windows/i.test(oe),he=/MAC OS X/i.test(oe),ge=te&&"undefined"!=typeof Worker&&!le,fe=re||se,me=te&&void 0!==window.tencent_cloud_im_csig_flutter_for_web_25F_cy,ve=function(){if("undefined"==typeof window||void 0===window.navigator)return!1;var e=window.navigator.standalone;return!(!se||e||pe)}(),Ie="undefined"!=typeof console?console:void 0!==ue&&ue.console?ue.console:"undefined"!=typeof window&&window.console?window.console:{},ye=function(){},Me=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],Ce=Me.length;Ce--;)V=Me[Ce],console[V]||(Ie[V]=ye);function Te(){var e=new Date;return e.setTime(Le()),e}function Ee(){Se=0}function De(){return Math.floor(Le()/1e3)}var Re=Ie,Se=0,Le=function(){return(new Date).getTime()+Se},Ae=0;function ke(){return Kt()?"%c Chat %c":"Chat"}function Oe(){var e=Te();return e.toLocaleTimeString("en-US",{hour12:!1})+"."+function(e){var t;switch(e.toString().length){case 1:t="00"+e;break;case 2:t="0"+e;break;default:t=e}return t}(e.getMilliseconds())}var Ne={arguments2String:function(e){var t="";if(1===e.length)t=e[0];else for(var n=0,o=e.length;n<o;n++){if(_t(e[n]))try{t+=ht(e[n])?JSON.stringify(e[n],["message","code"]):JSON.stringify(e[n])}catch(e){t+=e?e.message:"";break}else t+=e[n];t+=" "}return t},_exec:function(e,t){Kt()?Re[e](ke(),"background:#0abf5b; padding:1px; border-radius:3px; color: #fff","background:transparent",Oe(),t):Re[e]("".concat(ke()," ").concat(Oe()," ").concat(t))},d:function(){var e;Ae<=-1&&(e=this.arguments2String(arguments),this._exec("debug",e))},l:function(){var e;Ae<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},log:function(){var e;Ae<=0&&(e=this.arguments2String(arguments),this._exec("log",e))},i:function(){var e;Ae<=1&&(e=this.arguments2String(arguments),this._exec("info",e))},w:function(){var e;Ae<=2&&(e=this.arguments2String(arguments),this._exec("warn",e))},e:function(){var e;Ae<=3&&(e=this.arguments2String(arguments),this._exec("error",e))},setLevel:function(e){e<4&&this._exec("log","set level from "+Ae+" to "+e),Ae=e},getLevel:function(){return Ae}},Pe={JPG:1,JPEG:1,GIF:2,PNG:3,BMP:4,UNKNOWN:255},Ge={NICK:"".concat($="Tag_Profile_IM_","Nick"),GENDER:"".concat($,"Gender"),BIRTHDAY:"".concat($,"BirthDay"),LOCATION:"".concat($,"Location"),SELFSIGNATURE:"".concat($,"SelfSignature"),ALLOWTYPE:"".concat($,"AllowType"),LANGUAGE:"".concat($,"Language"),AVATAR:"".concat($,"Image"),MESSAGESETTINGS:"".concat($,"MsgSettings"),ADMINFORBIDTYPE:"".concat($,"AdminForbidType"),LEVEL:"".concat($,"Level"),ROLE:"".concat($,"Role")},Ue={GROUP:"".concat("Tag_SNS_IM_","Group"),REMARK:"".concat("Tag_SNS_IM_","Remark"),ADDSOURCE:"".concat("Tag_SNS_IM_","AddSource"),ADDWORDING:"".concat("Tag_SNS_IM_","Wording"),ADDTIME:"".concat("Tag_SNS_IM_","AddTime")},be={UNKNOWN:"".concat(J="Gender_Type_","Unknown"),FEMALE:"".concat(J,"Female"),MALE:"".concat(J,"Male")},we={NONE:"".concat("AdminForbid_Type_","None"),SEND_OUT:"".concat("AdminForbid_Type_","SendOut")},Fe={NEED_CONFIRM:"".concat("AllowType_Type_","NeedConfirm"),ALLOW_ANY:"".concat("AllowType_Type_","AllowAny"),DENY_ANY:"".concat("AllowType_Type_","DenyAny")},qe="JoinedSuccess",xe="WaitAdminApproval",Ve="@TOPIC#_",Be=Object.prototype.hasOwnProperty;function He(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(ze(e)){for(var t in e)if(Be.call(e,t))return!1;return!0}return!!(Ke(e)||We(e)||Ye(e))&&0===e.size}function Ke(e){return"map"===gt(e)}function We(e){return"set"===gt(e)}function Ye(e){return"file"===gt(e)}function je(e){return null!==e&&("number"==typeof e&&!isNaN(+e)||"object"===n(e)&&e.constructor===Number)}function Je(e){return null!==e&&"object"===n(e)}function ze(e){if("object"===n(e)&&null!==e){if(null===(e=Object.getPrototypeOf(e)))return 1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return e===t}}function Xe(e){return"function"==typeof Array.isArray?Array.isArray(e):"array"===gt(e)}function Qe(e){return Xe(e)&&0<e.length}function Ze(e){return"function"==typeof e}function $e(e){return"filelist"===gt(e)}function et(e){return"string"==typeof e&&(e=e[0],!/[^a-zA-Z0-9]/.test(e))}function nt(e,t,n,o){if(!_t(e)||!_t(t))return 0;for(var i,s=0,a=Object.keys(t),r=0,c=a.length;r<c;r++)if(i=a[r],!(pt(t[i])||n&&n.includes(i)))if(_t(e[i])&&_t(t[i]))s+=nt(e[i],t[i],n,o);else{if(o&&o.includes(t[i]))continue;e[i]!==t[i]&&(e[i]=t[i],s+=1)}return s}function ot(e,t){var n,o=new Map,i=T(e.entries());try{for(i.s();!(n=i.n()).done;){var s=f(n.value,2),a=s[0],r=s[1];r&&o.set(a,t?JSON.stringify(r):JSON.parse(JSON.stringify(r)))}}catch(e){i.e(e)}finally{i.f()}return o}function it(e){if(0===e.length)return 0;for(var t=0,n=0,o="undefined"!=typeof document&&void 0!==document.characterSet?document.characterSet:"UTF-8";void 0!==e[t];)n+=e[t++].charCodeAt[t]<=255?1:!1===o?3:2;return n}function st(e){return e=e||99999999,Math.round(Math.random()*e)}function at(){for(var e="",t=32;0<t;--t)e+=ft[Math.floor(Math.random()*mt)];return e}function rt(e,t){for(var n in e)if(e[n]===t)return 1}function ct(e){return-1===e.indexOf("http://")||-1===e.indexOf("https://")?"https://"+e:e.replace(/https|http/,"https")}function ut(e){if(0===Object.getOwnPropertyNames(e).length)return Object.create(null);var t,o,i=Array.isArray(e)?[]:Object.create(null);for(o in e)null!==e[o]?void 0!==e[o]?(t=n(e[o]),0<=["string","number","function","boolean"].indexOf(t)?i[o]=e[o]:i[o]=ut(e[o])):i[o]=void 0:i[o]=null;return i}var lt=["url"],dt=function(e){return"string"==typeof e},pt=function(e){return void 0===e},_t=function(e){return Xe(e)||Je(e)},ht=function(e){return e instanceof Error},gt=function(e){return Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase()},ft=(Date.now||(Date.now=function(){return(new Date).getTime()}),"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),mt=ft.length,vt={};function It(e,t){if(!Xe(e)||!Xe(t))return!1;var n=!1;return t.forEach((function(t){var o=t.key,i=(t=t.value,e.find((function(e){return e.key===o})));i?i.value!==t&&(i.value=t,n=!0):(e.push({key:o,value:t}),n=!0)})),n}function yt(e){return He(e)?[]:e.filter((function(e){return!0===e.isModified}))}function Mt(e){if(ze(e)&&ze(e.webhookInfo)){var t=[];if(e.webhookInfo.disableCloudMessagePreHook&&t.push("ForbidBeforeSendMsgCallback"),e.webhookInfo.disableCloudMessagePostHook&&t.push("ForbidAfterSendMsgCallback"),0!==t.length)return t}}function Ct(e){return He(e)?[]:e.filter((function(e){return!1===e.isModified}))}function Tt(e){return e===D.GRP_AVCHATROOM}function Et(e){var t=e.type;return e=e.groupID,t===D.GRP_COMMUNITY||"".concat(e).startsWith("@TGS#_")&&!"".concat(e).includes(Ve)}function Dt(e){return"".concat(e).startsWith("@TGS#_")&&"".concat(e).includes(Ve)}function Rt(e){return dt(e)&&e.slice(0,3)===D.CONV_C2C}function St(e){return dt(e)&&e.slice(0,5)===D.CONV_GROUP}function Lt(e){return dt(e)&&e===D.CONV_SYSTEM}function At(e,t){var n={};return Object.keys(e).forEach((function(o){n[o]=t(e[o],o)})),n}function kt(e){return ee?Promise.resolve({width:0,height:0}):Z?new Promise((function(t,n){ne.getImageInfo({src:e,success:function(e){t({width:e.width,height:e.height})},fail:function(){t({width:0,height:0})}})})):le&&9===de?Promise.resolve({width:0,height:0}):new Promise((function(t,n){var o=new Image;o.onload=function(){t({width:this.width,height:this.height}),o=null},o.onerror=function(){t({width:0,height:0}),o=null},o.src=e}))}function Ot(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return"".concat(e()+e()).concat(e()).concat(e()).concat(e()).concat(e()).concat(e()).concat(e())}function Nt(){var e=re?"android":se?"ios":_e?"windows":he?"mac":"unknown";if(Z)try{var t=ne.getSystemInfoSync().platform;void 0!==t&&(e=t)}catch(e){}return e}function Pt(e,t){e=e.split("."),t=t.split(".");for(var n=Math.max(e.length,t.length);e.length<n;)e.push("0");for(;t.length<n;)t.push("0");for(var o=0;o<n;o++){var i=parseInt(e[o]),s=parseInt(t[o]);if(s<i)return 1;if(i<s)return-1}return 0}function Gt(e){var t=void 0===(t=e.originUrl)?void 0:t,n=e.originWidth,o=e.originHeight,i=(e=void 0===(e=e.min)?198:e,{url:void 0,width:0,height:0});return((n=parseInt(n))<=(o=parseInt(o))?n:o)<=e?(i.url=t,i.width=n,i.height=o):(o<=n?(i.width=Math.ceil(n*e/o),i.height=e):(i.width=e,i.height=Math.ceil(o*e/n)),o=t&&-1<t.indexOf("?")?"".concat(t,"&"):"".concat(t,"?"),i.url="".concat(o,198===e?"imageView2/3/w/198/h/198":"imageView2/3/w/720/h/720")),pt(t)?(i.url,_(i,lt)):i}function Ut(e){var t=e[2];e[2]=e[1],e[1]=t;for(var n=0;n<e.length;n++)e[n].setType(n)}function bt(e){return(e=e.servcmd).slice(e.indexOf(".")+1)}function wt(e,t){return Math.round(Number(e)*Math.pow(10,t))/Math.pow(10,t)}function Ft(e,t){return e.includes(t)}function qt(e,t){return e.includes(t)}function xt(e){return e.split(Ve)[0]}var Vt=function(e,t,n){if(pt(t))return"";switch(e){case D.MSG_TEXT:return t.text;case D.MSG_IMAGE:return n?"[Image]":"[图片]";case D.MSG_LOCATION:return n?"[Location]":"[位置]";case D.MSG_AUDIO:return n?"[Voice]":"[语音]";case D.MSG_VIDEO:return n?"[Video]":"[视频]";case D.MSG_FILE:return n?"[File]":"[文件]";case D.MSG_CUSTOM:return n?"[Custom Messages]":"[自定义消息]";case D.MSG_GRP_TIP:return n?"[Group Notification]":"[群提示消息]";case D.MSG_GRP_SYS_NOTICE:return n?"[Group System Message]":"[群系统通知]";case D.MSG_FACE:return n?"[Animated Sticker]":"[动画表情]";case D.MSG_MERGER:return n?"[Chat Record]":"[聊天记录]";default:return""}};function Bt(e){return e===D.MSG_TEXT||e===D.MSG_CUSTOM||e===D.MSG_LOCATION||e===D.MSG_FACE}function Ht(e){var t=[];if(!dt(e))return t;var n=e.length;if(0===n)return t;for(var o=n-1;0<=o;o--)"1"===e[o]&&t.push(Math.pow(2,n-o-1));return t}function Kt(){return!le&&!Z}function Wt(e){return"the length of userIDList cannot exceed ".concat(e)}function Yt(e){var t;if(Xe(e)&&0!==e.length)return t=0,e.forEach((function(e){t+=e})),t.toFixed(0)}function jt(e){var t;if(Xe(e)&&0!==e.length)return t=0,e.forEach((function(e){t+=e})),(t/e.length).toFixed(0)}function Jt(e,t,n){t=!(1<arguments.length&&void 0!==t)||t,n=!(2<arguments.length&&void 0!==n)||n;var o=Date.now();return t?n?"".concat(o-e," ms"):"".concat(Math.round((o-e)/1e3)," s"):n?o-e:Math.round((o-e)/1e3)}function zt(e){return!!(e&&1<e)}function Xt(e,t,n,o){if(void 0===t)return 1;var i,s,a=!0;return t.required&&He(e)&&(Ne.e("[".concat(n,'] Missing required params: "').concat(o,'".')),a=!1),He(e)||(i=gt(e))!==(s=t.type.toLowerCase())&&("asyncfunction"===i&&"function"===s||(Ne.e("[".concat(n,'] Invalid params: type check failed for "').concat(o,'". Expected ').concat(t.type,".")),a=!1)),t.validator&&!t.validator(e,n,o)&&(Ne.e("[".concat(n,'] Invalid params: custom validator check failed for "').concat(o,'".')),a=!1),a}function Qt(e){return!(!e||!(Rt(e)||St(e)||Lt(e))&&((e=Fn("InvalidConversationID",e))&&Ne.w(e),1))}function Zt(e){""!==e.desc&&""!==Fn("API_REFER")&&Ne.w("[".concat(e.api,"] | ").concat(e.paramName," | ").concat(e.desc,", ").concat(Fn("API_REFER")).concat(e.api))}function $t(){return Fn("StringRequiredLog")}function en(e){return Fn("NonEmptyStringRequiredLog",e)}function tn(){return Fn("NumberRequiredLog")}function nn(){return Fn("UndefinedNotAllowedLog")}function on(){return Fn("FileRequiredLog")}function sn(){return Fn("FunctionRequiredLog")}function an(){return Fn("ArrayRequiredLog")}function rn(){return Fn("NonEmptyArrayLog")}function cn(){return Fn("CallbackMissingLog")}function un(){return Fn("PositiveIntegerRequiredLog")}function ln(e,t){return Fn("StringNotLongerThanLog",e,t)}function dn(e,t){return Fn("NumberGreaterThanLog",e,t)}function pn(e,t){return Fn("NumberGreaterOrEqualLog",e,t)}function _n(e){return Fn("KeyValueStringRequiredLog",e)}function hn(){return Fn("PlainObjectRequiredLog")}function gn(){return Fn("NonEmptyContentRequiredLog")}function fn(){return Fn("FileNotSelectedLog")}function mn(){return Fn("MessageInstanceRequiredLog")}function vn(){return Fn("NonAnonymousFunctionLog")}function In(){return Fn("MessageExtensionNotAvailableLog")}function yn(){return Fn("MessageReactionRequiredLog")}function Mn(e,t){return Fn("ContainsUnsupportedTypeLog",e,t)}function Cn(e,t,n,o){var i=o.allowUndefined,s=o.allowEmpty;return o=o.maxLength,pt(e)?!!i||(Zt({api:t,paramName:n,desc:nn()}),!1):Xe(e)?!(0===e.length&&(Zt({api:t,paramName:n,desc:rn()}),!s)||o&&e.length>o&&(Zt({api:t,paramName:n,desc:Fn("MaximumArrayLengthLog",n,o)}),1)):(Zt({api:t,paramName:n,desc:an()}),!1)}function Tn(e,t,n,o){var i=o.allowUndefined,s=o.min;return o=o.max,pt(e)?!!i||(Zt({api:t,paramName:n,desc:nn()}),!1):je(e)?je(s)&&e<s?(Zt({api:t,paramName:n,desc:0===s?pn(n,s):dn(n,s-1)}),!1):!(je(o)&&o<e&&(Zt({api:t,paramName:n,desc:Fn("MaximumNumberLog",n,o)}),1)):(Zt({api:t,paramName:n,desc:tn()}),!1)}function En(e){return{code:0,data:e||{}}}function Dn(e){return Promise.resolve(En(e))}function Rn(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof Vn)return t&&null!==Hn&&Hn.emit(E.ERROR,e),Promise.reject(e);if(e instanceof Error)return n=new Vn({code:Bn.UNCAUGHT_ERROR}),t&&null!==Hn&&Hn.emit(E.ERROR,n),Promise.reject(n);if(pt(e)||pt(e.code))return Promise.reject(new Vn({code:Bn.UNCAUGHT_ERROR}));var n=new Vn(e);return t&&null!==Hn&&Hn.emit(E.ERROR,n),Promise.reject(n)}var Sn,Ln="unSend",An="success",kn="fail",On="notStart",Nn="pending",Pn="resolved",Gn="rejected",Un={type:"Boolean",required:!0},bn={type:"number",required:!0},wn={keywordListForMsg:{type:"Array",required:!1,validator:function(e,t,n){return Cn(e,t,n,{allowUndefined:!0,allowEmpty:!0,maxLength:5})}},keywordListExceptMsg:{type:"Array",required:!0,validator:function(e,t,n){return Cn(e,t,n,{allowUndefined:!1,allowEmpty:!1,maxLength:5})}},keywordListMatchType:{type:"String",required:!1,validator:function(e,t,n){return!e||"or"===e||"and"===e||Zt({api:t,paramName:n,desc:"".concat(e," is invalid match type")})}},cursor:{type:"String",required:!1},count:{type:"Number",required:!1,validator:function(e,t,n){return Tn(e,t,n,{allowUndefined:!0,min:1,max:100})}},groupTypeList:{type:"Array",required:!1,validator:function(e,t,n){if(!e)return!0;if(!Cn(e,t,n,{allowUndefined:!0,allowEmpty:!0}))return!1;var o=[D.GRP_PUBLIC,D.GRP_COMMUNITY,D.GRP_WORK,D.GRP_MEETING];return!(0<e.filter((function(e){return-1===o.indexOf(e)})).length&&(Zt({api:t,paramName:n,desc:Mn(n,"group")}),1))}}},Fn=null,qn={hookGetAPITips:function(e){Fn=e},login:{userID:X={type:"String",required:!0},userSig:X},addToBlacklist:{userIDList:$={type:"Array",required:!0}},removeFromBlacklist:{userIDList:$},on:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(Zt({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(Zt({api:t,paramName:n,desc:sn()}),!1):(""===e.name&&Zt({api:t,paramName:n,desc:vn()}),!0)}}],once:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(Zt({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(Zt({api:t,paramName:n,desc:sn()}),!1):(""===e.name&&Zt({api:t,paramName:n,desc:vn()}),!0)}}],off:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(Zt({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(Zt({api:t,paramName:n,desc:sn()}),!1):(""===e.name&&Zt({api:t,paramName:n,desc:vn()}),!0)}}],sendMessage:[t({name:"message"},J={type:"Object",required:!0})],setMessageExtensions:[t(t({name:"message"},J),{},{validator:function(e,t,n){return e.status===An&&!0===e.isSupportExtension||(Zt({api:t,paramName:n,desc:In()}),!1)}}),t({name:"extensions"},$)],getMessageExtensions:[t(t({name:"message"},J),{},{validator:function(e,t,n){return e.status===An&&!0===e.isSupportExtension||(Zt({api:t,paramName:n,desc:In()}),!1)}})],deleteMessageExtensions:[t(t({name:"message"},J),{},{validator:function(e,t,n){return e.status===An&&!0===e.isSupportExtension||(Zt({api:t,paramName:n,desc:In()}),!1)}})],addMessageReaction:[t(t({name:"message"},J),{},{validator:function(e,t,n){return e.status===An||(Zt({api:t,paramName:n,desc:yn()}),!1)}}),t({name:"reactionID"},X)],removeMessageReaction:[t(t({name:"message"},J),{},{validator:function(e,t,n){return e.status===An||(Zt({api:t,paramName:n,desc:yn()}),!1)}}),t({name:"reactionID"},X)],getMessageReactions:{messageList:t({},$)},getAllUserListOfMessageReaction:{message:t(t({},J),{},{validator:function(e,t,n){return e.status===An||(Zt({api:t,paramName:n,desc:yn()}),!1)}}),reactionID:t({},X),nextSeq:{type:"Number"},count:{type:"Number"}},getMessageList:{conversationID:t(t({},X),{},{validator:Qt}),nextReqMessageID:{type:"String"},count:{type:"Number",validator:function(e,t,n){return!(!pt(e)&&!/^[1-9][0-9]*$/.test(e)&&(Zt({api:t,paramName:n,desc:un()}),1))}}},getMessageListHopping:{conversationID:t(t({},X),{},{validator:Qt}),sequence:{type:"Number"},time:{type:"Number"},direction:{type:"Number",validator:function(e,t,n){return!(!pt(e)&&0!==e&&1!==e&&(Zt({api:t,paramName:n,desc:Fn("0Or1RequiredLog")}),1))}},count:{type:"Number",validator:function(e,t,n){return!(!pt(e)&&!/^[1-9][0-9]*$/.test(e)&&(Zt({api:t,paramName:n,desc:un}),1))}}},setMessageRead:{conversationID:t(t({},X),{},{validator:Qt})},setAllMessageRead:{scope:{type:"String",required:!1,validator:function(e,t,n){return!e||-1!==[D.READ_ALL_C2C_MSG,D.READ_ALL_GROUP_MSG,D.READ_ALL_MSG].indexOf(e)||(Zt({api:t,paramName:n,desc:Fn("ValidScopeRequired")}),!1)}}},getConversationProfile:[t(t({name:"conversationID"},X),{},{validator:Qt})],clearHistoryMessage:[t(t({name:"conversationID"},X),{},{validator:Qt})],pinConversation:{conversationID:t(t({},X),{},{validator:Qt}),isPinned:t({},Un)},setConversationDraft:{conversationID:t(t({},X),{},{validator:Qt}),draftText:{type:"String",validator:function(e,t,n){return!!dt(e)||(Zt({api:t,paramName:n,desc:$t()}),!1)}}},setConversationCustomData:{conversationIDList:t({},$),customData:{type:"String",validator:function(e,t,n){return dt(e)?!(256<e.length&&(Zt({api:t,paramName:n,desc:ln(n,256)}),1)):(Zt({api:t,paramName:n,desc:$t()}),!1)}}},markConversation:{conversationIDList:t({},$),markType:{type:"number",validator:function(e,t,n){return je(e)?e<=0?(Zt({api:t,paramName:n,desc:dn(n,0)}),!1):!(e>=Math.pow(2,64)&&(Zt({api:t,paramName:n,desc:Fn("NumberLessThanLog",n,"Math.pow(2,64)")}),1)):(Zt({api:t,paramName:n,desc:tn()}),!1)}},enableMark:t({},Un)},createConversationGroup:{conversationIDList:t({},$),groupName:t(t({},X),{},{validator:function(e,t,n){return!(!e||32<e.length&&(Zt({api:t,paramName:n,desc:ln(n,32)}),1))}})},deleteConversationGroup:[t({name:"groupName"},X)],renameConversationGroup:{oldName:t({},X),newName:t(t({},X),{},{validator:function(e,t,n){return!(!e||32<e.length&&(Zt({api:t,paramName:n,desc:ln(n,32)}),1))}})},addConversationsToGroup:{conversationIDList:t({},$),groupName:t({},X)},deleteConversationsFromGroup:{conversationIDList:t({},$),groupName:t({},X)},getGroupList:{groupProfileFilter:{type:"Array"}},getGroupProfile:{groupID:X,groupCustomFieldFilter:{type:"Array"},memberCustomFieldFilter:{type:"Array"}},getGroupProfileAdvance:{groupIDList:$},createGroup:{name:X},joinGroup:{groupID:X,type:{type:"String"},applyMessage:{type:"String"}},quitGroup:[t({name:"groupID"},X)],handleApplication:{message:J,handleAction:X,handleMessage:{type:"String"}},changeGroupOwner:{groupID:X,newOwnerID:X},updateGroupProfile:{groupID:X,muteAllMembers:{type:"Boolean"}},dismissGroup:[t({name:"groupID"},X)],searchGroupByID:[t({name:"groupID"},X)],getGroupOnlineMemberCount:[t({name:"groupID"},X)],initGroupAttributes:{groupID:X,groupAttributes:t(t({},J),{},{validator:function(e,t,n){var o=!0;return Object.keys(e).forEach((function(i){if(!dt(e[i]))return Zt({api:t,paramName:n,desc:_n("value")}),o=!1})),o}})},setGroupAttributes:{groupID:X,groupAttributes:t(t({},J),{},{validator:function(e,t,n){var o=!0;return Object.keys(e).forEach((function(i){if(!dt(e[i]))return Zt({api:t,paramName:n,desc:_n("value")}),o=!1})),o}})},deleteGroupAttributes:{groupID:X,keyList:{type:"Array",validator:function(e,t,n){return pt(e)||!Xe(e)?(Zt({api:t,paramName:n,desc:an()}),!1):!!He(e)||(o=!0,e.forEach((function(e){if(!dt(e))return Zt({api:t,paramName:n,desc:Fn("StringArrayRequiredLog")}),o=!1})),o);var o}}},getGroupAttributes:{groupID:X,keyList:{type:"Array",validator:function(e,t,n){return pt(e)||!Xe(e)?(Zt({api:t,paramName:n,desc:an()}),!1):!!He(e)||(o=!0,e.forEach((function(e){if(!dt(e))return Zt({api:t,paramName:n,desc:_n("key")}),o=!1})),o);var o}}},setGroupCounters:{groupID:X,counters:J},increaseGroupCounter:{groupID:X,key:X,value:bn},decreaseGroupCounter:{groupID:X,key:X,value:bn},getGroupCounters:{groupID:X},getGroupMemberList:{groupID:X,count:{type:"Number"}},getGroupMemberProfile:{groupID:X,userIDList:$,memberCustomFieldFilter:{type:"Array"}},addGroupMember:{groupID:X,userIDList:$},setGroupMemberRole:{groupID:X,userID:X,role:X},setGroupMemberMuteTime:{groupID:X,userID:X,muteTime:{type:"Number",validator:function(e){return 0<=e}}},setGroupMemberNameCard:{groupID:X,userID:{type:"String"},nameCard:{type:"String",validator:function(e,t,n){return dt(e)?(e.length,!0):(Zt({api:t,paramName:n,desc:$t()}),!1)}}},setGroupMemberCustomField:{groupID:X,userID:{type:"String"},memberCustomField:$},deleteGroupMember:{groupID:X},markGroupMemberList:{groupID:X,markType:{type:"number",validator:function(e,t,n){return je(e)?!(e<1e3&&(Zt({api:t,paramName:n,desc:pn(n,1e3)}),1)):(Zt({api:t,paramName:n,desc:tn()}),!1)}},userIDList:t({},$),enableMark:t({},Un)},createTextMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){return ze(e)?dt(e.text)?0!==e.text.length||(Zt({api:t,paramName:"payload.text",desc:gn()}),!1):(Zt({api:t,paramName:"payload.text",desc:$t()}),!1):(Zt({api:t,paramName:n,desc:hn()}),!1)}})},createTextAtMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){return ze(e)?dt(e.text)?0===e.text.length?(Zt({api:t,paramName:"payload.text",desc:gn()}),!1):!(e.atUserList&&!Xe(e.atUserList)&&(Zt({api:t,paramName:"payload.atUserList",desc:an()}),1)):(Zt({api:t,paramName:"payload.text",desc:$t()}),!1):(Zt({api:t,paramName:n,desc:hn()}),!1)}})},createCustomMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){return ze(e)?e.data&&!dt(e.data)?(Zt({api:t,paramName:"payload.data",desc:$t()}),!1):e.description&&!dt(e.description)?(Zt({api:t,paramName:"payload.description",desc:$t()}),!1):!(e.extension&&!dt(e.extension)&&(Zt({api:t,paramName:"payload.extension",desc:$t()}),1)):(Zt({api:t,paramName:"payload",desc:hn()}),!1)}})},createImageMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){if(!ze(e))return Zt({api:t,paramName:n,desc:hn()}),!1;if(pt(e.file))return Zt({api:t,paramName:"payload.file",desc:nn()}),!1;if(te){if(!(e.file instanceof HTMLInputElement||Ye(e.file)))return ze(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(Zt({api:t,paramName:"payload.file",desc:fn()}),!1):(Zt({api:t,paramName:"payload.file",desc:on()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Zt({api:t,paramName:"payload.file",desc:fn()}),!1}return!0},onProgress:{type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:cn()}),!0}}})},createAudioMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){return!!ze(e)||(Zt({api:t,paramName:n,desc:hn()}),!1)}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:cn()}),!0}}},createVideoMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){if(!ze(e))return Zt({api:t,paramName:n,desc:hn()}),!1;if(pt(e.file))return Zt({api:t,paramName:"payload.file",desc:nn()}),!1;if(te){if(!(e.file instanceof HTMLInputElement||Ye(e.file)))return ze(e.file)&&"undefined"!=typeof uni?!!Ye(e.file.tempFile)||(Zt({api:t,paramName:"payload.file",desc:fn()}),!1):(Zt({api:t,paramName:"payload.file",desc:on()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Zt({api:t,paramName:"payload.file",desc:fn()}),!1}return!0}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:cn()}),!0}}},createFaceMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){return ze(e)?je(e.index)?!!dt(e.data)||(Zt({api:t,paramName:"payload.data",desc:$t()}),!1):(Zt({api:t,paramName:"payload.index",desc:tn()}),!1):(Zt({api:t,paramName:n,desc:hn()}),!1)}})},createFileMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){if(!ze(e))return Zt({api:t,paramName:n,desc:hn()}),!1;if(pt(e.file))return Zt({api:t,paramName:"payload.file",desc:nn()}),!1;if(te){if(!(e.file instanceof HTMLInputElement||Ye(e.file)))return ze(e.file)&&"undefined"!=typeof uni?0!==e.file.tempFilePaths.length&&0!==e.file.tempFiles.length||(Zt({api:t,paramName:"payload.file",desc:fn()}),!1):(Zt({api:t,paramName:"payload.file",desc:on()}),!1);if(e.file instanceof HTMLInputElement&&0===e.file.files.length)return Zt({api:t,paramName:"payload.file",desc:fn()}),!1}return!0}}),onProgress:{type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:cn()}),!0}}},createLocationMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){return ze(e)?dt(e.description)?je(e.longitude)?!!je(e.latitude)||(Zt({api:t,paramName:"payload.latitude",desc:tn()}),!1):(Zt({api:t,paramName:"payload.longitude",desc:tn()}),!1):(Zt({api:t,paramName:"payload.description",desc:$t()}),!1):(Zt({api:t,paramName:n,desc:hn()}),!1)}})},createMergerMessage:{to:X,conversationType:X,payload:t(t({},J),{},{validator:function(e,t,n){if(He(e.messageList))return Zt({api:t,paramName:"payload.messageList",desc:rn()}),!1;if(He(e.compatibleText))return Zt({api:t,paramName:"payload.compatibleText",desc:en("compatibleText")}),!1;var o=!1;return e.messageList.forEach((function(e){e.status===kn&&(o=!0)})),!o||(Zt({api:t,paramName:"payload.messageList",desc:Fn("MergeFailedMessageLog")}),!1)}})},revokeMessage:[t(t({name:"message"},J),{},{validator:function(e,t,n){return He(e)?(Zt({api:t,paramName:n,desc:mn()}),!1):e.conversationType===D.CONV_SYSTEM?(Zt({api:t,paramName:n,desc:Fn("MessageCanBeRevokedDesc")}),!1):!0!==e.isRevoked||(Zt({api:t,paramName:n,desc:Fn("MessageRevokedLog")}),!1)}})],deleteMessage:[t(t({name:"messageList"},$),{},{validator:function(e,t,n){return!He(e)||(Zt({api:t,paramName:n,desc:rn()}),!1)}})],translateText:{sourceTextList:$,sourceLanguage:X,targetLanguage:X},convertVoiceToText:{message:t(t({},J),{},{validator:function(e,t,n){return He(e)?(Zt({api:t,paramName:n,desc:mn()}),!1):e.type===D.MSG_AUDIO&&e.status===An||(Zt({api:t,paramName:n,desc:Fn("AudioMessageRequiredLog")}),!1)}})},modifyMessage:[t(t({name:"message"},J),{},{validator:function(e,t,n){return He(e)?(Zt({api:t,paramName:n,desc:mn()}),!1):e.conversationType===D.CONV_SYSTEM?(Zt({api:t,paramName:n,desc:Fn("MessageCanBeModifiedLog")}),!1):!0!==e._onlineOnlyFlag||(Zt({api:t,paramName:n,desc:Fn("OnlineMessageNotSupportLog")}),!1)}})],searchCloudMessages:{keywordList:wn.keywordListForMsg,keywordListMatchType:wn.keywordListMatchType,cursor:wn.cursor,senderUserIDList:{type:"Array",required:!1,validator:function(e,t,n){return Cn(e,t,n,{allowUndefined:!0,allowEmpty:!0,maxLength:5})}},messageTypeList:{type:"Array",required:!1,validator:function(e,t,n){if(!e)return!0;if(!Cn(e,t,n,{allowUndefined:!0,allowEmpty:!0}))return!1;var o=[D.MSG_TEXT,D.MSG_IMAGE,D.MSG_AUDIO,D.MSG_FILE,D.MSG_VIDEO,D.MSG_LOCATION,D.MSG_CUSTOM,D.MSG_MERGER];return!(0<e.filter((function(e){return-1===o.indexOf(e)})).length&&(Zt({api:t,paramName:n,desc:Mn(n,"message")}),1))}},conversationID:{type:"String",required:!1,validator:function(e){return!e||Qt(e)}},timePosition:{type:"number",required:!1,validator:function(e,t,n){return Tn(e,t,n,{allowUndefined:!0,min:0})}},timePeriod:{type:"number",required:!1,validator:function(e,t,n){return Tn(e,t,n,{allowUndefined:!0,min:0})}}},searchCloudUsers:{keywordList:wn.keywordListExceptMsg,keywordListMatchType:wn.keywordListMatchType,cursor:wn.cursor,count:wn.count,miniBirthday:{type:"Number",required:!1,validator:function(e,t,n){return Tn(e,t,n,{allowUndefined:!0,min:0})}},maxBirthday:{type:"Number",required:!1,validator:function(e,t,n){return Tn(e,t,n,{allowUndefined:!0,min:0})}},gender:{type:"String",required:!1,validator:function(e,t,n){return!e||e===D.GENDER_FEMALE||e===D.GENDER_MALE||Zt({api:t,paramName:n,desc:"".concat(e," is invalid match type")})}}},searchCloudGroups:{keywordList:wn.keywordListExceptMsg,keywordListMatchType:wn.keywordListMatchType,cursor:wn.cursor,count:wn.count,groupTypeList:wn.groupTypeList},searchCloudGroupMembers:{keywordList:wn.keywordListExceptMsg,keywordListMatchType:wn.keywordListMatchType,cursor:wn.cursor,count:wn.count,groupTypeList:wn.groupTypeList,groupIDList:{type:"Array",required:!1,validator:function(e,t,n){return Cn(e,t,n,{allowUndefined:!0,allowEmpty:!0})}}},getUserProfile:{userIDList:{type:"Array",validator:function(e,t,n){return Xe(e)?(0===e.length&&Zt({api:t,paramName:n,desc:rn()}),!0):(Zt({api:t,paramName:n,desc:an()}),!1)}}},updateMyProfile:{profileCustomField:{type:"Array",validator:function(e,t,n){return!!pt(e)||!!Xe(e)||(Zt({api:t,paramName:n,desc:an()}),!1)}}},setSelfStatus:{customStatus:{type:"String",validator:function(e,t,n){return!!dt(e)||(Zt({api:t,paramName:n,desc:$t()}),!1)}}},getUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return Xe(e)?0!==e.length||(Zt({api:t,paramName:n,desc:rn()}),!1):(Zt({api:t,paramName:n,desc:an()}),!1)}}},subscribeUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return Xe(e)?0!==e.length||(Zt({api:t,paramName:n,desc:rn()}),!1):(Zt({api:t,paramName:n,desc:an()}),!1)}}},unsubscribeUserStatus:{userIDList:{type:"Array",validator:function(e,t,n){return!e||!!Xe(e)||(Zt({api:t,paramName:n,desc:an()}),!1)}}},addFriend:{to:X,source:{type:"String",required:!0,validator:function(e,t,n){return!(!e||(e.startsWith("AddSource_Type_")?8<e.replace("AddSource_Type_","").length&&(Zt({api:t,paramName:n,desc:ln("keyword",8)}),1):(Zt({api:t,paramName:n,desc:Fn("SourcePrefixLog")}),1)))}},remark:{type:"String",required:!1,validator:function(e,t,n){return!(dt(e)&&96<e.length&&(Zt({api:t,paramName:n,desc:ln(n,96)}),1))}}},deleteFriend:{userIDList:$},checkFriend:{userIDList:$},getFriendProfile:{userIDList:$},updateFriend:{userID:X,remark:{type:"String",required:!1,validator:function(e,t,n){return!(dt(e)&&96<e.length&&(Zt({api:t,paramName:n,desc:ln(n,96)}),1))}},friendCustomField:{type:"Array",required:!1,validator:function(e,t,n){if(e){if(!Xe(e))return Zt({api:t,paramName:n,desc:an()}),!1;var o=!0;return e.forEach((function(e){return dt(e.key)&&-1!==e.key.indexOf("Tag_SNS_Custom")?dt(e.value)?8<e.key.replace("Tag_SNS_Custom_","").length?(Zt({api:t,paramName:n,desc:ln("keyword",8)}),o=!1):void 0:(Zt({api:t,paramName:n,desc:_n("value")}),o=!1):(Zt({api:t,paramName:n,desc:Fn("FriendCustomFieldPrefixLog")}),o=!1)})),o}return!0}}},acceptFriendApplication:{userID:X},refuseFriendApplication:{userID:X},deleteFriendApplication:{userID:X},createFriendGroup:{name:X},deleteFriendGroup:{name:X},addToFriendGroup:{name:X,userIDList:$},removeFromFriendGroup:{name:X,userIDList:$},renameFriendGroup:{oldName:X,newName:X},sendMessageReadReceipt:[{name:"messageList",type:"Array",validator:function(e,t,n){return Xe(e)?0!==e.length||(Zt({api:t,paramName:n,desc:rn()}),!1):(Zt({api:t,paramName:n,desc:an()}),!1)}}],getMessageReadReceiptList:[{name:"messageList",type:"Array",validator:function(e,t,n){return Xe(e)?0!==e.length||(Zt({api:t,paramName:n,desc:rn()}),!1):(Zt({api:t,paramName:n,desc:an()}),!1)}}],createTopicInCommunity:{groupID:X,topicName:X},deleteTopicFromCommunity:{groupID:X,topicIDList:{type:"Array",validator:function(e,t,n){return!e||!!Xe(e)||(Zt({api:t,paramName:n,desc:an()}),!1)}}},updateTopicProfile:{groupID:X,topicID:X},getTopicList:{groupID:X,topicIDList:{type:"Array",validator:function(e,t,n){return!e||!!Xe(e)||(Zt({api:t,paramName:n,desc:an()}),!1)}}},followUser:[t({name:"userIDList"},$)],unfollowUser:[t({name:"userIDList"},$)],getMyFollowingList:[t(t({name:"startIndex"},X),{},{required:!1})],getMyFollowersList:[t(t({name:"startIndex"},X),{},{required:!1})],getMutualFollowersList:[t(t({name:"startIndex"},X),{},{required:!1})],getUserFollowInfo:[t(t({name:"userIDList"},$),{},{required:!1})],checkFollowType:[t({name:"userIDList"},$)],addSignalingListener:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(Zt({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(Zt({api:t,paramName:n,desc:sn()}),!1):(""===e.name&&Zt({api:t,paramName:n,desc:vn()}),!0)}}],removeSignalingListener:[{name:"eventName",type:"String",validator:function(e,t,n){return"string"==typeof e&&0!==e.length||(Zt({api:t,paramName:n,desc:en(n)}),!1)}},{name:"handler",type:"Function",validator:function(e,t,n){return"function"!=typeof e?(Zt({api:t,paramName:n,desc:sn()}),!1):(""===e.name&&Zt({api:t,paramName:n,desc:vn()}),!0)}}],invite:{userID:X},inviteSync:[t(t({},J),{},{validator:function(e,t,n){return ze(e)?!!dt(e.userID)||(Zt({api:t,paramName:"options.userID",desc:$t()}),!1):(Zt({api:t,paramName:"options",desc:hn()}),!1)}}),{name:"successCb",type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:sn()}),!0}},{name:"errorCb",type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:sn()}),!0}}],inviteInGroup:{groupID:X,inviteeList:$},inviteInGroupSync:[t(t({},J),{},{validator:function(e,t,n){return ze(e)?dt(e.groupID)?!!Xe(e.inviteeList)||(Zt({api:t,paramName:"options.inviteeList",desc:an()}),!1):(Zt({api:t,paramName:"options.groupID",desc:$t()}),!1):(Zt({api:t,paramName:"options",desc:hn()}),!1)}}),{name:"successCb",type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:sn()}),!0}},{name:"errorCb",type:"Function",required:!1,validator:function(e,t,n){return pt(e)&&Zt({api:t,paramName:n,desc:sn()}),!0}}],accept:{inviteID:X},reject:{inviteID:X},getSignalingInfo:[t(t({name:"message"},J),{},{validator:function(e,t,n){return!He(e)||(Zt({api:t,paramName:n,desc:mn()}),!1)}})],modifyInvitation:{inviteID:X,data:X}},xn={login:1,logout:1,getLoginUser:1,getServerTime:1,on:1,once:1,off:1,setLogLevel:1,registerPlugin:1,destroy:1,isReady:1,createTextMessage:1,createTextAtMessage:1,createImageMessage:1,createAudioMessage:1,createVideoMessage:1,createCustomMessage:1,createFaceMessage:1,createFileMessage:1,createLocationMessage:1,createMergerMessage:1,downloadMergerMessage:1,createForwardMessage:1,sendMessage:1,resendMessage:1,revokeMessage:1,deleteMessage:1,translateText:1,convertVoiceToText:1,modifyMessage:1,sendMessageReadReceipt:1,getGroupMessageReadMemberList:1,getMessageReadReceiptList:1,setMessageExtensions:1,getMessageExtensions:1,deleteMessageExtensions:1,addMessageReaction:1,removeMessageReaction:1,getMessageReactions:1,getAllUserListOfMessageReaction:1,getMessageList:1,findMessage:1,getMessageListHopping:1,setMessageRead:1,setAllMessageRead:1,getConversationList:1,getConversationProfile:1,deleteConversation:1,setConversationDraft:1,pinConversation:1,getTotalUnreadMessageCount:1,setConversationCustomData:1,markConversation:1,createConversationGroup:1,getConversationGroupList:1,deleteConversationGroup:1,renameConversationGroup:1,addConversationsToGroup:1,deleteConversationsFromGroup:1,clearHistoryMessage:1,setMessageRemindType:1,setAllReceiveMessageOpt:1,getAllReceiveMessageOpt:1,getGroupList:1,getGroupProfile:1,createGroup:1,joinGroup:1,updateGroupProfile:1,quitGroup:1,dismissGroup:1,changeGroupOwner:1,searchGroupByID:1,getGroupApplicationList:1,handleGroupApplication:1,initGroupAttributes:1,setGroupAttributes:1,deleteGroupAttributes:1,getGroupAttributes:1,setGroupCounters:1,increaseGroupCounter:1,decreaseGroupCounter:1,getGroupCounters:1,getJoinedCommunityList:1,createTopicInCommunity:1,deleteTopicFromCommunity:1,updateTopicProfile:1,getTopicList:1,getGroupMemberProfile:1,getGroupMemberList:1,addGroupMember:1,deleteGroupMember:1,setGroupMemberNameCard:1,setGroupMemberMuteTime:1,setGroupMemberRole:1,setGroupMemberCustomField:1,getGroupOnlineMemberCount:1,markGroupMemberList:1,getMyProfile:1,getUserProfile:1,updateMyProfile:1,setSelfStatus:1,getUserStatus:1,subscribeUserStatus:1,unsubscribeUserStatus:1,getBlacklist:1,addToBlacklist:1,removeFromBlacklist:1,searchCloudMessages:1,searchCloudUsers:1,searchCloudGroups:1,searchCloudGroupMembers:1,getFriendList:1,addFriend:1,deleteFriend:1,checkFriend:1,updateFriend:1,getFriendProfile:1,getFriendApplicationList:1,refuseFriendApplication:1,deleteFriendApplication:1,acceptFriendApplication:1,setFriendApplicationRead:1,getFriendGroupList:1,createFriendGroup:1,renameFriendGroup:1,deleteFriendGroup:1,addToFriendGroup:1,removeFromFriendGroup:1,followUser:1,unfollowUser:1,getMyFollowingList:1,getMyFollowersList:1,getMutualFollowersList:1,getUserFollowInfo:1,checkFollowType:1,callExperimentalAPI:1,addSignalingListener:1,removeSignalingListener:1,invite:1,inviteSync:1,inviteInGroup:1,inviteInGroupSync:1,cancel:1,accept:1,reject:1,getSignalingInfo:1,modifyInvitation:1},Vn=(r(lo,p(Error)),Sn=g(lo),s(lo)),Bn={NO_SDKAPPID:2e3,NO_ACCOUNT_TYPE:2001,NO_IDENTIFIER:2002,NO_USERSIG:2003,NO_TINYID:2022,NO_A2KEY:2023,USER_NOT_LOGGED_IN:2024,REPEAT_LOGIN:2025,COS_UNDETECTED:2040,COS_GET_SIG_FAIL:2041,MSG_SEND_FAIL:2100,MSG_SEND_FAIL_NOT_IN_AV:2101,MSG_INSTANCE_REQUIRED:2105,MSG_INVALID_CONV_TYPE:2106,MSG_F_IS_EMPTY:2108,MSG_ONPROGRESS_ERR:2109,MSG_REVOKE_FAIL:2110,MSG_DELETE_FAIL:2111,MSG_UNREAD_ALL_FAIL:2112,READ_RECEIPT_MSG_LIST_EMPTY:2114,MSG_SEND_GRP_WITH_TOPIC_FAIL:2115,CANNOT_DELETE_GRP_SYSTEM_NOTICE:2116,TRANSLATE_TEXT_FAIL:2117,VOICE_TO_TEXT_FAIL:2118,UNSUPPORTED_VOICE_FORMAT:2119,MSG_I_SELECT_F_FIRST:2251,MSG_I_TYPES_LIMIT:2252,MSG_I_SIZE_LIMIT:2253,MSG_A_UPLOAD_FAIL:2300,MSG_A_SIZE_LIMIT:2301,MSG_V_UPLOAD_FAIL:2350,MSG_V_SIZE_LIMIT:2351,MSG_V_TYPES_LIMIT:2352,MSG_F_UPLOAD_FAIL:2400,MSG_F_SELECT_F_FIRST:2401,MSG_F_SIZE_LIMIT:2402,MSG_F_URL_IS_EMPTY:2403,MSG_MERGER_TYPE_INVALID:2450,MSG_MERGER_KEY_INVALID:2451,MSG_MERGER_DOWNLOAD_FAIL:2452,MSG_FORWARD_TYPE_INVALID:2453,MSG_FORWARD_INVALID_ELEMENTS:2454,MSG_MODIFY_CONFLICT:2480,MSG_MODIFY_DISABLED_IN_AV:2481,CONV_NOT_FOUND:2500,USER_OR_GRP_NOT_FOUND:2501,CONV_UN_RECORDED_TYPE:2502,INVALID_CONV_ID:2503,ILLEGAL_GRP_TYPE:2600,ILLEGAL_GRP_ID:2602,CANNOT_FIND_GRP:2603,CANNOT_CHANGE_OWNER_IN_AV:2620,CANNOT_CHANGE_OWNER_TO_SELF:2621,MEMBER_NOT_IN_GRP:2623,JOIN_GRP_FAIL:2660,CANNOT_ADD_MEMBER_IN_AV:2661,CANNOT_JOIN_NON_AV_WITHOUT_LOGIN:2662,NOT_OWNER:2681,INVALID_MEMBER_ROLE:2683,CANNOT_SET_SELF_MEMBER_ROLE:2684,CANNOT_MUTE_SELF:2685,BAN_DURATION_INVALID:2686,OPERATION_NOT_SUPPORTED_IN_AV:2687,NOT_MY_FRIEND:2700,ALREADY_MY_FRIEND:2701,FRIEND_GRP_EXISTED:2710,FRIEND_GRP_NOT_EXIST:2711,FRIEND_APPLICATION_NOT_EXIST:2716,UPDATE_PROFILE_INVALID_PARAM:2721,UPDATE_PROFILE_NO_KEY:2722,CANNOT_ADD_SELF_TO_BLACKLIST:2742,NETWORK_ERROR:2800,NETWORK_TIMEOUT:2801,NO_NETWORK:2805,UNCAUGHT_ERROR:2903,INVALID_OPERATION:2905,INVALID_TRTC_CMD:2995,OVER_FREQUENCY_LIMIT:2996,NO_PROTOCOL:2997,NO_MODULE:2998,SDK_IS_NOT_READY:2999,LOGGING_IN:3e3,LOGIN_FAILED:3001,KICKED_OUT_MULT_DEVICE:3002,KICKED_OUT_MULT_ACCOUNT:3003,KICKED_OUT_USERSIG_EXPIRED:3004,LOGGED_OUT:3005,KICKED_OUT_REST_API:3006,ILLEGAL_TOPIC_ID:3021,NO_USE:3122,PROFANITY_FOUND:3123,OPTIONS_IS_EMPTY:3153,MSG_A2KEY_EXPIRED:20002,ACCOUNT_A2KEY_EXPIRED:70001,HELLO_ANSWER_KICKED_OUT:1002,OPEN_SERVICE_OVERLOAD_ERROR:60022,SIGNALING_INVALID_INVITE_ID:8010,SIGNALING_NO_PERMISSION:8011,SIGNALING_ALREADY_EXISTS:8012,INVALID_CANCEL_MESSAGE:8020},Hn=null,Kn=(s(uo,[{key:"isLoggedIn",value:function(){return this._m.get(12).isLoggedIn()}},{key:"isOversea",value:function(){return this._m.get(12).isOversea()}},{key:"isPrivateNetWork",value:function(){var e=this._m.get(12);return e.isPrivateNetWork()&&!e.getFileDownloadProxy()}},{key:"getFileDownloadProxy",value:function(){return this._m.get(12).getFileDownloadProxy()}},{key:"getDowloadFileAuthKey",value:function(){return this._m.get(12).getDowloadFileAuthKey()}},{key:"getMyUserID",value:function(){return this._m.get(12).getUserID()}},{key:"getMyTinyID",value:function(){return this._m.get(12).getTinyID()}},{key:"getSDKAppID",value:function(){return this._m.get(12).getSDKAppID()}},{key:"isIntl",value:function(){return this._m.get(12).isIntl()}},{key:"isUsingChatCore",value:function(){return this._m.get(12).isUsingChatCore()}},{key:"isDevMode",value:function(){return this._m.get(12).isDevMode()}},{key:"get",value:function(e){return this._m.get(e)}},{key:"getPlatform",value:function(){return ie}},{key:"getCloudConfig",value:function(e){return this._m.get(23).getCloudConfig(e)}},{key:"emitOEvt",value:function(e,t){this._m.getOEmitInst().emit(e,t)}},{key:"emitIEvt",value:function(e,t){this._m.getIEmitInst().emit(e,t)}},{key:"getIEmitInst",value:function(){return this._m.getIEmitInst()}},{key:"req",value:function(e){return this._m.get(20).req(e)}},{key:"canIUse",value:function(e){return this._m.get(27).canIUse(e)}},{key:"getErrMsg",value:function(e,t,n){return this._m.getErrMsg(e,t,n)}},{key:"warn",value:function(e,t,n){(e=this.getErrMsg(e,t,n))&&Ne.w(e)}},{key:"noUse",value:function(e){var t=Bn.NO_USE;return Rn({code:t,message:this.getErrMsg(t,e)})}}]),bn=uo,{LOGIN:"wslogin",LOGOUT:"wslogout",HELLO:"wshello",KICK_OTHER:"KickOther",SYNC_UNREAD_MSG:"getmsg",SEND_C2C_MSG:"sendmsg",SEND_GRP_MSG:"send_group_msg",GET_USER_PROFILE:"portrait_get_all",UPDATE_MY_PROFILE:"portrait_set",GET_BL:"black_list_get",ADD_TO_BL:"black_list_add",RM_FROM_BL:"black_list_delete",GET_FD_LIST:"friend_get",GET_FD_PROFILE:"friend_get_specified",CHECK_FD:"friend_check",DEL_FD:"friend_delete",ADD_FD:"friend_add",UPDATE_FD:"friend_update",RESPOND_FD_APPLICATION:"friend_response",GET_FD_APPLICATION_LIST:"pendency_get",DEL_FD_APPLICATION:"pendency_delete",REFUSE_FD_APPLICATION:"pendency_refuse",REPORT_FD_APPLICATION:"pendency_report",GET_FD_GRP_LIST:"group_get",CREATE_FD_GRP:"group_add",DEL_FD_GRP:"group_delete",UPDATE_FD_GRP:"group_update",REVOKE_C2C_MSG:"msgwithdraw",SET_C2C_MSG_READ:"msgreaded",SET_C2C_PEER_MUTE_NOTIFICATIONS:"set_c2c_peer_mute_notifications",GET_C2C_PEER_MUTE_NOTIFICATIONS:"get_c2c_peer_mute_notifications",GET_C2C_ROAMING_MSG:"getroammsg",GET_C2C_PEER_READ_TIME:"get_peer_read_time",DEL_C2C_MSG:"delete_c2c_msg_ramble",MODIFY_C2C_MSG:"modify_c2c_msg",MODIFY_C2C_MSG_EXT:"set_key_values",GET_C2C_MSG_EXT:"get_key_values",ADD_C2C_MSG_REACTION:"reaction_add",RM_C2C_MSG_REACTION:"reaction_del",GET_C2C_MSG_REACTIONS:"reaction_multi_stat",GET_C2C_MSG_REACTION_USER_LIST:"reaction_iterate",PAGING_GET_CONV_LIST:"page_get",DEL_CONV:"batch_delete",CLEAR_HISTORY_MSG:"clear_msg",PIN_CONV:"top",DEL_GROUP_AT_TIPS:"deletemsg",SET_CONV_CUSTOM_DATA:"set_conv_custom_data",MARK_CONV:"mark_contact",CREATE_CONV_GRP:"create_contact_group",DEL_CONV_GRP:"del_contact_group",RENAME_CONV_GRP:"update_contact_group",ADD_CONV_TO_GRP:"add_conv_to_group",DEL_CONV_FROM_GRP:"del_conv_from_group",GET_CONV_GRP_LIST:"get_contact_group",SEARCH_CONV_GRP_MARK:"search_contact_group",GET_GRP_LIST:"get_joined_group_list",GET_GRP_PROFILE:"get_group_self_member_info",CREATE_GRP:"create_group",DISMISS_GRP:"destroy_group",UPDATE_GRP_PROFILE:"modify_group_base_info",APPLY_JOIN_GRP:"apply_join_group",APPLY_JOIN_GRP_NOAUTH:"apply_join_group_noauth",QUIT_GRP:"quit_group",SEARCH_GRP:"get_group_public_info",CHANGE_GRP_OWNER:"change_group_owner",HANDLE_GRP_APPLICATION:"handle_apply_join_group",HANDLE_INVITE_JOIN_GRP:"handle_invite_join_permission_group",HANDLE_GRP_INVITATION:"handle_invite_join_group",REVOKE_GRP_MSG:"group_msg_recall",SET_GRP_MSG_READ:"msg_read_report",SET_ALL_MSG_READ:"read_all_unread_msg",GET_GRP_ROAMING_MSG:"group_msg_get",GET_READ_RECEIPT:"get_group_msg_receipt",SEND_READ_RECEIPT:"group_msg_receipt",SEND_C2C_READ_RECEIPT:"c2c_msg_read_receipt",GET_READ_RECEIPT_DETAIL:"get_group_msg_receipt_detail",GET_GRP_PENDENCY:"get_pendency",DEL_GRP_SYSTEM_NOTICE:"deletemsg",AV_POLLING:"get_msg",AV_NOAUTH_POLLING:"get_msg_noauth",GET_ONLINE_MBR_NUM:"get_online_member_num",DEL_GRP_MSG:"delete_group_ramble_msg_by_seq",MODIFY_GRP_MSG:"modify_group_msg",SET_GRP_ATTR:"set_group_attr",MODIFY_GRP_ATTR:"modify_group_attr",DEL_GRP_ATTR:"delete_group_attr",CLEAR_GRP_ATTR:"clear_group_attr",GET_GRP_ATTR:"get_group_attr",MODIFY_GRP_MSG_EXT:"group_set_key_values",GET_GRP_MSG_EXT:"group_get_key_values",GET_GRP_NOTIFY:"batch_get_group_notify",UPDATE_GRP_COUNTER:"update_group_counter",GET_GRP_COUNTER:"get_group_counter",ADD_GRP_MSG_REACTION:"group_reaction_add",RM_GRP_MSG_REACTION:"group_reaction_del",GET_GRP_MSG_REACTIONS:"group_reaction_multi_stat",GET_GRP_MSG_REACTION_USER_LIST:"group_reaction_iterate",GET_GRP_MBR_LIST:"get_group_member_info",GET_AV_MBR_LIST:"get_members",GET_GRP_MBR_PROFILE:"get_specified_group_member_info",ADD_GRP_MBR:"add_group_member",DEL_GRP_MBR:"delete_group_member",BAN_AV_MBR:"ban_group_member",MODIFY_GRP_MBR_INFO:"modify_group_member_info",MARK_AV_MBR_INFO:"modify_user_info",COS_SIGN:"cos",COS_PRE_SIG:"pre_sig",SIMPLE_COS_PRE_SIG:"simple_sig",GET_IMAGE_INFO:"get_imageinfo",GET_IP:"get_final_ip",VIDEO_COVER:"video_cover",SSO_STAT:"tim_web_report_v2",PING:"alive",MSG_PUSH:"msg_push",CS:"query",GRP_CS:"query_grp",MBR_CS:"query_grp_member",USER_CS:"query_user",MULTI_MSG_PUSH:"multi_msg_push_ws",MSG_PUSH_ACK:"ws_msg_push_ack",STATUS_FORCE_OFFLINE:"stat_forceoffline",UPLOAD_MERGER_MSG:"save_relay_json_msg",DOWNLOAD_MERGER_MSG:"get_relay_json_msg",FETCH_CLOUD_CTRL_CONFIG:"fetch_config",PUSHED_CLOUD_CTRL_CONFIG:"push_configv2",FETCH_COMMERCIAL_CONFIG:"fetch_imsdk_purchase_bitsv2",PUSHED_COMMERCIAL_CONFIG:"push_imsdk_purchase_bitsv2",OVERLOAD_NOTIFY:"notify2",CREATE_TOPIC:"create_topic",DEL_TOPIC:"destroy_topic",UPDATE_TOPIC_PROFILE:"modify_topic",GET_TOPIC_LIST:"get_topic",SET_SELF_STATUS:"ws_set_custom_status",GET_USER_STATUS:"ws_get_user_status",SUB_USER_STATUS:"ws_status_subscribe",UNSUB_USER_STATUS:"ws_status_unsubscribe",STAT_BACKGROUND:"ws_stat_background",STAT_FOREGROUND:"ws_stat_foreground",SET_TOKEN:"ws_stat_settoken",PUSH_REPORT:"uniapp_sdk_report",GET_PROFANITY_LIST:"get_local_words",TRANSLATE_TEXT:"ws_batch_trans_text",VOICE_TO_TEXT:"ws_sentence_recognition",FOLLOW:"follow_add",UNFOLLOW:"follow_delete",GET_FOLLOW:"follow_get",GET_FOLLOW_INFO:"follow_get_info",CHECK_FOLLOW_TYPE:"follow_check",SET_ALL_RECEIVE_MSG_OPT:"ws_set_do_not_disturb",GET_ALL_RECEIVE_MSG_OPT:"ws_get_do_not_disturb"}),Wn="networkRTT",Yn="messageE2EDelay",jn="sendMessageC2C",Jn="sendMessageGroup",zn="sendMessageGroupAV",Xn="sendMessageRichMedia",Qn="cosUpload",Zn="messageReceivedGroup",$n="messageReceivedGroupAVPush",eo="messageReceivedGroupAVPull",to=(a(Un={},Wn,2),a(Un,Yn,3),a(Un,jn,4),a(Un,Jn,5),a(Un,zn,6),a(Un,Xn,7),a(Un,Zn,8),a(Un,$n,9),a(Un,eo,10),a(Un,Qn,11),Un),no={info:4,warning:5,error:6},oo={wifi:1,"2g":2,"3g":3,"4g":4,"5g":5,unknown:6,none:7,online:8},io={login:4,plugin_search:16,plugin_translate:16,plugin_voice_to_text:16,plugin_cs:16,plugin_push:16,plugin_bot:16,plugin_emoji_reaction:16,tui_key_features:16},so=(s(co,[{key:"updateTimeStamp",value:function(){this.timestamp=Le()}},{key:"start",value:function(e){return this._startts=e,this}},{key:"end",value:function(){var e,t=this,n=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this._sentFlag||(this._netMonitorModule&&(e=this._netMonitorModule.getNetworkType(),this.setNetworkType(e)),e=Le(),0===this.costTime&&(this.costTime=e-this._startts),this.setMoreMessage("startts:".concat(this._startts," endts:").concat(e)),n?(this._sentFlag=!0,this._eventStatModule&&this._eventStatModule.pushIn(this)):setTimeout((function(){t._sentFlag=!0,t._eventStatModule&&t._eventStatModule.pushIn(t)}),0))}},{key:"setError",value:function(e){if(!(e instanceof Error))return Ne.w("".concat(this._n,".setError value not instanceof Error, please check!")),this;if(this._sentFlag)return this;var t=!0;return(t=this._netMonitorModule?this._netMonitorModule.isOnline():t)?(e.code&&this.setCode(e.code),e.message&&this.setMoreMessage(e.message)):this.setCode(Bn.NO_NETWORK),this.setLevel("error"),this}},{key:"setCode",value:function(e){return pt(e)||this._sentFlag||("ECONNABORTED"===e&&(this.code=103),je(e)?this.code=e:Ne.w("".concat(this._n,".setCode value not a number, please check!"),e,n(e))),this}},{key:"setMessage",value:function(e){return pt(e)||this._sentFlag||(je(e)&&(this.message=e.toString()),dt(e)&&(this.message=e)),this}},{key:"setCostTime",value:function(e){return this.costTime=e,this}},{key:"setLevel",value:function(e){return pt(e)||this._sentFlag||(this.level=no[e]),this}},{key:"setMoreMessage",value:function(e){return He(this.moreMessage)?this.moreMessage="".concat(e):this.moreMessage+=" ".concat(e),this}},{key:"setNetworkType",value:function(e){return pt(e)?Ne.w("".concat(this._n,".setNetworkType value is undefined, please check!")):(e=oo[e.toLowerCase()],pt(e)||(this.networkType=e)),this}},{key:"getStartTs",value:function(){return this._startts}},{key:"setUIPlatform",value:function(e){return this.uiPlatform=e,this}},{key:"setExtension",value:function(e){return this.extension=e,this}},{key:"setEventType",value:function(e){return this.eventType=e,this}}],[{key:"bindEventStatModule",value:function(e){co.prototype._eventStatModule=e}},{key:"bindNetMonitorModule",value:function(e){co.prototype._netMonitorModule=e}}]),co),ao=(s(ro,[{key:"setText",value:function(e){this.content.text=e}},{key:"sendable",value:function(){return 0!==this.content.text.length}}]),ro);function ro(e){o(this,ro),this.type=D.MSG_TEXT,this.content={text:e.text||""}}function co(e){o(this,co),this._n="SSOLogData",this.eventType=io[e]||0,this.timestamp=0,this.networkType=8,this.code=0,this.message="",this.moreMessage="",this.extension=e,this.costTime=0,this.duplicate=!1,this.level=4,this.uiPlatform=void 0,this._sentFlag=!1,this._startts=Le()}function uo(e){o(this,uo),this._m=e,this._n=""}function lo(e){o(this,lo),t=Sn.call(this);var t,n=e.code,i=e.message;return e=e.data,t.code=n,i?t.message=i:t._getErrMsg&&(t.message=t._getErrMsg(t.code)),t.data=e||{},t}function po(e,t,n,o){var i;if(o=3<arguments.length&&void 0!==o?o:[],e)return i=e,t&&(e.startsWith("http://")?i=e.replace(/^http:\/\/[^/]+/,t):e.startsWith("https://")&&(i=e.replace(/^https:\/\/[^/]+/,t))),n&&-1===i.indexOf("authKey=")&&go(i,o)?(-1<i.indexOf("?")?"".concat(i,"&authKey="):"".concat(i,"?authKey=")).concat(n):i}function _o(e,t,n){return n=2<arguments.length&&void 0!==n?n:[],e===D.MSG_VIDEO?go((t[0].content||t[0].payload).snapshotUrl,n)&&(t[0].content?(t[0].content.snapshotUrl=ho(t[0].content.snapshotUrl),t[0].content.thumbUrl=ho(t[0].content.thumbUrl)):(t[0].payload.snapshotUrl=ho(t[0].payload.snapshotUrl),t[0].payload.thumbUrl=ho(t[0].payload.thumbUrl))):e===D.MSG_FILE?go((t[0].content||t[0].payload).fileUrl,n)&&(t[0].content?t[0].content.fileUrl=ho(t[0].content.fileUrl):t[0].payload.fileUrl=ho(t[0].payload.fileUrl)):e===D.MSG_MERGER&&(e=(n=t[0].content||t[0].payload).downloadKey,n=void 0===(n=n.messageList)?[]:n,He(void 0===e?"":e)&&n.forEach((function(e){_o(e.messageBody[0].type,e.messageBody)}))),t}function ho(e){if(!e)return e;if(-1===e.indexOf("authKey="))return e;for(var t=(e=e.split("?"))[1].split("&"),n=0,o=0;o<t.length;o++)if(-1<t[o].indexOf("authKey=")){n=o;break}return t.splice(n,1),0<t.length?"".concat(e[0],"?").concat(t.join("&")):e[0]}function go(e,t){var n=!1;if(e){var o=(e=e.match(/:\/\/([0-9]?\.)?(.[^/:]+)/))&&e[2]||"";if(o.includes("rich-dev"))return 1;for(var i=0;i<t.length;i++)if(o.endsWith(t[i])){n=!0;break}}return n}s(Ho,[{key:"_initImageInfoModel",value:function(){var e=this;this._ImageInfoModel=function(t){this.instanceID=st(9999999),this.sizeType=t.type||0,this.type=0,this.size=t.size||0,this.width=t.width||0,this.height=t.height||0,this.imageUrl=t.imageUrl||t.url||"",this.url=po(t.url||e._imageMemoryURL,e._fileDownloadProxy,e._authKey,e._fileDNList)},this._ImageInfoModel.prototype={setSizeType:function(e){this.sizeType=e},setType:function(e){this.type=e},setImageUrl:function(e){e&&(this.imageUrl=e)},getImageUrl:function(){return this.imageUrl}}}},{key:"initImageInfoArray",value:function(e){for(var t,n=0,o=null;n<=2;)t=pt(e)||pt(e[n])?{type:0,size:0,width:0,height:0,url:""}:e[n],(o=new this._ImageInfoModel(t)).setSizeType(n+1),o.setType(n),this.addImageInfo(o),n++;this.updateAccessSideImageInfoArray()}},{key:"updateImageInfoArray",value:function(e){for(var t,n=this.content.imageInfoArray.length,o=0;o<n;o++)t=this.content.imageInfoArray[o],e[o].size&&(t.size=e[o].size),e[o].url&&t.setImageUrl(e[o].url),e[o].width&&(t.width=e[o].width),e[o].height&&(t.height=e[o].height)}},{key:"_autoFixUrl",value:function(){for(var e=this.content.imageInfoArray.length,t="",n="",o=["http","https"],i=null,s=0;s<e;s++)this.content.imageInfoArray[s].url&&""!==(i=this.content.imageInfoArray[s]).imageUrl&&(n=i.imageUrl.slice(0,i.imageUrl.indexOf("://")+1),t=i.imageUrl.slice(i.imageUrl.indexOf("://")+1),o.indexOf(n)<0&&(n="https:"),this.content.imageInfoArray[s].setImageUrl([n,t].join("")))}},{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateImageFormat",value:function(e){this.content.imageFormat=Pe[e.toUpperCase()]||Pe.UNKNOWN}},{key:"createImageDataASURLInWeb",value:function(e){void 0!==e&&0<e.files.length&&(this._imageMemoryURL=window.URL.createObjectURL(e.files[0]))}},{key:"createImageDataASURL",value:function(e){e&&e.url&&(this._imageMemoryURL=e.url)}},{key:"replaceImageInfo",value:function(e,t){this.content.imageInfoArray[t]instanceof this._ImageInfoModel||(this.content.imageInfoArray[t]=e)}},{key:"addImageInfo",value:function(e){3<=this.content.imageInfoArray.length||this.content.imageInfoArray.push(e)}},{key:"updateAccessSideImageInfoArray",value:function(){var e=this.content.imageInfoArray,t=void 0===(t=(n=e[0]).width)?0:t,n=void 0===(n=n.height)?0:n;0!==t&&0!==n&&(Ut(e),Object.assign(e[2],Gt({originWidth:t,originHeight:n,min:720})))}},{key:"sendable",value:function(){return 0!==this.content.imageInfoArray.length&&""!==this.content.imageInfoArray[0].imageUrl&&0!==this.content.imageInfoArray[0].size}}]);var fo=Ho,mo=(s(Bo,[{key:"sendable",value:function(){return null!==this.content}}]),Bo),vo=(s(Vo,[{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateAudioUrl",value:function(e){this.content.remoteAudioUrl=e}},{key:"sendable",value:function(){return""!==this.content.remoteAudioUrl}}]),Vo),Io={from:!0,groupID:!0,groupName:!0,to:!0},yo=(s(xo,[{key:"_initContent",value:function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"remarkInfo":case"memberExtraInfo":case"onlineMemberInfo":break;case"groupProfile":t.content.groupProfile={},t._initGroupProfile(e[n]);break;case"operatorInfo":t.content.operatorInfo={},t._initOperatorInfo(e[n]);break;case"memberInfoList":case"msgMemberInfo":t._updateMemberList(e[n]);break;case"memberNum":t.content[n]=e[n],t.content.memberCount=e[n];break;case"newGroupProfile":t.content.newGroupProfile={},t._initNewGroupProfile(e[n]);break;default:t.content[n]=e[n]}})),this.content.userIDList||(this.content.userIDList=[this.content.operatorID])}},{key:"_initGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];Io[o]&&(this.content.groupProfile[o]=e[o])}}},{key:"_initOperatorInfo",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];this.content.operatorInfo[o]=e[o]}}},{key:"_updateMemberList",value:function(e){He(this.content.memberList)?this.content.memberList=e:this.content.memberList.forEach((function(t){e.forEach((function(e){t.userID===e.userID&&Object.assign(t,e)}))}))}},{key:"_initNewGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];this.content.newGroupProfile[o]="muteAllMembers"!==o?e[o]:1===e[o]}}}]),xo),Mo={from:!0,groupID:!0,groupName:!0,to:!0,groupType:!0},Co=(s(qo,[{key:"_initContent",value:function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"memberInfoList":break;case"remarkInfo":t.content.handleMessage=e[n];break;case"groupProfile":t.content.groupProfile={},t._initGroupProfile(e[n]);break;default:t.content[n]=e[n]}}))}},{key:"_initGroupProfile",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var o=t[n];Mo[o]&&("groupName"===o?this.content.groupProfile.name=e[o]:this.content.groupProfile[o]=e[o])}}}]),qo),To=(s(Fo,[{key:"_getFileInfo",value:function(e){return pt(e.fileName)||pt(e.fileSize)?(e=e.file.files[0],z&&(e.path&&-1!==e.path.indexOf(".")&&(t=e.path.slice(e.path.lastIndexOf(".")+1).toLowerCase(),e.type=t,e.name||(e.name="".concat(st(999999),".").concat(t))),e.name||(e.type="",e.name=e.path.slice(e.path.lastIndexOf("/")+1).toLowerCase()),e.suffix&&(e.type=e.suffix),e.url||(e.url=e.path)),{size:e.size,name:e.name}):{size:e.fileSize,name:e.fileName};var t}},{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateFileUrl",value:function(e){this.content.fileUrl=e}},{key:"sendable",value:function(){return""!==this.content.fileUrl&&""!==this.content.fileName&&0!==this.content.fileSize}}]),Fo),Eo=(s(wo,[{key:"setData",value:function(e){return this.content.data=e,this}},{key:"setDescription",value:function(e){return this.content.description=e,this}},{key:"setExtension",value:function(e){return this.content.extension=e,this}},{key:"sendable",value:function(){return 0!==this.content.data.length||0!==this.content.description.length||0!==this.content.extension.length}}]),wo),Do=(s(bo,[{key:"updatePercent",value:function(e){this._percent=e,1<this._percent&&(this._percent=1)}},{key:"updateVideoUrl",value:function(e){e&&(this.content.remoteVideoUrl=e)}},{key:"updateSnapshotInfo",value:function(e){var t=e.snapshotUrl,n=e.snapshotWidth;e=e.snapshotHeight,He(t)||(this.content.thumbUrl=this.content.snapshotUrl=t),He(n)||(this.content.thumbWidth=this.content.snapshotWidth=Number(n)),He(e)||(this.content.thumbHeight=this.content.snapshotHeight=Number(e))}},{key:"sendable",value:function(){return""!==this.content.remoteVideoUrl}}]),bo),Ro=(s(Uo,[{key:"sendable",value:function(){return!0}}]),Uo),So=(s(Go,[{key:"_patchRichMediaPayload",value:function(e,t){e===D.MSG_IMAGE?t.imageInfoArray.forEach((function(e){!e.imageUrl&&e.url&&(e.imageUrl=e.url,e.sizeType=e.type,1===e.type?e.type=0:3===e.type&&(e.type=1))})):e===D.MSG_VIDEO?!t.remoteVideoUrl&&t.videoUrl&&(t.remoteVideoUrl=t.videoUrl):e===D.MSG_AUDIO?!t.remoteAudioUrl&&t.url&&(t.remoteAudioUrl=t.url):e===D.MSG_FILE&&!t.fileUrl&&t.url&&(t.fileUrl=t.url,t.url=void 0)}},{key:"_updateRichMediaDownloadUrl",value:function(e,t,n,o,i){(n||o)&&(e===D.MSG_IMAGE?t.imageInfoArray.forEach((function(e){e.url=po(e.url,n,o,i)})):e===D.MSG_VIDEO?(t.videoUrl=po(t.videoUrl,n,o,i),t.snapshotUrl=po(t.thumbUrl,n,o,i),t.snapshotHeight=t.thumbHeight,t.snapshotWidth=t.thumbWidth):e===D.MSG_AUDIO?t.url=po(t.url,n,o,i):e===D.MSG_FILE&&(t.fileUrl=po(t.fileUrl,n,o,i)))}}]),Go),Lo=(s(Po,[{key:"sendable",value:function(){return!He(this.content.messageList)||!He(this.content.downloadKey)}}]),Po),Ao={1:D.MSG_PRIORITY_HIGH,2:D.MSG_PRIORITY_NORMAL,3:D.MSG_PRIORITY_LOW,4:D.MSG_PRIORITY_LOWEST},ko=(s(No,[{key:"elements",get:function(){return this._elements}},{key:"getElements",value:function(){return this._elements}},{key:"extractGroupInfo",value:function(e){null!==e&&(dt(e.nick)&&(this.nick=e.nick),dt(e.avatar)&&(this.avatar=e.avatar),ze(e=e.messageFromAccountExtraInformation)&&dt(e.nameCard)&&(this.nameCard=e.nameCard))}},{key:"handleGroupAtInfo",value:function(e){var t=this;e.payload&&e.payload.atUserList&&e.payload.atUserList.forEach((function(e){e!==D.MSG_AT_ALL?(t._groupAtInfoList.push({groupAtAllFlag:0,groupAtUserID:e}),t.atUserList.push(e)):(t._groupAtInfoList.push({groupAtAllFlag:1}),t.atUserList.push(D.MSG_AT_ALL))})),Xe(e.groupAtInfo)&&e.groupAtInfo.forEach((function(e){0===e.groupAtAllFlag?t.atUserList.push(e.groupAtUserID):1===e.groupAtAllFlag&&t.atUserList.push(D.MSG_AT_ALL)}))}},{key:"getGroupAtInfoList",value:function(){return this._groupAtInfoList}},{key:"_initProxy",value:function(){this._elements[0]&&(this.payload=this._elements[0].content,this.type=this._elements[0].type)}},{key:"reInitialize",value:function(e){e&&(this.status=this.from?An:Ln,this.from||(this.from=e)),this._initFlow(e),this._initSequence(e),this._concatConversationID(e),this.generateMessageID()}},{key:"isSendable",value:function(){return 0!==this._elements.length&&(!0===this._relayFlag||"function"==typeof this._elements[0].sendable&&this._elements[0].sendable())}},{key:"_initTo",value:function(e){this.conversationType===D.CONV_GROUP&&(this.to=e.groupID)}},{key:"_initSequence",value:function(e){var t,n,o;0===this.clientSequence&&e&&(this.clientSequence=!!e&&(void 0===vt[e]&&(o=new Date,t="3".concat(o.getHours()).slice(-2),n="0".concat(o.getMinutes()).slice(-2),o="0".concat(o.getSeconds()).slice(-2),vt[e]=parseInt([t,n,o,"0001"].join("")),o=n=t=null,Ne.l("autoIncrementIndex start index:".concat(vt[e]))),vt[e]++)),0===this.sequence&&this.conversationType===D.CONV_C2C&&(this.sequence=this.clientSequence)}},{key:"generateMessageID",value:function(){this.from===D.CONV_SYSTEM&&(this.senderTinyID="144115198244471703"),this.ID="".concat(this.senderTinyID,"-").concat(this.clientTime,"-").concat(this.random)}},{key:"_initFlow",value:function(e){""!==e&&(e===this.from?(this.flow="out",this.isRead=!0):this.flow="in")}},{key:"_concatConversationID",value:function(e){var t=this.to,n=this.conversationType;n!==D.CONV_SYSTEM?(e=n===D.CONV_C2C?e===this.from?t:this.from:this.to,this.conversationID=e?"".concat(n).concat(e):null):this.conversationID=D.CONV_SYSTEM}},{key:"isElement",value:function(e){return e instanceof ao||e instanceof fo||e instanceof mo||e instanceof vo||e instanceof To||e instanceof Do||e instanceof yo||e instanceof Co||e instanceof Eo||e instanceof Ro||e instanceof Lo}},{key:"setElement",value:function(e,t,n,o){var i=this;if(this.isElement(e))return this._elements=[e],void this._initProxy();function s(e){if(e.type&&e.content)switch(e.type){case D.MSG_TEXT:i.setTextElement(e.content);break;case D.MSG_IMAGE:i.setImageElement(e.content,t,n,o);break;case D.MSG_AUDIO:i.setAudioElement(e.content,t,n,o);break;case D.MSG_FILE:i.setFileElement(e.content,t,n,o);break;case D.MSG_VIDEO:i.setVideoElement(e.content,t,n,o);break;case D.MSG_CUSTOM:i.setCustomElement(e.content);break;case D.MSG_LOCATION:i.setLocationElement(e.content);break;case D.MSG_GRP_TIP:i.setGroupTipElement(e.content);break;case D.MSG_GRP_SYS_NOTICE:i.setGroupSystemNoticeElement(e.content);break;case D.MSG_FACE:i.setFaceElement(e.content);break;case D.MSG_MERGER:i.setMergerElement(e.content,t,n,o)}}if(Xe(e))for(var a=0;a<e.length;a++)s(e[a]);else s(e);this._initProxy()}},{key:"clearElement",value:function(){this._elements.length=0}},{key:"setTextElement",value:function(e){e="string"==typeof e?e:e.text,e=new ao({text:e}),this._elements.push(e)}},{key:"setImageElement",value:function(e,t,n,o){e=new fo(e,t,n,o),this._elements.push(e)}},{key:"setAudioElement",value:function(e,t,n,o){e=new vo(e,t,n,o),this._elements.push(e)}},{key:"setFileElement",value:function(e,t,n,o){e=new To(e,t,n,o),this._elements.push(e)}},{key:"setVideoElement",value:function(e,t,n,o){e=new Do(e,t,n,o),this._elements.push(e)}},{key:"setLocationElement",value:function(e){e=new Ro(e),this._elements.push(e)}},{key:"setCustomElement",value:function(e){e=new Eo(e),this._elements.push(e)}},{key:"setGroupTipElement",value:function(e){var t,n={},o=e.operationType;He(e.memberInfoList)?e.operatorInfo&&(n=e.operatorInfo):o!==D.GRP_TIP_MBR_JOIN&&o!==D.GRP_TIP_MBR_KICKED_OUT&&o!==D.GRP_TIP_MBR_SET_ADMIN&&o!==D.GRP_TIP_MBR_CANCELED_ADMIN||(n=e.memberInfoList[0]),He(e.memberExtraInfo)||(t=e.memberExtraInfo.reason,e.msgMemberInfo.forEach((function(e){e.reason=t}))),o=n.nick,n=n.avatar,dt(o)&&(this.nick=o),dt(n)&&(this.avatar=n),o=new yo(e),this._elements.push(o)}},{key:"setGroupSystemNoticeElement",value:function(e){e=new Co(e),this._elements.push(e)}},{key:"setFaceElement",value:function(e){e=new mo(e),this._elements.push(e)}},{key:"setMergerElement",value:function(e,t,n,o){e=new Lo(e,t,n,o),this._elements.push(e)}},{key:"setIsRead",value:function(e){this.isRead=e}},{key:"setRelayFlag",value:function(e){this._relayFlag=e}},{key:"_computePriority",value:function(e){return pt(e)?D.MSG_PRIORITY_NORMAL:dt(e)&&-1!==Object.values(Ao).indexOf(e)?e:je(e)&&(e=""+e,-1!==Object.keys(Ao).indexOf(e))?Ao[e]:D.MSG_PRIORITY_NORMAL}},{key:"setNickAndAvatar",value:function(e){var t=e.nick;e=e.avatar,dt(t)&&(this.nick=t),dt(e)&&(this.avatar=e)}},{key:"setNameCard",value:function(e){dt(e)&&(this.nameCard=e)}},{key:"initC2CReadReceiptInfo",value:function(e){var t=e.readReceiptSentByPeer;e=void 0===(e=e.timestamp)?0:e,this.conversationType===D.CONV_C2C&&!0===this.needReadReceipt&&(this.readReceiptInfo.isPeerRead=1===(void 0===t?void 0:t),this.readReceiptInfo.timestamp=e)}}]),No),Oo=["sound","FCMChannelID"];function No(e){o(this,No),this.ID="",this.conversationID=e.conversationID||null,this.conversationType=e.conversationType||D.CONV_C2C,this.conversationSubType=e.conversationSubType,this.time=e.time||Math.ceil(Date.now()/1e3),this.sequence=e.sequence||0,this.clientSequence=e.clientSequence||e.sequence||0,this.random=e.random||0===e.random?e.random:st(),this.priority=this._computePriority(e.priority),this.nick=e.nick||"",this.avatar=e.avatar||"",this.isPeerRead=!1,this.nameCard="",this.hasRiskContent=zt(e.checkResult),this._elements=[],this.isPlaceMessage=e.isPlaceMessage||0,this.isRevoked=2===e.isPlaceMessage||8===e.msgFlagBits,this.from=e.from||null,this.to=e.to||null,this.flow="",this.isSystemMessage=e.isSystemMessage||!1,this.protocol=e.protocol||"JSON",this.isResend=!1,this.isRead=!1,this.status=e.status||An,this._onlineOnlyFlag=!1,this._groupAtInfoList=[],this._relayFlag=!1,this.atUserList=[],this.cloudCustomData=e.cloudCustomData||"",this.isDeleted=!1,this.isModified=!!e.messageVersion,this._isExcludedFromUnreadCount=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromUnreadCount),this._isExcludedFromLastMessage=!(!e.messageControlInfo||1!==e.messageControlInfo.excludedFromLastMessage),this.clientTime=e.clientTime||De()||0,this.senderTinyID=e.senderTinyID||e.tinyID||"",this.readReceiptInfo=e.readReceiptInfo||{readCount:void 0,unreadCount:void 0,isPeerRead:void 0,timestamp:0},this.needReadReceipt=!0===e.needReadReceipt||1===e.needReadReceipt,this.version=e.messageVersion||0,this.isBroadcastMessage=e.isBroadcastMessage||!1,this._receiverList=e.receiverList||void 0,this.isSupportExtension=!0===e.isSupportExtension||1===e.isSupportExtension,this._cmConfigID=e.customModerationConfigurationID,this.revoker=e.revokerInfo&&e.revokerInfo.revoker||"",this.revokerInfo=e.revokerInfo||{userID:"",nick:"",avatar:""},this.revokeReason=e.revokeReason||"",this.reInitialize(e.currentUser),this.extractGroupInfo(e.groupProfile||null),this.handleGroupAtInfo(e),this.initC2CReadReceiptInfo(e)}function Po(e,t,n,i){var s,a,r,c,u,l,d;o(this,Po),this.type=D.MSG_MERGER,this.content={downloadKey:"",pbDownloadKey:"",messageList:[],title:"",abstractList:[],compatibleText:"",version:0,layersOverLimit:!1},e.downloadKey?(a=e.downloadKey,r=e.pbDownloadKey,c=e.title,u=e.abstractList,l=e.compatibleText,s=e.version,this.content.downloadKey=a,this.content.pbDownloadKey=r,this.content.title=c,this.content.abstractList=u,this.content.compatibleText=l,this.content.version=s||0):He(e.messageList)?1===e.layersOverLimit&&(this.content.layersOverLimit=!0):(a=e.messageList,r=e.title,c=e.abstractList,u=e.compatibleText,l=e.version,d=[],a.forEach((function(e){He(e)||(e=new So(e,t,n,i),d.push(e))})),this.content.messageList=d,this.content.title=r,this.content.abstractList=c,this.content.compatibleText=u,this.content.version=l||0)}function Go(e,t,n,i){var s,a;o(this,Go),this.from=e.from,this.messageSender=e.from,this.time=e.time,this.messageSequence=e.sequence,this.clientSequence=e.clientSequence||e.sequence,this.messageRandom=e.random,this.cloudCustomData=e.cloudCustomData||"",this.clientTime=e.clientTime||void 0,e.ID?(this.ID=e.ID||"",this.nick=e.nick||"",this.avatar=e.avatar||"",e.messageBody?this.messageBody=JSON.parse(JSON.stringify(e.messageBody)):this.messageBody=[{type:e.type,payload:e.payload}],e.conversationType?e.conversationType.startsWith(D.CONV_C2C)?this.receiverUserID=e.to:e.conversationType.startsWith(D.CONV_GROUP)&&(this.receiverGroupID=e.to):e.receiverGroupID?this.receiverGroupID=e.receiverGroupID:e.receiverUserID&&(this.receiverUserID=e.receiverUserID),this.messageReceiver=e.to||e.messageReceiver):(this.nick=e.nick||"",this.avatar=e.avatar||"",this.messageBody=[],s=e.elements[0].type,a=e.elements[0].content,this._patchRichMediaPayload(s,a),this._updateRichMediaDownloadUrl(s,a,t,n,i),s===D.MSG_MERGER?this.messageBody.push({type:s,payload:new Lo(a,t,n,i).content}):this.messageBody.push({type:s,payload:a}),e.groupID&&(this.receiverGroupID=e.groupID,this.messageReceiver=e.groupID),e.to&&(this.receiverUserID=e.to,this.messageReceiver=e.to),this.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random))}function Uo(e){o(this,Uo),this.type=D.MSG_LOCATION;var t=e.description,n=e.longitude;e=e.latitude,this.content={description:t,longitude:n,latitude:e}}function bo(e,t,n,i){o(this,bo),this.type=D.MSG_VIDEO,this._percent=0,this.content={remoteVideoUrl:e.remoteVideoUrl||e.videoUrl||"",videoFormat:e.videoFormat,videoSecond:parseInt(e.videoSecond,10),videoSize:e.videoSize,videoUrl:po(e.videoUrl,t,n,i),videoDownloadFlag:2,videoUUID:e.videoUUID,thumbUUID:e.thumbUUID,thumbFormat:e.thumbFormat,thumbWidth:e.thumbWidth,snapshotWidth:e.thumbWidth,thumbHeight:e.thumbHeight,snapshotHeight:e.thumbHeight,thumbSize:e.thumbSize,snapshotSize:e.thumbSize,thumbDownloadFlag:2,thumbUrl:po(e.thumbUrl,t,n,i),snapshotUrl:po(e.thumbUrl,t,n,i)}}function wo(e){o(this,wo),this.type=D.MSG_CUSTOM,this.content={data:e.data||"",description:e.description||"",extension:e.extension||""}}function Fo(e,t,n,i){o(this,Fo),this.type=D.MSG_FILE,this._percent=0;var s=this._getFileInfo(e);this.content={downloadFlag:2,fileUrl:po(e.url||e.fileUrl,t,n,i)||"",uuid:e.uuid,fileName:s.name||"",fileSize:s.size||0}}function qo(e){o(this,qo),this.type=D.MSG_GRP_SYS_NOTICE,this.content={},this._initContent(e)}function xo(e){o(this,xo),this.type=D.MSG_GRP_TIP,this.content={},this._initContent(e)}function Vo(e,t,n,i){o(this,Vo),this.type=D.MSG_AUDIO,this._percent=0,this.content={downloadFlag:2,second:e.second,size:e.size,url:po(e.url,t,n,i),remoteAudioUrl:e.url||"",uuid:e.uuid}}function Bo(e){o(this,Bo),this.type=D.MSG_FACE,this.content=e||null}function Ho(e,t,n,i){o(this,Ho),this._imageMemoryURL="",this._fileDownloadProxy=t,this._authKey=n,this._fileDNList=i,Z||ee?this.createImageDataASURL(e.file):this.createImageDataASURLInWeb(e.file),this._initImageInfoModel(),this.type=D.MSG_IMAGE,this._percent=0,this.content={imageFormat:e.imageFormat||Pe.UNKNOWN,uuid:e.uuid,imageInfoArray:[]},this.initImageInfoArray(e.imageInfoArray),this._autoFixUrl()}function Ko(e){if(ze(e))return{pushFlag:!0===e.disablePush?1:0,title:e.title||"",desc:e.description||"",ext:e.extension||"",apnsInfo:(o=void 0===(o=(n=e).apnsInfo)?{}:o,i=n.ignoreIOSBadge,n=n.disableVoipPush,i=!0===o.ignoreIOSBadge||!0===(void 0!==i&&i)?1:0,s=void 0,pt(n)||(s=!1===n?1:0),pt(o.disableVoipPush)||(s=!1===o.disableVoipPush?1:0),t(t({},o),{},{badgeMode:i,isVoipPush:s})),androidInfo:(o=void 0===(o=(n=e).androidInfo)?{}:o,n=n.androidOPPOChannelID,n=o.OPPOChannelID||(void 0===n?"":n),i=void 0===(i=o.sound)?"":i,s=void 0===(s=o.FCMChannelID)?"":s,t(t({},_(o,Oo)),{},{Sound:-1===(i=(o=i).lastIndexOf("."))?o:o.slice(0,i),OPPOChannelID:n,GoogleChannelID:s}))};var n,o,i,s}r(Xo,bn),Wo=g(Xo),s(Xo,[{key:"onNewMessage",value:function(e){var t=e.dataList,n=e.isInstantMessage,o=e.C2CRemainingUnreadList,i=e.C2CPairUnreadList,s=(e=e.isSyncingEnded,o=(n||Ne.l("".concat(this._n,".onNewMessage C2CPairUnreadList:"),i,"C2CRemainingUnreadList:",o),t=this._assembly({dataList:t,C2CRemainingUnreadList:o,C2CPairUnreadList:i,isInstantMessage:n})).conversationOptionsList,i=t.messageList,t=t.isUnreadC2CMessage,0<(s=yt(i)).length&&this.emitOEvt(E.MESSAGE_MODIFIED,s),this.get(11).onNewMessage({conversationOptionsList:o,isInstantMessage:n,isUnreadC2CMessage:t,isSyncingEnded:e}),Ct(i));n&&0<s.length&&this.emitOEvt(E.MESSAGE_RECEIVED,s),i.length=0}},{key:"_assembly",value:function(e){for(var t=e.dataList,n=e.C2CRemainingUnreadList,o=e.C2CPairUnreadList,i=e.isInstantMessage,s=null,a=[],r=[],c={},u=this.get(26),l=!1,d=this.get(11),p=this.get(4),_=(e=this.get(17),this.getFileDownloadProxy()),h=this.getDowloadFileAuthKey(),g=e.getFileDNList(),f=0,m=t.length;f<m;f++)if(this._isC2CNotice(t[f]))this._noticeFromUnreadDBList.push(t[f].eventArray[0].c2CNotifyMsgArray[0]);else{var v=t[f],I=(v.currentUser=this.getMyUserID(),v.conversationType=D.CONV_C2C,v.isSystemMessage=!!v.isSystemMessage,(pt(v.nick)||pt(v.avatar))&&(l=!0),(s=new ko(v)).setElement(v.elements,_,h,g),s.setNickAndAvatar({nick:v.nick,avatar:v.avatar}),s.conversationID);if(i){if(this._msgFromUnreadDBMap.get(s.ID))continue;var y,M,C=!1,T=(s.from!==this.getMyUserID()?(M=d.getLatestMessageSentByPeer(I))&&(y=M.nick,M=M.avatar,l?s.setNickAndAvatar({nick:y,avatar:M}):y===s.nick&&M===s.avatar||(C=!0)):(y=d.getLatestMessageSentByMe(I))&&(M=y.nick,T=y.avatar,M===s.nick&&T===s.avatar||(d.modifyMessageSentByMe({conversationID:I,latestNick:s.nick,latestAvatar:s.avatar}),p.mockOnNickAvatarModified(s.nick,s.avatar))),1===t[f].isModified);if(d.isMessageSentByCurrentInstance(s)?s.isModified=T:T=!1,0===v.msgLifeTime)s._onlineOnlyFlag=!0,d.isMessageSentByCurrentInstance(s)||r.push(s);else{if(!d.pushIntoMessageList(r,s,T))continue;C&&(d.modifyMessageSentByPeer({conversationID:I,latestNick:s.nick,latestAvatar:s.avatar}),d.updateUserProfileSpecifiedKey({conversationID:I,nick:s.nick,avatar:s.avatar}))}i&&0<s.clientTime&&u.addMessageDelay(s.clientTime)}else this._msgFromUnreadDBMap.set(s.ID,s);if(0!==v.msgLifeTime){if(!1===s._onlineOnlyFlag){if(je(C=d.getLastMessageTime(I))&&s.time<C)continue;i&&(pt(c[I])?(v=0,"in"===s.flow&&(s._isExcludedFromUnreadCount||(v=1)),c[I]=a.push({conversationID:I,unreadCount:v,type:s.conversationType,subType:s.conversationSubType,lastMessage:s._isExcludedFromLastMessage?"":s})-1):(v=c[I],a[v].type=s.conversationType,a[v].subType=s.conversationSubType,a[v].lastMessage=s._isExcludedFromLastMessage?"":s,"in"===s.flow&&(s._isExcludedFromUnreadCount||a[v].unreadCount++)))}}else s._onlineOnlyFlag=!0}this._handleNoticeFromUnreadDB();var E=!1;if(Xe(o)&&0<o.length)for(var R=0,S=o.length;R<S;R++)!function(e){if(o[e].from!==D.CONV_SYSTEM){E=!0;var t=a.find((function(t){return t.conversationID==="".concat(D.CONV_C2C).concat(o[e].from)}));t?t.unreadCount=o[e].unreadCount:a.push({conversationID:"".concat(D.CONV_C2C).concat(o[e].from),unreadCount:o[e].unreadCount,type:D.CONV_C2C})}}(R);if(Xe(n))for(var L=0,A=n.length;L<A;L++)!function(e){a.find((function(t){return t.conversationID==="".concat(D.CONV_C2C).concat(n[e].from)}))||a.push({conversationID:"".concat(D.CONV_C2C).concat(n[e].from),type:D.CONV_C2C,lastMsgTime:n[e].lastMsgTime})}(L);return{conversationOptionsList:a,messageList:r,isUnreadC2CMessage:E}}},{key:"getMessageListFromUnreadDB",value:function(){return m(this._msgFromUnreadDBMap.values())}},{key:"_isC2CNotice",value:function(e){return!(!Xe(e=e.eventArray)||10!==e[0].event)}},{key:"_handleNoticeFromUnreadDB",value:function(){var e,t=this._noticeFromUnreadDBList.length;0!==t&&(Ne.l("".concat(this._n,"._handleNoticeFromUnreadDB count:").concat(t)),e=[],this._noticeFromUnreadDBList.forEach((function(t){t.hasOwnProperty("c2cMessageRevokedNotify")&&e.push(t)})),this.onMsgRevoked({dataList:e}),this._noticeFromUnreadDBList.length=0,e.length=0)}},{key:"onMsgRevoked",value:function(e,t){var n,o=this,i=this.get(11),s=[];e.dataList.forEach((function(e){e.c2cMessageRevokedNotify&&(e=e.c2cMessageRevokedNotify.revokedInfos,pt(e)||e.forEach((function(e){var t=o.getMyUserID()===e.from?"".concat(D.CONV_C2C).concat(e.to):"".concat(D.CONV_C2C).concat(e.from);n=i.revoke(t,e.sequence,e.random);var a,r=e.revokerInfo&&e.revokerInfo.revoker,c=e.revokerInfo&&e.revokerInfo.reason||"";n?a=n:(a={conversationID:t,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(a.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)),e.time&&(a.time=e.time)),a&&(a.revoker=r,a.revokeReason=c,a.revokerInfo={userID:r,nick:"",avatar:""},s.push(a))})))})),0!==s.length&&(Ne.l("".concat(this._n,".onMsgRevoked count:").concat(s.length," updateUnreadCount:").concat(t)),i.onMessageRevoked(s,t),i.updateRevokerInfo(s).then((function(e){o.emitOEvt(E.MESSAGE_REVOKED,e)})))}},{key:"onMsgReadReceipt",value:function(e){var t=this;e.dataList.forEach((function(e){var n;He(e.c2cMessageReadReceipt)||(n=e.c2cMessageReadReceipt.to,e.c2cMessageReadReceipt.uinPairReadArray.forEach((function(e){e=e.peerReadTime;var o=(Ne.l("".concat(t._n,".onMsgReadReceipt to:").concat(n," peerReadTime:").concat(e)),"".concat(D.CONV_C2C).concat(n)),i=t.get(11);i.recordPeerReadTime(o,e),i.updateMsgIsPeerReadProp(o,e)})))}))}},{key:"onMsgReadNotice",value:function(e){var t=this;e.dataList.forEach((function(e){var n;He(e.c2cMessageReadNotice)||(n=t.get(11),e.c2cMessageReadNotice.uinPairReadArray.forEach((function(e){var o=e.from;e=e.peerReadTime,Ne.l("".concat(t._n,".onMsgReadNotice from:").concat(o," lastReadTime:").concat(e)),o="".concat(D.CONV_C2C).concat(o),n.updateIsReadAfterReadReport({conversationID:o,lastMessageTime:e}),n.updateUnreadCount(o)})))}))}},{key:"onMsgModified",value:function(e){Ne.l("".concat(this._n,".onMsgModified options:"),e);var n=this.get(11);e.dataList.forEach((function(e){n.onMessageModified(t(t({},e),{},{conversationType:D.CONV_C2C}))}))}},{key:"onReadReceiptList",value:function(e){Ne.l("".concat(this._n,".onReadReceiptList options:"),e),this.get(11).updateReadReceiptInfo(e.dataList)}},{key:"sendMessage",value:function(e,t){return e=this._createC2CMessagePack(e,t),this.req(e)}},{key:"_createC2CMessagePack",value:function(e,t){var n=null,o=(t&&(t.offlinePushInfo&&(n=t.offlinePushInfo),!0===t.onlineUserOnly&&(n?n.disablePush=!0:n={disablePush:!0})),""),i=(dt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData),[]),s=(ze(t)&&ze(t.messageControlInfo)&&(s=(r=t.messageControlInfo).excludedFromUnreadCount,a=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===s&&i.push("NoUnread"),!0===a&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),this.isOnlineMessage(e,t)?0:void 0),a=JSON.parse(JSON.stringify(e.getElements())),r=this.get(17).getFileDNList();return{P:Kn.SEND_C2C_MSG,data:{fromAccount:this.getMyUserID(),toAccount:e.to,msgBody:_o(e.type,a,r),cloudCustomData:o,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:s,nick:e.nick,avatar:e.avatar,offlinePushInfo:Ko(n),messageControlInfo:0!==s?i:void 0,clientTime:e.clientTime,needReadReceipt:!0===e.needReadReceipt?1:0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID,forbidCallbackControl:Mt(t)}}}},{key:"isOnlineMessage",value:function(e,t){return!(!t||!0!==t.onlineUserOnly)}},{key:"revokeMessage",value:function(e){return this.req({P:Kn.REVOKE_C2C_MSG,data:{msgInfo:{fromAccount:e.from,toAccount:e.to,msgSeq:e.sequence,msgRandom:e.random,msgTimeStamp:e.time}}})}},{key:"deleteMessage",value:function(e){var t=e.to;return e=e.keyList,Ne.l("".concat(this._n,".deleteMessage toAccount:").concat(t," count:").concat(e.length)),this.req({P:Kn.DEL_C2C_MSG,data:{fromAccount:this.getMyUserID(),to:t,keyList:e}})}},{key:"modifyRemoteMessage",value:function(e){var t=e.from,n=e.to,o=void 0===(o=e.version)?0:o,i=e.sequence,s=e.random,a=e.time,r=e.payload,c=e.type,u=e.cloudCustomData,l=void(e=e._elements);return Bt(c)&&(1<e.length&&e.splice(0,1,{type:c,content:r}),l=e),this.req({P:Kn.MODIFY_C2C_MSG,data:{from:t,to:n,version:o,sequence:i,random:s,time:a,elements:l,cloudCustomData:u}})}},{key:"setMessageRead",value:function(e){var t=this,n=e.conversationID,o=e.lastMessageTime,i="".concat(this._n,".").concat("setMessageRead"),s=(e="convID:".concat(n," lastMessageTime:").concat(o),Ne.l("".concat(i," ").concat(e)),je(o)||this.warn("DoNotModifyLastTime"),new so("setMessageRead"));return s.setMessage(e),this.req({P:Kn.SET_C2C_MSG_READ,data:{C2CMsgReaded:{cookie:"",C2CMsgReadedItem:[{toAccount:n.replace("C2C",""),lastMessageTime:o,receipt:1}]}}}).then((function(){s.end(),Ne.l("".concat(i," ok"));var e=t.get(11);return e.updateIsReadAfterReadReport({conversationID:n,lastMessageTime:o}),e.updateUnreadCount(n),En()})).catch((function(e){return s.setError(e).end(),Ne.l("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"getRoamingMessage",value:function(e){var t=this,n="".concat(this._n,".").concat("getRoamingMessage"),o=e.peerAccount,i=e.conversationID,s=e.count,a=e.lastMessageTime,r=(e=e.messageKey,"peerAccount:".concat(o," count:").concat(s||15," lastMessageTime:").concat(a||0," messageKey:").concat(e)),c=(Ne.l("".concat(n," ").concat(r)),new so("getRoamingMessage"));return this.req({P:Kn.GET_C2C_ROAMING_MSG,data:{peerAccount:o,count:s||15,lastMessageTime:a||0,messageKey:e}}).then((function(e){var o=(e=e.data).complete,s=e.messageList,a=e.messageKey,u=(e=e.lastMessageTime,pt(s)?Ne.l("".concat(n," ok. complete:").concat(o," but messageList is undefined!")):Ne.l("".concat(n," ok. complete:").concat(o," count:").concat(s.length)),c.setMessage("".concat(r," complete:").concat(o," length:").concat(s.length)).end(),t.get(11)),l=((o=1===o)&&u.setCompleted(i),[]);return s=u.onRoamingMessage(s,i,!0,l),u.modifyMessageList(i),u.updateIsRead(i),u.updateRoamingMsgKeyAndTime(i,a,e),a=u.getPeerReadTime(i),Ne.l("".concat(n," update isPeerRead property. convID:").concat(i," peerReadTime:").concat(a)),a?u.updateMsgIsPeerReadProp(i,a):(e=i.replace(D.CONV_C2C,""),t.getRemotePeerReadTime([e]).then((function(){u.updateMsgIsPeerReadProp(i,u.getPeerReadTime(i))}))),a="",0<s.length?a=s[0].ID:(e=u.getLocalOldestMessage(i))&&(a=e.ID),Ne.l("".concat(n," nextReqID:").concat(a," storedMsgCount:").concat(s.length)),{nextReqID:a,storedMessageList:s,assembledMessageList:l,isPullingCompleted:o}})).catch((function(e){return c.setMessage(r).setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"getRoamingMessagesHopping",value:function(e){var t=this,n="".concat(this._n,".").concat("getRoamingMessagesHopping"),o=e.peerAccount,i=void 0===(i=e.time)?0:i,s=e.count,a=e.direction,r="".concat(D.CONV_C2C).concat(o),c="peerAccount:".concat(o," count:").concat(s," time:").concat(i," direction:").concat(a),u=(Ne.l("".concat(n," ").concat(c)),new so("getRoamingMessagesHopping"));return this.req({P:Kn.GET_C2C_ROAMING_MSG,data:{peerAccount:o,count:s+1,lastMessageTime:i,direction:a}}).then((function(e){var o=(e=e.data).complete,i=void 0===(i=e.messageList)?[]:i,s=(e=e.lastMessageTime,"complete:".concat(o," count:").concat(i.length)),l=(Ne.l("".concat(n," ok. ").concat(s)),u.setMessage("".concat(c," ").concat(s)).end(),1!==o&&(1===a?i.pop():i.shift()),t.get(11));return s=l.onRoamingMessage(i,r,!1),t._modifyMessageList(r,s),i=t._computeResult({complete:o,lastMessageTime:e,resultList:s}),l.storeHoppingMessageList(i.messageList),o=l.getPeerReadTime(r),Ne.l("".concat(n," update isPeerRead property. convID:").concat(r," peerReadTime:").concat(o)),o?l.updateMsgIsPeerReadProp(r,o):(e=r.replace(D.CONV_C2C,""),t.getRemotePeerReadTime([e]).then((function(){l.updateMsgIsPeerReadProp(r,l.getPeerReadTime(r))}))),En(i)})).catch((function(e){return u.setMessage(c).setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"_computeResult",value:function(e){var t=void 0===(t=e.complete)?0:t,n=e.lastMessageTime;return e={messageList:m(void 0===(e=e.resultList)?[]:e),isCompleted:!1,nextMessageTime:""},1===t?e.isCompleted=!0:e.nextMessageTime=n,e}},{key:"_modifyMessageList",value:function(e,t){if(e=this.get(11).getLocalConversation(e))for(var n=e.userProfile.nick,o=e.userProfile.avatar,i=(e=this.get(4).getNickAndAvatarByUserID(this.getMyUserID())).nick,s=e.avatar,a=t.length-1;0<=a;a--){var r=t[a];"in"===r.flow&&(r.nick!==n&&r.setNickAndAvatar({nick:n}),r.avatar!==o&&r.setNickAndAvatar({avatar:o})),"out"===r.flow&&(r.nick!==i&&r.setNickAndAvatar({nick:i}),r.avatar!==s&&r.setNickAndAvatar({avatar:s}))}}},{key:"getRemotePeerReadTime",value:function(e){var t=this,n="".concat(this._n,".").concat("getRemotePeerReadTime");if(He(e))return Promise.resolve();var o=new so("getRemotePeerReadTime");return Ne.l("".concat(n," userIDList:").concat(e)),this.req({P:Kn.GET_C2C_PEER_READ_TIME,data:{userIDList:e}}).then((function(i){var s=i.data.peerReadTimeList;Ne.l("".concat(n," ok. peerReadTimeList:").concat(s));for(var a="",r=t.get(11),c=0;c<e.length;c++)a+="".concat(e[c],"-").concat(s[c]," "),0<s[c]&&r.recordPeerReadTime("".concat(D.CONV_C2C).concat(e[c]),s[c]);o.setMessage(a).end()})).catch((function(e){o.setError(e).end(),Ne.w("".concat(n," failed. error:"),e)}))}},{key:"sendReadReceipt",value:function(e){var t=e[0].conversationID.replace(D.CONV_C2C,""),n=new so("sendReadReceipt"),o=(n.setMessage("peerAccount:".concat(t)),this.getMyUserID());if(0===(e=e.filter((function(e){return e.from!==o&&!0===e.needReadReceipt})).map((function(e){return{fromAccount:e.from,toAccount:e.to,sequence:e.sequence,random:e.random,time:e.time,clientTime:e.clientTime}}))).length)return Rn({code:Bn.READ_RECEIPT_MSG_LIST_EMPTY});var i="".concat(this._n,".").concat("sendReadReceipt");return Ne.l("".concat(i,". peerAccount:").concat(t," length:").concat(e.length)),this.req({P:Kn.SEND_C2C_READ_RECEIPT,data:{peerAccount:t,messageInfoList:e}}).then((function(e){return n.end(),Ne.l("".concat(i," ok")),En()})).catch((function(e){return n.setError(e).end(),Ne.w("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"getReadReceiptList",value:function(e){var t=e[0].conversationID.replace(D.CONV_C2C,"");return Ne.l("".concat(this._n,".getReadReceiptList peerAccount:").concat(t," msgCount:").concat(e.length)),Dn({messageList:e})}},{key:"getMessageExtensions",value:function(e,t){return Ne.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t)),this.req({P:Kn.GET_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),startSequence:t}})}},{key:"modifyMsgExts",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;return Ne.l("".concat(this._n,".modifyMsgExts operateType:").concat(n)),this.req({P:Kn.MODIFY_C2C_MSG_EXT,data:{from:e.from,to:e.to,messageKey:this.getMessageKey(e),extensionList:t,operateType:n}})}},{key:"getMessageKey",value:function(e){var t=e.clientSequence,n=e.random;return e=e.time,"".concat(t,"_").concat(n,"_").concat(e)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._msgFromUnreadDBMap.clear(),this._noticeFromUnreadDBList.length=0}}]);var Wo,Yo=Xo,jo={A2KEY_AND_TINYID_UPDATED:"_inner".concat(1),CLOUD_CONFIG:"_inner".concat(2),PROFILE_UPDATED:"_inner".concat(3),CONV_SYNC_COMPLETED:"_inner".concat(4),C2C_UNREAD_HANDLE_COMPLETED:"_inner".concat(5)},Jo=(s(zo,[{key:"_onCloudConfig",value:function(){var e=this._convM.getCloudConfig("topic_msg_limit");pt(e)||(this.TOPIC_MSG_LIMIT=Number(e)),Ne.l("".concat(this._n,"._onCloudConfig topicMsgLimit:").concat(this.TOPIC_MSG_LIMIT))}},{key:"onCheckTimer",value:function(e){if(e%20==0&&0<this._map.size){var t,n=T(this._map);try{for(n.s();!(t=n.n()).done;){var o=f(t.value,2),i=o[0],s=o[1];i.includes(Ve)&&s.size>=this.TOPIC_MSG_LIMIT&&this._convM.clearMemMsg(i,!0)}}catch(e){n.e(e)}finally{n.f()}}}},{key:"pushIn",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=e.conversationID,o=!0,i=(this._map.has(n)||this._map.set(n,new Map),this._getUniqueIDOfMsg(e));if(this._map.get(n).has(i)){var s=this._map.get(n).get(i);if(!t||!0===s.isModified)return!1}return this._map.get(n).set(i,e),this._setLatestMsgSentByPeer(n,e),this._setLatestMsgSentByMe(n,e),o}},{key:"unshift",value:function(e,t){var n;if(Xe(e)?0<e.length&&(n=e[0].conversationID,this._unshiftMultipleMsgs(e,t)):(n=e.conversationID,this._unshiftSingleMsg(e,t)),n){var o=Array.from(this._map.get(n).values());if(0!==(e=o.length)){for(var i=e-1;0<=i;i--)if("out"===o[i].flow){this._setLatestMsgSentByMe(n,o[i]);break}if(n.startsWith(D.CONV_C2C))for(var s=e-1;0<=s;s--)if("in"===o[s].flow){this._setLatestMsgSentByPeer(n,o[s]);break}}}}},{key:"_unshiftSingleMsg",value:function(e,t){var n=e.conversationID,o=this._getUniqueIDOfMsg(e);if(!this._map.has(n))return this._map.set(n,new Map),this._map.get(n).set(o,e),void t.push(e);var i=this._map.get(n),s=Array.from(i);i.has(o)||(s.unshift([o,e]),this._map.set(n,new Map(s)),t.push(e))}},{key:"_unshiftMultipleMsgs",value:function(e,t){for(var n=e.length,o=[],i=e[0].conversationID,s=this._map.get(i),a=this._map.has(i)?Array.from(s):[],r=0;r<n;r++){var c=this._getUniqueIDOfMsg(e[r]);s&&s.has(c)||(o.push([c,e[r]]),t.push(e[r]))}this._map.set(i,new Map(o.concat(a)))}},{key:"remove",value:function(e){var t=e.conversationID;e=this._getUniqueIDOfMsg(e),this._map.has(t)&&this._map.get(t).delete(e)}},{key:"revoke",value:function(e,t,n){var o;return this._map.has(e)?(o=this._map.get(e),this._updateMsgIsRevoked(o,t,n)):this._hoppingMsgMap.has(e)?(o=this._hoppingMsgMap.get(e),this._updateMsgIsRevoked(o,t,n)):null}},{key:"_updateMsgIsRevoked",value:function(e,t,n){var o,i=T(e);try{for(i.s();!(o=i.n()).done;){var s=f(o.value,2)[1];if(s.sequence===t&&(pt(n)||s.random===n))return s.isRevoked||(s.isRevoked=!0),s}}catch(e){i.e(e)}finally{i.f()}}},{key:"removeByConvID",value:function(e){var t=this._map.has(e);Ne.l("".concat(this._n,".removeByConvID convID:").concat(e," has:").concat(t)),t&&(this._map.delete(e),this._latestMsgSentByPeerMap.delete(e),this._latestMsgSentByMeMap.delete(e))}},{key:"findMessage",value:function(e){var t=null;return(t=this._findMsg(e,this._map))?t:this._findMsg(e,this._hoppingMsgMap)}},{key:"_findMsg",value:function(e,t){var n,o=null,i=T(t);try{for(i.s();!(n=i.n()).done;)for(var s=m(f(n.value,2)[1].values()),a=s.length,r=0;r<a;r++)if(s[r].ID===e){o=s[r];break}}catch(e){i.e(e)}finally{i.f()}return o}},{key:"updateMsgIsPeerReadProp",value:function(e,t){var n,o=[];return this._map.has(e)?(n=this._map.get(e),o=this._updateMsgIsPeerReadProp(n,t)):this._hoppingMsgMap.has(e)&&(n=this._hoppingMsgMap.get(e),o=this._updateMsgIsPeerReadProp(n,t)),Ne.l("".concat(this._n,".updateMsgIsPeerReadProp convID:").concat(e," peerReadTime:").concat(t," count:").concat(o.length)),o}},{key:"_updateMsgIsPeerReadProp",value:function(e,t){var n,o=[],i=T(e);try{for(i.s();!(n=i.n()).done;){var s=f(n.value,2)[1];s.time<=t&&!s.isPeerRead&&"out"===s.flow&&(s.isPeerRead=!0,o.push(s))}}catch(e){i.e(e)}finally{i.f()}return o}},{key:"updateMsgIsModifiedProp",value:function(e){var t=e.conversationID;this._map.has(t)&&(e=this._getUniqueIDOfMsg(e),(t=this._map.get(t).get(e))&&(t.isModified=!0))}},{key:"hasLocalMsgList",value:function(e){return this._map.has(e)}},{key:"getLocalMsgList",value:function(e){return this.hasLocalMsgList(e)?m(this._map.get(e).values()):[]}},{key:"getLocalMaxSeq",value:function(e){return this.hasLocalMsgList(e)?(e=m(this._map.get(e).values()).map((function(e){return e.sequence})),Math.max.apply(Math,m(e))):0}},{key:"getLocalMaxTime",value:function(e){return this.hasLocalMsgList(e)?(e=m(this._map.get(e).values()).map((function(e){return e.time})),Math.max.apply(Math,m(e))):0}},{key:"hasLocalMsg",value:function(e,t){for(var n=!1,o=this.getLocalMsgList(e),i=o.length,s=0;s<i;s++)o[s].ID===t&&(n=!0);return n}},{key:"getLocalMsg",value:function(e,t){for(var n=null,o=this.getLocalMsgList(e),i=o.length,s=0;s<i;s++)if(o[s].ID===t){n=o[s];break}return n}},{key:"getLocalLastMsg",value:function(e){return(e=this.getLocalMsgList(e))[e.length-1]}},{key:"getLocalSecondLastMsg",value:function(e){return(e=this.getLocalMsgList(e))[e.length-2]}},{key:"getLocalOldestMsg",value:function(e){return this.getLocalMsgList(e)[0]}},{key:"_setLatestMsgSentByPeer",value:function(e,t){e.startsWith(D.CONV_C2C)&&"in"===t.flow&&this._latestMsgSentByPeerMap.set(e,t)}},{key:"_setLatestMsgSentByMe",value:function(e,t){"out"===t.flow&&this._latestMsgSentByMeMap.set(e,t)}},{key:"getLatestMsgSentByPeer",value:function(e){return this._latestMsgSentByPeerMap.get(e)}},{key:"getLatestMsgSentByMe",value:function(e){return this._latestMsgSentByMeMap.get(e)}},{key:"modifyMsgSentByPeer",value:function(e){var t=e.conversationID,n=e.latestNick,o=e.latestAvatar;if(!He(e=this._map.get(t))){var i=Array.from(e.values());if(0!==(e=i.length)){for(var s=null,a=0,r=!1,c=e-1;0<=c;c--)"in"===i[c].flow&&((s=i[c]).nick!==n&&(s.setNickAndAvatar({nick:n}),r=!0),s.avatar!==o&&(s.setNickAndAvatar({avatar:o}),r=!0),r&&(a+=1));Ne.l("".concat(this._n,".modifyMsgSentByPeer convID:").concat(t," count:").concat(a))}}}},{key:"modifyMsgSentByMe",value:function(e){var t=e.conversationID,n=e.latestNick,o=e.latestAvatar;if(!He(e=this._map.get(t))){var i=Array.from(e.values());if(0!==(e=i.length)){for(var s=null,a=0,r=!1,c=e-1;0<=c;c--)"out"===i[c].flow&&((s=i[c]).nick!==n&&(s.setNickAndAvatar({nick:n}),r=!0),s.avatar!==o&&(s.setNickAndAvatar({avatar:o}),r=!0),r&&(a+=1));Ne.l("".concat(this._n,".modifyMsgSentByMe convID:").concat(t," count:").concat(a))}}}},{key:"getTopicConvIDList",value:function(e){return m(this._map.keys()).filter((function(t){return t.startsWith("".concat(D.CONV_GROUP).concat(e))}))}},{key:"onMsgModified",value:function(e,t){if(!this._map.has(e)&&!this._hoppingMsgMap.has(e))return{isUpdated:!1,message:null};var n="".concat(this._n,".onMsgModified"),o=this._getUniqueIDOfMsg(t),i=this._getTargetMsg(e,o),s=!!i;return Ne.l("".concat(n," convID:").concat(e," uniqueID:").concat(o," has:").concat(s)),s?(e=t.messageVersion,o=t.elements,s=t.cloudCustomData,t=t.checkResult,Ne.l("".concat(n," localVersion:").concat(i.version," remoteVersion:").concat(e)),i.version<e?(i.version=e,i._elements=JSON.parse(JSON.stringify(o)),i.payload=i._elements[0].content,i.type=i._elements[0].type,i.cloudCustomData=s,i.isModified=!0,i.hasRiskContent=zt(t),{isUpdated:!0,message:i}):{isUpdated:!1,message:i}):{isUpdated:!1,message:null}}},{key:"_getUniqueIDOfMsg",value:function(e){var t=e.from,n=e.to,o=e.random,i=e.sequence;return e=e.time,"".concat(t,"-").concat(n,"-").concat(o,"-").concat(i,"-").concat(e)}},{key:"_getTargetMsg",value:function(e,t){if(this._map.has(e))return this._map.get(e).get(t);var n=void 0;if(this._hoppingMsgMap.has(e))for(var o=m(this._hoppingMsgMap.get(e).values()),i=0;i<o.length;i++)if(this._getUniqueIDOfMsg(o[i])===t){n=o[i];break}return n}},{key:"storeHoppingMsgList",value:function(e){if(0!==e.length){var t=e[0].conversationID,n=e.length;this._hoppingMsgMap.has(t)||this._hoppingMsgMap.set(t,new Map);for(var o=this._hoppingMsgMap.get(t),i=0;i<n;i++){var s=e[i];o.has(s.ID)||o.set(s.ID,s)}}}},{key:"getHoppingMsg",value:function(e,t){if(this._hoppingMsgMap.has(e))return this._hoppingMsgMap.get(e).get(t)}},{key:"reset",value:function(){this._map.clear(),this._latestMsgSentByPeerMap.clear(),this._latestMsgSentByMeMap.clear(),this._hoppingMsgMap.clear()}}]),zo);function zo(e){o(this,zo),this._convM=e,this._map=new Map,this._n="MsgListHandler",this._latestMsgSentByPeerMap=new Map,this._latestMsgSentByMeMap=new Map,this._hoppingMsgMap=new Map,this.TOPIC_MSG_LIMIT=1e3,this._convM.getIEmitInst().on(jo.CLOUD_CONFIG,this._onCloudConfig,this)}function Xo(e){return o(this,Xo),(e=Wo.call(this,e))._n="C2CModule",e._msgFromUnreadDBMap=new Map,e._noticeFromUnreadDBList=[],e}function Qo(e){this.mixin(e)}function Zo(e,n,o){return pt(e)?{lastTime:0,lastSequence:0,fromAccount:"",messageForShow:"",payload:null,type:"",isRevoked:!1,cloudCustomData:"",onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:!1,revoker:null}:o&&e.ID||e instanceof ko?{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",messageForShow:Vt(e.type,e.payload,n),payload:e.payload||null,type:e.type||null,isRevoked:e.isRevoked||!1,cloudCustomData:e.cloudCustomData||"",onlineOnlyFlag:e._onlineOnlyFlag||!1,nick:e.nick||"",nameCard:e.nameCard||"",version:e.version||0,isPeerRead:e.isPeerRead||!1,revoker:e.revoker||null}:t(t({},e),{},{messageForShow:Vt(e.type,e.payload,n)})}function $o(e,t){return He(e)?{lastTime:0,lastSequence:0,fromAccount:"",payload:null,type:"",messageForShow:"",nick:"",avatar:"",version:0,cloudCustomData:"",isRevoked:!1,revoker:null}:{lastTime:e.time||0,lastSequence:e.sequence||0,fromAccount:e.from||"",payload:e.payload||null,type:e.type||"",messageForShow:Vt(e.type,e.payload,t),nick:e.nick||"",avatar:e.avatar||"",version:e.version||0,cloudCustomData:e.cloudCustomData||"",isRevoked:e.isRevoked||!1,revoker:e.revoker||null}}function ei(e){var t=String(e).replace(/[=]+$/,""),n="";if(t.length%4==1)return"";for(var o,i,s=0,a=0;i=t.charAt(a++);~i&&(o=s%4?64*o+i:i,s++%4)&&(n+=String.fromCharCode(255&o>>(-2*s&6))))i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);try{return decodeURIComponent(escape(n))}catch(e){return""}}Qo.mixin=function(e){(e=e.prototype||e)._isReady=!1,e.ready=function(e){if(e)return this._isReady?void(1<arguments.length&&void 0!==arguments[1]&&arguments[1]?e.call(this):setTimeout(e,1)):(this._readyQueue=this._readyQueue||[],void this._readyQueue.push(e))},e.triggerReady=function(){var e=this;this._isReady=!0,setTimeout((function(){var t=e._readyQueue;e._readyQueue=[],t&&0<t.length&&t.forEach((function(e){e.call(this)}),e)}),1)},e.resetReady=function(){this._isReady=!1,this._readyQueue=[]},e.isReady=function(){return this._isReady}};var ti,ni,oi,ii,si,ai=["jpg","jpeg","gif","png","bmp","image","webp"],ri=["mp4","quicktime","mov"],ci=(s(ds,[{key:"validate",value:function(e){var t,n=!0,o="";if(He(e))return{valid:!1,tips:"empty options"};if(e.profileCustomField)for(var i=e.profileCustomField.length,s=null,a=0;a<i;a++){if(s=e.profileCustomField[a],!dt(s.key)||-1===s.key.indexOf("Tag_Profile_Custom"))return{valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!dt(s.value))return{valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if("profileCustomField"===t)continue;if(He(e[t])&&!dt(e[t])&&!je(e[t])){o="key:"+t+", invalid value:"+e[t],n=!1;continue}switch(t){case"nick":dt(e[t])||(n=!(o="nick must be a string")),500<it(e[t])&&(o="nick name limited: must less than or equal to ".concat(500," bytes, current size: ").concat(it(e[t])," bytes"),n=!1);break;case"gender":rt(be,e.gender)||(o="key:gender, invalid value:"+e.gender,n=!1);break;case"birthday":je(e.birthday)||(n=!(o="birthday must be a number"));break;case"location":dt(e.location)||(n=!(o="location must be a string"));break;case"selfSignature":dt(e.selfSignature)||(n=!(o="selfSignature must be a string"));break;case"allowType":rt(Fe,e.allowType)||(o="key:allowType, invalid value:"+e.allowType,n=!1);break;case"language":je(e.language)||(n=!(o="language must be a number"));break;case"avatar":dt(e.avatar)||(n=!(o="avatar must be a string"));break;case"messageSettings":0!==e.messageSettings&&1!==e.messageSettings&&(n=!(o="messageSettings must be 0 or 1"));break;case"adminForbidType":rt(we,e.adminForbidType)||(o="key:adminForbidType, invalid value:"+e.adminForbidType,n=!1);break;case"level":je(e.level)||(n=!(o="level must be a number"));break;case"role":je(e.role)||(n=!(o="role must be a number"));break;default:o="unknown key:"+t+"  "+e[t],n=!1}}return{valid:n,tips:o}}}]),ds),ui=(s(ls,[{key:"set",value:function(e){var t;this.map.size>=this.MAX_LENGTH&&(t=this.map.entries().next().value[0],this.map.delete(t)),this.map.set(e,1)}},{key:"has",value:function(e){return this.map.has(e)}},{key:"delete",value:function(e){this.has(e)&&this.map.delete(e)}},{key:"reset",value:function(){this.map.clear()}}]),ls),li=["groupID","name","avatar","type","introduction","notification","ownerID","selfInfo","createTime","infoSequence","lastInfoTime","lastMessage","nextMessageSeq","memberNum","maxMemberNum","memberList","joinOption","groupCustomField","muteAllMembers","isSupportTopic","inviteOption","_lastRevokedTime"],di=(s(us,[{key:"memberNum",get:function(){return this.memberCount},set:function(e){}},{key:"maxMemberNum",get:function(){return this.maxMemberCount},set:function(e){}},{key:"_initGroup",value:function(e){for(var t in e)li.indexOf(t)<0||("selfInfo"!==t?("memberNum"===t&&(this.memberCount=e[t]),"maxMemberNum"===t&&(this.maxMemberCount=e[t]),"isSupportTopic"!==t?this[t]=e[t]:this.isSupportTopic=1===e[t]):this.updateSelfInfo(e[t]))}},{key:"updateGroup",value:function(e){var t=this;(e.appid=void 0,e.grossTopicNextMsgSeq=void 0,e.selfInfo&&(e.selfInfo.grossTopicReadSeq=void 0),e=JSON.parse(JSON.stringify(e))).lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),pt(e.muteAllMembers)||("On"===e.muteAllMembers?e.muteAllMembers=!0:e.muteAllMembers=!1),e.groupCustomField&&It(this.groupCustomField,e.groupCustomField),pt(e.memberNum)||(this.memberCount=e.memberNum),pt(e.maxMemberNum)||(this.maxMemberCount=e.maxMemberNum),pt(e.isSupportTopic)||(this.isSupportTopic=je(e.isSupportTopic)?1===e.isSupportTopic:e.isSupportTopic),nt(this,e,["members","errorCode","lastMsgTime","groupCustomField","memberNum","maxMemberNum","isSupportTopic"]),Xe(e.members)&&0<e.members.length&&e.members.forEach((function(e){e.userID===t.selfInfo.userID&&nt(t.selfInfo,e,["sequence"])}))}},{key:"updateSelfInfo",value:function(e){e={nameCard:e.nameCard,joinTime:e.joinTime,role:e.role,messageRemindType:e.messageRemindType,readedSequence:e.readedSequence,excludedUnreadSequenceList:e.excludedUnreadSequenceList},nt(this.selfInfo,t({},e),[],["",null,void 0,0,NaN])}},{key:"setSelfNameCard",value:function(e){this.selfInfo.nameCard=e}}]),us),pi=(s(cs,[{key:"toAccount",get:function(){return this.conversationID.startsWith(D.CONV_C2C)?this.conversationID.replace(D.CONV_C2C,""):this.conversationID.startsWith(D.CONV_GROUP)?this.conversationID.replace(D.CONV_GROUP,""):""}},{key:"_initProfile",value:function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"userProfile":t.userProfile=e.userProfile;break;case"groupProfile":t.groupProfile=e.groupProfile}})),pt(this.userProfile)&&this.type===D.CONV_C2C?this.userProfile=new ci({userID:e.conversationID.replace("C2C","")}):pt(this.groupProfile)&&this.type===D.CONV_GROUP&&(this.groupProfile=new di({groupID:e.conversationID.replace("GROUP","")}))}},{key:"updateUnreadCount",value:function(e){var t=e.nextUnreadCount,n=e.isFromGetConversations;e=e.isUnreadC2CMessage,pt(t)||(Tt(this.subType)?this.unreadCount=0:n&&this.type===D.CONV_GROUP||n&&this.type===D.CONV_TOPIC||e&&this.type===D.CONV_C2C?this.unreadCount=t:this.unreadCount=this.unreadCount+t)}},{key:"updateLastMessage",value:function(e){this.lastMessage=Zo(e)}},{key:"updateGroupAtInfoList",value:function(e){var t;this._isNeedMergeGroupAtInfo(e)||(-1!==(t=(v(t=e.groupAtType)||I(t)||y(t)||C()).slice(0)).indexOf(D.CONV_AT_ME)&&-1!==t.indexOf(D.CONV_AT_ALL)&&(t=[D.CONV_AT_ALL_AT_ME]),t={from:e.from,groupID:e.groupID,topicID:e.topicID,messageSequence:e.sequence,atTypeArray:t,__random:e.__random,__sequence:e.__sequence},this.groupAtInfoList.push(t))}},{key:"_isNeedMergeGroupAtInfo",value:function(e){var t=e.groupID,n=e.sequence;if(!Et({groupID:t}))return!1;var o=!1;return this.groupAtInfoList.forEach((function(t){t.messageSequence===n&&(-1<t.atTypeArray.indexOf(D.CONV_AT_ME)&&-1<e.groupAtType.indexOf(D.CONV_AT_ALL)&&(t.atTypeArray=[D.CONV_AT_ALL_AT_ME]),-1<t.atTypeArray.indexOf(D.CONV_AT_ALL)&&-1<e.groupAtType.indexOf(D.CONV_AT_ME)&&(t.atTypeArray=[D.CONV_AT_ALL_AT_ME],t.__random=e.__random,t.__sequence=e.__sequence),o=!0)})),o}},{key:"clearGroupAtInfoList",value:function(){this.groupAtInfoList.length=0}},{key:"reduceUnreadCount",value:function(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}},{key:"isLastMessageRevoked",value:function(e){var t=e.sequence;return e=e.time,this.type===D.CONV_C2C&&t===this.lastMessage.lastSequence&&e===this.lastMessage.lastTime||this.type===D.CONV_GROUP&&t===this.lastMessage.lastSequence}},{key:"setLastMessageRevoked",value:function(e){this.lastMessage.isRevoked=e}},{key:"setLastMessageRevoker",value:function(e){this.lastMessage.revoker=e}},{key:"setDraftText",value:function(e){this.draftText=e}}]),cs),_i=(a(wn={},D.MSG_REMIND_ACPT_AND_NOTE,0),a(wn,D.MSG_REMIND_DISCARD,1),a(wn,D.MSG_REMIND_ACPT_NOT_NOTE,2),wn),hi=(s(rs,[{key:"onAllRcvMsgOptNotify",value:function(e){e=this._handleResult(e),this._convM.emitOEvt(E.ALL_RECEIVE_MESSAGE_OPT_UPDATED,e)}},{key:"getC2CMsgRemindType",value:function(e){var t=this,n="".concat(this._n,".getC2CMsgRemindType");return this._convM.req({P:Kn.GET_C2C_PEER_MUTE_NOTIFICATIONS,data:{toAccount:this._convM.getMyUserID(),userIDList:e}}).then((function(o){Ne.l("".concat(n," ok. userIDList:").concat(e)),o=o.data.muteFlagList,t._convM.onC2CMsgRemindTypeFetched(o)})).catch((function(e){Ne.e("".concat(n," failed. error:"),e)}))}},{key:"set",value:function(e){return e.groupID?this._setGroupMsgRemindType(e):Xe(e.userIDList)?this._setC2CMsgRemindType(e):void 0}},{key:"_setGroupMsgRemindType",value:function(e){var t=this,n="".concat(this._n,".").concat("_setGroupMsgRemindType"),o=e.groupID,i=e.messageRemindType,s="groupID:".concat(o," messageRemindType:").concat(i),a=new so("_setGroupMsgRemindType"),r=(a.setMessage(s),this._get(7));return r?r.modifyGroupMemberInfo({groupID:o,messageRemindType:i,userID:this._convM.getMyUserID()}).then((function(){a.end(),Ne.l("".concat(n," ok. ").concat(s));var o=t.onGroupMsgRemindTypeUpdated(e);return t._convM.onTotalUnreadCountUpdate(),En(o)})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)})):Rn({code:Bn.NO_MODULE})}},{key:"onGroupMsgRemindTypeUpdated",value:function(e){var t,n,o=e.groupID,i=(e=e.messageRemindType,Ne.l("".concat(this._n,".onGroupMsgRemindTypeUpdated groupID:").concat(o," messageRemindType:").concat(e)),this._get(7).getLocalGroupProfile(o));return i&&(i.selfInfo.messageRemindType=e),Dt(o)?(t=xt(n=o),(n=this._get(10).getLocalTopic(t,n))&&n.updateSelfInfo({messageRemindType:e})&&this._convM.emitOEvt(E.TOPIC_UPDATED,{groupID:t,topic:n}),{topic:n}):(this._convM.patchMsgRemindType({ID:o,isC2CConversation:!1,messageRemindType:e})&&this._emitConvUpdate(),{group:i})}},{key:"_setC2CMsgRemindType",value:function(e){var t=this,n="".concat(this._n,".").concat("_setC2CMsgRemindType"),o=e.userIDList,i=e.messageRemindType,s=o.slice(0,30),a=(e=_i[i]||0,"userIDList:".concat(s," messageRemindType:").concat(i)),r=new so("_setC2CMsgRemindType");return r.setMessage(a),this._convM.req({P:Kn.SET_C2C_PEER_MUTE_NOTIFICATIONS,data:{userIDList:s,muteFlag:e}}).then((function(e){r.end(),e=e.data.errorList;var o=[],c=[],u=(Xe(e)&&e.forEach((function(e){o.push(e.userID),c.push({userID:e.userID,code:e.errorCode})})),e=s.filter((function(e){return-1===o.indexOf(e)})),Ne.l("".concat(n," ok. ").concat(a," successUserIDList:").concat(e," failureUserIDList:").concat(JSON.stringify(c))),0);return e.forEach((function(e){t._convM.patchMsgRemindType({ID:e,isC2CConversation:!0,messageRemindType:i})&&(u+=1)})),1<=u&&t._emitConvUpdate(),s.length=o.length=0,t._convM.onTotalUnreadCountUpdate(),Dn({successUserIDList:e.map((function(e){return{userID:e}})),failureUserIDList:c})})).catch((function(e){return r.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"_get",value:function(e){return this._convM.get(e)}},{key:"_emitConvUpdate",value:function(){this._convM.emitConvUpdate(!0,!1)}},{key:"setAllRcvMsgOpt",value:function(e){var t="".concat(this._n,".").concat("setAllRcvMsgOpt"),n=void 0===(n=e.messageRemindType)?D.MSG_REMIND_ACPT_NOT_NOTE:n,o=void 0===(o=e.isRepeated)||o,i=void 0===(i=(s=this._calcStartAndEndTime(e)).startTime)?0:i,s=void 0===(s=s.endTime)?0:s,a=(e=JSON.stringify(e),new so("setAllRcvMsgOpt"));return a.setMessage(e),Ne.l("".concat(t," options:").concat(e)),this._convM.req({P:Kn.SET_ALL_RECEIVE_MSG_OPT,data:{messageRemindType:_i[n],startTime:i,endTime:s,isRepeated:o?1:0}}).then((function(e){return a.end(),Ne.l("".concat(t," ok.")),En(e)})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"_calcStartAndEndTime",value:function(e){var t=void 0===(t=e.startHour)?0:t,n=void 0===(n=e.startMinute)?0:n,o=void 0===(o=e.startSecond)?0:o,i=void 0===(i=e.duration)?0:i,s=(e=void 0===(e=e.isRepeated)||e,(r=new Date).getFullYear()),a=r.getMonth(),r=r.getDate();return{startTime:s=Math.round(new Date(s,a,r,t,n,o).getTime()/1e3),endTime:e&&86400<=i?s+86400:s+i}}},{key:"getAllRcvMsgOpt",value:function(){var e=this,t="".concat(this._n,".").concat("getAllRcvMsgOpt"),n=new so("getAllRcvMsgOpt");return this._convM.req({P:Kn.GET_ALL_RECEIVE_MSG_OPT,data:{toAccount:this._convM.getMyUserID()}}).then((function(o){return o=o.data,n.setMessage(JSON.stringify(o)).end(),Ne.l("".concat(t," ok. data:").concat(JSON.stringify(o))),En(o=e._handleResult(o))})).catch((function(e){return n.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"_handleResult",value:function(e){var t=e.messageRemindType,n=e.startTime,o=e.endTime,i=(e=e.isRepeated,D.MSG_REMIND_ACPT_AND_NOTE);return 1===t&&(i=D.MSG_REMIND_DISCARD),{messageRemindType:i=2===t?D.MSG_REMIND_ACPT_NOT_NOTE:i,startTime:n,endTime:o,isRepeated:1===e}}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset"))}}]),rs),gi=(s(as,[{key:"setConvCustomData",value:function(e){var t=this,n="".concat(this._n,".").concat("setConvCustomData"),o=e.conversationIDList,i=e.customData,s=(Ne.l("".concat(n," options:"),e),new so("setConvCustomData")),a=(s.setMessage(JSON.stringify(e)),{fromAccount:this._getMyUserID(),itemList:[]}),r=[],c=[];return o.forEach((function(e){if(!t._hasLocalConv(e))return t._onConvNotFound(c,e),!0;if(!Rt(e)&&!St(e))return t._onConvIDInvalid(c,e),!0;var n={operationType:2,contactItem:void 0,customMark:i};Rt(e)?n.contactItem={type:1,toAccount:e.replace(D.CONV_C2C,"")}:St(e)&&(n.contactItem={type:2,groupID:e.replace(D.CONV_GROUP,"")}),a.itemList.push(n)})),c.length===o.length?Dn({successConversationIDList:r,failureConversationIDList:c}):this._convM.req({P:Kn.SET_CONV_CUSTOM_DATA,data:a}).then((function(e){var o,a,u;return s.end(),Ne.l("".concat(n," ok")),Xe(e=e.data.resultItem)&&(u=!1,e.forEach((function(e){o=t._concatConvID(e.contactItem),0===e.resultCode?(r.push(o),(a=t._getLocalConv(o))&&a.customData!==i&&(a.customData=i,u=!0)):c.push({conversationID:o,code:e.resultCode,message:e.resultInfo})})),!0===u&&t._emitConvUpdate()),En({successConversationIDList:r,failureConversationIDList:c})})).catch((function(e){return s.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"markConv",value:function(e){var t=this;if(!this._convM.canIUse(U.CONV_MARK))return this._convM.noUse("markConv");var n="".concat(this._n,".").concat("markConv"),o=e.conversationIDList,i=e.markType,s=e.enableMark,a=(Ne.l("".concat(n," options:"),e),new so("markConv")),r=void a.setMessage(JSON.stringify(e)),c=void 0,u=(e=this._getFlagBit(i),!0===s?c=[e]:r=[e],{fromAccount:this._getMyUserID(),itemList:[]}),l=[],d=[];return o.forEach((function(e){if(!t._hasLocalConv(e))return t._onConvNotFound(d,e),!0;if(!Rt(e)&&!St(e))return t._onConvIDInvalid(d,e),!0;var n={operationType:1,contactItem:void 0,clearMark:r,setMark:c};Rt(e)?n.contactItem={type:1,toAccount:e.replace(D.CONV_C2C,"")}:St(e)&&(n.contactItem={type:2,groupID:e.replace(D.CONV_GROUP,"")}),u.itemList.push(n)})),d.length===o.length?Dn({successConversationIDList:l,failureConversationIDList:d}):this._convM.req({P:Kn.MARK_CONV,data:u}).then((function(e){var o,r,c;return a.end(),Ne.l("".concat(n," ok")),Xe(e=e.data.resultItem)&&(c=!1,e.forEach((function(e){var n;o=t._concatConvID(e.contactItem),0===e.resultCode?(l.push(o),(r=t._getLocalConv(o))&&(n=r.markList.indexOf(i),!0===s?-1===n&&(r.markList.push(i),c=!0):-1!==n&&(r.markList.splice(n,1),c=!0))):d.push({conversationID:o,code:e.resultCode,message:e.resultInfo})})),!0===c&&t._emitConvUpdate()),En({successConversationIDList:l,failureConversationIDList:d})})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"getLocalConvGroupList",value:function(){var e=this;return Ne.l("".concat(this._n,".getLocalConvGroupList pagingStatus:").concat(this._pagingStatus)),this._pagingStatus===Gn?this.getRemoteConvGroupList().then((function(){return En(m(e._convGroupMap.values()))})):Dn(m(this._convGroupMap.values()))}},{key:"searchConvGroupAndMark",value:function(e,t){var n=this,o="".concat(this._n,".searchConvGroupAndMark"),i=[];return e.forEach((function(e){1===t?i.push({type:1,toAccount:e}):2===t&&i.push({type:2,groupID:e})})),Ne.l("".concat(o," type:").concat(t," list:"),e),this._convM.req({P:Kn.SEARCH_CONV_GRP_MARK,data:{fromAccount:this._getMyUserID(),contactItem:i}}).then((function(e){var t=(e=e.data).contactItem;e=e.groupItem,Ne.l("".concat(o," ok. contactItem:"),t,"groupItem:",e),n._fillConvGroupMap(e),n._handleContactItem(t),n._emitConvUpdate()})).catch((function(e){Ne.w("".concat(o," failed. error:"),e)}))}},{key:"_fillConvGroupMap",value:function(e){var t=this;Xe(e)&&e.forEach((function(e){var n=e.convGroupID;e=e.groupName,t._convGroupMap.set(n,e)}))}},{key:"_handleContactItem",value:function(e){var t,n=this;Xe(e)&&e.forEach((function(e){var o=[],i=e.standardMark,s=e.customData,a=e.convGroupIDList;Xe(a)&&a.forEach((function(e){n._convGroupMap.has(e)&&o.push(n._convGroupMap.get(e))})),t=n._concatConvID(e),(t=n._getLocalConv(t))&&(t.markList=Ht(i),t.customData=s||"",t.conversationGroupList=[].concat(o))}))}},{key:"getRemoteConvGroupList",value:function(){var e=this,t="".concat(this._n,".getRemoteConvGroupList");return this._pagingStatus=Nn,this._convM.req({P:Kn.GET_CONV_GRP_LIST,data:{fromAccount:this._getMyUserID(),startIndex:this._startIndex}}).then((function(n){var o=(n=n.data).completeFlag,i=n.contactItem,s=void 0===(s=n.nextStartIndex)?0:s;if(n=n.groupItem,e._startIndex=s,Ne.l("".concat(t," completeFlag:").concat(o," nextStartIndex:").concat(s,", groupItem:"),n,"contactItem:",i),e._fillConvGroupMap(n),e._handleContactItem(i),0===o)return e.getRemoteConvGroupList();1===o&&(e._pagingStatus=Pn,e._emitConvUpdate(),e._emitConvGroupListUpdate())})).catch((function(n){e._pagingStatus=Gn,Ne.w("".concat(t," failed. error:"),n)}))}},{key:"createConvGroup",value:function(e){var t=this;if(!this._convM.canIUse(U.CONV_GROUP))return this._convM.noUse("createConvGroup");var n="".concat(this._n,".").concat("createConvGroup"),o=(Ne.l("".concat(n," options:"),e),new so("createConvGroup")),i=(o.setMessage(JSON.stringify(e)),e.groupName),s=(e=e.conversationIDList,{fromAccount:this._getMyUserID(),itemList:[{groupName:i,contactItem:[]}]}),a=[],r=[];return e.forEach((function(e){return t._hasLocalConv(e)?Rt(e)||St(e)?void(Rt(e)?s.itemList[0].contactItem.push({type:1,toAccount:e.replace(D.CONV_C2C,"")}):St(e)&&s.itemList[0].contactItem.push({type:2,groupID:e.replace(D.CONV_GROUP,"")})):(t._onConvIDInvalid(r,e),!0):(t._onConvNotFound(r,e),!0)})),r.length===e.length?Dn({successConversationIDList:a,failureConversationIDList:r}):this._convM.req({P:Kn.CREATE_CONV_GRP,data:s}).then((function(e){o.end(),Ne.l("".concat(n," ok"));var s,c,u,l=(e=e.data.groupResultItem[0]).groupItem;return e=e.resultItem,ze(l)&&(t._convGroupMap.set(l.convGroupID,l.groupName),t._emitConvGroupListUpdate()),Xe(e)&&(u=!1,e.forEach((function(e){s=t._concatConvID(e.contactItem),0===e.resultCode?(a.push(s),(c=t._getLocalConv(s))&&-1===c.conversationGroupList.indexOf(i)&&(c.conversationGroupList.push(i),u=!0)):r.push({conversationID:s,code:e.resultCode,message:e.resultInfo})})),!0===u&&(t._emitConvUpdate(),t._emitConvGroupListUpdate())),En({successConversationIDList:a,failureConversationIDList:r})})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"deleteConvGroup",value:function(e){var t=this;if(!this._convM.canIUse(U.CONV_GROUP))return this._convM.noUse("deleteConvGroup");var n="".concat(this._n,".").concat("deleteConvGroup"),o=(Ne.l("".concat(n," groupName:").concat(e)),new so("deleteConvGroup"));return o.setMessage(e),this._convM.req({P:Kn.DEL_CONV_GRP,data:{fromAccount:this._getMyUserID(),groupName:[e]}}).then((function(i){var s;o.end(),Ne.l("".concat(n," ok")),Xe(i=i.data.groupItem)&&(s=!1,i.forEach((function(e){t._convGroupMap.has(e.convGroupID)&&(t._convGroupMap.delete(e.convGroupID),s=!0)})),!0===s&&t._emitConvGroupListUpdate()),t._eraseFromConversationGroupList([e])})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"renameConvGroup",value:function(e){var t=this;if(!this._convM.canIUse(U.CONV_GROUP))return this._convM.noUse("renameConvGroup");var n="".concat(this._n,".").concat("renameConvGroup"),o=(Ne.l("".concat(n," options:"),e),new so("renameConvGroup")),i=(o.setMessage(JSON.stringify(e)),e.oldName),s=e.newName;return this._convM.req({P:Kn.RENAME_CONV_GRP,data:{fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:1,oldName:i,newName:s}}}).then((function(e){o.end(),Ne.l("".concat(n," ok")),e=e.data.updateGroupResult.convGroupID,t._convGroupMap.set(e,s),t._emitConvGroupListUpdate(),e=t._convM.getLocalConvList();var a,r,c=!1;e.forEach((function(e){a=e.conversationGroupList,-1!==(r=a.indexOf(i))&&(a.splice(r,1,s),c=!0)})),!0===c&&t._emitConvUpdate()})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"addConvsToGroup",value:function(e){var t=this;if(!this._convM.canIUse(U.CONV_GROUP))return this._convM.noUse("addConvsToGroup");var n="".concat(this._n,".").concat("addConvsToGroup"),o=(Ne.l("".concat(n," options:"),e),new so("addConvsToGroup")),i=(o.setMessage(JSON.stringify(e)),e.conversationIDList),s=e.groupName,a={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:s,updateItem:[]}},r=[],c=[];return i.forEach((function(e){return t._hasLocalConv(e)?Rt(e)||St(e)?void(Rt(e)?a.updateGroup.updateItem.push({operationType:1,contactItem:{type:1,toAccount:e.replace(D.CONV_C2C,"")}}):St(e)&&a.updateGroup.updateItem.push({operationType:1,contactItem:{type:2,groupID:e.replace(D.CONV_GROUP,"")}})):(t._onConvIDInvalid(c,e),!0):(t._onConvNotFound(c,e),!0)})),c.length===i.length?Dn({successConversationIDList:r,failureConversationIDList:c}):this._convM.req({P:Kn.ADD_CONV_TO_GRP,data:a}).then((function(e){var i,a,u;return o.end(),Ne.l("".concat(n," ok")),Xe(e=e.data.updateGroupResult.contactResultItem)&&(u=!1,e.forEach((function(e){i=t._concatConvID(e.contactItem),0===e.resultCode?(a=t._getLocalConv(i))&&-1===a.conversationGroupList.indexOf(s)&&(a.conversationGroupList.push(s),r.push(i),u=!0):c.push({conversationID:i,code:e.resultCode,message:e.resultInfo})})),!0===u&&(t._emitConvUpdate(),t._emitConvInGroupUpdate(s))),En({successConversationIDList:r,failureConversationIDList:c})})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"deleteConvsFromGroup",value:function(e){var t=this,n="deleteConvsFromGroup";if(!this._convM.canIUse(U.CONV_GROUP))return this._convM.noUse(n);var o="".concat(this._n,".").concat(n),i=(Ne.l("".concat(o," options:"),e),new so(n)),s=(i.setMessage(JSON.stringify(e)),n=e.conversationIDList,e.groupName),a={fromAccount:this._getMyUserID(),updateType:1,updateGroup:{updateGroupType:2,groupName:s,updateItem:[]}},r=[],c=[];return n.forEach((function(e){return t._hasLocalConv(e)?Rt(e)||St(e)?void(Rt(e)?a.updateGroup.updateItem.push({operationType:2,contactItem:{type:1,toAccount:e.replace(D.CONV_C2C,"")}}):St(e)&&a.updateGroup.updateItem.push({operationType:2,contactItem:{type:2,groupID:e.replace(D.CONV_GROUP,"")}})):(t._onConvIDInvalid(c,e),!0):(t._onConvNotFound(c,e),!0)})),c.length===n.length?Dn({successConversationIDList:r,failureConversationIDList:c}):this._convM.req({P:Kn.DEL_CONV_FROM_GRP,data:a}).then((function(e){var n,a,u;return i.end(),Ne.l("".concat(o," ok")),Xe(e=e.data.updateGroupResult.contactResultItem)&&(u=!1,e.forEach((function(e){var o;n=t._concatConvID(e.contactItem),0===e.resultCode?!(a=t._getLocalConv(n))||-1!==(o=a.conversationGroupList.indexOf(s))&&(a.conversationGroupList.splice(o,1),r.push(n),u=!0):c.push({conversationID:n,code:e.resultCode,message:e.resultInfo})})),!0===u&&(t._emitConvUpdate(),t._emitConvInGroupUpdate(s))),En({successConversationIDList:r,failureConversationIDList:c})})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"onConvMarkUpdated",value:function(e){var t,n,o=this;He(e)||(Ne.l("".concat(this._n,".onConvMarkUpdated markItemList:"),e),n=!1,e.forEach((function(e){var i=e.recentContactItem,s=e.optType,a=e.standardMark;e=e.customMark,t=o._concatConvID(i),(t=o._getLocalConv(t))&&(1===s?n=o._diffStandardMark(t,a):2===s?n=o._diffCustomMark(t,e):3===s&&(i=o._diffStandardMark(t,a),s=o._diffCustomMark(t,e),n=i||s))})),!0===n&&this._emitConvUpdate())}},{key:"_diffStandardMark",value:function(e,t){t=Ht(t);var n=!1;return!0!==function(e,t){if(e===t)return!0;if(!e||!t)return!1;if(e.length!==t.length)return!1;for(var n=0,o=e.length;n<o;n++)if(e[n]!==t[n])return!1;return!0}(e.markList,t)&&(e.markList=t,n=!0),n}},{key:"_diffCustomMark",value:function(e,t){var n=!1;return e.customData!==t&&void 0!==t&&(e.customData=t,n=!0),n}},{key:"onConvGroupCreated",value:function(e){var t=this,n=(Ne.l("".concat(this._n,".onConvGroupCreated resultList:"),e),!1),o=!1;Xe(e)&&(e.forEach((function(e){var i,s,a=(s=e.msgGroupItem).groupID,r=s.groupName;t._convGroupMap.get(a)!==r&&(t._convGroupMap.set(a,r),o=!0),Xe(s=e.msgRecentContactItem)&&s.forEach((function(e){i=t._concatConvID(e),(i=t._getLocalConv(i))&&-1===i.conversationGroupList.indexOf(r)&&(i.conversationGroupList.push(r),n=!0)}))})),!0===n&&this._emitConvUpdate(),!0===o&&this._emitConvGroupListUpdate())}},{key:"onConvGroupDeleted",value:function(e){var t,n=this,o=(Ne.l("".concat(this._n,".onConvGroupDeleted groupItemList:"),e),[]);Xe(e)&&(t=!1,e.forEach((function(e){var i=e.groupID;e=e.groupName,n._convGroupMap.has(i)&&(n._convGroupMap.delete(i),t=!0,o.push(e))})),!0===t&&this._emitConvGroupListUpdate()),this._eraseFromConversationGroupList(o)}},{key:"_eraseFromConversationGroupList",value:function(e){He(e)||(this._convM.getLocalConvList().forEach((function(t){t.conversationGroupList=t.conversationGroupList.filter((function(t){return!e.includes(t)}))})),this._emitConvUpdate())}},{key:"onConvGroupNameUpdated",value:function(e){Ne.l("".concat(this._n,".onConvGroupNameUpdated options:"),e);var t,n,o,i=e.groupID,s=e.groupName,a=e.oldGroupName;this._convGroupMap.get(i)!==s&&(this._convGroupMap.set(i,s),this._emitConvGroupListUpdate(),e=this._convM.getLocalConvList(),o=!1,e.forEach((function(e){t=e.conversationGroupList,-1!==(n=t.indexOf(a))&&(t.splice(n,1,s),o=!0)})),!0===o&&this._emitConvUpdate())}},{key:"onConvInGroupUpdated",value:function(e){var t,n,o,i=this,s=(Ne.l("".concat(this._n,".onConvInGroupUpdated options:"),e),e.oldGroupName);Xe(e=e.recentContactUpdateGroupItem)&&(o=!1,e.forEach((function(e){var a=e.contactOptType;e=e.recentContactItem,t=i._concatConvID(e),(t=i._getLocalConv(t))&&(n=t.conversationGroupList.indexOf(s),1===a?-1===n&&(t.conversationGroupList.push(s),o=!0):2===a&&-1!==n&&(t.conversationGroupList.splice(n,1),o=!0))})),!0===o&&(this._emitConvUpdate(),this._emitConvInGroupUpdate(s)))}},{key:"onConvAddedToOrDeletedFromGroup",value:function(e){var t,n,o=this,i=(Ne.l("".concat(this._n,".onConvAddedToOrDeletedFromGroup options:"),e),e.msgRecentContactItem),s=(e=e.msgRecentContactUpdateContactItem,i=this._concatConvID(i),this._getLocalConv(i));s&&Xe(e)&&(n=!1,e.forEach((function(e){var i=e.groupOptType;e=e.recentContactGroupItem.groupName,t=s.conversationGroupList.indexOf(e),1===i?-1===t&&(s.conversationGroupList.push(e),n=!0):2===i&&-1!==t&&(s.conversationGroupList.splice(t,1),n=!0),!0===n&&o._emitConvInGroupUpdate(e)})),!0===n&&this._emitConvUpdate())}},{key:"onConvGroupListSynced",value:function(e){Xe(e)&&0!==e.length&&(Ne.l("".concat(this._n,".onConvGroupListSynced groupItem:"),e),this._fillConvGroupMap(e))}},{key:"getConvGroupListByID",value:function(e){var t,n=this;if(!He(e))return t=[],e.forEach((function(e){n._convGroupMap.has(e)&&t.push(n._convGroupMap.get(e))})),t}},{key:"_onConvNotFound",value:function(e,t){e.push({conversationID:t,code:Bn.CONV_NOT_FOUND,message:this._convM.getErrMsg(Bn.CONV_NOT_FOUND)})}},{key:"_onConvIDInvalid",value:function(e,t){e.push({conversationID:t,code:Bn.INVALID_CONV_ID,message:this._convM.getErrMsg(Bn.INVALID_CONV_ID)})}},{key:"_getFlagBit",value:function(e){for(var t=e.toString(2),n=t.length,o=n-1;0<=o;o--)if("1"===t[o])return n-o-1}},{key:"_concatConvID",value:function(e){var t,n=e.type,o=e.to,i=e.groupID;return e=e.userID,1===n?pt(e)?pt(o)||(t="".concat(D.CONV_C2C).concat(o)):t="".concat(D.CONV_C2C).concat(e):2===n&&(t="".concat(D.CONV_GROUP).concat(i)),t}},{key:"_getMyUserID",value:function(){return this._convM.getMyUserID()}},{key:"_getLocalConv",value:function(e){return this._convM.getLocalConversation(e)}},{key:"_hasLocalConv",value:function(e){return this._convM.hasLocalConversation(e)}},{key:"_emitConvUpdate",value:function(){this._convM.emitConvUpdate(!0,!1)}},{key:"_emitConvGroupListUpdate",value:function(){this._convM.emitOEvt(E.CONVERSATION_GROUP_LIST_UPDATED,m(this._convGroupMap.values()))}},{key:"_emitConvInGroupUpdate",value:function(e){var t={groupName:e,conversationList:[]},n=this._convM.getLocalConvList();t.conversationList=n.filter((function(t){return t.conversationGroupList.includes(e)})),this._convM.emitOEvt(E.CONVERSATION_IN_GROUP_UPDATED,t)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._convGroupMap.clear(),this._startIndex=0,this._pagingStatus=On}}]),as),fi=(r(ss,bn),si=g(ss),s(ss,[{key:"_initListeners",value:function(){var e=this.getIEmitInst();e.on(jo.A2KEY_AND_TINYID_UPDATED,this._init,this),e.on(jo.PROFILE_UPDATED,this._onProfileUpdated,this),e.on(jo.CLOUD_CONFIG,this._onCloudConfig,this)}},{key:"_init",value:function(){var e=this,t=(Ne.l("".concat(this._n,"._init")),this.get(13).getItem("conversationMap")),n=this.isIntl(),o=this.isUsingChatCore();if(t){for(var i=t.length,s=0;s<i;s++){var a=t[s];if(a){if(this._isNonExistentAccount(a.conversationID))continue;if(a.groupProfile&&Tt(a.groupProfile.type))continue}this._convMap.set(a.conversationID,new pi(t[s],n,o))}this.emitConvUpdate(!0,!1)}this.ready((function(){0<e._tmpGroupList.length&&(e.updateConvGroupProfile(e._tmpGroupList),e._tmpGroupList.length=0)})),this.syncConvList()}},{key:"_isNonExistentAccount",value:function(e){var t;return"@TLS#ERROR"===(t=e.startsWith(D.CONV_C2C)?e.replace(D.CONV_C2C,""):t)||"@TLS#NOT_FOUND"===t}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&this._msgListHandler.onCheckTimer(e)}},{key:"onMessageSent",value:function(e){this._onSendOrRcvMsg({conversationOptionsList:e.conversationOptionsList,isInstantMessage:!0})}},{key:"onNewMessage",value:function(e){this._onSendOrRcvMsg(e)}},{key:"_onSendOrRcvMsg",value:function(e){var t=this,n=e.conversationOptionsList,o=void 0===(o=e.isInstantMessage)||o,i=void 0!==(i=e.isUnreadC2CMessage)&&i,s=void 0===(s=e.updateUnreadCount)||s,a=void 0!==(a=e.isSyncingEnded)&&a;this._isReady?0!==n.length?(!0===o&&this._checkNewConv(n),this._updateLocalConvList({conversationOptionsList:n,isInstantMessage:o,isUnreadC2CMessage:i,isFromGetConversations:!1,updateUnreadCount:s}),o||(this._convIDFromUnreadDBMap=new Map([].concat(m(this._convIDFromUnreadDBMap),m(n.map((function(e){return[e.conversationID,1]}))))),this._diffAndDeleteConv(),a&&this.emitIEvt(jo.C2C_UNREAD_HANDLE_COMPLETED)),0<n.filter((function(e){return!t._isConvNeedShow(e.conversationID)})).length||this.emitConvUpdate()):a&&this.emitIEvt(jo.C2C_UNREAD_HANDLE_COMPLETED):this.ready((function(){t._onSendOrRcvMsg(e)}))}},{key:"updateConvGroupProfile",value:function(e){var t,n=this;Xe(e)&&0===e.length||(0!==this._convMap.size?(t=!1,e.forEach((function(e){var o="".concat(D.CONV_GROUP).concat(e.groupID);n._convMap.has(o)&&(t=!0,(o=n._convMap.get(o)).groupProfile=JSON.parse(JSON.stringify(e)),o.lastMessage.lastSequence<e.nextMessageSeq&&(o.lastMessage.lastSequence=e.nextMessageSeq-1),o.subType||(o.subType=e.type))})),t&&this.emitConvUpdate(!0,!1)):this._tmpGroupList=e)}},{key:"onMessageRevoked",value:function(e,t){var n,o,i,s=this;0!==e.length&&(n=null,o=!1,i=[],e.forEach((function(e){(n=s._convMap.get(e.conversationID))&&(t&&n.reduceUnreadCount()&&(o=n.type!==D.CONV_TOPIC),n.type===D.CONV_TOPIC?i.push(e):n.isLastMessageRevoked({sequence:e.sequence,time:e.time})&&(n.setLastMessageRevoked(!0),n.setLastMessageRevoker(e.revoker),o=!0))})),this.get(10).onMessageRevoked(i),o&&this.emitConvUpdate(!0,!1))}},{key:"updateRevokerInfo",value:function(e){for(var t=new Set,n=0;n<e.length;n++){var o=e[n].revoker;t.add(o)}var i=m(t),s=this.get(4);return new Promise((function(t){s.getUserProfile({userIDList:i}).then((function(n){if(!Xe(n=n.data)||0===n.length)return t(e);var o,i={},s=T(n);try{for(s.s();!(o=s.n()).done;){var a=o.value,r=a.userID,c=a.nick,u=a.avatar;i[r]={nick:c,avatar:u}}}catch(n){s.e(n)}finally{s.f()}e.forEach((function(e){var t=e.revoker;i[t]&&(e.revokerInfo.nick=i[t].nick||"",e.revokerInfo.avatar=i[t].avatar||"")})),t(e)})).catch((function(){t(e)}))}))}},{key:"isLastMessageRevoked",value:function(e){var t=!1,n=e.conversationID,o=e.sequence,i=e.time,s=this._convMap.get(n);return s&&(t=s.type===D.CONV_TOPIC?this.get(10).isLastMessageRevoked({topicID:n.replace(D.CONV_GROUP,""),sequence:o}):s.isLastMessageRevoked({sequence:o,time:i})),Ne.l("".concat(this._n,".isLastMessageRevoked options:"),e,"ret:".concat(t)),t}},{key:"onMessageDeleted",value:function(e){var t=this;if(0!==e.length){var n=null;e.forEach((function(e){(n=t._msgListHandler.getLocalMsg(e.conversationID,e.ID))&&(n.isDeleted=!0),e!==n&&(e.isDeleted=!0)})),e=e[0].conversationID;for(var o=this._msgListHandler.getLocalMsgList(e),i={},s=o.length-1;0<=s;s--)if(!o[s].isDeleted){i=o[s];break}var a,r=this._convMap.get(e);r&&(a=!1,r.lastMessage.lastSequence===i.sequence&&r.lastMessage.lastTime===i.time||(He(i)&&(i=void 0),r.updateLastMessage(i),r.type!==D.CONV_TOPIC&&(a=!0),Ne.l("".concat(this._n,".onMessageDeleted. update convID:").concat(e," with lastMessage:"),r.lastMessage)),e.startsWith(D.CONV_C2C)&&this.updateUnreadCount(e),a&&this.emitConvUpdate(!0,!1))}}},{key:"onMessageModified",value:function(e){var t="".concat(this._n,".onMessageModified"),n=e.conversationType,o=e.from,i=e.to,s=e.time,a=e.sequence,r=e.elements,c=e.cloudCustomData,u=e.messageVersion,l=this.getMyUserID(),d="".concat(n).concat(i),p=(n=(i===l&&n===D.CONV_C2C&&(d="".concat(n).concat(o)),l=this._msgListHandler.onMsgModified(d,e)).isUpdated,l=l.message,!0===n&&this.emitOEvt(E.MESSAGE_MODIFIED,[l]),this._isTopicConv(d));return null===l?Ne.l("".concat(t," message is null! options:"),e):Ne.l("".concat(t," isUpdated:").concat(n," isTopicMessage:").concat(p," from:").concat(o," to:").concat(i," sequence:").concat(l.sequence," time:").concat(l.time)),p?this.get(10).onMessageModified(e):!(n=this._convMap.get(d))||(o=n.lastMessage)&&o.lastTime===s&&o.lastSequence===a&&o.version!==u&&(Ne.l("".concat(t," convID:").concat(d," lastMessage updated")),o.type=r[0].type,o.payload=r[0].content,o.messageForShow=Vt(o.type,o.payload,this.isIntl()),o.cloudCustomData=c,o.version=u,this.emitConvUpdate(!0,!1)),l}},{key:"onNewGroupAtTips",value:function(e){var n=this,o=(e=e.dataList,null);e.forEach((function(e){e.groupAtTips?o=e.groupAtTips:e.elements?o=t(t({},e.elements),{},{sync:!0}):e.groupAtType&&(o=t(t({},e),{},{sync:!0})),o.__random=e.random,o.__sequence=e.clientSequence,n._tmpGroupAtTipsList.push(o)})),Ne.l("".concat(this._n,".onNewGroupAtTips isReady:").concat(this._isReady),this._tmpGroupAtTipsList),this._isReady&&this._handleGroupAtTipsList()}},{key:"_handleGroupAtTipsList",value:function(){var e,t=this;0!==this._tmpGroupAtTipsList.length&&(e=!1,this._tmpGroupAtTipsList.forEach((function(n){var o=n.groupID,i=n.from,s=void 0===(s=n.topicID)?void 0:s,a=void 0!==(a=n.sync)&&a;i!==t.getMyUserID()&&(pt(s)?(i=t._convMap.get("".concat(D.CONV_GROUP).concat(o)))&&(i.updateGroupAtInfoList(n),e=!0):((o=t._convMap.get("".concat(D.CONV_GROUP).concat(s)))&&(o.updateGroupAtInfoList(n),t.get(10).onAtInfoUpdated({topicID:s,groupAtInfoList:o.groupAtInfoList})),He(o)&&a&&(t.updateTopicConversation([{conversationID:"".concat(D.CONV_GROUP).concat(s),type:D.CONV_TOPIC}]),t._convMap.get("".concat(D.CONV_GROUP).concat(s)).updateGroupAtInfoList(n))))})),e&&this.emitConvUpdate(!0,!1),this._tmpGroupAtTipsList.length=0)}},{key:"_checkNewConv",value:function(e){var t=this,n=[],o=[];e.forEach((function(e){t._convMap.has(e.conversationID)||(e.type===D.CONV_C2C?n.push(e.conversationID.replace(D.CONV_C2C,"")):e.type===D.CONV_GROUP&&o.push(e.conversationID.replace(D.CONV_GROUP,"")))})),0<n.length&&(this._onNewC2CConv(n),n=null),0<o.length&&(this._onNewGroupConv(o),o=null)}},{key:"_onNewC2CConv",value:function(e){var t=this.get(6);return Promise.all([t.getRemotePeerReadTime(e),this._msgRemindHandler.getC2CMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,1)])}},{key:"_onNewGroupConv",value:function(e){var t=this.get(7);return t?Promise.all([t.getMsgRemindType(e),this._convGroupHandler.searchConvGroupAndMark(e,2)]):Promise.resolve()}},{key:"_setStorageConvList",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.getLocalConvList().filter((function(e){return e.type===D.CONV_C2C||e.type===D.CONV_GROUP&&e.lastMessage.type!==D.MSG_GRP_TIP})).slice(0,20).map((function(e){return{conversationID:e.conversationID,type:e.type,subType:e.subType,lastMessage:e.lastMessage,groupProfile:e.groupProfile,userProfile:e.userProfile}}));this.get(13).setItem("conversationMap",t,e)}},{key:"emitConvUpdate",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this.getLocalConvList();!t||(t=this.get(7))&&t.updateGroupLastMessage(n),e&&(this.get(12).isPartialUpdatedConvs()?(this._diffConvMap(this._convMapForDiff,this._convMap),0<this._partialUpdatedConvMap.size&&(this.emitOEvt(E.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate(),this._convMapForDiff.clear(),this._convMapForDiff=ot(this._convMap,!0)),0===this._convMapForDiff.size&&(this._convMapForDiff=ot(this._convMap,!0))):(this.emitOEvt(E.CONVERSATION_LIST_UPDATED),this.onTotalUnreadCountUpdate()))}},{key:"_diffConvMap",value:function(e,t){var n,o=T(t);try{for(o.s();!(n=o.n()).done;){var i=f(n.value,2),s=i[0],a=i[1];e.has(s)&&JSON.stringify(a)===e.get(s)||this._partialUpdatedConvMap.set(s,a)}}catch(e){o.e(e)}finally{o.f()}}},{key:"getPartialUpdatedConvs",value:function(){var e=m(ot(this._partialUpdatedConvMap,!1).values());return this._partialUpdatedConvMap.clear(),e}},{key:"getLocalConvList",value:function(){var e=this;return m(this._convMap.values()).filter((function(t){return e._isConvNeedShow(t.conversationID)}))}},{key:"getLocalConversation",value:function(e){return this._convMap.get(e)}},{key:"hasLocalConversation",value:function(e){return this._convMap.has(e)}},{key:"getLocalOldestMessage",value:function(e){return this._msgListHandler.getLocalOldestMsg(e)}},{key:"syncConvList",value:function(){var e=this,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n="syncConvList",o=new so(n);return this._pagingStatus===On&&this._convMap.clear(),this._pagingGetConvList(t).then((function(t){var i=jt(e._pagingGetCostList),s=Yt(e._pagingGetCostList);return e._pagingGetCostList.length=0,e._pagingStatus=Pn,e._diffAndDeleteConv(),e.emitConvUpdate(!0,!1),e._setStorageConvList(),e._handleC2CPeerReadTime(),e.emitIEvt(jo.CONV_SYNC_COMPLETED),s="count:".concat(e._convMap.size," sum:").concat(s," avg:").concat(i),Ne.l("".concat(e._n,".").concat(n,". ").concat(s)),o.setMessage(s).end(),t})).catch((function(t){return e._pagingStatus=Gn,o.setMessage(e._pagingTs).setError(t).end(),Rn(t)}))}},{key:"_diffAndDeleteConv",value:function(){var e,t=this;this._isSyncCompleted()&&(e=[],this._convMap.forEach((function(n,o){!t._pagingConvIDMap.has(o)&&t._convIDFromUnreadDBMap.has(o)&&(t._convMap.delete(o),e.push(o))})),Ne.l("".concat(this._n,"._diffAndDeleteConv list:").concat(e)),e=null)}},{key:"_pagingGetConvList",value:function(){var e=this,t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n="".concat(this._n,"._pagingGetConvList"),o=(Ne.l("".concat(n," incrementalPullFlag:").concat(t," ts:").concat(this._pagingTs," startIdx:").concat(this._pagingStartIdx)+" pinnedTs:".concat(this._pagingPinnedTs," pinnedStartIdx:").concat(this._pagingPinnedStartIdx)),Date.now());return this._pagingStatus=Nn,this.req({P:Kn.PAGING_GET_CONV_LIST,data:{fromAccount:this.getMyUserID(),timeStamp:t?this._pagingTs:0,startIndex:t?this._pagingStartIdx:0,pinnedTimeStamp:t?this._pagingPinnedTs:0,pinnedStartIndex:t?this._pagingPinnedStartIdx:0,orderType:1}}).then((function(t){var i=(t=t.data).completeFlag,s=void 0===(s=t.conversations)?[]:s,a=t.timeStamp,r=t.startIndex,c=t.pinnedTimeStamp,u=t.pinnedStartIndex;if(t=t.groupItem,e._pagingGetCostList.push(Jt(o,!1)),Ne.l("".concat(n," ok. completeFlag:").concat(i," count:").concat(s.length," cost:").concat(Jt(o))),e._convGroupHandler.onConvGroupListSynced(t),0<s.length&&(t=e._getConvOptions(s),e._pagingConvIDMap=new Map([].concat(m(e._pagingConvIDMap),m(t.map((function(e){return[e.conversationID,1]}))))),e._updateLocalConvList({conversationOptionsList:t,isFromGetConversations:!0,updateUnreadCount:!0}),e.isLoggedIn()&&e.emitConvUpdate()),!e._isReady){if(!e.isLoggedIn())return Dn();e.triggerReady()}return e._pagingTs=a,e._pagingStartIdx=r,e._pagingPinnedTs=c,e._pagingPinnedStartIdx=u,1!==i?e._pagingGetConvList():(e._handleGroupAtTipsList(),e._convGroupHandler.getRemoteConvGroupList(),Dn())})).catch((function(t){throw e.isLoggedIn()&&(e._isReady||(Ne.w("".concat(n," failed. error:"),t),e.triggerReady())),t}))}},{key:"_updateLocalConvList",value:function(e){var t=e.isFromGetConversations,n=Date.now();e=this._getTmpConvListMapping(e).newConvList,this._convMap=new Map(this._sortConvList(m(this._convMap))),t||this._updateUserOrGroupProfile(e),Ne.l("".concat(this._n,"._updateLocalConvList cost:").concat(Jt(n)))}},{key:"_getTmpConvListMapping",value:function(e){for(var t=e.conversationOptionsList,n=e.isFromGetConversations,o=e.isInstantMessage,i=e.isUnreadC2CMessage,s=void 0!==i&&i,a=e.updateUnreadCount,r=[],c=[],u=this.get(7),l=this.get(8),d=this.isIntl(),p=this.isUsingChatCore(),_=0,h=t.length;_<h;_++){var g=new pi(t[_],d,p),f=g.conversationID,m=g.type;if(!this._isNonExistentAccount(f)){if(this._convMap.has(f)){var v=this._convMap.get(f);if(n&&m!==D.CONV_TOPIC){this._convMap.set(f,g),m===D.CONV_C2C?g.unreadCount=v.unreadCount:m===D.CONV_GROUP&&(g.groupProfile=JSON.parse(JSON.stringify(v.groupProfile)));continue}var I=["unreadCount","allowType","adminForbidType","payload"],y=(!1===o&&I.push("lastMessage"),"boolean"==typeof o&&I.push("isPinned"),t[_].lastMessage),M=!pt(y);M||t[_].type===D.CONV_TOPIC||this._onLastMsgNotExist(t[_]),pt(o)&&M&&null===v.lastMessage.payload&&(v.lastMessage.payload=y.payload),He(v.lastMessage.revoker)||(v.lastMessage.revoker=null),nt(v,g,I,[null,void 0,"",0,NaN]),!0===a&&v.updateUnreadCount({nextUnreadCount:g.unreadCount,isFromGetConversations:n,isUnreadC2CMessage:s}),o&&M&&(y.payload&&(v.lastMessage.payload=y.payload),v.type===D.CONV_GROUP&&(v.lastMessage.nameCard=y.nameCard,v.lastMessage.nick=y.nick)),M&&v.lastMessage.cloudCustomData!==y.cloudCustomData&&(v.lastMessage.cloudCustomData=y.cloudCustomData||"")}else m===D.CONV_GROUP&&u?(I=g.groupProfile.groupID,(M=u.getLocalGroupProfile(I))&&(g.groupProfile=M,!0===a&&g.updateUnreadCount({nextUnreadCount:0}))):m===D.CONV_C2C&&(v=f.replace(D.CONV_C2C,""),l&&l.isMyFriend(v)&&(g.remark=l.getFriendRemark(v))),r.push(g),this._convMap.set(f,g);this._convMap.get(f).type===D.CONV_TOPIC&&c.push(this._convMap.get(f))}}for(var C=this.get(10),T=0,E=c.length;T<E;T++){var R,S=(R=c[T]).conversationID;He(R=R.groupAtInfoList)||C.onAtInfoUpdated({topicID:S.replace(D.CONV_GROUP,""),groupAtInfoList:R})}return{newConvList:r}}},{key:"_onLastMsgNotExist",value:function(e){new so("lastMsgNotExist").setMessage(JSON.stringify(e)).end()}},{key:"_sortConvList",value:function(e){var t=[],n=[],o=[],i=[];return e.forEach((function(e){(!0===e[1].isPinned?He(e[1].lastMessage.lastTime)?n:t:He(e[1].lastMessage.lastTime)?i:o).push(e)})),t.sort((function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime})).concat(n).concat(o.sort((function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime}))).concat(i)}},{key:"_sortConvListAndEmitEvent",value:function(){this._convMap=new Map(this._sortConvList(m(this._convMap))),this.emitConvUpdate(!0,!1)}},{key:"_updateUserOrGroupProfile",value:function(e){var t,n,o,i,s=this;0!==e.length&&(t=[],n=[],o=this.get(4),i=this.get(7),e.forEach((function(e){var o;e.type===D.CONV_C2C?t.push(e.toAccount):e.type===D.CONV_GROUP&&(o=e.toAccount,i.hasLocalGroup(o)?e.groupProfile=i.getLocalGroupProfile(o):n.push(o))})),Ne.l("".concat(this._n,"._updateUserOrGroupProfile userIDList:").concat(t," groupIDList:").concat(n)),0<t.length&&o.getUserProfile({userIDList:t}).then((function(e){Xe(e=e.data)?e.forEach((function(e){s._doUpdateUserProfile("".concat(D.CONV_C2C).concat(e.userID),e)})):s._doUpdateUserProfile("".concat(D.CONV_C2C).concat(e.userID),e)})),0<n.length&&i.getGroupProfileAdvance({groupIDList:n,responseFilter:{groupBaseInfoFilter:["Type","Name","FaceUrl"]}}).then((function(e){e=e.data.successGroupList;var t=!1;e.forEach((function(e){var n="".concat(D.CONV_GROUP).concat(e.groupID);s._convMap.has(n)&&(nt((n=s._convMap.get(n)).groupProfile,e,[],[null,void 0,"",0,NaN]),!n.subType&&e.type&&(n.subType=e.type),t=!0)})),t&&s.emitConvUpdate()})))}},{key:"_doUpdateUserProfile",value:function(e,t){this.hasLocalConversation(e)&&(this.getLocalConversation(e).userProfile=t,this.emitConvUpdate())}},{key:"_getConvOptions",value:function(e){var n=this,o=[],i=(e=e.filter((function(e){var t=e.type;return e=e.userID,1===t&&!n._isNonExistentAccount(e)||2===t})),this.getMyUserID());return e=e.map((function(e){var s;return pt(e.lastMsg)&&(e.lastMsg={elements:[]}),1===e.type?(s={userID:e.userID,nick:e.peerNick,avatar:e.peerAvatar},o.push(s),{conversationID:"".concat(D.CONV_C2C).concat(e.userID),type:D.CONV_C2C,lastMessage:{lastTime:e.time,lastSequence:e.sequence,fromAccount:e.lastC2CMsgFromAccount,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:null,payload:e.lastMsg.elements[0]?n._amendLayersOverLimitProp(e.lastMsg.elements[0].content):null,cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:8===e.lastMessageFlag,onlineOnlyFlag:!1,nick:"",nameCard:"",version:0,isPeerRead:e.lastC2CMsgFromAccount===i&&e.time<=e.c2cPeerReadTime,revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null},unreadCount:0,userProfile:new ci(s),peerReadTime:e.c2cPeerReadTime,isPinned:1===e.isPinned,customData:e.customMark||"",markList:Ht(e.standardMark),conversationGroupList:n._convGroupHandler.getConvGroupListByID(e.contactGroupId),remark:e.friendRemark||"",messageRemindType:n._transMsgRemindType(e.messageRemindType)}):{conversationID:"".concat(D.CONV_GROUP).concat(e.groupID),type:D.CONV_GROUP,lastMessage:t(t({lastTime:e.time,lastSequence:e.sequence,fromAccount:e.msgGroupFromAccount},n._patchTypeAndPayload(e)),{},{cloudCustomData:e.lastMsg.cloudCustomData||"",isRevoked:2===e.lastMessageFlag,onlineOnlyFlag:!1,nick:e.senderNick||"",nameCard:e.senderNameCard||"",revoker:e.lastMsg.revokerInfo?e.lastMsg.revokerInfo.revoker:null}),groupProfile:new di({groupID:e.groupID,name:e.groupNick,avatar:e.groupImage,type:e.groupType,nextMessageSeq:e.nextMessageSeq}),unreadCount:n._computeGroupUnreadCount(e),peerReadTime:0,isPinned:1===e.isPinned,version:0,customData:e.customMark||"",markList:Ht(e.standardMark),conversationGroupList:n._convGroupHandler.getConvGroupListByID(e.contactGroupId),messageRemindType:n._transMsgRemindType(e.messageRemindType)}})),0<o.length&&this.get(4).onConvProfileUpdated(o),e}},{key:"_transMsgRemindType",value:function(e){var t="";return 0===e?t=D.MSG_REMIND_ACPT_AND_NOTE:1===e?t=D.MSG_REMIND_DISCARD:2===e?t=D.MSG_REMIND_ACPT_NOT_NOTE:3===e&&(t=D.NOT_RECEIVE_OFFLINE_PUSH_EXCEPT_AT),t}},{key:"_computeGroupUnreadCount",value:function(e){var t;return 0<(t=(void 0===(t=e.unreadCount)?0:t)-(void 0===(e=e.noUnreadCount)?0:e))?t:0}},{key:"_patchTypeAndPayload",value:function(e){var n=(e=e.lastMsg).event,o=void 0===(o=e.elements)?[]:o;return e=void 0===(e=e.groupTips)?{}:e,pt(void 0===n?void 0:n)||He(e)?{type:o[0]?o[0].type:null,payload:o[0]?this._amendLayersOverLimitProp(o[0].content):null}:((n=new ko(e)).setElement({type:D.MSG_GRP_TIP,content:t(t({},e.elements),{},{groupProfile:e.groupProfile})}),o=JSON.parse(JSON.stringify(n.payload)),n=null,{type:D.MSG_GRP_TIP,payload:o})}},{key:"_amendLayersOverLimitProp",value:function(e){var t=e.layersOverLimit;return 0===t?e.layersOverLimit=!1:1===t&&(e.layersOverLimit=!0),e}},{key:"getLocalMessageList",value:function(e){return this._msgListHandler.getLocalMsgList(e)}},{key:"deleteLocalMessage",value:function(e){e instanceof ko&&this._msgListHandler.remove(e)}},{key:"onConvDeleted",value:function(e){Xe(e)&&(e=e.map((function(e){var t=e.type,n=e.userID;return e=e.groupID,1===t?"".concat(D.CONV_C2C).concat(n):2===t?"".concat(D.CONV_GROUP).concat(e):void 0})),Ne.l("".concat(this._n,".onConvDeleted convIDList:").concat(e)),this.deleteLocalConvList(e))}},{key:"onConvPinnedStatus",value:function(e,t){var n,o=this;Xe(e)&&(n=!1,e.forEach((function(e){var i,s=e.type,a=e.userID;e=e.groupID,1===s?i=o.getLocalConversation("".concat(D.CONV_C2C).concat(a)):2===s&&(i=o.getLocalConversation("".concat(D.CONV_GROUP).concat(e))),i&&(Ne.l("".concat(o._n,".onConvPinnedStatus convID:").concat(i.conversationID," localPinned:").concat(i.isPinned," remotePinned:").concat(t)),t?i.isPinned||(i.isPinned=!0,n=!0):i.isPinned&&(i.isPinned=!1,n=!0))})),n&&this._sortConvListAndEmitEvent())}},{key:"getMessageList",value:function(e){var t=this,n=e.conversationID,o=e.nextReqMessageID,i=(e=e.count,"".concat(this._n,".getMessageList")),s="";if((r=this.getLocalConversation(n))&&r.groupProfile&&(s=r.groupProfile.type),Tt(s))return Ne.l("".concat(i," not available in ").concat(s,". convID:").concat(n)),Dn({messageList:[],nextReqMessageID:"",isCompleted:!0});(pt(e)||15<e)&&(e=15),o||this._isMeInCommunity(n)||this.clearMemMsg(n);var a=this._computeRemainingCount({conversationID:n,nextReqMessageID:o}),r=this._completedMap.has(n);return Ne.l("".concat(i," convID:").concat(n," isEverCleared:").concat(this._isEverCleared(n)," nextReqMessageID:").concat(o)+" remainingCount:".concat(a," count:").concat(e," isCompleted:").concat(r)),this._needGetHistory({conversationID:n,remainingCount:a,count:e})?this.getHistoryMessages({conversationID:n,nextReqMessageID:o,count:20}).then((function(e){var o=e.nextReqID,s=e.storedMessageList,r=e.assembledMessageList,c=(e=e.isPullingCompleted,t._completedMap.has(n)),u=s,l=(0<a&&(u=t._msgListHandler.getLocalMsgList(n).slice(0,s.length+a)),{nextReqMessageID:void 0,messageList:void 0,isCompleted:void 0});return t._isEverCleared(n)?(l.nextReqMessageID=o,l.messageList=r,l.isCompleted=e):(l.nextReqMessageID=c?"":o,l.messageList=u,l.isCompleted=c),s=l.messageList.filter((function(e){return e.isRevoked}))||[],r=l.messageList.map((function(e){return e.sequence})),Ne.l("".concat(i," ret.nextReqMessageID:").concat(l.nextReqMessageID," ret.isCompleted:").concat(l.isCompleted," sequenceList:"),r),Xe(s)&&0!==s.length?t.updateRevokerInfo(s).then((function(e){return e.forEach((function(e){var t=e.revokerInfo;l.messageList=l.messageList.map((function(n){return n.ID===e.ID&&t&&(n.revokeReason=t.reason||"",n.revokerInfo={userID:t.revoker||n.revoker,nick:t.nick,avatar:t.avatar}),n}))})),En(l)})):En(l)})):(this.modifyMessageList(n),Dn(s=this._getMsgListFromMem({conversationID:n,nextReqMessageID:o,count:e})))}},{key:"_isEverCleared",value:function(e){return this._everClearedMap.has(e)}},{key:"_getMsgListFromMem",value:function(e){var t=e.conversationID,n=e.nextReqMessageID,o=(e=e.count,"".concat(this._n,"._getMsgListFromMem")),i=this._msgListHandler.getLocalMsgList(t),s=i.length,a=Rt(t),r=0,c={isCompleted:!1,nextReqMessageID:"",messageList:[]};return n?(r=a?i.findIndex((function(e){return e.ID===n})):i.findIndex((function(e){return e.sequence+""===n})))>e?(c.messageList=i.slice(r-e,r),c.nextReqMessageID=a?i[r-e].ID:i[r-e].sequence+""):(c.messageList=i.slice(0,r),c.isCompleted=!0):e<s?(c.messageList=i.slice(r=s-e,s),c.nextReqMessageID=a?i[r].ID:i[r].sequence+""):(c.messageList=i.slice(0,s),c.isCompleted=!0),e=c.messageList.map((function(e){return e.sequence})),Ne.l("".concat(o," convID:").concat(t)+" ret.nextReqMessageID:".concat(c.nextReqMessageID," ret.isCompleted:").concat(c.isCompleted," sequenceList:").concat(e)),c}},{key:"getMessageListHopping",value:function(e){var t,n,o=e.conversationID,i=e.sequence,s=e.time,a=e.count;return e=void 0===(e=e.direction)?0:e,(pt(a)||15<a)&&(a=15),o.startsWith(D.CONV_C2C)?(t=this.get(6),n=o.replace(D.CONV_C2C,""),t.getRoamingMessagesHopping({peerAccount:n,time:s,count:a,direction:e})):o.startsWith(D.CONV_GROUP)?(t=this.get(7),n=o.replace(D.CONV_GROUP,""),t.getRoamingMessagesHopping({groupID:n,sequence:i,count:a,direction:e})):void 0}},{key:"_computeRemainingCount",value:function(e){var t=e.conversationID,n=e.nextReqMessageID,o=(e=this._msgListHandler.getLocalMsgList(t)).length;return Ne.l("".concat(this._n,"._computeRemainingCount convID:").concat(t," nextReqMessageID:").concat(n," length:").concat(o)),n?(o=0,Rt(t)?o=e.findIndex((function(e){return e.ID===n})):St(t)&&(o=-1!==n.indexOf("-")?e.findIndex((function(e){return e.ID===n})):e.findIndex((function(e){return e.sequence+""===n}))),-1===o?0:o):o}},{key:"_needGetHistory",value:function(e){var t=e.conversationID,n=e.remainingCount,o=(e=e.count,this.getLocalConversation(t)),i="";return o&&o.groupProfile&&(i=o.groupProfile.type),!Lt(t)&&!Tt(i)&&(!!this._isEverCleared(t)||(o=n<=e&&!this._completedMap.has(t),Ne.l("".concat(this._n,"._needGetHistory convID:").concat(t," ret:").concat(o)),o))}},{key:"_isTopicConv",value:function(e){return Dt(e=e.replace(D.CONV_GROUP,""))}},{key:"getHistoryMessages",value:function(e){var t=e.conversationID,n=e.count;if(e=e.nextReqMessageID,t===D.CONV_SYSTEM)return Dn();var o,i,s=15;if(20<n&&(s=20),n=null,Rt(t))return c=0,o="",i=!1,r=this._roamingMsgKeyAndTimeMap.has(t),e&&(i=!0,r?(c=this._roamingMsgKeyAndTimeMap.get(t).lastMessageTime,o=this._roamingMsgKeyAndTimeMap.get(t).messageKey):(a=this._msgListHandler.findMessage(e))&&(c=a.time,Ne.l("".concat(this._n,".getHistoryMessages convID:").concat(t," isRelayInfoExisted:").concat(r," lastMessageTime:").concat(c)))),(n=this.get(6)).getRoamingMessage({conversationID:t,peerAccount:t.replace(D.CONV_C2C,""),count:s,lastMessageTime:i?c:0,messageKey:i?o:""});if(St(t)){if(!(n=this.get(7)))return Rn({code:Bn.NO_MODULE});var a=t.replace(D.CONV_GROUP,""),r=null,c=(this._convMap.has(t)&&!Dt(a)&&(r=this._convMap.get(t).lastMessage),0);return e?c=Number(e):r&&(c=r.lastSequence),n.getRoamingMessage({conversationID:t,groupID:a,count:s,sequence:c})}return Dn()}},{key:"patchConvLastMessage",value:function(e){var t,n,o=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=this.getLocalConversation(e);i&&(t=(n=i.lastMessage).messageForShow,n=n.payload,!(He(t)||He(n)||o)||0!==(t=this._msgListHandler.getLocalMsgList(e)).length&&(n=t[t.length-1],Ne.l("".concat(this._n,".patchConvLastMessage bForceUpdate:").concat(o," convID:").concat(e," payload:"),n.payload),i.updateLastMessage(n)))}},{key:"onRoamingMessage",value:function(){var e,n,o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2],s=3<arguments.length?arguments[3]:void 0,a=(u=1<arguments.length?arguments[1]:void 0).startsWith(D.CONV_C2C)?D.CONV_C2C:D.CONV_GROUP,r=null,c=[],u=[],l=0,d=o.length,p=a===D.CONV_GROUP,_=this.getFileDownloadProxy(),h=this.getDowloadFileAuthKey(),g=Xe(s),f=this.get(17).getFileDNList(),m=function(){p?--l:++l},v=function(){return p?d<=l:l<d};for(l=p?o.length-1:0,d=p?0:o.length;v();m())1!==o[l].isPlaceMessage&&((r=new ko(o[l])).to=o[l].to,a!==D.CONV_GROUP||pt(o[l].topicID)||(r.to=o[l].topicID),r.isSystemMessage=!!o[l].isSystemMessage,r.conversationType=a,e=4===o[l].event?{type:D.MSG_GRP_TIP,content:t(t({},o[l].elements),{},{groupProfile:o[l].groupProfile})}:o[l].elements,p||r.setNickAndAvatar({nick:o[l].nick,avatar:o[l].avatar}),He(e)?((n=new so("emptyMessageBody")).setMessage("from:".concat(r.from," to:").concat(r.to," sequence:").concat(r.sequence," event:").concat(o[l].event)),n.setLevel("warning").end()):(r.setElement(e,_,h,f),r.reInitialize(this.getMyUserID()),c.push(r),g&&s.push(r)));return m=v=null,i?(this._msgListHandler.unshift(c,u),c=null,u):(u=null,c)}},{key:"findMessage",value:function(e){return this._msgListHandler.findMessage(e)}},{key:"_isMeInCommunity",value:function(e){var t=!0;return this._isTopicConv(e)&&(e=xt(e.replace(D.CONV_GROUP,"")),this.get(7).hasLocalGroup(e)||(t=!1,Ne.l("".concat(this._n,"._isMeInCommunity groupID:").concat(e," ret:").concat(t)))),t}},{key:"deleteTopicRoamingInfo",value:function(e){var t=this;Et({groupID:e})&&this._msgListHandler.getTopicConvIDList(e).forEach((function(e){t.clearMemMsg(e)}))}},{key:"deleteGroupRoamingInfo",value:function(e){e="".concat(D.CONV_GROUP).concat(e),0<this._msgListHandler.getLocalMsgList(e).length&&this.clearMemMsg(e)}},{key:"setMessageRead",value:function(e){var t=e.conversationID,n=this.getLocalConversation(t);if(e="".concat(this._n,".setMessageRead"),Ne.l("".concat(e," convID:").concat(t," unreadCount:").concat(n?n.unreadCount:0)),!n)return Dn();if(n.type!==D.CONV_GROUP&&n.type!==D.CONV_TOPIC||He(n.groupAtInfoList)||this.deleteGroupAtTips(t),0===n.unreadCount)return Dn();var o=this._msgListHandler.getLocalLastMsg(t),i=n.lastMessage.lastTime,s=(i<(s=this._msgListHandler.getLocalMaxTime(t))&&(Ne.l("".concat(e," update lastMessageTime from ").concat(i," to ").concat(s)),i=s),this._msgListHandler.getLocalMaxSeq(t)),a=n.lastMessage.lastSequence,r=(a<s&&(Ne.l("".concat(e," update lastMessageSeq from ").concat(a," to ").concat(s)),a=s),n.type===D.CONV_TOPIC&&pt(o)&&(e=this.get(10),o=xt(s=t.replace(D.CONV_GROUP,"")),(e=e.getLocalTopic(o,s))&&(a=e.nextMessageSeq-1)),null);switch(n.type){case D.CONV_C2C:return(r=this.get(6))?r.setMessageRead({conversationID:t,lastMessageTime:i}):Rn({code:Bn.NO_MODULE});case D.CONV_GROUP:case D.CONV_TOPIC:return(r=this.get(7))?r.setMessageRead({conversationID:t,lastMessageSeq:a}):Rn({code:Bn.NO_MODULE});case D.CONV_SYSTEM:return n.unreadCount=0,this.emitConvUpdate(!0,!1),Dn();default:return Dn()}}},{key:"setAllMessageRead",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n="setAllMessageRead",o="".concat(this._n,".").concat(n),i=(t.scope||(t.scope=D.READ_ALL_MSG),Ne.l("".concat(o," options:"),t),this._createSetAllMessageReadPack(t));if(0===i.readAllC2CMessage&&0===i.groupMessageReadInfoList.length)return Dn();var s=new so(n);return this.req({P:Kn.SET_ALL_MSG_READ,data:i}).then((function(n){return n=n.data,n=e._handleAllMsgRead(n),s.setMessage("scope:".concat(t.scope," failureGroups:").concat(JSON.stringify(n))).end(),Dn()})).catch((function(e){return s.setError(e).end(),Ne.w("".concat(o," failed. error:"),e),Rn({code:e&&e.code?e.code:Bn.MSG_UNREAD_ALL_FAIL,message:e&&e.message?e.message:void 0})}))}},{key:"setConvCustomData",value:function(e){return this._convGroupHandler.setConvCustomData(e)}},{key:"markConv",value:function(e){return this._convGroupHandler.markConv(e)}},{key:"getConvGroupList",value:function(){return this._convGroupHandler.getLocalConvGroupList()}},{key:"createConvGroup",value:function(e){return this._convGroupHandler.createConvGroup(e)}},{key:"deleteConvGroup",value:function(e){return this._convGroupHandler.deleteConvGroup(e)}},{key:"renameConvGroup",value:function(e){return this._convGroupHandler.renameConvGroup(e)}},{key:"addConvsToGroup",value:function(e){return this._convGroupHandler.addConvsToGroup(e)}},{key:"deleteConvsFromGroup",value:function(e){return this._convGroupHandler.deleteConvsFromGroup(e)}},{key:"onConvMarkUpdated",value:function(e){this._convGroupHandler.onConvMarkUpdated(e)}},{key:"onConvGroupCreated",value:function(e){this._convGroupHandler.onConvGroupCreated(e)}},{key:"onConvGroupDeleted",value:function(e){this._convGroupHandler.onConvGroupDeleted(e)}},{key:"onConvGroupNameUpdated",value:function(e){this._convGroupHandler.onConvGroupNameUpdated(e)}},{key:"onConvInGroupUpdated",value:function(e){this._convGroupHandler.onConvInGroupUpdated(e)}},{key:"onConvAddedToOrDeletedFromGroup",value:function(e){this._convGroupHandler.onConvAddedToOrDeletedFromGroup(e)}},{key:"_getConvLastMessageSeq",value:function(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID);return e=e.lastMessage.lastSequence,t&&e<t.sequence?t.sequence:e}},{key:"_getConvLastMessageTime",value:function(e){var t=this._msgListHandler.getLocalLastMsg(e.conversationID);return e=e.lastMessage.lastTime,t&&e<t.time?t.time:e}},{key:"_createSetAllMessageReadPack",value:function(e){var t,n={readAllC2CMessage:0,groupMessageReadInfoList:[]},o=e.scope,i=T(this._convMap);try{for(i.s();!(t=i.n()).done;){var s,a=f(t.value,2)[1];if(0<a.unreadCount)if(a.type===D.CONV_C2C&&0===n.readAllC2CMessage){if(o===D.READ_ALL_MSG)n.readAllC2CMessage=1;else if(o===D.READ_ALL_C2C_MSG){n.readAllC2CMessage=1;break}}else a.type!==D.CONV_GROUP||o!==D.READ_ALL_GROUP_MSG&&o!==D.READ_ALL_MSG||(s=this._getConvLastMessageSeq(a),n.groupMessageReadInfoList.push({groupID:a.groupProfile.groupID,messageSequence:s}))}}catch(e){i.e(e)}finally{i.f()}return n}},{key:"onPushedAllMessageRead",value:function(e){this._handleAllMsgRead(e)}},{key:"_handleAllMsgRead",value:function(e){var t=e.groupMessageReadInfoList;return e=e.readAllC2CMessage,t=this._parseGroupReadInfo(t),1<=this._updateAllConvUnreadCount({readAllC2CMessage:e})&&this.emitConvUpdate(!0,!1),t}},{key:"_parseGroupReadInfo",value:function(e){var t=[];if(e&&e.length)for(var n=0,o=e.length;n<o;n++){var i=(r=e[n]).groupID,s=r.sequence,a=r.retCode,r=r.lastMessageSeq;pt(a)?this._remoteGroupReadSeqMap.set(i,r):(this._remoteGroupReadSeqMap.set(i,s),0!==a&&t.push("".concat(i,"-").concat(s,"-").concat(a)))}return t}},{key:"_updateAllConvUnreadCount",value:function(e){var t,n=e.readAllC2CMessage,o=0,i=T(this._convMap);try{for(i.s();!(t=i.n()).done;){var s,a,r,c,u=f(t.value,2),l=u[0],d=u[1];1<=d.unreadCount&&(1===n&&d.type===D.CONV_C2C?(s=this._getConvLastMessageTime(d),this.updateIsReadAfterReadReport({conversationID:l,lastMessageTime:s})):d.type===D.CONV_GROUP&&(a=l.replace(D.CONV_GROUP,""),this._remoteGroupReadSeqMap.has(a)&&(r=this._remoteGroupReadSeqMap.get(a),c=this._getConvLastMessageSeq(d),this.updateIsReadAfterReadReport({conversationID:l,remoteReadSequence:r}),r<=c&&this._remoteGroupReadSeqMap.delete(a))),this.updateUnreadCount(l,!1)&&(o+=1))}}catch(t){i.e(t)}finally{i.f()}return o}},{key:"isRemoteRead",value:function(e){var t,n=e.conversationID,o=(e=e.sequence,n.replace(D.CONV_GROUP,"")),i=!1;return this._remoteGroupReadSeqMap.has(o)&&(e<=(t=this._remoteGroupReadSeqMap.get(o))&&(i=!0,Ne.l("".concat(this._n,".isRemoteRead convID:").concat(n," msgSeq:").concat(e," remoteReadSeq:").concat(t))),t+10<=e&&this._remoteGroupReadSeqMap.delete(o)),i}},{key:"updateIsReadAfterReadReport",value:function(e){var t=e.conversationID,n=e.lastMessageSeq,o=e.lastMessageTime,i=this._msgListHandler.getLocalMsgList(t);if(0!==i.length)for(var s,a=i.length-1;0<=a;a--)if(s=i[a],!(o&&s.time>o||n&&s.sequence>n)){if("in"===s.flow&&s.isRead)break;s.setIsRead(!0)}}},{key:"updateUnreadCount",value:function(e){var t,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],o=!1,i=this.getLocalConversation(e),s=this._msgListHandler.getLocalMsgList(e);if(i)return(t=i.unreadCount)!==(s=s.filter((function(e){return!e.isRead&&!e._onlineOnlyFlag&&!e.isDeleted})).length)&&(i.unreadCount=s,o=!0,Ne.l("".concat(this._n,".updateUnreadCount from ").concat(t," to ").concat(s,", convID:").concat(e)),!0===n&&this.emitConvUpdate(!0,!1)),o&&i.type===D.CONV_TOPIC&&(t=i.unreadCount,s=this.get(10),n=e.replace(D.CONV_GROUP,""),s.onUnreadCountUpdatedFromConv(n,t)),o}},{key:"clearGroupAtInfoList",value:function(e){var t,n=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],o=this.getLocalConversation(e);o&&0<o.groupAtInfoList.length&&(o.clearGroupAtInfoList(),Ne.l("".concat(this._n,".clearGroupAtInfoList convID:").concat(e)),o.type===D.CONV_TOPIC&&(o=o.groupAtInfoList,t=this.get(10),e=e.replace(D.CONV_GROUP,""),t.onAtInfoUpdated({topicID:e,groupAtInfoList:o})),!0===n&&this.emitConvUpdate(!0,!1))}},{key:"updateReadReceiptInfo",value:function(e){var t,n,o,i=this,s=void 0===(r=e.userID)?void 0:r,a=void 0===(r=e.groupID)?void 0:r,r=e.readReceiptList,c=void 0===(e=e.timestamp)?0:e;He(r)||(t=[],pt(s)?pt(a)||(n="".concat(D.CONV_GROUP).concat(a),r.forEach((function(e){var o=e.tinyID,s=e.clientTime,r=e.random,c=e.readCount;e=e.unreadCount,o="".concat(o,"-").concat(s,"-").concat(r),s=i._msgListHandler.getLocalMsg(n,o)||i._msgListHandler.getHoppingMsg(n,o),r={groupID:a,messageID:o,readCount:0,unreadCount:0},s&&(je(c)&&(s.readReceiptInfo.readCount=c,r.readCount=c),je(e)&&(s.readReceiptInfo.unreadCount=e,r.unreadCount=e),t.push(r))}))):(o="".concat(D.CONV_C2C).concat(s),r.forEach((function(e){var n=e.tinyID,a=e.clientTime;e=e.random,n="".concat(n,"-").concat(a,"-").concat(e),(a=i._msgListHandler.getLocalMsg(o,n)||i._msgListHandler.getHoppingMsg(o,n))&&!a.readReceiptInfo.isPeerRead&&(a.readReceiptInfo.isPeerRead=!0,a.readReceiptInfo.timestamp=c,t.push({userID:s,messageID:n,isPeerRead:!0,timestamp:c}))}))),0<t.length&&this.emitOEvt(E.MESSAGE_READ_RECEIPT_RECEIVED,t))}},{key:"updateIsRead",value:function(e){var t=this.getLocalConversation(e),n=this.getLocalMessageList(e);if(t&&0!==n.length&&!Lt(t.type)){for(var o=[],i=0,s=n.length;i<s;i++)"in"!==n[i].flow?"out"!==n[i].flow||n[i].isRead||n[i].setIsRead(!0):o.push(n[i]);var a=0;a=t.type===D.CONV_C2C?(e=o.slice(-t.unreadCount).filter((function(e){return e.isRevoked})).length,o.length-t.unreadCount-e):o.length-t.unreadCount;for(var r=0;r<a&&!o[r].isRead;r++)o[r].setIsRead(!0)}}},{key:"deleteGroupAtTips",value:function(e){var t=this,n="".concat(this._n,".deleteGroupAtTips");if(Ne.l("".concat(n)),!(i=this._convMap.get(e)))return Promise.resolve();var o=i.groupAtInfoList;if(0===o.length)return Promise.resolve();var i=void 0,s=(e.startsWith(D.CONV_GROUP)&&(i=e.replace(D.CONV_GROUP,"")),m(o));if((Et({groupID:i})||Dt(i))&&0===(s=o.filter((function(e){return!e.atTypeArray.includes(D.CONV_AT_ALL)}))).length)return this.clearGroupAtInfoList(e,!1),Promise.resolve();var a=this.getMyUserID();return this.req({P:Kn.DEL_GROUP_AT_TIPS,data:{messageListToDelete:s.map((function(e){return{from:e.from,to:a,messageSeq:e.__sequence,messageRandom:e.__random,groupID:pt(e.topicID)?e.groupID:e.topicID}}))}}).then((function(){return Ne.l("".concat(n," ok. count:").concat(o.length)),t.clearGroupAtInfoList(e,!1),Promise.resolve()})).catch((function(e){return Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"appendToMessageList",value:function(e){return this._msgListHandler.pushIn(e)}},{key:"setMessageRandom",value:function(e){this._sll.set(e.random)}},{key:"deleteMessageRandom",value:function(e){this._sll.delete(e.random)}},{key:"pushIntoMessageList",value:function(e,t,n){return!(!this._msgListHandler.pushIn(t,n)||this._sll.has(t.random)&&!n||(e.push(t),0))}},{key:"revoke",value:function(e,t,n){return this._msgListHandler.revoke(e,t,n)}},{key:"getPeerReadTime",value:function(e){return this._peerReadTimeMap.get(e)}},{key:"recordPeerReadTime",value:function(e,t){(!this._peerReadTimeMap.has(e)||this._peerReadTimeMap.get(e)<t)&&this._peerReadTimeMap.set(e,t)}},{key:"updateMsgIsPeerReadProp",value:function(e,t){var n;e.startsWith(D.CONV_C2C)&&0<t&&(0<(n=this._msgListHandler.updateMsgIsPeerReadProp(e,t)).length&&this.emitOEvt(E.MESSAGE_READ_BY_PEER,n),this._convMap.has(e)&&(He(n=this._convMap.get(e).lastMessage)||n.fromAccount===this.getMyUserID()&&n.lastTime<=t&&!n.isPeerRead&&(n.isPeerRead=!0,this.emitConvUpdate(!0,!1))))}},{key:"updateMsgIsModifiedProp",value:function(e){this._msgListHandler.updateMsgIsModifiedProp(e)}},{key:"setCompleted",value:function(e){Ne.l("".concat(this._n,".setCompleted convID:").concat(e)),this._completedMap.set(e,!0)}},{key:"updateRoamingMsgKeyAndTime",value:function(e,t,n){this._roamingMsgKeyAndTimeMap.set(e,{messageKey:t,lastMessageTime:n})}},{key:"getConvList",value:function(e){var t,n=this,o="".concat(this._n,".").concat("getConvList"),i="pagingStatus:".concat(this._pagingStatus,", local conversation count:").concat(this._convMap.size,", options:").concat(JSON.stringify(e));return Ne.l("".concat(o,". ").concat(i)),this._pagingStatus===Gn?((t=new so("getConvList")).setMessage(i),this.syncConvList().then((function(){return t.end(),En({conversationList:n._getConvList(e),isSyncCompleted:n._isSyncCompleted()})})).catch((function(e){return t.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))):(i=this._getConvList(e),Ne.l("".concat(o,". returned conversation count:").concat(i.length)),Dn({conversationList:i,isSyncCompleted:this._isSyncCompleted()}))}},{key:"_getConvList",value:function(e){var t,n,o,i,s,a=this;return pt(e)?this.getLocalConvList():Xe(e)?0===e.length?[]:this.getLocalConvList().filter((function(t){return e.includes(t.conversationID)})):ze(e)?(t=e.type,n=e.markType,o=e.groupName,i=e.hasUnreadCount,s=e.hasGroupAtInfo,this.getLocalConvList().filter((function(e){return a._filterType(e,t)&&a._filterMarkType(e,n)&&a._filterGroupName(e,o)&&a._filterUnreadCount(e,i)&&a._filterGroupAtInfo(e,s)}))):[]}},{key:"_filterType",value:function(e,t){return t!==D.CONV_C2C&&t!==D.CONV_GROUP||e.type===t}},{key:"_filterGroupName",value:function(e,t){return!dt(t)||(""===t?0===e.conversationGroupList.length:e.conversationGroupList.includes(t))}},{key:"_filterMarkType",value:function(e,t){return!je(t)||(0===t?0===e.markList.length:e.markList.includes(t))}},{key:"_filterUnreadCount",value:function(e,t){var n=!0;return!0===t?n=1<=e.unreadCount:!1===t&&(n=0===e.unreadCount),n}},{key:"_filterGroupAtInfo",value:function(e,t){var n=!0;return!0===t?n=1<=e.groupAtInfoList.length:!1===t&&(n=0===e.groupAtInfoList.length),n}},{key:"_handleC2CPeerReadTime",value:function(){var e,t=T(this._convMap);try{for(t.s();!(e=t.n()).done;){var n=f(e.value,2),o=n[0],i=n[1];i.type===D.CONV_C2C&&this.recordPeerReadTime(o,i.peerReadTime)}}catch(e){t.e(e)}finally{t.f()}}},{key:"_isPagingGetGroupListCompleted",value:function(){var e=this.get(7);return!e||e.isPagingGetCompleted()}},{key:"_getLocalGroupCount",value:function(){var e=this.get(7);return e?e.getLocalGroupList().length:0}},{key:"_hasLocalGroup",value:function(e){var t=this.get(7);return!!t&&t.hasLocalGroup(e.replace(D.CONV_GROUP,""))}},{key:"getConversationProfile",value:function(e){var t,n=this,o=!1;if(this._convMap.has(e)?t=this._convMap.get(e):(t=new pi({conversationID:e,type:Rt(e)?D.CONV_C2C:D.CONV_GROUP},this.isIntl(),this.isUsingChatCore()),o=!0),t._isInfoCompleted||t.type===D.CONV_SYSTEM)return Dn({conversation:t});if(St(e)){if(!this.get(7))return Rn({code:Bn.NO_MODULE});if(!this._hasLocalGroup(e))return Dn({conversation:t})}var i="".concat(this._n,".").concat("getConversationProfile"),s=new so("getConversationProfile");return Ne.l("".concat(i,". convID:").concat(e," remark:").concat(t.remark," lastMessage:"),t.lastMessage),this._getUserOrGroupProfile(t).then((function(a){s.setMessage("convID:".concat(e," unreadCount:").concat(a.data.conversation.unreadCount)).end();var r,c=n.get(8);if(c&&t.type===D.CONV_C2C&&(r=e.replace(D.CONV_C2C,""),c.isMyFriend(r)&&(c=c.getFriendRemark(r),t.remark!==c&&(t.remark=c,Ne.l("".concat(i,". convID:").concat(e," patch remark:").concat(t.remark))))),Ne.l("".concat(i," ok. isNewConv:").concat(o," convID:").concat(e)),o){if(t.type===D.CONV_C2C)return n._onNewC2CConv([e.replace(D.CONV_C2C,"")]).then((function(){return Dn({conversation:t})}));if(t.type===D.CONV_GROUP)return n._onNewGroupConv([e.replace(D.CONV_GROUP,"")]).then((function(){return Dn({conversation:t})}))}return a})).catch((function(t){return s.setError(t).setMessage("convID:".concat(e)).end(),Ne.e("".concat(i," failed. error:"),t),Rn(t)}))}},{key:"_getUserOrGroupProfile",value:function(e){var t=this;return e.type===D.CONV_C2C?this.get(4).getUserProfile({userIDList:[e.toAccount]}).then((function(n){return 0===(n=n.data).length?Rn({code:Bn.USER_OR_GRP_NOT_FOUND}):(e.userProfile=n[0],e._isInfoCompleted=!0,t._insertConvAfterTopmost(e),Dn({conversation:e}))})):this.get(7).getGroupProfile({groupID:e.toAccount}).then((function(n){return e.groupProfile=n.data.group,e._isInfoCompleted=!0,t._insertConvAfterTopmost(e),Dn({conversation:e})}))}},{key:"_insertConvAfterTopmost",value:function(e){var t,n;e instanceof pi&&!this._convMap.has(e.conversationID)&&(n=(t=m(this._convMap)).findIndex((function(e){return!1===e[1].isPinned})),t.splice(n,0,[e.conversationID,e]),this._convMap=new Map(t),this._setStorageConvList(),this.emitConvUpdate(!0,!1))}},{key:"_onProfileUpdated",value:function(e){var t=this;e.data.forEach((function(e){var n=e.userID;n===t.getMyUserID()?t._onMyProfileModified({latestNick:e.nick,latestAvatar:e.avatar}):(n=t._convMap.get("".concat(D.CONV_C2C).concat(n)))&&(n.userProfile=e)}))}},{key:"_onCloudConfig",value:function(e){"0"===this.getCloudConfig("pull_on_invite")&&(this._bPullOnInvite=!1),Ne.l("".concat(this._n,"._onCloudConfig bPullOnInvite:").concat(this._bPullOnInvite))}},{key:"disableMsgPullOnInvite",value:function(){this._bPullOnInvite=!1}},{key:"_isSyncCompleted",value:function(){return this._pagingStatus===Pn}},{key:"_errorLog",value:function(e,t,n,o){var i=new Error("Params validate failed."),s="".concat(this.getErrMsg("API_REFER")).concat(e);throw Ne.w("[".concat(e,"] | ").concat(t," | ").concat(this.getErrMsg(n,o),", ").concat(s)),Ne.e("[".concat(e,"] Invalid ").concat(t,": type check failed for ").concat(t,".")),i}},{key:"_isValidConvID",value:function(e){return Rt(e)||St(e)||Lt(e)}},{key:"deleteConversation",value:function(e){var t=this,n="deleteConversation";return dt(e)||Je(e)||this._errorLog(n,"options","StringOrObjectRequiredLog"),dt(e)?(this._isValidConvID(e)||this._errorLog(n,"options","InvalidConversationID",e),Ne.l("".concat(this._n,".").concat(n," convID:").concat(e)),this.deleteConvList({conversationIDList:[e],flag:1})):(Xe(e.conversationIDList)||this._errorLog(n,"conversationIDList","ArrayRequiredLog"),0===e.conversationIDList.length&&this._errorLog(n,"conversationIDList","NonEmptyArrayLog"),e.conversationIDList.forEach((function(e){t._isValidConvID(e)||t._errorLog(n,"conversationIDList","InvalidConversationID",e)})),"clearHistoryMessage"in e&&"boolean"!=typeof e.clearHistoryMessage&&this._errorLog(n,"clearHistoryMessage","BooleanRequiredLog"),100<e.conversationIDList.length&&(e.conversationIDList=e.conversationIDList.slice(0,100)),this.deleteConvList(e))}},{key:"deleteConvList",value:function(e){var t=void 0===(t=e.conversationIDList)?[]:t,n=void 0===(n=e.clearHistoryMessage)||n,o=void 0===(e=e.flag)?0:e,i="".concat(this._n,".").concat("deleteConvList"),s=(e="convIDList:".concat(t," clearHistoryMessage:").concat(n),Ne.l("".concat(i," ").concat(e)),new so("deleteConvList"));return s.setMessage(e),Promise.all([this.rmLocalOnlyConvList(t),this.rmLocalAndRemoteConvList(t,n)]).then((function(e){return s.end(),0===(e=[].concat(m(e[0]),m(e[1]))).length?Rn(new Vn({code:Bn.CONV_NOT_FOUND})):(Ne.l("".concat(i," ok")),Dn(1===o?{conversationID:e[0]}:{conversationIDList:e}))})).catch((function(e){return s.setError(e).end(),Ne.e("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"rmLocalOnlyConvList",value:function(e){var t=this;return e.filter((function(e){if(!t._convMap.has(e))return!1;var n=t.getLocalConversation(e).type;return n!==D.CONV_GROUP||t._hasLocalGroup(e)?n===D.CONV_SYSTEM&&(t.get(7).deleteGroupSystemNotice({messageList:t._msgListHandler.getLocalMsgList(e)}),t.deleteLocalConv(e),!0):(t.deleteLocalConv(e),!0)}))}},{key:"rmLocalAndRemoteConvList",value:function(e,t){var n=this,o={fromAccount:this.getMyUserID(),conversationList:[],clearHistoryMessage:t?1:0};return e.forEach((function(e){var t;n._convMap.has(e)&&((t=n.getLocalConversation(e).type)===D.CONV_C2C?o.conversationList.push({toAccount:e.replace(t,""),type:1}):t===D.CONV_GROUP&&n._hasLocalGroup(e)&&o.conversationList.push({toGroupID:e.replace(t,""),type:2}))})),0===o.conversationList.length?[]:this.req({P:Kn.DEL_CONV,data:o}).then((function(e){var t=[];return 0<e.data.resultList.length&&e.data.resultList.map((function(e){0===e.code&&(e=1===e.type?"".concat(D.CONV_C2C).concat(e.to):"".concat(D.CONV_GROUP).concat(e.groupID),t.push(e))})),n.deleteLocalConvList(t),t}))}},{key:"setConvDraft",value:function(e){var t=e.conversationID,n=(e=e.draftText,"".concat(this._n,".").concat("setConvDraft"));return Ne.l("".concat(n," convID:").concat(t," draftText:").concat(e)),this._convMap.has(t)?((n=this._convMap.get(t)).setDraftText(e),this.emitConvUpdate(),Dn({code:0,conversation:n})):Rn({code:Bn.CONV_NOT_FOUND})}},{key:"clearHistoryMessage",value:function(e){var t=this,n={fromAccount:this.getMyUserID(),toAccount:void 0,type:void 0,toGroupID:void 0};if(!this._convMap.has(e))return Rn({code:Bn.CONV_NOT_FOUND});var o=this._convMap.get(e).type;if(o===D.CONV_C2C)n.type=1,n.toAccount=e.replace(D.CONV_C2C,"");else{if(o!==D.CONV_GROUP)return o===D.CONV_SYSTEM?(this.get(7).deleteGroupSystemNotice({messageList:this._msgListHandler.getLocalMsgList(e)}),Dn({conversationID:e})):Rn({code:Bn.CONV_UN_RECORDED_TYPE});n.type=2,n.toGroupID=e.replace(D.CONV_GROUP,"")}var i="".concat(this._n,".").concat("clearHistoryMessage"),s=new so("clearHistoryMessage");return s.setMessage("convID:".concat(e)),Ne.l("".concat(i,". convID:").concat(e)),this.setMessageRead({conversationID:e}).then((function(){return t.req({P:Kn.CLEAR_HISTORY_MSG,data:n})})).then((function(){s.end(),Ne.l("".concat(i," ok")),t.clearMemMsg(e);var n=t.getLocalConversation(e);return n&&(n.updateLastMessage(),t._sortConvListAndEmitEvent()),Dn({conversationID:e})})).catch((function(e){return s.setError(e).end(),Ne.e("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"pinConversation",value:function(e){var t=this,n=e.conversationID,o=e.isPinned,i=this.getLocalConversation(n);if(i&&i.isPinned===o)return Dn({conversationID:n});if(Lt(n))return i&&(i.isPinned=o),this._sortConvListAndEmitEvent(),Dn({conversationID:n});if(e=null,Rt(n)?e={type:1,toAccount:n.replace(D.CONV_C2C,"")}:St(n)&&(e={type:2,groupID:n.replace(D.CONV_GROUP,"")}),null===e)return Rn({code:Bn.INVALID_CONV_ID});var s="".concat(this._n,".").concat("pinConversation"),a="convID:".concat(n," isPinned:").concat(o),r=new so("pinConversation");return r.setMessage(a),Ne.l("".concat(s,". ").concat(a)),this.req({P:Kn.PIN_CONV,data:{fromAccount:this.getMyUserID(),operationType:!0===o?1:2,itemList:[e]}}).then((function(){return r.end(),Ne.l("".concat(s," ok")),i?i.isPinned!==o&&(i.isPinned=o):t._convMap.set(n,new pi({conversationID:n,type:Rt(n)?D.CONV_C2C:D.CONV_GROUP,isPinned:o},t.isIntl(),t.isUsingChatCore())),t._sortConvListAndEmitEvent(),En({conversationID:n})})).catch((function(e){return r.setError(e).end(),Ne.e("".concat(s," failed. error:"),e),Rn(e)}))}},{key:"setMessageRemindType",value:function(e){return this._msgRemindHandler.set(e)}},{key:"patchMsgRemindType",value:function(e){var t=e.ID,n=e.isC2CConversation,o=e.messageRemindType,i=!1;return(n=this.getLocalConversation("".concat(n?D.CONV_C2C:D.CONV_GROUP).concat(t)))&&n.messageRemindType!==o&&(n.messageRemindType=o,i=!0),Ne.l("".concat(this._n,".patchMsgRemindType options:"),e,"ret:".concat(i)),i}},{key:"onC2CMsgRemindTypeFetched",value:function(e){var t,n=this;Xe(e)&&0<e.length&&(t=0,e.forEach((function(e){var o=e.userID;e=e.muteFlag,e=n._transMsgRemindType(e),!0===n.patchMsgRemindType({ID:o,isC2CConversation:!0,messageRemindType:e})&&(t+=1)})),Ne.l("".concat(this._n,".onC2CMsgRemindTypeFetched updateCount:").concat(t)),1<=t&&this.emitConvUpdate(!0,!1))}},{key:"onC2CMsgRemindTypeSynced",value:function(e){var t=this,n="".concat(this._n,".onC2CMsgRemindTypeSynced");e.dataList.forEach((function(e){var o;He(e.muteNotificationsSync)||(o=(e=e.muteNotificationsSync).to,e=e.muteFlag,e=t._transMsgRemindType(e),t.patchMsgRemindType({ID:o,isC2CConversation:!(o=0),messageRemindType:e})&&(o+=1),Ne.l("".concat(n," updateCount:").concat(o)),1<=o&&t.emitConvUpdate(!0,!1))}))}},{key:"onGroupMsgRemindTypeUpdated",value:function(e){this._msgRemindHandler.onGroupMsgRemindTypeUpdated(e)}},{key:"deleteLocalConv",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this._convMap.has(e);Ne.l("".concat(this._n,".deleteLocalConv convID:").concat(e," has:").concat(n)),n&&(this._convMap.delete(e),this._convMapForDiff.delete(e),this.clearMemMsg(e),this._setStorageConvList(!0),t)&&(n=!this._isTopicConv(e),this.emitConvUpdate(n,!1))}},{key:"pullMsgOnInvite",value:function(e){var t,n,o,i,s,a=this.get(7);a&&(t="".concat(this._n,".pullMsgOnInvite"),Ne.l("".concat(t," flag:").concat(this._bPullOnInvite)),this._bPullOnInvite&&(s=this.getLocalLastMessage(e),n=this.getLocalSecondLastMessage(e),i=o=1,s&&(o=s.sequence),n&&(i=n.sequence),s=a.getGroupRemoteLastSeq(e.replace(D.CONV_GROUP,"")),Ne.l("".concat(t," convID:").concat(e," localLastSeq:").concat(o," localSecondLastSeq:").concat(i," remoteLastSeq:").concat(s)),this.clearMemMsg(e),1<o-i?this._recursiveGetMsgList([],e,!1,o,i):1<s-o&&this._recursiveGetMsgList([],e,!0,s,o)))}},{key:"_recursiveGetMsgList",value:function(e,t,n,o,i,s){var a=this;this.getMessageList({conversationID:t,nextReqMessageID:s}).then((function(s){var r=(s=s.data).messageList,c=s.isCompleted,u=(s=s.nextReqMessageID,r.filter((function(e){return n?e.sequence>i&&e.sequence<=o:e.sequence>i&&e.sequence<o})));e.unshift.apply(e,m(u)),!c&&0<r.length&&r[0].sequence>i&&e.length<60?a._recursiveGetMsgList(e,t,n,o,i,s):a._emitMsgReceived(t,e)}))}},{key:"_emitMsgReceived",value:function(e,t){var n,o,i=this;0<t.length&&(t=t.filter((function(e,t,n){return t===n.findIndex((function(t){return t.sequence===e.sequence}))})),n=this.hasLocalConversation(e),o=t.map((function(e){return e.sequence})),Ne.l("".concat(this._n,"._emitMsgReceived convID:").concat(e," has:").concat(n," count:").concat(o.length," sequenceList:"),o),this.emitOEvt(E.MESSAGE_RECEIVED,t),n?this.patchConvLastMessage(e,!0):this.getConversationProfile(e).then((function(){i.patchConvLastMessage(e,!0)})))}},{key:"deleteLocalConvList",value:function(e){var t=this,n=!1;e.forEach((function(e){t._convMap.has(e)&&(t.deleteLocalConv(e,!1),n=!0)})),Ne.l("".concat(this._n,".deleteLocalConvList convID:").concat(e," isConvIDExisted:").concat(n)),n&&this.emitConvUpdate(!0,!1)}},{key:"isMessageSentByCurrentInstance",value:function(e){return!(!this._msgListHandler.hasLocalMsg(e.conversationID,e.ID)&&!this._sll.has(e.random))}},{key:"modifyMessageList",value:function(e){var t,n;e.startsWith(D.CONV_C2C)&&this._convMap.has(e)&&(n=this._convMap.get(e),t=Date.now(),this._msgListHandler.modifyMsgSentByPeer({conversationID:e,latestNick:n.userProfile.nick,latestAvatar:n.userProfile.avatar}),n=this.get(4).getNickAndAvatarByUserID(this.getMyUserID()),this._msgListHandler.modifyMsgSentByMe({conversationID:e,latestNick:n.nick,latestAvatar:n.avatar}),Ne.l("".concat(this._n,".modifyMessageList convID:").concat(e," cost:").concat(Jt(t))))}},{key:"updateUserProfileSpecifiedKey",value:function(e){Ne.l("".concat(this._n,".updateUserProfileSpecifiedKey options:"),e);var t=e.conversationID,n=e.nick;e=e.avatar,this._convMap.has(t)&&(t=this._convMap.get(t).userProfile,dt(n)&&t.nick!==n&&(t.nick=n),dt(e)&&t.avatar!==e&&(t.avatar=e),this.emitConvUpdate(!0,!1))}},{key:"_onMyProfileModified",value:function(e){var n=this,o=this.getLocalConvList(),i=Date.now();o.forEach((function(o){n.modifyMessageSentByMe(t({conversationID:o.conversationID},e))})),Ne.l("".concat(this._n,"._onMyProfileModified. modify all messages sent by me, cost:").concat(Jt(i)))}},{key:"modifyMessageSentByMe",value:function(e){this._msgListHandler.modifyMsgSentByMe(e)}},{key:"getLatestMessageSentByMe",value:function(e){return this._msgListHandler.getLatestMsgSentByMe(e)}},{key:"modifyMessageSentByPeer",value:function(e){this._msgListHandler.modifyMsgSentByPeer(e)}},{key:"getLatestMessageSentByPeer",value:function(e){return this._msgListHandler.getLatestMsgSentByPeer(e)}},{key:"pushIntoNoticeResult",value:function(e,t){return!(!this._msgListHandler.pushIn(t)||this._sll.has(t.random)||(e.push(t),0))}},{key:"getLocalLastMessage",value:function(e){return this._msgListHandler.getLocalLastMsg(e)}},{key:"getLocalSecondLastMessage",value:function(e){return this._msgListHandler.getLocalSecondLastMsg(e)}},{key:"checkAndPatchRemark",value:function(){var e,t,n=this.get(8);0===this._convMap.size||!n||0!==(e=m(this._convMap.values()).filter((function(e){return e.type===D.CONV_C2C}))).length&&(t=0,e.forEach((function(e){var o=e.conversationID.replace(D.CONV_C2C,"");n.isMyFriend(o)&&(o=n.getFriendRemark(o),e.remark!==o&&(e.remark=o,t+=1))})),Ne.l("".concat(this._n,".checkAndPatchRemark. c2cConvCount:").concat(e.length," patchedCount:").concat(t)),0<t&&this.emitConvUpdate(!0,!1))}},{key:"updateTopicConversation",value:function(e){this._updateLocalConvList({conversationOptionsList:e,isFromGetConversations:!0,updateUnreadCount:!0})}},{key:"sendReadReceipt",value:function(e){var t=e[0],n=null;return t.conversationType===D.CONV_C2C?n=this._m.get(6):t.conversationType===D.CONV_GROUP&&(n=this._m.get(7)),n?n.sendReadReceipt(e):Rn({code:Bn.NO_MODULE})}},{key:"getReadReceiptList",value:function(e){var t=e[0],n=null;return t.conversationType===D.CONV_C2C?n=this._m.get(6):t.conversationType===D.CONV_GROUP&&(n=this._m.get(7)),n?n.getReadReceiptList(e):Rn({code:Bn.NO_MODULE})}},{key:"getLastMessageTime",value:function(e){return(e=this.getLocalConversation(e))?e.lastMessage.lastTime:0}},{key:"getTotalUnreadCount",value:function(){var e=this.getLocalConvList(),t=0;return e.forEach((function(e){e.type!==D.CONV_SYSTEM&&(""!==e.messageRemindType&&e.messageRemindType!==D.MSG_REMIND_ACPT_AND_NOTE||(t+=e.unreadCount))})),t}},{key:"onTotalUnreadCountUpdate",value:function(){var e=this.getTotalUnreadCount();this._convTotalUnreadCount!==e&&(Ne.l("".concat(this._n,".onTotalUnreadCountUpdate from ").concat(this._convTotalUnreadCount," to ").concat(e)),this._convTotalUnreadCount=e,this.emitOEvt(E.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED))}},{key:"_isConvNeedShow",value:function(e){if(e=this.getLocalConversation(e),pt(e))return!0;var t=e.type===D.CONV_TOPIC,n=e.type===D.CONV_GROUP&&e.groupProfile.type===D.GRP_ROOM;return e=e.type===D.CONV_GROUP&&e.groupProfile.type===D.GRP_LIVE,!(t||n||e)}},{key:"setAllRcvMsgOpt",value:function(e){return this._msgRemindHandler.setAllRcvMsgOpt(e)}},{key:"getAllRcvMsgOpt",value:function(){return this._msgRemindHandler.getAllRcvMsgOpt()}},{key:"onAllRcvMsgOptNotify",value:function(e){this._msgRemindHandler.onAllRcvMsgOptNotify(e)}},{key:"clearUnreadCount",value:function(e){(e=this.getLocalConversation(e))&&0<e.unreadCount&&(e.unreadCount=0,this.emitConvUpdate(!0,!1))}},{key:"storeHoppingMessageList",value:function(e){this._msgListHandler.storeHoppingMsgList(e)}},{key:"clearMemMsg",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];Ne.l("".concat(this._n,".clearMemMsg convID:").concat(e," isOverLimit:").concat(t)),this._msgListHandler.removeByConvID(e),this._completedMap.delete(e),this._roamingMsgKeyAndTimeMap.delete(e),this._everClearedMap.set(e,1)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._setStorageConvList(!0),this._pagingStatus=On,this._msgListHandler.reset(),this._msgRemindHandler.reset(),this._roamingMsgKeyAndTimeMap.clear(),this._sll.reset(),this._peerReadTimeMap.clear(),this._completedMap.clear(),this._convMap.clear(),this._pagingTs=0,this._pagingStartIdx=0,this._pagingPinnedTs=0,this._pagingPinnedStartIdx=0,this._remoteGroupReadSeqMap.clear(),this._convTotalUnreadCount=0,this._pagingGetCostList.length=0,this._pagingConvIDMap.clear(),this._convIDFromUnreadDBMap.clear(),this._pagingGetCostList.length=0,this._convMapForDiff.clear(),this._partialUpdatedConvMap.clear(),this._everClearedMap.clear(),this._bPullOnInvite=!0,this._convGroupHandler.reset(),this.resetReady()}}]),ss),mi=(s(is,[{key:"onCheckTimer",value:function(e){e%1==0&&0<this._cachedGroupTipsMap.size&&this._check()}},{key:"_check",value:function(){var e=this;this._cachedGroupTipsMap.forEach((function(t,n){var o=e._checkCountMap.get(n),i=e._grpM.hasLocalGroup(n);Ne.l("".concat(e._n,"._check groupID:").concat(n," hasLocalGroup:").concat(i," checkCount:").concat(o)),i?(e._notifyCachedGroupTips(n),e._checkCountMap.delete(n),e._grpM.deleteUnjoinedAVChatRoom(n)):o>=e.MAX_CHECK_COUNT?(e._deleteCachedGroupTips(n),e._checkCountMap.delete(n)):e._checkCountMap.set(n,++o)}))}},{key:"onNewGroupTips",value:function(e){Ne.l("".concat(this._n,".onNewGroupTips options:").concat(JSON.stringify(e.dataList)));var t=(e=this._assembly(e)).eventDataList,n=e.result;0<(e=e.AVChatRoomMessageList).length&&this._grpM.onAVChatRoomMessage(e),0<n.length&&(this._grpM.emitOEvt(E.MESSAGE_RECEIVED,n),this._handleTips(n)),0<t.length&&(this._grpM.updateNextMessageSeq(t),this._grpM.get(11).onNewMessage({conversationOptionsList:t,isInstantMessage:!0}))}},{key:"_assembly",value:function(e){for(var n=e.event,o=e.dataList,i=null,s=[],a=[],r={},c=[],u=0,l=o.length;u<l;u++){var d=ut(o[u]);if(6===n){if(this._grpM.isGroupAttributesUpdatedNotice(d))continue;if(this._grpM.isGroupCountersNotice(d))continue}var p=(f=d.groupProfile).groupID,_=void 0===(_=f.communityType)?0:_,h=void 0===(h=f.topicID)?void 0:h,g=f.invisible,f=void 0===(f=f.groupType)?void 0:f,m=void 0;if((I=this._grpM.isMessageFromTopic(_,h))&&(m=D.CONV_TOPIC,d.to=h),(v=this._grpM.hasLocalGroup(p))||!this._grpM.isUnjoinedAVChatRoom(p))if(v||I)if(this._grpM.isMessageFromOrToAVChatroom(p))d.event=n,c.push(d);else if(d.currentUser=this._grpM.getMyUserID(),d.conversationType=D.CONV_GROUP,(i=new ko(d)).setElement({type:D.MSG_GRP_TIP,content:t(t({},d.elements),{},{groupProfile:d.groupProfile})}),i.isSystemMessage=!1,1!==g){var v=this._grpM.get(11),I=(g=(I=i).conversationID,I.sequence);if(6===n)i._onlineOnlyFlag=!0,a.push(i);else if(!v.pushIntoNoticeResult(a,i))continue;this._grpM.isMessageFromCommunityOfTopic(_,h)||6===n&&v.getLocalConversation(g)||(6!==n&&this._qualityStat(i),_=v.isRemoteRead({conversationID:g,sequence:I}),pt(r[g])?(h=0,"in"===i.flow&&(i._isExcludedFromUnreadCount||i._onlineOnlyFlag||_||(h=1)),r[g]=s.push({conversationID:g,unreadCount:h,type:pt(m)?i.conversationType:m,subType:i.conversationSubType,lastMessage:i._isExcludedFromLastMessage?"":i})-1):(s[v=r[g]].type=i.conversationType,s[v].subType=i.conversationSubType,s[v].lastMessage=i._isExcludedFromLastMessage?"":i,"in"===i.flow&&(i._isExcludedFromUnreadCount||i._onlineOnlyFlag||_||s[v].unreadCount++)))}else this._qualityStat(i);else this._cacheAndCompare({groupID:p,event:n,item:d,groupType:f})}return{eventDataList:s,result:a,AVChatRoomMessageList:c}}},{key:"_qualityStat",value:function(e){this._grpM.get(26).addMessageSequence({key:Zn,message:e})}},{key:"_handleTips",value:function(e){var t=this;e.forEach((function(e){switch(e.payload.operationType){case 1:t._onNewMemberComeIn(e);break;case 2:t._onMemberQuit(e);break;case 3:t._onMemberKickedOut(e);break;case 4:t._onMemberSetAdmin(e);break;case 5:t._onMemberCancelledAdmin(e);break;case 6:t._onGroupProfileModified(e);break;case 7:t._onMemberInfoModified(e);break;case 8:t._onTopicProfileUpdated(e);break;default:Ne.w("".concat(t._n,"._handleTips unknown operationType:").concat(e.payload.operationType))}}))}},{key:"_onNewMemberComeIn",value:function(e){var t=(e=e.payload).memberNum;e=e.groupProfile.groupID,(e=this._grpM.getLocalGroupProfile(e))&&je(t)&&e.memberCount!==t&&(e.memberCount=t,this._updateConvGroupProfile(e))}},{key:"_onMemberQuit",value:function(e){var t=(n=e.payload).memberNum,n=n.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(n);o&&je(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConvGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(n,e.payload.userIDList)}},{key:"_onMemberKickedOut",value:function(e){var t=(n=e.payload).memberNum,n=n.groupProfile.groupID,o=this._grpM.getLocalGroupProfile(n);o&&je(t)&&o.memberCount!==t&&(o.memberCount=t,this._updateConvGroupProfile(o)),this._grpM.getGroupMemberHandler().deleteLocalGroupMembers(n,e.payload.userIDList)}},{key:"_updateConvGroupProfile",value:function(e){this._grpM.get(11).updateConvGroupProfile([e])}},{key:"_onMemberSetAdmin",value:function(e){var t=e.payload.groupProfile.groupID,n=(e=e.payload.userIDList,this._grpM.getGroupMemberHandler());e.forEach((function(e){(e=n.getLocalGroupMemberInfo(t,e))&&e.updateRole(D.GRP_MBR_ROLE_ADMIN)}))}},{key:"_onMemberCancelledAdmin",value:function(e){var t=e.payload.groupProfile.groupID,n=(e=e.payload.userIDList,this._grpM.getGroupMemberHandler());e.forEach((function(e){(e=n.getLocalGroupMemberInfo(t,e))&&e.updateRole(D.GRP_MBR_ROLE_MEMBER)}))}},{key:"_onGroupProfileModified",value:function(e){var t=this,n=(e=e.payload).newGroupProfile,o=e.groupProfile,i=e.operatorInfo,s=(e=o.groupID,this._grpM.getLocalGroupProfile(e));Object.keys(n).forEach((function(e){switch(e){case"ownerID":t._ownerChanged(s,n);break;case"groupName":s.name=n[e];break;default:s[e]=n[e]}})),pt(i)||Object.keys(i).forEach((function(e){var t;"nameCard"===e?s.updateSelfInfo({nameCard:i[e]}):"role"===e&&(t="",400===i[e]?t=D.GRP_MBR_ROLE_OWNER:300===i[e]?t=D.GRP_MBR_ROLE_ADMIN:200===i[e]&&(t=D.GRP_MBR_ROLE_MEMBER),s.updateSelfInfo({role:t}))})),o=!s.isSupportTopic,this._grpM.emitGroupListUpdate(!0,o)}},{key:"_ownerChanged",value:function(e,t){e=e.groupID;var n=this._grpM.getLocalGroupProfile(e),o=this._grpM.getMyUserID();o===t.ownerID&&(n.updateGroup({selfInfo:{role:D.GRP_MBR_ROLE_OWNER}}),n=(t=this._grpM.getGroupMemberHandler()).getLocalGroupMemberInfo(e,o),o=this._grpM.getLocalGroupProfile(e).ownerID,t=t.getLocalGroupMemberInfo(e,o),n&&n.updateRole(D.GRP_MBR_ROLE_OWNER),t&&t.updateRole(D.GRP_MBR_ROLE_MEMBER))}},{key:"_onMemberInfoModified",value:function(e){var t=e.to,n=(o=e.payload).groupProfile,o=o.memberList,i=n.groupID,s=(Dt(t)&&this._updateTopicMuteTime(e),this._grpM.getGroupMemberHandler());o.forEach((function(e){var t=s.getLocalGroupMemberInfo(i,e.userID);t&&je(e.muteTime)&&t.updateMuteUntil(e.muteTime)}))}},{key:"_updateTopicMuteTime",value:function(e){var t=e.to,n=(e=e.payload).groupProfile,o=void 0===(e=e.memberList)?[]:e,i=(e=this._grpM.get(10),n=n.groupID,e.getLocalTopic(n,t));if(i){for(var s=!1,a=0;a<o.length;a++){var r=o[a];if(r.userID===this._grpM.getMyUserID()&&0<=r.muteTime){i.updateSelfInfo({muteTime:r.muteTime}),s=!0;break}}s&&this._grpM.emitOEvt(E.TOPIC_UPDATED,{groupID:n,topic:i})}}},{key:"_onTopicProfileUpdated",value:function(e){var n=(o=e.payload).groupProfile.groupID,o=o.newTopicInfo;this._grpM.get(10).onTopicProfileUpdated(t({groupID:n,topicID:e.to},o))}},{key:"_cacheGroupTips",value:function(e,t){this._cachedGroupTipsMap.has(e)||this._cachedGroupTipsMap.set(e,[]),this._cachedGroupTipsMap.get(e).push(t)}},{key:"_deleteCachedGroupTips",value:function(e){this._cachedGroupTipsMap.has(e)&&this._cachedGroupTipsMap.delete(e)}},{key:"_notifyCachedGroupTips",value:function(e,t){var n=this,o=this._cachedGroupTipsMap.get(e)||[];Ne.l("".concat(this._n,"._notifyCachedGroupTips groupID:").concat(e," groupType:").concat(t," count:").concat(o.length)),o.forEach((function(e){n.onNewGroupTips(e)})),this._deleteCachedGroupTips(e)}},{key:"_cacheAndCompare",value:function(e){var t=e.groupID,n=e.event,o=e.item;e=e.groupType,Ne.l("".concat(this._n,"._cacheAndCompare groupID:").concat(t," groupType:").concat(e)),this._cacheGroupTips(t,{event:n,dataList:[o]}),n={groupID:t,type:e},e===D.GRP_AVCHATROOM?this._grpM.hasLocalGroup(t)?this._notifyCachedGroupTips(t,e):this._grpM.setUnjoinedAVChatRoom(t):(this._grpM.updateGroupMap([n]),this._notifyCachedGroupTips(t,e)),this._checkCountMap.has(t)||this._checkCountMap.set(t,0)}},{key:"reset",value:function(){this._cachedGroupTipsMap.clear(),this._checkCountMap.clear()}}]),is),vi=(s(os,[{key:"onCheckTimer",value:function(e){e%1==0&&0<this._cachedGroupMessageMap.size&&this._check()}},{key:"_check",value:function(){var e=this;this._cachedGroupMessageMap.forEach((function(t,n){var o=e._checkCountMap.get(n),i=e._grpM.hasLocalGroup(n);Ne.l("".concat(e._n,"._check groupID:").concat(n," hasLocalGroup:").concat(i," checkCount:").concat(o)),i?(e._notifyCachedGroupMessage(n),e._checkCountMap.delete(n),e._grpM.deleteUnjoinedAVChatRoom(n)):o>=e.MAX_CHECK_COUNT?(e._deleteCachedGroupMessage(n),e._checkCountMap.delete(n)):e._checkCountMap.set(n,++o)}))}},{key:"updateLastMsg",value:function(e){var n="".concat(this._n,".updateLastMsg");if(0!==this._grpM.getGroupMap().size){for(var o,i,s,a,r=!1,c=e.length,u=0;u<c;u++)(o=e[u]).type===D.CONV_GROUP&&0!==o.lastMessage.lastSequence&&null!==o.lastMessage.payload&&(i=o.conversationID.split(/^GROUP/)[1],(i=this._grpM.getLocalGroupProfile(i))&&(s=i.lastMessage,a=o.lastMessage,JSON.stringify(s)!==JSON.stringify(a)&&(i.lastMessage=t({},o.lastMessage),r=!0)));Ne.l("".concat(n," convCount:").concat(c," groupCount:").concat(this._grpM.getLocalGroupList().length," isUpdated:").concat(r)),r&&(this._grpM.sortLocalGroupList(),this._grpM.emitGroupListUpdate(!0,!1))}else this.tempConversationList=e}},{key:"onNewMessage",value:function(e){var t,n=(t=this._assembly(e)).conversationOptionsList,o=t.messageList;0<(0<(0<(t=t.AVChatRoomMessageList).length&&this._grpM.onAVChatRoomMessage(t),t=yt(o)).length&&this._grpM.emitOEvt(E.MESSAGE_MODIFIED,t),0<n.length&&(this._grpM.get(11).onNewMessage({conversationOptionsList:n,isInstantMessage:!1!==e.isInstantMessage,updateUnreadCount:!1!==e.updateUnreadCount}),this._grpM.updateNextMessageSeq(n)),t=Ct(o)).length&&this._grpM.emitOEvt(E.MESSAGE_RECEIVED,t),o.length=0}},{key:"_assembly",value:function(e){var t=e.dataList,n=e.event,o=e.isInstantMessage,i=null,s=[],a=[],r=[],c={},u=this._grpM.getFileDownloadProxy(),l=this._grpM.getDowloadFileAuthKey(),d=this._grpM.get(17).getFileDNList(),p=t.length;1<p&&t.sort((function(e,t){return e.sequence-t.sequence}));for(var _=this._grpM.get(11),h=this._grpM.get(4),g=0;g<p;g++){var f,m=ut(t[g]),v=(C=m.groupProfile).groupID,I=void 0===(I=C.communityType)?0:I,y=void 0===(y=C.topicID)?void 0:y,M=C.invisible,C=void 0===(C=C.groupType)?void 0:C,T=void 0,E=this._grpM.isMessageFromTopic(I,y),R=(E&&(T=D.CONV_TOPIC,m.to=y),this._grpM.hasLocalGroup(v));!R&&this._grpM.isUnjoinedAVChatRoom(v)||(R||E?this._grpM.isMessageFromOrToAVChatroom(v)?(m.event=n,r.push(m)):(m.currentUser=this._grpM.getMyUserID(),m.conversationType=D.CONV_GROUP,m.isSystemMessage=!!m.isSystemMessage,(i=new ko(m)).setElement(m.elements,u,l,d),1!==M?(R=1===t[g].isModified,_.isMessageSentByCurrentInstance(i)?i.isModified=R:R=!1,1===m.onlineOnlyFlag?(i._onlineOnlyFlag=!0,_.isMessageSentByCurrentInstance(i)||a.push(i)):this._grpM.isMessageFromCommunityOfTopic(I,y)?a.push(i):(i.from!==this._grpM.getMyUserID()||(E=_.getLatestMessageSentByMe(i.conversationID))&&(M=E.nick,I=E.avatar,M===i.nick&&I===i.avatar||(_.modifyMessageSentByMe({conversationID:f,latestNick:i.nick,latestAvatar:i.avatar}),h.mockOnNickAvatarModified(i.nick,i.avatar))),_.pushIntoMessageList(a,i,R)&&(this._qualityStat(o,i),f=(y=i).conversationID,E=y.sequence,M=_.isRemoteRead({conversationID:f,sequence:E}),pt(c[f])?(I=0,"in"===i.flow&&(i._isExcludedFromUnreadCount||M||(I=1)),c[f]=s.push({conversationID:f,unreadCount:I,type:pt(T)?i.conversationType:T,subType:i.conversationSubType,lastMessage:i._isExcludedFromLastMessage?"":i})-1):(s[R=c[f]].type=pt(T)?i.conversationType:T,s[R].subType=i.conversationSubType,s[R].lastMessage=i._isExcludedFromLastMessage?"":i,"in"===i.flow&&(i._isExcludedFromUnreadCount||M||s[R].unreadCount++))))):this._qualityStat(o,i)):this._cacheAndCompare({groupID:v,event:n,item:m,groupType:C}))}return{conversationOptionsList:s,messageList:a,AVChatRoomMessageList:r}}},{key:"_qualityStat",value:function(e,t){var n=this._grpM.get(26);n.addMessageSequence({key:Zn,message:t}),e&&0<t.clientTime&&n.addMessageDelay(t.clientTime)}},{key:"onMsgRevoked",value:function(e,t){var n=this,o=this._grpM.get(11),i=[],s=[];e.dataList.forEach((function(e){var t=e.elements.revokedInfos,n=e.revokerInfo,a=e.groupProfile,r=!1;a&&(r=Et({groupID:a.groupID})||!He(a.topicID)),pt(t)||t.forEach((function(e){var t,c=He(e.topicID)?"GROUP".concat(e.groupID):"GROUP".concat(e.topicID),u=o.getLocalConversation(c),l=e.revokerInfo&&e.revokerInfo.revoker||n&&n.revoker,d=n&&n.reason||"";u&&Tt(u.type)?t={conversationID:c,sequence:e.sequence,ID:"".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)}:(u=o.revoke(c,e.sequence,e.random))?t=u:(t={conversationID:c,sequence:e.sequence},e.tinyID&&e.clientTime&&e.random&&(t.ID="".concat(e.tinyID,"-").concat(e.clientTime,"-").concat(e.random)),e.time&&(t.time=e.time)),t&&(t.revoker=l,t.revokeReason=d,t.revokerInfo={userID:l,nick:"",avatar:""},r?(t.revokerInfo.nick=a.nick,t.revokerInfo.avatar=a.avatar,i.push(t)):s.push(t))}))})),0===s.length&&0===i.length||(o.onMessageRevoked([].concat(i,s),t),0<i.length&&this._grpM.emitOEvt(E.MESSAGE_REVOKED,i),0<s.length&&o.updateRevokerInfo(s).then((function(e){n._grpM.emitOEvt(E.MESSAGE_REVOKED,e)})))}},{key:"_groupListTreeShaking",value:function(e){for(var t=new Map(m(this._grpM.getGroupMap())),n=0,o=e.length;n<o;n++)t.delete(e[n].groupID);this._grpM.hasJoinedAVChatRoom()&&this._grpM.getJoinedAVChatRoom().forEach((function(e){t.delete(e)})),this._grpM.getGroupMap().forEach((function(e,n){e.isSupportTopic&&t.delete(n)}));for(var i=m(t.keys()),s=0,a=i.length;s<a;s++)this._grpM.deleteGroup(i[s])}},{key:"syncGroupList",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],n=(this._pagingStatus===On&&this._grpM.clearGroupMap(),m(w)),o=this.PAGING_GRP_COUNT_LIMIT,i=[];if(!0===t)return this._pagingGetGroupListWithTopic({limit:o,offset:0,groupBaseInfoFilter:n,groupList:i});t="syncGroupList";var s="".concat(this._n,".").concat(t),a=new so(t);return this._pagingGetGroupList({limit:o,offset:0,groupBaseInfoFilter:n,groupList:i}).then((function(){var t=jt(e._pagingGetCostList),n=Yt(e._pagingGetCostList),o=(e._pagingGetCostList.length=0,e._pagingStatus=Pn,e._groupListTreeShaking(i),e._grpM.updateGroupMap(i),e._grpM.getLocalGroupList().length);return o="count:".concat(o," sum:").concat(n," avg:").concat(t),Ne.l("".concat(s," ok. ").concat(o)),a.setMessage(o).end(),e.tempConversationList&&(e.updateLastMsg(e.tempConversationList),e.tempConversationList=null),e._grpM.emitGroupListUpdate(!0,!0),En({groupList:e._grpM.getLocalGroupList()})})).catch((function(t){return e._pagingStatus=Gn,a.setError(t).end(),Ne.e("".concat(s," failed. error:"),t),Rn(t)}))}},{key:"getGroupList",value:function(){var e=this,t="".concat(this._n,".").concat("getGroupList");if(Ne.l("".concat(t," pagingStatus:").concat(this._pagingStatus)),this._pagingStatus===Gn||this._pagingStatus===On)return this.syncGroupList().then((function(){return En({groupList:e._grpM.getLocalGroupList(),isSyncCompleted:e.isPagingGetCompleted()})})).catch((function(e){return Ne.e("".concat(t," failed. error:"),e),Rn(e)}));var n=this._grpM.getLocalGroupList();return Ne.l("".concat(t,". returned group count:").concat(n.length)),Dn({groupList:n,isSyncCompleted:this.isPagingGetCompleted()})}},{key:"isPagingGetCompleted",value:function(){return this._pagingStatus===Pn}},{key:"_pagingGetGroupList",value:function(e){var t=this,n="".concat(this._n,".").concat("_pagingGetGroupList"),o=e.isCommunityRelay,i=void 0!==o&&o,s=e.limit,a=e.offset,r=e.groupBaseInfoFilter,c=e.groupList,u=Date.now();return this._grpM.req({P:Kn.GET_GRP_LIST,data:{type:i?D.GRP_COMMUNITY:void 0,memberAccount:this._grpM.getMyUserID(),limit:s,offset:a,responseFilter:{groupBaseInfoFilter:r,selfInfoFilter:["Role","JoinTime","MsgFlag","MsgSeq"]}}}).then((function(e){var o=void 0===(o=(e=e.data).groups)?[]:o,l=(e=e.totalCount,c.push.apply(c,m(o)),t._handleGroupAtInfoWithoutTopic(i,o),!((o=a+s)<e));return e="offset:".concat(a," limit:").concat(s," total:").concat(e," isCompleted:").concat(l," ")+"current:".concat(c.length," isCommunityRelay:").concat(i),t._pagingGetCostList.push(Jt(u,!1)),Ne.l("".concat(n," ok. ").concat(e," cost:").concat(Jt(u))),i||l?!i&&l?(Ne.l("".concat(n," start to get community list")),a=0,t._pagingGetGroupList({limit:s,offset:a,groupBaseInfoFilter:r,groupList:c,isCommunityRelay:!0})):i&&!l?(a=o,t._pagingGetGroupList({limit:s,offset:a,groupBaseInfoFilter:r,groupList:c,isCommunityRelay:!0})):En({groupList:c}):(a=o,t._pagingGetGroupList({limit:s,offset:a,groupBaseInfoFilter:r,groupList:c}))})).catch((function(e){return 10018===e.code?(Ne.w("".concat(t.logPrefix," response size exceeds the limit, request count:").concat(s)),s=50,t._pagingGetGroupList({limit:s,offset:a,groupBaseInfoFilter:r,groupList:c,isCommunityRelay:i})):i?(11e3===e.code&&Ne.l("".concat(n," ok. community unavailable")),Dn({groupList:c})):Rn(e)}))}},{key:"_pagingGetGroupListWithTopic",value:function(e){var t=this,n="".concat(this._n,"._pagingGetGroupListWithTopic"),o=e.limit,i=e.offset,s=e.groupBaseInfoFilter,a=e.groupList,r=Date.now();return this._grpM.req({P:Kn.GET_GRP_LIST,data:{type:D.GRP_COMMUNITY,memberAccount:this._grpM.getMyUserID(),limit:o,offset:i,responseFilter:{groupBaseInfoFilter:s,selfInfoFilter:m(F)},isSupportTopic:1,needAppDefineData:1}}).then((function(e){var c=(e=e.data).groups,u=(e=e.totalCount,a.push.apply(a,m(void 0===c?[]:c)),!((c=i+o)<e));return Ne.l("".concat(n," ok. offset:").concat(i," limit:").concat(o," totalCount:").concat(e," isCompleted:").concat(u," currentCount:").concat(a.length," cost:").concat(Jt(r))),u?(t._grpM.updateGroupMap(a),t._grpM.emitGroupListUpdate(!0,!1),En({groupList:e=t._grpM.getLocalGroupList().filter((function(e){return!0===e.isSupportTopic}))})):(i=c,t._pagingGetGroupListWithTopic({limit:o,offset:i,groupBaseInfoFilter:s,groupList:a}))})).catch((function(e){return 10018===e.code?(Ne.w("".concat(t.logPrefix," response size exceeds the limit, request count:").concat(o)),o=50,t._pagingGetGroupListWithTopic({limit:o,offset:i,groupBaseInfoFilter:s,groupList:a})):Rn(e)}))}},{key:"_cacheGroupMessage",value:function(e,t){this._cachedGroupMessageMap.has(e)||this._cachedGroupMessageMap.set(e,[]),this._cachedGroupMessageMap.get(e).push(t)}},{key:"_deleteCachedGroupMessage",value:function(e){this._cachedGroupMessageMap.has(e)&&this._cachedGroupMessageMap.delete(e)}},{key:"_notifyCachedGroupMessage",value:function(e,t){var n=this,o=this._cachedGroupMessageMap.get(e)||[];Ne.l("".concat(this._n,"._notifyCachedGroupMessage groupID:").concat(e," groupType:").concat(t," count:").concat(o.length)),o.forEach((function(e){n.onNewMessage(e)})),this._deleteCachedGroupMessage(e)}},{key:"_cacheAndCompare",value:function(e){var t=e.groupID,n=e.event,o=e.item;e=e.groupType,Ne.l("".concat(this._n,"._cacheAndCompare groupID:").concat(t," groupType:").concat(e)),this._cacheGroupMessage(t,{event:n,dataList:[o]}),n={groupID:t,type:e},e===D.GRP_AVCHATROOM?this._grpM.hasLocalGroup(t)?this._notifyCachedGroupMessage(t,e):this._grpM.setUnjoinedAVChatRoom(t):(this._grpM.updateGroupMap([n]),this._notifyCachedGroupMessage(t,e)),this._checkCountMap.has(t)||this._checkCountMap.set(t,0)}},{key:"_handleGroupAtInfoWithoutTopic",value:function(e,n){var o=this;e&&0!==n.length&&n.forEach((function(e){var n=e.groupID,i=(e=e.groupAtInfoList,[]);pt(e)||(e.forEach((function(e){i.push(t(t({},e),{},{groupID:n}))})),o._grpM.get(11).onNewGroupAtTips({dataList:i}))}))}},{key:"setPagingGroupCount",value:function(e){pt(e)||(this.PAGING_GRP_COUNT_LIMIT=parseInt(e,10))}},{key:"reset",value:function(){this.PAGING_GRP_COUNT_LIMIT=200,this._cachedGroupMessageMap.clear(),this._checkCountMap.clear(),this._pagingStatus=On,this._pagingGetCostList=[]}}]),os),Ii=(s(ns,[{key:"_onCloudConfig",value:function(){var e=this._grpM.getCloudConfig("grp_attr_cache_time");pt(e)||(this.CACHE_EXPIRE_TIME=Number(e))}},{key:"updateLocalMainSequenceOnReconnected",value:function(){this._groupAttributesMap.forEach((function(e){e.localMainSequence=0}))}},{key:"isGroupAttributesUpdatedNotice",value:function(e){var t=e.to,n=(e=e.elements.newGroupProfile,!pt(e)&&!He(e.groupAttributeOption));return n&&this._onGroupAttributesUpdated({groupID:t,groupAttributeOption:e.groupAttributeOption}),n}},{key:"_onGroupAttributesUpdated",value:function(e){var t=this,n=e.groupID,o=(e=e.groupAttributeOption).mainSequence,i=e.isWithChangedAttributeInfo,s=void 0===(s=e.groupAttributeList)?[]:s;if(e=e.operationType,Ne.l("".concat(this._n,".onGroupAttributesUpdated. ")+"groupID:".concat(n," isWithChangedAttributeInfo:").concat(i," operationType:").concat(e)),!pt(e)){this._groupAttributesCopy=this._getCachedAttributes({groupID:n});var a=o-this._getLocalGroupAttributes(n).localMainSequence;if(0!=a){if(1===i&&1==a)return this._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:o,groupAttributeList:s,operationType:e}),void this._emitGroupAttributesUpdated(n);this._hasLocalGroupAttributes(n)&&(i=this._getLocalGroupAttributes(n).avChatRoomKey,this._getGroupAttributes({groupID:n,avChatRoomKey:i}).then((function(){t._emitGroupAttributesUpdated(n)})))}}}},{key:"initGroupAttributesCache",value:function(e){var t=e.groupID;e=void 0===(e=e.avChatRoomKey)?void 0:e,this._groupAttributesMap.set(t,{lastUpdateTime:0,localMainSequence:0,remoteMainSequence:0,attributes:new Map,avChatRoomKey:e}),Ne.l("".concat(this._n,".initGroupAttributesCache groupID:").concat(t," avChatRoomKey:").concat(e))}},{key:"initGroupAttributes",value:function(e){var t=this,n=e.groupID,o=e.groupAttributes,i=(e=this._getLocalGroupAttributes(n)).remoteMainSequence,s=(e=e.avChatRoomKey,new so("initGroupAttributes"));return s.setMessage("groupID:".concat(n," avChatRoomKey:").concat(e," mainSequence:").concat(i)),this._grpM.req({P:Kn.SET_GRP_ATTR,data:{groupID:n,avChatRoomKey:e,mainSequence:i,groupAttributeList:this._transformGroupAttributes(o)}}).then((function(e){Ne.l("".concat(t._n,".").concat("initGroupAttributes"," ok. groupID:").concat(n));var i=(e=e.data).mainSequence;return(e=m(e.groupAttributeList)).forEach((function(e){e.value=o[e.key]})),t._groupAttributesCopy=t._getCachedAttributes({groupID:n}),t._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:i,groupAttributeList:e,operationType:1}),t._emitGroupAttributesUpdated(n),s.end(),En({groupAttributes:o})})).catch((function(e){return s.setError(e).end(),Rn(e)}))}},{key:"setGroupAttributes",value:function(e){var t=this,n="".concat(this._n,".").concat("setGroupAttributes"),o=e.groupID,i=e.groupAttributes,s=(e=this._getLocalGroupAttributes(o)).remoteMainSequence,a=e.avChatRoomKey,r=e.attributes,c=((e=this._transformGroupAttributes(i)).forEach((function(e){var t=e.key;e.sequence=0,r.has(t)&&(e.sequence=r.get(t).sequence)})),new so("setGroupAttributes"));return c.setMessage("groupID:".concat(o," groupAttributes:").concat(JSON.stringify(i))),Ne.l("".concat(n,". groupID:").concat(o," mainSequence:").concat(s)),this._grpM.req({P:Kn.MODIFY_GRP_ATTR,data:{groupID:o,avChatRoomKey:a,mainSequence:s,groupAttributeList:e}}).then((function(e){Ne.l("".concat(n," ok."));var s=(e=e.data).mainSequence;return(e=m(e.groupAttributeList)).forEach((function(e){e.value=i[e.key]})),t._groupAttributesCopy=t._getCachedAttributes({groupID:o}),t._refreshCachedGroupAttributes({groupID:o,remoteMainSequence:s,groupAttributeList:e,operationType:2}),t._emitGroupAttributesUpdated(o),c.end(),En({groupAttributes:i})})).catch((function(e){return c.setError(e).end(),Rn(e)}))}},{key:"deleteGroupAttributes",value:function(e){var t=this,n=e.groupID,o=(e=void 0===(e=e.keyList)?[]:e,(r=this._getLocalGroupAttributes(n)).remoteMainSequence),i=r.avChatRoomKey,s=r.attributes,a=m(s.keys()),r=Kn.CLEAR_GRP_ATTR,c=3,u=(i={groupID:n,avChatRoomKey:i,mainSequence:o},[]),l=(0<e.length&&(a=[],r=Kn.DEL_GRP_ATTR,c=4,e.forEach((function(e){var t=0;s.has(e)&&(t=s.get(e).sequence,a.push(e)),u.push({key:e,sequence:t})})),i.groupAttributeList=u),new so("deleteGroupAttributes"));return l.setMessage("groupID:".concat(n," mainSequence:").concat(o," keyList:").concat(e," proto:").concat(r)),this._grpM.req({P:r,data:i}).then((function(e){return Ne.l("".concat(t._n,".").concat("deleteGroupAttributes"," ok. groupID:").concat(n)),e=e.data.mainSequence,t._groupAttributesCopy=t._getCachedAttributes({groupID:n}),t._refreshCachedGroupAttributes({groupID:n,remoteMainSequence:e,groupAttributeList:u,operationType:c}),t._emitGroupAttributesUpdated(n),l.end(),En({keyList:a})})).catch((function(e){return l.setError(e).end(),Rn(e)}))}},{key:"getGroupAttributes",value:function(e){var t=this,n="".concat(this._n,".").concat("getGroupAttributes"),o=e.groupID,i=(r=this._getLocalGroupAttributes(o)).avChatRoomKey,s=r.lastUpdateTime,a=r.localMainSequence,r=r.remoteMainSequence,c=new so("getGroupAttributes");return c.setMessage("groupID:".concat(o," localMainSequence:").concat(a," remoteMainSequence:").concat(r," keyList:").concat(e.keyList)),Date.now()-s>=this.CACHE_EXPIRE_TIME||a<r?this._getGroupAttributes({groupID:o,avChatRoomKey:i}).then((function(i){return c.setMoreMessage("get attributes from remote. count:".concat(i.length)).end(),Ne.l("".concat(n," from remote. groupID:").concat(o)),En({groupAttributes:i=t._getCachedAttributes(e)})})).catch((function(e){return c.setError(e).end(),Rn(e)})):(c.setMoreMessage("get attributes from cache").end(),Ne.l("".concat(n," from cache. groupID:").concat(o)),Dn({groupAttributes:s=this._getCachedAttributes(e)}))}},{key:"_getGroupAttributes",value:function(e){var n=this,o=0;return pt(e.avChatRoomKey)||(o=1),this._grpM.req({P:Kn.GET_GRP_ATTR,data:t(t({},e),{},{groupType:o})}).then((function(t){Ne.l("".concat(n._n,"._getGroupAttributes ok. groupID:").concat(e.groupID));var o=(t=t.data).mainSequence,i=m(t=t.groupAttributeList);return pt(o)||n._refreshCachedGroupAttributes({groupID:e.groupID,remoteMainSequence:o,groupAttributeList:i,operationType:5}),t})).catch((function(e){return Rn(e)}))}},{key:"_refreshCachedGroupAttributes",value:function(e){var t=e.groupID,n=e.remoteMainSequence,o=e.groupAttributeList;if(e=e.operationType,this._hasLocalGroupAttributes(t)){var i=this._getLocalGroupAttributes(t),s=i.localMainSequence;if(5===e||n-s==1)i.remoteMainSequence=n,i.localMainSequence=n,i.lastUpdateTime=Date.now(),this._updateCachedAttributes({groupAttributes:i,groupAttributeList:o,operationType:e});else{if(s===n)return;i.remoteMainSequence=n}this._groupAttributesMap.set(t,i),o="operationType:".concat(e," localMainSequence:").concat(s," remoteMainSequence:").concat(n),Ne.l("".concat(this._n,"._refreshCachedGroupAttributes. ").concat(o))}}},{key:"_getCachedAttributes",value:function(e){var t=e.groupID,n=(e=void 0===(e=e.keyList)?[]:e,{});if(this._hasLocalGroupAttributes(t)){var o=this._getLocalGroupAttributes(t).attributes;if(0<e.length)e.forEach((function(e){o.has(e)&&(n[e]=o.get(e).value)}));else{var i,s=T(o.keys());try{for(s.s();!(i=s.n()).done;){var a=i.value;n[a]=o.get(a).value}}catch(e){s.e(e)}finally{s.f()}}}return n}},{key:"_updateCachedAttributes",value:function(e){var t=e.groupAttributes,n=e.groupAttributeList;3!==(e=e.operationType)?4!==e?(1===e&&t.attributes.clear(),n.forEach((function(e){var n=e.key,o=e.value;e=e.sequence,t.attributes.set(n,{value:o,sequence:e})}))):n.forEach((function(e){t.attributes.delete(e.key)})):t.attributes.clear()}},{key:"_hasLocalGroupAttributes",value:function(e){return this._groupAttributesMap.has(e)}},{key:"_getLocalGroupAttributes",value:function(e){return this._hasLocalGroupAttributes(e)||this.initGroupAttributesCache({groupID:e}),this._groupAttributesMap.get(e)}},{key:"_transformGroupAttributes",value:function(e){var t=[];return Object.keys(e).forEach((function(n){t.push({key:n,value:e[n]})})),t}},{key:"_emitGroupAttributesUpdated",value:function(e){var t=this._getCachedAttributes({groupID:e}),n=(o=this._computeAttrChangedInfo(t)).updatedKeyList,o=o.deletedKeyList;Ne.l("".concat(this._n,"._emitGroupAttributesUpdated update:").concat(n.length,", delete:").concat(o.length)),0===n.length&&0===o.length||this._grpM.emitOEvt(E.GROUP_ATTRIBUTES_UPDATED,{groupID:e,groupAttributes:t,updatedKeyList:n,deletedKeyList:o})}},{key:"_computeAttrChangedInfo",value:function(e){var t=this,n=[],o=[];return Object.keys(e).forEach((function(o){e[o]!==t._groupAttributesCopy[o]&&n.push(o)})),Object.keys(this._groupAttributesCopy).forEach((function(t){pt(e[t])&&o.push(t)})),this._groupAttributesCopy={},{updatedKeyList:n,deletedKeyList:o}}},{key:"deleteLocalGroupAttributes",value:function(e){this._hasLocalGroupAttributes(e)&&this._groupAttributesMap.delete(e)}},{key:"reset",value:function(){this._groupAttributesMap.clear(),this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4}}]),ns),yi=(s(ts,[{key:"_onCloudConfig",value:function(){var e=this._grpM.getCloudConfig("grp_counter_expire_time");pt(e)||(this.EXPIRE_TIME=Number(e))}},{key:"isGroupCountersNotice",value:function(e){var t=e.to,n=!1;return He(e=e.elements.groupCounterInfo)||(this._onGroupCountersUpdated({groupID:t,groupCounterInfo:e}),n=!0),n}},{key:"_onGroupCountersUpdated",value:function(e){var t=this,n=e.groupID;e.groupCounterInfo.forEach((function(e){var o=e.type,i=e.groupCounterSeq;e=void 0===(e=e.counterList)?[]:e,0!==o&&2!==o||(t._updateLocalGroupCounters({groupID:n,groupCounterSeq:i,counterList:e}),e.forEach((function(e){t._grpM.emitOEvt(E.GROUP_COUNTER_UPDATED,{groupID:n,key:e.key,value:e.value})}))),1===o&&t._deleteLocalGroupCounters({groupID:n,groupCounterSeq:i,counterList:e})})),Ne.l("".concat(this._n,"._onGroupCountersUpdated groupID:").concat(n))}},{key:"initGroupCountersCache",value:function(e){var t=e.groupID;e=e.avChatRoomKey,this._groupCountersMap.set(t,{lastUpdateTime:0,groupCounterSeq:0,counters:new Map,avChatRoomKey:e}),Ne.l("".concat(this._n,".initGroupCountersCache groupID:").concat(t," avChatRoomKey:").concat(e))}},{key:"setGroupCounters",value:function(e){if(!this._grpM.canIUse(U.GRP_COUNTER))return this._grpM.noUse("setGroupCounters");var t="".concat(this._n,".").concat("setGroupCounters"),n=e.groupID,o=(e=e.counters,e=this._convertObjectToList(e),this._getLocalGroupCounters(n).avChatRoomKey),i="groupID:".concat(n," count:").concat(e.length),s=new so("setGroupCounters");return s.setMessage("".concat(i)),Ne.l("".concat(t,". ").concat(i)),this._updateGroupCounters({groupID:n,counterList:e,avChatRoomKey:o,mode:"Set"}).then((function(e){return s.end(),Ne.l("".concat(t," ok.")),En({counters:e})})).catch((function(e){return s.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"increaseGroupCounter",value:function(e){var t="increaseGroupCounter";if(!this._grpM.canIUse(U.GRP_COUNTER))return this._grpM.noUse(t);var n="".concat(this._n,".").concat(t),o=e.groupID,i=e.key,s=(e=e.value,this._getLocalGroupCounters(o).avChatRoomKey),a="groupID:".concat(o," key:").concat(i," value:").concat(e),r=new so(t);return r.setMessage("".concat(a)),Ne.l("".concat(n,". ").concat(a)),this._updateGroupCounters({groupID:o,counterList:[{key:i,value:e}],avChatRoomKey:s,mode:"Increase"}).then((function(e){return r.end(),Ne.l("".concat(n," ok.")),En({counters:e})})).catch((function(e){return r.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"decreaseGroupCounter",value:function(e){var t="decreaseGroupCounter";if(!this._grpM.canIUse(U.GRP_COUNTER))return this._grpM.noUse(t);var n="".concat(this._n,".").concat(t),o=e.groupID,i=e.key,s=(e=e.value,this._getLocalGroupCounters(o).avChatRoomKey),a="groupID:".concat(o," key:").concat(i," value:").concat(e),r=new so(t);return r.setMessage("".concat(a)),Ne.l("".concat(n,". ").concat(a)),this._updateGroupCounters({groupID:o,counterList:[{key:i,value:e}],avChatRoomKey:s,mode:"Decrease"}).then((function(e){return r.end(),Ne.l("".concat(n," ok.")),En({counters:e})})).catch((function(e){return r.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"getGroupCounters",value:function(e){var t=this;if(!this._grpM.canIUse(U.GRP_COUNTER))return this._grpM.noUse("getGroupCounters");var n="".concat(this._n,".").concat("getGroupCounters"),o=e.groupID,i=void 0===(e=e.keyList)?[]:e,s=(e=this._getLocalGroupCounters(o)).avChatRoomKey,a=(e=e.lastUpdateTime,new so("getGroupCounters"));return a.setMessage("groupID:".concat(o)),Date.now()-e>=this.EXPIRE_TIME?this._getRemoteGroupCounters({groupID:o,avChatRoomKey:s}).then((function(e){return a.setMoreMessage("from remote. count:".concat(e.length)).end(),Ne.l("".concat(n," from remote. groupID:").concat(o)),En({counters:e=t._getLocalCounters(o,i)})})).catch((function(e){return a.setError(e).end(),Rn(e)})):(a.setMoreMessage("from cache").end(),Ne.l("".concat(n," from cache. groupID:").concat(o)),Dn({counters:e=this._getLocalCounters(o,i)}))}},{key:"_getRemoteGroupCounters",value:function(e){var n=this;return this._grpM.req({P:Kn.GET_GRP_COUNTER,data:t({},e)}).then((function(t){var o=void 0===(o=(t=t.data).counterList)?[]:o;return t=t.groupCounterSeq,n._updateLocalGroupCounters({groupID:e.groupID,counterList:o,groupCounterSeq:t}),Ne.l("".concat(n._n,"._getRemoteGroupCounters ok. groupID:").concat(e.groupID)),o})).catch((function(e){return Rn(e)}))}},{key:"_convertObjectToList",value:function(e){var t=[];return Object.keys(e).forEach((function(n){t.push({key:n,value:e[n]})})),t}},{key:"_updateGroupCounters",value:function(e){var n="".concat(this._n,"._updateGroupCounters"),o=e.groupID,i=e.avChatRoomKey,s=e.mode;return Ne.l("".concat(n,". groupID:").concat(o," avChatRoomKey:").concat(i," mode:").concat(s)),this._grpM.req({P:Kn.UPDATE_GRP_COUNTER,data:t({},e)}).then((function(e){Ne.l("".concat(n," ok.")),e=e.data.counterList;var t={};return(void 0===e?[]:e).forEach((function(e){var n=e.key;e=e.value,t[n]=e})),t})).catch((function(e){return Rn(e)}))}},{key:"_hasLocalGroupCounters",value:function(e){return this._groupCountersMap.has(e)}},{key:"_getLocalGroupCounters",value:function(e){return this._hasLocalGroupCounters(e)||this.initGroupCountersCache({groupID:e}),this._groupCountersMap.get(e)}},{key:"_updateLocalGroupCounters",value:function(e){var t,n,o,i=e.groupID,s=void 0===(s=e.counterList)?[]:s;e=e.groupCounterSeq,this._hasLocalGroupCounters(i)&&(o=this._getLocalGroupCounters(i),t=o.counters,n=o.avChatRoomKey,o=o.groupCounterSeq,0<e&&e<o||(s.forEach((function(e){var n=e.key;e=e.value,t.set(n,e)})),this._groupCountersMap.set(i,{lastUpdateTime:Date.now(),groupCounterSeq:e,counters:t,avChatRoomKey:n})))}},{key:"_deleteLocalGroupCounters",value:function(e){var t,n,o=e.groupID,i=void 0===(i=e.counterList)?[]:i;e=e.groupCounterSeq,this._hasLocalGroupCounters(o)&&(n=this._getLocalGroupCounters(o),t=n.counters,n=n.avChatRoomKey,i.forEach((function(e){t.delete(e.key)})),this._groupCountersMap.set(o,{lastUpdateTime:Date.now(),groupCounterSeq:e,counters:t,avChatRoomKey:n}))}},{key:"_getLocalCounters",value:function(e,t){var n={};if(!this._hasLocalGroupCounters(e))return n;var o=this._getLocalGroupCounters(e).counters;if(0<t.length)t.forEach((function(e){o.has(e)&&(n[e]=o.get(e))}));else{var i,s=T(o.keys());try{for(s.s();!(i=s.n()).done;){var a=i.value;n[a]=o.get(a)}}catch(e){s.e(e)}finally{s.f()}}return n}},{key:"reset",value:function(){this._groupCountersMap.clear(),this.EXPIRE_TIME=3e4}}]),ts),Mi=(s(es,[{key:"start",value:function(){var e=this._grpM.isLoggedIn();e||(this._proto=Kn.AV_NOAUTH_POLLING),Ne.l("".concat(this._n,".start pollingInterval:").concat(this._manager.getPollingInterval()," isLoggedIn:").concat(e)),this._isRunning=!0,this._request()}},{key:"isRunning",value:function(){return this._isRunning}},{key:"_request",value:function(){var e=this,t=this._onInit(this._groupID);this._grpM.req({P:this._proto,data:t}).then((function(t){e._onSuccess(e._groupID,t),e.isRunning()&&(-1<e._timeoutID&&clearTimeout(e._timeoutID),e._timeoutID=setTimeout(e._request.bind(e),e._manager.getPollingInterval()))})).catch((function(t){e._onFail(e._groupID,t),e.isRunning()&&(-1<e._timeoutID&&clearTimeout(e._timeoutID),e._timeoutID=setTimeout(e._request.bind(e),e._manager.MAX_POLLING_INTERVAL))}))}},{key:"stop",value:function(){Ne.l("".concat(this._n,".stop")),-1<this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=-1),this._isRunning=!1}},{key:"getPollingTimerID",value:function(){return this._timeoutID}}]),es),Ci={3:!0,4:!0,5:!0,6:!0,17:!0,20:!0,21:!0,100:!0},Ti=(s($i,[{key:"hasJoinedAVChatRoom",value:function(){var e=[];return 0<(e=0<this._joinedGroupMap.size?m(this._joinedGroupMap.values()).filter((function(e){return e.type===D.GRP_AVCHATROOM})):e).length}},{key:"getJoinedLiveList",value:function(){var e=[];return 0<this._joinedGroupMap.size?m(this._joinedGroupMap.values()).filter((function(e){return e.type===D.GRP_LIVE})):e}},{key:"checkJoinedAVChatRoomByID",value:function(e){return this._joinedGroupMap.has(e)}},{key:"getJoinedAVChatRoom",value:function(){return 0<this._joinedGroupMap.size?m(this._joinedGroupMap.keys()):[]}},{key:"_updatedata",value:function(e){var n=this._pollingRequestInfoMap.get(e);return e===m(this._pollingInstanceMap.keys())[0]?t(t({},n),{},{startBroadcastSeq:this._startBroadcastSeq,simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG}):t(t({},n),{},{simplifiedMessage:this.DEFAULT_POLLING_SIMPLIFIED_MSG})}},{key:"_handleSuccess",value:function(e,t){var n,o=(c=t.data).key,i=c.nextSeq,s=c.rspMsgList,a=c.errorCode,r=c.nextBroadcastSeq,c=c.broadcastMessageList;0!==a?(a=this._pollingRequestInfoMap.get(e),n=new so("longPollingAVError"),a=a?"".concat(a.key,"-").concat(a.startSeq):"requestInfo is undefined",n.setMessage("".concat(e,"-").concat(a,"-").concat(t.errorInfo)).setCode(t.errorCode).end(!0)):this.checkJoinedAVChatRoomByID(e)&&(dt(o)&&je(i)&&this._pollingRequestInfoMap.set(e,{key:o,startSeq:i}),je(r)&&r>this._startBroadcastSeq&&(this._startBroadcastSeq=r),Xe(s)&&0<s.length?(s.forEach((function(e){e.to=e.groupID})),this.onMessage(s,e)):(this._pollingNoMessageCount+=1,this._pollingNoMessageCount===this.DEFAULT_POLLING_NO_MESSAGE_COUNT&&(this._pollingInterval=this.DEFAULT_POLLING_INTERVAL+this.DEFAULT_POLLING_INTERVAL_PLUS)),this._onBroadcastMessage(c))}},{key:"_handleFailure",value:function(e,t){}},{key:"onMessage",value:function(e,t){if(Xe(e)&&0!==e.length){var n="".concat(this._n,".onMessage"),o=(t&&(n+=" groupID:".concat(t)),0!==this._pollingNoMessageCount&&(this._pollingNoMessageCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL),null),i=[],s=this._get(11),a=this._get(26),r=e.length,c=(1<r&&e.sort((function(e,t){return e.sequence-t.sequence})),this._get(12).isUnlimitedAVChatRoom()),u=!1;Ne.getLevel()<=0&&(t=e.map((function(e){return e.sequence})),Ne.l("".concat(n," count:").concat(t.length," sequenceList:").concat(t)),t.length=0);for(var l=0;l<r;l++){var d=this.restoreMessageFromSimplified(e[l]);if(Ci[d.event]){if(6===d.event){if(this._grpM.isGroupAttributesUpdatedNotice(d))continue;if(this._grpM.isGroupCountersNotice(d))continue}if(20!==d.event)if(21!==d.event)if(100!==d.event){o=this.packMessage(d,d.event);var p=1===d.isModified;if(u=1===d.isHistoryMessage,!c){if(this._seqSll.has(o.sequence))continue;this._seqSll.set(o.sequence)}var _=this._IDSll.has(o.ID);_?Ne.w("".concat(n," ID:").concat(o.ID," has:").concat(_)):(this._IDSll.set(o.ID),_=!1,!u&&this._isMessageSentByCurrentInstance(o)?p&&(_=!0,o.isModified=p,s.updateMsgIsModifiedProp(o)):_=!0,_&&(o.conversationType===D.CONV_SYSTEM&&5===o.payload.operationType&&this._onGroupDismissed(o.payload.groupProfile.groupID),u||o.conversationType===D.CONV_SYSTEM||(p=o.conversationID.replace(D.CONV_GROUP,""),this._pollingInstanceMap.has(p)?this._grpM.isLoggedIn()&&a.addMessageSequence({key:eo,message:o}):(o.type!==D.MSG_GRP_TIP&&0<o.clientTime&&a.addMessageDelay(o.clientTime),a.addMessageSequence({key:$n,message:o}))),i.push(o)))}else this.onRoomCustomData(d);else this._get(34).onMessageReactionNotify({event:21,dataList:d.elements.messageReactionNotifyList});else this.handleMessageRevokedNotice(d)}else Ne.w("".concat(n,". unknown event:").concat(d.event))}0!==i.length&&(0<(t=yt(i)).length&&this._grpM.emitOEvt(E.MESSAGE_MODIFIED,t),u||0<(t=this.packConversationOption(i)).length&&s.onNewMessage({conversationOptionsList:t,isInstantMessage:!0}),this._checkMessageStacked(i),0<(t=Ct(i)).length&&this._grpM.emitOEvt(E.MESSAGE_RECEIVED,t),i.length=0)}}},{key:"handleMessageRevokedNotice",value:function(e){var t=this,n=e.groupID,o=e.elements.revokeMsgList,i=e.revokerInfo,s=[];o.forEach((function(e){var t=e.tinyID,o=e.clientTime,a=e.random;e=e.sequence,t={conversationID:"".concat(D.CONV_GROUP).concat(n),ID:"".concat(t,"-").concat(o,"-").concat(a),revoker:i.revoker,revokeReason:i.reason||"",revokerInfo:{userID:i.revoker,nick:"",avatar:""},sequence:e},s.push(t)})),0!==s.length&&this._get(11).updateRevokerInfo(s).then((function(e){t._grpM.emitOEvt(E.MESSAGE_REVOKED,e)}))}},{key:"isBroadcastOrNormal",value:function(e){return 3===e||17===e}},{key:"isGroupTip",value:function(e){return 4===e||6===e}},{key:"isGroupSystemNotice",value:function(e){return 5===e}},{key:"restoreGroupTipElements",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=void 0===(t=e.operatorInfo)?{}:t,n=e.operatorID,o=void 0===(o=e.userIDList)?[]:o,i=e.operationType,s=(je(e.groupJoinType)||1!==i&&2!==i||(e.groupJoinType=2===i?0:1),i=t.userID,t.avatar);return t=t.nick,e.operatorInfo={userID:void 0===i?n:i,avatar:void 0===s?"":s,nick:void 0===t?"":t},n=o.map((function(e){return{userID:e}})),e.memberInfoList=e.memberInfoList||n,e}},{key:"restoreMessageFromSimplified",value:function(e){var n,o,i,s=e.event;return this.isBroadcastOrNormal(s)&&(e.cloudCustomData=e.cloudCustomData||"",e.elements=e.elements.map((function(e){var n;return e.type===D.MSG_CUSTOM&&(n=e.content,e.content=t({data:"",description:"",extension:""},void 0===n?{}:n)),e}))),(this.isGroupTip(s)||this.isGroupSystemNotice(s))&&(e.from=e.from||"@TIM#SYSTEM"),this.isGroupTip(s)&&(e.elements=this.restoreGroupTipElements(e.elements),o=(i=void 0===(i=e.elements)?{}:i).operationType,n=i.operatorInfo,1===o&&(o=[{userID:(void 0===n?{}:n).userID}],i.memberInfoList=i.memberInfoList||o)),this.isGroupSystemNotice(s)&&(i=(n=e.elements).memberInfoList,o=n.operatorInfo,e.elements.memberInfoList=t({userID:e.elements.operatorID,avatar:"",nick:""},i=i||(void 0===o?{}:o)),e.elements=t({authentication:"",remarkInfo:"",messageKey:1e3*e.time},e.elements),s=Object.keys(e.elements).filter((function(e){return"operatorInfo"!==e})).reduce((function(n,o){return t(t({},n),{},a({},o,e.elements[o]))}),{}),e.elements=s),e}},{key:"_onGroupDismissed",value:function(e){Ne.l("".concat(this._n,"._onGroupDismissed groupID:").concat(e)),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}},{key:"_checkMessageStacked",value:function(e){var t="MessageStacked";100<=(e=e.length)&&(this._grpM.warn(t,e),this._reportMessageStackedCount<5&&(new so(t).setMessage("count:".concat(e," groupID:").concat(m(this._joinedGroupMap.keys()))).setLevel("warning").end(),this._reportMessageStackedCount+=1))}},{key:"_isMessageSentByCurrentInstance",value:function(e){return!!this._get(11).isMessageSentByCurrentInstance(e)}},{key:"packMessage",value:function(e,t){e.currentUser=this._grpM.getMyUserID(),e.conversationType=5===t?D.CONV_SYSTEM:D.CONV_GROUP,e.isSystemMessage=!!e.isSystemMessage;var n=new ko(e),o=(e=this.packElements(e,t),t=this._grpM.getFileDownloadProxy(),this._grpM.getDowloadFileAuthKey()),i=this._get(17).getFileDNList();return n.setElement(e,t,o,i),n}},{key:"packElements",value:function(e,n){return 4===n||6===n?(this._updateMemberCountByGroupTips(e),{type:D.MSG_GRP_TIP,content:t(t({},e.elements),{},{groupProfile:e.groupProfile})}):5===n?{type:D.MSG_GRP_SYS_NOTICE,content:t(t({},e.elements),{},{groupProfile:t(t({},e.groupProfile),{},{groupID:e.groupID})})}:e.elements}},{key:"packConversationOption",value:function(e){for(var t=new Map,n=0;n<e.length;n++){var o,i=e[n],s=i.conversationID;t.has(s)?"in"===((o=t.get(s)).lastMessage=i).flow&&o.unreadCount++:t.set(s,{conversationID:i.conversationID,unreadCount:"out"===i.flow?0:1,type:i.conversationType,subType:i.conversationSubType,lastMessage:i})}return m(t.values())}},{key:"_updateMemberCountByGroupTips",value:function(e){var t,n,o,i=e.groupProfile.groupID;He(e=void 0===(e=e.elements.onlineMemberInfo)?void 0:e)||(t=void 0===(t=e.onlineMemberNum)?0:t,e=void 0===(e=e.expireTime)?this.DEFAULT_EXPIRE_TIME:e,n=this._onlineMemberCountMap.get(i)||{},o=Date.now(),He(n)?Object.assign(n,{lastReqTime:0,lastSyncTime:0,latestUpdateTime:o,memberCount:t,expireTime:e}):(n.latestUpdateTime=o,n.memberCount=t),this._onlineMemberCountMap.set(i,n))}},{key:"_onBroadcastMessage",value:function(e){if(!He(e)){for(var t=[],n=e.length,o=null,i=0;i<n;i++){var s=this.restoreMessageFromSimplified(e[i]);Ci[s.event]?((o=this.packMessage(s,s.event)).isBroadcastMessage=!0,this._broadcastMessageIDMap.has(o.ID)||(t.push(o),this._broadcastMessageIDMap.set(o.ID,1))):Ne.w("".concat(this._n,"._onBroadcastMessage unknown event:").concat(s.event))}0<t.length&&this._grpM.emitOEvt(E.MESSAGE_RECEIVED,t)}}},{key:"start",value:function(e){var t;this._pollingInstanceMap.has(e)?(t=this._pollingInstanceMap.get(e)).isRunning()||t.start():((t=new Mi({manager:this,groupID:e,onInit:this._updatedata.bind(this),onSuccess:this._handleSuccess.bind(this),onFail:this._handleFailure.bind(this)})).start(),this._pollingInstanceMap.set(e,t),Ne.l("".concat(this._n,".start groupID:").concat(e)))}},{key:"handleJoinResult",value:function(e){var t=this;return this._preCheck(e.group).then((function(){var n=e.longPollingKey,o=e.group,i=o.groupID;return t._joinedGroupMap.set(i,o),t._grpM.updateGroupMap([o]),t._grpM.deleteUnjoinedAVChatRoom(i),t._grpM.emitGroupListUpdate(!0,!1),pt(n)?Dn({status:qe,group:o}):Promise.resolve()}))}},{key:"startRunLoop",value:function(e){var t=this;return this.handleJoinResult(e).then((function(){var n=e.longPollingKey,o=e.group,i=e.startSeq,s=o.groupID;return t._pollingRequestInfoMap.set(s,{key:n,startSeq:void 0===i?0:i}),t.start(s),t._grpM.isLoggedIn()?Dn({status:qe,group:o}):Dn({status:qe})}))}},{key:"_preCheck",value:function(e){if(this._get(12).isUnlimitedAVChatRoom())return Promise.resolve();if(!this.hasJoinedAVChatRoom())return Promise.resolve();if(e.type===D.GRP_LIVE)return Promise.resolve();var t=(e=f(this._joinedGroupMap.entries().next().value,2))[0];if(e=e[1],this._grpM.isLoggedIn()){if(e.selfInfo.role!==D.GRP_MBR_ROLE_OWNER&&e.ownerID!==this._grpM.getMyUserID())return this._grpM.quitGroup(t);this._grpM.deleteLocalGroupAndConversation(t)}else this._grpM.deleteLocalGroupAndConversation(t);return this.reset(t),Promise.resolve()}},{key:"joinWithoutAuth",value:function(e){var t=this,n=e.groupID,o="".concat(this._n,".").concat("joinWithoutAuth"),i=new so("joinWithoutAuth");return this._grpM.req({P:Kn.APPLY_JOIN_GRP_NOAUTH,data:e}).then((function(e){if(e=e.data.longPollingKey,i.setMessage("groupID:".concat(n," longPollingKey:").concat(e)).end(!0),pt(e))return Rn({code:Bn.CANNOT_JOIN_NON_AV_WITHOUT_LOGIN});Ne.l("".concat(o," ok. groupID:").concat(n)),t._get(11).setCompleted("".concat(D.CONV_GROUP).concat(n));var s=new di({groupID:n});return t.startRunLoop({group:s,longPollingKey:e}),En({status:qe})})).catch((function(e){return Ne.e("".concat(o," failed. groupID:").concat(n," error:"),e),i.setError(e).setMessage("groupID:".concat(n)).end(!0),Rn(e)})).finally((function(){t._grpM.get(14).reportAtOnce()}))}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this._onlineMemberCountMap.get(e)||{},n=Date.now();return He(t)||n-t.lastSyncTime>1e3*t.expireTime&&1e4<n-t.latestUpdateTime&&3e3<n-t.lastReqTime?(t.lastReqTime=n,this._onlineMemberCountMap.set(e,t),this._getGroupOnlineMemberCount(e).then((function(e){return En({memberCount:e.memberCount})})).catch((function(e){return Rn(e)}))):Dn({memberCount:t.memberCount})}},{key:"_getGroupOnlineMemberCount",value:function(e){var t=this,n="".concat(this._n,".").concat("_getGroupOnlineMemberCount"),o=new so("_getGroupOnlineMemberCount");return this._grpM.requestOnlineCount(e).then((function(o){var i=t._onlineMemberCountMap.get(e)||{},s=void 0===(s=(o=o.data).memberCount)?0:s,a=(o=void 0===(o=o.expireTime)?t.DEFAULT_EXPIRE_TIME:o,Ne.l("".concat(n," ok. groupID:").concat(e," memberCount:").concat(s," expireTime:").concat(o)),Date.now());return He(i)&&(i.lastReqTime=a),t._onlineMemberCountMap.set(e,Object.assign(i,{lastSyncTime:a,latestUpdateTime:a,memberCount:s,expireTime:o})),{memberCount:s}})).catch((function(t){return Ne.w("".concat(n," failed. error:"),t),o.setCode(t.code).setMessage("groupID:".concat(e," error:").concat(JSON.stringify(t))).end(),Promise.reject(t)}))}},{key:"_get",value:function(e){return this._grpM.get(e)}},{key:"setPollingInterval",value:function(e){pt(e)||(je(e)?this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=e:this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=parseInt(e,10))}},{key:"setPollingIntervalPlus",value:function(e){pt(e)||(je(e)?this.DEFAULT_POLLING_INTERVAL_PLUS=e:this.DEFAULT_POLLING_INTERVAL_PLUS=parseInt(e,10))}},{key:"setPollingNoMessageCount",value:function(e){pt(e)||(je(e)?this.DEFAULT_POLLING_NO_MESSAGE_COUNT=e:this.DEFAULT_POLLING_NO_MESSAGE_COUNT=parseInt(e,10))}},{key:"setPollingSimplifiedMessage",value:function(e){pt(e)||"0"!==e&&"1"!==e||(this.DEFAULT_POLLING_SIMPLIFIED_MSG=parseInt(e,10))}},{key:"getPollingInterval",value:function(){return this._pollingInterval}},{key:"onAVChatRoomMemberBanned",value:function(e){e=e.payload.groupProfile.groupID,Ne.l("".concat(this._n,".onAVChatRoomMemberBanned groupID:").concat(e)),this._grpM.deleteLocalGroupAndConversation(e),this.reset(e)}},{key:"restartPolling",value:function(){Ne.l("".concat(this._n,".restartPolling count:").concat(this._pollingInstanceMap.size));var e,t=T(this._pollingInstanceMap.values());try{for(t.s();!(e=t.n()).done;){var n=e.value;n.stop(),n.start()}}catch(e){t.e(e)}finally{t.f()}}},{key:"getPollingTimerID",value:function(e){if(!this._pollingInstanceMap.has(e))return-1;var t=this._pollingInstanceMap.get(e).getPollingTimerID();return Ne.l("".concat(this._n,".getPollingTimerID groupID:").concat(e," timerID:").concat(t)),t}},{key:"hasPollingInstance",value:function(e){return this._pollingInstanceMap.has(e)}},{key:"onRoomCustomData",value:function(e){var t=e.groupID,n=e.sequence,o=e.time;e=(e=e.elements)&&e.content,this._get(30).onRoomCustomDataReceived(e),Ne.l("".concat(this._n,".onRoomCustomData groupID:").concat(t," sequence:").concat(n," time:").concat(o," data:").concat(e))}},{key:"reset",value:function(e){if(e){Ne.l("".concat(this._n,".reset groupID:").concat(e));var t=this._pollingInstanceMap.get(e);t&&t.stop(),this._pollingInstanceMap.delete(e),this._joinedGroupMap.delete(e),this._pollingRequestInfoMap.delete(e),this._onlineMemberCountMap.delete(e)}else{Ne.l("".concat(this._n,".reset all"));var n,o=T(this._pollingInstanceMap.values());try{for(o.s();!(n=o.n()).done;)n.value.stop()}catch(e){o.e(e)}finally{o.f()}this._pollingInstanceMap.clear(),this._joinedGroupMap.clear(),this._pollingRequestInfoMap.clear(),this._onlineMemberCountMap.clear(),this._broadcastMessageIDMap.clear()}this._seqSll.reset(),this._IDSll.reset(),this._reportMessageStackedCount=0,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL=300,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0}}]),$i),Ei=(s(Zi,[{key:"updateMember",value:function(e){pt(e.onlineStatus)||(this.isOnline="Online"===e.onlineStatus);var t=[null,void 0,"",0,NaN];e.memberCustomField&&It(this.memberCustomField,e.memberCustomField),nt(this,e,["memberCustomField","marks","onlineStatus"],t)}},{key:"updateRole",value:function(e){["Owner","Admin","Member"].indexOf(e)<0||(this.role=e)}},{key:"updateMuteUntil",value:function(e){pt(e)||(this.muteUntil=Math.floor((Date.now()+1e3*e)/1e3))}},{key:"updateNameCard",value:function(e){pt(e)||(this.nameCard=e)}},{key:"updateMemberCustomField",value:function(e){e&&It(this.memberCustomField,e)}}]),Zi),Di=(s(Qi,[{key:"_onProfileUpdated",value:function(e){for(var t=this,n=e.data,o=0;o<n.length;o++)!function(e){var o=n[e];t.groupMemberListMap.forEach((function(e){e.has(o.userID)&&e.get(o.userID).updateMember({nick:o.nick,avatar:o.avatar})}))}(o)}},{key:"deleteGroupMemberList",value:function(e){this.groupMemberListMap.delete(e)}},{key:"getGroupMemberList",value:function(e){var t,n=this,o=e.groupID,i=void 0===(i=e.role)?void 0:i,s=void 0===(c=e.offset)?0:c,a=void 0===(c=e.count)?15:c,r=(e=void 0===(c=e.filter)?void 0:c,"".concat(this._n,".").concat("getGroupMemberList")),c=this._grpM.hasLocalGroup(o);if(Ne.l("".concat(r," groupID:").concat(o," role:").concat(i," offset:").concat(s," count:").concat(a," hasLocalGroup:").concat(c)),!c)return Dn({memberList:[],offset:0});if(this._grpM.getLocalGroupProfile(o).type===D.GRP_AVCHATROOM){if(this._grpM.canIUse(U.AV_MBR_LIST))return this._getAVChatRoomMemberList({groupID:o,offset:s,filter:e});this._grpM.warn("LiveOnlineMember")}i!==D.GRP_MBR_ROLE_ADMIN&&i!==D.GRP_MBR_ROLE_OWNER&&i!==D.GRP_MBR_ROLE_MEMBER||(t=i);var u=new so("getGroupMemberList"),l=0,d=(c={groupID:o,limit:100<a?100:a,memberRoleFilter:t?[t]:void 0,memberInfoFilter:this.DEFAULT_MEMBER_INFO_FILTER},Et({groupID:o})?c.next="".concat(s):(c.offset=s,l=s+a),[]);return this._grpM.req({P:Kn.GET_GRP_MBR_LIST,data:c}).then((function(e){var t=(e=e.data).members,i=e.memberNum;return e=e.next,pt(e=void 0===e?void 0:e)||(l=He(e)?0:e),Xe(t)&&0!==t.length?(n._grpM.hasLocalGroup(o)&&(n._grpM.getLocalGroupProfile(o).memberNum=i),d=n._updateLocalGroupMemberMap(o,t),n._grpM.get(4).getUserProfile({userIDList:t.map((function(e){return e.userID})),tagList:[Ge.NICK,Ge.AVATAR]})):(l=0,Promise.resolve([]))})).then((function(e){return Xe(e=e.data)&&0!==e.length?(e=e.map((function(e){return{userID:e.userID,nick:e.nick,avatar:e.avatar}})),n._updateLocalGroupMemberMap(o,e),d.length<a&&(l=0),u.setMessage("groupID:".concat(o," offset:").concat(s," count:").concat(a)).end(),Ne.l("".concat(r," ok.")),En({memberList:d,offset:l})):Dn({memberList:[],offset:l})})).catch((function(e){return u.setError(e).end(),Ne.e("".concat(r," failed. error:"),e),Rn(e)}))}},{key:"_getAVChatRoomMemberList",value:function(e){var n=this,o=e.groupID,i=e.offset,s=(e=e.filter,"".concat(this._n,".").concat("_getAVChatRoomMemberList")),a=new so("_getAVChatRoomMemberList");return a.setMessage("groupID:".concat(o," offset:").concat(i," filter:").concat(e)),this._grpM.req({P:Kn.GET_AV_MBR_LIST,data:{groupID:o,offset:i,filter:e}}).then((function(e){var i=void 0===(i=(e=e.data).memberList)?[]:i;return e=void 0===(e=e.offset)?0:e,a.end(),Ne.l("".concat(s," ok. member count:").concat(i.length,", next request timestamp:").concat(e)),i=i.map((function(e){return t(t({},e),{},{onlineStatus:"Online"})})),En({memberList:i=n._updateLocalGroupMemberMap(o,i),offset:e})})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(s," failed. error:"),e),Rn(e)}))}},{key:"getGroupMemberProfile",value:function(e){var n=this,o="getGroupMemberProfile",i="".concat(this._n,".").concat(o),s="groupID:".concat(e.groupID),a=(5<e.userIDList.length?s+=" userIDList.length:".concat(e.userIDList.length):s+=" userIDList:".concat(e.userIDList),Ne.l("".concat(i," ").concat(s)),50<e.userIDList.length&&(e.userIDList=e.userIDList.slice(0,50)),e.groupID),r=e.userIDList;if((i=this._grpM.getLocalGroupProfile(a))&&Tt(i.type))return Rn({code:i=Bn.OPERATION_NOT_SUPPORTED_IN_AV,message:this._grpM.getErrMsg(i,o)});var c=new so(o);return c.setMessage(s),this._getGroupMemberProfileAdvance(t(t({},e),{},{userIDList:r})).then((function(e){return Xe(e=e.data.members)&&0!==e.length?(n._updateLocalGroupMemberMap(a,e),n._grpM.get(4).getUserProfile({userIDList:e.map((function(e){return e.userID})),tagList:[Ge.NICK,Ge.AVATAR]})):Dn([])})).then((function(e){return e=e.data.map((function(e){return{userID:e.userID,nick:e.nick,avatar:e.avatar}})),n._updateLocalGroupMemberMap(a,e),e=r.filter((function(e){return n.hasLocalGroupMember(a,e)})).map((function(e){return n.getLocalGroupMemberInfo(a,e)})),c.end(),En({memberList:e})}))}},{key:"addGroupMember",value:function(e){var t=this,n="".concat(this._n,".").concat("addGroupMember"),o=e.groupID,i=this._grpM.getLocalGroupProfile(o),s=i.type,a=new so("addGroupMember");return a.setMessage("groupID:".concat(o," groupType:").concat(s)),Tt(s)?(s=new Vn({code:Bn.CANNOT_ADD_MEMBER_IN_AV}),a.setError(s).end(),Rn(s)):(e.userIDList=e.userIDList.map((function(e){return{userID:e}})),Ne.l("".concat(n," groupID:").concat(o)),this._grpM.req({P:Kn.ADD_GRP_MBR,data:e}).then((function(o){o=o.data.members;var s=(Ne.l("".concat(n," ok")),o.filter((function(e){return 1===e.result})).map((function(e){return e.userID}))),r=o.filter((function(e){return 0===e.result})).map((function(e){return e.userID})),c=o.filter((function(e){return 2===e.result})).map((function(e){return e.userID})),u=(o=o.filter((function(e){return 4===e.result})).map((function(e){return e.userID})),"groupID:".concat(e.groupID,", ")+"successUserIDList:".concat(s,", ")+"failureUserIDList:".concat(r,", ")+"existedUserIDList:".concat(c,", ")+"overLimitUserIDList:".concat(o));return a.setMoreMessage(u).end(),0===s.length?En({successUserIDList:s,failureUserIDList:r,existedUserIDList:c,overLimitUserIDList:o}):(t._updateConvGroupProfile(i),En({successUserIDList:s,failureUserIDList:r,existedUserIDList:c,overLimitUserIDList:o,group:i}))})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)})))}},{key:"deleteGroupMember",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteGroupMember"),o=e.groupID,i=e.userIDList,s=this._grpM.getLocalGroupProfile(o);if(pt(s))return Rn({code:Bn.CANNOT_FIND_GRP});if(Tt(s.type))return this._grpM.canIUse(U.AV_BAN_MBR)?this._banAVChatRoomMember(e):this._grpM.noUse("deleteGroupMember");var a="groupID:".concat(o," ").concat(5<i.length?"userIDList.length:".concat(i.length):"userIDList:".concat(i)),r=(Ne.l("".concat(n," groupID:").concat(o," userIDList:"),i),new so("deleteGroupMember"));return r.setMessage(a),this._grpM.req({P:Kn.DEL_GRP_MBR,data:e}).then((function(){return r.end(),Ne.l("".concat(n," ok")),t._updateConvGroupProfile(s),t.deleteLocalGroupMembers(o,i),En({group:s,userIDList:i})})).catch((function(e){return r.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"_updateConvGroupProfile",value:function(e){this._grpM.get(11).updateConvGroupProfile([e])}},{key:"_banAVChatRoomMember",value:function(e){var t=this,n="".concat(this._n,".").concat("_banAVChatRoomMember"),o=e.groupID,i=e.userIDList,s="groupID:".concat(o," ").concat(5<i.length?"userIDList.length:".concat(i.length):"userIDList:".concat(i)),a=new so("_banAVChatRoomMember"),r=(a.setMessage(s),Ne.l("".concat(n," groupID:").concat(o," userIDList:"),i),this._grpM.getLocalGroupProfile(o));return pt(e.duration)||0===e.duration?Rn({code:Bn.BAN_DURATION_INVALID}):this._grpM.req({P:Kn.BAN_AV_MBR,data:e}).then((function(){return a.end(),Ne.l("".concat(n," ok")),t.deleteLocalGroupMembers(o,i),En({group:r,userIDList:i})})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"setGroupMemberMuteTime",value:function(e){var t=this,n=e.groupID,o=e.userID,i=(e=e.muteTime,"".concat(this._n,".").concat("setGroupMemberMuteTime"));if(o===this._grpM.getMyUserID())return Rn({code:Bn.CANNOT_MUTE_SELF});var s="groupID:".concat(n," userID:").concat(o," muteTime:").concat(e),a=(Ne.l("".concat(i," ").concat(s)),new so("setGroupMemberMuteTime"));return a.setMessage(s),this.modifyGroupMemberInfo({groupID:n,userID:o,muteTime:e}).then((function(e){return a.end(),Ne.l("".concat(i," ok")),En({group:t._grpM.getLocalGroupProfile(n),member:e})})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"setGroupMemberRole",value:function(e){var t="".concat(this._n,".").concat("setGroupMemberRole"),n=e.groupID,o=e.userID,i=(e=e.role,"groupID:".concat(n," userID:").concat(o," role:").concat(e)),s=this._grpM.getLocalGroupProfile(n);if(s&&s.selfInfo.role!==D.GRP_MBR_ROLE_OWNER)return Rn({code:Bn.NOT_OWNER});var a=[D.GRP_MBR_ROLE_ADMIN,D.GRP_MBR_ROLE_MEMBER];if(Et({groupID:n})&&a.push(D.GRP_MBR_ROLE_CUSTOM),a.indexOf(e)<0)return Rn({code:Bn.INVALID_MEMBER_ROLE});if(o===this._grpM.getMyUserID())return Rn({code:Bn.CANNOT_SET_SELF_MEMBER_ROLE});var r=new so("setGroupMemberRole");return r.setMessage(i),Ne.l("".concat(t," ").concat(i)),this.modifyGroupMemberInfo({groupID:n,userID:o,role:e}).then((function(e){return r.end(),Ne.l("".concat(t," ok")),En({group:s,member:e})})).catch((function(e){return r.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"_filterProfanity",value:function(e,t){if(!(o=this._grpM.get(29)))return!0;var n=(o=o.filterText(t[e],"group_member_profile")).isAllowedToSend,o=o.modifiedText;return!0===n&&(t[e]=o,!0)}},{key:"setGroupMemberNameCard",value:function(e){var t=this,n="setGroupMemberNameCard",o="".concat(this._n,".").concat(n);if(e.nameCard&&!1===this._filterProfanity("nameCard",e))return Rn({code:Bn.PROFANITY_FOUND});var i=e.groupID,s=void 0===(r=e.userID)?this._grpM.getMyUserID():r,a=e.nameCard,r="groupID:".concat(i," userID:").concat(s," nameCard:").concat(a);if(Ne.l("".concat(o," ").concat(r)),(e=this._grpM.getLocalGroupProfile(i))&&Tt(e.type))return Rn({code:e=Bn.OPERATION_NOT_SUPPORTED_IN_AV,message:this._grpM.getErrMsg(e,n)});var c=new so(n);return c.setMessage(r),this.modifyGroupMemberInfo({groupID:i,userID:s,nameCard:a}).then((function(e){Ne.l("".concat(o," ok")),c.end();var n=t._grpM.getLocalGroupProfile(i);return s===t._grpM.getMyUserID()&&n&&n.setSelfNameCard(a),En({group:n,member:e})})).catch((function(e){return c.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"setGroupMemberCustomField",value:function(e){var t=this,n="setGroupMemberCustomField",o="".concat(this._n,".").concat(n),i=e.groupID,s=void 0===(s=e.userID)?this._grpM.getMyUserID():s,a=(e=e.memberCustomField,"groupID:".concat(i," userID:").concat(s," memberCustomField:").concat(JSON.stringify(e))),r=(Ne.l("".concat(o," ").concat(a)),this._grpM.getLocalGroupProfile(i));if(r&&Tt(r.type))return Rn({code:r=Bn.OPERATION_NOT_SUPPORTED_IN_AV,message:this._grpM.getErrMsg(r,n)});var c=new so(n);return c.setMessage(a),this.modifyGroupMemberInfo({groupID:i,userID:s,memberCustomField:e}).then((function(e){return c.end(),Ne.l("".concat(o," ok")),En({group:t._grpM.getLocalGroupProfile(i),member:e})})).catch((function(e){return c.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"modifyGroupMemberInfo",value:function(e){var n=this,o=e.groupID,i=e.userID,s=void 0;return Dt(o)&&(o=xt(s=o)),this._grpM.req({P:Kn.MODIFY_GRP_MBR_INFO,data:t(t({},e),{},{groupID:o,topicID:s})}).then((function(){if(n.hasLocalGroupMember(o,i))return t=n.getLocalGroupMemberInfo(o,i),pt(e.muteTime)||t.updateMuteUntil(e.muteTime),pt(e.role)||t.updateRole(e.role),pt(e.nameCard)||t.updateNameCard(e.nameCard),pt(e.memberCustomField)||t.updateMemberCustomField(e.memberCustomField),t;var t=n._grpM.getLocalGroupProfile(o);return t&&!Tt(t.type)?n.getGroupMemberProfile({groupID:o,userIDList:[i]}).then((function(e){return f(e.data.memberList,1)[0]})):void 0}))}},{key:"markGroupMemberList",value:function(e){var t="".concat(this._n,".").concat("markGroupMemberList"),n=e.groupID,o=e.markType,i=e.enableMark,s=void 0===(e=e.userIDList)?[]:e,a=(e="groupID:".concat(n," markType:").concat(o," enableMark:").concat(i," userIDList count:").concat(s.length),Ne.l("".concat(t," ").concat(e)),2),r=[],c=(!0===i&&(a=1),i=m(s),500<s.length&&(i=s.slice(0,500),Ne.w("".concat(t," ").concat(Wt(500)))),i.forEach((function(e){r.push({userID:e,markType:[o]})})),i=null,new so("markGroupMemberList"));return c.setMessage(e),this._grpM.req({P:Kn.MARK_AV_MBR_INFO,data:{groupID:n,operationType:a,memberList:r}}).then((function(e){e=e.data.memberList;var n=[],o=[];return(e=void 0===e?[]:e).length===s.length?n.push.apply(n,m(s)):(e.forEach((function(e){n.push(e.userID)})),s.forEach((function(e){n.includes(e)||o.push(e)}))),e="success count:".concat(n.length," fail count:").concat(o.length),c.setMessage(e).end(),Ne.l("".concat(t," ok. ").concat(e)),En({successUserIDList:n,failureUserIDList:o})})).catch((function(e){return c.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"_getGroupMemberProfileAdvance",value:function(e){return this._grpM.req({P:Kn.GET_GRP_MBR_PROFILE,data:t(t({},e),{},{memberInfoFilter:e.memberInfoFilter||this.DEFAULT_MEMBER_INFO_FILTER})})}},{key:"_updateLocalGroupMemberMap",value:function(e,t){var n=this;return Xe(t)&&0!==t.length?t.map((function(t){return n.hasLocalGroupMember(e,t.userID)?n.getLocalGroupMemberInfo(e,t.userID).updateMember(t):n.setLocalGroupMember(e,new Ei(t)),n.getLocalGroupMemberInfo(e,t.userID)})):[]}},{key:"deleteLocalGroupMembers",value:function(e,t){var n=this.groupMemberListMap.get(e);n&&t.forEach((function(e){n.delete(e)}))}},{key:"getLocalGroupMemberInfo",value:function(e,t){return this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).get(t):null}},{key:"setLocalGroupMember",value:function(e,t){this.groupMemberListMap.has(e)?this.groupMemberListMap.get(e).set(t.userID,t):(t=(new Map).set(t.userID,t),this.groupMemberListMap.set(e,t))}},{key:"getLocalGroupMemberList",value:function(e){return this.groupMemberListMap.get(e)}},{key:"hasLocalGroupMember",value:function(e,t){return this.groupMemberListMap.has(e)&&this.groupMemberListMap.get(e).has(t)}},{key:"hasLocalGroupMemberMap",value:function(e){return this.groupMemberListMap.has(e)}},{key:"reset",value:function(){this.groupMemberListMap.clear()}}]),Qi),Ri=[17,18,20],Si=(s(Xi,[{key:"onNewGroupSystemNotice",value:function(e){var t=e.dataList,n=e.isSyncingEnded,o=(e=e.isInstantMessage,(Ne.d("".concat(this._n,".onReceiveSystemNotice count:").concat(t.length)),t=this._assembly({notifiesList:t,isInstantMessage:e})).eventDataList);t=t.result,0<o.length&&(this._grpM.get(11).onNewMessage({conversationOptionsList:o,isInstantMessage:e}),this._onReceivedGroupSystemNotice({result:t,isInstantMessage:e})),e?0<t.length&&this._grpM.emitOEvt(E.MESSAGE_RECEIVED,t):!0===n&&this._clearGroupSystemNotice()}},{key:"_assembly",value:function(e){var n=e.notifiesList,o=e.isInstantMessage,i=null,s=n.length,a=0,r=[],c={conversationID:D.CONV_SYSTEM,unreadCount:0,type:D.CONV_SYSTEM,subType:null,lastMessage:null};for(a=0;a<s;a++){var u=n[a],l=(d=u.groupProfile).communityType,d=void 0===(d=d.topicID)?void 0:d,p=void 0===(p=(_=u.elements).topicIDList)?void 0:p,_=_.operationType;if(!(2!==(void 0===l?0:l)||He(d)&&He(p))){if(Ri.includes(_)){this._handleTopicSystemNotice(u);continue}He(d)||(u.to=d)}15!==u.elements.operationType&&(u.currentUser=this._grpM.getMyUserID(),u.conversationType=D.CONV_SYSTEM,u.conversationID=D.CONV_SYSTEM,(i=new ko(u)).setElement({type:D.MSG_GRP_SYS_NOTICE,content:t(t({},u.elements),{},{groupProfile:t({},u.groupProfile)})}),i.isSystemMessage=!0,(1===i.sequence&&1===i.random||2===i.sequence&&2===i.random)&&(i.sequence=st(),i.random=st(),i.generateMessageID(),Ne.l("".concat(this._n,"._assembly regenerate ID:").concat(i.ID))),this._grpM.get(11).pushIntoNoticeResult(r,i)&&(o?c.unreadCount++:i.setIsRead(!0),c.subType=i.conversationSubType))}return c.lastMessage=r[r.length-1],{eventDataList:0<r.length?[c]:[],result:r}}},{key:"_clearGroupSystemNotice",value:function(){var e=this;this._getPendencyList().then((function(t){t.forEach((function(t){e.pendencyMap.set("".concat(t.from,"_").concat(t.groupID,"_").concat(t.to),t)})),t=e._grpM.get(11).getLocalMessageList(D.CONV_SYSTEM);var n=[];t.forEach((function(t){var o=(s=t.payload).operatorID,i=s.operationType,s=s.groupProfile;1===i&&(i="".concat(o,"_").concat(s.groupID,"_").concat(s.to),(o=e.pendencyMap.get(i))&&je(o.handled)&&0!==o.handled&&n.push(t))})),e.deleteGroupSystemNotice({messageList:n})}))}},{key:"deleteGroupSystemNotice",value:function(e){var t=this,n="".concat(this._n,".deleteGroupSystemNotice");return Xe(e.messageList)&&0!==e.messageList.length?(Ne.l("".concat(n," ")+e.messageList.map((function(e){return e.ID}))),this._grpM.req({P:Kn.DEL_GRP_SYSTEM_NOTICE,data:{messageListToDelete:e.messageList.map((function(e){return{from:D.CONV_SYSTEM,messageSeq:e.clientSequence,messageRandom:e.random}}))}}).then((function(){Ne.l("".concat(n," ok"));var o=t._grpM.get(11);return e.messageList.forEach((function(e){o.deleteLocalMessage(e)})),En()})).catch((function(e){return Ne.e("".concat(n," error:"),e),Rn(e)}))):Dn()}},{key:"_getPendencyList",value:function(){var e=this,t=(o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).type,n=o.startTime,o=o.limit;return this._grpM.req({P:Kn.GET_GRP_PENDENCY,data:{type:void 0===t?void 0:t,startTime:void 0===n?0:n,limit:void 0===o?20:o,handleAccount:this._grpM.getMyUserID()}}).then((function(t){var n=t.data.pendencyList;return 0!==t.data.nextStartTime?e._getPendencyList({startTime:t.data.nextStartTime}).then((function(e){return[].concat(m(n),m(e))})):n}))}},{key:"getGroupApplicationList",value:function(){var e=this;return this._getPendencyList().then((function(t){return e._getPendencyList({type:D.GRP_COMMUNITY}).then((function(n){return t.push.apply(t,m(n)),e._handlePendencyResult(t)})).catch((function(n){return e._handlePendencyResult(t)}))}))}},{key:"_handlePendencyResult",value:function(e){var t=this,n=[];return e.forEach((function(e){t.pendencyMap.set("".concat(e.from,"_").concat(e.groupID,"_").concat(e.to),e),0===e.handled&&n.push({applicant:e.from,applicantNick:e.fromUserNickName,groupName:e.groupName,groupID:e.groupID,authentication:e.authentication,messageKey:e.time,applicationType:e.applicationType,userID:e.userID,note:e.note})})),Dn({applicationList:n})}},{key:"_onReceivedGroupSystemNotice",value:function(e){var t=this,n=e.result;e.isInstantMessage&&n.forEach((function(e){switch(e.payload.operationType){case 1:case 3:case 6:case 11:case 12:case 15:break;case 2:t._onApplyJoinGroup(e);break;case 4:t._onMemberKicked(e);break;case 5:t._onGroupDismissed(e);break;case 7:t._onInviteGroup(e);break;case 8:t._onQuitGroup(e);break;case 9:t._onSetManager(e);break;case 10:t._onDeleteManager(e);break;case 20:t._onMessageRemindTypeSynced(e);break;case 21:t._grpM.onAVChatRoomMemberBanned(e)}}))}},{key:"_onApplyJoinGroup",value:function(e){var t=this,n=(e=e.payload.groupProfile).groupID,o=(e=e.groupType,this._grpM.hasLocalGroup(n));Ne.l("".concat(this._n,"._onApplyJoinGroup groupID:").concat(n," groupType:").concat(e," hasGroup:").concat(o)),o||Tt(e)||this._grpM.getGroupProfile({groupID:n}).then((function(e){(e=e.data.group)&&(t._grpM.updateGroupMap([e]),e=!e.isSupportTopic,t._grpM.emitGroupListUpdate(!0,e))}))}},{key:"_onMemberKicked",value:function(e){e=e.payload.groupProfile.groupID,this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e)}},{key:"_onGroupDismissed",value:function(e){e=e.payload.groupProfile.groupID;var t=(this._grpM.hasLocalGroup(e)&&this._grpM.deleteLocalGroupAndConversation(e),this._grpM._AVChatRoomHandler);t&&t.checkJoinedAVChatRoomByID(e)&&t.reset(e)}},{key:"_onInviteGroup",value:function(e){var t=this,n=e.payload.groupProfile.groupID;e=this._grpM.hasLocalGroup(n),Ne.l("".concat(this._n,"._onInviteGroup groupID:").concat(n," hasGroup:").concat(e)),this._grpM.getGroupProfile({groupID:n}).then((function(){t._grpM.emitGroupListUpdate(),t._grpM.get(11).pullMsgOnInvite("".concat(D.CONV_GROUP).concat(n))}))}},{key:"_onQuitGroup",value:function(e){var t=(e=e.payload.groupProfile).groupID,n=(e=e.groupType,this._grpM.hasLocalGroup(t));Ne.l("".concat(this._n,"._onQuitGroup groupID:").concat(t," groupType:").concat(e," hasGroup:").concat(n)),n&&this._grpM.deleteLocalGroupAndConversation(t)}},{key:"_onSetManager",value:function(e){var t=(e=e.payload.groupProfile).to;e=e.groupID,(e=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(e,t))&&e.updateRole(D.GRP_MBR_ROLE_ADMIN)}},{key:"_onDeleteManager",value:function(e){var t=(e=e.payload.groupProfile).to;e=e.groupID,(e=this._grpM.getGroupMemberHandler().getLocalGroupMemberInfo(e,t))&&e.updateRole(D.GRP_MBR_ROLE_MEMBER)}},{key:"_onMessageRemindTypeSynced",value:function(e){var t=e.payload.groupProfile.groupID;e=e.payload.messageRemindType,this._grpM.get(11).onGroupMsgRemindTypeUpdated({groupID:t,messageRemindType:e})}},{key:"_handleTopicSystemNotice",value:function(e){var t=(n=e.groupProfile).groupID,n=n.topicID,o=(e=e.elements).operationType,i=e.topicIDList,s=(e=e.messageRemindType,this._grpM.get(10));17===o?s.onTopicCreated({groupID:t,topicID:n}):18===o?s.onTopicDeleted({groupID:t,topicIDList:i}):20===o&&s.onMessageRemindTypeUpdated({groupID:t,topicID:n,messageRemindType:e})}},{key:"reset",value:function(){this.pendencyMap.clear()}}]),Xi),Li=["relayFlag"],Ai=(r(zi,bn),ii=g(zi),s(zi,[{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("polling_interval"),t=this.getCloudConfig("polling_interval_plus"),n=this.getCloudConfig("polling_no_msg_count"),o=this.getCloudConfig("polling_simplified_msg"),i=this.getCloudConfig("paging_grp_count");Ne.l("".concat(this._n,"._onCloudConfig pollingInterval:").concat(e)+" pollingIntervalPlus:".concat(t," pollingNoMessageCount:").concat(n)+" pollingSimplifiedMessage:".concat(o," pagingGroupCount:").concat(i)),this._AVChatRoomHandler.setPollingInterval(e),this._AVChatRoomHandler.setPollingIntervalPlus(t),this._AVChatRoomHandler.setPollingNoMessageCount(n),this._AVChatRoomHandler.setPollingSimplifiedMessage(o),this._commonGroupHandler.setPagingGroupCount(i)}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&(this._commonGroupHandler.onCheckTimer(e),this._groupTipsHandler.onCheckTimer(e))}},{key:"guardForAVChatRoom",value:function(e){var t,n=this;return e.conversationType===D.CONV_GROUP?(t=Dt(e.to)?xt(e.to):e.to,this.hasLocalGroup(t)?Dn():this.getGroupProfile({groupID:t}).then((function(o){return o=o.data.group.type,Ne.l("".concat(n._n,".guardForAVChatRoom. groupID:").concat(t," type:").concat(o)),o===D.GRP_AVCHATROOM?Rn(new Vn({code:o=Bn.MSG_SEND_FAIL_NOT_IN_AV,message:n.getErrMsg(o,e.from,t),data:{message:e}})):Dn()}))):Dn()}},{key:"checkJoinedAVChatRoomByID",value:function(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}},{key:"onNewMessage",value:function(e){this._commonGroupHandler.onNewMessage(e)}},{key:"updateNextMessageSeq",value:function(e){var t,n=this;Xe(e)&&(t=this.get(10),e.forEach((function(e){var o=e.conversationID.replace(D.CONV_GROUP,"");Dt(o)&&t.updateUnreadCountAndLastMsg(o,e.lastMessage),n.groupMap.has(o)&&(n.groupMap.get(o).nextMessageSeq=e.lastMessage.sequence+1)})))}},{key:"onNewGroupTips",value:function(e){this._groupTipsHandler.onNewGroupTips(e)}},{key:"onMsgRevoked",value:function(e){this._commonGroupHandler.onMsgRevoked(e,!(1<arguments.length&&void 0!==arguments[1])||arguments[1])}},{key:"onNewGroupSystemNotice",value:function(e){this._groupSystemNoticeHandler.onNewGroupSystemNotice(e)}},{key:"onMsgReadNotice",value:function(e){var t=this;e.dataList.forEach((function(e){var n;e=e.elements.groupMessageReadNotice,pt(e)||(n=t.get(11),e.forEach((function(e){var o=e.groupID,i=void 0===(i=e.topicID)?void 0:i,s=(e=e.lastMessageSeq,Ne.l("".concat(t._n,".onMsgReadNotice groupID:").concat(o," lastMessageSeq:").concat(e)),o="".concat(D.CONV_GROUP).concat(o),!0);He(i)||(o="".concat(D.CONV_GROUP).concat(i),s=!1),n.updateIsReadAfterReadReport({conversationID:o,lastMessageSeq:e}),n.updateUnreadCount(o,s),n.clearGroupAtInfoList(o,s)})))}))}},{key:"onReadReceiptList",value:function(e){var t=this;Ne.l("".concat(this._n,".onReadReceiptList options:"),e),e.dataList.forEach((function(e){var n=e.groupProfile,o=(e=e.elements,n=n.groupID,t.get(11));e=e.readReceiptList,o.updateReadReceiptInfo({groupID:n,readReceiptList:e})}))}},{key:"onMsgModified",value:function(e){Ne.l("".concat(this._n,".onMsgModified options:"),e);var n=this.get(11);e.dataList.forEach((function(e){n.onMessageModified(t(t({},e),{},{conversationType:D.CONV_GROUP,to:e.topicID||e.groupID}))}))}},{key:"deleteGroupSystemNotice",value:function(e){this._groupSystemNoticeHandler.deleteGroupSystemNotice(e)}},{key:"initGroupMap",value:function(e){this.groupMap.set(e.groupID,new di(e))}},{key:"clearGroupMap",value:function(){this.groupMap.clear()}},{key:"deleteGroup",value:function(e){this.groupMap.delete(e)}},{key:"updateGroupMap",value:function(e){var t,n=this,o=this.get(11);e.forEach((function(e){t=e.groupID,n.groupMap.has(t)?n.groupMap.get(t).updateGroup(e):(n.groupMap.set(t,new di(e)),o.deleteGroupRoamingInfo(t))}));var i,s=this.getMyUserID(),a=T(this.groupMap);try{for(a.s();!(i=a.n()).done;){var r=f(i.value,2)[1];r.selfInfo.userID=s,"Owner"===r.selfInfo.role&&(r.ownerID=s)}}catch(e){a.e(e)}finally{a.f()}}},{key:"getGroupMap",value:function(){return this.groupMap}},{key:"getLocalGroupList",value:function(){return m(this.groupMap.values()).filter((function(e){return e.type!==D.GRP_ROOM&&e.type!==D.GRP_LIVE}))}},{key:"getLocalGroupProfile",value:function(e){return this.groupMap.get(e)}},{key:"sortLocalGroupList",value:function(){var e=m(this.groupMap).filter((function(e){return(e=f(e,2))[0],!He(e[1].lastMessage)}));e.sort((function(e,t){return t[1].lastMessage.lastTime-e[1].lastMessage.lastTime})),this.groupMap=new Map(m(e))}},{key:"updateGroupLastMessage",value:function(e){this._commonGroupHandler.updateLastMsg(e)}},{key:"emitGroupListUpdate",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=this.getLocalGroupList();e&&this.emitOEvt(E.GROUP_LIST_UPDATED),t&&(e=JSON.parse(JSON.stringify(n)),this.get(11).updateConvGroupProfile(e))}},{key:"getMyNameCardByGroupID",value:function(e){return(e=this.getLocalGroupProfile(e))?e.selfInfo.nameCard:""}},{key:"isPagingGetCompleted",value:function(){return this._commonGroupHandler.isPagingGetCompleted()}},{key:"getMsgRemindType",value:function(e){var t=this;return Xe(e)&&0!==e.length?0===(e=e.filter((function(e){return!Tt(t.getLocalGroupProfile(e).type)}))).length?Promise.resolve():(Ne.l("".concat(this._n,".getMsgRemindType groupIDList:").concat(e)),this.getGroupProfileAdvance({groupIDList:e,responseFilter:{memberInfoFilter:["MsgFlag"]}}).then((function(e){e=e.data.successGroupList;var n=t.get(11);e.forEach((function(e){n.onGroupMsgRemindTypeUpdated({groupID:e.groupID,messageRemindType:Xe(e.members)?e.members[0].messageRemindType:""})}))}))):Promise.resolve()}},{key:"getGroupList",value:function(){return this._commonGroupHandler.getGroupList()}},{key:"syncCommunityWithTopic",value:function(){return this._commonGroupHandler.syncGroupList(!0)}},{key:"getGroupProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("getGroupProfile"),o=new so("getGroupProfile"),i=e.groupID,s=e.groupCustomFieldFilter;return Ne.l("".concat(n," groupID:").concat(i)),s={groupIDList:[i],responseFilter:{groupBaseInfoFilter:m(w),groupCustomFieldFilter:s,memberInfoFilter:[].concat(m(F),["NameCard"])}},this.getGroupProfileAdvance(s).then((function(e){var s=(e=e.data).successGroupList;return e=e.failureGroupList,Ne.l("".concat(n," ok")),0<e.length?Rn(e[0]):((e=Tt(s[0].type)&&!t.hasLocalGroup(i)?new di(s[0]):(t.updateGroupMap(s),t.getLocalGroupProfile(i))).isSupportTopic||t.get(11).updateConvGroupProfile([e]),o.setMessage("groupID:".concat(i," type:").concat(e.type," muteAllMembers:").concat(e.muteAllMembers," ownerID:").concat(e.ownerID)).end(),En({group:e}))})).catch((function(t){return o.setError(t).setMessage("groupID:".concat(e.groupID)).end(),Ne.e("".concat(n," failed. error:"),t),Rn(t)}))}},{key:"getGroupProfileAdvance",value:function(e){var n,o="".concat(this._n,".getGroupProfileAdvance"),i=(Xe(a=e.groupIDList)&&50<a.length&&(this.warn("GetGroupProfileLimit"),a.length=50),[]),s=[],a=(a.forEach((function(e){(Et({groupID:e})?s:i).push(e)})),[]);return 0<i.length&&(n=this._getGroupProfileAdvance(t(t({},e),{},{groupIDList:i})),a.push(n)),0<s.length&&(n=this._getGroupProfileAdvance(t(t({},e),{},{groupIDList:s,relayFlag:0<i.length})),a.push(n)),Promise.all(a).then((function(e){var t=[],n=[];return e.forEach((function(e){t.push.apply(t,m(e.successGroupList)),n.push.apply(n,m(e.failureGroupList))})),En({successGroupList:t,failureGroupList:n})})).catch((function(e){return Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"_getGroupProfileAdvance",value:function(e){var t=this,n=e.relayFlag,o=void 0!==n&&n,i=_(e,Li);return this.req({P:Kn.GET_GRP_PROFILE,data:i}).then((function(e){return Ne.l("".concat(t._n,"._getGroupProfileAdvance ok. options:"),i),{successGroupList:(e=e.data.groups).filter((function(e){return pt(e.errorCode)||0===e.errorCode})),failureGroupList:e.filter((function(e){return e.errorCode&&0!==e.errorCode})).map((function(e){return new Vn({code:e.errorCode,message:e.errorInfo,data:{groupID:e.groupID}})}))}})).catch((function(t){return o&&Et({groupID:e.groupIDList[0]})?{successGroupList:[],failureGroupList:[]}:Rn(t)}))}},{key:"createGroup",value:function(e){var n=this,o=[D.GRP_PUBLIC,D.GRP_WORK,D.GRP_MEETING,D.GRP_AVCHATROOM,D.GRP_COMMUNITY],i="".concat(this._n,".").concat("createGroup"),s=e.type,a=e.groupID;if(e.name&&!1===this._filterProfanity("name",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return Rn({code:Bn.PROFANITY_FOUND});if(!o.includes(s))return Rn({code:Bn.ILLEGAL_GRP_TYPE});if(!Et({type:s})){if(!He(a)&&Et({groupID:a}))return Rn({code:Bn.ILLEGAL_GRP_ID});e.isSupportTopic=void 0}if(Tt(s)&&!pt(e.memberList)&&0<e.memberList.length&&(e.memberList=void 0),this._canIUseJoinOption(s)||pt(e.joinOption)||(e.joinOption=void 0),Et({type:s})){if(!He(a)&&!Et({groupID:a}))return Rn({code:Bn.ILLEGAL_GRP_ID});e.isSupportTopic=!0===e.isSupportTopic?1:0}var r=new so("createGroup"),c=(Ne.l("".concat(i," options:"),e),null),u=[];return this.req({P:Kn.CREATE_GRP,data:t(t({},e),{},{ownerID:this.getMyUserID(),webPushFlag:1})}).then((function(o){var s=(o=o.data).groupID,a=void 0===(o=o.overLimitUserIDList)?[]:o;if(c=s,u=a,o="groupType:".concat(e.type," groupID:").concat(s," overLimitUserIDList:").concat(a),r.setMessage(o).end(),Ne.l("".concat(i," ok. ").concat(o)),e.type===D.GRP_AVCHATROOM)return n.getGroupProfile({groupID:s});if(e.type===D.GRP_COMMUNITY&&1===e.isSupportTopic)return n.getGroupProfile({groupID:s});He(e.memberList)||He(a)||(e.memberList=e.memberList.filter((function(e){return-1===a.indexOf(e.userID)}))),n.updateGroupMap([t(t({},e),{},{groupID:s})]),o=n.get(2);var l="",d=0,p=(e.type===D.GRP_COMMUNITY?(l=n.isIntl()?"Create Community":"创建社群",d=1):l=n.isIntl()?"Create Group":"创建群组",n.get(4).getMyNick());return l=o.createCustomMessage({to:s,conversationType:D.CONV_GROUP,payload:{data:JSON.stringify({businessID:"group_create",content:l,cmd:d,opUser:p||n.getMyUserID(),version:4})}}),o.sendMessageInstance(l),n.emitGroupListUpdate(),n.getGroupProfile({groupID:s})})).then((function(e){var t=(n=(e=e.data.group).selfInfo).nameCard,n=n.joinTime;return e.updateSelfInfo({nameCard:t,joinTime:n,messageRemindType:D.MSG_REMIND_ACPT_AND_NOTE,role:D.GRP_MBR_ROLE_OWNER}),En({group:e,overLimitUserIDList:u})})).catch((function(o){var s;return r.setMessage("groupType:".concat(e.type)).setError(o).end(),10010===o.code||10007===o.code?(n._silentlyGetGroupProfile(o.code,c),n.updateGroupMap([t(t({},e),{},{groupID:c})]),(s=n.getLocalGroupProfile(c)).selfInfo.role=D.GRP_MBR_ROLE_OWNER,En({group:s,overLimitUserIDList:u})):(Ne.e("".concat(i," failed. error:"),o),Rn(o))}))}},{key:"dismissGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("dismissGroup"),o="groupID:".concat(e),i=new so("dismissGroup");return i.setMessage(o),Ne.l("".concat(n," ").concat(o)),this.req({P:Kn.DISMISS_GRP,data:{groupID:e}}).then((function(){return i.end(),Ne.l("".concat(n," ok")),t.deleteLocalGroupAndConversation(e),t.checkJoinedAVChatRoomByID(e)&&t._AVChatRoomHandler.reset(e),t._groupAttributesHandler.deleteLocalGroupAttributes(e),En({groupID:e})})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"updateGroupProfile",value:function(e){var t,n=this,o="".concat(this._n,".").concat("updateGroupProfile");if(this.hasLocalGroup(e.groupID)&&(t=this.getLocalGroupProfile(e.groupID).type,this._canIUseJoinOption(t)||pt(e.joinOption)||(Ne.w("".concat(o," joinOption is unavailable for Work/Meeting/AVChatRoom")),e.joinOption=void 0)),pt(e.muteAllMembers)||(e.muteAllMembers?e.muteAllMembers="On":e.muteAllMembers="Off"),e.name&&!1===this._filterProfanity("name",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return Rn({code:Bn.PROFANITY_FOUND});var i=new so("updateGroupProfile");return i.setMessage(JSON.stringify(e)),Ne.l("".concat(o," groupID:").concat(e.groupID)),this.req({P:Kn.UPDATE_GRP_PROFILE,data:e}).then((function(){return i.end(),Ne.l("".concat(o," ok")),n.hasLocalGroup(e.groupID)&&n.groupMap.get(e.groupID).updateGroup(e),En({group:n.groupMap.get(e.groupID)})})).catch((function(e){return i.setError(e).end(),Ne.l("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"_filterProfanity",value:function(e,t){if(!(o=this.get(29)))return!0;var n=(o=o.filterText(t[e],b)).isAllowedToSend,o=o.modifiedText;return!0===n&&(t[e]=o,!0)}},{key:"joinGroup",value:function(e){var t=this,n=e.groupID,o="".concat(this._n,".joinGroup");if(this.deleteUnjoinedAVChatRoom(n),this.hasLocalGroup(n)){if(!this.isLoggedIn())return Dn({status:D.JOIN_STATUS_ALREADY_IN_GROUP});var i=new so("applyJoinGroup");return this.getGroupProfile({groupID:n}).then((function(){return i.setMessage("groupID:".concat(n," joinedStatus:").concat(D.JOIN_STATUS_ALREADY_IN_GROUP)).end(),Dn({status:D.JOIN_STATUS_ALREADY_IN_GROUP})})).catch((function(s){return i.setMessage("groupID:".concat(n," unjoined")).end(),Ne.w("".concat(o," ").concat(n," was unjoined, now join!")),t.groupMap.delete(n),t.applyJoinGroup(e)}))}return Ne.l("".concat(o," groupID:").concat(n)),this.isLoggedIn()?this.applyJoinGroup(e):this._AVChatRoomHandler.joinWithoutAuth(e)}},{key:"applyJoinGroup",value:function(e){var n=this,o="".concat(this._n,".").concat("applyJoinGroup"),i=e.groupID;if(!He(e.applyMessage)&&!1===this._filterProfanity("applyMessage",e))return Rn({code:Bn.PROFANITY_FOUND});var s=new so("applyJoinGroup"),a=(e=t({},e),this.canIUse(U.AV_HISTORY_MSG));return a&&(e.historyMessageFlag=1),this.get(11).deleteTopicRoamingInfo(i),this.req({P:Kn.APPLY_JOIN_GRP,data:e}).then((function(e){var t=(e=e.data).joinedStatus,r=e.longPollingKey,c=e.startSeq,u=e.avChatRoomFlag,l=e.avChatRoomKey,d=e.messageList;switch(e="groupID:".concat(i," joinedStatus:").concat(t," longPollingKey:").concat(r," startSeq:").concat(c)+" avChatRoomFlag:".concat(u," canGetAVChatRoomHistoryMsg:").concat(a,",")+" historyMsgCount:".concat(He(d)?0:d.length),s.setMessage(e).end(),Ne.l("".concat(o," ok. ").concat(e)),t){case xe:return En({status:xe});case qe:return n.getGroupProfile({groupID:i}).then((function(e){return e=e.data.group,n._handleJoinResult({group:e,avChatRoomFlag:u,longPollingKey:r,startSeq:c,avChatRoomKey:l,messageList:d})})).catch((function(e){var t;return 10010===e.code||10007===e.code?(n._silentlyGetGroupProfile(e.code,i),t=new di({groupID:i}),n.updateGroupMap([t]),n._handleJoinResult({group:t,avChatRoomFlag:u,longPollingKey:r,startSeq:c,avChatRoomKey:l,messageList:d})):(Ne.e("".concat(o," failed. error:"),e),Rn(e))}));default:var p=new Vn({code:Bn.JOIN_GRP_FAIL});return Ne.e("".concat(o," failed. error:"),p),Rn(p)}})).catch((function(e){return s.setMessage("groupID:".concat(i)).setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"_handleJoinResult",value:function(e){var t=this,n=e.group,o=e.avChatRoomFlag,i=e.longPollingKey,s=e.startSeq,a=e.avChatRoomKey,r=e.messageList,c=n.groupID;return 1===o?(this.get(11).setCompleted("".concat(D.CONV_GROUP).concat(c)),this._groupAttributesHandler.initGroupAttributesCache({groupID:c,avChatRoomKey:a}),this._groupCountersHandler.initGroupCountersCache({groupID:c,avChatRoomKey:a}),(e=pt(i)?this._AVChatRoomHandler.handleJoinResult({group:n}):this._AVChatRoomHandler.startRunLoop({group:n,longPollingKey:i,startSeq:s})).then((function(){t._onAVChatRoomHistoryMessage(r,c)})),e):(this.emitGroupListUpdate(!0,!1),En({status:qe,group:n}))}},{key:"quitGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("quitGroup"),o="groupID:".concat(e),i=(Ne.l("".concat(n," ").concat(o)),this.checkJoinedAVChatRoomByID(e));if(!i&&!this.hasLocalGroup(e))return Rn({code:Bn.MEMBER_NOT_IN_GRP});if(i&&!this.isLoggedIn())return Ne.l("".concat(n," anonymously ok. ").concat(o)),this.deleteLocalGroupAndConversation(e),this._AVChatRoomHandler.reset(e),Dn({groupID:e});var s=new so("quitGroup");return s.setMessage(o),this.req({P:Kn.QUIT_GRP,data:{groupID:e}}).then((function(){return s.end(),Ne.l("".concat(n," ok")),t.deleteLocalGroupAndConversation(e),i&&t._AVChatRoomHandler.reset(e),t._groupAttributesHandler.deleteLocalGroupAttributes(e),En({groupID:e})})).catch((function(e){return s.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"searchGroupByID",value:function(e){var t="".concat(this._n,".").concat("searchGroupByID"),n={groupIDList:[e]},o=new so("searchGroupByID");return o.setMessage("groupID:".concat(e)),Ne.l("".concat(t," groupID:").concat(e)),this.req({P:Kn.SEARCH_GRP,data:n}).then((function(e){if(0!==(e=e.data.groupProfile)[0].errorCode)throw new Vn({code:e[0].errorCode,message:e[0].errorInfo});return o.end(),Ne.l("".concat(t," ok")),En({group:new di(e[0])})})).catch((function(e){return o.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"changeGroupOwner",value:function(e){var t=this,n="".concat(this._n,".").concat("changeGroupOwner");if(this.hasLocalGroup(e.groupID)&&this.getLocalGroupProfile(e.groupID).type===D.GRP_AVCHATROOM)return Rn({code:Bn.CANNOT_CHANGE_OWNER_IN_AV});if(e.newOwnerID===this.getMyUserID())return Rn({code:Bn.CANNOT_CHANGE_OWNER_TO_SELF});var o=new so("changeGroupOwner");return o.setMessage("groupID:".concat(e.groupID," newOwnerID:").concat(e.newOwnerID)),Ne.l("".concat(n," groupID:").concat(e.groupID)),this.req({P:Kn.CHANGE_GRP_OWNER,data:e}).then((function(){o.end(),Ne.l("".concat(n," ok"));var i,s=e.groupID,a=e.newOwnerID,r=(t.groupMap.get(s).ownerID=a,t._groupMemberHandler.getLocalGroupMemberList(s));return r instanceof Map&&(i=r.get(t.getMyUserID()),pt(i)||(i.updateRole("Member"),t.groupMap.get(s).selfInfo.role="Member"),i=r.get(a),pt(i)||i.updateRole("Owner")),t.emitGroupListUpdate(!0,!1),En({group:t.groupMap.get(s)})})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"getGroupApplicationList",value:function(){return this._groupSystemNoticeHandler.getGroupApplicationList()}},{key:"handleGroupApplication",value:function(e){var t,n,o,i,s,a=this,r="".concat(this._n,".").concat("handleGroupApplication"),c=e.handleAction,u=e.handleMessage,l=e.message,d=e.application,p=(l?(t=l.payload.operatorID,n=l.payload.groupProfile.groupID,o=l.payload.authentication,i=l.payload.messageKey):d&&(t=d.applicant,n=d.groupID,o=d.authentication,i=d.messageKey),Kn.HANDLE_GRP_APPLICATION),_=(d&&2===d.applicationType&&(p=Kn.HANDLE_INVITE_JOIN_GRP,s=d.userID),new so("handleGroupApplication"));return _.setMessage("groupID:".concat(n)),Ne.l("".concat(r," groupID:").concat(n)),this.req({P:p,data:{handleAction:c,handleMessage:u,applicant:t,invitee:s,groupID:n,authentication:o,messageKey:i}}).then((function(){return _.end(),Ne.l("".concat(r," ok")),l&&a._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),En({group:a.getLocalGroupProfile(n)})})).catch((function(e){return _.setError(e).end(),Ne.e("".concat(r," failed. error"),e),Rn(e)}))}},{key:"handleGroupInvitation",value:function(e){var n=this,o="".concat(this._n,".").concat("handleGroupInvitation"),i=(r=e.message.payload).groupProfile.groupID,s=r.authentication,a=r.messageKey,r=r.operatorID,c=e.handleAction,u=new so("handleGroupInvitation");return u.setMessage("groupID:".concat(i," inviter:").concat(r," handleAction:").concat(c)),Ne.l("".concat(o," groupID:").concat(i," inviter:").concat(r," handleAction:").concat(c)),this.req({P:Kn.HANDLE_GRP_INVITATION,data:t(t({},e),{},{inviter:r,groupID:i,authentication:s,messageKey:a})}).then((function(){return u.end(),Ne.l("".concat(o," ok")),n._groupSystemNoticeHandler.deleteGroupSystemNotice({messageList:[e.message]}),En({group:n.getLocalGroupProfile(i)})})).catch((function(e){return u.setError(e).end(),Ne.e("".concat(o," failed. error"),e),Rn(e)}))}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this,n="".concat(this._n,".getGroupOnlineMemberCount"),o=this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e),i=this.hasLocalGroup(e);if(Ne.l("".concat(n," groupID:").concat(e," isAVChatRoom:").concat(o," has:").concat(i)),o)return this._AVChatRoomHandler.getGroupOnlineMemberCount(e);if(!i)return Dn({memberCount:0});if(o=Date.now(),this._onlineMemberCountMap.has(e)){if(o-(i=this._onlineMemberCountMap.get(e)).lastReqTime<=6e4)return Dn({memberCount:i.memberCount});i.lastReqTime=o}return this.requestOnlineCount(e).then((function(o){return o=void 0===(o=o.data.memberCount)?0:o,t._onlineMemberCountMap.set(e,{lastReqTime:Date.now(),memberCount:o}),Ne.l("".concat(n," ok. groupID:").concat(e," memberCount:").concat(o)),Dn({memberCount:o})})).catch((function(e){return Ne.w("".concat(n," failed. error:"),e),Promise.reject(e)}))}},{key:"requestOnlineCount",value:function(e){return this.req({P:Kn.GET_ONLINE_MBR_NUM,data:{groupID:e}})}},{key:"hasLocalGroup",value:function(e){return this.groupMap.has(e)}},{key:"deleteLocalGroupAndConversation",value:function(e){var t,n=this.checkJoinedAVChatRoomByID(e),o=(Ne.l("".concat(this._n,".deleteLocalGroupAndConversation groupID:").concat(e," isJoinedAVChatRoom:").concat(n)),this.get(11)),i="".concat(D.CONV_GROUP).concat(e);n&&(this.stopMessageLongPolling({groupID:e}),o.deleteLocalConv(i)),Et({groupID:e})&&(t=this.getLocalGroupProfile(e))&&!0===t.isSupportTopic&&this.get(10).deleteTopicListInCommunity(e),o.clearUnreadCount(i),o.setCompleted(i),this._deleteLocalGroup(e),this._onlineMemberCountMap.delete(e),this.emitGroupListUpdate(!0,!1)}},{key:"_deleteLocalGroup",value:function(e){this.groupMap.delete(e),this._groupMemberHandler.deleteGroupMemberList(e)}},{key:"sendMessage",value:function(e,t){return Xe(e._receiverList)&&0<e._receiverList.length&&!this.canIUse(U.MSG_TO_SPECIFIED_GRP_MBR)?this.noUse("Targeted Group Message"):(e=this.createGroupMessagePack(e,t),this.req(e))}},{key:"createGroupMessagePack",value:function(e,t){var n=null,o=(t&&t.offlinePushInfo&&(n=t.offlinePushInfo),""),i=(dt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(o=e.cloudCustomData),[]),s=void(ze(t)&&ze(t.messageControlInfo)&&(s=(r=t.messageControlInfo).excludedFromUnreadCount,a=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===s&&i.push("NoUnread"),!0===a&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck"))),a=(Xe(e._receiverList)&&0<e._receiverList.length&&(s=e._receiverList,50<e._receiverList.length&&(s=e._receiverList.slice(0,50),this.warn("ReceiverListLimit"))),this.isOnlineMessage(e,t)?1:0),r=JSON.parse(JSON.stringify(e.getElements())),c=this.get(17).getFileDNList(),u=e.getGroupAtInfoList();return r={fromAccount:this.getMyUserID(),groupID:e.to,msgBody:_o(e.type,r,c),cloudCustomData:o,random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:e.type!==D.MSG_TEXT||He(u)?void 0:u,onlineOnlyFlag:a,clientTime:e.clientTime,offlinePushInfo:Ko(n),messageControlInfo:0==a?i:void 0,needReadReceipt:!0!==e.needReadReceipt||this.isMessageFromOrToAVChatroom(e.to)?0:1,receiverList:s,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0,cmConfigID:e._cmConfigID,forbidCallbackControl:Mt(t)},Dt(e.to)&&(r.groupID=xt(e.to),r.topicID=e.to),{P:Kn.SEND_GRP_MSG,data:r}}},{key:"revokeMessage",value:function(e){var t={groupID:e.to,msgSeqList:[{msgSeq:e.sequence}]};return Dt(e.to)&&(t.groupID=xt(e.to),t.topicID=e.to),this.req({P:Kn.REVOKE_GRP_MSG,data:t})}},{key:"deleteMessage",value:function(e){var t=e.to;return e=e.keyList,Ne.l("".concat(this._n,".deleteMessage groupID:").concat(t," count:").concat(e.length)),e={groupID:t,deleter:this.getMyUserID(),keyList:e},Dt(t)&&(e.groupID=xt(t),e.topicID=t),this.req({P:Kn.DEL_GRP_MSG,data:e})}},{key:"modifyRemoteMessage",value:function(e){var t=e.to,n=e.sequence,o=e.payload,i=e.type,s=void 0===(s=e.version)?0:s,a=e.cloudCustomData,r=(e=e._elements,t),c=void 0;return t=void(Dt(t)&&(r=xt(t),c=t)),Bt(i)&&(1<e.length&&e.splice(0,1,{type:i,content:o}),t=e),this.req({P:Kn.MODIFY_GRP_MSG,data:{groupID:r,topicID:c,sequence:n,version:s,elements:t,cloudCustomData:a}})}},{key:"getRoamingMessage",value:function(e){var t=this,n="".concat(this._n,".").concat("getRoamingMessage"),o=e.conversationID,i=e.groupID,s=(e=e.sequence,new so("getRoamingMessage")),a=0,r=void 0;return Dt(i)&&(i=xt(r=i)),this._computeLastSequence({groupID:i,topicID:r,sequence:e}).then((function(e){return a=e,Ne.l("".concat(n," groupID:").concat(i," startSequence:").concat(a)),t.req({P:Kn.GET_GRP_ROAMING_MSG,data:{groupID:i,count:21,sequence:a,topicID:r}})})).then((function(e){var c=(l=e.data).messageList,u=l.complete,l=void 0===(l=l.invisibleSequenceList)?[]:l,d=(e=void 0===(e=e.data.nextSequence)?0:e,pt(c)?Ne.l("".concat(n," ok. complete:").concat(u," nextSequence:").concat(e," but messageList is undefined!")):Ne.l("".concat(n," ok. complete:").concat(u," nextSequence:").concat(e," count:").concat(c.length)),s.setMessage("groupID:".concat(i," topicID:").concat(r," startSequence:").concat(a," complete:").concat(u," nextSequence:").concat(e)).end(),t.get(11)),p=[],_=[];return He(c)||(p=d.onRoamingMessage(c,o,!0,_),d.updateIsRead(o),d.patchConvLastMessage(o)),(c=2===u||e<1)&&(d.setCompleted(o),e=""),Ne.l("".concat(n," isPullingCompleted:").concat(c," nextReqID:").concat(e," storedMsgCount:").concat(p.length)+" invisibleSeqCount:".concat(l.length)),{nextReqID:e+"",storedMessageList:p,assembledMessageList:_,isPullingCompleted:c}})).catch((function(e){return s.setError(e).setMessage("groupID:".concat(i," topicID:").concat(r," startSequence:").concat(a)).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"_getGroupIDOfMessage",value:function(e){return e.conversationID.replace(D.CONV_GROUP,"")}},{key:"getReadReceiptList",value:function(e){var t="".concat(this._n,".").concat("getReadReceiptList"),n=this._getGroupIDOfMessage(e[0]),o=this.getMyUserID(),i=e.filter((function(e){return e.from===o&&!0===e.needReadReceipt})).map((function(e){return{sequence:e.sequence}}));if(Ne.l("".concat(t," groupID:").concat(n," sequenceList:").concat(JSON.stringify(i))),0===i.length)return Dn({messageList:e});var s=new so("getReadReceiptList");return s.setMessage("groupID:".concat(n)),this.req({P:Kn.GET_READ_RECEIPT,data:{groupID:n,sequenceList:i}}).then((function(n){return s.end(),Ne.l("".concat(t," ok")),Xe(n=n.data.readReceiptList)&&n.forEach((function(t){e.forEach((function(e){0===t.code&&t.sequence===e.sequence&&(e.readReceiptInfo.readCount=t.readCount,e.readReceiptInfo.unreadCount=t.unreadCount)}))})),En({messageList:e})})).catch((function(e){return s.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"sendReadReceipt",value:function(e){var t="".concat(this._n,".").concat("sendReadReceipt"),n=this._getGroupIDOfMessage(e[0]),o=new so("sendReadReceipt"),i=(o.setMessage("groupID:".concat(n)),this.getMyUserID());return 0===(e=e.filter((function(e){return e.from!==i&&!0===e.needReadReceipt})).map((function(e){return{sequence:e.sequence}}))).length?Rn({code:Bn.READ_RECEIPT_MSG_LIST_EMPTY}):(Ne.l("".concat(t,". sequenceList:").concat(JSON.stringify(e))),this.req({P:Kn.SEND_READ_RECEIPT,data:{groupID:n,sequenceList:e}}).then((function(e){return o.end(),Ne.l("".concat(t," ok")),En()})).catch((function(e){return o.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)})))}},{key:"getReadReceiptDetail",value:function(e){var t=this,n=e.message,o=e.filter,i=e.cursor,s=(e=e.count,this._getGroupIDOfMessage(n)),a=n.ID,r=(n=n.sequence,"".concat(this._n,".").concat("getReadReceiptDetail")),c=this._receiptDetailCompleteMap.get(a)||!1,u=0!==o&&1!==o?0:o,l=(o=dt(i)?i:"",i=!je(e)||e<=0||100<=e?100:e,e="groupID:".concat(s," sequence:").concat(n," cursor:").concat(o," filter:").concat(u," completeFlag:").concat(c),Ne.l("".concat(r," ").concat(e)),{cursor:"",isCompleted:!1,messageID:a,unreadUserIDList:[],readUserIDList:[]}),d=new so("getReadReceiptDetail");return d.setMessage(e),this.req({P:Kn.GET_READ_RECEIPT_DETAIL,data:{groupID:s,sequence:n,flag:u,cursor:o,count:i}}).then((function(e){d.end();var n=(e=e.data).cursor,o=e.isCompleted,i=e.unreadUserIDList;return e=e.readUserIDList,l.cursor=n,1===o&&(l.isCompleted=!0,t._receiptDetailCompleteMap.set(a,!0)),0===u?l.readUserIDList=e.map((function(e){return e.userID})):1===u&&(l.unreadUserIDList=i.map((function(e){return e.userID}))),Ne.l("".concat(r," ok")),En(l)})).catch((function(e){return d.setError(e).end(),Ne.w("".concat(r," failed. error:"),e),Rn(e)}))}},{key:"getRoamingMessagesHopping",value:function(e){var t=this,n="".concat(this._n,".").concat("getRoamingMessagesHopping"),o=e.groupID,i=e.count,s=e.sequence,a=e.direction,r=void 0;return pt(s)&&1===a?Dn({messageList:[],isCompleted:!0,nextMessageSeq:""}):(Dt(o)&&(o=xt(r=o)),this._computeReqSeqHopping({groupID:o,topicID:r,sequence:s}).then((function(c){pt(s)||1!==a||(c=s+i-1);var u="".concat(r?"topicID:".concat(r):"groupID:".concat(o)," sequence:").concat(s," reqSeq:").concat(c," direction:").concat(a),l=(Ne.l("".concat(n," ").concat(u)),new so("getRoamingMessagesHopping"));return t.req({P:Kn.GET_GRP_ROAMING_MSG,data:{groupID:o,topicID:r,count:i,sequence:c}}).then((function(o){var i=void 0===(i=(o=o.data).messageList)?[]:i,r=o.complete,c=void 0===(c=o.nextSequence)?0:c,d=(o=void 0===(o=o.invisibleSequenceList)?[]:o,"complete:".concat(r," nextSequence:").concat(c," remoteMsgCount:").concat(i.length," invisibleSequenceList:").concat(o)),p=(l.setMessage("".concat(u," ").concat(d)).end(),Ne.l("".concat(n," ok. ").concat(d)),d="".concat(D.CONV_GROUP).concat(e.groupID),t.get(11));return d=p.onRoamingMessage(i,d,!1),i=t._computeResult({groupID:e.groupID,direction:a,sequence:s,remoteMessageList:i,processedMessageList:d,complete:r,nextSequence:c,invisibleSequenceList:o}),p.storeHoppingMessageList(i.messageList),En(i)})).catch((function(e){return l.setError(e).setMessage("groupID:".concat(o," sequence:").concat(s," count:").concat(i)).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))})))}},{key:"_computeReqSeqHopping",value:function(e){var t=this,n=e.groupID,o=void 0===(o=e.topicID)?void 0:o;return 0<(e=void 0===(e=e.sequence)?void 0:e)?Promise.resolve(e):pt(o)?this.getGroupProfileAdvance({groupIDList:[n],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then((function(e){var o=0;return He(e=e.data.successGroupList)||(o=e[0].nextMessageSeq-1),Ne.l("".concat(t._n,"._computeReqSeqHopping groupID:").concat(n," lastSequence:").concat(o," from remote")),o})).catch((function(e){return Rn(e)})):Promise.resolve(0)}},{key:"_computeResult",value:function(e){var t={messageList:[],isCompleted:!1,nextMessageSeq:""},n=e.groupID,o=e.direction,i=e.sequence,s=void 0===(s=e.remoteMessageList)?[]:s,a=void 0===(a=e.processedMessageList)?[]:a,r=e.complete,c=e.nextSequence;if(e=e.invisibleSequenceList,0===o)return t.nextMessageSeq=c,(2===r||c<1)&&(t.isCompleted=!0,t.nextMessageSeq=""),t.messageList=a,t;if(1===o){if(He(s)){if(He(e))return t.isCompleted=!0,t.nextMessageSeq="",t;t.nextMessageSeq=e[0]+1}else r=s[0].sequence,c=e[0]||0,t.nextMessageSeq=c<r?r+1:c+1;return a.forEach((function(e){e.sequence>=i&&t.messageList.push(e)})),(Et({groupID:n})||Dt(n))&&0===t.messageList.length&&s[0].sequence<i&&(t.isCompleted=!0,t.nextMessageSeq=""),t}}},{key:"setMessageRead",value:function(e){var t=this,n=e.conversationID,o=e.lastMessageSeq,i="".concat(this._n,".").concat("setMessageRead"),s=(e="convID:".concat(n," lastMessageSeq:").concat(o),Ne.l("".concat(i," ").concat(e)),je(o)||this.warn("DoNotModifyLastSeq"),new so("setMessageRead")),a=(s.setMessage(e),n.replace(D.CONV_GROUP,"")),r=void 0;return Dt(a)&&(a=xt(r=a)),this.req({P:Kn.SET_GRP_MSG_READ,data:{groupID:a,topicID:r,messageReadSeq:o}}).then((function(){s.end(),Ne.l("".concat(i," ok"));var e,c=t.get(11),u=(c.updateIsReadAfterReadReport({conversationID:n,lastMessageSeq:o}),!0);return pt(r)||(u=!1,(e=t.get(10).getLocalTopic(a,r))&&e.updateSelfInfo({readedSequence:o})),c.updateUnreadCount(n,u),En()})).catch((function(e){return s.setError(e).end(),Ne.l("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"_computeLastSequence",value:function(e){var t=e.groupID,n=void 0===(n=e.topicID)?void 0:n;return 0<(e=e.sequence)?Promise.resolve(e):pt(n)?this.getGroupLastSequence(t):Promise.resolve(0)}},{key:"getGroupLastSequence",value:function(e){var t="".concat(this._n,".").concat("getGroupLastSequence"),n=new so("getGroupLastSequence"),o=0,i="",s="groupID:".concat(e);if(this.hasLocalGroup(e)){var a=this.getLocalGroupProfile(e),r=a.lastMessage;if(0<r.lastSequence&&!1===r.onlineOnlyFlag)return o=r.lastSequence,i="".concat(s,", ").concat(o," from group.lastMessage.lastSequence"),Ne.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o);if(1<a.nextMessageSeq)return o=a.nextMessageSeq-1,i="".concat(s,", ").concat(o," from group.nextMessageSeq"),Ne.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o)}return(r=this.get(11).getLocalConversation("GROUP".concat(e)))&&r.lastMessage.lastSequence&&!1===r.lastMessage.onlineOnlyFlag?(o=r.lastMessage.lastSequence,i="".concat(s,", ").concat(o," from conversation.lastMessage.lastSequence"),Ne.l("".concat(t," ").concat(i)),n.setMessage(i).end(),Promise.resolve(o)):this.getGroupProfileAdvance({groupIDList:[e],responseFilter:{groupBaseInfoFilter:["NextMsgSeq"]}}).then((function(e){return He(e=e.data.successGroupList)?Ne.w("".concat(t," ").concat(s,", empty successGroupList")):(o=e[0].nextMessageSeq-1,i="".concat(s,", ").concat(o," from remote"),Ne.l("".concat(t," ").concat(i))),n.setMessage(i).end(),o})).catch((function(e){return n.setError(e).setMessage(s).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"isMessageFromOrToAVChatroom",value:function(e){return this._AVChatRoomHandler.checkJoinedAVChatRoomByID(e)}},{key:"hasJoinedAVChatRoom",value:function(){return this._AVChatRoomHandler.hasJoinedAVChatRoom()}},{key:"getJoinedAVChatRoom",value:function(){return this._AVChatRoomHandler.getJoinedAVChatRoom()}},{key:"getGroupRemoteLastSeq",value:function(e){return(e=this.getLocalGroupProfile(e))?e.nextMessageSeq-1:1}},{key:"isOnlineMessage",value:function(e,t){return!(!this._canIUseOnlineOnlyFlag(e)||!t||!0!==t.onlineUserOnly)}},{key:"_canIUseOnlineOnlyFlag",value:function(e){var t=this.getJoinedAVChatRoom();return!t||!t.includes(e.to)||e.conversationType!==D.CONV_GROUP}},{key:"_onAVChatRoomHistoryMessage",value:function(e,n){var o;He(e)||(Ne.l("".concat(this._n,"._onAVChatRoomHistoryMessage groupID:").concat(n," count:").concat(e.length)),o=[],e.forEach((function(e){o.push(t(t({},e),{},{isHistoryMessage:1}))})),this.onAVChatRoomMessage(o,n))}},{key:"onAVChatRoomMessage",value:function(e){this._AVChatRoomHandler.onMessage(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:"")}},{key:"onAVChatRoomMemberBanned",value:function(e){this._AVChatRoomHandler.onAVChatRoomMemberBanned(e)}},{key:"setUnjoinedAVChatRoom",value:function(e){this._unjoinedAVChatRoomList.set(e,1)}},{key:"deleteUnjoinedAVChatRoom",value:function(e){this._unjoinedAVChatRoomList.has(e)&&this._unjoinedAVChatRoomList.delete(e)}},{key:"isUnjoinedAVChatRoom",value:function(e){return this._unjoinedAVChatRoomList.has(e)}},{key:"isGroupAttributesUpdatedNotice",value:function(e){return this._groupAttributesHandler.isGroupAttributesUpdatedNotice(e)}},{key:"updateLocalMainSequenceOnReconnected",value:function(){this._groupAttributesHandler.updateLocalMainSequenceOnReconnected()}},{key:"initGroupAttributes",value:function(e){return this._groupAttributesHandler.initGroupAttributes(e)}},{key:"setGroupAttributes",value:function(e){return this._groupAttributesHandler.setGroupAttributes(e)}},{key:"deleteGroupAttributes",value:function(e){return this._groupAttributesHandler.deleteGroupAttributes(e)}},{key:"getGroupAttributes",value:function(e){return this._groupAttributesHandler.getGroupAttributes(e)}},{key:"isMessageFromTopic",value:function(e,t){return 2===e&&!He(t)}},{key:"isMessageFromCommunityOfTopic",value:function(e,t){return 2===e&&He(t)}},{key:"getMessageExtensions",value:function(e,t){return Ne.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t)),this.req({P:Kn.GET_GRP_MSG_EXT,data:{groupID:e.to,messageSequence:e.sequence,startSequence:t}})}},{key:"modifyMsgExts",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;return Ne.l("".concat(this._n,".modifyMsgExts operateType:").concat(n)),this.req({P:Kn.MODIFY_GRP_MSG_EXT,data:{groupID:e.to,messageSequence:e.sequence,extensionList:t,operateType:n}})}},{key:"_genNotifyReqList",value:function(e){for(var t,n,o,i,s=[],a=0,r=e.length;a<r;a++)t=e[a],i=this.getLocalGroupProfile(t).type,n=this._getGroupLastRevokedTime(t),o=1e3*Le(),i={notifyType:1,limit:20,type:Et({type:i,groupID:t})?D.GRP_COMMUNITY:void 0,groupID:t,beginTime:n,endTime:o},s.push(i);return s}},{key:"getNotice",value:function(e){var t=this,n="".concat(this._n,".getNotice");e=e.filter((function(e){if(!t.hasLocalGroup(e))return!1;var n=(e=t.getLocalGroupProfile(e)).type;return e=e.isSupportTopic,!Tt(n)&&!e})),0!==e.length&&(Ne.l("".concat(n," list:").concat(e)),this.req({P:Kn.GET_GRP_NOTIFY,data:{notifyReqList:this._genNotifyReqList(e)}}).then((function(e){e=e.data.notifyRspList;var o,i,s=[];Xe(e)&&(o={dataList:[]},i="".concat(n," ok."),e.forEach((function(e){var n=e.nextRevokedTime,a=e.groupID,r=e.notifyList;i+=" groupID:".concat(a," nextRevokedTime:").concat(n," count:").concat(r.length,"\n"),o.dataList.push({elements:{revokedInfos:t._genRevokedInfos(e)}}),0!==n?(t._setGroupLastRevokedTime(a,n),s.push(a)):t._setGroupLastRevokedTime(a,1e3*Le())})),Ne.l(i),t.onMsgRevoked(o,!1)),0<s.length&&t.getNotice(s)})).catch((function(e){Ne.e("".concat(n," failed. error:"),e)})))}},{key:"_genRevokedInfos",value:function(e){var n=e.notifyList,o=e.groupID,i=[];return Xe(n)&&n.forEach((function(e){i.push({groupID:o,sequence:e.sequence,random:e.random,revokerInfo:t({},e.revokerInfo)})})),i}},{key:"_getGroupLastRevokedTime",value:function(e){return this.hasLocalGroup(e)?this.getLocalGroupProfile(e)._lastRevokedTime:0}},{key:"_setGroupLastRevokedTime",value:function(e,t){this.hasLocalGroup(e)&&(this.getLocalGroupProfile(e)._lastRevokedTime=t)}},{key:"isGroupCountersNotice",value:function(e){return this._groupCountersHandler.isGroupCountersNotice(e)}},{key:"setGroupCounters",value:function(e){return this._groupCountersHandler.setGroupCounters(e)}},{key:"increaseGroupCounter",value:function(e){return this._groupCountersHandler.increaseGroupCounter(e)}},{key:"decreaseGroupCounter",value:function(e){return this._groupCountersHandler.decreaseGroupCounter(e)}},{key:"getGroupCounters",value:function(e){return this._groupCountersHandler.getGroupCounters(e)}},{key:"getGroupMemberHandler",value:function(){return this._groupMemberHandler}},{key:"getGroupMemberList",value:function(e){return this._groupMemberHandler.getGroupMemberList(e)}},{key:"getGroupMemberProfile",value:function(e){return this._groupMemberHandler.getGroupMemberProfile(e)}},{key:"addGroupMember",value:function(e){return this._groupMemberHandler.addGroupMember(e)}},{key:"deleteGroupMember",value:function(e){return this._groupMemberHandler.deleteGroupMember(e)}},{key:"setGroupMemberMuteTime",value:function(e){return this._groupMemberHandler.setGroupMemberMuteTime(e)}},{key:"setGroupMemberRole",value:function(e){return this._groupMemberHandler.setGroupMemberRole(e)}},{key:"setGroupMemberNameCard",value:function(e){return this._groupMemberHandler.setGroupMemberNameCard(e)}},{key:"setGroupMemberCustomField",value:function(e){return this._groupMemberHandler.setGroupMemberCustomField(e)}},{key:"markGroupMemberList",value:function(e){return this._groupMemberHandler.markGroupMemberList(e)}},{key:"modifyGroupMemberInfo",value:function(e){return this._groupMemberHandler.modifyGroupMemberInfo(e)}},{key:"restartPolling",value:function(){this._AVChatRoomHandler.restartPolling()}},{key:"getPollingTimerID",value:function(e){if(!e)return-1;var t=this.getLocalGroupProfile(e);return t&&Tt(t.type)?this._AVChatRoomHandler.getPollingTimerID(e):-1}},{key:"_canIUseJoinOption",value:function(e){return e===D.GRP_PUBLIC||Et({type:e})}},{key:"_silentlyGetGroupProfile",value:function(e,t){var n=setTimeout(this.getGroupProfile.bind(this,{groupID:t}),3e3);this._timeoutIDs.push(n),Ne.l("".concat(this._n,"._silentlyGetGroupProfile errorCode:").concat(e," groupID:").concat(t," timeoutIDs:").concat(this._timeoutIDs))}},{key:"_clearTimeoutIDs",value:function(){this._timeoutIDs.forEach((function(e){e&&clearTimeout(e)})),this._timeoutIDs=[]}},{key:"startMessageLongPolling",value:function(e){var t=e.groupID,n=e.longPollingKey,o=(e=void 0===(e=e.longPollingSequence)?1:e,this.get(12).isUnlimitedAVChatRoom()),i=(this._AVChatRoomHandler.hasPollingInstance(t)&&this.stopMessageLongPolling({groupID:t}),this._AVChatRoomHandler.getJoinedLiveList());return!o&&0<i.length&&this.stopMessageLongPolling({groupID:i[0]}),o=new di({groupID:t,type:D.GRP_LIVE}),Ne.l("".concat(this._n,".startMessageLongPolling groupID:").concat(t," longPollingKey:").concat(n," longPollingSequence:").concat(e)),this._AVChatRoomHandler.startRunLoop({group:o,longPollingKey:n,startSeq:e})}},{key:"stopMessageLongPolling",value:function(e){e=e.groupID;var t=this.get(11);return this._AVChatRoomHandler.reset(e),this._deleteLocalGroup(e),t.deleteLocalConv("".concat(D.CONV_GROUP).concat(e)),Ne.l("".concat(this._n,".stopMessageLongPolling ok, groupID:").concat(e)),Dn({groupID:e})}},{key:"reset",value:function(){this.groupMap.clear(),this._unjoinedAVChatRoomList.clear(),this._receiptDetailCompleteMap.clear(),this._onlineMemberCountMap.clear(),this._commonGroupHandler.reset(),this._groupSystemNoticeHandler.reset(),this._groupTipsHandler.reset(),this._groupAttributesHandler.reset(),this._groupCountersHandler.reset(),this._AVChatRoomHandler.reset(),this._groupMemberHandler.reset(),this._clearTimeoutIDs()}}]),zi),ki=["topicID","topicName","avatar","introduction","notification","unreadCount","muteAllMembers","customData","groupAtInfoList","nextMessageSeq","selfInfo"],Oi=(s(Ji,[{key:"_initTopic",value:function(e){for(var t in e)ki.indexOf(t)<0||("selfInfo"===t?this.updateSelfInfo(e[t]):this[t]="muteAllMembers"===t?1===e[t]:e[t])}},{key:"updateUnreadCount",value:function(){this.unreadCount=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0}},{key:"updateNextMessageSeq",value:function(e){this.nextMessageSeq=e}},{key:"updateLastMessage",value:function(e){this.lastMessage=$o(e)}},{key:"updateGroupAtInfoList",value:function(e){this.groupAtInfoList=JSON.parse(JSON.stringify(e))}},{key:"updateTopic",value:function(e){pt(e.selfInfo)||this.updateSelfInfo(e.selfInfo),pt(e.muteAllMembers)||(this.muteAllMembers=1===e.muteAllMembers),nt(this,e,["groupID","lastMessageTime","selfInfo","muteAllMembers","lastMsg"])}},{key:"updateSelfInfo",value:function(e){return 0===nt(this.selfInfo,e,[],[""])}},{key:"reduceUnreadCount",value:function(){return 1<=this.unreadCount&&(--this.unreadCount,!0)}},{key:"isLastMessageRevoked",value:function(e){return e.sequence===this.lastMessage.lastSequence}},{key:"setLastMessageRevoked",value:function(e){this.lastMessage.isRevoked=e}},{key:"setLastMessageRevoker",value:function(e){this.lastMessage.revoker=e}}]),Ji),Ni=(r(ji,bn),oi=g(ji),s(ji,[{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("topic_cache_time"),t=this.getCloudConfig("topic_last_active_time");pt(e)||(this.TOPIC_CACHE_TIME=Number(e)),pt(t)||(this.TOPIC_LAST_ACTIVE_TIME=Number(t))}},{key:"onTopicCreated",value:function(e){var t=e.groupID;this.resetGetTopicTime(t),this.emitOEvt(E.TOPIC_CREATED,e)}},{key:"onTopicDeleted",value:function(e){var t=this,n=e.groupID,o=e.topicIDList;(void 0===o?[]:o).forEach((function(e){t._deleteLocalTopic(n,e)})),this.emitOEvt(E.TOPIC_DELETED,e)}},{key:"onTopicProfileUpdated",value:function(e){var t=e.groupID,n=e.topicID;(n=this.getLocalTopic(t,n))&&(n.updateTopic(e),this.emitOEvt(E.TOPIC_UPDATED,{groupID:t,topic:n}))}},{key:"onTopicLatestMsg",value:function(e){var t,n,o=(e=e||{}).topicLatestMessage;e=e.excludedUnreadSequenceList,He(o)||(t=o.groupProfile.topicID,o.conversationType=D.CONV_GROUP,o.to=t,(n=new ko(o)).setElement(o.elements),this.updateUnreadCountAndLastMsg(t,n,e))}},{key:"onMessageRemindTypeUpdated",value:function(e){var t,n=e.groupID,o=e.topicID,i=(e=e.messageRemindType,this.getLocalTopic(n,o));i&&((t=i.updateSelfInfo({messageRemindType:e}))&&this.emitOEvt(E.TOPIC_UPDATED,{groupID:n,topic:i}),Ne.l("".concat(this._n,".onMessageRemindTypeUpdated topicID:").concat(o," messageRemindType:").concat(e," isUpdated:").concat(t)))}},{key:"onAtInfoUpdated",value:function(e){var t=e.topicID,n=(e=e.groupAtInfoList,xt(t));(t=this.getLocalTopic(n,t))&&!pt(e)&&(t.updateGroupAtInfoList(e),this.emitOEvt(E.TOPIC_UPDATED,{groupID:n,topic:t}))}},{key:"onUnreadCountUpdatedFromConv",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=xt(e);(e=this.getLocalTopic(n,e))&&e.unreadCount!==t&&(e.updateUnreadCount(t),0===t&&e.updateSelfInfo({readedSequence:e.lastMessage.lastSequence}),this.emitOEvt(E.TOPIC_UPDATED,{groupID:n,topic:e}))}},{key:"onMessageSent",value:function(e){var t,n,o=e.groupID,i=e.topicID;e=e.lastMessage,!(i=this.getLocalTopic(o,i))||(n=(t=void 0===(t=e.sequence)?0:t)+1)>i.nextMessageSeq&&(i.updateNextMessageSeq(n),i.updateLastMessage(e),i.updateSelfInfo({readedSequence:t}),i.updateUnreadCount(0),this.emitOEvt(E.TOPIC_UPDATED,{groupID:o,topic:i}))}},{key:"onMessageModified",value:function(e){var t,n=e.to,o=e.time,i=e.sequence,s=e.elements,a=e.cloudCustomData,r=e.messageVersion,c=xt(n),u=this.getLocalTopic(c,n);u&&(t=u.lastMessage,Ne.d("".concat(this._n,".onMessageModified topicID:").concat(n," lastMessage:"),JSON.stringify(t),"options:",JSON.stringify(e)),t&&(null===t.payload||t.lastTime===o&&t.lastSequence===i&&t.version!==r)&&(t.type=s[0].type,t.payload=s[0].content,t.messageForShow=Vt(t.type,t.payload,this.isIntl()),t.cloudCustomData=a,t.version=r,t.lastSequence=i,t.lastTime=o,this.emitOEvt(E.TOPIC_UPDATED,{groupID:c,topic:u})))}},{key:"onMessageRevoked",value:function(e){var t,n,o,i=this;0!==e.length&&(n=t=null,o=!1,e.forEach((function(e){var s=e.to;n=xt(s),(t=i.getLocalTopic(n,s))&&(t.reduceUnreadCount()&&(o=!0),t.isLastMessageRevoked(e)&&(t.setLastMessageRevoked(!0),t.setLastMessageRevoker(e.revoker),o=!0),(s=t.selfInfo.excludedUnreadSequenceList||[]).push(e.sequence),t.updateSelfInfo({excludedUnreadSequenceList:s}))})),o&&this.emitOEvt(E.TOPIC_UPDATED,{groupID:n,topic:t}))}},{key:"isLastMessageRevoked",value:function(e){var t=e.topicID,n=(e=e.sequence,xt(t));return n=this.getLocalTopic(n,t),t=!1,n?n.isLastMessageRevoked({sequence:e}):t}},{key:"updateUnreadCountAndLastMsg",value:function(e,t,n){var o,i=xt(e),s=this.getLocalTopic(i,e);s&&(o=s.selfInfo.excludedUnreadSequenceList||[],pt(n)||(o=n),t._isExcludedFromUnreadCount&&o.push(t.sequence),s.updateSelfInfo({excludedUnreadSequenceList:o}),Ne.l("".concat(this._n,".updateUnreadCountAndLastMsg seq:").concat(t.sequence," lastSeq:").concat(s.lastMessage.lastSequence)),t.sequence>s.lastMessage.lastSequence&&(s.updateLastMessage(t),n=t.sequence+1,s.updateNextMessageSeq(n),o=this._computeUnreadCount(s),s.updateUnreadCount(o),(t=this.get(11).getLocalConversation("".concat(D.CONV_GROUP).concat(e)))&&t.updateUnreadCount({nextUnreadCount:o,isFromGetConversations:!0}),this.emitOEvt(E.TOPIC_UPDATED,{groupID:i,topic:s})))}},{key:"getJoinedCommunityList",value:function(){return this.get(7).syncCommunityWithTopic()}},{key:"createTopicInCommunity",value:function(e){var n=this,o="".concat(this._n,".").concat("createTopicInCommunity"),i=e.topicID;if(!pt(i)&&!Dt(i))return Rn({code:Bn.ILLEGAL_TOPIC_ID});if(e.topicName&&!1===this._filterProfanity("topicName",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return Rn({code:Bn.PROFANITY_FOUND});var s=new so("createTopicInCommunity");return this.req({P:Kn.CREATE_TOPIC,data:t({},e)}).then((function(i){return i=i.data.topicID,s.setMessage("topicID:".concat(i)).end(),Ne.l("".concat(o," ok. topicID:").concat(i)),n._updateTopicMap([t(t({},e),{},{topicID:i})]),En({topicID:i})})).catch((function(e){return s.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"deleteTopicFromCommunity",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteTopicFromCommunity"),o=e.groupID,i=(e=void 0===(e=e.topicIDList)?[]:e,new so("deleteTopicFromCommunity"));return i.setMessage("groupID:".concat(o," topicIDList:").concat(e)),this.req({P:Kn.DEL_TOPIC,data:{groupID:o,topicIDList:e}}).then((function(e){e=e.data.resultList;var s=[],a=[];return(void 0===e?[]:e).forEach((function(e){var t=e.topicID,n=e.errorCode;e=e.errorInfo,0===n?s.push({topicID:t}):a.push({topicID:t,code:n,message:e})})),e="success count:".concat(s.length,", fail count:").concat(a.length),i.setMoreMessage(e).end(),Ne.l("".concat(n," ok. ").concat(e)),s.forEach((function(e){t._deleteLocalTopic(o,e.topicID)})),En({successTopicList:s,failureTopicList:a})})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"updateTopicProfile",value:function(e){var n=this,o="".concat(this._n,".").concat("updateTopicProfile");if(Ne.l("".concat(o," options:"),e),e.topicName&&!1===this._filterProfanity("topicName",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.introduction&&!1===this._filterProfanity("introduction",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.notification&&!1===this._filterProfanity("notification",e))return Rn({code:Bn.PROFANITY_FOUND});var i=new so("updateTopicProfile");return i.setMessage("groupID:".concat(e.groupID," topicID:").concat(e.topicID)),pt(e.muteAllMembers)||(e.muteAllMembers=!0===e.muteAllMembers?"On":"Off"),this.req({P:Kn.UPDATE_TOPIC_PROFILE,data:t({},e)}).then((function(){return i.end(),Ne.l("".concat(o," ok")),n._updateTopicMap([e]),En({topic:n.getLocalTopic(e.groupID,e.topicID)})})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"getTopicList",value:function(e){var n=this,o="".concat(this._n,".").concat("getTopicList"),i=e.groupID,s=0===(e=void 0===(e=e.topicIDList)?[]:e).length,a=new so("getTopicList");if(a.setMessage("groupID:".concat(i)),this._getTopicTimeMap.has(i)){var r=(c=this._getTopicTimeMap.get(i)).isGetAll,c=c.time;if((r||!r&&!s)&&Date.now()-c<1e3*this.TOPIC_CACHE_TIME&&(r=this._getLocalTopicList(i,e),s||r.length===e.length))return a.setMoreMessage("from cache, topic count:".concat(r.length)).end(),Ne.l("".concat(o," groupID:").concat(i," from cache, topic count:").concat(r.length)),Dn({successTopicList:r,failureTopicList:[]})}return this.req({P:Kn.GET_TOPIC_LIST,data:{groupID:i,topicIDList:e}}).then((function(e){e=e.data.topicInfoList;var r=[],c=[],u=[];return(void 0===e?[]:e).forEach((function(e){var n=e.topic,o=e.selfInfo,i=e.errorCode,s=(e=e.errorInfo,n.topicID);0===i?(r.push(t(t({},n),{},{selfInfo:o})),c.push(s)):u.push({topicID:s,code:i,message:e})})),n._updateTopicMap(r),n._handleTopicAtInfo(r),e="success count:".concat(c.length,", fail count:").concat(u.length),a.setMoreMessage(e).end(),Ne.l("".concat(o," groupID:").concat(i," from remote, ").concat(e)),e=[],He(c)||(n._getTopicTimeMap.set(i,{time:Date.now(),isGetAll:s}),e=n._getLocalTopicList(i,c)),En({successTopicList:e,failureTopicList:u})})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"hasLocalTopic",value:function(e,t){return!!this._topicMap.has(e)&&this._topicMap.get(e).has(t)}},{key:"getLocalTopic",value:function(e,t){var n=null;return this._topicMap.has(e)?this._topicMap.get(e).get(t):n}},{key:"_getLocalTopicList",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=[];return(e=this._topicMap.get(e))&&(n=m(e.values())),0===t.length?n:n.filter((function(e){return t.includes(e.topicID)}))}},{key:"_deleteLocalTopic",value:function(e,t){this._topicMap.has(e)&&this._topicMap.get(e).has(t)&&(this._topicMap.get(e).delete(t),Ne.l("".concat(this._n,"._deleteLocalTopic groupID:").concat(e," topicID:").concat(t)))}},{key:"_updateTopicMap",value:function(e){var t=this,n=[];e.forEach((function(e){var o=e.groupID,i=e.topicID,s=null;t._topicMap.has(o)||t._topicMap.set(o,new Map),t._topicMap.get(o).has(i)?(s=t._topicMap.get(o).get(i)).updateTopic(e):(t._getTopicLastMessage(e),s=new Oi(e,t.isIntl()),t._topicMap.get(o).set(i,s)),e=t._computeUnreadCount(s),s.updateUnreadCount(e),n.push({conversationID:"".concat(D.CONV_GROUP).concat(i),type:D.CONV_TOPIC,unreadCount:e})})),0<n.length&&this.get(11).updateTopicConversation(n)}},{key:"resetGetTopicTime",value:function(e){var t=this;pt(e)?m(this._getTopicTimeMap.keys()).forEach((function(e){t._getTopicTimeMap.set(e,0)})):this._getTopicTimeMap.set(e,0)}},{key:"getTopicListOnReconnected",value:function(){var e=this,t=m(this._topicMap.keys()),n=[],o=this.get(11);t.forEach((function(t){var i=[],s=e._getLocalTopicList(t);o.deleteTopicRoamingInfo(t),s.forEach((function(t){var n=void 0===(n=t.lastMessage.lastTime)?0:n;Date.now()-1e3*n<1e3*e.TOPIC_LAST_ACTIVE_TIME&&i.push(t.topicID)})),0<i.length&&n.push({groupID:t,topicIDList:i})})),Ne.l("".concat(this._n,".getTopicListOnReconnected. active community count:").concat(n.length)),this._relayGetTopicList(n)}},{key:"_relayGetTopicList",value:function(e){var t,n,o,i=this;0!==e.length&&(n=5<(t=e.shift()).topicIDList.length?"topicIDList.length:".concat(t.topicIDList.length):"topicIDList:".concat(t.topicIDList),(o=new so("relayGetTopicList")).setMessage(n),Ne.l("".concat(this._n,"._relayGetTopicList. ").concat(n)),this.getTopicList(t).then((function(){o.end(),i._relayGetTopicList(e)})).catch((function(t){o.setError(t).end(),i._relayGetTopicList(e)})))}},{key:"_handleTopicAtInfo",value:function(e){var n=this;0!==e.length&&e.forEach((function(e){var o=e.groupID,i=e.topicID,s=(e=e.groupAtInfoList,[]);pt(e)||(e.forEach((function(e){s.push(t(t({},e),{},{groupID:o,topicID:i}))})),n.get(11).onNewGroupAtTips({dataList:s}))}))}},{key:"_getTopicLastMessage",value:function(e){var t;pt(e.lastMsg)||(t={time:e.lastMsg.time,sequence:e.lastMsg.sequence,from:e.lastMsg.from,payload:e.lastMsg.elements[0]?e.lastMsg.elements[0].content:null,type:e.lastMsg.elements[0]?e.lastMsg.elements[0].type:"",nick:e.lastMsg.nick,avatar:e.lastMsg.avatar,version:e.lastMsg.messageVersion,cloudCustomData:e.lastMsg.cloudCustomData,isRevoked:2===e.lastMsg.isPlaceMessage,revoker:He(e.lastMsg.revokerInfo)?null:e.lastMsg.revokerInfo.revoker},e.lastMessage=t)}},{key:"deleteTopicListInCommunity",value:function(e){var t=this,n=this._getLocalTopicList(e),o=this.get(11);n.forEach((function(n){n=n.topicID,t._deleteLocalTopic(e,n),t._getTopicTimeMap.delete(e),o.deleteLocalConv("".concat(D.CONV_GROUP).concat(n))}))}},{key:"_computeUnreadCount",value:function(e){var t,n=(i=e.selfInfo).excludedUnreadSequenceList,o=i.readedSequence,i=e.nextMessageSeq-e.selfInfo.readedSequence-1;return Xe(n)&&(t=0,n.forEach((function(n){o<n&&n<=e.nextMessageSeq-1&&(t+=1)})),1<=t&&(i-=t)),i<0?0:i}},{key:"_filterProfanity",value:function(e,t){if(!(o=this.get(29)))return!0;var n=(o=o.filterText(t[e],b)).isAllowedToSend,o=o.modifiedText;return!0===n&&(t[e]=o,!0)}},{key:"getMessageExtensions",value:function(e,t){Ne.l("".concat(this._n,".getMessageExtensions startSequence:").concat(t));var n=xt(e.to);return this.req({P:Kn.GET_GRP_MSG_EXT,data:{groupID:n,topicID:e.to,messageSequence:e.sequence,startSequence:t}})}},{key:"modifyMsgExts",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,o=(Ne.l("".concat(this._n,".modifyMsgExts operateType:").concat(n)),xt(e.to));return this.req({P:Kn.MODIFY_GRP_MSG_EXT,data:{groupID:o,topicID:e.to,messageSequence:e.sequence,extensionList:t,operateType:n}})}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._topicMap.clear(),this._getTopicTimeMap.clear(),this.TOPIC_CACHE_TIME=300,this.TOPIC_LAST_ACTIVE_TIME=3600}}]),ji),Pi=(s(Yi,[{key:"setExpirationTime",value:function(e){this.expirationTime=e}},{key:"getUserProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("getUserProfile"),o=e.userIDList;e.fromAccount=this._userM.getMyAccount(),100<o.length&&(Ne.w("".concat(n," ").concat(Wt(100))),o.length=100);for(var i,s=[],a=[],r=0,c=o.length;r<c;r++)i=o[r],this._userM.isMyFriend(i)&&this._contains(i)?a.push(this._getProfileFromMap(i)):s.push(i);if(0===s.length)return Dn(a);e.toAccount=s;var u=e.bFromGetMyProfile||!1,l=[],d=(e.toAccount.forEach((function(e){l.push({toAccount:e,standardSequence:0,customSequence:0})})),e.userItem=l,new so("getUserProfile"));return d.setMessage(5<o.length?"userIDList.length:".concat(o.length):"userIDList:".concat(o)),this._userM.req({P:Kn.GET_USER_PROFILE,data:e}).then((function(e){return d.end(),Ne.i("".concat(n," ok")),e=t._handleResponse(e).concat(a),En(u?e[0]:e)})).catch((function(e){return d.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"getMyProfile",value:function(){var e,t=this._userM.getMyAccount(),n="".concat(this._n,".getMyProfile");return Ne.l("".concat(n," myAccount:").concat(t)),this._fill(),this._contains(t)?(e=this._getProfileFromMap(t),Ne.d("".concat(n," from cache, myProfile:").concat(JSON.stringify(e))),Dn(e)):this.getUserProfile({fromAccount:t,userIDList:[t],bFromGetMyProfile:!0})}},{key:"_handleResponse",value:function(e){var t=e.data.userProfileItem;if(!Xe(t))return[];for(var n=[],o=(e=Date.now(),0),i=t.length;o<i;o++){var s=(a=t[o]).to,a=a.profileItem;"@TLS#NOT_FOUND"!==s&&""!==s&&(s=this._update(s,this._getLatestProfileFromResponse(s,a)).latestProfile,n.push(s))}return Ne.l("".concat(this._n,"._handleResponse cost:").concat(Jt(e))),n}},{key:"_getLatestProfileFromResponse",value:function(e,t){var n={userID:e,profileCustomField:[]};if(!He(t))for(var o=0,i=t.length;o<i;o++)if(-1<t[o].tag.indexOf("Tag_Profile_Custom"))n.profileCustomField.push({key:t[o].tag,value:t[o].value});else switch(t[o].tag){case Ge.NICK:n.nick=t[o].value;break;case Ge.GENDER:n.gender=t[o].value;break;case Ge.BIRTHDAY:n.birthday=t[o].value;break;case Ge.LOCATION:n.location=t[o].value;break;case Ge.SELFSIGNATURE:n.selfSignature=t[o].value;break;case Ge.ALLOWTYPE:n.allowType=t[o].value;break;case Ge.LANGUAGE:n.language=t[o].value;break;case Ge.AVATAR:n.avatar=t[o].value;break;case Ge.MESSAGESETTINGS:n.messageSettings=t[o].value;break;case Ge.ADMINFORBIDTYPE:n.adminForbidType=t[o].value;break;case Ge.LEVEL:n.level=t[o].value;break;case Ge.ROLE:n.role=t[o].value;break;default:Ne.w("".concat(this._n,"._getLatestProfileFromResponse unknown tag:"),t[o].tag,t[o].value)}return n}},{key:"updateMyProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("updateMyProfile");if(e.nick&&!1===this._userM.filterProfanity("nick",e))return Rn({code:Bn.PROFANITY_FOUND});if(e.selfSignature&&!1===this._userM.filterProfanity("selfSignature",e))return Rn({code:Bn.PROFANITY_FOUND});var o=new so("updateMyProfile"),i=(o.setMessage(JSON.stringify(e)),(new ci).validate(e));if(!i.valid)return o.setCode(Bn.UPDATE_PROFILE_INVALID_PARAM).setMoreMessage("info:".concat(i.tips)).end(),Ne.e("".concat(n," info:").concat(i.tips)),Rn({code:Bn.UPDATE_PROFILE_INVALID_PARAM});var s,a=[];for(s in e)Object.prototype.hasOwnProperty.call(e,s)&&("profileCustomField"===s?e.profileCustomField.forEach((function(e){a.push({tag:e.key,value:e.value})})):a.push({tag:Ge[s.toUpperCase()],value:e[s]}));if(0===a.length)return i=new Vn({code:Bn.UPDATE_PROFILE_NO_KEY}),o.setError(i).end(),Ne.e("".concat(n," failed. error:"),i),Rn(i);var r=this._userM.getMyAccount();return this._userM.req({P:Kn.UPDATE_MY_PROFILE,data:{fromAccount:r,profileItem:a}}).then((function(i){o.end(),Ne.i("".concat(n," ok"));var s=(a=t._update(r,e)).isProfileUpdated,a=a.latestProfile;return!0===s&&t._userM.emitOEvt(E.PROFILE_UPDATED,[a]),Dn(a)})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"onProfileModified",value:function(e){var t=e.dataList;if(!He(t)){var n=t.length;Ne.d("".concat(this._n,".onProfileModified count:").concat(n," dataList:"),e.dataList);for(var o=[],i=0;i<n;i++){var s=t[i].userID,a=(s=this._update(s,this._getLatestProfileFromResponse(s,t[i].profileList))).isProfileUpdated;s=s.latestProfile,!0===a&&o.push(s)}0<o.length&&(this._userM.emitIEvt(jo.PROFILE_UPDATED,o),this._userM.emitOEvt(E.PROFILE_UPDATED,o))}}},{key:"_fill",value:function(){if(0===this.accountProfileMap.size){for(var e=this._getCachedProfiles(),t=Date.now(),n=0,o=e.length;n<o;n++)t-e[n].lastUpdatedTime<this.expirationTime&&this.accountProfileMap.set(e[n].userID,e[n]);Ne.l("".concat(this._n,"._fill from cache, size:").concat(this.accountProfileMap.size))}}},{key:"_update",value:function(e,t){var n,o=!1,i=Date.now();return this._contains(e)?(n=this._getProfileFromMap(e),t.profileCustomField&&!0===It(n.profileCustomField,t.profileCustomField)&&(n.lastUpdatedTime=i,o=!0),0<nt(n,t,["profileCustomField"])&&(n.lastUpdatedTime=i,o=!0)):(n=new ci(t),!this._userM.isMyFriend(e)&&e!==this._userM.getMyAccount()||(n.lastUpdatedTime=i,o=!0,this.accountProfileMap.set(e,n))),this._flush(e===this._userM.getMyAccount()),!0===o&&Ne.l("".concat(this._n,"._update account:").concat(e," isUpdated:").concat(o)),{isProfileUpdated:o,latestProfile:n}}},{key:"_flush",value:function(e){var t=m(this.accountProfileMap.values()),n=this._userM.getStorageModule();Ne.d("".concat(this._n,"._flush length:").concat(t.length," flushAtOnce:").concat(e)),n.setItem(this.TAG,t,e)}},{key:"_contains",value:function(e){return this.accountProfileMap.has(e)}},{key:"_getProfileFromMap",value:function(e){return this.accountProfileMap.get(e)}},{key:"_getCachedProfiles",value:function(){var e=this._userM.getStorageModule().getItem(this.TAG);return He(e)?[]:e}},{key:"onConvProfileUpdated",value:function(e){for(var t,n,o=[],i=0,s=e.length;i<s;i++)n=(t=e[i]).userID,this._userM.isMyFriend(n)&&(this._contains(n)?0<nt(this._getProfileFromMap(n),t)&&o.push(n):o.push(t.userID));0!==o.length&&(Ne.l("".concat(this._n,".onConvProfileUpdated toAccountList:").concat(o)),this.getUserProfile({userIDList:o}))}},{key:"getNickAndAvatarByUserID",value:function(e){return this._contains(e)?{nick:(e=this._getProfileFromMap(e)).nick,avatar:e.avatar}:{nick:"",avatar:""}}},{key:"getUserNickAndAvatar",value:function(e){var t=this,n=m(new Set(e)),o=(Ne.l("".concat(this._n,".getUserNickAndAvatar userIDList.length:").concat(e.length," uniqueUserIDList.length:").concat(n.length)),[]);if(0===e.length)return Promise.resolve(o);e=this._createUserIDListGroup(n);var i=[];return e.forEach((function(e){i.push(t.getUserProfile({userIDList:e}))})),Promise.all(i).then((function(e){return e.forEach((function(e){e=e.data.map((function(e){return{userID:e.userID,nick:e.nick,avatar:e.avatar}})),o.push.apply(o,m(e))})),o}))}},{key:"_createUserIDListGroup",value:function(e){for(var t=[],n=0;n<e.length;)t.push(e.slice(n,n+=100));return t}},{key:"reset",value:function(){this._flush(!0),this.accountProfileMap.clear()}}]),Yi),Gi=s((function e(t){o(this,e)})),Ui=(s(Wi,[{key:"getLocalBlacklist",value:function(){return m(this._blacklistMap.keys())}},{key:"getBlacklist",value:function(){var e=this,t="".concat(this._n,".getBlacklist"),n={fromAccount:this._userM.getMyAccount(),maxLimited:100,startIndex:this._startIndex},o=new so("getBlacklist");return this._userM.req({P:Kn.GET_BL,data:n}).then((function(n){var i=(n=n.data).blackListItem,s=(n=n.startIndex,He(i)?0:i.length);o.setMessage("count:".concat(s)).end(),Ne.i("".concat(t," ok")),e._startIndex=n,e._handleResponse(i,!0),e._userM.emitOEvt(E.BLACKLIST_UPDATED,m(e._blacklistMap.keys())),0!==e._startIndex&&e.getBlacklist()})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"addBlacklist",value:function(e){var t,n,o=this,i=new so("addToBlacklist"),s="".concat(this._n,".addBlacklist"),a=this._userM.getMyAccount();return 1===e.userIDList.length&&e.userIDList[0]===a?(n=this._userM.getErrMsg(t=Bn.CANNOT_ADD_SELF_TO_BLACKLIST),i.setCode(t).setMessage(n).end(),n=new Vn({code:t}),Ne.e("".concat(s," failed. error:"),n),Rn(n)):(e.userIDList.includes(a)&&(e.userIDList=e.userIDList.filter((function(e){return e!==a}))),e.fromAccount=this._userM.getMyAccount(),e.toAccount=e.userIDList,this._userM.req({P:Kn.ADD_TO_BL,data:e}).then((function(t){return i.setMessage(5<e.userIDList.length?"userIDList.length:".concat(e.userIDList.length):"userIDList:".concat(e.userIDList)).end(),Ne.i("".concat(s," ok")),o._handleResponse(t.resultItem,!0),En(m(o._blacklistMap.keys()))})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(s," failed. error:"),e),Rn(e)})))}},{key:"_handleResponse",value:function(e,t){if(!He(e))for(var n,o,i,s=0,a=e.length;s<a;s++)o=e[s].to,i=e[s].resultCode,!pt(i)&&0!==i||(t?((n=this._blacklistMap.has(o)?this._blacklistMap.get(o):new Gi).userID=o,He(e[s].addBlackTimeStamp)||(n.timeStamp=e[s].addBlackTimeStamp),this._blacklistMap.set(o,n)):this._blacklistMap.has(o)&&(n=this._blacklistMap.get(o),this._blacklistMap.delete(o)));Ne.l("".concat(this._n,"._handleResponse total:").concat(this._blacklistMap.size," bAdd:").concat(t))}},{key:"deleteBlacklist",value:function(e){var t=this,n="".concat(this._n,".deleteBlacklist"),o=new so("removeFromBlacklist");return e.fromAccount=this._userM.getMyAccount(),e.toAccount=e.userIDList,this._userM.req({P:Kn.RM_FROM_BL,data:e}).then((function(i){return o.setMessage(5<e.userIDList.length?"userIDList.length:".concat(e.userIDList.length):"userIDList:".concat(e.userIDList)).end(),Ne.i("".concat(n," ok")),t._handleResponse(i.data.resultItem,!1),En(m(t._blacklistMap.keys()))})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"onAccountDeleted",value:function(e){for(var t=0,n=e.length;t<n;t++){var o=e[t];this._blacklistMap.has(o)&&this._blacklistMap.delete(o)}var i=e.length;0<i&&(Ne.l("".concat(this._n,".onAccountDeleted count:").concat(i," ").concat(i<30?"userIDList:".concat(e):"")),this._userM.emitOEvt(E.BLACKLIST_UPDATED,m(this._blacklistMap.keys())))}},{key:"onAccountAdded",value:function(e){for(var t,n=[],o=0,i=e.length;o<i;o++)t=e[o],this._blacklistMap.has(t)||(this._blacklistMap.set(t,new Gi({userID:t})),n.push(t));0<n.length&&(Ne.l("".concat(this._n,".onAccountAdded count:").concat(n.length," userIDList:"),n),this._userM.emitOEvt(E.BLACKLIST_UPDATED,m(this._blacklistMap.keys())))}},{key:"reset",value:function(){this._blacklistMap.clear(),this._startIndex=0}}]),Wi),bi=(s(Ki,[{key:"_onCloudConfig",value:function(){var e=this._userM.getCloudConfig("status_query_count"),t=this._userM.getCloudConfig("status_sub_count"),n=this._userM.getCloudConfig("status_unsub_count");Ne.l("".concat(this._n,"._onCloudConfig statusQueryCount:").concat(e," statusSubscribeCount:").concat(t)+" statusUnsubscribeCount:".concat(n)),pt(e)||(this.MAX_QUERY_USER_COUNT=parseInt(e,10)),pt(e)||(this.MAX_SUBSCRIBE_USER_COUNT=parseInt(t,10)),pt(e)||(this.MAX_UNSUBSCRIBE_USER_COUNT=parseInt(n,10))}},{key:"onUserStatusUpdated",value:function(e){e=e.dataList;var t=this._userM.getMyUserID(),n=this._userM.get(12);e=e.map((function(e){var o=e.to,i=e.statusType;return e=ei(e=e.customStatus),o===t&&n.setCustomStatus(e),{userID:o,statusType:i,customStatus:e}})),Ne.l("".concat(this._n,".onUserStatusUpdated list:").concat(JSON.stringify(e))),this._userM.emitOEvt(E.USER_STATUS_UPDATED,e)}},{key:"setSelfStatus",value:function(e){var t=this,n="".concat(this._n,".setSelfStatus");if(!1===this._userM.filterProfanity("customStatus",e))return Rn({code:Bn.PROFANITY_FOUND});var o=new so("setSelfStatus"),i=e.customStatus;return this._userM.req({P:Kn.SET_SELF_STATUS,data:{customStatus:i}}).then((function(e){return o.setMessage("customStatus:".concat(i)).end(),Ne.l("".concat(n," ok. customStatus:").concat(i)),t._userM.get(12).setCustomStatus(i),En({userID:t._userM.getMyUserID(),statusType:1,customStatus:i})})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"getUserStatus",value:function(e){var t="".concat(this._n,".").concat("getUserStatus"),n=void 0===(e=e.userIDList)?[]:e,o=(e=this._userM.getMyUserID(),m(n)),i=void 0,s=o.indexOf(e);if(-1<s&&(o.splice(s,1),i={userID:e,statusType:1,customStatus:this._userM.get(12).getCustomStatus()}),0===o.length)return Dn({successUserList:[i],failureUserList:[]});if(!this._userM.canIUse(U.USER_STATUS))return this._userM.noUse("getUserStatus");o.length>this.MAX_QUERY_USER_COUNT&&(Ne.w("".concat(t," ").concat(Wt(this.MAX_QUERY_USER_COUNT))),o=n.slice(0,this.MAX_QUERY_USER_COUNT));var a=new so("getUserStatus");return this._userM.req({P:Kn.GET_USER_STATUS,data:{userIDList:o}}).then((function(e){var o=void 0===(o=(e=e.data).successUserList)?[]:o,s=(e=void 0===(e=e.failureUserList)?[]:e,o=o.map((function(e){return{userID:e.userID,statusType:e.statusType,customStatus:ei(e=e.customStatus)}})),e=e.map((function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode;return e=e.errorInfo,{userID:He(n)?t:n,code:o,message:e}})),pt(i)||o.unshift(i),"userID count:".concat(n.length,", success count:").concat(o.length,", fail count:").concat(e.length));return a.setMessage("".concat(s)).end(),Ne.l("".concat(t," ok. ").concat(s,".")),En({successUserList:o,failureUserList:e})})).catch((function(e){return a.setMessage("userID count:".concat(n.length)).setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"subscribeUserStatus",value:function(e){var t="subscribeUserStatus";if(!this._userM.canIUse(U.USER_STATUS))return this._userM.noUse(t);var n="".concat(this._n,".").concat(t),o=m(e=void 0===(e=e.userIDList)?[]:e),i=(o.length>this.MAX_SUBSCRIBE_USER_COUNT&&(Ne.w("".concat(n," ").concat(Wt(this.MAX_SUBSCRIBE_USER_COUNT))),o=e.slice(0,this.MAX_SUBSCRIBE_USER_COUNT)),new so(t)),s="userID count:".concat(e.length);return Ne.l("".concat(n," ").concat(s)),this._userM.req({P:Kn.SUB_USER_STATUS,data:{userIDList:o}}).then((function(e){return e=(void 0===(e=e.data.failureUserList)?[]:e).map((function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode;return e=e.errorInfo,{userID:He(n)?t:n,code:o,message:e}})),i.setMessage("".concat(s," fail count:").concat(e.length)).end(),Ne.l("".concat(n," ok. fail count:").concat(e.length,".")),En({failureUserList:e})})).catch((function(e){return i.setMessage(s).setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"unsubscribeUserStatus",value:function(e){var t="unsubscribeUserStatus";if(!this._userM.canIUse(U.USER_STATUS))return this._userM.noUse(t);var n="".concat(this._n,".").concat(t),o=m(e=void 0===(e=(e||{}).userIDList)?[]:e),i=(e.length>this.MAX_UNSUBSCRIBE_USER_COUNT&&(Ne.w("".concat(n," ").concat(Wt(this.MAX_UNSUBSCRIBE_USER_COUNT))),o=e.slice(0,this.MAX_UNSUBSCRIBE_USER_COUNT)),new so(t)),s="userID count:".concat(e.length);return Ne.l("".concat(n," ").concat(s)),t={userIDList:o},0===o.length&&(t.userIDList=void 0,t.unsubscribeAll=1),this._userM.req({P:Kn.UNSUB_USER_STATUS,data:t}).then((function(e){return e=(void 0===(e=e.data.failureUserList)?[]:e).map((function(e){var t=e.userID,n=e.invalidUserID,o=e.errorCode;return e=e.errorInfo,{userID:He(n)?t:n,code:o,message:e}})),i.setMessage("".concat(s," fail count:").concat(e.length)).end(),Ne.l("".concat(n," ok. fail count:").concat(e.length,".")),En({failureUserList:e})})).catch((function(e){return i.setMessage("".concat(s)).setError(e).end(),Ne.e("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"reset",value:function(){this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100}}]),Ki),wi=(r(Hi,bn),ni=g(Hi),s(Hi,[{key:"onContextUpdated",value:function(e){this._profileHandler.getMyProfile(),this._blacklistHandler.getBlacklist()}},{key:"mockOnNickAvatarModified",value:function(e,t){Ne.l("".concat(this._n,"._mockOnNickAvatarModified nick:").concat(e," avatar:").concat(t)),this.onProfileModified({dataList:[{pushType:1,userID:this.getMyUserID(),profileList:[{tag:Ge.NICK,value:e},{tag:Ge.AVATAR,value:t}]}]})}},{key:"onProfileModified",value:function(e){this._profileHandler.onProfileModified(e)}},{key:"onRelationChainModified",value:function(e){var t,n;He(e=e.dataList)||(t=[],e.forEach((function(e){e.blackListDelAccount&&t.push.apply(t,m(e.blackListDelAccount))})),0<t.length&&this._blacklistHandler.onAccountDeleted(t),n=[],e.forEach((function(e){e.blackListAddAccount&&n.push.apply(n,m(e.blackListAddAccount))})),0<n.length&&this._blacklistHandler.onAccountAdded(n))}},{key:"onConvProfileUpdated",value:function(e){this._profileHandler.onConvProfileUpdated(e)}},{key:"getMyAccount",value:function(){return this.getMyUserID()}},{key:"getMyNick",value:function(){return this._profileHandler.getNickAndAvatarByUserID(this.getMyUserID()).nick}},{key:"getMyProfile",value:function(){return this._profileHandler.getMyProfile()}},{key:"getStorageModule",value:function(){return this.get(13)}},{key:"filterProfanity",value:function(e,t){if(!(o=this.get(29)))return!0;var n=(o=o.filterText(t[e],"user_profile")).isAllowedToSend,o=o.modifiedText;return!0===n&&(t[e]=o,!0)}},{key:"isMyFriend",value:function(e){var t=this.get(8);return!!t&&t.isMyFriend(e)}},{key:"getUserProfile",value:function(e){return this._profileHandler.getUserProfile(e)}},{key:"updateMyProfile",value:function(e){return this._profileHandler.updateMyProfile(e)}},{key:"getNickAndAvatarByUserID",value:function(e){return this._profileHandler.getNickAndAvatarByUserID(e)}},{key:"getUserNickAndAvatar",value:function(e){return this._profileHandler.getUserNickAndAvatar(e)}},{key:"getLocalBlacklist",value:function(){return Dn(this._blacklistHandler.getLocalBlacklist())}},{key:"addBlacklist",value:function(e){return this._blacklistHandler.addBlacklist(e)}},{key:"deleteBlacklist",value:function(e){return this._blacklistHandler.deleteBlacklist(e)}},{key:"onUserStatusUpdated",value:function(e){this._userStatusHandler.onUserStatusUpdated(e)}},{key:"setSelfStatus",value:function(e){return this._userStatusHandler.setSelfStatus(e)}},{key:"getUserStatus",value:function(e){return this._userStatusHandler.getUserStatus(e)}},{key:"subscribeUserStatus",value:function(e){return this._userStatusHandler.subscribeUserStatus(e)}},{key:"unsubscribeUserStatus",value:function(e){return this._userStatusHandler.unsubscribeUserStatus(e)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._profileHandler.reset(),this._blacklistHandler.reset(),this._userStatusHandler.reset()}}]),Hi),Fi=(s(Bi,[{key:"isLoggedIn",value:function(){return this._isLoggedIn}},{key:"isOversea",value:function(){return this._oversea}},{key:"isPrivateNetWork",value:function(){return this._proxyServer}},{key:"isDevMode",value:function(){return this._isDevMode}},{key:"isTestEnv",value:function(){return this._isTestEnv}},{key:"isPartialUpdatedConvs",value:function(){return this._isPartialUpdatedConvs}},{key:"isIndependentDomainDisabled",value:function(){return this._isIndependentDomainDisabled}},{key:"isSingaporeSite",value:function(){return 2e7<=this._SDKAppID&&this._SDKAppID<3e7||172e7<=this._SDKAppID&&this._SDKAppID<173e7}},{key:"isKoreaSite",value:function(){return 3e7<=this._SDKAppID&&this._SDKAppID<4e7||173e7<=this._SDKAppID&&this._SDKAppID<174e7}},{key:"isGermanySite",value:function(){return 4e7<=this._SDKAppID&&this._SDKAppID<5e7||174e7<=this._SDKAppID&&this._SDKAppID<175e7}},{key:"isIndiaSite",value:function(){return 5e7<=this._SDKAppID&&this._SDKAppID<6e7||175e7<=this._SDKAppID&&this._SDKAppID<176e7}},{key:"isJapanSite",value:function(){return 6e7<=this._SDKAppID&&this._SDKAppID<7e7||176e7<=this._SDKAppID&&this._SDKAppID<177e7}},{key:"isUSASite",value:function(){return 7e7<=this._SDKAppID&&this._SDKAppID<8e7||177e7<=this._SDKAppID&&this._SDKAppID<178e7}},{key:"isIndonesiaSite",value:function(){return 8e7<=this._SDKAppID&&this._SDKAppID<9e7||178e7<=this._SDKAppID&&this._SDKAppID<179e7}},{key:"isIntl",value:function(){return 0===(e=this._SDKAppID)||2e7<=e&&e<9e7||172e7<=e&&e<179e7;var e}},{key:"isUnlimitedAVChatRoom",value:function(){return this._unlimitedAVChatRoom}},{key:"isUsingChatCore",value:function(){return this._isUsingChatCore}},{key:"setUsingChatCore",value:function(e){this._isUsingChatCore=e}},{key:"getUIPlatform",value:function(){return this._uiPlatform}},{key:"setUIPlatform",value:function(e){this._uiPlatform=e}},{key:"setUserID",value:function(e){this._userID=e}},{key:"getUserID",value:function(){return this._userID}},{key:"setUserSig",value:function(e){this._userSig=e}},{key:"getUserSig",value:function(){return this._userSig}},{key:"getSDKAppID",value:function(){return this._SDKAppID}},{key:"setTinyID",value:function(e){this._tinyID=e,this._isLoggedIn=!0}},{key:"getTinyID",value:function(){return this._tinyID}},{key:"setCustomStatus",value:function(e){this._customStatus=e}},{key:"getCustomStatus",value:function(){return this._customStatus}},{key:"getScene",value:function(){return me?window.tencent_cloud_im_csig_flutter_for_web_25F_cy:this._isTUIKit()?"tuikit":this._scene}},{key:"getInstanceID",value:function(){return this._instanceID}},{key:"getStatusInstanceID",value:function(){return this._statusInstanceID}},{key:"setStatusInstanceID",value:function(e){this._statusInstanceID=e}},{key:"getVersion",value:function(){return this._version}},{key:"getA2Key",value:function(){return this._a2Key}},{key:"setA2Key",value:function(e){this._a2Key=e}},{key:"getContentType",value:function(){return this._contentType}},{key:"getProxyServer",value:function(){return this._proxyServer}},{key:"getFileUploadProxy",value:function(){return this._fileUploadProxy}},{key:"getFileDownloadProxy",value:function(){return this._fileDownloadProxy}},{key:"setApplicationID",value:function(e){this._applicationID=e}},{key:"getApplicationID",value:function(){return this._applicationID}},{key:"setDowloadFileAuthKey",value:function(e){this._authKey=e}},{key:"getDowloadFileAuthKey",value:function(){return this._authKey}},{key:"setCustomLoginInfo",value:function(e){this._customLoginInfo=e}},{key:"getCustomLoginInfo",value:function(){return this._customLoginInfo}},{key:"_isTUIKit",value:function(){var e=!1,t=!1,n=!1,o=!1,i=[];Z&&(i=Object.keys(ne));for(var s=0,a=(i=te?Q?Object.keys(uni):Object.keys(window):i).length;s<a;s++)if(i[s].toLowerCase().includes("uikit")){e=!0;break}i=null;var r,c=(Z&&!Ze(ne.createGamePortal)&&Ze(getApp)&&!pt(getApp())&&ze(r=getApp().globalData)&&!0===r.isTUIKit&&(t=!0),!0===this._m.get(13).getStorageSync("TIM_".concat(this._SDKAppID,"_isTUIKit"))&&(n=!0),null);if(B&&!W&&"undefined"==typeof uni&&__wxConfig&&(c=__wxConfig.pages),K&&"undefined"==typeof uni&&__qqConfig&&(c=__qqConfig.pages),Xe(c)&&0<c.length){for(var u=0,l=c.length;u<l;u++)if(c[u].toLowerCase().includes("tui")){o=!0;break}c=null}return e||t||n||o}},{key:"reset",value:function(){this._isLoggedIn=!1,this._userSig="",this._a2Key="",this._tinyID="",this._customStatus="",this._statusInstanceID=0}}]),Bi),qi={"k-vue2-pc":1,"k-vue2-h5":2,"k-vue2-h5-uni":3,"k-vue2-app-uni":4,"k-vue2-mp-uni":5,"k-vue2-pc-uni":6,"k-vue3-pc":7,"k-vue3-h5":8,"k-vue3-h5-uni":9,"k-vue3-app-uni":10,"k-vue3-mp-uni":11,"k-vue3-pc-uni":12,"k-rn":13},xi=(r(Vi,bn),ti=g(Vi),s(Vi,[{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&e%this._helloInterval==0&&this._hello()}},{key:"getPushModule",value:function(){var e=void 0,t=this.get(36),n=this.get(28);return t.canIUseTIMPush()?e=t:n.canIUseOfflinePush()&&(e=n),e}},{key:"login",value:function(e){if(this.isLoggedIn())return t=this.getMyUserID(),(t=this.getErrMsg("RepeatLogin",t))&&Ne.w(t),Dn({actionStatus:"OK",errorCode:0,errorInfo:t,repeatLogin:!0});if(Date.now()-this._lastLoginTs<=15e3)return this.warn("LoggingIn",e.userID),Rn({code:Bn.REPEAT_LOGIN});if(Ne.l("".concat(this._n,".login userID:").concat(e.userID)),0!==(t=this._checkLoginInfo(e)).code)return Rn(t);var t=this.get(12),n=e.userID;return e=e.userSig,t.setUserID(n),t.setUserSig(e),this.get(20).updateProtocolConfig(),this._login()}},{key:"_login",value:function(){var e=this,t=this.get(12),n=t.getScene(),o=0,i=n,s=(n&&n.startsWith("k-")&&(i=qi[n],n="tuikit"),new so("login")),a=(s.setMessage("".concat(i)).setMoreMessage("identifier:".concat(this.getMyUserID())),"tuikit"===n),r=0,c=(Q?r=a?3===i||4===i||5===i||6===i?31:9===i||10===i||11===i||12===i?32:4:3:Z?r=H?36:"tuikit"===n?12:11:te?r=me?"flutter_web_uikit"===n?21:20:this._isReactUIKit()?fe?25:24:a?1===i||2===i?29:7===i||8===i?30:fe?17:14:fe?16:13:13===i&&(r=38),s.setUIPlatform(r),t.setUIPlatform(r),(a=this.getPushModule())&&(this._isWebUniapp=a.getUniAppPlatform(),i=this._getStatusInstanceID(),t.setStatusInstanceID(i),this.get(20).updateProtocolConfig(),o=a.getDeviceBrand()),"".concat(this._n,"._login"));return this._lastLoginTs=Date.now(),this.req({P:Kn.LOGIN,data:{deviceBrand:o,isWebUniapp:this._isWebUniapp,customInfo:t.getCustomLoginInfo()}}).then((function(o){e._lastLoginTs=0;var i=Date.now(),a=null,r=(g=o.data).a2Key,u=g.tinyID,l=g.helloInterval,d=g.instanceID,p=g.timeStamp,_=void 0===(_=g.customStatus)?"":_,h=g.purchaseBits,g=void 0===(g=g.authKey)?"":g,f=1e3*p,m=i-s.getStartTs();if(m=f+parseInt(m/2)-i,i=s.getStartTs()+m,s.start(i),i=f,Se=m,(f=new Date).setTime(i),Ne.i("baseTime from server:".concat(f," offset:").concat(Se)),!u)throw a=new Vn({code:Bn.NO_TINYID}),s.setError(a).end(),a;if(!r)throw a=new Vn({code:Bn.NO_A2KEY}),s.setError(a).end(),a;return i=e.get(21).getSocketID(),f=ei(_),a="socketID:".concat(i," scene:").concat(n," helloInterval:").concat(l," instanceID:").concat(d," timeStamp:").concat(p)+" offset:".concat(m," customStatus:").concat(f," isWebUniapp:").concat(e._isWebUniapp),Ne.l("".concat(c," ok. ").concat(a)),_="",i="",B&&Ze(ne.getAccountInfoSync)&&(p=ne.getAccountInfoSync().miniProgram)&&(_=p.appId,i=p.envVersion),s.setMoreMessage("".concat(a," href:").concat(te?window.location.href:""," mpAppId:").concat(_," envVersion:").concat(i," authKey:").concat(g)).end(),t.setA2Key(r),t.setTinyID(u),t.setStatusInstanceID(d),t.setCustomStatus(f),t.setDowloadFileAuthKey(g),h&&e.get(27).onPushedConfig({errorCode:0,expiredTime:0,purchaseBits:h}),e.get(20).updateProtocolConfig(),e.emitIEvt(jo.A2KEY_AND_TINYID_UPDATED),e._helloInterval=l,e.triggerReady(),(m=e.getPushModule())&&(uni.setStorageSync("timUniAppInstanceID",d),m.init()),e._fetchCloudControlConfig(),e.get(29).init(),o})).catch((function(t){return s.setError(t).end(!0),e._m.setNotReadyReason(Bn.LOGIN_FAILED),Ne.e("".concat(c," failed. error:"),t),e._lastLoginTs=0,e._m.onLoginFailed(),Rn(t)}))}},{key:"logout",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,n="".concat(this._n,".logout"),o=this.isLoggedIn();return Ne.i("".concat(n," type:").concat(t," isLoggedIn:").concat(o," isWebUniapp:").concat(this._isWebUniapp)),o?(new so("logout").setMessage("identifier:".concat(this.getMyUserID())).end(!0),0===t&&this._m.setNotReadyReason(Bn.LOGGED_OUT),this.req({P:Kn.LOGOUT,data:{type:t,isWebUniapp:this._isWebUniapp}}).then((function(){return e.resetReady(),Dn({})})).catch((function(t){return Ne.e("".concat(n," error:"),t),e.resetReady(),Dn({})}))):Rn({code:Bn.USER_NOT_LOGGED_IN})}},{key:"getLoginUser",value:function(){return this.isLoggedIn()?this.getMyUserID():""}},{key:"_fetchCloudControlConfig",value:function(){this.get(23).fetchConfig()}},{key:"_getStatusInstanceID",value:function(){return uni.getStorageSync("timUniAppInstanceID")||0}},{key:"_hello",value:function(){var e=this;this._lastWsHelloTs=Date.now(),this.req({P:Kn.HELLO,data:{isWebUniapp:this._isWebUniapp}}).catch((function(t){Ne.w("".concat(e._n,"._hello error:"),t)}))}},{key:"getLastWsHelloTs",value:function(){return this._lastWsHelloTs}},{key:"_checkLoginInfo",value:function(e){var t=0;return He(this.get(12).getSDKAppID())?t=Bn.NO_SDKAPPID:He(e.userID)?t=Bn.NO_IDENTIFIER:He(e.userSig)&&(t=Bn.NO_USERSIG),{code:t}}},{key:"_isReactUIKit",value:function(){return te&&void 0!==window.tencent_cloud_im_csig_react_uikit_23F_xa}},{key:"onMultipleAccountKickedOut",value:function(e){var t=this;new so("kickedOut").setMessage("type:".concat(D.KICKED_OUT_MULT_ACCOUNT," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),Ne.w("".concat(this._n,".onMultipleAccountKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),this.logout(1).then((function(){t.emitOEvt(E.KICKED_OUT,{type:D.KICKED_OUT_MULT_ACCOUNT}),t._m.setNotReadyReason(Bn.KICKED_OUT_MULT_ACCOUNT),t._m.reset()}))}},{key:"onMultipleDeviceKickedOut",value:function(e){var t=this;new so("kickedOut").setMessage("type:".concat(D.KICKED_OUT_MULT_DEVICE," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),Ne.w("".concat(this._n,".onMultipleDeviceKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),this.logout(1).then((function(){t.emitOEvt(E.KICKED_OUT,{type:D.KICKED_OUT_MULT_DEVICE}),t._m.setNotReadyReason(Bn.KICKED_OUT_MULT_DEVICE),t._m.reset()}))}},{key:"onUserSigExpired",value:function(){new so("kickedOut").setMessage(D.KICKED_OUT_USERSIG_EXPIRED).end(!0),Ne.w("".concat(this._n,".onUserSigExpired userID:").concat(this.getMyUserID())),0!==this.get(12).getStatusInstanceID()&&(this.emitOEvt(E.KICKED_OUT,{type:D.KICKED_OUT_USERSIG_EXPIRED}),this._m.setNotReadyReason(Bn.KICKED_OUT_USERSIG_EXPIRED),this._m.reset())}},{key:"onRestApiKickedOut",value:function(e){new so("kickedOut").setMessage("type:".concat(D.KICKED_OUT_REST_API," newInstanceInfo:").concat(JSON.stringify(e))).end(!0),Ne.w("".concat(this._n,".onRestApiKickedOut userID:").concat(this.getMyUserID()," newInstanceInfo:"),e),0!==this.get(12).getStatusInstanceID()&&(this.emitOEvt(E.KICKED_OUT,{type:D.KICKED_OUT_REST_API}),this._m.setNotReadyReason(Bn.KICKED_OUT_REST_API),this._m.reset(),this.get(21).onRestApiKickedOut())}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this.resetReady(),this._helloInterval=120,this._lastLoginTs=0,this._lastWsHelloTs=0,this._isWebUniapp=0}}]),Vi);function Vi(e){return o(this,Vi),(e=ti.call(this,e))._n="SignModule",e._helloInterval=120,e._lastLoginTs=0,e._lastWsHelloTs=0,e._isWebUniapp=0,Qo.mixin(h(e)),e}function Bi(e,t){o(this,Bi),this._m=e,this._isLoggedIn=!1,this._SDKAppID=t.SDKAppID,this._userID=t.userID||"",this._userSig=t.userSig||"",this._version="3.5.2",this._a2Key="",this._tinyID="",this._customStatus="",this._contentType="json",this._unlimitedAVChatRoom=t.unlimitedAVChatRoom,this._scene=t.scene||"",this._oversea=t.oversea,this._instanceID=t.instanceID,this._statusInstanceID=0,this._isDevMode=t.devMode,this._isTestEnv=t.testEnv,this._proxyServer=t.proxyServer,this._fileUploadProxy=t.fileUploadProxy,this._fileDownloadProxy=t.fileDownloadProxy,this._applicationID=0,this._isPartialUpdatedConvs=t.partialUpdatedConversations,this._isIndependentDomainDisabled=t.disableIndependentDomain,this._isUsingChatCore=!1,this._uiPlatform=0,this._authKey="",this._customLoginInfo=""}function Hi(e){return o(this,Hi),(e=ni.call(this,e))._n="UserModule",e._profileHandler=new Pi(h(e)),e._blacklistHandler=new Ui(h(e)),e._userStatusHandler=new bi(h(e)),e.getIEmitInst().on(jo.A2KEY_AND_TINYID_UPDATED,e.onContextUpdated,h(e)),e}function Ki(e){o(this,Ki),this._userM=e,this._n="UserStatusHandler",this.MAX_QUERY_USER_COUNT=500,this.MAX_SUBSCRIBE_USER_COUNT=100,this.MAX_UNSUBSCRIBE_USER_COUNT=100,this._userM.getIEmitInst().on(jo.CLOUD_CONFIG,this._onCloudConfig,this)}function Wi(e){o(this,Wi),this._userM=e,this._n="BlacklistHandler",this._blacklistMap=new Map,this._startIndex=0}function Yi(e){o(this,Yi),this._userM=e,this._n="ProfileHandler",this.TAG="profile",this.accountProfileMap=new Map,this.expirationTime=864e5}function ji(e){return o(this,ji),(e=oi.call(this,e))._n="TopicModule",e._topicMap=new Map,e._getTopicTimeMap=new Map,e.TOPIC_CACHE_TIME=300,e.TOPIC_LAST_ACTIVE_TIME=3600,e.getIEmitInst().on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Ji(e,t){o(this,Ji),this.topicID="",this.topicName="",this.avatar="",this.introduction="",this.notification="",this.unreadCount=0,this.muteAllMembers=!1,this.customData="",this.groupAtInfoList=[],this.nextMessageSeq=0,this.lastMessage=$o(e.lastMessage,t),this.selfInfo={muteTime:0,readedSequence:0,messageRemindType:"",excludedUnreadSequenceList:void 0},this._initTopic(e)}function zi(e){return o(this,zi),(e=ii.call(this,e))._n="GroupModule",e._commonGroupHandler=new vi(h(e)),e._groupAttributesHandler=new Ii(h(e)),e._groupCountersHandler=new yi(h(e)),e._AVChatRoomHandler=new Ti(h(e)),e._groupTipsHandler=new mi(h(e)),e._groupSystemNoticeHandler=new Si(h(e)),e._groupMemberHandler=new Di(h(e)),e.groupMap=new Map,e._unjoinedAVChatRoomList=new Map,e._receiptDetailCompleteMap=new Map,e._onlineMemberCountMap=new Map,e._timeoutIDs=[],e.getIEmitInst().on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Xi(e){o(this,Xi),this._grpM=e,this._n="GroupSystemNoticeHandler",this.pendencyMap=new Map}function Qi(e){o(this,Qi),this._grpM=e,this._n="GroupMemberHandler",this.groupMemberListMap=new Map,this.DEFAULT_MEMBER_INFO_FILTER=["Role","JoinTime","NameCard","ShutUpUntil","OnlineStatus"],this._grpM.getIEmitInst().on(jo.PROFILE_UPDATED,this._onProfileUpdated,this)}function Zi(e){o(this,Zi),this.userID="",this.avatar="",this.nick="",this.role="",this.joinTime="",this.lastSendMsgTime="",this.nameCard="",this.muteUntil=0,this.memberCustomField=[],this.isOnline=!1,this.updateMember(e)}function $i(e){o(this,$i),this._grpM=e,this._n="AVChatRoomHandler",this._joinedGroupMap=new Map,this._pollingRequestInfoMap=new Map,this._pollingInstanceMap=new Map,this._seqSll=new ui(200),this._IDSll=new ui(100),this._reportMessageStackedCount=0,this._onlineMemberCountMap=new Map,this.DEFAULT_EXPIRE_TIME=60,this.DEFAULT_POLLING_INTERVAL=300,this.MAX_POLLING_INTERVAL=2e3,this._pollingInterval=this.DEFAULT_POLLING_INTERVAL,this.DEFAULT_POLLING_NO_MESSAGE_COUNT=20,this.DEFAULT_POLLING_INTERVAL_PLUS=2e3,this._pollingNoMessageCount=0,this._startBroadcastSeq=1,this._broadcastMessageIDMap=new Map,this.DEFAULT_POLLING_SIMPLIFIED_MSG=0}function es(e){o(this,es);var t=e.manager,n=e.groupID,i=e.onInit,s=e.onSuccess;e=e.onFail,this._n="Polling",this._manager=t,this._grpM=t._grpM,this._onInit=i,this._onSuccess=s,this._onFail=e,this._groupID=n,this._timeoutID=-1,this._isRunning=!1,this._proto=Kn.AV_POLLING}function ts(e){o(this,ts),this._grpM=e,this._n="GroupCountersHandler",this._groupCountersMap=new Map,this.EXPIRE_TIME=3e4,this._grpM.getIEmitInst().on(jo.CLOUD_CONFIG,this._onCloudConfig,this)}function ns(e){o(this,ns),this._grpM=e,this._n="GroupAttributesHandler",this._groupAttributesMap=new Map,this._groupAttributesCopy={},this.CACHE_EXPIRE_TIME=3e4,this._grpM.getIEmitInst().on(jo.CLOUD_CONFIG,this._onCloudConfig,this)}function os(e){o(this,os),this._grpM=e,this._n="CommonGroupHandler",this.tempConversationList=null,this._cachedGroupMessageMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4,this.PAGING_GRP_COUNT_LIMIT=200,this._pagingStatus=On,this._pagingGetCostList=[],e.getIEmitInst().on(jo.A2KEY_AND_TINYID_UPDATED,this.syncGroupList,this)}function is(e){o(this,is),this._grpM=e,this._n="GroupTipsHandler",this._cachedGroupTipsMap=new Map,this._checkCountMap=new Map,this.MAX_CHECK_COUNT=4}function ss(e){return o(this,ss),(e=si.call(this,e))._n="ConvModule",Qo.mixin(h(e)),e._msgListHandler=new Jo(h(e)),e._msgRemindHandler=new hi(h(e)),e._convGroupHandler=new gi(h(e)),e._sll=new ui(100),e._pagingStatus=On,e._pagingTs=0,e._pagingStartIdx=0,e._pagingPinnedTs=0,e._pagingPinnedStartIdx=0,e._pagingConvIDMap=new Map,e._convIDFromUnreadDBMap=new Map,e._convMap=new Map,e._tmpGroupList=[],e._tmpGroupAtTipsList=[],e._peerReadTimeMap=new Map,e._completedMap=new Map,e._roamingMsgKeyAndTimeMap=new Map,e._remoteGroupReadSeqMap=new Map,e._convTotalUnreadCount=0,e._pagingGetCostList=[],e._convMapForDiff=new Map,e._partialUpdatedConvMap=new Map,e._everClearedMap=new Map,e._bPullOnInvite=!0,e._initListeners(),e}function as(e){o(this,as),this._convM=e,this._n="ConvGroupHandler",this._convGroupMap=new Map,this._startIndex=0,this._pagingStatus=On}function rs(e){o(this,rs),this._convM=e,this._n="MsgRemindHandler"}function cs(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];o(this,cs),this.conversationID=e.conversationID||"",this.unreadCount=e.unreadCount||0,this.type=e.type||"",this.lastMessage=Zo(e.lastMessage,t,n),e.lastMsgTime&&(this.lastMessage.lastTime=e.lastMsgTime),this._isInfoCompleted=!1,this.peerReadTime=e.peerReadTime||0,this.groupAtInfoList=[],this.remark="",this.isPinned=e.isPinned||!1,this.messageRemindType=e.messageRemindType,this.markList=e.markList||[],this.customData=e.customData||"",this.conversationGroupList=e.conversationGroupList||[],this.draftText=e.draftText||"",this._initProfile(e),this.subType=this.groupProfile?this.groupProfile.type:""}function us(e){o(this,us),this.groupID="",this.name="",this.avatar="",this.type="",this.introduction="",this.notification="",this.ownerID="",this.createTime="",this.infoSequence="",this.lastInfoTime="",this.selfInfo={messageRemindType:"",joinTime:"",nameCard:"",role:"",userID:"",memberCustomField:void 0,readedSequence:0,excludedUnreadSequenceList:void 0},this.lastMessage={lastTime:"",lastSequence:"",fromAccount:"",messageForShow:""},this.nextMessageSeq="",this.memberNum="",this.memberCount="",this.maxMemberNum="",this.maxMemberCount="",this.joinOption="",this.inviteOption="",this.groupCustomField=[],this.muteAllMembers=!1,this.isSupportTopic=!1,this._lastRevokedTime=0,this._initGroup(e)}function ls(e){o(this,ls),this.MAX_LENGTH=e,this.map=new Map}function ds(e){var t=this;o(this,ds),He(e)||(this.userID=e.userID||"",this.nick=e.nick||"",this.gender=e.gender||"",this.birthday=e.birthday||0,this.location=e.location||"",this.selfSignature=e.selfSignature||"",this.allowType=e.allowType||D.ALLOW_TYPE_ALLOW_ANY,this.language=e.language||0,this.avatar=e.avatar||"",this.messageSettings=e.messageSettings||0,this.adminForbidType=e.adminForbidType||D.FORBID_TYPE_NONE,this.level=e.level||0,this.role=e.role||0,this.lastUpdatedTime=0,this.profileCustomField=[],He(e.profileCustomField)||e.profileCustomField.forEach((function(e){t.profileCustomField.push({key:e.key,value:e.value})})))}function ps(){return null}function _s(e){var t=e.get(12);return{SDKType:10,SDKAppID:t.getSDKAppID(),SDKVersion:t.getVersion(),tinyID:Number(t.getTinyID()),userID:t.getUserID(),platform:e.getPlatform(),instanceID:t.getInstanceID(),traceID:Le()}}s(Es,[{key:"_errorTolerantHandle",value:function(){Z||"undefined"!=typeof window&&this._canIUseCookies()||(this.getItem=ps,this.setItem=ps,this.removeItem=ps,this.clear=ps)}},{key:"onCheckTimer",value:function(e){e%20==0&&0!==this._storageQueue.size&&this._doFlush()}},{key:"_doFlush",value:function(){try{var e,t=T(this._storageQueue);try{for(t.s();!(e=t.n()).done;){var n=f(e.value,2),o=n[0],i=n[1];this._setStorageSync(this._getKey(o),i)}}catch(e){t.e(e)}finally{t.f()}this._storageQueue.clear()}catch(e){Ne.w("".concat(this._n,"._doFlush error:"),e)}}},{key:"_getPrefix",value:function(){var e=this._m.get(12);return"TIM_".concat(e.getSDKAppID(),"_").concat(e.getUserID(),"_")}},{key:"_getKey",value:function(e){return"".concat(this._getPrefix()).concat(e)}},{key:"getItem",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var n=t?this._getKey(e):e;return this.getStorageSync(n)}catch(e){return Ne.w("".concat(this._n,".getItem error:"),e),{}}}},{key:"setItem",value:function(e,t){var n;2<arguments.length&&void 0!==arguments[2]&&arguments[2]?(n=3<arguments.length&&void 0!==arguments[3]&&!arguments[3]?e:this._getKey(e),this._setStorageSync(n,t)):this._storageQueue.set(e,t)}},{key:"clear",value:function(){try{Z?ne.clearStorageSync():this._canIUseCookies()&&localStorage.clear()}catch(s){Ne.w("".concat(this._n,".clear error:"),s)}}},{key:"removeItem",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];try{var n=t?this._getKey(e):e;this._removeStorageSync(n)}catch(e){Ne.w("".concat(this._n,".removeItem error:"),e)}}},{key:"getSize",value:function(e){var t=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"b";try{var o={size:0,limitSize:5242880,unit:n};if(Object.defineProperty(o,"leftSize",{enumerable:!0,get:function(){return o.limitSize-o.size}}),Z&&(o.limitSize=1024*ne.getStorageInfoSync().limitSize),e)o.size=JSON.stringify(this.getItem(e)).length+this._getKey(e).length;else if(Z)ne.getStorageInfoSync().keys.forEach((function(e){o.size+=JSON.stringify(t.getStorageSync(e)).length+t._getKey(e).length}));else if(this._canIUseCookies())for(var i in localStorage)localStorage.hasOwnProperty(i)&&(o.size+=localStorage.getItem(i).length+i.length);return this._convertUnit(o)}catch(e){Ne.w("".concat(this._n," error:"),e)}}},{key:"_convertUnit",value:function(e){var t,n={},o=e.unit;for(t in n.unit=o,e)"number"==typeof e[t]&&("kb"===o.toLowerCase()?n[t]=Math.round(e[t]/1024):"mb"===o.toLowerCase()?n[t]=Math.round(e[t]/1024/1024):n[t]=e[t]);return n}},{key:"_setStorageSync",value:function(e,t){Z?j?my.setStorageSync({key:e,data:t}):ne.setStorageSync(e,t):this._canIUseCookies()&&localStorage.setItem(e,JSON.stringify(t))}},{key:"getStorageSync",value:function(e){return Z?j?my.getStorageSync({key:e}).data:ne.getStorageSync(e):this._canIUseCookies()?JSON.parse(localStorage.getItem(e)):{}}},{key:"_removeStorageSync",value:function(e){Z?j?my.removeStorageSync({key:e}):ne.removeStorageSync(e):this._canIUseCookies()&&localStorage.removeItem(e)}},{key:"_canIUseCookies",value:function(){return"undefined"!=typeof window&&navigator&&navigator.cookieEnabled&&localStorage}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._doFlush()}}]);var hs,gs=Es,fs=(s(Ts,[{key:"pushIn",value:function(e){Ne.d("".concat(this._n,".pushIn"),this._report.length,e),this._report.push(e)}},{key:"backfill",value:function(e){var t;Xe(e)&&0!==e.length&&(Ne.d("".concat(this._n,".backfill"),this._report.length,e.length),(t=this._report).unshift.apply(t,m(e)))}},{key:"getLogsNumInMemory",value:function(){return this._report.length}},{key:"isEmpty",value:function(){return 0===this._report.length}},{key:"_reset",value:function(){this._report.length=0,this._report=[]}},{key:"getLogsInMemory",value:function(){var e=this._report.slice();return this._reset(),e}}]),Ts),ms=(r(Cs,bn),hs=g(Cs),s(Cs,[{key:"reportAtOnce",value:function(){this._report()}},{key:"_onLoginSuccess",value:function(){var e=this,t=this.get(13),n=t.getItem(this.TAG,!1);!He(n)&&Ze(n.forEach)&&(Ne.l("".concat(this._n,"._onLoginSuccess. logs count:").concat(n.length)),n.forEach((function(t){e._reportBody.pushIn(t)})),t.removeItem(this.TAG,!1))}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("evt_rpt_threshold"),t=this.getCloudConfig("evt_rpt_waiting"),n=this.getCloudConfig("evt_rpt_level"),o=this.getCloudConfig("evt_rpt_sdkappid_bl"),i=this.getCloudConfig("evt_rpt_tinyid_wl");pt(e)||(this.MIN_THRESHOLD=Number(e)),pt(t)||(this.WAITING_TIME=Number(t)),pt(n)||(this.REPORT_LEVEL=n.split(",").map((function(e){return Number(e)}))),pt(o)||(this.REPORT_SDKAPPID_BLACKLIST=o.split(",").map((function(e){return Number(e)}))),pt(i)||(this.REPORT_TINYID_WHITELIST=i.split(","))}},{key:"pushIn",value:function(e){e instanceof so&&(e.updateTimeStamp(),this._reportBody.pushIn(e),this._reportBody.getLogsNumInMemory()>=this.MIN_THRESHOLD&&this._report())}},{key:"onCheckTimer",value:function(){Date.now()<this._lastReportTime+this.WAITING_TIME||this._reportBody.isEmpty()||this._report()}},{key:"_filterLogs",value:function(e){var t=this,n=(o=this.get(12)).getSDKAppID(),o=o.getTinyID();return Ft(this.REPORT_SDKAPPID_BLACKLIST,n)&&!qt(this.REPORT_TINYID_WHITELIST,o)?[]:e.filter((function(e){return t.REPORT_LEVEL.includes(e.level)}))}},{key:"_report",value:function(){var e,n,o=this;this._reportBody.isEmpty()||(e=this._reportBody.getLogsInMemory(),0!==(n=this._filterLogs(e)).length?(n={header:_s(this),event:n},this.req({P:Kn.SSO_STAT,data:t({},n)}).then((function(){o._lastReportTime=Date.now()})).catch((function(t){Ne.w("".concat(o._n,"._report failed. error:"),t),o._lastReportTime=Date.now(),o._reportBody.backfill(e),o._reportBody.getLogsNumInMemory()>o.MAX_THRESHOLD&&o._flushAtOnce()}))):this._lastReportTime=Date.now())}},{key:"_flushAtOnce",value:function(){var e=this.get(13),t=e.getItem(this.TAG,!1),n=this._reportBody.getLogsInMemory(),o="".concat(this._n,"._flushAtOnce");He(t)?(Ne.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)):((n=n.concat(t)).length>this.MAX_THRESHOLD&&(n=n.slice(0,this.MAX_THRESHOLD)),Ne.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1))}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._lastReportTime=0,this._report(),this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[]}}]),Cs),vs="none",Is="online",ys=(s(Ms,[{key:"_startRN",value:function(){var e,t=this;!ee||(e=this._m.get(18).getPlugin("chat-network-monitor"))&&(this._removeListener=e.addEventListener((function(e){var n=e.isConnected;e=e.type,t._networkType!==e&&t._onNetworkStatusChange({isConnected:void 0!==n&&n,networkType:e})})))}},{key:"start",value:function(){var e=this,t="".concat(this._n,".start");Z?(ne.getNetworkType({success:function(n){e._networkType=n.networkType||n.subtype||"",n.networkType===vs?Ne.w("".concat(t," no network, please check!")):Ne.i("".concat(t," networkType:").concat(n.networkType))}}),this._mpNetworkStatusCallback=this._onNetworkStatusChange.bind(this),ne.onNetworkStatusChange(this._mpNetworkStatusCallback)):te&&(this._networkType=Is,this._webOnlineCallback=this._onWebOnline.bind(this),this._webOfflineCallback=this._onWebOffline.bind(this),window.addEventListener("online",this._webOnlineCallback),window.addEventListener("offline",this._webOfflineCallback))}},{key:"_onWebOnline",value:function(){this._onNetworkStatusChange({isConnected:!0,networkType:Is})}},{key:"_onWebOffline",value:function(){this._onNetworkStatusChange({isConnected:!1,networkType:vs})}},{key:"_onNetworkStatusChange",value:function(e){var t=e.isConnected,n=(e=e.networkType,"".concat(this._n,"._onNetworkStatusChange")),o=!1,i="previous:".concat(this._networkType," current:").concat(e);t?(Ne.i("".concat(n," ").concat(i)),this._networkType!==e&&(o=!0,this._networkType=e,this._m.get(21).reConnect(!0))):this._networkType!==e&&(o=!0,this._networkType=e,Ne.w("".concat(n," no network, please check!")),this._m.get(21).offline()),o&&new so("networkChange").setMessage("isConnected:".concat(t," ").concat(i)).end()}},{key:"isOnline",value:function(){return this._networkType!==vs}},{key:"getNetworkType",value:function(){return this._networkType}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),Z?null!==this._mpNetworkStatusCallback&&(ne.offNetworkStatusChange&&ne.offNetworkStatusChange(this._mpNetworkStatusCallback),this._mpNetworkStatusCallback=null):te?(null!==this._webOnlineCallback&&(window.removeEventListener("online",this._webOnlineCallback),this._webOnlineCallback=null),null!==this._onWebOffline&&(window.removeEventListener("offline",this._webOfflineCallback),this._webOfflineCallback=null)):ee&&this._removeListener&&(this._removeListener(),this._removeListener=null)}}]),Ms);function Ms(e){o(this,Ms),this._m=e,this._networkType=Is,this._n="NetMonitorModule",this._mpNetworkStatusCallback=null,this._webOnlineCallback=null,this._webOfflineCallback=null,this._removeListener=null,this._m.getIEmitInst().on(jo.A2KEY_AND_TINYID_UPDATED,this._startRN,this)}function Cs(e){o(this,Cs),(e=hs.call(this,e))._n="EventStatModule",e.TAG="im-ssolog-event",e._reportBody=new fs,e.MIN_THRESHOLD=20,e.MAX_THRESHOLD=100,e.WAITING_TIME=6e4,e.REPORT_LEVEL=[4,5,6],e.REPORT_SDKAPPID_BLACKLIST=[],e.REPORT_TINYID_WHITELIST=[],e._lastReportTime=Date.now();var t=e.getIEmitInst();return t.on(jo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,h(e)),t.on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Ts(e){o(this,Ts),this._n="SSOLogBody",this._report=[]}function Es(e){o(this,Es),this._m=e,this._n="StorageModule",this._storageQueue=new Map,this._errorTolerantHandle()}function Ds(e,t){return e(t={exports:{}},t.exports),t.exports}var Rs,Ss=Ds((function(e){var t=Object.prototype.hasOwnProperty,n="~";function o(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function s(e,t,o,s,a){if("function"!=typeof o)throw new TypeError("The listener must be a function");return o=new i(o,s||e,a),s=n?n+t:t,e._events[s]?e._events[s].fn?e._events[s]=[e._events[s],o]:e._events[s].push(o):(e._events[s]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function r(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(n=!1)),r.prototype.eventNames=function(){var e,o,i=[];if(0===this._eventsCount)return i;for(o in e=this._events)t.call(e,o)&&i.push(n?o.slice(1):o);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},r.prototype.listeners=function(e){e=n?n+e:e;var t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var o=0,i=t.length,s=new Array(i);o<i;o++)s[o]=t[o].fn;return s},r.prototype.listenerCount=function(e){return e=n?n+e:e,(e=this._events[e])?e.fn?1:e.length:0},r.prototype.emit=function(e,t,o,i,s,a){var r=n?n+e:e;if(!this._events[r])return!1;var c,u=this._events[r],l=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),l){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,o),!0;case 4:return u.fn.call(u.context,t,o,i),!0;case 5:return u.fn.call(u.context,t,o,i,s),!0;case 6:return u.fn.call(u.context,t,o,i,s,a),!0}for(_=1,c=new Array(l-1);_<l;_++)c[_-1]=arguments[_];u.fn.apply(u.context,c)}else for(var d,p=u.length,_=0;_<p;_++)switch(u[_].once&&this.removeListener(e,u[_].fn,void 0,!0),l){case 1:u[_].fn.call(u[_].context);break;case 2:u[_].fn.call(u[_].context,t);break;case 3:u[_].fn.call(u[_].context,t,o);break;case 4:u[_].fn.call(u[_].context,t,o,i);break;default:if(!c)for(d=1,c=new Array(l-1);d<l;d++)c[d-1]=arguments[d];u[_].fn.apply(u[_].context,c)}return!0},r.prototype.on=function(e,t,n){return s(this,e,t,n,!1)},r.prototype.once=function(e,t,n){return s(this,e,t,n,!0)},r.prototype.removeListener=function(e,t,o,i){if(e=n?n+e:e,!this._events[e])return this;if(!t)return a(this,e),this;var s=this._events[e];if(s.fn)s.fn!==t||i&&!s.once||o&&s.context!==o||a(this,e);else{for(var r=0,c=[],u=s.length;r<u;r++)(s[r].fn!==t||i&&!s[r].once||o&&s[r].context!==o)&&c.push(s[r]);c.length?this._events[e]=1===c.length?c[0]:c:a(this,e)}return this},r.prototype.removeAllListeners=function(e){return e?(e=n?n+e:e,this._events[e]&&a(this,e)):(this._events=new o,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=n,e.exports=r.EventEmitter=r})),Ls=["rich.my-imcloud.com","imrich.qcloud.com"],As=["requestSnapshotUrl"],ks=(r(bs,bn),Rs=g(bs),s(bs,[{key:"_init",value:function(){this._fileDownloadProxy=this.getFileDownloadProxy(),this._authKey=this.getDowloadFileAuthKey();var e=this.get(18);this.TIMUploadPlugin=e.getPlugin("tim-upload-plugin"),this.TIMUploadPlugin?this._initUploaderMethod():(this.COSSDK=e.getPlugin(e=Z?"cos-wx-sdk":"cos-js-sdk"),this.COSSDK?(this._getAuthorizationKey(),this.warn("CosReplacement",e)):this.warn("PluginUndetected"))}},{key:"_onCloudConfig",value:function(){var e=this,t="".concat(this._n,"._onCloudConfig"),n=this.getCloudConfig("upload_size_limit"),o=this.getCloudConfig("simple_cos"),i=this.getCloudConfig("file_dn_list");if(Ne.l("".concat(t," uploadSizeLimit:").concat(n," simpleCos:").concat(o)),!pt(n))try{var s=JSON.parse(n);this.UPLOAD_SIZE_LIMIT={A:s.a?1048576*parseInt(s.a):this.UPLOAD_SIZE_LIMIT.A,F:s.f?1048576*parseInt(s.f):this.UPLOAD_SIZE_LIMIT.F,I:s.i?1048576*parseInt(s.i):this.UPLOAD_SIZE_LIMIT.I,V:s.v?1048576*parseInt(s.v):this.UPLOAD_SIZE_LIMIT.V}}catch(t){}if(pt(o)||(this.isSimpleCos="1"===o),!pt(i))try{JSON.parse(i).forEach((function(t){e._fileDNList.includes(t)||e._fileDNList.push(t)}))}catch(t){}}},{key:"_getAuthorizationKey",value:function(){var e=this,t="".concat(this._n,".").concat("_getAuthorizationKey"),n=new so("_getAuthorizationKey"),o=Math.ceil(Date.now()/1e3);this.req({P:Kn.COS_SIGN,data:{duration:this.expiredTimeLimit}}).then((function(i){i=i.data;var s=(Ne.l("".concat(t," ok. data:"),i),i.expiredTime-o);n.setMessage("requestId:".concat(i.requestId," requestTime:").concat(o," expiredTime:").concat(i.expiredTime," diff:").concat(s,"s")).end(),!Z&&i.region&&(e.region=i.region),e.appid=i.appid,e.bucketName=i.bucketName,e.ciUrl=i.ciUrl,e.directory=i.directory,e.downloadUrl=i.downloadUrl,e.uploadUrl=i.uploadUrl,e.cosOptions={secretId:i.secretId,secretKey:i.secretKey,sessionToken:i.sessionToken,expiredTime:i.expiredTime},Ne.l("".concat(t," ok. region:").concat(e.region," bucketName:").concat(e.bucketName)),e._initUploaderMethod()})).catch((function(e){n.setError(e).end(),Ne.w("".concat(t," failed. error:"),e)}))}},{key:"_getCosPreSigUrl",value:function(e){var t=this,n="".concat(this._n,".").concat("_getCosPreSigUrl"),o=Math.ceil(Date.now()/1e3),i=new so("_getCosPreSigUrl"),s={uploadMethod:e.uploadMethod,platform:this.getPlatform(),SDKAppID:this.getSDKAppID(),userID:e.userID,conversationType:e.conversationType,uploadConfig:[{fileID:1,fileType:e.fileType,fileName:e.fileName}]},a=Kn.SIMPLE_COS_PRE_SIG;return this.isSimpleCos||(s={fileType:e.fileType,fileName:e.fileName,uploadMethod:e.uploadMethod,duration:e.duration},a=Kn.COS_PRE_SIG),this.req({P:a,data:s}).then((function(e){t.tryCount=0,e=e.data||{};var s,a,r=(Ne.l("".concat(n," ok. isSimpleCos:").concat(t.isSimpleCos," data:"),e),"");return r=t.isSimpleCos?(s=(a=e.preSig[0]).uploadUrl,a=a.fileKey,"uploadIP:".concat(e.uploadIP," uploadUrl:").concat(s," fileKey:").concat(a," cost:").concat(Jt(o))):"requestId:".concat(e.requestId," expiredTime:").concat(e.expiredTime," diff:").concat(e.expiredTime-o,"s"),i.setMessage(r).end(),e})).catch((function(o){return-1===o.code&&(o.code=Bn.COS_GET_SIG_FAIL),i.setError(o).end(),Ne.w("".concat(n," failed. error:"),o),t.tryCount<1?(t.tryCount++,t._getCosPreSigUrl(e)):(t.tryCount=0,Rn({code:Bn.COS_GET_SIG_FAIL}))}))}},{key:"_initUploaderMethod",value:function(){var e=this;if(this.TIMUploadPlugin)return this.timUploadPlugin=new this.TIMUploadPlugin,void(this._cosUploadMethod=function(t,n){e.timUploadPlugin.uploadFile(t,n)});this.appid&&(this.cos=Z?new this.COSSDK({ForcePathStyle:!0,getAuthorization:this._getAuthorization.bind(this)}):new this.COSSDK({getAuthorization:this._getAuthorization.bind(this)}),this._cosUploadMethod=Z?function(t,n){e.cos.postObject(t,n)}:function(t,n){e.cos.uploadFiles(t,n)})}},{key:"onCheckTimer",value:function(e){this.COSSDK&&(this.TIMUploadPlugin||this.isLoggedIn()&&e%60==0&&Math.ceil(Date.now()/1e3)>=this.cosOptions.expiredTime-120&&this._getAuthorizationKey())}},{key:"getFileDNList",value:function(){return this._fileDNList}},{key:"_getAuthorization",value:function(e,t){t({TmpSecretId:this.cosOptions.secretId,TmpSecretKey:this.cosOptions.secretKey,XCosSecurityToken:this.cosOptions.sessionToken,ExpiredTime:this.cosOptions.expiredTime})}},{key:"upload",value:function(e){if(!0===e._relayFlag)return Promise.resolve();var t=this.get(26);switch(e.type){case D.MSG_IMAGE:return t.addTotalCount(Qn),this._uploadImage(e);case D.MSG_FILE:return t.addTotalCount(Qn),this._uploadFile(e);case D.MSG_AUDIO:return t.addTotalCount(Qn),this._uploadAudio(e);case D.MSG_VIDEO:return t.addTotalCount(Qn),this._uploadVideo(e);default:return Promise.resolve()}}},{key:"_uploadImage",value:function(e){var n=this,o=this.get(2),i=e.getElements()[0],s=o.getMessageOption(e.clientSequence);return this.doUploadImage({file:s.payload.file,to:s.to,message:e,onProgress:function(e){if(i.updatePercent(e),Ze(s.onProgress))try{s.onProgress(e)}catch(e){return Rn({code:Bn.MSG_ONPROGRESS_ERR})}}}).then((function(o){var s=o.location,a=o.fileType,r=o.fileSize,c=o.width,u=o.height,l=o.smallImageUrl,d=o.smallImageWidth,p=o.smallImageHeight,_=o.largeImageUrl,h=o.largeImageWidth,g=o.largeImageHeight,f=o.imageInfoArray;o=n.isPrivateNetWork()?s:ct(s),i.updateImageFormat(a);var m,v,I={size:r,url:o,width:c,height:u};if(f&&0<f.length)for(var y=0;y<f.length;y++){var M=f[y];1===M.type?m=M:2===M.type?v=M:I=t(t({},I),M)}else v=l&&_?(m={url:l,width:d,height:p},{url:_,width:h,height:g}):(m=Gt({originUrl:o,originWidth:c,originHeight:u,min:198}),Gt({originUrl:o,originWidth:c,originHeight:u,min:720}));return i.updateImageInfoArray([t({},I),t({},v),t({},m)]),e}))}},{key:"_uploadFile",value:function(e){var t=this,n=this.get(2),o=e.getElements()[0],i=n.getMessageOption(e.clientSequence);return this.doUploadFile({file:i.payload.file,to:i.to,message:e,onProgress:function(e){if(o.updatePercent(e),Ze(i.onProgress))try{i.onProgress(e)}catch(e){return Rn({code:Bn.MSG_ONPROGRESS_ERR})}}}).then((function(n){var i=n=n.location;return t.isPrivateNetWork()||(i=po(i=ct(n),t._fileDownloadProxy,t._authKey,t._fileDNList)),o.updateFileUrl(i),e}))}},{key:"_uploadAudio",value:function(e){var t=this,n=this.get(2),o=e.getElements()[0],i=n.getMessageOption(e.clientSequence);return this.doUploadAudio({file:i.payload.file,to:i.to,message:e,onProgress:function(e){if(o.updatePercent(e),Ze(i.onProgress))try{i.onProgress(e)}catch(e){return Rn({code:Bn.MSG_ONPROGRESS_ERR})}}}).then((function(n){return n=n.location,n=t.isPrivateNetWork()?n:ct(n),o.updateAudioUrl(n),e}))}},{key:"_uploadVideo",value:function(e){var t=this,n=this.get(2),o=e.getElements()[0],i=n.getMessageOption(e.clientSequence);return this.doUploadVideo({file:i.payload.file,to:i.to,message:e,onProgress:function(e){if(o.updatePercent(e),Ze(i.onProgress))try{i.onProgress(e)}catch(e){return Rn({code:Bn.MSG_ONPROGRESS_ERR})}}}).then((function(n){var i=n.location;return n=n.snapshotInfo,i=t.isPrivateNetWork()?i:ct(i),o.updateVideoUrl(i),He(n)||o.updateSnapshotInfo(n),e}))}},{key:"_checkSizeError",value:function(e){var t="";return"A"===e?t="audio":"I"===e?t="image":"V"===e?t="video":"F"===e&&(t="file"),Rn({code:Bn["MSG_".concat(e,"_SIZE_LIMIT")],message:this.getErrMsg("UploadSizeLimit",t,"".concat(this.UPLOAD_SIZE_LIMIT[e]/1048576,"MB"))})}},{key:"doUploadImage",value:function(e){var t=this;if(!e.file||this._isEmptyFileList(e.file.files))return Rn({code:Bn.MSG_I_SELECT_F_FIRST});var n=this._checkImageType(e.file);if(!0!==n)return n;if(!0!==(n=this._checkImageSize(e.file)))return n;var o=null;return this._setUploadFileType(1),this.uploadByCOS(e).then((function(n){if(o=n,t.isPrivateNetWork())return kt(s);if(Xe(o.imageInfoArray)){var i=o.imageInfoArray.find((function(e){return 3===e.type}));if(i)return i}if(ee)return{width:e.file.width,height:e.file.height};var s=ct(n.location);return t.COSSDK?kt(s):kt(s=po(s,t._fileDownloadProxy,t._authKey,t._fileDNList))})).then((function(e){return o.width=e.width,o.height=e.height,Promise.resolve(o)}))}},{key:"_checkImageType",value:function(e){var t="";return t=Z?e.url.slice(e.url.lastIndexOf(".")+1):ee?e.type.split("/")[1]:e.files[0].name.slice(e.files[0].name.lastIndexOf(".")+1),0<=ai.indexOf(t.toLowerCase())||Rn({code:Bn.MSG_I_TYPES_LIMIT})}},{key:"_checkImageSize",value:function(e){return 0===(e=(Z||ee?e:e.files[0]).size)?Rn({code:Bn.MSG_F_IS_EMPTY}):e<this.UPLOAD_SIZE_LIMIT.I||this._checkSizeError("I")}},{key:"doUploadFile",value:function(e){return!e.file||this._isEmptyFileList(e.file.files)?Rn({code:Bn.MSG_F_SELECT_F_FIRST}):e.file.files[0].size>this.UPLOAD_SIZE_LIMIT.F?this._checkSizeError("F"):0===e.file.files[0].size?Rn({code:Bn.MSG_F_IS_EMPTY}):(this._setUploadFileType(255),this.uploadByCOS(e))}},{key:"doUploadVideo",value:function(e){return e.file.videoFile.size>this.UPLOAD_SIZE_LIMIT.V?this._checkSizeError("V"):0===e.file.videoFile.size?Rn({code:Bn.MSG_F_IS_EMPTY}):-1===ri.indexOf(e.file.videoFile.type)?Rn({code:Bn.MSG_V_TYPES_LIMIT}):(this._setUploadFileType(2),Z||ee?this.handleVideoUpload(t(t({},e),{},{file:e.file.videoFile})):te?this.handleVideoUpload(e):void 0)}},{key:"handleVideoUpload",value:function(e){var t=this;return new Promise((function(n,o){t.uploadByCOS(e).then((function(e){n(e)})).catch((function(){t.uploadByCOS(e).then((function(e){n(e)})).catch((function(){o(new Vn({code:Bn.MSG_V_UPLOAD_FAIL}))}))}))}))}},{key:"doUploadAudio",value:function(e){return e.file?e.file.size>this.UPLOAD_SIZE_LIMIT.A?this._checkSizeError("A"):0===e.file.size?Rn({code:Bn.MSG_F_IS_EMPTY}):(this._setUploadFileType(3),this.uploadByCOS(e)):Rn({code:Bn.MSG_A_UPLOAD_FAIL})}},{key:"uploadByCOS",value:function(e){var t=this;if(!Ze(this._cosUploadMethod))return this.warn("PluginUndetected"),Rn({code:Bn.COS_UNDETECTED});if(this.timUploadPlugin)return this._uploadWithPreSigUrl(e);var n=new so("upload"),o="".concat(this._n,".uploadByCOS"),i=Date.now(),s=this._getFile(e);return new Promise((function(a,r){var c=Z?t._createCosOptionsWXMiniApp(e):t._createCosOptionsWeb(e),u=t;t._cosUploadMethod(c,(function(e,c){var l=Object.create(null);if(c){if(e||Xe(c.files)&&c.files[0].error)return d=new Vn({code:Bn.MSG_F_UPLOAD_FAIL}),n.setError(d).end(),Ne.l("".concat(o," failed. error:"),c.files[0].error),403===c.files[0].error.statusCode&&t._getAuthorizationKey(),void r(d);l.fileName=s.name,l.fileSize=s.size,l.fileType=s.type.slice(s.type.indexOf("/")+1).toLowerCase(),l.location=(Z?c:c.files[0].data).Location;var d=Date.now()-i,p=(c=u._formatFileSize(s.size),u._formatSpeed(1e3*s.size/d));return c="size:".concat(c," time:").concat(d,"ms speed:").concat(p),(Ne.l("".concat(o," success. name:").concat(s.name," ").concat(c)),a(l),p=t.get(26)).addCost(Qn,d),p.addFileSize(Qn,s.size),void n.setMessage(c).end()}l=new Vn({code:Bn.MSG_F_UPLOAD_FAIL}),n.setError(l).end(),Ne.w("".concat(o," failed. error:"),e),403===e.statusCode&&t._getAuthorizationKey(),r(l)}))}))}},{key:"_uploadWithPreSigUrl",value:function(e){var t=this,n="".concat(this._n,"._uploadWithPreSigUrl"),o=this._getFile(e);return this._createCosOptionsPreSigUrl(e).then((function(e){return new Promise((function(i,s){var a=new so("upload"),r=e.requestSnapshotUrl,c=void 0===r?void 0:r,u=_(e,As),l=Date.now();t._cosUploadMethod(u,(function(r,d){var p,_,h;return r||403===d.statusCode?(a.setError(new Vn(r)).end(),_={HttpStatusCode:9999,CostTime:Jt(l,!1),error:r,url:e.url},d.data&&d.data.uploadIP&&(_.uploadIP=d.data.uploadIP),t._uploadSSOLog(_),Ne.l("".concat(n," failed, error:"),r),void s(new Vn({code:Bn.MSG_F_UPLOAD_FAIL}))):(p=Object.create(null),_=d.data.location||"",t.isPrivateNetWork()||0!==_.indexOf("https://")&&0!==_.indexOf("http://")||(_=_.split("//")[1]),p.fileName=o.name,p.fileSize=o.size,p.fileType=o.type.slice(o.type.indexOf("/")+1).toLowerCase(),p.location=_,r=Jt(l,!1),_=t._formatFileSize(o.size),h=t._formatSpeed(1e3*o.size/r),_="size:".concat(_," time:").concat(r,"ms speed:").concat(h," res:").concat(JSON.stringify(d.data)),Ne.l("".concat(n," ok. name:").concat(o.name," ").concat(_)),a.setMessage(_).end(),h={HttpStatusCode:d.statusCode,FileSize:o.size,CostTime:r,url:e.url},d.data&&d.data.uploadIP&&(h.uploadIP=d.data.uploadIP),t._uploadSSOLog(h),(_=t.get(26)).addCost(Qn,r),_.addFileSize(Qn,o.size),h=[],u.thumbUrl&&u.largeUrl&&h.push.apply(h,[t._getSmallImageInfoByUrl(u.thumbUrl,p),t._getLargeImageInfoByUrl(u.largeUrl,p)]),1===t.uploadFileType&&t.isSimpleCos&&!t.isPrivateNetWork()&&(h.push(t._getImageInfoArray(u.downloadUrl,p)),d.data.uploadIP&&h.push(t._getDownloadIP(u.downloadUrl.split("//")[1].split("/")[0],p))),c&&h.push(t._getSnapshotInfoByUrl(c,p)),0<h.length?Promise.all(h).then((function(){i(p)})):void i(p))}))}))}))}},{key:"_getDownloadIP",value:function(e,t){var n="".concat(this._n,"._getDownloadIP"),o=Date.now();return this.req({P:Kn.GET_IP,data:{domainName:e}}).then((function(e){var i;e.data&&e.data.ip&&(Ne.l("".concat(n," ok. downloadIP:").concat(e.data.ip," cost:").concat(Jt(o))),(i=t.location.split("/"))[0]=e.data.ip,t.location=i.join("/"))})).catch((function(e){}))}},{key:"_getImageInfoArray",value:function(e,t){var n=this,o="".concat(this._n,"._getImageInfoArray"),i=Date.now();return this.req({P:Kn.GET_IMAGE_INFO,data:{imageUrl:e}}).then((function(e){return e=e.data||{},Ne.l("".concat(o," ok. data: ").concat(JSON.stringify(e)," cost:").concat(Jt(i))),t.imageInfoArray=e.imageInfoArray,e})).catch((function(o){t.imageInfoArray=void 0,n._uploadSSOLog({HttpStatusCode:1e4,CostTime:Jt(i,!1),url:e})}))}},{key:"_uploadSSOLog",value:function(e){var t,n;this.isSimpleCos&&((t=new so).setEventType(18),e.error&&t.setError(new Vn(e.error)),n="HttpStatusCode:".concat(e.HttpStatusCode,"|CosRequestId:").concat(e.CosRequestId||"","|")+"FileAlreadyExist:".concat(e.FileAlreadyExist||0,"|FileSize:").concat(e.FileSize||0,"|CostTime:").concat(e.CostTime),e.uploadIP&&(n+="|FinalIP:".concat(e.uploadIP)),t.setMessage("OK").setMoreMessage(e.url).setExtension(n).end())}},{key:"_getRawOrUploadProxyUrl",value:function(e){var t=this.get(12).getFileUploadProxy(),n=e;return t?e.replace(/^https:\/\/[^/]+/,t):n}},{key:"_getFile",value:function(e){return Xe(e.file.files)||$e(e.file.files)?e.file.files[0]:e.file}},{key:"_formatFileSize",value:function(e){return e<1024?e+"B":e<1048576?Math.floor(e/1024)+"KB":Math.floor(e/1048576)+"MB"}},{key:"_formatSpeed",value:function(e){return e<=1048576?wt(e/1024,1)+"KB/s":wt(e/1048576,1)+"MB/s"}},{key:"_createCosOptionsWeb",value:function(e){var t=this._getFile(e),n=(n=t.name).slice(n.lastIndexOf("."));return n=this._genFileName("".concat(st(999999)).concat(n)),{files:[{Bucket:"".concat(this.bucketName,"-").concat(this.appid),Region:this.region,Key:"".concat(this.directory,"/").concat(n),Body:t}],SliceSize:1048576,onProgress:function(t){if("function"==typeof e.onProgress)try{e.onProgress(t.percent)}catch(t){Ne.w("onProgress callback error:",t)}},onFileFinish:function(e,t,n){}}}},{key:"_createCosOptionsWXMiniApp",value:function(e){var t=this._getFile(e),n=this._genFileName(t.name);return t=t.url,{Bucket:"".concat(this.bucketName,"-").concat(this.appid),Region:this.region,Key:"".concat(this.directory,"/").concat(n),FilePath:t,onProgress:function(t){if(Ne.l(JSON.stringify(t)),"function"==typeof e.onProgress)try{e.onProgress(t.percent)}catch(t){Ne.w("onProgress callback error:",t)}}}}},{key:"_createCosOptionsPreSigUrl",value:function(e){var t,n=this,o="",i="",s=0,a=this._getFile(e);return s=Z||ee?(o=e.message.type===D.MSG_FILE?(t=(t=a.name).slice(t.lastIndexOf(".")),this._genFileName("".concat(st(999999)).concat(t))):this._genFileName(a.name),i=a.url,1):(t=(t=a.name).slice(t.lastIndexOf(".")),o=this._genFileName("".concat(st(999999)).concat(t)),i=a,0),this._getCosPreSigUrl({fileType:this.uploadFileType,fileName:o,uploadMethod:s,duration:this.duration,userID:e.message.from,conversationType:Rt(e.message.conversationID)?1:2}).then((function(t){var s=(l=n.isSimpleCos?t.preSig[0]:t).uploadUrl,a=l.downloadUrl,r=void 0===(r=l.requestSnapshotUrl)?void 0:r,c=l.thumbUrl,u=l.largeUrl,l=l.fileKey;return t=void 0===(t=t.uploadIP)?"":t,{url:n._getRawOrUploadProxyUrl(s),fileType:n.uploadFileType,fileName:o,resources:i,downloadUrl:a,requestSnapshotUrl:r,thumbUrl:c,largeUrl:u,fileKey:l,uploadIP:!n.isPrivateNetWork()&&t,onProgress:function(t){if("function"==typeof e.onProgress)try{e.onProgress(t.percent)}catch(t){Ne.w("onProgress callback error:",t),Ne.e(t)}}}}))}},{key:"_genFileName",value:function(e){return"".concat(Ot(),"-").concat(e)}},{key:"_setUploadFileType",value:function(e){this.uploadFileType=e}},{key:"_getSnapshotInfoByUrl",value:function(e,t){var n=this,o="_getSnapshotInfoByUrl",i=new so(o);return this.req({P:Kn.VIDEO_COVER,data:{platform:this.getPlatform(),coverName:this._genFileName(st(99999)),requestSnapshotUrl:e}}).then((function(e){if(e=(e.data||{}).snapshotUrl,Ne.l("".concat(n._n,".").concat(o," ok. snapshotUrl:").concat(e)),i.setMessage("snapshotUrl:".concat(e)).end(),He(e))return{};var s=po(e,n._fileDownloadProxy,n._authKey,n._fileDNList);return kt(s).then((function(e){t.snapshotInfo={snapshotUrl:s,snapshotWidth:e.width,snapshotHeight:e.height}}))})).catch((function(e){return Ne.w("".concat(n._n,".").concat(o," failed. error:"),e),i.setCode(e.errorCode).setMessage(e.errorInfo).end(),{}}))}},{key:"_getSmallImageInfoByUrl",value:function(e,t){return kt(po(e,this._fileDownloadProxy,this._authKey,this._fileDNList)).then((function(n){t.smallImageUrl=e,t.smallImageWidth=n.width,t.smallImageHeight=n.height}))}},{key:"_getLargeImageInfoByUrl",value:function(e,t){return kt(po(e,this._fileDownloadProxy,this._authKey,this._fileDNList)).then((function(n){t.largeImageUrl=e,t.largeImageWidth=n.width,t.largeImageHeight=n.height}))}},{key:"_isEmptyFileList",value:function(e){return!(!$e(e)||0!==e.length)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset"))}}]),bs),Os=["downloadKey","pbDownloadKey","messageList"],Ns=(s(Us,[{key:"uploadMergerMessage",value:function(e,t){var n="".concat(this._n,".").concat("uploadMergerMessage"),o=(Ne.d("".concat(n," message:"),e,"messageBytes:".concat(t)),e=JSON.parse(JSON.stringify(e.payload)).messageList).length,i=this._msgM.get(17).getFileDNList(),s=new so("uploadMergerMessage");return e.forEach((function(e){_o(e.messageBody[0].type,e.messageBody,i)})),this._msgM.req({P:Kn.UPLOAD_MERGER_MSG,data:{messageList:e}}).then((function(e){Ne.d("".concat(n," ok. response:"),e.data);var i={pbDownloadKey:i=(e=e.data).pbDownloadKey,downloadKey:e=e.downloadKey,messageNumber:o};return s.setMessage("".concat(o,"-").concat(t,"-").concat(e)).end(),i})).catch((function(e){throw Ne.w("".concat(n," failed. error:"),e),s.setError(e).end(),e}))}},{key:"downloadMergerMessage",value:function(e){var n=this,o="".concat(this._n,".").concat("downloadMergerMessage"),i=(Ne.d("".concat(o," message:"),e),e.payload.downloadKey),s=this._msgM.getFileDownloadProxy(),a=this._msgM.getDowloadFileAuthKey(),r=new so("downloadMergerMessage");return r.setMessage("downloadKey:".concat(i)),this._msgM.req({P:Kn.DOWNLOAD_MERGER_MSG,data:{downloadKey:i}}).then((function(i){Ne.d("".concat(o," ok. response:"),i.data);var c,u,l=n._msgM.get(17).getFileDNList();return Ze(e.clearElement)?((c=e.payload).downloadKey,c.pbDownloadKey,c.messageList,c=_(c,Os),e.clearElement(),e.setElement({type:e.type,content:t({messageList:i.data.messageList},c)},s,a,l)):(u=[],i.data.messageList.forEach((function(e){He(e)||(e=new So(e,s,a,l),u.push(e))})),e.payload.messageList=u,e.payload.downloadKey="",e.payload.pbDownloadKey=""),r.end(),e})).catch((function(e){throw Ne.w("".concat(o," failed. key:").concat(i," error:"),e),r.setError(e).end(),e}))}},{key:"createMergerMessagePack",value:function(e,t,n){return e.conversationType===D.CONV_C2C?this._createC2CMergerMessagePack(e,t,n):this._createGroupMergerMessagePack(e,t,n)}},{key:"_createC2CMergerMessagePack",value:function(e,t,n){var o=null,i=(t&&(t.offlinePushInfo&&(o=t.offlinePushInfo),!0===t.onlineUserOnly&&(o?o.disablePush=!0:o={disablePush:!0})),[]),s=(ze(t)&&ze(t.messageControlInfo)&&(s=(r=t.messageControlInfo).excludedFromUnreadCount,a=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===s&&i.push("NoUnread"),!0===a&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),""),a=(dt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(s=e.cloudCustomData),n.pbDownloadKey),r=n.downloadKey,c=(n=n.messageNumber,(l=e.payload).title),u=l.abstractList,l=l.compatibleText,d=(d=this._msgM.get(6))&&d.isOnlineMessage(e,t)?0:void 0;return{P:Kn.SEND_C2C_MSG,data:{fromAccount:this._msgM.getMyUserID(),toAccount:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:a,downloadKey:r,title:c,abstractList:u,compatibleText:l,messageNumber:n}}],cloudCustomData:s,clientTime:e.clientTime,msgSeq:e.sequence,msgRandom:e.random,msgLifeTime:d,offlinePushInfo:Ko(o),messageControlInfo:0!==d?i:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}},{key:"_createGroupMergerMessagePack",value:function(e,t,n){var o=null,i=(t&&t.offlinePushInfo&&(o=t.offlinePushInfo),[]),s=(ze(t)&&ze(t.messageControlInfo)&&(s=(r=t.messageControlInfo).excludedFromUnreadCount,a=r.excludedFromLastMessage,r=r.excludedFromContentModeration,!0===s&&i.push("NoUnread"),!0===a&&i.push("NoLastMsg"),!0===r&&i.push("NoMsgCheck")),""),a=(dt(e.cloudCustomData)&&0<e.cloudCustomData.length&&(s=e.cloudCustomData),n.pbDownloadKey),r=n.downloadKey,c=(n=n.messageNumber,(l=e.payload).title),u=l.abstractList,l=l.compatibleText,d=this._msgM.get(7);return t=d&&d.isOnlineMessage(e,t)?1:0,{P:Kn.SEND_GRP_MSG,data:{fromAccount:this._msgM.getMyUserID(),groupID:e.to,msgBody:[{msgType:e.type,msgContent:{pbDownloadKey:a,downloadKey:r,title:c,abstractList:u,compatibleText:l,messageNumber:n}}],random:e.random,priority:e.priority,clientSequence:e.clientSequence,groupAtInfo:void 0,cloudCustomData:s,onlineOnlyFlag:t,offlinePushInfo:Ko(o),clientTime:e.clientTime,needReadReceipt:!0!==e.needReadReceipt||d.isMessageFromOrToAVChatroom(e.to)?0:1,messageControlInfo:0==t?i:void 0,isSupportExtension:!0===e.isSupportExtension?1:0,isRelayMessage:!0===e._relayFlag?1:0}}}}]),Us),Ps={ERR_SVR_COMM_SENSITIVE_TEXT:80001,ERR_SVR_COMM_BODY_SIZE_LIMIT:80002,OPEN_SERVICE_OVERLOAD_ERROR:60022,ERR_SVR_MSG_PKG_PARSE_FAILED:20001,ERR_SVR_MSG_INTERNAL_AUTH_FAILED:20002,ERR_SVR_MSG_INVALID_ID:20003,ERR_SVR_MSG_PUSH_DENY:20006,ERR_SVR_MSG_IN_PEER_BLACKLIST:20007,ERR_SVR_MSG_BOTH_NOT_FRIEND:20009,ERR_SVR_MSG_NOT_PEER_FRIEND:20010,ERR_SVR_MSG_NOT_SELF_FRIEND:20011,ERR_SVR_MSG_SHUTUP_DENY:20012,ERR_SVR_GROUP_INVALID_PARAMETERS:10004,ERR_SVR_GROUP_PERMISSION_DENY:10007,ERR_SVR_GROUP_NOT_FOUND:10010,ERR_SVR_GROUP_INVALID_GROUPID:10015,ERR_SVR_GROUP_REJECT_FROM_THIRDPARTY:10016,ERR_SVR_GROUP_SHUTUP_DENY:10017,MSG_SEND_FAIL:2100,OVER_FREQUENCY_LIMIT:2996},Gs=[Bn.MSG_ONPROGRESS_ERR,Bn.MSG_I_SELECT_F_FIRST,Bn.MSG_I_TYPES_LIMIT,Bn.MSG_F_IS_EMPTY,Bn.MSG_I_SIZE_LIMIT,Bn.MSG_F_SELECT_F_FIRST,Bn.MSG_F_SIZE_LIMIT,Bn.MSG_V_SIZE_LIMIT,Bn.MSG_V_TYPES_LIMIT,Bn.MSG_A_UPLOAD_FAIL,Bn.MSG_A_SIZE_LIMIT,Bn.COS_UNDETECTED];function Us(e){o(this,Us),this._n="MergerMessageHandler",this._msgM=e}function bs(e){o(this,bs),(e=Rs.call(this,e))._n="UploadModule",e.TIMUploadPlugin=null,e.timUploadPlugin=null,e.COSSDK=null,e._cosUploadMethod=null,e.expiredTimeLimit=600,e.appid=0,e.bucketName="",e.ciUrl="",e.directory="",e.downloadUrl="",e.uploadUrl="",e.region="ap-shanghai",e.cos=null,e.cosOptions={secretId:"",secretKey:"",sessionToken:"",expiredTime:0},e.uploadFileType="",e.duration=900,e.tryCount=0,e.UPLOAD_SIZE_LIMIT={A:20971520,F:104857600,I:20971520,V:104857600},e.isSimpleCos=!1,e._fileDownloadProxy="",e._authKey="",e._fileDNList=Ls;var t=e.getIEmitInst();return t.on(jo.A2KEY_AND_TINYID_UPDATED,e._init,h(e)),t.on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function ws(e){var t=!1;return Object.values(Ps).includes(e)&&(t=!0),120001<=e&&e<=13e4||10100<=e&&e<=10200||t}r(na,bn),Hs=g(na),s(na,[{key:"createTextMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e));return e=dt(e.payload)?e.payload:e.payload.text,e=new ao({text:e}),t=this._getNickAndAvatarByUserID(t),n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createImageMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e));if(Z){if(Ye(i=e.payload.file))return void this.warn("FileUnsupportedInMP","createImageMessage");var o=i.tempFiles[0].path||i.tempFiles[0].tempFilePath,i={url:o,name:o.slice(o.lastIndexOf("/")+1),size:i.tempFiles&&i.tempFiles[0].size||1,type:o.slice(o.lastIndexOf(".")+1).toLowerCase()};e.payload.file=i}else ee?(i={url:(o=e.payload.file).uri,name:o.fileName,size:o.fileSize||1,type:o.type,width:o.width,height:o.height},e.payload.file=i):te&&(Ye(e.payload.file)?(o=e.payload.file,e.payload.file={files:[o]}):ze(e.payload.file)&&"undefined"!=typeof uni&&(i=e.payload.file.tempFiles[0],e.payload.file={files:[i]}));return o=new fo({imageFormat:Pe.UNKNOWN,uuid:this._generateUUID(e.payload.file),file:e.payload.file}),i=this._getNickAndAvatarByUserID(t),n.setElement(o),n.setNickAndAvatar(i),n.setNameCard(this._getNameCardByGroupID(n)),this._messageOptionsMap.set(n.clientSequence,e),n}},{key:"createAudioMessage",value:function(e){var t=e.payload.file,n=(Z&&(n={url:t.tempFilePath,name:t.tempFilePath.slice(t.tempFilePath.lastIndexOf("/")+1),size:t.fileSize,second:parseInt(t.duration)/1e3,type:t.tempFilePath.slice(t.tempFilePath.lastIndexOf(".")+1).toLowerCase()},e.payload.file=n),ee&&(n={url:t.uri,name:t.uri.slice(t.uri.lastIndexOf("/")+1),size:t.fileSize||1,second:Math.floor(t.duration/1e3),type:t.uri.slice(t.uri.lastIndexOf(".")+1).toLowerCase()},e.payload.file=n,He(t.uri)&&this.warn("VoiceFileInRN")),this.getMyUserID()),o=(e.currentUser=n,e.senderTinyID=this.getMyTinyID(),new ko(e));return t=new vo({second:Math.floor(t.duration/1e3),size:t.fileSize||t.size||1,url:t.tempFilePath||t.uri,uuid:this._generateUUID(e.payload.file)}),n=this._getNickAndAvatarByUserID(n),o.setElement(t),o.setNickAndAvatar(n),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createVideoMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),e.payload.file.thumbUrl="",e.payload.file.thumbSize=0,{});if(Z){if(j)return void this.warn("VideoUnsupportedInAlipay");if(Ye(e.payload.file))return void this.warn("FileUnsupportedInMP","createVideoMessage");var o=e.payload.file;Xe(o.tempFiles)&&(o=o.tempFiles[0]),n.url=o.tempFilePath,n.name=o.tempFilePath.slice(o.tempFilePath.lastIndexOf("/")+1),n.size=o.size||1,n.second=o.duration||0,n.type=o.tempFilePath.slice(o.tempFilePath.lastIndexOf(".")+1).toLowerCase()}else ee?(o=e.payload.file,n.url=o.uri,n.name=o.fileName,n.size=o.fileSize||1,n.second=o.duration||0,n.type=o.type.split("/")[1]):te&&(Ye(e.payload.file)?(o=e.payload.file,e.payload.file.files=[o]):ze(e.payload.file)&&"undefined"!=typeof uni&&(o=e.payload.file.tempFile,e.payload.file.files=[o]),o=e.payload.file,n.url=window.URL.createObjectURL(o.files[0]),n.name=o.files[0].name,n.size=o.files[0].size||1,n.second=o.files[0].duration||0,n.type=o.files[0].type.split("/")[1]);return e.payload.file.videoFile=n,o=new ko(e),n=new Do({videoFormat:n.type,videoSecond:wt(n.second,0),videoSize:n.size,remoteVideoUrl:"",videoUrl:n.url,videoUUID:this._generateUUID(e.payload.file.videoFile),thumbUUID:this._generateUUID(e.payload.file.videoFile),thumbWidth:e.payload.file.width||200,thumbHeight:e.payload.file.height||200,thumbUrl:e.payload.file.thumbUrl,thumbSize:e.payload.file.thumbSize,thumbFormat:e.payload.file.thumbUrl.slice(e.payload.file.thumbUrl.lastIndexOf(".")+1).toLowerCase()}),t=this._getNickAndAvatarByUserID(t),o.setElement(n),o.setNickAndAvatar(t),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createCustomMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e));return e=new Eo({data:e.payload.data,description:e.payload.description,extension:e.payload.extension}),t=this._getNickAndAvatarByUserID(t),n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createFaceMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e));return e=new mo(e.payload),t=this._getNickAndAvatarByUserID(t),n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"createMergerMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),t=this._getNickAndAvatarByUserID(t),new ko(e));return e=new Lo(e.payload),n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n.setRelayFlag(!0),n}},{key:"createForwardMessage",value:function(e){var t=e.to,n=e.conversationType,o=e.priority,i=e.payload,s=e.needReadReceipt,a=e.receiverList;if(!Xe(i._elements))return Rn({code:Bn.MSG_FORWARD_INVALID_ELEMENTS});var r=this.getMyUserID(),c=this._getNickAndAvatarByUserID(r);return i.type===D.MSG_GRP_TIP?Rn({code:Bn.MSG_FORWARD_TYPE_INVALID}):(n={to:t,conversationType:n,conversationID:"".concat(n).concat(t),priority:o,isPlaceMessage:0,status:Ln,currentUser:r,senderTinyID:this.getMyTinyID(),cloudCustomData:e.cloudCustomData||i.cloudCustomData||"",needReadReceipt:s,receiverList:a,isSupportExtension:e.isSupportExtension||!1},(t=new ko(n)).setElement(i._elements[0]),t.setNickAndAvatar(c),t.setNameCard(this._getNameCardByGroupID(i)),t.setRelayFlag(!0),t)}},{key:"downloadMergerMessage",value:function(e){return this._mergerMessageHandler.downloadMergerMessage(e)}},{key:"createFileMessage",value:function(e){if(Z){if(!B&&!K&&!z)return;var n=ne.getSystemInfoSync().SDKVersion;if(B&&Pt(n,"2.5.0")<0)return void this.warn("WXChooseMessageFile");if(K&&Pt(n,"1.18.0")<0)return void this.warn("QQChooseMessageFile")}te||z?Ye(e.payload.file)?(n=e.payload.file,e.payload.file={files:[n]}):ze(e.payload.file)&&"undefined"!=typeof uni&&(i=(n=e.payload.file).tempFiles,n=n.files,o=null,Xe(i)?o=i[0]:Xe(n)&&(o=n[0]),e.payload.file={files:[o]}):B||K?(n=t(t({},(i=e.payload.file.tempFiles)[0]),{},{url:i[0].path}),e.payload.file={files:[n]}):ee&&(i=t(t({},o=e.payload.file),{},{url:o.uri}),e.payload.file={files:[i]}),n=this.getMyUserID();var o=(e.currentUser=n,e.senderTinyID=this.getMyTinyID(),new ko(e)),i=new To({uuid:this._generateUUID(e.payload.file),file:e.payload.file});return n=this._getNickAndAvatarByUserID(n),o.setElement(i),o.setNickAndAvatar(n),o.setNameCard(this._getNameCardByGroupID(o)),this._messageOptionsMap.set(o.clientSequence,e),o}},{key:"createLocationMessage",value:function(e){var t=this.getMyUserID(),n=(e.currentUser=t,e.senderTinyID=this.getMyTinyID(),new ko(e));return e=new Ro(e.payload),t=this._getNickAndAvatarByUserID(t),n.setElement(e),n.setNickAndAvatar(t),n.setNameCard(this._getNameCardByGroupID(n)),n}},{key:"_onNoModule",value:function(){return Rn({code:Bn.NO_MODULE})}},{key:"sendMessageInstance",value:function(e,t){var n=this;if(!1===this.get(29).filterMessage(e,t))return e.hasRiskContent=!0,this._onSendMessageFailed(e,new Vn({code:Bn.PROFANITY_FOUND}));var o=null;if(e.conversationType===D.CONV_C2C)o=this.get(6);else{if(e.conversationType!==D.CONV_GROUP)return Rn({code:Bn.MSG_INVALID_CONV_TYPE});o=this.get(7)}if(!o)return this._onNoModule();var i,s="".concat(this._n,".sendMessageInstance"),a=this.get(11),r=o.isOnlineMessage(e,t);return this.get(17).upload(e).then((function(){return n._getSendMessageSpecifiedKey(e)===Xn&&n.get(26).addSuccessCount(Qn),n._guardForGroup(e).then((function(){if(!e.isSendable())return Rn({code:Bn.MSG_F_URL_IS_EMPTY});n._addSendMessageTotalCount(e),i=Date.now();var s=function(e){var t="utf-8";te&&document&&(t=document.charset.toLowerCase());var n,o=0,i=e.length;if("utf-8"===t||"utf8"===t)for(var s=0;s<i;s++)(n=e.codePointAt(s))<=127?o+=1:n<=2047?o+=2:n<=65535?o+=3:(o+=4,s++);else if("utf-16"===t||"utf16"===t)for(var a=0;a<i;a++)(n=e.codePointAt(a))<=65535?o+=2:(o+=4,a++);else o=e.replace(/[^\x00-\xff]/g,"aa").length;return o}(JSON.stringify(e));return e.type===D.MSG_MERGER&&11264<s?n._mergerMessageHandler.uploadMergerMessage(e,s).then((function(o){return o=n._mergerMessageHandler.createMergerMessagePack(e,t,o),n.req(o)})):(a.setMessageRandom(e),o.sendMessage(e,t))})).then((function(o){var c,u=(o=o.data).time,l=o.sequence,d=o.readReceiptCode;return o=o.messageDropReason,je(d)&&0!==d&&(new so("sendMessageWithReceipt").setMessage("from:".concat(e.from," to:").concat(e.to," sequence:").concat(l," readReceiptCode:").concat(d)).end(),Ne.w("".concat(s," readReceiptCode:").concat(d," message:").concat(n.getErrMsg(d)))),o&&(d=new so("messageDropReason"),o="from:".concat(e.from," to:").concat(e.to," sequence:").concat(l," messageDropReason:").concat(o),d.setMessage(o).end(),Ne.w("".concat(s," ").concat(o))),n._addSendMessageSuccessCount(e,i),n._messageOptionsMap.delete(e.clientSequence),!0===e.isResend&&(c=a.findMessage(e.ID))&&(Ne.l("".concat(s," resend ok. ID:").concat(c.ID)),a.deleteLocalMessage(c)),e.status=An,e.time=u,d=!1,e.conversationType===D.CONV_GROUP?e.sequence=l:e.conversationType!==D.CONV_C2C||(o=a.getLatestMessageSentByMe(e.conversationID))&&(c=o.nick,u=o.avatar,c===e.nick&&u===e.avatar||(d=!0)),d&&a.modifyMessageSentByMe({conversationID:e.conversationID,latestNick:e.nick,latestAvatar:e.avatar}),!0===r?e._onlineOnlyFlag=!0:(a.appendToMessageList(e),l=e,ze(t)&&ze(t.messageControlInfo)&&(!0===t.messageControlInfo.excludedFromLastMessage&&(e._isExcludedFromLastMessage=!0,l=""),!0===t.messageControlInfo.excludedFromUnreadCount&&(e._isExcludedFromUnreadCount=!0)),o=e.conversationType,Dt(e.to)&&(o=D.CONV_TOPIC,n.get(10).onMessageSent({groupID:xt(e.to),topicID:e.to,lastMessage:l})),a.onMessageSent({conversationOptionsList:[{conversationID:e.conversationID,unreadCount:0,type:o,subType:e.conversationSubType,lastMessage:l}]})),e._relayFlag||"TIMImageElem"!==e.type||Ut(e.payload.imageInfoArray),En({message:e})}))})).catch((function(t){return n._onSendMessageFailed(e,t,r)}))}},{key:"_guardForGroup",value:function(e){if(e.conversationType!==D.CONV_GROUP)return Promise.resolve();var t=this.get(7);if(!t)return this._onNoModule();if(Et({groupID:e.to})){var n=t.getLocalGroupProfile(e.to);if(n&&n.isSupportTopic)return Rn({code:Bn.MSG_SEND_GRP_WITH_TOPIC_FAIL})}return t.guardForAVChatRoom(e)}},{key:"_onSendMessageFailed",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],o="".concat(this._n,"._onSendMessageFailed"),i=(e.status=kn,80001!==t.code&&80004!==t.code||(e.hasRiskContent=!0),this.get(11)),s=(i.deleteMessageRandom(e),10100<=t.code&&t.code<=10200||120001<=t.code&&t.code<=13e4);return n||s||!0===i.appendToMessageList(e)&&Ne.l("".concat(o," message stored, ID:").concat(e.ID)),this._addSendMessageFailCountOnUser(e,t),n=new so("sendMessage"),s="head.seq:".concat(t.data.headSeq," type:").concat(e.type," from:").concat(e.from," to:").concat(e.to),te&&("connection"in navigator&&(i=navigator.connection,s+=" downlink:".concat(i.downlink," effectiveType:").concat(i.effectiveType," rtt:").concat(i.rtt)),"memory"in window.performance&&(i=window.performance.memory,s+=" usedJSHeapSize:".concat(i.usedJSHeapSize," totalJSHeapSize:").concat(i.totalJSHeapSize," jsHeapSizeLimit:").concat(i.jsHeapSizeLimit))),n.setMessage(s).setError(t).end(),Ne.e("".concat(o," ").concat(s," error:"),t),Rn(new Vn({code:t&&t.code?t.code:Bn.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}},{key:"_getSendMessageSpecifiedKey",value:function(e){if([D.MSG_IMAGE,D.MSG_AUDIO,D.MSG_VIDEO,D.MSG_FILE].includes(e.type))return Xn;if(e.conversationType===D.CONV_C2C)return jn;if(e.conversationType===D.CONV_GROUP){var t=this.get(7);if(t&&(t=t.getLocalGroupProfile(e.to)))return Tt(e=t.type)?zn:Jn}}},{key:"_addSendMessageTotalCount",value:function(e){(e=this._getSendMessageSpecifiedKey(e))&&this.get(26).addTotalCount(e)}},{key:"_addSendMessageSuccessCount",value:function(e,t){var n;(e=this._getSendMessageSpecifiedKey(e))&&((n=this.get(26)).addSuccessCount(e),n.addCost(e,Jt(t,!1)))}},{key:"_addSendMessageFailCountOnUser",value:function(e,t){t=void 0===(t=t.code)?-1:t;var n,o=this.get(26);(e=this._getSendMessageSpecifiedKey(e))===Xn&&(n=!1,n=!!Gs.includes(t)||n)?o.addFailedCountOfUserSide(Qn):ws(t)&&e&&o.addFailedCountOfUserSide(e)}},{key:"resendMessage",value:function(e,t){return e.isResend=!0,e.status=Ln,this.sendMessageInstance(e,t)}},{key:"revokeMessage",value:function(e){var t=this,n=null;if(e.conversationType===D.CONV_C2C?n=this.get(6):e.conversationType===D.CONV_GROUP&&(n=this.get(7)),!n)return this._onNoModule();var o=new so("revokeMessage"),i=(o.setMessage("type:".concat(e.type," from:").concat(e.from," to:").concat(e.to)),"".concat(this._n,".").concat("revokeMessage"));return n.revokeMessage(e).then((function(n){return He(n=n.data.recallRetList)||0===n[0].retCode?(Ne.i("".concat(i," ok. ID:").concat(e.ID)),e.isRevoked=!0,o.end(),t.get(11).onMessageRevoked([e]),En({message:e})):(n=new Vn({code:n[0].retCode,data:{message:e}}),o.setCode(n.code).setMoreMessage(n.message).end(),Rn(n))})).catch((function(t){o.setError(t).end();var n=new Vn({code:t&&t.code?t.code:Bn.MSG_REVOKE_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}});return Ne.w("".concat(i," failed. error:"),t),Rn(n)}))}},{key:"deleteMessage",value:function(e){var t=this,n=null,o=e[0],i=o.conversationID,s="",a=[],r=[];if(o.conversationType===D.CONV_C2C)n=this.get(6),s=i.replace(D.CONV_C2C,""),e.forEach((function(e){e&&e.status===An&&e.conversationID===i&&(e._onlineOnlyFlag||a.push("".concat(e.sequence,"_").concat(e.random,"_").concat(e.time)),r.push(e))}));else if(o.conversationType===D.CONV_GROUP)n=this.get(7),s=i.replace(D.CONV_GROUP,""),e.forEach((function(e){e&&e.status===An&&e.conversationID===i&&(e._onlineOnlyFlag||a.push("".concat(e.sequence)),r.push(e))}));else if(o.conversationType===D.CONV_SYSTEM)return Rn({code:Bn.CANNOT_DELETE_GRP_SYSTEM_NOTICE});if(!n)return this._onNoModule();if(0===a.length)return this._onMessageDeleted(r);30<a.length&&(a=a.slice(0,30),r=r.slice(0,30));var c=new so("deleteMessage"),u=(c.setMessage("to:".concat(s," count:").concat(a.length)),"".concat(this._n,".").concat("deleteMessage"));return n.deleteMessage({to:s,keyList:a}).then((function(e){return c.end(),Ne.i("".concat(u," ok")),t._onMessageDeleted(r)})).catch((function(e){return c.setError(e).end(),Ne.w("".concat(u," failed. error:"),e),Rn(e=new Vn({code:e&&e.code?e.code:Bn.MSG_DELETE_FAIL,message:e&&e.message?e.message:void 0}))}))}},{key:"_onMessageDeleted",value:function(e){return this.get(11).onMessageDeleted(e),Dn({messageList:e})}},{key:"translateText",value:function(e){var n="".concat(this._n,".").concat("translateText"),o=e.sourceTextList,i=e.sourceLanguage,s=(e=e.targetLanguage,new so("translateText"));return s.setMessage("sourceLanguage:".concat(i," targetLanguage:").concat(e)),this.req({P:Kn.TRANSLATE_TEXT,data:{sourceTextList:o,source:i||"auto",target:e,from:this.getMyTinyID(),SDKAppID:this.getSDKAppID()}}).then((function(e){var o=(e=e.data).error,i=e.requestID;if(e=e.translatedTextList,0===o.code)return s.end(),Ne.i("".concat(n," ok. requestID:").concat(i)),En({translatedTextList:e});throw t(t({},o),{},{requestID:i})})).catch((function(e){return s.setCode(e.code).setMoreMessage(e.requestID).end(),Ne.w("".concat(n," failed. error:"),e),Rn({code:Bn.TRANSLATE_TEXT_FAIL})}))}},{key:"convertVoiceToText",value:function(e){var n=e.message,o=(e=e.language,n.payload.url);if(!(n.from===this.getMyUserID()&&"out"===n.flow&&(o=n.payload.remoteAudioUrl),n=/\.(wav|pcm|ogg-opus|speex|silk|mp3|m4a|aac|amr)/).test(o))return Rn({code:Bn.UNSUPPORTED_VOICE_FORMAT});n=n.exec(o)[1]||"mp3";var i="16k_zh-PY",s=(e?"zh (cmn-Hans-CN)"===e?i="16k_zh":"en-US"===e?i="16k_en":"yue-Hant-HK"===e?i="16k_yue":"ja-JP"===e&&(i="16k_ja"):i="16k_zh-PY",e="serviceType:".concat(i," url:").concat(o),"".concat(this._n,".").concat("convertVoiceToText")),a=(Ne.i("".concat(s," ").concat(e)),new so("convertVoiceToText"));return a.setMessage(e),this.req({P:Kn.VOICE_TO_TEXT,data:{url:o,language:i,SDKAppID:this.getSDKAppID(),format:n}}).then((function(e){var n=(e=e.data).error,o=e.requestID;if(e=e.result,0===n.code)return a.end(),Ne.i("".concat(s," ok. requestID:").concat(o)),En({result:e});throw t(t({},n),{},{requestID:o})})).catch((function(e){return a.setCode(e.code).setMoreMessage(e.requestID||"").end(),Ne.w("".concat(s," failed. error:"),e),Rn({code:Bn.VOICE_TO_TEXT_FAIL})}))}},{key:"modifyRemoteMessage",value:function(e){var t=this;if(!1===this.get(29).filterMessage(e))return e.hasRiskContent=!0,Rn({code:Bn.PROFANITY_FOUND,data:{message:e}});var n=null,o=e.conversationType,i=e.to;if(o===D.CONV_C2C)n=this.get(6);else if(o===D.CONV_GROUP){if(!(n=this.get(7)))return this._onNoModule();if(n.isMessageFromOrToAVChatroom(i))return Rn({code:Bn.MSG_MODIFY_DISABLED_IN_AV,data:{message:e}})}var s=new so("modifyMessage"),a=(s.setMessage("to:".concat(i)),"".concat(this._n,".modifyRemoteMessage"));return n.modifyRemoteMessage(e).then((function(n){return s.end(),Ne.i("".concat(a," ok")),En({message:n=t._onModifyRemoteMessageResp(e,n.data)})})).catch((function(n){var o;return s.setCode(n.code).setMoreMessage(n.message).end(),Ne.w("".concat(a," failed. error:"),n),20027===n.code?(o=t._onModifyRemoteMessageResp(e,n.data),Rn({code:Bn.MSG_MODIFY_CONFLICT,data:{message:o}})):Rn({code:n.code,message:n.message,data:{message:e}})}))}},{key:"_onModifyRemoteMessageResp",value:function(e,t){Ne.d("".concat(this._n,"._onModifyRemoteMessageResp options:"),t);var n=e.conversationType,o=e.from,i=e.to,s=e.random,a=e.sequence,r=(e=e.time,t.elements),c=t.messageVersion;return t=void 0===(t=t.cloudCustomData)?"":t,this.get(11).onMessageModified({conversationType:n,from:o,to:i,time:e,random:s,sequence:a,elements:r,cloudCustomData:t,messageVersion:c})}},{key:"_generateUUID",value:function(e){var t=this.get(12);return t="".concat(t.getSDKAppID(),"-").concat(t.getUserID(),"-").concat(at()),(e=(e=e.name||e.value||e.url||e.tempFilePath)&&e.slice(e.lastIndexOf(".")+1))?"".concat(t,".").concat(e):t}},{key:"getMessageOption",value:function(e){return this._messageOptionsMap.get(e)}},{key:"_getNickAndAvatarByUserID",value:function(e){return this.get(4).getNickAndAvatarByUserID(e)}},{key:"_getNameCardByGroupID",value:function(e){if(e.conversationType===D.CONV_GROUP){var t=this.get(7);if(t)return t.getMyNameCardByGroupID(e.to)}return""}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._messageOptionsMap.clear()}}]);var Fs,qs,xs,Vs,Bs,Hs,Ks=na,Ws=(r(ta,bn),Bs=g(ta),s(ta,[{key:"onMsgExtNotify",value:function(e){var t=this,n=(e=e.dataList).messageInfo,o=e.operateType,i=e.operateResultList,s=e.tinyID,a=(e=e.globalSequence,n.clientTime),r=(n=n.random,"".concat(s,"-").concat(a,"-").concat(n)),c=[],u=[],l=(Ne.l("".concat(this._n,".onMsgExtNotify messageID:").concat(r," operateType:").concat(o," globalSequence:").concat(e)),this._updateGlobalSeq(r,e),!1),d=!1;i.forEach((function(e){var n=void 0===(n=e.extensions)?[]:n,i=e.clearSequence;1===o?(l=!0,n.forEach((function(e){c.push({key:e.key,value:e.value})})),t._updateLocalExt(r,n)):2===o?(d=!0,n.forEach((function(e){u.push(e.key)})),t._updateLocalExt(r,n)):3===o&&(d=!0,t._hasLocalExt(r)&&t._getLocalExt(r).forEach((function(e,t){e.seq<=i&&!He(e.value)&&u.push(t)})),t._clearLocalExt(r,i))})),l&&this.emitOEvt(E.MESSAGE_EXTENSIONS_UPDATED,{messageID:r,extensions:c}),d&&this.emitOEvt(E.MESSAGE_EXTENSIONS_DELETED,{messageID:r,keyList:u})}},{key:"setMessageExtensions",value:function(e,t){var n="setMessageExtensions";if(!this.canIUse(U.MSG_EXT))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.ID,s=e.conversationID,a=e.sequence,r=e.time,c=m(t),u=(20<t.length&&(c=t.slice(0,20),Ne.w("".concat(o,". the length of extensions cannot exceed 20."))),t="convID:".concat(s," messageID:").concat(i," sequence:").concat(a," time:").concat(r," count:").concat(c.length),new so(n));return u.setMessage(t),Ne.l("".concat(o," ").concat(t)),this._modifyMsgExts(e,c).then((function(e){var t=e.resultList,n=e.successCount;return e=e.failureCount,n="successCount:".concat(n," failCount:").concat(e),u.setMoreMessage(n).end(),Ne.l("".concat(o," ok. ").concat(n)),En({extensions:t})})).catch((function(e){return u.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"getMessageExtensions",value:function(e){var t=this,n="getMessageExtensions";if(!this.canIUse(U.MSG_EXT))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.ID,s=e.conversationID,a=e.sequence,r=e.time,c=(s="convID:".concat(s," messageID:").concat(i," sequence:").concat(a," time:").concat(r),new so(n)),u=(c.setMessage(s),void Ne.l("".concat(o," ").concat(s)));return this.getMsgExtsMap.has(i)&&(u=this._getGlobalSeq(i)),this._getMsgExts(e,u).then((function(e){return c.end(),Ne.l("".concat(o," ok. extCount:").concat(e.length)),pt(u)&&0<e.length&&t.getMsgExtsMap.set(i,1),En({extensions:e})})).catch((function(e){return c.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"deleteMessageExtensions",value:function(e,t){var n="deleteMessageExtensions";if(!this.canIUse(U.MSG_EXT))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=[],s=3,a=(He(t)||(s=2,t.forEach((function(e){i.push({key:e,value:"",seq:0})}))),t=e.ID,e.conversationID),r=e.sequence,c=e.time,u=(a="convID:".concat(a," messageID:").concat(t," sequence:").concat(r," time:").concat(c," operateType:").concat(s),new so(n));return u.setMessage(a),Ne.l("".concat(o," ").concat(a)),this._modifyMsgExts(e,i,s).then((function(e){var t=e.resultList,n=e.successCount,i=(e=e.failureCount,"");return 2===s&&(i="success count:".concat(n," fail count:").concat(e)),u.setMoreMessage("".concat(i)).end(),Ne.l("".concat(o," ok. ").concat(i)),En({extensions:t})})).catch((function(e){return u.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"_modifyMsgExts",value:function(e,t){var n=this,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,i=Dt(e.to)?D.CONV_TOPIC:e.conversationType,s=void 0,a=(3!==o&&(s=this._getReqExts(e,t)),null);switch(i){case D.CONV_C2C:a=this.get(6);break;case D.CONV_GROUP:a=this.get(7);break;case D.CONV_TOPIC:a=this.get(10);break;default:return Rn({code:Bn.NO_MODULE})}return a.modifyMsgExts(e,s,o).then((function(t){var o=(t=t.data).extensions,i=(t=t.seq,[]),s=0,a=0,r=[];return(o=He(o)?[]:o).forEach((function(e){var t=e.errorCode,n=(e=e.extension).key,o=e.value;e=e.seq,i.push({code:t,key:n,value:o}),0===t?s++:a++,r.push({key:n,value:o,seq:e})})),n._updateGlobalSeq(e.ID,t),0<r.length&&(n._updateLocalExt(e.ID,r),r=null),{resultList:i,successCount:s,failureCount:a}})).catch((function(e){return Rn(e)}))}},{key:"_getReqExts",value:function(e,t){var n,o=[];return this._hasLocalExt(e.ID)?(n=this._getLocalExt(e.ID),t.forEach((function(e){var t=e.key,i=(e=e.value,0);n.has(t)&&(i=n.get(t).seq),o.push({key:t,value:e,seq:i})}))):t.forEach((function(e){var t=e.key;e=e.value,o.push({key:t,value:e,seq:0})})),o}},{key:"_getMsgExts",value:function(e,t){var n=this,o="".concat(this._n,"._getMsgExts"),i=e.ID,s=null;switch(Dt(e.to)?D.CONV_TOPIC:e.conversationType){case D.CONV_C2C:s=this.get(6);break;case D.CONV_GROUP:s=this.get(7);break;case D.CONV_TOPIC:s=this.get(10);break;default:return Rn({code:Bn.NO_MODULE})}return s.getMessageExtensions(e,t).then((function(t){var s=(t=t.data).extensions,a=t.completeFlag,r=t.globalSequence;return t=t.clearSequence,s=He(s)?[]:s,Ne.l("".concat(o," ok. completeFlag:").concat(a," globalSequence:").concat(r," clearSequence:").concat(t," count:").concat(s.length)),n._updateLocalExt(i,s),n._clearLocalExt(i,t),n._updateGlobalSeq(i,r),1!==a?(t=s.slice(-1)[0].seq+1,n._getMsgExts(e,t)):n._getLocalExtList(i)})).catch((function(e){return Rn(e)}))}},{key:"_hasLocalExt",value:function(e){return this.msgExtMap.has(e)}},{key:"_getLocalExt",value:function(e){return this.msgExtMap.get(e)}},{key:"_updateLocalExt",value:function(e,t){this._hasLocalExt(e)||this.msgExtMap.set(e,new Map);var n=this._getLocalExt(e);t.forEach((function(e){var t=e.key,o=e.value;e=e.seq,n.set(t,{value:void 0===o?"":o,seq:e})}))}},{key:"_clearLocalExt",value:function(e,t){var n;t<=0||!this._hasLocalExt(e)||(n=this._getLocalExt(e)).forEach((function(e,o){e.seq<=t&&n.delete(o)}))}},{key:"_getLocalExtList",value:function(e){var t=[];return this._hasLocalExt(e)&&this._getLocalExt(e).forEach((function(e,n){He(e=e.value)||t.push({key:n,value:e})})),t}},{key:"_getGlobalSeq",value:function(e){return this.globalSeqMap.get(e)}},{key:"_updateGlobalSeq",value:function(e,t){this.globalSeqMap.set(e,t)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this.msgExtMap.clear(),this.globalSeqMap.clear(),this.getMsgExtsMap.clear()}}]),ta),Ys=(r(ea,bn),Vs=g(ea),s(ea,[{key:"onReactionNotifyList",value:function(e){var n=this;(void 0===(e=(e||{}).dataList)?[]:e).forEach((function(e){var o=e.C2CMessageInfo,i=void 0===(i=e.groupMessageInfo)?{}:i,s=(e=void 0===(e=e.reactionList)?[]:e,i=(o=t(t({},void 0===o?{}:o),i)).tinyID,o.clientTime),a=(o=o.random,i="".concat(i,"-").concat(s,"-").concat(o),[]);e.forEach((function(e){pt(e.userIDList)&&(e.userIDList=[],e.count=0),a.push.apply(a,m(e.userIDList))})),Ne.l("".concat(n._n,".onReactionNotifyList messageID:").concat(i," reactionList:").concat(e.length)),n._handleReactionSummary([{messageID:i,reactionList:e}],a).then((function(e){n.emitOEvt(E.MESSAGE_REACTIONS_UPDATED,t({},e[0]))}))}))}},{key:"onReactionNotify",value:function(e){var n=(e=e.dataList||{}).C2CMessageInfo,o=void 0===(o=e.groupMessageInfo)?{}:o,i=e.reactionID,s=(e=e.operateType,o=(n=t(t({},void 0===n?{}:n),o)).tinyID,n.clientTime);n=n.random,o="".concat(o,"-").concat(s,"-").concat(n),Ne.l("".concat(this._n,".onReactionNotify messageID:").concat(o," reactionID:").concat(i," operateType:").concat(e)),1===e?this._addReactedByMyselfMap(o,i):this._removeReactedByMyselfMap(o,i),s="".concat(o,"-").concat(i),this._reactionInfoMap.has(s)&&((n=this._reactionInfoMap.get(s)).reactedByMyself=1===e,this.emitOEvt(E.MESSAGE_REACTIONS_UPDATED,{messageID:o,reactionList:[n]}))}},{key:"addMessageReaction",value:function(e,t){var n=this,o="addMessageReaction";if(!this.canIUse(U.MSG_REACTION))return this.noUse(o);var i="".concat(this._n,".").concat(o),s=e.ID,a=e.conversationID,r=(a="convID:".concat(a," messageID:").concat(s," reactionID:").concat(t),new so(o));return r.setMessage(a),Ne.l("".concat(i," ").concat(a)),s=this._createReactionOperationPack(e,t,1),this._addReactedByMyselfMap(e.ID,t),this.req(s).then((function(){return r.end(),Ne.l("".concat(i," ok.")),En()})).catch((function(o){return n._removeReactedByMyselfMap(e.ID,t),r.setError(o).end(),Ne.e("".concat(i," failed. error:"),o),Rn(o)}))}},{key:"removeMessageReaction",value:function(e,t){var n="removeMessageReaction";if(!this.canIUse(U.MSG_REACTION))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.ID,s=e.conversationID,a=(s="convID:".concat(s," messageID:").concat(i," reactionID:").concat(t),new so(n));return a.setMessage(s),Ne.l("".concat(o," ").concat(s)),i=this._createReactionOperationPack(e,t,2),this._removeReactedByMyselfMap(e.ID,t),this.req(i).then((function(){return a.end(),Ne.l("".concat(o," ok.")),En()})).catch((function(e){return a.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"getMessageReactions",value:function(e){var n=this,o="getMessageReactions";if(!this.canIUse(U.MSG_REACTION))return this.noUse(o);var i="".concat(this._n,".").concat(o),s=e.messageList,a=e.maxUserCountPerReaction,r=s[0].conversationID,c=(r="convID:".concat(r," maxUserCountPerReaction:").concat(a," msgCount:").concat(s.length),new so(o)),u=(c.setMessage(r),Ne.l("".concat(i," ").concat(r)),new Map);return a=this._createReactionSummaryPack(t(t({},e),{},{messageIDMap:u})),this.req(a).then((function(e){e=e.data.resultList;var t=[],o=[];return(void 0===e?[]:e).forEach((function(e){var n=void 0===(n=e.messageKey)?void 0:n,i=void 0===(i=e.messageSequence)?void 0:i;e=void 0===(e=e.reactionList)?[]:e,i=pt(n)?u.get(i):u.get(n),t.push({messageID:i,reactionList:e}),e.forEach((function(e){o.push.apply(o,m(e.userIDList))}))})),n._handleReactionSummary(t,o)})).then((function(e){return c.end(),Ne.l("".concat(i," ok.")),u.clear(),En({resultList:e})})).catch((function(e){return c.setError(e).end(),Ne.e("".concat(i," failed. error:"),e),Rn(e)}))}},{key:"getAllUserListOfMessageReaction",value:function(e){var t=this,n="getAllUserListOfMessageReaction";if(!this.canIUse(U.MSG_REACTION))return this.noUse(n);var o="".concat(this._n,".").concat(n),i=e.message,s=e.reactionID,a=e.nextSeq,r=e.count,c=i.ID,u=(i=i.conversationID,i="convID:".concat(i," messageID:").concat(c," reactionID:").concat(s," nextSeq:").concat(a," count:").concat(r),new so(n)),l=(u.setMessage(i),Ne.l("".concat(o," ").concat(i)),{userList:[],nextSeq:0,isCompleted:!1});return c=this._createReactionUserListPack(e),this.req(c).then((function(e){var n=void 0===(n=(e=e.data).userIDList)?[]:n;return e=void 0===(e=e.nextSeq)?0:e,l.nextSeq=e,l.isCompleted=0===e,t.get(4).getUserNickAndAvatar(n)})).then((function(e){return l.userList=e,u.end(),Ne.l("".concat(o," ok.")),En(l)})).catch((function(e){return u.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"_createReactionOperationPack",value:function(e,t,n){var o,i,s=void 0;return t={reactionID:t,userIDList:[this.getMyUserID()]},e.conversationType===D.CONV_C2C&&(o=this.get(6),s=1===n?Kn.ADD_C2C_MSG_REACTION:Kn.RM_C2C_MSG_REACTION,t.from=e.from,t.to=e.to,t.messageKey=o.getMessageKey(e)),e.conversationType===D.CONV_GROUP&&(o=void 0,i=e.to,Dt(e.to)&&(i=xt(o=e.to)),s=1===n?Kn.ADD_GRP_MSG_REACTION:Kn.RM_GRP_MSG_REACTION,t.groupID=i,t.topicID=o,t.messageSequence=e.sequence),{P:s,data:t}}},{key:"_createReactionSummaryPack",value:function(e){var t,n,o,i=e.messageList,s=void 0===(s=e.maxUserCountPerReaction)?10:s,a=e.messageIDMap,r=void 0,c=void 0;return(e=i[0]).conversationType===D.CONV_C2C&&(t=this.get(6),n=i.map((function(e){var n=t.getMessageKey(e);return a.set(n,e.ID),n})),r=Kn.GET_C2C_MSG_REACTIONS,c={from:e.from,to:e.to,messageKeyList:n,count:s}),e.conversationType===D.CONV_GROUP&&(n=void 0,o=e.to,Dt(e.to)&&(o=xt(n=e.to)),e=i.map((function(e){return a.set(e.sequence,e.ID),e.sequence})),r=Kn.GET_GRP_MSG_REACTIONS,c={groupID:o,topicID:n,messageSequenceList:e,count:s}),{P:r,data:c}}},{key:"_createReactionUserListPack",value:function(e){var t=e.message,n=e.reactionID,o=e.nextSeq,i=void 0;return n={reactionID:n,nextSeq:void 0===o?0:o,count:100<(e=void 0===(e=e.count)?100:e)?100:e},t.conversationType===D.CONV_C2C&&(o=this.get(6),i=Kn.GET_C2C_MSG_REACTION_USER_LIST,n.from=t.from,n.to=t.to,n.messageKey=o.getMessageKey(t)),t.conversationType===D.CONV_GROUP&&(e=void 0,o=t.to,Dt(t.to)&&(o=xt(e=t.to)),i=Kn.GET_GRP_MSG_REACTION_USER_LIST,n.groupID=o,n.topicID=e,n.messageSequence=t.sequence),{P:i,data:n}}},{key:"_handleReactionSummary",value:function(e,t){var n=this;return this.get(4).getUserNickAndAvatar(t).then((function(t){var o=[];return e.forEach((function(e){var i=[];e.reactionList.forEach((function(o){var s=o.reactionID,a=o.count,r=o.userIDList,c=(o=void 0===(o=o.reactedByMyself)?void 0:o,[]);r.forEach((function(e){t.forEach((function(t){e===t.userID&&c.push(t)}))})),r={reactionID:s,totalUserCount:a,partialUserList:c,reactedByMyself:n._computeReactedByMyself({reactedByMyself:o,messageID:e.messageID,reactionID:s})},i.push(r),pt(o)&&!n._reactedByMyselfMap.has(e.messageID)&&(a="".concat(e.messageID,"-").concat(s),n._reactionInfoMap.set(a,r))})),o.push({messageID:e.messageID,reactionList:i})})),o}))}},{key:"_addReactedByMyselfMap",value:function(e,t){this._reactedByMyselfMap.has(e)||this._reactedByMyselfMap.set(e,[]),-1===(e=this._reactedByMyselfMap.get(e)).indexOf(t)&&e.push(t)}},{key:"_removeReactedByMyselfMap",value:function(e,t){!this._reactedByMyselfMap.has(e)||-1<(t=(e=this._reactedByMyselfMap.get(e)).indexOf(t))&&e.splice(t,1)}},{key:"_computeReactedByMyself",value:function(e){var t=e.reactedByMyself,n=e.messageID;return e=e.reactionID,pt(t)?!!this._reactedByMyselfMap.has(n)&&this._reactedByMyselfMap.get(n).includes(e):1===t}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._reactedByMyselfMap.clear(),this._reactionInfoMap.clear()}}]),ea),js=(r($s,bn),xs=g($s),s($s,[{key:"sendMessage",value:function(e){var t=this,n=this._createMsg(e);if(null===n)return Rn({code:Bn.MSG_SEND_FAIL});this._addSendMessageTotalCount(n);var o=Date.now();return this.get(11).setMessageRandom(n),this._sendComboMessage(n,e).then((function(e){var i=(e=e.data).time,s=e.sequence;return je(e=e.readReceiptCode)&&0!==e&&(new so("sendMessageWithReceipt").setMessage("from:".concat(n.from," to:").concat(n.to," sequence:").concat(s," readReceiptCode:").concat(e)).end(),Ne.w("".concat(t._n,".sendMessage readReceiptCode:").concat(e," message:").concat(t.getErrMsg(e)))),t._addSendMessageSuccessCount(n,o),e=t.get(11),n.status=An,n.time=i,n.conversationType===D.CONV_GROUP&&(n.sequence=s),e.appendToMessageList(n),i=n,!0===n._isExcludedFromLastMessage&&(i=""),e.onMessageSent({conversationOptionsList:[{conversationID:n.conversationID,unreadCount:0,type:n.conversationType,subType:n.conversationSubType,lastMessage:i}]}),En({message:n})})).catch((function(e){return t._onSendMessageFailed(n,e)}))}},{key:"_sendComboMessage",value:function(e,t){var n=this._m.get(20),o="";return e.conversationType===D.CONV_C2C&&(o="".concat(G.NAME.OPEN_IM,".").concat(Kn.SEND_C2C_MSG)),e.conversationType===D.CONV_GROUP&&(o="".concat(G.NAME.GRP,".").concat(Kn.SEND_GRP_MSG)),n.sendComboMessage({servcmd:o,data:t})}},{key:"_createMsg",value:function(e){var t="".concat(this._n,"._createMsg"),n=null;try{var o,i=this.getMyUserID(),s={};s.senderTinyID=this.getMyTinyID(),s.currentUser=i,s.from=e.From_Account||i,e.GroupId?(s.conversationID="".concat(D.CONV_GROUP).concat(e.GroupId),s.conversationType=D.CONV_GROUP,s.to=e.GroupId):e.To_Account&&(s.conversationID="".concat(D.CONV_C2C).concat(e.To_Account),s.conversationType=D.CONV_C2C,s.to=e.To_Account),s.time=e.MsgTimeStamp||0,s.random=e.Random||e.MsgRandom||0,s.priority=e.MsgPriority,dt(e.CloudCustomData)&&0<e.CloudCustomData.length&&(s.cloudCustomData=e.CloudCustomData),Xe(e.SendMsgControl)&&(s.messageControlInfo={},e.SendMsgControl.includes("NoUnread")&&(s.messageControlInfo.excludedFromUnreadCount=1),e.SendMsgControl.includes("NoLastMsg")&&(s.messageControlInfo.excludedFromLastMessage=1)),s.conversationType===D.CONV_GROUP&&Xe(e.To_Account)&&0<e.To_Account.length&&(o=e.To_Account,50<e.To_Account.length&&(o=e.To_Account.slice(0,50),Ne.w("".concat(t," To_Account must be less than or equal to 50."))),s.receiverList=m(o),e.To_Account=m(o)),1!==e.IsNeedReadReceipt&&1!==e.NeedReadReceipt||(s.needReadReceipt=!0),1===e.SupportMessageExtension&&(s.isSupportExtension=!0),(n=new ko(s)).status=Ln,e.MsgClientTime=n.clientTime,n.conversationType===D.CONV_C2C&&(e.MsgSeq=n.sequence);for(var a,r=e.MsgBody.length,c=0;c<r;c++)"TIMTextElem"===(a=e.MsgBody[c]).MsgType?n.setTextElement(a.MsgContent.Text):"TIMCustomElem"===a.MsgType?n.setCustomElement({data:a.MsgContent.Data||"",description:a.MsgContent.Desc||"",extension:a.MsgContent.Ext||""}):"TIMFaceElem"===a.MsgType&&n.setFaceElement({index:a.MsgContent.Index,data:a.MsgContent.Data});var u=n.getElements();n.payload=u[0].content,n.type=u[0].type}catch(e){n=null,Ne.e("".concat(t," failed. error:"),e)}return n}},{key:"_onSendMessageFailed",value:function(e,t){e.status=kn,this.get(11).deleteMessageRandom(e),this._addSendMessageFailCountOnUser(e,t);var n=new so("sendMessage"),o="head.seq:".concat(t.data.headSeq,"  type:").concat(e.type," from:").concat(e.from," to:").concat(e.to);return n.setMessage(o).setError(t).end(),Ne.e("".concat(this._n,"._onSendMessageFailed ").concat(o," error:"),t),Rn(new Vn({code:t&&t.code?t.code:Bn.MSG_SEND_FAIL,message:t&&t.message?t.message:void 0,data:{message:e}}))}},{key:"_getSendMessageSpecifiedKey",value:function(e){return e.conversationType===D.CONV_C2C?jn:e.conversationType===D.CONV_GROUP&&(e=this.get(7).getLocalGroupProfile(e.to))?Tt(e=e.type)?zn:Jn:void 0}},{key:"_addSendMessageTotalCount",value:function(e){(e=this._getSendMessageSpecifiedKey(e))&&this.get(26).addTotalCount(e)}},{key:"_addSendMessageSuccessCount",value:function(e,t){var n;(e=this._getSendMessageSpecifiedKey(e))&&((n=this.get(26)).addSuccessCount(e),n.addCost(e,Jt(t,!1)))}},{key:"_addSendMessageFailCountOnUser",value:function(e,t){t=void 0===(t=t.code)?-1:t;var n=this.get(26);e=this._getSendMessageSpecifiedKey(e),ws(t)&&e&&n.addFailedCountOfUserSide(e)}}]),$s),Js=(r(Zs,bn),qs=g(Zs),s(Zs,[{key:"registerPlugin",value:function(e){var t=this,n="0";Object.keys(e).forEach((function(o){t.plugins[o]=e[o],"tim-upload-plugin"===o&&"function"==typeof e[o].getVersion&&(n=e[o].getVersion())})),new so("registerPlugin").setMessage("".concat(Object.keys(e))).setMoreMessage("version:".concat(n)).end()}},{key:"getPlugin",value:function(e){return this.plugins[e]}},{key:"reset",value:function(){}}]),Zs),zs=(r(Qs,bn),Fs=g(Qs),s(Qs,[{key:"_init",value:function(){this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}},{key:"_startSync",value:function(e){var n=this,o=e.cookie,i=e.syncFlag,s=e.isOnlineSync,a="".concat(this._n,"._startSync"),r=(Ne.l("".concat(a," options:"),e),new so("syncUnread"));r.setMessage(JSON.stringify(e)),this.req({P:Kn.SYNC_UNREAD_MSG,data:{cookie:o,syncFlag:i,isOnlineSync:s}}).then((function(e){var o=(i=e.data).cookie,i=i.syncFlag,s="$cookie:".concat(o," syncFlag:").concat(i);Ne.l("".concat(a," ok. ").concat(s)),n._cookie=o,r.setMoreMessage(s).end(),He(o)||(0===i||1===i?(n._dispatch(t(t({},e.data),{},{isSyncingEnded:!1})),n._startSync({cookie:o,syncFlag:i,isOnlineSync:0})):2===i&&n._dispatch(t(t({},e.data),{},{isSyncingEnded:!0})))})).catch((function(e){r.setError(e).end(),Ne.e("".concat(a," failed. error:"),e)}))}},{key:"_dispatch",value:function(e){e.eventArray&&this.get(20).onMessage({head:{},body:{eventArray:e.eventArray,isInstantMessage:this._onlineSyncFlag,isSyncingEnded:e.isSyncingEnded}}),this.get(6).onNewMessage({dataList:e.messageList,isInstantMessage:!!e.isSyncingEnded&&this._onlineSyncFlag,C2CRemainingUnreadList:e.C2CRemainingUnreadList,C2CPairUnreadList:e.C2CPairUnreadList,isSyncingEnded:e.isSyncingEnded})}},{key:"syncOnNeed",value:function(){Ne.l("".concat(this._n,".syncOnNeed cookie:").concat(this._cookie)),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:1})}},{key:"syncOnReconnected",value:function(){Ne.l("".concat(this._n,".syncOnReconnected cookie:").concat(this._cookie)),this._onlineSyncFlag=!0,this._startSync({cookie:this._cookie,syncFlag:0,isOnlineSync:0})}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._onlineSyncFlag=!1,this._cookie=""}}]),Qs),Xs={req:{toAccount:"To_Account",fromAccount:"From_Account",to:"To_Account",from:"From_Account",groupID:"GroupId",groupAtUserID:"GroupAt_Account",extension:"Ext",data:"Data",description:"Desc",elements:"MsgBody",sizeType:"Type",downloadFlag:"Download_Flag",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",videoUrl:"",imageUrl:"URL",fileUrl:"Url",uuid:"UUID",priority:"MsgPriority",receiverUserID:"To_Account",receiverGroupID:"GroupId",messageSender:"SenderId",messageReceiver:"ReceiverId",nick:"From_AccountNick",avatar:"From_AccountHeadurl",messageNumber:"MsgNum",pbDownloadKey:"PbMsgKey",downloadKey:"JsonMsgKey",applicationType:"PendencyType",userIDList:"To_Account",groupNameList:"GroupName",userID:"To_Account",groupAttributeList:"GroupAttr",mainSequence:"AttrMainSeq",avChatRoomKey:"BytesKey",attributeControl:"AttrControl",sequence:"seq",messageControlInfo:"SendMsgControl",updateSequence:"UpdateSeq",clientTime:"MsgClientTime",sequenceList:"MsgSeqList",topicID:"TopicId",customData:"CustomString",isSupportTopic:"SupportTopic",isWebUniapp:"is_web_uniapp",isSupportExtension:"SupportMessageExtension",messageSequence:"MsgSeq",messageKey:"MsgKey",startSequence:"startSeq",simplifiedMessage:"DownsizeFlag",isRelayMessage:"IsRelayMsg",reactionID:"Reaction",messageSequenceList:"MsgSeqList",messageKeyList:"MsgKeyList",cmConfigID:"CustomModerationConfigID"},res:{MsgPriority:"priority",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",Download_Flag:"downloadFlag",GroupId:"groupID",Member_Account:"userID",MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",MsgSeq:"sequence",MsgRandom:"random",MsgTime:"time",MsgTimeStamp:"time",MsgContent:"content",MsgBody:"elements",From_AccountNick:"nick",From_AccountHeadurl:"avatar",GroupWithdrawInfoArray:"revokedInfos",GroupReadInfoArray:"groupMessageReadNotice",LastReadMsgSeq:"lastMessageSeq",WithdrawC2cMsgNotify:"c2cMessageRevokedNotify",C2cWithdrawInfoArray:"revokedInfos",C2cReadedReceipt:"c2cMessageReadReceipt",ReadC2cMsgNotify:"c2cMessageReadNotice",LastReadTime:"peerReadTime",MsgRand:"random",MsgType:"type",MsgShow:"messageShow",NextMsgSeq:"nextMessageSeq",FaceUrl:"avatar",ProfileDataMod:"profileModify",Profile_Account:"userID",ValueBytes:"value",ValueNum:"value",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgFrom_AccountExtraInfo:"messageFromAccountExtraInformation",Operator_Account:"operatorID",OpType:"operationType",ReportType:"operationType",UserId:"userID",User_Account:"userID",List_Account:"userIDList",MsgOperatorMemberExtraInfo:"operatorInfo",MsgMemberExtraInfo:"memberInfoList",ImageUrl:"avatar",NickName:"nick",MsgGroupNewInfo:"newGroupProfile",MsgAppDefinedData:"groupCustomField",Owner_Account:"ownerID",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupNotification:"notification",GroupApplyJoinOption:"joinOption",MsgKey:"messageKey",GroupInfo:"groupProfile",ShutupTime:"muteTime",Desc:"description",Ext:"extension",GroupAt_Account:"groupAtUserID",MsgNum:"messageNumber",PbMsgKey:"pbDownloadKey",JsonMsgKey:"downloadKey",MsgModifiedFlag:"isModified",PendencyItem:"applicationItem",PendencyType:"applicationType",AddTime:"time",AddSource:"source",AddWording:"wording",ProfileImImage:"avatar",PendencyAdd:"friendApplicationAdded",FrienPencydDel_Account:"friendApplicationDeletedUserIDList",Peer_Account:"userID",GroupAttr:"groupAttributeList",GroupAttrAry:"groupAttributeList",AttrMainSeq:"mainSequence",seq:"sequence",GroupAttrOption:"groupAttributeOption",BytesChangedKeys:"changedKeyList",GroupAttrInfo:"groupAttributeList",GroupAttrSeq:"mainSequence",PushChangedAttrValFlag:"isWithChangedAttributeInfo",SubKeySeq:"sequence",Val:"value",MsgGroupFromCardName:"senderNameCard",MsgGroupFromNickName:"senderNick",C2cNick:"peerNick",C2cImage:"peerAvatar",SendMsgControl:"messageControlInfo",NoLastMsg:"excludedFromLastMessage",NoUnread:"excludedFromUnreadCount",UpdateSeq:"updateSequence",MuteNotifications:"muteFlag",MsgClientTime:"clientTime",TinyId:"tinyID",GroupMsgReceiptList:"readReceiptList",ReadNum:"readCount",UnreadNum:"unreadCount",TopicId:"topicID",MillionGroupFlag:"communityType",SupportTopic:"isSupportTopic",MsgTopicNewInfo:"newTopicInfo",ShutupAll:"muteAllMembers",CustomString:"customData",TopicFaceUrl:"avatar",TopicIntroduction:"introduction",TopicNotification:"notification",TopicIdArray:"topicIDList",MsgVersion:"messageVersion",C2cMsgModNotifys:"c2cMessageModified",GroupMsgModNotifys:"groupMessageModified",ApplyJoinOption:"joinOption",MsgFlag:"messageRemindType",AtInfoList:"groupAtInfoList",AtFlagList:"groupAtType",AtMsgSeq:"sequence",BanDuration:"duration",BanDescription:"reason",NotVisible:"invisible",BytesTag:"tag",BytesValue:"value",RptBytesValue:"value",LatestSeq:"globalSequence",ClearSeq:"clearSequence",SupportMessageExtension:"isSupportExtension",ExtensionList:"extensions",GroupCounter:"counterList",Revoker_Account:"revoker",MsgExtensionNotify:"messageExtensionNotify",ExtensionC2cMsgInfo:"messageInfo",ExtensionGroupMsgInfo:"messageInfo",MsgOptType:"operateType",SetKVInfo:"operateResultList",DeleteKVInfo:"operateResultList",ClearKVInfo:"operateResultList",MsgKeyValue:"extensions",ClearMsgSeq:"clearSequence",MsgLastSeq:"globalSequence",InviteJoinOption:"inviteOption",MemberList_Account:"inviteeList",MsgMemberExtraInfoList:"inviteeInfoList",E:"event",GInf:"groupProfile",MCT:"clientTime",MR:"random",MP:"priority",MTS:"time",GId:"groupID",MS:"sequence",CCD:"cloudCustomData",F_Account:"from",F_Hd:"avatar",F_NN:"nick",GN:"groupName",GT:"groupType",IsSys:"isSystemMessage",OpInf:"operatorInfo",Img:"avatar",NN:"nick",OnlineInf:"onlineMemberInfo",ET:"expireTime",Num:"onlineMemberNum",Opt:"operationType",O_Account:"operatorID",RT:"operationType",UDF:"userDefinedField",L_Account:"userIDList",IsPlaceMsg:"isPlaceMessage",MsgCheckResult:"checkResult",Results:"resultList",Reaction:"reactionID",Reaction_Account:"userIDList",MsgReactionNotifyList:"messageReactionNotifyList",MsgReactionNotify:"messageReactionNotify",MsgReactionSummary:"reactionList",C2CMsgInfo:"C2CMessageInfo",GroupMsgInfo:"groupMessageInfo",int32_err_code:"errorCode",str_err_msg:"errorMsg",MsgDropReason:"messageDropReason",ReactedByMe:"reactedByMyself",Level:"messageRemindType",PeerReadTime:"timestamp",NoUnreadSeqList:"excludedUnreadSequenceList",NewMsg:"topicLatestMessage"},ignoreKeyWord:["C2C","ID","USP"]};function Qs(e){return o(this,Qs),(e=Fs.call(this,e))._n="SyncUnreadMsgModule",e._cookie="",e._onlineSyncFlag=!1,e.getIEmitInst().on(jo.A2KEY_AND_TINYID_UPDATED,e._init,h(e)),e}function Zs(e){return o(this,Zs),(e=qs.call(this,e))._n="PluginModule",e.plugins={},e}function $s(e){return o(this,$s),(e=xs.call(this,e))._n="ComboMsgModule",e}function ea(e){return o(this,ea),(e=Vs.call(this,e))._n="MsgReactionModule",e._reactedByMyselfMap=new Map,e._reactionInfoMap=new Map,e}function ta(e){return o(this,ta),(e=Bs.call(this,e))._n="MsgExtModule",e.msgExtMap=new Map,e.globalSeqMap=new Map,e.getMsgExtsMap=new Map,e}function na(e){return o(this,na),(e=Hs.call(this,e))._n="MessageModule",e._messageOptionsMap=new Map,e._mergerMessageHandler=new Ns(h(e)),e}function oa(e,t){if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");return t=Object.assign({pascalCase:!1},t),0===(e=Array.isArray(e)?e.map((function(e){return e.trim()})).filter((function(e){return e.length})).join("-"):e.trim()).length?"":1===e.length?t.pascalCase?e.toUpperCase():e.toLowerCase():(e=e=(e=e!==e.toLowerCase()?ia(e):e).replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,(function(e,t){return t.toUpperCase()})).replace(/\d+(\w|$)/g,(function(e){return e.toUpperCase()})),t.pascalCase?e.charAt(0).toUpperCase()+e.slice(1):e)}var ia=function(e){for(var t=!1,n=!1,o=!1,i=0;i<e.length;i++){var s=e[i];t&&/[a-zA-Z]/.test(s)&&s.toUpperCase()===s?(e=e.slice(0,i)+"-"+e.slice(i),o=n,n=!(t=!1),i++):n&&o&&/[a-zA-Z]/.test(s)&&s.toLowerCase()===s?(e=e.slice(0,i-1)+"-"+e.slice(i-1),o=n,t=!(n=!1)):(t=s.toLowerCase()===s&&s.toUpperCase()!==s,o=n,n=s.toUpperCase()===s&&s.toLowerCase()!==s)}return e};function sa(e,t){var n=0;return function e(t,o){return 100<++n?(n--,t):Xe(t)?(i=t.map((function(t){return Je(t)?e(t,o):t})),n--,i):Je(t)?(s=t,a=function(e,t){if(!et(t))return!1;if(t!==oa(t))for(var n=0;n<Xs.ignoreKeyWord.length&&!t.includes(Xs.ignoreKeyWord[n]);n++);var i;return pt(o[t])?(i=t)[0].toUpperCase()+oa(i).slice(1):o[t]},r=Object.create(null),Object.keys(s).forEach((function(e){var t=a(s[e],e);t&&(r[t]=s[e])})),i=At(i=r,(function(t,n){return Xe(t)||Je(t)?e(t,o):t})),n--,i):void 0;var i,s,a,r}(e,t)}for(var aa,ra=String.fromCharCode,ca=function(e){var t=0|e.charCodeAt(0);if(55296<=t)if(t<56320)if(56320<=(e=0|e.charCodeAt(1))&&e<=57343){if(65535<(t=(t<<10)+e-56613888|0))return ra(240|t>>>18,128|t>>>12&63,128|t>>>6&63,128|63&t)}else t=65533;else t<=57343&&(t=65533);return t<=2047?ra(192|t>>>6,128|63&t):ra(224|t>>>12,128|t>>>6&63,128|63&t)},ua=function(e){for(var t=void 0===e?"":(""+e).replace(/[\x80-\uD7ff\uDC00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]?/g,ca),n=0|t.length,o=new Uint8Array(n),i=0;i<n;i=i+1|0)o[i]=0|t.charCodeAt(i);return o},la=(s(Pa,[{key:"getID",value:function(){return this._id}},{key:"_onOpen",value:function(e){this._handler.onOpen({id:this._id,res:JSON.stringify(e)})}},{key:"_onClose",value:function(e){this._handler.onClose({id:this._id,e:e})}},{key:"_onMessage",value:function(e){e=this._canIUseBinaryFrame?this._isAppCompressedData(e.data)?this._handler.inflate(e.data):function(e){for(var t=new Uint8Array(e),n="",o=0,i=t.length;o<i;){var s=t[o],a=0,r=0;if(s<=127?(a=0,r=255&s):s<=223?(a=1,r=31&s):s<=239?(a=2,r=15&s):s<=244&&(a=3,r=7&s),0<i-o-a)for(var c=0;c<a;)r=r<<6|63&(s=t[o+c+1]),c+=1;else r=65533,a=i-o;n+=String.fromCodePoint(r),o+=a+1}return n}(e.data):e.data,this._handler.onMessage({data:e})}},{key:"_isAppCompressedData",value:function(e){return 67===(e=new Uint8Array(e))[0]&&79===e[1]&&77===e[2]&&80===e[3]}},{key:"_onError",value:function(e){this._handler.onError({id:this._id,e:e})}},{key:"setIsWorkerEnabled",value:function(e){this._isWorkerEnabled=!0}},{key:"close",value:function(e){if(this._workerSocket&&(this._workerSocket.postMessage({cmd:"stop",code:e}),this._workerSocket.terminate(),this._workerSocket=null),j)return ne.offSocketClose(),ne.offSocketMessage(),ne.offSocketOpen(),ne.offSocketError(),void ne.closeSocket();this._socket&&(Z?(this._socket.onClose((function(){})),this._socket.onOpen((function(){})),this._socket.onMessage((function(){})),this._socket.onError((function(){}))):(this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null),Y?this._socket.close({code:e}):this._socket.close(e),this._socket=null)}},{key:"send",value:function(e){this._workerSocket?this._workerSocket.postMessage({cmd:"sendMessage",data:this._canIUseBinaryFrame?ua(e.data).buffer:e.data}):j?ne.sendSocketMessage({data:e.data,fail:function(){e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket&&(Z?this._socket.send({data:this._canIUseBinaryFrame?ua(e.data).buffer:e.data,fail:function(){e.fail&&e.requestID&&e.fail(e.requestID)}}):this._socket.send(this._canIUseBinaryFrame?ua(e.data):e.data))}}]),Pa),da=["keyMap"],pa=["keyMap"],_a="connected",ha="connecting",ga="disconnected",fa=(s(Na,[{key:"_setWebsocketHost",value:function(){var e=this._chM.get(12);this._currentSite=P,this._chM.isOversea()&&(this._currentSite="OVERSEA"),e.isSingaporeSite()?this._currentSite="SINGAPORE":e.isKoreaSite()?this._currentSite="KOREA":e.isGermanySite()?this._currentSite="GERMANY":e.isIndiaSite()?this._currentSite="IND":e.isJapanSite()?this._currentSite="JPN":e.isUSASite()?this._currentSite="USA":e.isIndonesiaSite()&&(this._currentSite="INDONESIA"),G.HOST.setCurrent(this._currentSite)}},{key:"_initConnection",value:function(){var e=this._chM.get(12).getSDKAppID()+"",t=this._chM.get(12).isIndependentDomainDisabled();He(e=(pt(G.HOST.CURRENT.BACKUP)?this._url=G.HOST.CURRENT.DEFAULT:""===this._url?this._url=t?G.HOST.CURRENT.DEFAULT:G.HOST.CURRENT.DEFAULT0.replace("*",e):-1<this._url.indexOf(e)?this._url=G.HOST.CURRENT.DEFAULT:this._url===G.HOST.CURRENT.DEFAULT?this._url=G.HOST.CURRENT.IPV6||G.HOST.CURRENT.BACKUP:this._url===G.HOST.CURRENT.IPV6?this._url=G.HOST.CURRENT.BACKUP:this._url===G.HOST.CURRENT.BACKUP?this._url=this._canIUseAnyCast()?G.HOST.CURRENT.ANYCAST:G.HOST.CURRENT.DEFAULT:this._url===G.HOST.CURRENT.ANYCAST&&(G.HOST.CURRENT.ANYCAST="",this._url=G.HOST.CURRENT.DEFAULT),t=this._chM.get(12)).getProxyServer())||(this._url=e),t.isTestEnv()&&(this._url=A.TEST[this._currentSite].DEFAULT),this._connect(),this._nextPingTs=0}},{key:"_canIUseAnyCast",value:function(){return te&&G.HOST.CURRENT.ANYCAST}},{key:"onCheckTimer",value:function(e){e%1==0&&(this._checkPromiseMap(),this._checkNativeAppWS())}},{key:"_checkPromiseMap",value:function(){var e=this;0!==this._promiseMap.size&&this._promiseMap.forEach((function(t,n){var o=t.reject,i=t.timestamp,s=(t=t.headSeq,15e3);-1!==n.indexOf(Kn.LOGIN)?s=9e4:-1!==n.indexOf(Kn.PING)&&(s=3e3),Date.now()-i>=s&&(Ne.l("".concat(e._n,"._checkPromiseMap request timeout, delete requestID:").concat(n)),e._promiseMap.delete(n),o(new Vn({code:Bn.NETWORK_TIMEOUT,data:{headSeq:t}})),e._chM.onRequestTimeout())}))}},{key:"_checkNativeAppWS",value:function(){z&&!this.isConnected()&&this._reConnect()}},{key:"onOpen",value:function(e){var t,n;this._readyState!==ga&&(this._onOpenTs=Date.now(),n=e.id,e=e.res,this._socketID=n,t=Jt(this._startTs,!1),n="socketID:".concat(n," res:").concat(e),Ne.l("".concat(this._n,"._onOpen cost:").concat(t," ms. ").concat(n)),new so("wsOnOpen").setMessage(t).setCostTime(t).setMoreMessage(n).end(),this._readyState=_a,this._reConnectCount=0,this._resend(),!0===this._reConnectFlag&&(this._chM.onReconnected(),this._reConnectFlag=!1),this._chM.onOpen())}},{key:"onClose",value:function(e){var t=new so("wsOnClose"),n=e.id,o=(e=e.e,"sourceSocketID:".concat(n," currentSocketID:").concat(this._socketID," code:").concat(e.code," reason:").concat(e.reason)),i=0;0!==this._onOpenTs&&(i=Date.now()-this._onOpenTs),t.setMessage(i).setCostTime(i).setMoreMessage(o).setCode(e.code).end(!0),Ne.l("".concat(this._n,"._onClose ").concat(o," onlineTime:").concat(i)),n===this._socketID&&(this._readyState=ga,i<1e3?this._chM.onReconnectFailed():this._chM.onClose())}},{key:"onError",value:function(e){var t=e.id,n=(e=e.e,"sourceSocketID:".concat(t," currentSocketID:").concat(this._socketID));new so("wsOnError").setMessage(e.errMsg||JSON.stringify(e,["message","code"])).setMoreMessage(n).setLevel("error").end(!0),Ne.w("".concat(this._n,"._onError"),e,n),t===this._socketID&&(this._readyState=ga,this._chM.onError())}},{key:"onMessage",value:function(e){var t;try{t=JSON.parse(e.data)}catch(t){new so("jsonParseError").setMessage(e.data).end()}if(t&&t.head){e=this._getRequestIDFromHead(t.head);var n,o,i,s,a=t.body;if(this._chM.get(30).isTRTCCommand(e)||(s=bt(t.head),a=function e(t,n){return Xe(t)?t.map((function(t){return Je(t)?e(t,n):t})):Je(t)?(o=t,i=function(e,t){return pt(n[t])?oa(t):n[t]},s={},Object.keys(o).forEach((function(e){s[i(o[e],e)]=o[e]})),At(s,(function(t){return Xe(t)||Je(t)?e(t,n):t}))):void 0;var o,i,s}(t.body,this._getResKeyMap(s))),Ne.d("".concat(this._n,".onMessage ret:").concat(JSON.stringify(a)," requestID:").concat(e," has:").concat(this._promiseMap.has(e))),this._setNextPingTs(),this._promiseMap.has(e))return n=(s=this._promiseMap.get(e)).resolve,o=s.reject,i=s.timestamp,s=s.headSeq,this._promiseMap.delete(e),this._calcRTT(i),void(a.errorCode&&0!==a.errorCode?(this._chM.onErrorCodeNotZero(a),o(new Vn({code:a.errorCode,message:a.errorInfo||"",data:e.includes(Kn.MODIFY_C2C_MSG)||e.includes(Kn.MODIFY_GRP_MSG)?{elements:a.elements,messageVersion:a.messageVersion,cloudCustomData:a.cloudCustomData,headSeq:s}:{headSeq:s}}))):n(En(a)));this._chM.onMessage({head:t.head,body:a})}}},{key:"_calcRTT",value:function(e){e=Date.now()-e,this._chM.get(26).addRTT(e)}},{key:"_connect",value:function(){this._readyState!==ha&&this._readyState!==_a&&(this._startTs=Date.now(),this._onOpenTs=0,this._readyState=ha,this._socket=new la(this),this._socketID=this._socket.getID(),Ne.l("".concat(this._n,"._connect isWorkerEnabled:").concat(this.getIsWorkerEnabled()," socketID:").concat(this._socketID," url:").concat(this.getURL())),new so("wsConnect").setMessage("socketID:".concat(this._socketID," url:").concat(this.getURL())).end())}},{key:"getURL",value:function(){this._chM.isDevMode()&&(this._canIUseBinaryFrame=!1);var e=Nt(),t=((j||B&&"windows"===e||z)&&(this._canIUseBinaryFrame=!1),-1),n=("ios"===e?t=ae||-1:"android"===e&&(t=ce||-1),this._chM.get(12)),o=this._chM.getPlatform(),i=n.getSDKAppID();return n=n.getInstanceID(),i="sdkappid=".concat(i,"&instanceid=").concat(n,"&random=").concat(this._getRandom(),"&platform=").concat(o,"&host=").concat(e)+"&version=".concat(t,"&sdkversion=").concat("3.5.2"),H&&(i+="&isminigame=1"),this._chM.canIUseInflate()&&(i+="&compress=gzip"),(this._canIUseBinaryFrame?"".concat(this._url,"/binfo?"):"".concat(this._url,"/info?")).concat(i)}},{key:"_closeConnection",value:function(e){Ne.l("".concat(this._n,"._closeConnection socketID:").concat(this._socketID)),this._socket&&(this._socket.close(e),this._socketID=-1,this._socket=null,this._readyState=ga)}},{key:"_resend",value:function(){var e=this;if(Ne.l("".concat(this._n,"._resend reConnectFlag:").concat(this._reConnectFlag),"promiseMap.size:".concat(this._promiseMap.size," simpleRequestMap.size:").concat(this._simpleRequestMap.size)),0<this._promiseMap.size&&this._promiseMap.forEach((function(t,n){var o=t.uplinkData,i=t.resolve;t=t.reject,-1!==n.indexOf(Kn.AV_POLLING)?e._promiseMap.delete(n):(e._promiseMap.set(n,{resolve:i,reject:t,timestamp:Date.now(),uplinkData:o}),e._execute(n,o))})),0<this._simpleRequestMap.size){var t,n=T(this._simpleRequestMap);try{for(n.s();!(t=n.n()).done;){var o=f(t.value,2),i=o[0],s=o[1];this._execute(i,s)}}catch(t){n.e(t)}finally{n.f()}this._simpleRequestMap.clear()}}},{key:"send",value:function(e){var t=this,n=(e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3),e.head.cs=this._calcCheckSum(e.head.servcmd,e.body),e.keyMap,_(e,da)),o=this._getRequestIDFromHead(e.head),i=JSON.stringify(n);return new Promise((function(s,a){t._promiseMap.set(o,{resolve:s,reject:a,timestamp:Date.now(),uplinkData:i,headSeq:e.head.seq}),Ne.d("".concat(t._n,".send uplinkData:").concat(JSON.stringify(n)," requestID:").concat(o," readyState:").concat(t._readyState)),t._readyState!==_a?t._reConnect():(t._execute(o,i),t._chM.get(26).addRequestCount())}))}},{key:"simplySend",value:function(e){e.head.seq=this._getSequence(),e.head.reqtime=Math.floor(Date.now()/1e3),e.keyMap;var t=_(e,pa);e=this._getRequestIDFromHead(e.head),t=JSON.stringify(t),this._readyState!==_a?(this._simpleRequestMap.size<this.MAX_SIZE?this._simpleRequestMap.set(e,t):Ne.l("".concat(this._n,".simplySend. simpleRequestMap is full, drop request!")),this._reConnect()):this._execute(e,t)}},{key:"_execute",value:function(e,t){this._socket.send({data:t,fail:Z?this._onSendFail.bind(this):void 0,requestID:e})}},{key:"_onSendFail",value:function(e){Ne.l("".concat(this._n,"._onSendFail requestID:").concat(e)),this._chM.onSendFail()}},{key:"_getSequence",value:function(){var e;if(this._startSequence<2415919103)return e=this._startSequence,this._startSequence+=1,2415919103===this._startSequence&&(this._startSequence=st()),e}},{key:"_getRequestIDFromHead",value:function(e){return e.servcmd+e.seq}},{key:"_getResKeyMap",value:function(e){return e=this._chM.getKeyMap(e),t(t({},Xs.res),e.res)}},{key:"_reConnect",value:function(){this._readyState!==_a&&this._readyState!==ha&&this.forcedReconnect()}},{key:"forcedReconnect",value:function(){var e="".concat(this._n,".forcedReconnect");Ne.l("".concat(e," count:").concat(this._reConnectCount," readyState:").concat(this._readyState)),this._reConnectFlag=!0,this._resetRandom(),this._reConnectCount<this.MAX_RECONNECT_COUNT?(this._reConnectCount+=1,this._closeConnection(4001),this._initConnection()):(this._reConnectCount=0,this._chM.get(15).isOnline()?(Ne.w("".concat(e," disconnected from wsserver but network is ok, continue...")),this._closeConnection(4001),this._initConnection()):this._chM.onReconnectFailed())}},{key:"getReconnectFlag",value:function(){return this._reConnectFlag}},{key:"_setNextPingTs",value:function(){this._nextPingTs=z?Date.now()+5e3:Date.now()+1e4}},{key:"getNextPingTs",value:function(){return this._nextPingTs}},{key:"isConnected",value:function(){return this._readyState===_a}},{key:"canIUseBinaryFrame",value:function(){return this._canIUseBinaryFrame}},{key:"getSocketID",value:function(){return this._socketID}},{key:"inflate",value:function(e){if(this._chM.canIUseInflate())return this._chM.get(37).inflate(e)}},{key:"setIsWorkerEnabled",value:function(e){Ne.l("".concat(this._n,".setIsWorkerEnabled flag:").concat(e)),this._isWorkerEnabled=e}},{key:"getIsWorkerEnabled",value:function(){return this._isWorkerEnabled&&ge}},{key:"_getRandom",value:function(){return 0===this._random&&(this._random=Math.random()),this._random}},{key:"_resetRandom",value:function(){this._random=0}},{key:"_calcCheckSum",value:function(e,t){if(-1!==e.indexOf(Kn.PING)||-1!==e.indexOf(Kn.LOGIN)||-1!==e.indexOf(Kn.LOGOUT)||-1!==e.indexOf(Kn.AV_POLLING)||-1!==e.indexOf(Kn.AV_NOAUTH_POLLING))return 0;for(var n=ua(JSON.stringify(t)),o=4294967295,i=0,s=n.length;i<s;i++){o^=n[i];for(var a=0;a<8;a++)1&~o?o>>>=1:o=o>>>1^3988292384}return(4294967295^o)>>>0}},{key:"close",value:function(){Ne.l("".concat(this._n,".close")),this._closeConnection(4e3),this._promiseMap.clear(),this._startSequence=st(),this._readyState=ga,this._simpleRequestMap.clear(),this._reConnectFlag=!1,this._reConnectCount=0,this._onOpenTs=0,this._url="",this._random=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0}}]),Na),ma=function(e,t,n){return new Promise((function(o,i){var s,a,r="application/x-www-form-urlencoded;charset=UTF-8";Z?ne.request({url:t,data:n,method:e,timeout:3e3,header:{"content-type":r},success:function(e){e&&e.data&&e.data.NetCheckInfo&&Ne.l("".concat("getconninfo ok in"," miniapp. ret:"),e.data),o()},fail:function(){i(new Vn({code:Bn.NETWORK_ERROR}))}}):(s=new XMLHttpRequest,a=setTimeout((function(){s.abort(),i(new Vn({code:Bn.NETWORK_TIMEOUT}))}),3e3),s.onreadystatechange=function(){4===s.readyState&&(a&&clearTimeout(a),200===s.status||304===s.status?(s.responseText&&-1<s.responseText.indexOf("NetCheckInfo")&&Ne.l("".concat("getconninfo ok in"," web. ret:"),JSON.parse(s.responseText)),o()):i(new Vn({code:Bn.NETWORK_ERROR})))},s.open(e,t,!0),s.setRequestHeader("Content-type",r),n?s.send(n):s.send())}))},va=(r(Oa,bn),aa=g(Oa),s(Oa,[{key:"onCheckTimer",value:function(e){this._socketHandler&&(this.isLoggedIn()?(0<this._timerForNotLoggedIn&&(clearInterval(this._timerForNotLoggedIn),this._timerForNotLoggedIn=-1),this._socketHandler.onCheckTimer(e)):this._socketHandler.onCheckTimer(1),this._checkNextPing())}},{key:"onErrorCodeNotZero",value:function(e){this.get(20).onErrorCodeNotZero(e)}},{key:"onMessage",value:function(e){this.get(20).onMessage(e)}},{key:"send",value:function(e){return this._socketHandler?this._previousState!==D.NET_STATE_CONNECTED&&e.head.servcmd.includes(Kn.SSO_STAT)?(this.reConnect(),this.isPrivateNetWork()?Promise.resolve():this._sendLogViaHTTP(e)):this._socketHandler.send(e):Promise.reject()}},{key:"_sendLogViaHTTP",value:function(e){var t=G.HOST.CURRENT.STAT;return t="".concat(t,"/v4/imopenstat/tim_web_report_v2?sdkappid=").concat(e.head.sdkappid,"&reqtime=").concat(Date.now()),e=JSON.stringify(e.body),ma("POST",t,e)}},{key:"simplySend",value:function(e){return this._socketHandler?this._socketHandler.simplySend(e):Promise.reject()}},{key:"onOpen",value:function(){this._ping()}},{key:"onClose",value:function(){this._socketHandler&&this._socketHandler.getReconnectFlag()&&this._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED),this.reConnect()}},{key:"onError",value:function(){Z&&!z&&this.warn("DomainNameInMP"),this._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED)}},{key:"getKeyMap",value:function(e){return this.get(20).getKeyMap(e)}},{key:"onRequestTimeout",value:function(){3e4<=Date.now()-this._lastDiagnoseTS&&this.diagnose()}},{key:"onSendFail",value:function(){this._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED)}},{key:"onReconnected",value:function(){Ne.l("".concat(this._n,".onReconnected cost:").concat(Jt(this._disconnectedTS,!0,!0))),this._m.restartTimer(),this.get(20).onReconnected(Jt(this._disconnectedTS,!1,!1)),this._disconnectedTS=0,this._emitNetStateChangeEvent(D.NET_STATE_CONNECTED)}},{key:"onReconnectFailed",value:function(){Ne.l("".concat(this._n,".onReconnectFailed")),this._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED)}},{key:"setIsWorkerEnabled",value:function(e){this._socketHandler&&this._socketHandler.setIsWorkerEnabled(!1)}},{key:"offline",value:function(){this._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED)}},{key:"reConnect",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=!1,n=(this._socketHandler&&(t=this._socketHandler.getReconnectFlag()),"forcedFlag:".concat(e," fatalErrorFlag:").concat(this._fatalErrorFlag," previousState:").concat(this._previousState," reconnectFlag:").concat(t));if(Ne.l("".concat(this._n,".reConnect ").concat(n)),!this._fatalErrorFlag&&this._socketHandler){if(!0===e)this._socketHandler.forcedReconnect();else{if(this._previousState===D.NET_STATE_CONNECTING&&t)return;this._socketHandler.forcedReconnect()}this._emitNetStateChangeEvent(D.NET_STATE_CONNECTING)}}},{key:"_emitNetStateChangeEvent",value:function(e){this._previousState!==e&&(Ne.l("".concat(this._n,"._emitNetStateChangeEvent from ").concat(this._previousState," to ").concat(e)),e===D.NET_STATE_DISCONNECTED&&0===this._disconnectedTS&&(this._disconnectedTS=Date.now(),this.diagnose()),this._previousState=e,this.emitOEvt(E.NET_STATE_CHANGE,{state:e}))}},{key:"_ping",value:function(){var e,t=this;!0!==this._probing&&(this._probing=!0,e=this.get(20).getProtocolData({P:Kn.PING}),this.send(e).then((function(){t._probing=!1})).catch((function(e){t._probing=!1;var n=t.get(15).isOnline();if(Ne.w("".concat(t._n,"._ping failed. bOnline:").concat(n," error:"),e),e&&60002===e.code)return new so("error").setMessage("code:".concat(e.code," message:").concat(e.message)).end(),t._fatalErrorFlag=!0,void t._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED);n?t.reConnect():t._emitNetStateChangeEvent(D.NET_STATE_DISCONNECTED)})))}},{key:"_checkNextPing",value:function(){this._socketHandler&&this._socketHandler.isConnected()&&Date.now()>=this._socketHandler.getNextPingTs()&&this._ping()}},{key:"dealloc",value:function(){this._socketHandler&&(this._socketHandler.close(),this._socketHandler=null),-1<this._timerForNotLoggedIn&&clearInterval(this._timerForNotLoggedIn)}},{key:"onRestApiKickedOut",value:function(){this._socketHandler&&(this._socketHandler.close(),this.reConnect(!0))}},{key:"canIUseInflate",value:function(){return this._m.canIUseInflate()}},{key:"getSocketID",value:function(){if(this._socketHandler)return this._socketHandler.getSocketID()}},{key:"diagnose",value:function(){this.isPrivateNetWork()||(this._lastDiagnoseTS=Date.now(),this._diagnoseBySSO(),this._diagnoseByCDN())}},{key:"_diagnoseBySSO",value:function(){var e=this,t=this._socketHandler.getURL(),n=t.split("/")[2];n.startsWith("ws")&&(t=t.slice(t.indexOf("info?")+5),n="https://".concat(n,"/v3/netcheck/getconninfo?").concat(t,"&reqtime=").concat(Date.now()),ma("GET",n).catch((function(t){Ne.w("".concat(e._n,"._diagnoseBySSO failed. error:"),t)})))}},{key:"_diagnoseByCDN",value:function(){var e=this,t=(t=this._socketHandler.getURL()).slice(t.indexOf("info?")+5);t="https://boce-cdn.my-imcloud.com/v3/netcheck/getconninfo?".concat(t,"&reqtime=").concat(Date.now()),ma("GET",t).catch((function(t){Ne.w("".concat(e._n,"._diagnoseByCDN failed. error:"),t)}))}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._previousState=D.NET_STATE_CONNECTED,this._probing=!1,this._fatalErrorFlag=!1,this._timerForNotLoggedIn=setInterval(this.onCheckTimer.bind(this),1e3),this._disconnectedTS=0,this._lastDiagnoseTS=0}}]),Oa),Ia=["a2","tinyid"],ya=["a2","tinyid"],Ma=(s(ka,[{key:"_fillMap",value:function(){this._map.clear();var e=this._sessionM.genCommonHead(),n=this._sessionM.genCosSpecifiedHead(),o=this._sessionM.genSSOReportHead();this._map.set(Kn.LOGIN,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.LOGIN)}),body:{state:"Online",isWebUniapp:0,deviceBrand:0,customInfo:""},keyMap:{req:{deviceBrand:"InstType"},res:{InstId:"instanceID",HelloInterval:"helloInterval",RichMsgAuthKey:"authKey"}}}),this._map.set(Kn.LOGOUT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.LOGOUT)}),body:{type:0,isWebUniapp:0},keyMap:{req:{type:"wslogout_type"}}}),this._map.set(Kn.HELLO,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.HELLO)}),body:{isWebUniapp:0},keyMap:{res:{NewInstInfo:"newInstanceInfo"}}}),this._map.set(Kn.KICK_OTHER,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.STAT_SERVICE,".").concat(Kn.KICK_OTHER)}),body:{}}),this._map.set(Kn.COS_SIGN,{head:t(t({},n),{},{servcmd:"".concat(G.NAME.IM_COS_SIGN,".").concat(Kn.COS_SIGN)}),body:{cmd:"open_im_cos_svc",subCmd:"get_cos_token",duration:300,version:2},keyMap:{req:{userSig:"usersig",subCmd:"sub_cmd",cmd:"cmd",duration:"duration",version:"version"},res:{expired_time:"expiredTime",bucket_name:"bucketName",session_token:"sessionToken",tmp_secret_id:"secretId",tmp_secret_key:"secretKey"}}}),this._map.set(Kn.COS_PRE_SIG,{head:t(t({},n),{},{servcmd:"".concat(G.NAME.CUSTOM_UPLOAD,".").concat(Kn.COS_PRE_SIG)}),body:{fileType:void 0,fileName:void 0,uploadMethod:0,duration:900},keyMap:{req:{userSig:"usersig",fileType:"file_type",fileName:"file_name",uploadMethod:"upload_method"},res:{expired_time:"expiredTime",request_id:"requestId",head_url:"headUrl",upload_url:"uploadUrl",download_url:"downloadUrl",ci_url:"ciUrl",snapshot_url:"requestSnapshotUrl"}}}),this._map.set(Kn.SIMPLE_COS_PRE_SIG,{head:t(t({},n),{},{servcmd:"".concat(G.NAME.CUSTOM_UPLOAD,".").concat(Kn.SIMPLE_COS_PRE_SIG)}),body:{uploadMethod:0,platform:2,SDKAppID:0,userID:"",conversationType:1,uploadConfig:[{fileID:1,fileType:1,fileName:""}]},keyMap:{req:{platform:"uint32_platform",SDKAppID:"uint32_sdkappid",userID:"str_user_id",uploadMethod:"uint32_upload_method",conversationType:"uint32_scene",uploadConfig:"rpt_upload_object",fileID:"uint32_file_id",fileType:"uint32_file_type",fileName:"str_file_name"},res:{str_final_ip:"uploadIP",rpt_pre_sig:"preSig",uint32_file_id:"fileID",uint32_exist_flag:"existFlag",str_download_url:"downloadUrl",str_upload_url:"uploadUrl",str_snapshot_url:"requestSnapshotUrl",str_file_key:"fileKey"}}}),this._map.set(Kn.GET_IMAGE_INFO,{head:t(t({},n),{},{servcmd:"".concat(G.NAME.CUSTOM_UPLOAD,".").concat(Kn.GET_IMAGE_INFO)}),body:{imageUrl:""},keyMap:{req:{imageUrl:"str_image_url"},res:{rpt_msg_image_info:"imageInfoArray",uint32_image_type:"type",str_url:"url",uint32_width:"width",uint32_height:"height",str_image_format:"imageFormat"}}}),this._map.set(Kn.GET_IP,{head:t(t({},n),{},{servcmd:"".concat(G.NAME.CUSTOM_UPLOAD,".").concat(Kn.GET_IP)}),body:{domainName:""},keyMap:{req:{domainName:"str_domain"},res:{str_final_ip:"ip"}}}),this._map.set(Kn.VIDEO_COVER,{head:t(t({},n),{},{servcmd:"".concat(G.NAME.CUSTOM_UPLOAD,".").concat(Kn.VIDEO_COVER)}),body:{version:1,platform:void 0,coverName:void 0,requestSnapshotUrl:void 0},keyMap:{req:{version:"version",platform:"platform",coverName:"cover_name",requestSnapshotUrl:"snapshot_url"},res:{error_code:"errorCode",error_msg:"errorInfo",download_url:"snapshotUrl"}}}),this._map.set(Kn.FETCH_COMMERCIAL_CONFIG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_CONFIG_MANAGER,".").concat(Kn.FETCH_COMMERCIAL_CONFIG)}),body:{SDKAppID:0},keyMap:{req:{SDKAppID:"uint32_sdkappid"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(Kn.PUSHED_COMMERCIAL_CONFIG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_CONFIG_MANAGER,".").concat(Kn.PUSHED_COMMERCIAL_CONFIG)}),body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_purchase_bits:"purchaseBits",uint32_expired_time:"expiredTime"}}}),this._map.set(Kn.FETCH_CLOUD_CTRL_CONFIG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_CONFIG_MANAGER,".").concat(Kn.FETCH_CLOUD_CTRL_CONFIG)}),body:{SDKAppID:0,version:0},keyMap:{req:{SDKAppID:"uint32_sdkappid",version:"uint64_version"},res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(Kn.PUSHED_CLOUD_CTRL_CONFIG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_CONFIG_MANAGER,".").concat(Kn.PUSHED_CLOUD_CTRL_CONFIG)}),body:{},keyMap:{res:{int32_error_code:"errorCode",str_error_message:"errorMessage",str_json_config:"cloudControlConfig",uint32_expired_time:"expiredTime",uint32_sdkappid:"SDKAppID",uint64_version:"version"}}}),this._map.set(Kn.OVERLOAD_NOTIFY,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OVERLOAD_PUSH,".").concat(Kn.OVERLOAD_NOTIFY)}),body:{},keyMap:{res:{OverLoadServCmd:"overloadCommand",DelaySecs:"waitingTime"}}}),this._map.set(Kn.SYNC_UNREAD_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.SYNC_UNREAD_MSG)}),body:{cookie:"",syncFlag:0,needAbstract:1,isOnlineSync:0,needSignaling:1,needCachedMsg:1},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",from:"From_Account",to:"To_Account",time:"MsgTimeStamp",sequence:"MsgSeq",random:"MsgRandom",elements:"MsgBody"},res:{MsgList:"messageList",SyncFlag:"syncFlag",To_Account:"to",From_Account:"from",ClientSeq:"clientSequence",MsgSeq:"sequence",NoticeSeq:"noticeSequence",NotifySeq:"notifySequence",MsgRandom:"random",MsgTimeStamp:"time",MsgContent:"content",ToGroupId:"to",MsgKey:"messageKey",GroupTips:"groupTips",MsgBody:"elements",MsgType:"type",C2CRemainingUnreadCount:"C2CRemainingUnreadList",C2CPairUnreadCount:"C2CPairUnreadList"}}}),this._map.set(Kn.GET_PROFANITY_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_MSG_AUDIT_MGR,".").concat(Kn.GET_PROFANITY_LIST)}),body:{version:0,deviceID:"",startIndex:void 0},keyMap:{req:{version:"uint64_version",deviceID:"str_device_id",startIndex:"uint64_start_index"},res:{msg_cmd_error_code:"errorInfo",str_err_msg:"errorMessage",uint32_code:"errorCode",msg_scene_ctl_config:"filterConfig",uint64_c2c_custom_msg_flag:"c2c_custom_message",uint64_c2c_text_msg_flag:"c2c_text_message",uint64_group_custom_msg_flag:"group_custom_message",uint64_group_text_msg_flag:"group_text_message",uint64_group_info_flag:"group_profile",uint64_group_member_info_flag:"group_member_profile",uint64_relation_chain_flag:"sns",uint64_user_info_flag:"user_profile",rpt_msg_dirty_word:"lexicon",str_dirty_word:"profanity",str_replaced_content:"replacement",uint64_filter_type:"filterType",uint64_id:"id",uint64_word_type:"profanityType",uint64_complete_flag:"completeFlag",uint64_next_start_index:"nextStartIndex",uint64_version:"version",uint64_expired_time:"expiredTime"}}}),this._map.set(Kn.SEND_C2C_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.SEND_C2C_MSG)}),body:{fromAccount:"",toAccount:"",msgSeq:0,msgRandom:0,msgBody:[],cloudCustomData:void 0,nick:"",avatar:"",msgLifeTime:void 0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",OPPOCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:"",HonorImportance:""}},messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0,forbidCallbackControl:void 0},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",count:"MaxCnt",lastMessageTime:"LastMsgTime",messageKey:"MsgKey",peerAccount:"Peer_Account",data:"Data",description:"Desc",extension:"Ext",type:"MsgType",content:"MsgContent",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",nick:"From_AccountNick",avatar:"From_AccountHeadurl",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"IsNeedReadReceipt",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID",OPPOChannelID:"OPPOChannelID",OPPOCategory:"OPPOCategory",VIVOClassification:"VIVOClassification",VIVOCategory:"VIVOCategory",HonorImportance:"HonorImportance"}}}),this._map.set(Kn.SEND_GRP_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.SEND_GRP_MSG)}),body:{fromAccount:"",groupID:"",random:0,clientSequence:0,priority:"",msgBody:[],cloudCustomData:void 0,onlineOnlyFlag:0,offlinePushInfo:{pushFlag:0,title:"",desc:"",ext:"",apnsInfo:{sound:"",badgeMode:0,isVoipPush:void 0,image:""},androidInfo:{sound:"",XiaoMiChannelID:"",OPPOChannelID:"",GoogleChannelID:"",VIVOClassification:1,VIVOCategory:"",HuaWeiCategory:"",OPPOCategory:"",HuaWeiImage:"",HonorImage:"",GoogleImage:"",HonorImportance:""}},groupAtInfo:[],messageControlInfo:void 0,clientTime:void 0,needReadReceipt:0,topicID:void 0,receiverList:void 0,isSupportExtension:0,isRelayMessage:0,cmConfigID:void 0,forbidCallbackControl:void 0},keyMap:{req:{to:"GroupId",extension:"Ext",data:"Data",description:"Desc",random:"Random",sequence:"ReqMsgSeq",count:"ReqMsgNumber",type:"MsgType",priority:"MsgPriority",content:"MsgContent",elements:"MsgBody",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",clientSequence:"ClientSeq",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody",needReadReceipt:"NeedReadReceipt",receiverList:"To_Account",GoogleChannelID:"GoogleChannelID",XiaoMiChannelID:"XiaoMiChannelID",OPPOChannelID:"OPPOChannelID",OPPOCategory:"OPPOCategory",VIVOClassification:"VIVOClassification",VIVOCategory:"VIVOCategory",HonorImportance:"HonorImportance"},res:{MsgTime:"time",MsgSeq:"sequence"}}}),this._map.set(Kn.REVOKE_C2C_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.REVOKE_C2C_MSG)}),body:{msgInfo:{fromAccount:"",toAccount:"",msgTimeStamp:0,msgSeq:0,msgRandom:0}},keyMap:{req:{msgInfo:"MsgInfo",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom"}}}),this._map.set(Kn.REVOKE_GRP_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.REVOKE_GRP_MSG)}),body:{groupID:"",msgSeqList:void 0,topicID:""},keyMap:{req:{msgSeqList:"MsgSeqList",msgSeq:"MsgSeq"}}}),this._map.set(Kn.GET_C2C_ROAMING_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.GET_C2C_ROAMING_MSG)}),body:{peerAccount:"",count:15,lastMessageTime:0,messageKey:"",withRecalledMessage:1,direction:0},keyMap:{req:{messageKey:"MsgKey",peerAccount:"Peer_Account",count:"MaxCnt",lastMessageTime:"LastMsgTime",withRecalledMessage:"WithRecalledMsg",direction:"GetDirection"},res:{LastMsgTime:"lastMessageTime",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer"}}}),this._map.set(Kn.MODIFY_C2C_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.MODIFY_C2C_MSG)}),body:{from:"",to:"",sequence:0,random:0,time:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(Kn.GET_GRP_ROAMING_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_ROAMING_MSG)}),body:{withRecalledMsg:1,groupID:"",count:15,sequence:"",topicID:void 0},keyMap:{req:{sequence:"ReqMsgSeq",count:"ReqMsgNumber",withRecalledMessage:"WithRecalledMsg"},res:{Random:"random",MsgTime:"time",MsgSeq:"sequence",ReqMsgSeq:"sequence",RspMsgList:"messageList",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgPriority:"priority",MsgBody:"elements",MsgType:"type",MsgContent:"content",IsFinished:"complete",Download_Flag:"downloadFlag",ClientSeq:"clientSequence",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",NextReqMsgSeq:"nextSequence"}}}),this._map.set(Kn.SET_C2C_MSG_READ,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.SET_C2C_MSG_READ)}),body:{C2CMsgReaded:void 0},keyMap:{req:{lastMessageTime:"LastedMsgTime"}}}),this._map.set(Kn.SET_C2C_PEER_MUTE_NOTIFICATIONS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.SET_C2C_PEER_MUTE_NOTIFICATIONS)}),body:{userIDList:void 0,muteFlag:0},keyMap:{req:{userIDList:"Peer_Account",muteFlag:"Mute_Notifications"}}}),this._map.set(Kn.GET_C2C_PEER_MUTE_NOTIFICATIONS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.GET_C2C_PEER_MUTE_NOTIFICATIONS)}),body:{toAccount:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Peer_Account"},res:{MuteNotificationsList:"muteFlagList"}}}),this._map.set(Kn.SET_GRP_MSG_READ,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.SET_GRP_MSG_READ)}),body:{groupID:void 0,messageReadSeq:void 0,topicID:void 0},keyMap:{req:{messageReadSeq:"MsgReadedSeq"}}}),this._map.set(Kn.SET_ALL_MSG_READ,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.SET_ALL_MSG_READ)}),body:{readAllC2CMessage:0,groupMessageReadInfoList:[]},keyMap:{req:{readAllC2CMessage:"C2CReadAllMsg",groupMessageReadInfoList:"GroupReadInfo",messageSequence:"MsgSeq"},res:{C2CReadAllMsg:"readAllC2CMessage",GroupReadInfoArray:"groupMessageReadInfoList"}}}),this._map.set(Kn.DEL_C2C_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.DEL_C2C_MSG)}),body:{fromAccount:"",to:"",keyList:void 0},keyMap:{req:{keyList:"MsgKeyList"}}}),this._map.set(Kn.DEL_GRP_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.DEL_GRP_MSG)}),body:{groupID:"",deleter:"",keyList:void 0,topicID:void 0},keyMap:{req:{deleter:"Deleter_Account",keyList:"Seqs"}}}),this._map.set(Kn.TRANSLATE_TEXT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_TRANSLATE,".").concat(Kn.TRANSLATE_TEXT)}),body:{sourceTextList:void 0,SDKAppID:0,from:0,source:"",target:""},keyMap:{req:{sourceTextList:"SourceText",SDKAppID:"SdkAppId",from:"FromAccount"},res:{TargetText:"translatedTextList",RequestId:"requestID",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(Kn.VOICE_TO_TEXT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_SPEECH,".").concat(Kn.VOICE_TO_TEXT)}),body:{url:"",SDKAppID:0,format:"",sourceType:0,language:""},keyMap:{req:{url:"BytesUrl",SDKAppID:"Uint32Sdkappid",format:"BytesVoiceFormat",sourceType:"Uint64SourceType",language:"BytesEngServiceType"},res:{BytesRequestid:"requestID",BytesResult:"result",CmdErrorCode:"error",ErrorCode:"code",ErrorInfo:"message"}}}),this._map.set(Kn.MODIFY_GRP_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.MODIFY_GRP_MSG)}),body:{groupID:"",topicID:void 0,sequence:0,version:0,elements:void 0,cloudCustomData:void 0},keyMap:{req:{sequence:"MsgSeq",version:"MsgVersion",type:"MsgType",content:"MsgContent"}}}),this._map.set(Kn.GET_READ_RECEIPT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_READ_RECEIPT)}),body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequence:"MsgSeq"}}}),this._map.set(Kn.SEND_C2C_READ_RECEIPT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.SEND_C2C_READ_RECEIPT)}),body:{peerAccount:"",messageInfoList:void 0},keyMap:{req:{peerAccount:"Peer_Account",messageInfoList:"C2CMsgInfo",fromAccount:"From_Account",toAccount:"To_Account",sequence:"MsgSeq",random:"MsgRandom",time:"MsgTime",clientTime:"MsgClientTime"}}}),this._map.set(Kn.SEND_READ_RECEIPT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.SEND_READ_RECEIPT)}),body:{groupID:"",sequenceList:void 0},keyMap:{req:{sequenceList:"MsgSeqList",sequence:"MsgSeq"}}}),this._map.set(Kn.GET_READ_RECEIPT_DETAIL,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_READ_RECEIPT_DETAIL)}),body:{groupID:"",sequence:void 0,flag:0,cursor:0,count:0},keyMap:{req:{sequence:"MsgSeq",count:"Num"},res:{ReadList:"readUserIDList",Read_Account:"userID",UnreadList:"unreadUserIDList",Unread_Account:"userID",IsFinish:"isCompleted"}}}),this._map.set(Kn.MODIFY_C2C_MSG_EXT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.MODIFY_C2C_MSG_EXT)}),body:{from:void 0,to:void 0,messageKey:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(Kn.GET_C2C_MSG_EXT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.GET_C2C_MSG_EXT)}),body:{from:void 0,to:void 0,messageKey:void 0,startSequence:void 0}}),this._map.set(Kn.MODIFY_GRP_MSG_EXT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.MODIFY_GRP_MSG_EXT)}),body:{groupID:void 0,topicID:void 0,messageSequence:void 0,operateType:void 0,extensionList:void 0}}),this._map.set(Kn.GET_GRP_MSG_EXT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.GET_GRP_MSG_EXT)}),body:{groupID:void 0,topicID:void 0,messageSequence:void 0,startSequence:void 0}}),this._map.set(Kn.ADD_C2C_MSG_REACTION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.ADD_C2C_MSG_REACTION)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(Kn.RM_C2C_MSG_REACTION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.RM_C2C_MSG_REACTION)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(Kn.GET_C2C_MSG_REACTIONS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.GET_C2C_MSG_REACTIONS)}),body:{from:void 0,to:void 0,messageKeyList:void 0,count:void 0}}),this._map.set(Kn.GET_C2C_MSG_REACTION_USER_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.GET_C2C_MSG_REACTION_USER_LIST)}),body:{from:void 0,to:void 0,reactionID:void 0,messageKey:void 0,count:void 0}}),this._map.set(Kn.ADD_GRP_MSG_REACTION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.ADD_GRP_MSG_REACTION)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Add_Account"}}}),this._map.set(Kn.RM_GRP_MSG_REACTION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.RM_GRP_MSG_REACTION)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,userIDList:void 0},keyMap:{req:{userIDList:"Del_Account"}}}),this._map.set(Kn.GET_GRP_MSG_REACTIONS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.GET_GRP_MSG_REACTIONS)}),body:{groupID:void 0,topicID:void 0,messageSequenceList:void 0,count:void 0},keyMap:{res:{MsgSeq:"messageSequence"}}}),this._map.set(Kn.GET_GRP_MSG_REACTION_USER_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM_MSG_EXT,".").concat(Kn.GET_GRP_MSG_REACTION_USER_LIST)}),body:{groupID:void 0,topicID:void 0,reactionID:void 0,messageSequence:void 0,nextSeq:void 0,count:void 0}}),this._map.set(Kn.GET_C2C_PEER_READ_TIME,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.GET_C2C_PEER_READ_TIME)}),body:{userIDList:void 0},keyMap:{req:{userIDList:"To_Account"},res:{ReadTime:"peerReadTimeList"}}}),this._map.set(Kn.PAGING_GET_CONV_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.PAGING_GET_CONV_LIST)}),body:{fromAccount:void 0,timeStamp:void 0,startIndex:void 0,pinnedTimeStamp:void 0,pinnedStartIndex:void 0,orderType:void 0,messageAssistFlag:15,assistFlag:31},keyMap:{req:{messageAssistFlag:"MsgAssistFlags",assistFlag:"AssistFlags",pinnedTimeStamp:"TopTimeStamp",pinnedStartIndex:"TopStartIndex"},res:{SessionItem:"conversations",ToAccount:"groupID",To_Account:"userID",UnreadMsgCount:"unreadCount",MsgGroupReadedSeq:"messageReadSeq",C2cPeerReadTime:"c2cPeerReadTime",LastMsgFlags:"lastMessageFlag",TopFlags:"isPinned",TopTimeStamp:"pinnedTimeStamp",TopStartIndex:"pinnedStartIndex",GroupId:"convGroupID",C2cRemark:"friendRemark",MsgRecvOption:"messageRemindType",GroupIgnoredUnreadSeqCount:"noUnreadCount",GroupNextMsgSeq:"nextMessageSeq"}}}),this._map.set(Kn.DEL_CONV,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.DEL_CONV)}),body:{fromAccount:"",conversationList:void 0,clearHistoryMessage:void 0},keyMap:{req:{toGroupID:"ToGroupid",clearHistoryMessage:"ClearRamble",conversationList:"ContactItem"},res:{ResultItem:"resultList",ToGroupid:"groupID",ResultCode:"code",ResultInfo:"info"}}}),this._map.set(Kn.CLEAR_HISTORY_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.CLEAR_HISTORY_MSG)}),body:{fromAccount:"",toAccount:void 0,type:1,toGroupID:void 0},keyMap:{req:{toGroupID:"ToGroupid"}}}),this._map.set(Kn.PIN_CONV,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.PIN_CONV)}),body:{fromAccount:"",operationType:1,itemList:void 0},keyMap:{req:{itemList:"RecentContactItem"}}}),this._map.set(Kn.DEL_GROUP_AT_TIPS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.DEL_GROUP_AT_TIPS)}),body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(Kn.SET_CONV_CUSTOM_DATA,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.MARK_CONV)}),body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(Kn.MARK_CONV,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.MARK_CONV)}),body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"MarkItem",operationType:"OptType",groupID:"ToGroupId"},res:{ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(Kn.CREATE_CONV_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.CREATE_CONV_GRP)}),body:{fromAccount:"",itemList:void 0},keyMap:{req:{itemList:"GroupContactItem",groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType"}}}),this._map.set(Kn.DEL_CONV_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.DEL_CONV_GRP)}),body:{fromAccount:"",groupName:void 0},keyMap:{res:{GroupId:"convGroupID"}}}),this._map.set(Kn.RENAME_CONV_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:void 0},keyMap:{req:{oldName:"OldGroupName",newName:"NewGroupName",groupID:"ToGroupId",operationType:"ContactOptType",groupName:"OldGroupName",updateItem:"ContactUpdateItem"},res:{ContactOptType:"operationType",ToGroupId:"groupID",GroupId:"convGroupID"}}}),this._map.set(Kn.ADD_CONV_TO_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:{groupName:void 0,updateGroupType:void 0,updateItem:void 0}}}),this._map.set(Kn.DEL_CONV_FROM_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.RENAME_CONV_GRP)}),body:{fromAccount:"",updateType:void 0,updateGroup:void 0}}),this._map.set(Kn.GET_CONV_GRP_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.GET_CONV_GRP_LIST)}),body:{fromAccount:"",startIndex:void 0},keyMap:{res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList"}}}),this._map.set(Kn.SEARCH_CONV_GRP_MARK,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.RECENT_CONTACT,".").concat(Kn.SEARCH_CONV_GRP_MARK)}),body:{fromAccount:"",contactItem:void 0},keyMap:{req:{groupID:"ToGroupId"},res:{GroupId:"convGroupID",ToGroupId:"groupID",OptType:"operationType",CustomMark:"customData",ContactGroupId:"convGroupIDList",ContactResultItem:"contactItem"}}}),this._map.set(Kn.GET_USER_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.PROFILE,".").concat(Kn.GET_USER_PROFILE)}),body:{fromAccount:"",userItem:[]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(Kn.UPDATE_MY_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.PROFILE,".").concat(Kn.UPDATE_MY_PROFILE)}),body:{fromAccount:"",profileItem:[{tag:Ge.NICK,value:""},{tag:Ge.GENDER,value:""},{tag:Ge.ALLOWTYPE,value:""},{tag:Ge.AVATAR,value:""}]},keyMap:{req:{toAccount:"To_Account",standardSequence:"StandardSequence",customSequence:"CustomSequence"}}}),this._map.set(Kn.GET_BL,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.GET_BL)}),body:{fromAccount:"",startIndex:0,maxLimited:30}}),this._map.set(Kn.ADD_TO_BL,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.ADD_TO_BL)}),body:{fromAccount:"",toAccount:[]}}),this._map.set(Kn.RM_FROM_BL,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.RM_FROM_BL)}),body:{fromAccount:"",toAccount:[]}}),this._map.set(Kn.SET_SELF_STATUS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.SET_SELF_STATUS)}),body:{customStatus:""}}),this._map.set(Kn.GET_USER_STATUS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.GET_USER_STATUS)}),body:{userIDList:void 0},keyMap:{res:{UserStatusList:"successUserList",ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID",Status:"statusType"}}}),this._map.set(Kn.SUB_USER_STATUS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.SUB_USER_STATUS)}),body:{userIDList:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(Kn.UNSUB_USER_STATUS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.UNSUB_USER_STATUS)}),body:{userIDList:void 0,unsubscribeAll:void 0},keyMap:{res:{ErrorList:"failureUserList",To_Account:"userID",Invalid_Account:"invalidUserID"}}}),this._map.set(Kn.GET_FD_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.GET_FD_LIST)}),body:{fromAccount:"",startIndex:0,standardSequence:0,customSequence:0},keyMap:{res:{FriendNum:"friendCount",UserDataItem:"resultList",ValueItem:"tagValueList"}}}),this._map.set(Kn.ADD_FD,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.ADD_FD)}),body:{fromAccount:"",addFriendItem:[],type:""},keyMap:{req:{source:"AddSource",wording:"AddWording",type:"AddType"},res:{ResultItem:"resultList"}}}),this._map.set(Kn.UPDATE_FD,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.UPDATE_FD)}),body:{fromAccount:"",updateItem:void 0},keyMap:{req:{snsItem:"SnsItem"},res:{ResultItem:"resultList"}}}),this._map.set(Kn.DEL_FD,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.DEL_FD)}),body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"DeleteType"},res:{ResultItem:"resultList"}}}),this._map.set(Kn.GET_FD_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.GET_FD_PROFILE)}),body:{fromAccount:"",userIDList:void 0},keyMap:{res:{InfoItem:"resultList",SnsProfileItem:"tagValueList"}}}),this._map.set(Kn.CHECK_FD,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.CHECK_FD)}),body:{fromAccount:"",userIDList:[],type:""},keyMap:{req:{type:"CheckType"},res:{InfoItem:"resultList"}}}),this._map.set(Kn.GET_FD_APPLICATION_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.GET_FD_APPLICATION_LIST)}),body:{fromAccount:"",applicationType:"",startTime:0,maxLimited:0,lastSequence:0},keyMap:{res:{PendencyItem:"resultList",AddSource:"source",AddTime:"time",AddWording:"wording",Image:"avatar",UnreadPendencyCount:"unreadCount",To_Account:"userID",PendencyType:"type"}}}),this._map.set(Kn.RESPOND_FD_APPLICATION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.RESPOND_FD_APPLICATION)}),body:{fromAccount:"",responseFriendItem:[]},keyMap:{req:{tag:"TagName",action:"ResponseAction"},res:{ResultItem:"resultList"}}}),this._map.set(Kn.DEL_FD_APPLICATION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.DEL_FD_APPLICATION)}),body:{fromAccount:"",type:"",userIDList:void 0},keyMap:{req:{type:"PendencyType",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(Kn.REPORT_FD_APPLICATION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.REPORT_FD_APPLICATION)}),body:{fromAccount:"",latestTimeStamp:""},keyMap:{req:{latestTimeStamp:"LatestPendencyTimeStamp"}}}),this._map.set(Kn.CREATE_FD_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.CREATE_FD_GRP)}),body:{fromAccount:"",groupName:void 0,userIDList:void 0},keyMap:{req:{groupName:"GroupName",userIDList:"To_Account"},res:{ResultItem:"resultList"}}}),this._map.set(Kn.DEL_FD_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.DEL_FD_GRP)}),body:{fromAccount:"",nameList:void 0},keyMap:{req:{nameList:"GroupName"}}}),this._map.set(Kn.GET_FD_GRP_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.GET_FD_GRP_LIST)}),body:{fromAccount:"",lastSequence:0,needFriend:"Need_Friend_Type_Yes"},keyMap:{res:{ResultItem:"resultList",GroupName:"name",FriendNumber:"friendCount",To_Account:"userIDList"}}}),this._map.set(Kn.UPDATE_FD_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FD,".").concat(Kn.UPDATE_FD_GRP)}),body:{fromAccount:"",oldName:"",newName:void 0,updateGroupItem:void 0},keyMap:{req:{oldName:"GroupOldName",newName:"GroupNewName"},res:{UpdateType:"type",ResultItem:"resultList"}}}),this._map.set(Kn.GET_GRP_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_LIST)}),body:{memberAccount:"",limit:void 0,offset:void 0,groupType:void 0,responseFilter:{groupBaseInfoFilter:void 0,selfInfoFilter:void 0},isSupportTopic:0,needAppDefineData:1},keyMap:{req:{memberAccount:"Member_Account"},res:{GroupIdList:"groups",MsgSeq:"readedSequence",LastRecallTime:"_lastRevokedTime",AppDefinedData:"groupCustomField"}}}),this._map.set(Kn.GET_GRP_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_PROFILE)}),body:{groupIDList:void 0,responseFilter:{groupBaseInfoFilter:void 0,groupCustomFieldFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0}},keyMap:{req:{groupIDList:"GroupIdList",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",groupCustomFieldFilter:"AppDefinedDataFilter_Group",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{GroupIdList:"groups",AppDefinedData:"groupCustomField",AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_Group:"groupCustomFieldFilter",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",InfoSeq:"infoSequence",MemberList:"members",GroupInfo:"groups",ShutUpUntil:"muteUntil",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(Kn.CREATE_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.CREATE_GRP)}),body:{type:void 0,name:void 0,groupID:void 0,ownerID:void 0,introduction:void 0,notification:void 0,maxMemberNum:void 0,joinOption:void 0,memberList:void 0,groupCustomField:void 0,memberCustomField:void 0,webPushFlag:1,avatar:"",isSupportTopic:void 0,inviteOption:void 0},keyMap:{req:{ownerID:"Owner_Account",userID:"Member_Account",avatar:"FaceUrl",maxMemberNum:"MaxMemberCount",joinOption:"ApplyJoinOption",groupCustomField:"AppDefinedData",memberCustomField:"AppMemberDefinedData",inviteOption:"InviteJoinOption"},res:{HugeGroupFlag:"avChatRoomFlag",OverJoinedGroupLimit_Account:"overLimitUserIDList"}}}),this._map.set(Kn.DISMISS_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.DISMISS_GRP)}),body:{groupID:void 0}}),this._map.set(Kn.UPDATE_GRP_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.UPDATE_GRP_PROFILE)}),body:{groupID:void 0,name:void 0,introduction:void 0,notification:void 0,avatar:void 0,joinOption:void 0,groupCustomField:void 0,muteAllMembers:void 0,inviteOption:void 0},keyMap:{req:{groupCustomField:"AppDefinedData",muteAllMembers:"ShutUpAllMember",joinOption:"ApplyJoinOption",avatar:"FaceUrl",inviteOption:"InviteJoinOption"},res:{AppDefinedData:"groupCustomField",ShutUpAllMember:"muteAllMembers"}}}),this._map.set(Kn.APPLY_JOIN_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.APPLY_JOIN_GRP)}),body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1,historyMessageFlag:void 0},keyMap:{req:{applyMessage:"ApplyMsg",historyMessageFlag:"HugeGroupHistoryMsgFlag"},res:{HugeGroupFlag:"avChatRoomFlag",AVChatRoomKey:"avChatRoomKey",RspMsgList:"messageList",ToGroupId:"to"}}}),this._map.set(Kn.APPLY_JOIN_GRP_NOAUTH,(e.a2,e.tinyid,{head:t(t({},_(e,Ia)),{},{servcmd:"".concat(G.NAME.BIG_GRP_NO_AUTH,".").concat(Kn.APPLY_JOIN_GRP)}),body:{groupID:void 0,applyMessage:void 0,userDefinedField:void 0,webPushFlag:1},keyMap:{req:{applyMessage:"ApplyMsg"},res:{HugeGroupFlag:"avChatRoomFlag"}}})),this._map.set(Kn.QUIT_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.QUIT_GRP)}),body:{groupID:void 0}}),this._map.set(Kn.SEARCH_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.SEARCH_GRP)}),body:{groupIDList:void 0,responseFilter:{groupBasePublicInfoFilter:["Type","Name","Introduction","Notification","FaceUrl","CreateTime","Owner_Account","LastInfoTime","LastMsgTime","NextMsgSeq","MemberNum","MaxMemberNum","ApplyJoinOption","InviteJoinOption"]}}}),this._map.set(Kn.CHANGE_GRP_OWNER,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.CHANGE_GRP_OWNER)}),body:{groupID:void 0,newOwnerID:void 0},keyMap:{req:{newOwnerID:"NewOwner_Account"}}}),this._map.set(Kn.HANDLE_GRP_APPLICATION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.HANDLE_GRP_APPLICATION)}),body:{groupID:void 0,applicant:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(Kn.HANDLE_INVITE_JOIN_GRP,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.HANDLE_INVITE_JOIN_GRP)}),body:{groupID:void 0,applicant:void 0,invitee:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,userDefinedField:void 0},keyMap:{req:{applicant:"Applicant_Account",invitee:"Invited_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg"}}}),this._map.set(Kn.HANDLE_GRP_INVITATION,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.HANDLE_GRP_INVITATION)}),body:{groupID:void 0,inviter:void 0,handleAction:void 0,handleMessage:void 0,authentication:void 0,messageKey:void 0,userDefinedField:void 0},keyMap:{req:{inviter:"Inviter_Account",handleAction:"HandleMsg",handleMessage:"ApprovalMsg",messageKey:"MsgKey"}}}),this._map.set(Kn.GET_GRP_PENDENCY,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_PENDENCY)}),body:{startTime:void 0,limit:void 0,handleAccount:void 0},keyMap:{req:{handleAccount:"Handle_Account"},res:{To_Account:"userID",ApplyInviteMsg:"note"}}}),this._map.set(Kn.DEL_GRP_SYSTEM_NOTICE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.DEL_GRP_SYSTEM_NOTICE)}),body:{messageListToDelete:void 0},keyMap:{req:{messageListToDelete:"DelMsgList",messageSeq:"MsgSeq",messageRandom:"MsgRandom"}}}),this._map.set(Kn.AV_POLLING,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.BIG_GRP_POLLING,".").concat(Kn.AV_POLLING)}),body:{USP:1,startSeq:1,startBroadcastSeq:void 0,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}}),this._map.set(Kn.AV_NOAUTH_POLLING,(e.a2,e.tinyid,{head:t(t({},_(e,ya)),{},{servcmd:"".concat(G.NAME.BIG_GRP_POLLING_NO_AUTH,".").concat(Kn.AV_POLLING)}),body:{USP:1,startSeq:1,holdTime:90,key:void 0,simplifiedMessage:void 0},keyMap:{req:{USP:"USP"},res:{ToGroupId:"groupID",RspBroadcastMsgList:"broadcastMessageList",IsSystemMsg:"isSystemMessage"}}})),this._map.set(Kn.GET_ONLINE_MBR_NUM,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_ONLINE_MBR_NUM)}),body:{groupID:void 0},keyMap:{res:{OnlineMemberNum:"memberCount"}}}),this._map.set(Kn.SET_GRP_ATTR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.SET_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(Kn.MODIFY_GRP_ATTR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.MODIFY_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key",value:"value"}}}),this._map.set(Kn.DEL_GRP_ATTR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.DEL_GRP_ATTR)}),body:{groupID:void 0,groupAttributeList:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]},keyMap:{req:{key:"key"}}}),this._map.set(Kn.CLEAR_GRP_ATTR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.CLEAR_GRP_ATTR)}),body:{groupID:void 0,mainSequence:void 0,avChatRoomKey:void 0,attributeControl:["RaceConflict"]}}),this._map.set(Kn.GET_GRP_ATTR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_ATTR,".").concat(Kn.GET_GRP_ATTR)}),body:{groupID:void 0,avChatRoomKey:void 0,groupType:1},keyMap:{req:{avChatRoomKey:"Key",groupType:"GroupType"}}}),this._map.set(Kn.GET_GRP_NOTIFY,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_NOTIFY)}),body:{notifyReqList:[]},keyMap:{req:{notifyReqList:"NotifyReqList"},res:{NextMsgTime:"nextRevokedTime",NotifyMsgList:"notifyList",NotifyRspList:"notifyRspList"}}}),this._map.set(Kn.UPDATE_GRP_COUNTER,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.UPDATE_GRP_COUNTER)}),body:{groupID:void 0,counterList:void 0,avChatRoomKey:void 0,mode:void 0},keyMap:{req:{counterList:"GroupCounter"}}}),this._map.set(Kn.GET_GRP_COUNTER,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_COUNTER)}),body:{groupID:void 0,keyList:[],avChatRoomKey:void 0},keyMap:{req:{keyList:"GroupCounterKeys"}}}),this._map.set(Kn.CREATE_TOPIC,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_COMMUNITY,".").concat(Kn.CREATE_TOPIC)}),body:{groupID:void 0,topicName:void 0,avatar:void 0,customData:void 0,topicID:void 0,notification:void 0,introduction:void 0},keyMap:{req:{avatar:"FaceUrl"}}}),this._map.set(Kn.DEL_TOPIC,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_COMMUNITY,".").concat(Kn.DEL_TOPIC)}),body:{groupID:void 0,topicIDList:void 0},keyMap:{req:{topicIDList:"TopicIdList"},res:{DestroyResultItem:"resultList"}}}),this._map.set(Kn.UPDATE_TOPIC_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_COMMUNITY,".").concat(Kn.UPDATE_TOPIC_PROFILE)}),body:{groupID:void 0,topicID:void 0,avatar:void 0,customData:void 0,notification:void 0,introduction:void 0,muteAllMembers:void 0,topicName:void 0},keyMap:{req:{avatar:"FaceUrl",muteAllMembers:"ShutUpAllMember"}}}),this._map.set(Kn.GET_TOPIC_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_COMMUNITY,".").concat(Kn.GET_TOPIC_LIST)}),body:{groupID:void 0,topicIDList:void 0,MemberInfoFilter:["NoUnreadSeqList"]},keyMap:{req:{topicIDList:"TopicIdList"},res:{TopicAndSelfInfo:"topicInfoList",TopicInfo:"topic",GroupID:"groupID",ShutUpTime:"muteTime",ShutUpAllFlag:"muteAllMembers",LastMsgTime:"lastMessageTime",MsgSeq:"readedSequence",LastMsgSeq:"sequence"}}}),this._map.set(Kn.GET_GRP_MBR_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_MBR_LIST)}),body:{groupID:void 0,limit:0,offset:void 0,next:void 0,memberRoleFilter:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{AppMemberDefinedData:"memberCustomField",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",MemberList:"members",ShutUpUntil:"muteUntil"}}}),this._map.set(Kn.GET_AV_MBR_LIST,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_AV,".").concat(Kn.GET_AV_MBR_LIST)}),body:{groupID:void 0,offset:void 0,filter:void 0},keyMap:{req:{offset:"Timestamp",filter:"Mark"},res:{NextTimestamp:"offset"}}}),this._map.set(Kn.GET_GRP_MBR_PROFILE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.GET_GRP_MBR_PROFILE)}),body:{groupID:void 0,userIDList:void 0,memberInfoFilter:void 0,memberCustomFieldFilter:void 0},keyMap:{req:{userIDList:"Member_List_Account",memberCustomFieldFilter:"AppDefinedDataFilter_GroupMember"},res:{MemberList:"members",ShutUpUntil:"muteUntil",AppDefinedDataFilter_GroupMember:"memberCustomFieldFilter",AppMemberDefinedData:"memberCustomField"}}}),this._map.set(Kn.ADD_GRP_MBR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.ADD_GRP_MBR)}),body:{groupID:void 0,silence:void 0,userIDList:void 0},keyMap:{req:{userID:"Member_Account",userIDList:"MemberList"},res:{MemberList:"members"}}}),this._map.set(Kn.DEL_GRP_MBR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.DEL_GRP_MBR)}),body:{groupID:void 0,userIDList:void 0,reason:void 0},keyMap:{req:{userIDList:"MemberToDel_Account"}}}),this._map.set(Kn.BAN_AV_MBR,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.BAN_AV_MBR)}),body:{groupID:void 0,userIDList:void 0,duration:void 0,reason:""},keyMap:{req:{userIDList:"Members_Account",duration:"Duration",reason:"Description"}}}),this._map.set(Kn.MODIFY_GRP_MBR_INFO,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP,".").concat(Kn.MODIFY_GRP_MBR_INFO)}),body:{groupID:void 0,topicID:void 0,userID:void 0,messageRemindType:void 0,nameCard:void 0,role:void 0,memberCustomField:void 0,muteTime:void 0},keyMap:{req:{userID:"Member_Account",memberCustomField:"AppMemberDefinedData",muteTime:"ShutUpTime",messageRemindType:"MsgFlag"}}}),this._map.set(Kn.MARK_AV_MBR_INFO,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_AV,".").concat(Kn.MARK_AV_MBR_INFO)}),body:{groupID:void 0,operationType:1,memberList:[]},keyMap:{req:{operationType:"CommandType",memberList:"MemberList",markType:"Marks",userID:"Member_Account"},res:{CommandType:"operationType",Marks:"markType",Member_Account:"userID"}}}),this._map.set(Kn.CS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.MSG_SEARCH,".").concat(Kn.CS)}),body:{keywordList:void 0,keywordListMatchType:"or",account:void 0,groupID:void 0,count:100,cursor:void 0,messageTypeList:void 0,senderUserIDList:void 0,startTime:void 0,endTime:void 0},keyMap:{req:{keywordListMatchType:"MatchType",account:"PeerAccount",groupID:"GroupID",messageTypeList:"MsgTypeList",senderUserIDList:"SendUserIDList",keywords:"Keywords",keywordMatchType:"KeywordMatchType",count:"Count",miniBirthday:"UserBirthStart",maxBirthday:"UserBirthEnd",gender:"UserGenderType",groupTypeList:"GroupType",groupIDList:"GroupIdList"},res:{GroupID:"groupID",UserID:"userID",ErrorCode:"code",ErrorInfo:"message",TotalCount:"totalCount",Count:"messageCount",LastMsgTime:"lastMessageTime",ConversationMsgs:"searchResult",IsNeedReadReceipt:"needReadReceipt",IsPeerRead:"readReceiptSentByPeer",MsgSeq:"sequence",ReqMsgSeq:"sequence",IsSystemMsg:"isSystemMessage",ToGroupId:"to",EnumFrom_AccountType:"fromAccountType",EnumTo_AccountType:"toAccountType",GroupCode:"groupCode",MsgContent:"content",ClientSeq:"clientSequence",ToTopicId:"topicID",InvisibleMsgSeq:"invisibleSequenceList",Users:"userList",ProfileItems:"profileItems",StrValue:"value",IntValue:"value",Groups:"groupList",GroupFaceUrl:"avatar",GroupIntroduction:"introduction",GroupOwnerUserID:"ownerID",GroupOwnerUserName:"ownerNick",GroupOwnerTinyID:"ownerTinyID",GroupMemberNum:"memberNum",GroupName:"name",GroupType:"type",GroupMembers:"groupMemberList",GroupMemberUserID:"userID",GroupMemberTinyID:"userTinyID",GroupMemberUserName:"nick",GroupMemberNameCard:"nameCard"}}}),this._map.set(Kn.USER_CS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.USER_SEARCH,".").concat(Kn.CS)}),body:{keywords:void 0,keywordMatchType:0,miniBirthday:void 0,maxBirthday:void 0,gender:void 0,count:20,cursor:void 0}}),this._map.set(Kn.GRP_CS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_SEARCH,".").concat(Kn.CS)}),body:{keywords:void 0,keywordMatchType:0,groupType:void 0,count:20,cursor:void 0}}),this._map.set(Kn.MBR_CS,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.GRP_MEMBER_SEARCH,".").concat(Kn.CS)}),body:{keywords:void 0,keywordMatchType:0,groupType:void 0,groupIDList:void 0,count:20,cursor:void 0}}),this._map.set(Kn.SSO_STAT,{head:t(t({},o),{},{servcmd:"".concat(G.NAME.IM_OPEN_STAT,".").concat(Kn.SSO_STAT)}),body:{header:{},event:[],quality:[]},keyMap:{req:{SDKType:"sdk_type",SDKVersion:"sdk_version",deviceType:"device_type",platform:"platform",instanceID:"instance_id",traceID:"trace_id",SDKAppID:"sdk_app_id",userID:"user_id",tinyID:"tiny_id",extension:"extension",timestamp:"timestamp",networkType:"network_type",eventType:"event_type",code:"error_code",message:"error_message",moreMessage:"more_message",duplicate:"duplicate",costTime:"cost_time",level:"level",qualityType:"quality_type",reportIndex:"report_index",wholePeriod:"whole_period",totalCount:"total_count",rttCount:"success_count_business",successRateOfRequest:"percent_business",countLessThan1Second:"success_count_business",percentOfCountLessThan1Second:"percent_business",countLessThan3Second:"success_count_platform",percentOfCountLessThan3Second:"percent_platform",successCountOfBusiness:"success_count_business",successRateOfBusiness:"percent_business",successCountOfPlatform:"success_count_platform",successRateOfPlatform:"percent_platform",successCountOfMessageReceived:"success_count_business",successRateOfMessageReceived:"percent_business",avgRTT:"average_value",avgDelay:"average_value",avgValue:"average_value",uiPlatform:"ui_platform"}}}),this._map.set(Kn.PING,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.HEARTBEAT,".").concat(Kn.PING)}),body:{}}),this._map.set(Kn.MSG_PUSH,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_PUSH,".").concat(Kn.MSG_PUSH)}),body:{},keyMap:{res:{C2cMsgArray:"C2CMessageArray",GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",C2cNotifyMsgArray:"C2CNotifyMessageArray",C2cMsgInfo:"C2CReadReceiptArray",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyAdd_Account:"userID",ProfileImNick:"nick",PendencyType:"applicationType",C2CReadAllMsg:"readAllC2CMessage",IsNeedReadReceipt:"needReadReceipt",Status:"statusType"}}}),this._map.set(Kn.MULTI_MSG_PUSH,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_PUSH,".").concat(Kn.MULTI_MSG_PUSH)}),body:{},keyMap:{res:{GroupMsgArray:"groupMessageArray",GroupTips:"groupTips",ClientSeq:"clientSequence",MsgPriority:"priority",NoticeSeq:"noticeSequence",MsgContent:"content",MsgType:"type",MsgBody:"elements",ToGroupId:"to",Desc:"description",Ext:"extension",IsSyncMsg:"isSyncMessage",Flag:"needSync",NeedAck:"needAck",PendencyType:"applicationType"}}}),this._map.set(Kn.MSG_PUSH_ACK,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OPEN_IM,".").concat(Kn.MSG_PUSH_ACK)}),body:{sessionData:void 0},keyMap:{req:{sessionData:"SessionData"}}}),this._map.set(Kn.STATUS_FORCE_OFFLINE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.STATUS_FORCE_OFFLINE)}),body:{},keyMap:{res:{C2cNotifyMsgArray:"C2CNotifyMessageArray",NoticeSeq:"noticeSequence",KickoutMsgNotify:"kickoutMsgNotify",NewInstInfo:"newInstanceInfo"}}}),this._map.set(Kn.DOWNLOAD_MERGER_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_LONG_MSG,".").concat(Kn.DOWNLOAD_MERGER_MSG)}),body:{downloadKey:""},keyMap:{res:{Data:"data",Desc:"description",Ext:"extension",Download_Flag:"downloadFlag",ThumbUUID:"thumbUUID",VideoUUID:"videoUUID"}}}),this._map.set(Kn.UPLOAD_MERGER_MSG,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_LONG_MSG,".").concat(Kn.UPLOAD_MERGER_MSG)}),body:{messageList:[]},keyMap:{req:{fromAccount:"From_Account",toAccount:"To_Account",msgTimeStamp:"MsgTimeStamp",msgSeq:"MsgSeq",msgRandom:"MsgRandom",msgBody:"MsgBody",type:"MsgType",content:"MsgContent",data:"Data",description:"Desc",extension:"Ext",sizeType:"Type",uuid:"UUID",url:"",imageUrl:"URL",fileUrl:"Url",remoteAudioUrl:"Url",remoteVideoUrl:"VideoUrl",thumbUUID:"ThumbUUID",videoUUID:"VideoUUID",videoUrl:"",downloadFlag:"Download_Flag",from:"From_Account",time:"MsgTimeStamp",messageRandom:"MsgRandom",messageSequence:"MsgSeq",elements:"MsgBody",clientSequence:"ClientSeq",payload:"MsgContent",messageList:"MsgList",messageNumber:"MsgNum",abstractList:"AbstractList",messageBody:"MsgBody"}}}),this._map.set(Kn.FOLLOW,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FOLLOW,".").concat(Kn.FOLLOW)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"FollowItem"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(Kn.UNFOLLOW,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FOLLOW,".").concat(Kn.UNFOLLOW)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(Kn.GET_FOLLOW_INFO,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FOLLOW,".").concat(Kn.GET_FOLLOW_INFO)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{FollowInfo:"followInfoList",To_Account:"userID",FollowerCount:"followersCount",FollowingCount:"followingCount",MutualFollowingCount:"mutualFollowersCount"}}}),this._map.set(Kn.GET_FOLLOW,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FOLLOW,".").concat(Kn.GET_FOLLOW)}),body:{fromAccount:"",type:1,nextCursor:"",count:500},keyMap:{req:{type:"FollowType",nextCursor:"StartCursor",count:"WantNum"},res:{FollowItem:"resultList",To_Account:"userID",ProfileItem:"profileList"}}}),this._map.set(Kn.CHECK_FOLLOW_TYPE,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.FOLLOW,".").concat(Kn.CHECK_FOLLOW_TYPE)}),body:{fromAccount:"",userIDList:[]},keyMap:{req:{userIDList:"To_Account"},res:{ResultItem:"resultList",To_Account:"userID"}}}),this._map.set(Kn.SET_TOKEN,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.SET_TOKEN)}),body:{tokenID:"",pushMsg:0,sdkAppID:0,businessID:"",deviceBrand:"",deviceToken:"",isTpns:0,isWebUniapp:0,notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:""},keyMap:{req:{tokenID:"TokenID",pushMsg:"PushMsg",sdkAppID:"EnterVersion",businessID:"BusiID",deviceBrand:"InstType",deviceToken:"VarToken",isTpns:"IsTpns",notificationStatus:"NotificationStatus",deviceModel:"DeviceModel",systemVersion:"SystemVersion",pushVersion:"PushPluginVersion"}}}),this._map.set(Kn.STAT_FOREGROUND,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.STAT_FOREGROUND)}),body:{isWebUniapp:0}}),this._map.set(Kn.STAT_BACKGROUND,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_OPEN_STATUS,".").concat(Kn.STAT_BACKGROUND)}),body:{C2CUnread:0,GroupUnread:0,isWebUniapp:0},keyMap:{req:{c2cUnreadCount:"C2cUnread",groupUnreadCount:"GrpUnread"}}}),this._map.set(Kn.PUSH_REPORT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.OFFLINE_PUSH_REPORT,".").concat(Kn.PUSH_REPORT)}),body:{eventList:[]},keyMap:{req:{eventList:"UinappPushEvents",type:"EventType",time:"EventTime",pushId:"ClickExt"}}}),this._map.set(Kn.SET_ALL_RECEIVE_MSG_OPT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_MSG_LOGIC,".").concat(Kn.SET_ALL_RECEIVE_MSG_OPT)}),body:{startTime:0,endTime:0,isRepeated:0,messageRemindType:0},keyMap:{req:{messageRemindType:"Level"}}}),this._map.set(Kn.GET_ALL_RECEIVE_MSG_OPT,{head:t(t({},e),{},{servcmd:"".concat(G.NAME.IM_MSG_LOGIC,".").concat(Kn.GET_ALL_RECEIVE_MSG_OPT)}),body:{toAccount:void 0}})}},{key:"has",value:function(e){return this._map.has(e)}},{key:"get",value:function(e){return this._map.get(e)}},{key:"update",value:function(){this._fillMap()}},{key:"getKeyMap",value:function(e){return this.has(e)?this.get(e).keyMap||{}:(Ne.w("".concat(this._n,".getKeyMap unknown P:").concat(e)),{})}},{key:"getProtocolData",value:function(e){var t=e.P,n=e.data;if(e=this.get(t),t=null,n){var o,i=this._simpleDeepCopy(e),s=(i=this._updateService(n,i)).body,a=Object.create(null);for(o in s)if(Object.prototype.hasOwnProperty.call(s,o)){if(a[o]=s[o],void 0===n[o])continue;a[o]=n[o]}i.body=a,t=this._getUplinkData(i)}else t=this._getUplinkData(e);return t}},{key:"_getUplinkData",value:function(e){var t=bt((e=this._dataCleaner(e)).head);return t=sa(e.body,this._getReqKeyMap(t)),e.body=t,e}},{key:"_updateService",value:function(e,t){var n,o,i=bt(t.head);return this._isFromGroupRequest(t)&&(n=e.type,o=e.groupID,e=void 0===(e=e.groupIDList)?[]:e,pt(o=void 0===o?void 0:o)&&(o=e[0]||""),Et({type:n,groupID:o})&&(t.head.servcmd="".concat(G.NAME.GRP_COMMUNITY,".").concat(i))),t}},{key:"_isFromGroupRequest",value:function(e){return e.head.servcmd.includes(G.NAME.GRP)||e.head.servcmd.includes(G.NAME.GRP_ATTR)}},{key:"_getReqKeyMap",value:function(e){return e=this.getKeyMap(e),t(t({},Xs.req),e.req)}},{key:"_dataCleaner",value:function(e){var t,o=Array.isArray(e)?[]:Object.create(null);for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&et(t)&&null!==e[t]&&void 0!==e[t]&&("object"!==n(e[t])?o[t]=e[t]:o[t]=this._dataCleaner.bind(this)(e[t]));return o}},{key:"_simpleDeepCopy",value:function(e){for(var t,n=Object.keys(e),o={},i=0,s=n.length;i<s;i++)Xe(e[t=n[i]])?o[t]=Array.from(e[t]):Je(e[t])?o[t]=this._simpleDeepCopy(e[t]):o[t]=e[t];return o}}]),ka),Ca=[Kn.MSG_PUSH_ACK],Ta=(s(Aa,[{key:"_onC2CMsgArray",value:function(e){var t=this._sessionM.get(6);e.dataList.forEach((function(e){var t;1===e.isSyncMessage&&(t=e.from,e.from=e.to,e.to=t)})),1===e.needSync&&this._sessionM.get(19).syncOnNeed(),t.onNewMessage({dataList:e.dataList,isInstantMessage:!0})}},{key:"_onC2CMsgModified",value:function(e){this._sessionM.get(6).onMsgModified(e)}},{key:"_onGroupMsgArray",value:function(e){var t=this._sessionM.get(7);t&&t.onNewMessage({event:e.event,dataList:e.dataList,isInstantMessage:!0})}},{key:"_onGroupMsgModified",value:function(e){var t=this._sessionM.get(7);t&&t.onMsgModified(e)}},{key:"_onGroupTips",value:function(e){var t=this._sessionM.get(7);if(t){var n=e.event,o=e.dataList,i=e.isInstantMessage,s=void 0===i||i,a=e.isSyncingEnded;switch(n){case 4:case 6:t.onNewGroupTips({event:n,dataList:o});break;case 5:for(var r=0;r<o.length;r++)if(Xe(o[r].elements.revokedInfos))t.onMsgRevoked({dataList:o});else if(Xe(o[r].elements.groupMessageReadNotice))t.onMsgReadNotice({dataList:o});else{if(!Xe(o[r].elements.readReceiptList)){t.onNewGroupSystemNotice({dataList:o,isInstantMessage:s,isSyncingEnded:a});break}t.onReadReceiptList({dataList:o})}break;case 12:this._sessionM.get(11).onNewGroupAtTips({dataList:o});break;default:Ne.l("".concat(this._n,"._onGroupTips unknown event:").concat(n," dataList:"),o)}}}},{key:"_onC2CNotifyMsgArray",value:function(e){var t,n=this,o=e.dataList;Xe(o)&&(t=this._sessionM.get(6),o.forEach((function(e){var i,s;ze(e)&&(e.hasOwnProperty("kickoutMsgNotify")?(i=(s=e.kickoutMsgNotify).kickType,s=void 0===(s=s.newInstanceInfo)?{}:s,1===i?n._sessionM.onMultipleAccountKickedOut(s):2===i?n._sessionM.onMultipleDeviceKickedOut(s):3===i&&n._sessionM.onRestApiKickedOut(s)):e.hasOwnProperty("c2cMessageRevokedNotify")?t&&t.onMsgRevoked({dataList:o},!0):e.hasOwnProperty("c2cMessageReadReceipt")?t&&t.onMsgReadReceipt({dataList:o}):e.hasOwnProperty("c2cMessageReadNotice")?t&&t.onMsgReadNotice({dataList:o}):e.hasOwnProperty("muteNotificationsSync")&&n._sessionM.get(11).onC2CMsgRemindTypeSynced({dataList:o}))})))}},{key:"_onC2CReadReceiptArray",value:function(e){this._sessionM.get(6).onReadReceiptList(e)}},{key:"_onProfileModified",value:function(e){this._sessionM.get(4).onProfileModified({dataList:e.dataList});var t=this._sessionM.get(8);t&&t.onFriendProfileModified({dataList:e.dataList})}},{key:"_onRelationChainModified",value:function(e){this._sessionM.get(4).onRelationChainModified({dataList:e.dataList});var t=this._sessionM.get(8);t&&t.onRelationChainModified({dataList:e.dataList})}},{key:"_onRecentContact",value:function(e){var t;!Xe(e=e.dataList)||(t=this._sessionM.get(11))&&e.forEach((function(e){var n,o,i=e.pushType;1===i?(n=e.recentContactDeleteItem,t.onConvDeleted(n.recentContactList)):2===i?(n=e.recentContactTopItem,t.onConvPinnedStatus(n.recentContactList,!0)):3===i?(n=e.recentContactTopItem,t.onConvPinnedStatus(n.recentContactList,!1)):4===i?(n=e.recentContactMarkContact,t.onConvMarkUpdated(n.recentContactMarkContactItem)):5===i?(n=e.recentContactCreateContactGroup,t.onConvGroupCreated(n.msgContactGroupContactItem)):6===i?(n=e.recentContactDelContactGroup,t.onConvGroupDeleted(n.msgGroupItem)):7===i&&(i=(n=e.recentContactUpdateContactGroup).updateType,e=n.msgUpdateGroup,n=n.msgUpdateContact,1===i?1===(o=e.updateGroupType)?t.onConvGroupNameUpdated(e):2===o&&t.onConvInGroupUpdated(e):2===i&&t.onConvAddedToOrDeletedFromGroup(n))}))}},{key:"_onAllMsgRead",value:function(e){e=e.dataList;var t=this._sessionM.get(11);t&&t.onPushedAllMessageRead(e)}},{key:"_onUserStatusList",value:function(e){this._sessionM.get(4).onUserStatusUpdated(e)}},{key:"_onMsgExtNotify",value:function(e){this._sessionM.get(3).onMsgExtNotify(e)}},{key:"_onMsgReactionNotifyList",value:function(e){this._sessionM.get(34).onReactionNotifyList(e)}},{key:"_onMsgReactionNotify",value:function(e){this._sessionM.get(34).onReactionNotify(e)}},{key:"_onFollowNotify",value:function(e){this._sessionM.get(35).onFollowNotify(e)}},{key:"_onTopicLatestMsg",value:function(e){this._sessionM.get(10).onTopicLatestMsg(e)}},{key:"onMessage",value:function(e){var t=this,n=e.body;if(this._filterMsgFromIMOpenPush(e)){var o,i=n.eventArray,s=n.isInstantMessage,a=n.isSyncingEnded,r=n.needSync;if(Xe(i))for(var c,u,l,d=0,p=i.length;d<p;d++)100!==(l=(c=i[d]).event)?24!==l?26!==l?(o=Object.keys(c).find((function(e){return-1!==t._keys.indexOf(e)})))?(u=14===l?{readAllC2CMessage:c[o],groupMessageReadInfoList:c.groupMessageReadNotice||[]}:16===l?{userID:c.userID,timestamp:c.timestamp,readReceiptList:c[o]}:c[o],this._eventHandlerMap.get(o)({event:l,dataList:u,isInstantMessage:s,isSyncingEnded:a,needSync:r})):Ne.l("".concat(this._n,".onMessage unknown eventItem:"),c):this._onTopicLatestMsg(c):this._onAllRcvMsgOptNotify(c):this._onRoomCustomData(c.content)}}},{key:"_onRoomCustomData",value:function(e){this._sessionM.get(30).onRoomCustomDataReceived(e),Ne.l("".concat(this._n,"._onRoomCustomData data:").concat(e))}},{key:"_onAllRcvMsgOptNotify",value:function(e){this._sessionM.get(11).onAllRcvMsgOptNotify(e)}},{key:"_filterMsgFromIMOpenPush",value:function(e){var t=e.head,n=(e=e.body,t=t.servcmd,!1);return!(n=pt(t)?n:t.includes(G.NAME.IM_CONFIG_MANAGER)||t.includes(G.NAME.OVERLOAD_PUSH)||t.includes(G.NAME.STAT_SERVICE))||(t.includes(Kn.PUSHED_CLOUD_CTRL_CONFIG)?this._sessionM.get(23).onPushedConfig(e):t.includes(Kn.PUSHED_COMMERCIAL_CONFIG)?this._sessionM.get(27).onPushedConfig(e):t.includes(Kn.OVERLOAD_NOTIFY)?this._sessionM.onPushedServerOverload(e):t.includes(Kn.KICK_OTHER)&&(n=Date.now(),this._sessionM.reLoginOnKickOther(),e=new so("kickOther"),n-=t=this._sessionM.get(1).getLastWsHelloTs(),e.setMessage("last wshello time:".concat(t," diff:").concat(n,"ms")).end()),!1)}}]),Aa),Ea=[{cmd:Kn.GET_GRP_PROFILE,interval:1,count:8},{cmd:Kn.UPDATE_GRP_PROFILE,interval:1,count:8},{cmd:Kn.GET_AV_MBR_LIST,interval:3,count:1},{cmd:Kn.GET_GRP_PENDENCY,interval:1,count:15},{cmd:Kn.GET_TOPIC_LIST,interval:1,count:10},{cmd:Kn.SET_GRP_ATTR,interval:5,count:10},{cmd:Kn.MODIFY_GRP_ATTR,interval:5,count:10},{cmd:Kn.DEL_GRP_ATTR,interval:5,count:10},{cmd:Kn.CLEAR_GRP_ATTR,interval:5,count:10},{cmd:Kn.GET_GRP_ATTR,interval:5,count:20},{cmd:Kn.UPDATE_GRP_COUNTER,interval:5,count:20},{cmd:Kn.GET_GRP_COUNTER,interval:5,count:20},{cmd:Kn.SET_ALL_MSG_READ,interval:1,count:1},{cmd:Kn.GET_USER_STATUS,interval:5,count:20},{cmd:Kn.SUB_USER_STATUS,interval:5,count:20},{cmd:Kn.UNSUB_USER_STATUS,interval:5,count:20},{cmd:Kn.CS,interval:5,count:20},{cmd:Kn.GRP_CS,interval:5,count:20},{cmd:Kn.MBR_CS,interval:5,count:20},{cmd:Kn.USER_CS,interval:5,count:20},{cmd:Kn.CHECK_FOLLOW_TYPE,interval:5,count:20},{cmd:Kn.GET_GRP_ROAMING_MSG,interval:1,count:20},{cmd:Kn.GET_C2C_ROAMING_MSG,interval:1,count:20}],Da=new Map,Ra=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],Sa=0,La=Ra.length;Sa<La;Sa++)Da.set(Sa,Ra[Sa]);function Aa(e){o(this,Aa),this._sessionM=e,this._n="MsgDispatcher",this._eventHandlerMap=new Map,this._eventHandlerMap.set("C2CMessageArray",this._onC2CMsgArray.bind(this)),this._eventHandlerMap.set("groupMessageArray",this._onGroupMsgArray.bind(this)),this._eventHandlerMap.set("groupTips",this._onGroupTips.bind(this)),this._eventHandlerMap.set("C2CNotifyMessageArray",this._onC2CNotifyMsgArray.bind(this)),this._eventHandlerMap.set("C2CReadReceiptArray",this._onC2CReadReceiptArray.bind(this)),this._eventHandlerMap.set("profileModify",this._onProfileModified.bind(this)),this._eventHandlerMap.set("friendListMod",this._onRelationChainModified.bind(this)),this._eventHandlerMap.set("recentContactMod",this._onRecentContact.bind(this)),this._eventHandlerMap.set("readAllC2CMessage",this._onAllMsgRead.bind(this)),this._eventHandlerMap.set("c2cMessageModified",this._onC2CMsgModified.bind(this)),this._eventHandlerMap.set("groupMessageModified",this._onGroupMsgModified.bind(this)),this._eventHandlerMap.set("userStatusList",this._onUserStatusList.bind(this)),this._eventHandlerMap.set("messageExtensionNotify",this._onMsgExtNotify.bind(this)),this._eventHandlerMap.set("messageReactionNotifyList",this._onMsgReactionNotifyList.bind(this)),this._eventHandlerMap.set("messageReactionNotify",this._onMsgReactionNotify.bind(this)),this._eventHandlerMap.set("followChangeList",this._onFollowNotify.bind(this)),this._keys=m(this._eventHandlerMap.keys())}function ka(e){o(this,ka),this._n="PHandler",this._sessionM=e,this._map=new Map,this._fillMap()}function Oa(e){return o(this,Oa),(e=aa.call(this,e))._n="ChannelModule",e._socketHandler=new fa(h(e)),e._probing=!1,e._isAppShowing=!0,e._previousState=D.NET_STATE_CONNECTED,e._timerForNotLoggedIn=-1,e._timerForNotLoggedIn=setInterval(e.onCheckTimer.bind(h(e)),1e3),e._fatalErrorFlag=!1,e._disconnectedTS=0,e._lastDiagnoseTS=0,e}function Na(e){o(this,Na),this._chM=e,this._n="SocketHandler",this._promiseMap=new Map,this._readyState=ga,this._simpleRequestMap=new Map,this.MAX_SIZE=100,this._startSequence=st(),this._startTs=0,this._reConnectFlag=!1,this._nextPingTs=0,this._reConnectCount=0,this.MAX_RECONNECT_COUNT=3,this._socketID=-1,this._random=0,this._socket=null,this._url="",this._onOpenTs=0,this._canIUseBinaryFrame=!0,this._isWorkerEnabled=!0,this._currentSite=P,this._setWebsocketHost(),this._initConnection()}function Pa(e){o(this,Pa);var t,n,i=(this._handler=e).getURL();this._socket=null,this._workerSocket=null,this._id=st(),this._handler.getIsWorkerEnabled()?(t=URL.createObjectURL(new Blob([';let _socket = null;onmessage = function(event) {  if (event.data.cmd === "start") {    const url = event.data.url;    _socket = new WebSocket(url);    _socket.binaryType = "arraybuffer";    _socket.onopen = function() {      postMessage({ callback: "onOpen", extensions: _socket.extensions });    };    _socket.onclose = function(e) {      postMessage({ callback: "onOpen", e: { code: e.code, reason: e.reason } });    };    _socket.onmessage = function(e) {      postMessage({ callback: "onMessage", data: e.data });    };    _socket.onerror = function(e) {      postMessage({ callback: "onError", e: { isTrusted: "true" } });    };  } else if (event.data.cmd === "sendMessage") {    if (_socket !== null) {      _socket.send(event.data.data);    }  } else if (event.data.cmd === "stop") {    if (_socket !== null) {      _socket.close(event.data.code);      _socket = null;    }  }};'],{type:"application/javascript; charset=utf-8"})),this._workerSocket=new Worker(t),(n=this)._workerSocket.onmessage=function(e){var t=(i=e.data).callback,o=i.e,i=i.extensions;"onOpen"===t?n._onOpen(i):"onClose"===t?n._onClose(o):"onError"===t?n._onError(o):"onMessage"===t&&n._onMessage(e.data)},this._workerSocket.postMessage({cmd:"start",id:this._id,url:i})):Z?j?(ne.connectSocket({url:i,header:{"content-type":"application/json"}}),ne.onSocketClose(this._onClose.bind(this)),ne.onSocketOpen(this._onOpen.bind(this)),ne.onSocketMessage(this._onMessage.bind(this)),ne.onSocketError(this._onError.bind(this))):(this._socket=ne.connectSocket({url:i,header:{"content-type":"application/json"},complete:function(){}}),this._socket.onClose(this._onClose.bind(this)),this._socket.onOpen(this._onOpen.bind(this)),this._socket.onMessage(this._onMessage.bind(this)),this._socket.onError(this._onError.bind(this))):(this._socket=new WebSocket(i),this._socket.binaryType="arraybuffer",this._socket.onopen=this._onOpen.bind(this,this._socket.extensions),this._socket.onmessage=this._onMessage.bind(this),this._socket.onclose=this._onClose.bind(this),this._socket.onerror=this._onError.bind(this)),this._canIUseBinaryFrame=e.canIUseBinaryFrame()}function Ga(e){for(var t,n,o=e,i="",s=0,a=(o=e.length%8!=0?"0".repeat(8-e.length%8)+e:o).length;s<a;s+=8)t=parseInt(o.slice(s,s+4),2),n=parseInt(o.slice(s+4,s+8),2),i+=Da.get(t)+Da.get(n);return i}function Ua(e){if(e<0||53<e)return NaN;var t=0|1073741824*Math.random();return 30<e?t+1073741824*(0|Math.random()*(1<<e-30)):t>>>30-e}function ba(e,t){for(var n=e.toString(16),o=t-n.length,i="0";0<o;o>>>=1,i+=i)1&o&&(n=i+n);return n}r(tc,bn),ja=g(tc),s(tc,[{key:"_init",value:function(){this._updateCmdFreqLimitMap(Ea)}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("cmd_frequency_limit");pt(e)||(e=JSON.parse(e),this._updateCmdFreqLimitMap(e))}},{key:"_updateCmdFreqLimitMap",value:function(e){var t=this;e.forEach((function(e){t._cmdFreqLimitMap.set(e.cmd,{interval:e.interval,count:e.count})}))}},{key:"updateProtocolConfig",value:function(){this._pHandler.update()}},{key:"req",value:function(e){Ne.d("".concat(this._n,".req options:"),e);var t=e.P;if(!this._pHandler.has(t))return Ne.w("".concat(this._n,".req unknown P:").concat(t)),Rn({code:Bn.NO_PROTOCOL});var n=(e=this.getProtocolData(e)).head.servcmd;if(this._isFreqOverLimit(n))return Rn({code:o=Bn.OVER_FREQUENCY_LIMIT,message:this.getErrMsg(o,this._getCmd(n))});if(this._isServerOverload(n))return Rn({code:o=Bn.OPEN_SERVICE_OVERLOAD_ERROR,message:this.getErrMsg(o,this._getCmd(n))});var o=this.get(21);return Ca.includes(t)?o.simplySend(e):o.send(e)}},{key:"getKeyMap",value:function(e){return this._pHandler.getKeyMap(e)}},{key:"genCommonHead",value:function(){var e=this.get(12);return{ver:"v4",platform:this._platform,websdkappid:N,websdkversion:O,a2:e.getA2Key()||void 0,tinyid:e.getTinyID()||void 0,status_instid:e.getStatusInstanceID(),sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getA2Key()?void 0:e.getUserID(),usersig:e.getA2Key()?void 0:e.getUserSig(),sdkability:12775283,sdkability_ext:Ga(""),cappid:e.getApplicationID(),cs:0}}},{key:"genCosSpecifiedHead",value:function(){var e=this.get(12);return{ver:"v4",platform:this._platform,websdkappid:N,websdkversion:O,sdkappid:e.getSDKAppID(),contenttype:e.getContentType(),reqtime:0,identifier:e.getUserID(),usersig:e.getUserSig(),status_instid:e.getStatusInstanceID(),sdkability:12775283,sdkability_ext:Ga(""),cappid:e.getApplicationID(),cs:0}}},{key:"genSSOReportHead",value:function(){var e=this.get(12);return{ver:"v4",platform:this._platform,websdkappid:N,websdkversion:O,sdkappid:e.getSDKAppID(),contenttype:"",reqtime:0,identifier:"",usersig:"",status_instid:e.getStatusInstanceID(),sdkability:12775283,sdkability_ext:Ga(""),cappid:e.getApplicationID(),cs:0}}},{key:"getProtocolData",value:function(e){return this._pHandler.getProtocolData(e)}},{key:"trans",value:function(e){var n=e.servcmd;return e=e.data,n={head:t(t({},this.genCommonHead()),{},{servcmd:n}),body:e},this.get(21).send(n)}},{key:"sendComboMessage",value:function(e){var n=e.servcmd;return e=e.data,n={head:t(t({},this.genCommonHead()),{},{servcmd:n}),body:e},this.get(21).send(n)}},{key:"onErrorCodeNotZero",value:function(e){var t,n=e.errorCode;n===Bn.HELLO_ANSWER_KICKED_OUT&&(t=e.kickType,e=void 0===(e=e.newInstanceInfo)?{}:e,1===t?this.onMultipleAccountKickedOut(e):2===t?this.onMultipleDeviceKickedOut(e):3===t&&this.onRestApiKickedOut(e)),n!==Bn.MSG_A2KEY_EXPIRED&&n!==Bn.ACCOUNT_A2KEY_EXPIRED||(this._onUserSigExpired(),this.get(21).reConnect())}},{key:"onMessage",value:function(e){var t=(n=e.body).needAck,n=n.sessionData;1===(void 0===t?0:t)&&this._sendACK(n),this._msgDispatcher.onMessage(e)}},{key:"onReconnected",value:function(e){this._incrementalPullContactFlag=e<=300,this._reLoginOnReconnected()}},{key:"reLoginOnKickOther",value:function(){Ne.l("".concat(this._n,".reLoginOnKickOther")),this._reLogin()}},{key:"_reLoginOnReconnected",value:function(){Ne.l("".concat(this._n,"._reLoginOnReconnected")),this._reLogin()}},{key:"_reLogin",value:function(){var e,t,n,o=this,i="".concat(this._n,"._reLogin");this.isLoggedIn()&&(e=0,(t=this.get(1).getPushModule())&&(e=t.getUniAppPlatform()),n=new so("reLogin"),this.req({P:Kn.LOGIN,data:{isWebUniapp:e,customInfo:this.get(12).getCustomLoginInfo()}}).then((function(e){var t=(e=e.data).instanceID,s=(e=e.customStatus,o.get(12)),a=ei(e),r=(s.setStatusInstanceID(t),o.get(21)),c=r.getSocketID();c="socketID:".concat(c," instanceID:").concat(t," customStatus:").concat(a),n.setMessage(c).end(!0),Ne.l("".concat(i," ok. ").concat(c)),s.getCustomStatus()!==a&&o.get(4).onUserStatusUpdated({dataList:[{to:o.getMyUserID(),statusType:D.USER_STATUS_ONLINE,customStatus:e}]}),r.diagnose(),o.get(11).syncConvList(o._incrementalPullContactFlag).then((function(){Ne.l("".concat(i,", sync conv list ok.")),o.get(25).start()})),((t=o.get(7))&&t.updateLocalMainSequenceOnReconnected(),c=o.get(10)).resetGetTopicTime(),c.getTopicListOnReconnected(),(s=o.get(35))&&s.clearCacheOnReconnected()})))}},{key:"onMultipleAccountKickedOut",value:function(e){this.get(1).onMultipleAccountKickedOut(e)}},{key:"onMultipleDeviceKickedOut",value:function(e){this.get(1).onMultipleDeviceKickedOut(e)}},{key:"_onUserSigExpired",value:function(){this.get(1).onUserSigExpired()}},{key:"onRestApiKickedOut",value:function(e){this.get(1).onRestApiKickedOut(e)}},{key:"_sendACK",value:function(e){this.req({P:Kn.MSG_PUSH_ACK,data:{sessionData:e}})}},{key:"_isFreqOverLimit",value:function(e){if(e=e.split(".")[1],!this._cmdFreqLimitMap.has(e))return!1;if(!this._cmdReqInfoMap.has(e))return this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1;var t=(n=this._cmdFreqLimitMap.get(e)).count,n=n.interval,o=(i=this._cmdReqInfoMap.get(e)).startTime,i=i.requestCount;return Date.now()-o>1e3*n?(this._cmdReqInfoMap.set(e,{startTime:Date.now(),requestCount:1}),!1):(this._cmdReqInfoMap.set(e,{startTime:o,requestCount:i+=1}),t<i)}},{key:"_isServerOverload",value:function(e){if(!this._serverOverloadInfoMap.has(e))return!1;var t=(n=this._serverOverloadInfoMap.get(e)).overloadTime,n=n.waitingTime;return Date.now()-t<=1e3*n||(this._serverOverloadInfoMap.delete(e),!1)}},{key:"_getCmd",value:function(e){var t="";if(!e.includes("."))return t;var n,o=e.split(".")[1];for(n in Kn)if(Kn[n]===o){t=n;break}return t}},{key:"onPushedServerOverload",value:function(e){var t=e.overloadCommand;e=e.waitingTime,this._serverOverloadInfoMap.set(t,{overloadTime:Date.now(),waitingTime:e}),Ne.w("".concat(this._n,".onPushedServerOverload waitingTime:").concat(e,"s cmd:").concat(this._getCmd(t)))}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._updateCmdFreqLimitMap(Ea),this._cmdReqInfoMap.clear(),this._serverOverloadInfoMap.clear(),this._incrementalPullContactFlag=!0}}]);var wa,Fa,qa,xa,Va,Ba,Ha,Ka,Wa,Ya,ja,Ja=tc,za=(r(ec,bn),Ya=g(ec),s(ec,[{key:"getCloudConfig",value:function(e){return pt(e)?this._cloudConfig:this._cloudConfig.has(e)?this._cloudConfig.get(e):void 0}},{key:"getServerConfig",value:function(e){var t={code:0,data:""};return!pt(e)&&this._cloudConfig.has(e)&&(t.data=this._cloudConfig.get(e)),Promise.resolve(t)}},{key:"_canFetch",value:function(){return this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime}},{key:"fetchConfig",value:function(){var e,t=this,n="".concat(this._n,".fetchConfig"),o=this._canFetch();Ne.l("".concat(n," canFetch:").concat(o)),o&&(e=new so("fetchCloudCtrlConfig"),o=this.get(12).getSDKAppID(),this._isFetching=!0,this.req({P:Kn.FETCH_CLOUD_CTRL_CONFIG,data:{SDKAppID:o,version:this._version}}).then((function(o){t._isFetching=!1;var i=(s=o.data).version,s=s.cloudControlConfig;e.setMessage("version:".concat(t._version," newVersion:").concat(i," config:").concat(s)).end(),Ne.l("".concat(n," ok")),t._parse(o.data)})).catch((function(o){t._isFetching=!1,e.setError(o).end(),Ne.l("".concat(n," failed. error:"),o),t._setExpiredTime(12e4)})))}},{key:"onPushedConfig",value:function(e){Ne.l("".concat(this._n,".onPushedConfig config:"),e),new so("pushedCloudCtrlConfig").setMessage("newVersion:".concat(e.version," config:").concat(e.cloudControlConfig)).end(),this._parse(e)}},{key:"onCheckTimer",value:function(e){this._canFetch()&&this.fetchConfig()}},{key:"_parse",value:function(e){var t=this,n="".concat(this._n,"._parse"),o=e.errorCode,i=e.errorMessage,s=e.cloudControlConfig,a=e.version,r=e.expiredTime;if(0===o){if(this._version!==a){var c=null;try{c=JSON.parse(s)}catch(e){this.isPrivateNetWork()||Ne.e("".concat(n," failed. config:"),s)}c&&(this._cloudConfig.clear(),Object.keys(c).forEach((function(e){t._cloudConfig.set(e,c[e])})),this._version=a,this.emitIEvt(jo.CLOUD_CONFIG))}this._setExpiredTime(1e3*r)}else pt(o)?(Ne.l("".concat(n," failed. Invalid message format:"),e),this._setExpiredTime(36e5)):(Ne.e("".concat(n," errorCode:").concat(o," errorMessage:").concat(i)),this._setExpiredTime(12e4))}},{key:"_setExpiredTime",value:function(e){this._expiredTime=Date.now()+e}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._cloudConfig.clear(),this._expiredTime=0,this._version=0,this._isFetching=!1}}]),ec),Xa=(r($r,bn),Wa=g($r),s($r,[{key:"start",value:function(){this._recoverGroupChat(),this._recoverC2CChat()}},{key:"_recoverGroupChat",value:function(){var e,t,n,o,i=this,s=this._getLocalConvList().filter((function(e){return e.type===D.CONV_GROUP&&e.groupProfile.type!==D.GRP_AVCHATROOM})),a=this.get(11),r=[];s.forEach((function(s){var c=s.conversationID;s=s.lastMessage,e=c.replace(D.CONV_GROUP,""),t=a.getLocalLastMessage(c),s&&0!==s.lastSequence&&t?(n=s.lastSequence,t=t.sequence,o=n-t,0<t&&1<=o&&o<300?i._recoverGroupMsg({groupID:e,localLastMessageSequence:t,remoteLastMessageSequence:n}):r.push(e)):r.push(e)})),this._getGroupNotice(r)}},{key:"_recoverC2CChat",value:function(){var e,t,n,o=this,i=this._getLocalConvList().filter((function(e){return e.type===D.CONV_C2C})),s=this.get(11),a=[Promise.resolve()];i.forEach((function(i){var r=i.conversationID;i=i.lastMessage,e=s.getLocalLastMessage(r),i&&0!==i.lastTime&&e&&(t=i.lastTime,e=e.time,n=t-e,0<e&&1<=n&&n<=600&&a.push(o._recoverC2CMsg({conversationID:r,localLastMessageTime:e,remoteLastMessageTime:t})))})),Promise.all(a).then((function(){Ne.l("".concat(o._n,"._recoverC2CChat all done")),o.get(19).syncOnReconnected()}))}},{key:"_getLocalConvList",value:function(){return this.get(11).getLocalConvList()}},{key:"_recoverGroupMsg",value:function(e){var t=this,n="".concat(this._n,".").concat("_recoverGroupMsg"),o=(Ne.l("".concat(n," options:"),e),e.groupID),i=e.localLastMessageSequence,s=e.remoteLastMessageSequence,a=JSON.stringify(e),r=new so("_recoverGroupMsg");r.setMessage(a),this._getGroupRoamingMsg({groupID:o,sequence:i}).then((function(e){var c=(e=e.data).complete,u=e.messageList;if(!pt(u)){e=u[0].sequence;var l=u.map((function(e){return e.sequence})),d=(l="".concat(a," complete:").concat(c," sequenceList:").concat(l),Ne.l("".concat(n," ").concat(l)),e!==i&&e<s&&2!==c&&t._recoverGroupMsg({groupID:o,localLastMessageSequence:e,remoteLastMessageSequence:s}),r.setMessage(l).end(),t.get(7));1<u.length&&u.sort((function(e,t){return e.sequence-t.sequence}));for(var p=!1,_=0,h=u.length;_<h;_++)if(u[_].from===D.CONV_SYSTEM){p=!0;break}if(p)for(var g=0,f=u.length;g<f;g++){var m=u[g];m.from!==D.CONV_SYSTEM?d.onNewMessage({dataList:[m],isInstantMessage:!1,updateUnreadCount:!1}):d.onNewGroupTips({event:m.event,dataList:[m]})}else d.onNewMessage({dataList:u,isInstantMessage:!1,updateUnreadCount:!1})}})).catch((function(e){r.setError(e).end(),Ne.w("".concat(n," failed. error:"),e)}))}},{key:"_getGroupNotice",value:function(e){var t=e.length;if(Ne.l("".concat(this._n,"._getGroupNotice length:").concat(t)),0!==t){var n=this.get(7);if(t<=10)n.getNotice(e);else{var o=Math.floor(t/10);5<=o&&(o=5);for(var i=0;i<=o;i++)n.getNotice(e.slice(10*i,10*(i+1)))}}}},{key:"_getGroupRoamingMsg",value:function(e){var t=e.groupID;return e=e.sequence,this.req({P:Kn.GET_GRP_ROAMING_MSG,data:{groupID:t,count:this.PULL_LIMIT_COUNT,sequence:e+this.PULL_LIMIT_COUNT-1}})}},{key:"_recoverC2CMsg",value:function(e){var t=this,n="".concat(this._n,".").concat("_recoverC2CMsg"),o=(Ne.l("".concat(n," options:"),e),e.conversationID),i=e.localLastMessageTime,s=e.remoteLastMessageTime,a=JSON.stringify(e),r=new so("_recoverC2CMsg");return r.setMessage(a),this._getC2CRoamingMsg({conversationID:o,time:i}).then((function(e){var i=(e=e.data).complete;if(e=e.messageList,!pt(e)){var c=e.length;if(t.get(6).onNewMessage({dataList:e,isInstantMessage:!0}),c=e[c-1].time,e=e.map((function(e){return e.random})),e="".concat(a," complete:").concat(i," randomList:").concat(e),Ne.l("".concat(n," ").concat(e)),r.setMessage(e).end(),c<s&&1!==i)return t._recoverC2CMsg({conversationID:o,localLastMessageTime:c,remoteLastMessageTime:s})}})).catch((function(e){r.setError(e).end(),Ne.w("".concat(n," failed. error:"),e)}))}},{key:"_getC2CRoamingMsg",value:function(e){var t=e.conversationID;return e=e.time,this.req({P:Kn.GET_C2C_ROAMING_MSG,data:{peerAccount:t.replace(D.CONV_C2C,""),count:this.PULL_LIMIT_COUNT+1,lastMessageTime:e,direction:1}})}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset"))}}]),$r),Qa=(s(Zr,[{key:"addMessageDelay",value:function(e){0<=(e=De()-e)&&this._e2eDelayArray.push(e)}},{key:"_calcAvg",value:function(e,t){if(0===t)return 0;var n=0;return e.forEach((function(e){n+=e})),wt(n/t,1)}},{key:"_calcCountWithLimit",value:function(e){var t=e.e2eDelayArray,n=e.min,o=e.max;return t.filter((function(e){return n<=e&&e<o})).length}},{key:"_calcPercent",value:function(e,t){return 100<(e=wt(e/t*100,2))?100:e}},{key:"_checkE2EDelayException",value:function(e,t){var n,o,i,s=e.filter((function(e){return t<e}));0<s.length&&(n=s.length,o=Math.min.apply(Math,m(s)),i=Math.max.apply(Math,m(s)),s=this._calcAvg(s,n),50<(e=wt(n/e.length*100,2))&&new so("messageE2EDelayException").setMessage("count:".concat(n," min:").concat(o," max:").concat(i," avg:").concat(s," percent:").concat(e)).setLevel("warning").end())}},{key:"getStatResult",value:function(){var e=this._e2eDelayArray.length;if(0===e)return null;var t=m(this._e2eDelayArray),n=this._calcCountWithLimit({e2eDelayArray:t,min:0,max:1}),o=this._calcCountWithLimit({e2eDelayArray:t,min:1,max:3}),i=this._calcPercent(n,e),s=this._calcPercent(o,e),a=this._calcAvg(t,e);return this._checkE2EDelayException(t,3),t.length=0,this.reset(),{totalCount:e,countLessThan1Second:n,percentOfCountLessThan1Second:i,countLessThan3Second:o,percentOfCountLessThan3Second:s,avgDelay:a}}},{key:"reset",value:function(){this._e2eDelayArray.length=0}}]),Zr),Za=(s(Qr,[{key:"addRequestCount",value:function(){this._requestCount+=1}},{key:"addRTT",value:function(e){this._rttArray.push(e)}},{key:"_calcTotalCount",value:function(){return this._requestCount}},{key:"_calcRTTCount",value:function(e){return e.length}},{key:"_calcSuccessRateOfRequest",value:function(e,t){return 0===t?0:100<(e=wt(e/t*100,2))?100:e}},{key:"_calcAvg",value:function(e,t){if(0===t)return 0;var n=0;return e.forEach((function(e){n+=e})),parseInt(n/t)}},{key:"_calcMax",value:function(){return Math.max.apply(Math,m(this._rttArray))}},{key:"_calcMin",value:function(){return Math.min.apply(Math,m(this._rttArray))}},{key:"getStatResult",value:function(){var e=this._calcTotalCount(),t=m(this._rttArray);if(0===e)return null;var n=this._calcRTTCount(t),o=this._calcSuccessRateOfRequest(n,e);return t=this._calcAvg(t,n),Ne.l("".concat(this._n,".getStatResult max:").concat(this._calcMax()," min:").concat(this._calcMin()," avg:").concat(t)),this.reset(),{totalCount:e,rttCount:n,successRateOfRequest:o,avgRTT:t}}},{key:"reset",value:function(){this._requestCount=0,this._rttArray.length=0}}]),Qr),$a=(s(Xr,[{key:"initMap",value:function(e){var t=this;e.forEach((function(e){t._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})}))}},{key:"addTotalCount",value:function(e){return!(pt(e)||!this._map.has(e)||(this._map.get(e).totalCount+=1,0))}},{key:"addSuccessCount",value:function(e){return!(pt(e)||!this._map.has(e)||(this._map.get(e).successCount+=1,0))}},{key:"addFailedCountOfUserSide",value:function(e){return!(pt(e)||!this._map.has(e)||(this._map.get(e).failedCountOfUserSide+=1,0))}},{key:"addCost",value:function(e,t){return!(pt(e)||!this._map.has(e)||(this._map.get(e).costArray.push(t),0))}},{key:"addFileSize",value:function(e,t){return!(pt(e)||!this._map.has(e)||(this._map.get(e).fileSizeArray.push(t),0))}},{key:"_calcSuccessRateOfBusiness",value:function(e){return pt(e)||!this._map.has(e)?-1:100<(e=wt((e=this._map.get(e)).successCount/e.totalCount*100,2))?100:e}},{key:"_calcSuccessRateOfPlatform",value:function(e){if(pt(e)||!this._map.has(e))return-1;var t=this._map.get(e);return 100<(e=wt(e=this._calcSuccessCountOfPlatform(e)/t.totalCount*100,2))?100:e}},{key:"_calcTotalCount",value:function(e){return pt(e)||!this._map.has(e)?-1:this._map.get(e).totalCount}},{key:"_calcSuccessCountOfBusiness",value:function(e){return pt(e)||!this._map.has(e)?-1:this._map.get(e).successCount}},{key:"_calcSuccessCountOfPlatform",value:function(e){return pt(e)||!this._map.has(e)?-1:(e=this._map.get(e)).successCount+e.failedCountOfUserSide}},{key:"_calcAvg",value:function(e){return pt(e)||!this._map.has(e)?-1:e===Qn?this._calcAvgSpeed(e):this._calcAvgCost(e)}},{key:"_calcAvgCost",value:function(e){var t=this._map.get(e).costArray.length;if(0===t)return 0;var n=0;return this._map.get(e).costArray.forEach((function(e){n+=e})),parseInt(n/t)}},{key:"_calcAvgSpeed",value:function(e){var t=0,n=0;return this._map.get(e).costArray.forEach((function(e){t+=e})),this._map.get(e).fileSizeArray.forEach((function(e){n+=e})),parseInt(1e3*n/t)}},{key:"getStatResult",value:function(e){var t=this._calcTotalCount(e);if(0===t)return null;var n=this._calcSuccessCountOfBusiness(e),o=this._calcSuccessRateOfBusiness(e),i=this._calcSuccessCountOfPlatform(e),s=this._calcSuccessRateOfPlatform(e),a=this._calcAvg(e);return this.reset(e),{totalCount:t,successCountOfBusiness:n,successRateOfBusiness:o,successCountOfPlatform:i,successRateOfPlatform:s,avgValue:a}}},{key:"reset",value:function(e){pt(e)?this._map.clear():this._map.set(e,{totalCount:0,successCount:0,failedCountOfUserSide:0,costArray:[],fileSizeArray:[]})}}]),Xr),er=(s(zr,[{key:"initMap",value:function(e){var t=this;e.forEach((function(e){t._lastMap.set(e,new Map),t._currentMap.set(e,new Map)}))}},{key:"addMessageSequence",value:function(e){var t=e.key,n=e.message;if(pt(t)||!this._lastMap.has(t)||!this._currentMap.has(t))return!1;var o,i,s=n.conversationID;return n=n.sequence,s=s.replace(D.CONV_GROUP,""),0!==this._lastMap.get(t).size&&this._lastMap.get(t).has(s)?(i=(o=this._lastMap.get(t).get(s)).length-1,n>o[0]&&n<o[i]?(o.push(n),o.sort(),this._lastMap.get(t).set(s,o)):this._addCurrentMap(e)):this._addCurrentMap(e),!0}},{key:"_addCurrentMap",value:function(e){var t=e.key,n=(e=e.message).conversationID;e=e.sequence,n=n.replace(D.CONV_GROUP,""),this._currentMap.get(t).has(n)||this._currentMap.get(t).set(n,[]),this._currentMap.get(t).get(n).push(e)}},{key:"_copyData",value:function(e){if(!pt(e)){this._lastMap.set(e,new Map);var t,n=this._lastMap.get(e),o=T(this._currentMap.get(e));try{for(o.s();!(t=o.n()).done;){var i=f(t.value,2),s=i[0],a=i[1];n.set(s,a)}}catch(e){o.e(e)}finally{o.f()}n=null,this._currentMap.set(e,new Map)}}},{key:"getStatResult",value:function(e){if(pt(this._currentMap.get(e))||pt(this._lastMap.get(e)))return null;if(0===this._lastMap.get(e).size)return this._copyData(e),null;var t=0,n=0;if(this._lastMap.get(e).forEach((function(e,o){var i=(e=m(e.values())).length;e=e[i-1]-e[0]+1,t+=e,n+=i})),0===t)return null;var o=wt(n/t*100,2);return 100<o&&(o=100),this._copyData(e),{totalCount:t,successCountOfMessageReceived:n,successRateOfMessageReceived:o}}},{key:"reset",value:function(){this._currentMap.clear(),this._lastMap.clear()}}]),zr),tr=(r(Jr,bn),Ka=g(Jr),s(Jr,[{key:"_onLoginSuccess",value:function(){var e=this,t=(this._rateMessageSent.initMap(this._messageSentItems),this._rateMessageReceived.initMap(this._messageReceivedItems),this.get(13)),n=t.getItem(this.TAG,!1);!He(n)&&Ze(n.forEach)&&(Ne.l("".concat(this._n,"._onLoginSuccess. logs count:").concat(n.length)),n.forEach((function(t){e._statInfoArr.push(t)})),t.removeItem(this.TAG,!1))}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("q_rpt_interval"),t=this.getCloudConfig("q_rpt_sdkappid_bl"),n=this.getCloudConfig("q_rpt_tinyid_wl");pt(e)||(this.REPORT_INTERVAL=Number(e)),pt(t)||(this.REPORT_SDKAPPID_BLACKLIST=t.split(",").map((function(e){return Number(e)}))),pt(n)||(this.REPORT_TINYID_WHITELIST=n.split(","))}},{key:"onCheckTimer",value:function(e){this.isLoggedIn()&&e%this.REPORT_INTERVAL==0&&(this.wholePeriod=!0,this._report())}},{key:"addRequestCount",value:function(){this._avgRTT.addRequestCount()}},{key:"addRTT",value:function(e){this._avgRTT.addRTT(e)}},{key:"addMessageDelay",value:function(e){this._avgE2EDelay.addMessageDelay(e)}},{key:"addTotalCount",value:function(e){this._rateMessageSent.addTotalCount(e)||Ne.w("".concat(this._n,".addTotalCount invalid key:"),e)}},{key:"addSuccessCount",value:function(e){this._rateMessageSent.addSuccessCount(e)||Ne.w("".concat(this._n,".addSuccessCount invalid key:"),e)}},{key:"addFailedCountOfUserSide",value:function(e){this._rateMessageSent.addFailedCountOfUserSide(e)||Ne.w("".concat(this._n,".addFailedCountOfUserSide invalid key:"),e)}},{key:"addCost",value:function(e,t){this._rateMessageSent.addCost(e,t)||Ne.w("".concat(this._n,".addCost invalid key or cost:"),e,t)}},{key:"addFileSize",value:function(e,t){this._rateMessageSent.addFileSize(e,t)||Ne.w("".concat(this._n,".addFileSize invalid key or size:"),e,t)}},{key:"addMessageSequence",value:function(e){this._rateMessageReceived.addMessageSequence(e)||Ne.w("".concat(this._n,".addMessageSequence invalid key:"),e.key)}},{key:"_getQualityItem",value:function(e){var n={},o=oo[this.get(15).getNetworkType()];switch(pt(o)&&(o=8),o={qualityType:to[e],timestamp:Le(),networkType:o,extension:""},e){case Wn:n=this._avgRTT.getStatResult();break;case Yn:n=this._avgE2EDelay.getStatResult();break;case jn:case Jn:case zn:case Xn:case Qn:n=this._rateMessageSent.getStatResult(e);break;case Zn:case $n:case eo:n=this._rateMessageReceived.getStatResult(e)}return null===n?null:t(t({},o),n)}},{key:"_report",value:function(e){var t=this,n=[],o=null,i=(pt(e)?this._qualityItems.forEach((function(e){null!==(o=t._getQualityItem(e))&&(o.reportIndex=t.reportIndex,o.wholePeriod=t.wholePeriod,n.push(o))})):null!==(o=this._getQualityItem(e))&&(o.reportIndex=this.reportIndex,o.wholePeriod=this.wholePeriod,n.push(o)),Ne.d("".concat(this._n,"._report"),n),0<this._statInfoArr.length&&(n=n.concat(this._statInfoArr),this._statInfoArr=[]),e=this.get(12)).getSDKAppID();e=e.getTinyID(),0<(n=Ft(this.REPORT_SDKAPPID_BLACKLIST,i)&&!qt(this.REPORT_TINYID_WHITELIST,e)?[]:n).length&&this._doReport(n)}},{key:"_doReport",value:function(e){var n=this,o={header:_s(this),quality:e};this.req({P:Kn.SSO_STAT,data:t({},o)}).then((function(){n.reportIndex++,n.wholePeriod=!1})).catch((function(t){Ne.w("".concat(n._n,"._doReport failed. error:"),t),n._statInfoArr=n._statInfoArr.concat(e),n._flushAtOnce()}))}},{key:"_flushAtOnce",value:function(){var e=this.get(13),t=e.getItem(this.TAG,!1),n=this._statInfoArr,o="".concat(this._n,"._flushAtOnce");He(t)?(Ne.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)):(10<(n=n.concat(t)).length&&(n=n.slice(0,10)),Ne.l("".concat(o," count:").concat(n.length)),e.setItem(this.TAG,n,!0,!1)),this._statInfoArr=[]}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._report(),this.reportIndex=0,this.wholePeriod=!1,this.REPORT_SDKAPPID_BLACKLIST=[],this.REPORT_TINYID_WHITELIST=[],this._avgRTT.reset(),this._avgE2EDelay.reset(),this._rateMessageSent.reset(),this._rateMessageReceived.reset()}}]),Jr),nr=s((function e(t){o(this,e),He(t)||(this.userID=t.userID||"",this.nick=t.nick||"",this.avatar=t.avatar||"",this.time=t.time||0,this.source=t.source||"",this.wording=t.wording||"",this.type=t.type||"")})),or=(s(jr,[{key:"getLocalApplicationList",value:function(){return{friendApplicationList:m(this._map.values()),unreadCount:this._unreadCount}}},{key:"_onApplicationListUpdated",value:function(){this._snsM.emitOEvt(E.FRIEND_APPLICATION_LIST_UPDATED,{friendApplicationList:m(this._map.values()),unreadCount:this._unreadCount})}},{key:"onApplicationRead",value:function(){this._unreadCount=0,this._onApplicationListUpdated()}},{key:"onApplicationAdded",value:function(e,n){var o,i,s=this;He(e)||(o="",o=n===this._snsM.getMyUserID()?D.SNS_APPLICATION_SENT_BY_ME:D.SNS_APPLICATION_SENT_TO_ME,i=!1,e.forEach((function(e){var n="".concat(e.userID,"_").concat(o);o!==D.SNS_APPLICATION_SENT_TO_ME||s._map.has(n)||(s._unreadCount+=1),s._map.set(n,new nr(t(t({},e),{},{type:o}))),i=!0})),i&&this._onApplicationListUpdated())}},{key:"onApplicationDeleted",value:function(e){He(e)||(this._startTime=0,this._currentSeq=0,this.getApplicationList())}},{key:"getApplicationList",value:function(){var e=this,t="".concat(this._n,".").concat("getApplicationList"),n=new so("getApplicationList");return this._snsM.req({P:Kn.GET_FD_APPLICATION_LIST,data:{applicationType:D.SNS_APPLICATION_TYPE_BOTH,fromAccount:this._snsM.getMyUserID(),maxLimited:this._maxLimited,startTime:this._startTime,lastSequence:this._currentSeq}}).then((function(o){var i=(o=o.data).resultList,s=o.unreadCount,a=o.startTime,r=(o=o.currentSequence,e._startTime=a,e._currentSeq=o,e._unreadCount=s,Xe(i)?i.length:0);r="applicationCount:".concat(r," unreadCount:").concat(s," startTime:").concat(a," currentSequence:").concat(o),n.setMessage(r).end(),Ne.i("".concat(t," ok. ").concat(r)),e._map.clear(),Xe(i)&&i.forEach((function(t){var n=t.userID,o=t.type;t=new nr(t),e._map.set("".concat(n,"_").concat(o),t)})),e._onApplicationListUpdated()})).catch((function(e){return n.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"deleteApplication",value:function(e){var t="".concat(this._n,".").concat("deleteApplication"),n=e.userID,o=e.type;if(o&&(o===D.SNS_APPLICATION_SENT_BY_ME||o===D.SNS_APPLICATION_SENT_TO_ME)||(o=D.SNS_APPLICATION_SENT_TO_ME),!this._map.has("".concat(n,"_").concat(o)))return Rn({code:Bn.FRIEND_APPLICATION_NOT_EXIST});var i=new so("deleteApplication");return i.setMessage("userID:".concat(n," type:").concat(o)),this._snsM.req({P:Kn.DEL_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),userIDList:[n],type:o}}).then((function(e){var s=(r=(e=e.data.resultList)[0]).to,a=r.resultCode,r=r.resultInfo;return i.setMoreMessage("resultList:".concat(JSON.stringify(e))).end(),Ne.i("".concat(t," ok. userID:").concat(n," type:").concat(o)),0===a?En():Rn({userID:s,code:a,message:r})})).catch((function(e){return i.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"acceptApplication",value:function(e){var t="".concat(this._n,".").concat("acceptApplication"),n=e.userID,o=e.remark,i=e.tag,s=e.type,a=(s&&(s===D.SNS_APPLICATION_AGREE||s===D.SNS_APPLICATION_AGREE_AND_ADD)||(s=D.SNS_APPLICATION_AGREE_AND_ADD),new so("acceptApplication"));return a.setMessage("userID:".concat(n," type:").concat(s)),this._snsM.req({P:Kn.RESPOND_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),responseFriendItem:[{userID:n,remark:o,tag:i,action:s}]}}).then((function(e){a.end();var o=(e=e.data.resultList[0]).resultCode;if(e=e.resultInfo,0!==o)return Rn({code:o,message:e});Ne.i("".concat(t," ok. userID:").concat(n," type:").concat(s))})).catch((function(e){return a.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"refuseApplication",value:function(e){var t="".concat(this._n,".").concat("refuseApplication"),n=e.userID,o=new so("refuseApplication");return o.setMessage("userID:".concat(n)),this._snsM.req({P:Kn.RESPOND_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),responseFriendItem:[{userID:n,action:"Response_Action_Reject"}]}}).then((function(e){o.end();var i=(e=e.data.resultList[0]).resultCode;if(e=e.resultInfo,0!==i)return Rn({code:i,message:e});Ne.i("".concat(t," ok. userID:").concat(n))})).catch((function(e){return o.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"setApplicationRead",value:function(){var e=this,t="".concat(this._n,".").concat("setApplicationRead"),n=new so("setApplicationRead");return this._snsM.req({P:Kn.REPORT_FD_APPLICATION,data:{fromAccount:this._snsM.getMyUserID(),latestTimeStamp:wt(Le()/1e3,0)}}).then((function(o){n.end(),Ne.i("".concat(t," ok")),e._unreadCount=0})).catch((function(e){return n.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"reset",value:function(){this._maxLimited=100,this._currentSeq=0,this._unreadCount=0,this._map.clear()}}]),jr),ir=(s(Yr,[{key:"validate",value:function(e){var t,n=!0,o="";if(He(e))return{valid:!1,tips:"empty options"};if(e.profileCustomField)for(var i=e.profileCustomField.length,s=null,a=0;a<i;a++){if(s=e.profileCustomField[a],!dt(s.key)||-1===s.key.indexOf("Tag_Profile_Custom"))return{valid:!1,tips:"The prefix of keys of the custom profile key-value pairs (which is profileCustomField) must be Tag_Profile_Custom"};if(!dt(s.value))return{valid:!1,tips:"The type of values of the custom profile key-value pairs (which is profileCustomField) must be String"}}for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if("profileCustomField"===t)continue;if(He(e[t])&&!dt(e[t])&&!je(e[t])){o="key:"+t+", invalid value:"+e[t],n=!1;continue}switch(t){case"nick":dt(e[t])||(n=!(o="nick must be a string")),500<it(e[t])&&(o="nick name limited: must less than or equal to ".concat(500," bytes, current size: ").concat(it(e[t])," bytes"),n=!1);break;case"gender":rt(be,e.gender)||(o="key:gender, invalid value:"+e.gender,n=!1);break;case"birthday":je(e.birthday)||(n=!(o="birthday must be a number"));break;case"location":dt(e.location)||(n=!(o="location must be a string"));break;case"selfSignature":dt(e.selfSignature)||(n=!(o="selfSignature must be a string"));break;case"allowType":rt(Fe,e.allowType)||(o="key:allowType, invalid value:"+e.allowType,n=!1);break;case"language":je(e.language)||(n=!(o="language must be a number"));break;case"avatar":dt(e.avatar)||(n=!(o="avatar must be a string"));break;case"messageSettings":0!==e.messageSettings&&1!==e.messageSettings&&(n=!(o="messageSettings must be 0 or 1"));break;case"adminForbidType":rt(we,e.adminForbidType)||(o="key:adminForbidType, invalid value:"+e.adminForbidType,n=!1);break;case"level":je(e.level)||(n=!(o="level must be a number"));break;case"role":je(e.role)||(n=!(o="role must be a number"));break;default:o="unknown key:"+t+"  "+e[t],n=!1}}return{valid:n,tips:o}}},{key:"update",value:function(e){var t,n="",o=[];this.friendCustomField.forEach((function(e){o.push(e.key)}));for(var i=0,s=e.length;i<s;i++)if(n=e[i].tag,t=e[i].value,-1<n.indexOf("Tag_SNS_Custom"))-1<o.indexOf(n)?this.friendCustomField.forEach((function(e){e.key===n&&(e.value=t)})):this.friendCustomField.push({key:n,value:t});else if(-1<n.indexOf("Tag_Profile_Custom")){var a=!1;this.profile.profileCustomField.forEach((function(e){e.key===n&&(e.value=t,a=!0)})),a||this.profile.profileCustomField.push({key:n,value:t})}else switch(n){case Ge.NICK:this.profile.nick=t;break;case Ge.GENDER:this.profile.gender=t;break;case Ge.BIRTHDAY:this.profile.birthday=t;break;case Ge.LOCATION:this.profile.location=t;break;case Ge.SELFSIGNATURE:this.profile.selfSignature=t;break;case Ge.ALLOWTYPE:this.profile.allowType=t;break;case Ge.LANGUAGE:this.profile.language=t;break;case Ge.AVATAR:this.profile.avatar=t;break;case Ge.MESSAGESETTINGS:this.profile.messageSettings=t;break;case Ge.ADMINFORBIDTYPE:this.profile.adminForbidType=t;break;case Ge.LEVEL:this.profile.level=t;break;case Ge.ROLE:this.profile.role=t;break;case Ue.REMARK:this.remark=t;break;case Ue.ADDTIME:this.addTime=t;break;case Ue.GROUP:this.groupList=JSON.parse(JSON.stringify(t));break;case Ue.ADDSOURCE:this.source=t;break;case Ue.ADDWORDING:break;default:Ne.d("snsProfileItem unkown tag->",e[i].tag)}this.timestamp=Date.now(),o.length=0}},{key:"updateProfile",value:function(e){this.profile=JSON.parse(JSON.stringify(e)),this.timestamp=Date.now()}},{key:"addToGroupList",value:function(e){-1===this.groupList.indexOf(e)&&(this.groupList.push(e),this.count=this.groupList.length)}},{key:"removeFromGroupList",value:function(e){-1<(e=this.groupList.indexOf(e))&&(this.groupList.splice(e,1),this.count=this.groupList.length)}}]),Yr),sr=(s(Wr,[{key:"getLocalFriendList",value:function(){return m(this._map.values())}},{key:"getFriendRemark",value:function(e){return this._map.has(e)?this._map.get(e).remark:""}},{key:"onFriendProfileModified",value:function(e){var t,n=this;He(e=e.dataList)||(t=this._snsM.get(11),e.forEach((function(e){var o,i=e.userID;e=e.profileList,n.isMyFriend(i)&&(Ne.l("".concat(n._n,".onFriendProfileModified. friend account:").concat(i,", profileList:").concat(JSON.stringify(e))),(o=n._map.get(i)).update(e),t.modifyMessageSentByPeer({conversationID:"".concat(D.CONV_C2C).concat(i),latestNick:o.profile.nick,latestAvatar:o.profile.avatar}))})),this._onFriendListUpdated())}},{key:"onFriendAdded",value:function(e){var t=this;0!==e.length&&(Ne.l("".concat(this._n,".onFriendAdded userIDList:").concat(e)),e.forEach((function(e){t._map.set(e,new ir(e))})),this.getFriendProfile({userIDList:e}).then((function(n){e.forEach((function(e){var n=t._map.get(e);0<n.groupList.length&&t._snsM.updateWhenFriendAdded({nameList:n.groupList,userID:e})})),t._onFriendListUpdated()})))}},{key:"onFriendDeleted",value:function(e){var t=this;0!==e.length&&(Ne.l("".concat(this._n,".onFriendDeleted userIDList:").concat(e)),e.forEach((function(e){var n=t._map.get(e);0<n.groupList.length&&t._snsM.updateWhenFriendDeleted({nameList:n.groupList,userID:e}),t._map.delete(e)})),this._onFriendListUpdated())}},{key:"_onFriendListUpdated",value:function(){this._snsM.emitOEvt(E.FRIEND_LIST_UPDATED),this._snsM.get(11).checkAndPatchRemark()}},{key:"getFriendProfile",value:function(e){var t=this,n="".concat(this._n,".").concat("getFriendProfile"),o=(e=e.userIDList,[]),i=[],s=[];if(e.forEach((function(e){var n;t._map.has(e)?(n=t._map.get(e),Date.now()-n.timestamp<t._expirationTime?i.push(n):s.push(e)):o.push({userID:e,code:Bn.NOT_MY_FRIEND,message:t._snsM.getErrMsg(Bn.NOT_MY_FRIEND)})})),0===s.length)return Ne.i("".concat(n," newUserIDList is empty")),Dn({friendList:i,failureUserIDList:o});var a=new so("getFriendProfile");return a.setMessage("userIDList:".concat(s)),Ne.i("".concat(n," userIDList:").concat(s)),this._snsM.req({P:Kn.GET_FD_PROFILE,data:{fromAccount:this._snsM.getMyUserID(),userIDList:s}}).then((function(e){return a.end(),Ne.i("".concat(n," ok")),e.data.resultList.forEach((function(e){var n,s=e.to,a=e.resultCode,r=e.resultInfo;e=e.tagValueList,pt(a)||0===a?(t._map.has(s)?(n=t._map.get(s)).update(e):(n=new ir(s,e),t._map.set(s,n)),i.push(n)):o.push({userID:s,code:a,message:r})})),En({friendList:i,failureUserIDList:o})})).catch((function(e){return a.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"isMyFriend",value:function(e){return this._map.has(e)}},{key:"pagingGetFriendList",value:function(){var e=this,t="".concat(this._n,".").concat("getFriendList"),n=new so("getFriendList"),o=Date.now();this._snsM.req({P:Kn.GET_FD_LIST,data:{fromAccount:this._snsM.getMyUserID(),startIndex:this._startIdx,standardSequence:this._standardSeq,customSequence:this._customSeq}}).then((function(i){var s=(i=i.data).friendCount,a=i.resultList,r=i.nextStartIndex,c=i.standardSequence,u=i.customSequence;i=i.completeFlag,e._startIdx=r,e._standardSeq=c,e._customSeq=u,s="friendCount:".concat(s," nextStartIndex:").concat(r," standardSequence:").concat(c," ")+"customSequence:".concat(u," completeFlag:").concat(i," cost:").concat(Jt(o)),n.setMessage(s).end(),Ne.i("".concat(t," ok."),s),He(a)||a.forEach((function(t){var n=t.to;t=t.tagValueList,e._map.set(n,new ir(n,t))})),0===i?e.pagingGetFriendList():(e._snsM.emitOEvt(E.FRIEND_LIST_UPDATED),e._pagingGetFriendProfile())})).catch((function(e){return n.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"_pagingGetFriendProfile",value:function(){var e=this,t=m(this._map.keys()),n=this._snsM.get(4),o=t.length,i=o<=100?1:Math.ceil(o/100);Ne.l("".concat(this._n,"._pagingGetFriendProfile friendCount:").concat(o," pageCount:").concat(i));for(var s=0;s<i;s++)n.getUserProfile({userIDList:t.slice(100*s,100*(s+1))}).then((function(t){t.data.forEach((function(t){var n=e._map.get(t.userID);n&&n.updateProfile(t)})),e._onFriendListUpdated()}))}},{key:"addFriend",value:function(e){var t=this,n="".concat(this._n,".").concat("addFriend");if(this._map.has(e.to))return Rn({code:Bn.ALREADY_MY_FRIEND});if(e.wording&&!1===this._snsM.filterProfanity("wording",e))return Rn({code:Bn.PROFANITY_FOUND});var o=e.to,i=e.source,s=e.type,a=e.wording,r=e.remark,c=(e=e.groupName,s),u=(c&&(c===D.SNS_ADD_TYPE_SINGLE||c===D.SNS_ADD_TYPE_BOTH)||(c=D.SNS_ADD_TYPE_BOTH),new so("addFriend"));return u.setMessage("to:".concat(o," source:").concat(i," type:").concat(c)),this._snsM.req({P:Kn.ADD_FD,data:{fromAccount:this._snsM.getMyUserID(),addFriendItem:[{to:o,source:i,wording:a,remark:r,groupName:e}],type:c}}).then((function(e){e=e.data.resultList;var o=(u.setMoreMessage("resultList:".concat(JSON.stringify(e))).end(),e=e[0]).to,i=e.resultCode;return e=e.resultInfo,Ne.i("".concat(n," ok. to:").concat(o," type:").concat(c," code:").concat(i)),pt(i)||0===i?En({userID:o,code:0}):30539===i?En({userID:o,code:i,message:t._snsM.getErrMsg(i)}):Rn({userID:o,code:i,message:t._snsM.getErrMsg(i)||e})})).catch((function(e){return u.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"deleteFriend",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteFriend"),o=e.userIDList,i=(e=e.type,1e3<o.length&&(Ne.w("".concat(n," ").concat(Wt(1e3))),o.length=1e3),[]),s=[],a=[];if(o.forEach((function(e){t._map.has(e)?a.push(e):i.push({userID:e,code:Bn.NOT_MY_FRIEND,message:t._snsM.getErrMsg(Bn.NOT_MY_FRIEND)})})),0===a.length)return Dn({successUserIDList:s,failureUserIDList:i});var r=((o=e)&&(o===D.SNS_DELETE_TYPE_SINGLE||o===D.SNS_DELETE_TYPE_BOTH)||(o=D.SNS_DELETE_TYPE_BOTH),new so("deleteFriend"));return r.setMessage("userIDList:".concat(a," type:").concat(o)),this._snsM.req({P:Kn.DEL_FD,data:{fromAccount:this._snsM.getMyUserID(),userIDList:a,type:o}}).then((function(e){return r.end(),Ne.i("".concat(n," ok")),He(e=e.data.resultList)||e.forEach((function(e){var t=e.to,n=e.resultCode;e=e.resultInfo,pt(n)||0===n?s.push({userID:t}):i.push({userID:t,code:n,message:e})})),En({successUserIDList:s,failureUserIDList:i})})).catch((function(e){return r.setError(e).end(),Ne.w("".concat(n," error:"),e),Rn(e)}))}},{key:"updateFriend",value:function(e){var t=this,n=e.userID,o=e.remark,i=e.friendCustomField;if(!this._map.has(n))return Rn({code:Bn.NOT_MY_FRIEND});var s="".concat(this._n,".").concat("updateFriend"),a=new so("updateFriend"),r=(a.setMessage("userID:".concat(n," remark:").concat(o," friendCustomField:").concat(i)),[]);return pt(o)||r.push({tag:Ue.REMARK,value:o}),Xe(i)&&0<i.length&&i.forEach((function(e){r.push({tag:e.key,value:e.value})})),this._snsM.req({P:Kn.UPDATE_FD,data:{fromAccount:this._snsM.getMyUserID(),updateItem:[{to:n,snsItem:r}]}}).then((function(e){a.end(),Ne.i("".concat(s," ok"));var n=(e=e.data.resultList[0]).to,r=e.resultCode;return e=e.resultInfo,pt(r)||0===r?((n=t._map.get(n))&&(pt(o)||(n.remark=o),Xe(i)&&0<i.length&&It(n.friendCustomField,i),t._onFriendListUpdated()),En(n)):Rn({code:r,message:e})})).catch((function(e){return a.setError(e).end(),Ne.w("".concat(s," failed. error:"),e),Rn(e)}))}},{key:"checkFriend",value:function(e){var t="".concat(this._n,".").concat("checkFriend"),n=e.userIDList,o=e.type,i=(o&&(o===D.SNS_CHECK_TYPE_SINGLE||o===D.SNS_CHECK_TYPE_BOTH)||(o=D.SNS_CHECK_TYPE_BOTH),new so("checkFriend"));return i.setMessage("userIDList:".concat(n," type:").concat(o)),this._snsM.req({P:Kn.CHECK_FD,data:{fromAccount:this._snsM.getMyUserID(),userIDList:n,type:o}}).then((function(e){i.end(),Ne.i("".concat(t," ok. userIDList:").concat(n," type:").concat(o));var s=[],a=[];return Xe(e=e.data.resultList)&&e.forEach((function(e){var t=e.to,n=e.relation,o=e.resultCode;e=e.resultInfo,pt(o)||0===o?s.push({userID:t,code:0,relation:n}):a.push({userID:t,code:o,message:e})})),En({successUserIDList:s,failureUserIDList:a})})).catch((function(e){return i.setError(e).end(),Ne.w("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"onAddedToFriendGroup",value:function(e){var t=this,n=e.name;e=e.userIDList,Ne.l("".concat(this._n,".onAddedToFriendGroup groupName:").concat(n," userIDList:").concat(e)),n&&!He(e)&&e.forEach((function(e){t._map.has(e)&&t._map.get(e).addToGroupList(n)}))}},{key:"onRemovedFromFriendGroup",value:function(e){var t=this,n=e.name;e=e.userIDList,Ne.l("".concat(this._n,".onRemovedFromFriendGroup groupName:").concat(n," userIDList:").concat(e)),n&&!He(e)&&e.forEach((function(e){t._map.has(e)&&t._map.get(e).removeFromGroupList(n)}))}},{key:"reset",value:function(){this._map.clear(),this._startIdx=0,this._standardSeq=0,this._customSeq=0}}]),Wr),ar=(s(Kr,[{key:"addToUserIDList",value:function(e){-1===this.userIDList.indexOf(e)&&(this.userIDList.push(e),this.count=this.userIDList.length)}},{key:"removeFromUserIDList",value:function(e){-1<(e=this.userIDList.indexOf(e))&&(this.userIDList.splice(e,1),this.count=this.userIDList.length)}}]),Kr),rr=(s(Hr,[{key:"getLocalGroupList",value:function(){return m(this._map.values())}},{key:"_onGroupListUpdated",value:function(){var e=m(this._map.values());this._snsM.emitOEvt(E.FRIEND_GROUP_LIST_UPDATED,e)}},{key:"getGroupList",value:function(){var e=this,t="".concat(this._n,".").concat("getGroupList"),n=new so("getGroupList");return this._snsM.req({P:Kn.GET_FD_GRP_LIST,data:{fromAccount:this._snsM.getMyUserID()}}).then((function(o){n.end(),He(o=o.data.resultList)?Ne.i("".concat(t," ok. count:0")):(Ne.i("".concat(t," ok. count:").concat(o.length)),e._map.clear(),o.forEach((function(t){var n=new ar(t);e._map.set(t.name,n)})),e._onGroupListUpdated())})).catch((function(e){return n.setError(e).end(),Ne.w("".concat(t," error:"),e),Rn(e)}))}},{key:"createGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("createGroup"),o=e.name;if(e=e.userIDList,this._map.has(o))return Rn({code:Bn.FRIEND_GRP_EXISTED});var i="name:".concat(o," userIDList:").concat(e),s=new so("createGroup");return s.setMessage(i),this._snsM.req({P:Kn.CREATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),groupName:[o],userIDList:Xe(e)?e:void 0}}).then((function(e){s.end(),Ne.l("".concat(n," ok. ").concat(i)),e=e.data.resultList;var a=[],r=[];return e&&e.forEach((function(e){var t=e.to,n=e.resultCode,o=e.resultInfo;pt(n)||0===n?a.push(t):(t={userID:e.to,code:n,message:o},r.push(t))})),e=new ar({name:o,userIDList:a}),t._map.set(o,e),t._snsM.onAddedToFriendGroup({name:o,userIDList:a}),t._onGroupListUpdated(),En({friendGroup:e,failureUserIDList:r})})).catch((function(e){return s.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"deleteGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("deleteGroup"),o=e.name;if(!this._map.has(o))return this._onGroupNotExist();var i="name:".concat(o),s=new so("deleteGroup");return s.setMessage(i),this._snsM.req({P:Kn.DEL_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),nameList:[o]}}).then((function(e){s.end(),Ne.l("".concat(n," ok. ").concat(i));var a=t._map.get(o);return a&&(t._snsM.onRemovedFromFriendGroup({name:o,userIDList:a.userIDList}),t._map.delete(o),a.userIDList.length=0),t._onGroupListUpdated(),En(a)})).catch((function(e){return s.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"renameGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("renameGroup"),o=e.oldName,i=e.newName;if(!this._map.has(o))return this._onGroupNotExist();var s="oldName:".concat(o," newName:").concat(i),a=new so("renameGroup");return a.setMessage(s),this._snsM.req({P:Kn.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,newName:i}}).then((function(){var e;return a.end(),Ne.l("".concat(n," ok. ").concat(s)),t._map.has(o)?((e=t._map.get(o)).name=i,t._map.delete(o),t._map.set(i,e),t._snsM.onRemovedFromFriendGroup({name:o,userIDList:e.userIDList}),t._snsM.onAddedToFriendGroup({name:i,userIDList:e.userIDList}),t._onGroupListUpdated(),En(e)):En()})).catch((function(e){return a.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"addToGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("addToGroup"),o=e.name;if(e=e.userIDList,!this._map.has(o))return this._onGroupNotExist();var i="name:".concat(o," userIDList:").concat(e),s=new so("addToGroup");return s.setMessage(i),this._snsM.req({P:Kn.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,updateGroupItem:e.filter((function(e){return t._snsM.isMyFriend(e)})).map((function(e){return{to:e,updateType:"Update_Type_Add"}}))}}).then((function(e){return s.end(),Ne.l("".concat(n," ok. ").concat(i)),t._onGroupUpdated(o,e)})).catch((function(e){return s.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"removeFromGroup",value:function(e){var t=this,n="".concat(this._n,".").concat("removeFromGroup"),o=e.name;if(e=e.userIDList,!this._map.has(o))return this._onGroupNotExist();var i="name:".concat(o," userIDList:").concat(e),s=new so("removeFromGroup");return s.setMessage(i),this._snsM.req({P:Kn.UPDATE_FD_GRP,data:{fromAccount:this._snsM.getMyUserID(),oldName:o,updateGroupItem:e.filter((function(e){return t._snsM.isMyFriend(e)})).map((function(e){return{to:e,updateType:"Update_Type_Delete"}}))}}).then((function(e){return s.end(),Ne.l("".concat(n," ok. ").concat(i)),t._onGroupUpdated(o,e)})).catch((function(e){return s.setError(e).end(),Ne.w("".concat(n," failed. error:"),e),Rn(e)}))}},{key:"_onGroupUpdated",value:function(e,t){t=t.data.resultList;var n=this._map.get(e),o=[],i=[],s=[];return Xe(t)&&t.forEach((function(e){var t=e.to,a=e.resultCode,r=e.resultInfo,c=e.type;0===a?"Update_Type_Add"===c?n&&(n.addToUserIDList(t),i.push(t)):"Update_Type_Delete"===c&&n&&(n.removeFromUserIDList(t),s.push(t)):o.push({to:e.to,code:a,message:r})})),Ne.l("".concat(this._n,"._onGroupUpdated name:").concat(e," userIDList:").concat(n.userIDList)),0<i.length&&this._snsM.onAddedToFriendGroup({name:e,userIDList:i}),0<s.length&&this._snsM.onRemovedFromFriendGroup({name:e,userIDList:s}),En({friendGroup:n,failureUserIDList:o})}},{key:"updateWhenFriendAdded",value:function(e){var t=this,n=e.nameList,o=e.userID;Ne.l("".concat(this._n,".updateWhenFriendAdded userID:").concat(o," nameList:").concat(n)),He(n)||n.forEach((function(e){t._map.has(e)&&t._map.get(e).addToUserIDList(o)}))}},{key:"updateWhenFriendDeleted",value:function(e){var t=this,n=e.nameList,o=e.userID;Ne.l("".concat(this._n,".updateWhenFriendDeleted userID:").concat(o," nameList:").concat(n)),He(n)||n.forEach((function(e){t._map.has(e)&&t._map.get(e).removeFromUserIDList(o)}))}},{key:"_onGroupNotExist",value:function(e){return Rn({code:Bn.FRIEND_GRP_NOT_EXIST})}},{key:"reset",value:function(){this._map.clear()}}]),Hr),cr=(r(Br,bn),Ha=g(Br),s(Br,[{key:"onContextUpdated",value:function(e){this._friendHandler.pagingGetFriendList(),this._friendGroupHandler.getGroupList(),this._friendApplicationHandler.getApplicationList()}},{key:"onRelationChainModified",value:function(e){var t,n,o,i,s,a,r=this;He(e=e.dataList)||(t=[],n=[],o=[],s=!(i=[]),a="",e.forEach((function(e){var c;3!==e.pushType&&4!==e.pushType||!e.from||(a=e.from),e.friendAddAccount&&(t.push.apply(t,m(e.friendAddAccount)),i.push.apply(i,m(e.friendAddAccount))),e.friendDelAccount&&n.push.apply(n,m(e.friendDelAccount)),e.friendApplicationAdded&&o.push.apply(o,m(e.friendApplicationAdded)),e.friendApplicationDeletedUserIDList&&i.push.apply(i,m(e.friendApplicationDeletedUserIDList)),e.reportTime&&7===e.pushType&&(s=!0),e.friendUpInfo&&(c={dataList:[]},e.friendUpInfo.forEach((function(e){c.dataList.push({userID:e.friendAccount,profileList:m(e.sns)})})),r.onFriendProfileModified(c))})),s&&this._friendApplicationHandler.onApplicationRead(),this._friendApplicationHandler.onApplicationAdded(o,a),this._friendApplicationHandler.onApplicationDeleted(i),this._friendHandler.onFriendAdded(t),this._friendHandler.onFriendDeleted(n))}},{key:"isMyFriend",value:function(e){return this._friendHandler.isMyFriend(e)}},{key:"filterProfanity",value:function(e,t){if(!(o=this.get(29)))return!0;var n=(o=o.filterText(t[e],"sns")).isAllowedToSend,o=o.modifiedText;return!0===n&&(t[e]=o,!0)}},{key:"onFriendProfileModified",value:function(e){this._friendHandler.onFriendProfileModified(e)}},{key:"getLocalFriendList",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],t=this._friendHandler.getLocalFriendList();return e?Dn(t):t}},{key:"getFriendRemark",value:function(e){return this._friendHandler.getFriendRemark(e)}},{key:"getFriendList",value:function(){return this._friendHandler.pagingGetFriendList()}},{key:"addFriend",value:function(e){return this._friendHandler.addFriend(e)}},{key:"deleteFriend",value:function(e){return this._friendHandler.deleteFriend(e)}},{key:"checkFriend",value:function(e){return this._friendHandler.checkFriend(e)}},{key:"getFriendProfile",value:function(e){return this._friendHandler.getFriendProfile(e)}},{key:"updateFriend",value:function(e){return this._friendHandler.updateFriend(e)}},{key:"onAddedToFriendGroup",value:function(e){this._friendHandler.onAddedToFriendGroup(e)}},{key:"onRemovedFromFriendGroup",value:function(e){this._friendHandler.onRemovedFromFriendGroup(e)}},{key:"getLocalFriendApplicationList",value:function(){return Dn(this._friendApplicationHandler.getLocalApplicationList())}},{key:"deleteFriendApplication",value:function(e){return this._friendApplicationHandler.deleteApplication(e)}},{key:"refuseFriendApplication",value:function(e){return this._friendApplicationHandler.refuseApplication(e)}},{key:"acceptFriendApplication",value:function(e){return this._friendApplicationHandler.acceptApplication(e)}},{key:"setFriendApplicationRead",value:function(e){return this._friendApplicationHandler.setApplicationRead(e)}},{key:"getLocalFriendGroupList",value:function(){return Dn(this._friendGroupHandler.getLocalGroupList())}},{key:"createFriendGroup",value:function(e){return this._friendGroupHandler.createGroup(e)}},{key:"deleteFriendGroup",value:function(e){return this._friendGroupHandler.deleteGroup(e)}},{key:"addToFriendGroup",value:function(e){return this._friendGroupHandler.addToGroup(e)}},{key:"removeFromFriendGroup",value:function(e){return this._friendGroupHandler.removeFromGroup(e)}},{key:"renameFriendGroup",value:function(e){return this._friendGroupHandler.renameGroup(e)}},{key:"updateWhenFriendAdded",value:function(e){this._friendGroupHandler.updateWhenFriendAdded(e)}},{key:"updateWhenFriendDeleted",value:function(e){this._friendGroupHandler.updateWhenFriendDeleted(e)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._friendHandler.reset(),this._friendGroupHandler.reset(),this._friendApplicationHandler.reset()}}]),Br),ur=(r(Vr,bn),Ba=g(Vr),s(Vr,[{key:"isWorkerEnabled",value:function(){return this._isWorkerEnabled&&ge}},{key:"startWorkerTimer",value:function(){Ne.l("".concat(this._n,".startWorkerTimer")),this._workerTimer&&this._workerTimer.postMessage("start")}},{key:"stopWorkerTimer",value:function(){Ne.l("".concat(this._n,".stopWorkerTimer")),this._workerTimer&&this._workerTimer.postMessage("stop")}},{key:"_init",value:function(){var e,t;ge&&(e=URL.createObjectURL(new Blob(['let interval = -1;onmessage = function(event) {  if (event.data === "start") {    if (interval > 0) {      clearInterval(interval);    }    interval = setInterval(() => {      postMessage("");    }, 1000);    postMessage(interval);  } else if (event.data === "stop") {    clearInterval(interval);    interval = -1;  }};'],{type:"application/javascript; charset=utf-8"})),this._workerTimer=new Worker(e),(t=this)._workerTimer.onmessage=function(e){e.data?(t._timerID=e.data,Ne.l("".concat(t._n,"._init seed:").concat(t._timerID))):t._m.onCheckTimer()})}},{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("enable_worker");Ne.l("".concat(this._n,"._onCloudConfig enableWorker:").concat(e)),pt(e)||"1"===e?!this._isWorkerEnabled&&ge&&(this._isWorkerEnabled=!0,this.startWorkerTimer(),this._m.onWorkerTimerEnabled()):this._isWorkerEnabled&&ge&&(this._isWorkerEnabled=!1,this.stopWorkerTimer(),this._m.onWorkerTimerDisabled())}},{key:"terminate",value:function(){Ne.l("".concat(this._n,".terminate")),this._workerTimer&&(this._workerTimer.terminate(),this._workerTimer=null,this._timerID=-1)}},{key:"getTimerID",value:function(){return this._timerID}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset"))}}]),Vr),lr=(s(xr,[{key:"isValidPurchaseBits",value:function(e){return e&&"string"==typeof e&&1<=e.length&&e.length<=64&&/[01]{1,64}/.test(e)}},{key:"parsePurchaseBits",value:function(e){if(this.isValidPurchaseBits(e)){this._featureMap.clear();for(var t,n=e.length-1,o=0;0<=n;n--,o++)t=(o<32?new L(0,Math.pow(2,o)):new L(Math.pow(2,o-32),0)).toString(),"1"===e[n]?this._featureMap.set(t,!0):this._featureMap.set(t,!1)}else Ne.w("".concat(this._n,".parsePurchaseBits invalid purchasebits:").concat(e))}},{key:"hasPurchasedFeature",value:function(e){return!!this._featureMap.get(e)}},{key:"isFeatureEnabled",value:function(e){for(var t=parseInt(e).toString(2),n=void 0,o=!0,i=t.length-1,s=0;0<=i;i--,s++)if("1"===t.charAt(i)&&(n=(s<32?new L(0,Math.pow(2,s)):new L(Math.pow(2,s-32),0)).toString(),!this._featureMap.get(n))){o=!1;break}return Ne.l("".concat(this._n,".isFeatureEnabled decimalNumber:").concat(e," key:").concat(n," ret:").concat(o)),Dn({enabled:o})}},{key:"isFeatureEnabledForStat",value:function(e){for(var t=parseInt(e).toString(2),n=t.length-1,o=0;0<=n;n--,o++)if("1"===t.charAt(n)){if(i=(o<32?new L(0,Math.pow(2,o)):new L(Math.pow(2,o-32),0)).toString(),!this._featureMap.get(i))break;var i,s="",a=0;i===U.PLUGIN_TRANSLATE?(s="plugin_translate",a=16):i===U.PLUGIN_VOICE_TO_TEXT?(s="plugin_voice_to_text",a=17):i===U.PLUGIN_CS?(s="plugin_cs",a=14):i===U.PLUGIN_PUSH?(s="plugin_push",a=13):i===U.PLUGIN_BOT?(s="plugin_bot",a=15):i===U.MSG_REACTION&&(s="plugin_emoji_reaction",a=18),""!==s&&(i=this._commercialConfigM.get(12).getUIPlatform(),new so(s).setCode(a).setUIPlatform(i).end(),Ne.l("".concat(this._n,".isFeatureEnabledForStat ").concat(s," code:").concat(a," uiPlatform:").concat(i)))}}},{key:"isCSPluginEnabled",value:function(){var e;this._isCSPluginReported||(e=this._commercialConfigM.get(12).getUIPlatform(),new so("plugin_search").setCode(6).setUIPlatform(e).end(),this._isCSPluginReported=!0)}},{key:"clear",value:function(){this._featureMap.clear(),this._isCSPluginReported=!1}}]),xr),dr=(s(qr,[{key:"_canFetch",value:function(){return this.get(12).isLoggedIn()?!this._isFetching&&Date.now()>=this._expiredTime:(this._expiredTime=Date.now()+2e3,!1)}},{key:"onCheckTimer",value:function(e){this._canFetch()&&this.fetchConfig()}},{key:"fetchConfig",value:function(){var e,t,n=this,o=this._canFetch(),i="".concat(this._n,".fetchConfig");Ne.l("".concat(i," canFetch:").concat(o)),o&&(e=new so("fetchCommercialConfig"),o=this.get(12).getSDKAppID(),t=this.get(20),this._isFetching=!0,t.req({P:Kn.FETCH_COMMERCIAL_CONFIG,data:{SDKAppID:o}}).then((function(t){e.setMessage("purchaseBits:".concat(t.data.purchaseBits)).end(),Ne.l("".concat(i," ok.")),n._parseConfig(t.data),n._isFetching=!1})).catch((function(t){e.setError(t).end(),n._isFetching=!1})))}},{key:"onPushedConfig",value:function(e){var t="".concat(this._n,".onPushedConfig data:").concat(JSON.stringify(e));Ne.l("".concat(t)),new so("pushedCommercialConfig").setMessage("purchaseBits:".concat(e.purchaseBits)).end(),this._parseConfig(e)}},{key:"_parseConfig",value:function(e){var t="".concat(this._n,"._parseConfig"),n=e.errorCode,o=e.errorMessage,i=e.purchaseBits,s=e.expiredTime;0===n?(this._purchasedFeatureHandler.parsePurchaseBits(i),this._expiredTime=Date.now()+1e3*s):pt(n)?(Ne.l("".concat(t," failed. Invalid message format:"),e),this._setExpiredTimeOnResponseError(36e5)):(Ne.e("".concat(t," errorCode:").concat(n," errorMessage:").concat(o)),this._setExpiredTimeOnResponseError(12e4))}},{key:"_setExpiredTimeOnResponseError",value:function(e){this._expiredTime=Date.now()+e}},{key:"canIUse",value:function(e){return this._purchasedFeatureHandler.hasPurchasedFeature(e)}},{key:"isFeatureEnabled",value:function(e){return this._purchasedFeatureHandler.isFeatureEnabled(e)}},{key:"isFeatureEnabledForStat",value:function(e){this._purchasedFeatureHandler.isFeatureEnabledForStat(e)}},{key:"isCSPluginEnabled",value:function(){this._purchasedFeatureHandler.isCSPluginEnabled()}},{key:"get",value:function(e){return this._m.get(e)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler.clear()}}]),qr),pr=(r(Fr,bn),Va=g(Fr),s(Fr,[{key:"registerPlugin",value:function(e){var t,n,o,i,s,a,r,c,u,l,d,p,_;z?(this._offlinePushPlugin=e["tim-offline-push-plugin"],t=(_=e.offlinePushConfig||{}).huaweiBusinessID,n=_.xiaomiBusinessID,o=_.xiaomiAppID,i=_.xiaomiAppKey,s=_.meizuBusinessID,a=_.meizuAppID,r=_.meizuAppKey,c=_.vivoBusinessID,u=_.oppoBusinessID,l=_.oppoAppKey,d=_.oppoAppSecret,p=_.honorBusinessID,_=_.iosBusinessID,this._androidPushConfig.huaweiPushBussinessId=t,this._androidPushConfig.xiaomiPushBussinessId=n,this._androidPushConfig.xiaomiPushAppId=o,this._androidPushConfig.xiaomiPushAppKey=i,this._androidPushConfig.meizuPushBussinessId=s,this._androidPushConfig.meizuPushAppId=a,this._androidPushConfig.meizuPushAppKey=r,this._androidPushConfig.vivoPushBussinessId=c,this._androidPushConfig.oppoPushBussinessId=u,this._androidPushConfig.oppoPushAppKey=l,this._androidPushConfig.oppoPushAppSecret=d,this._androidPushConfig.honorPushBussinessId=p,new so("registerPlugin").setMessage("tim-offline-push-plugin").setMoreMessage("isExist:".concat(!pt(this._offlinePushPlugin))).end(!0),Ne.l("".concat(this._n,".").concat("registerPlugin"," ok. offlinePushConfig:").concat(JSON.stringify(e.offlinePushConfig))),this._iosBusinessID=_,this._setAppShowListener()):this.warn("OfflinePushInUniapp")}},{key:"init",value:function(){this._isWebUniapp=this.getUniAppPlatform(),this._getDeviceToken()}},{key:"_getDeviceToken",value:function(){var e,t=this,n="".concat(this._n,".").concat("_getDeviceToken");Ze(this._offlinePushPlugin.getDeviceToken)?(e="androidPushConfig:".concat(JSON.stringify(this._androidPushConfig),", iosBusinessID:").concat(this._iosBusinessID),Ne.l("".concat(n," start. ").concat(e)),new so("_getDeviceToken").setMessage("".concat(e)).end(!0),this._offlinePushPlugin.getDeviceToken(this._androidPushConfig,(function(o){var i,s,a,r,c=new so("getDeviceTokenRes"),u=o.code,l=o.msg;0===u?(i=(r=o.data).deviceToken,s=r.deviceBrand,a=r.deviceType,r=r.bussinessId,t._deviceToken=i,t._businessID=r||t._iosBusinessID,e="deviceToken:".concat(i,", deviceBrand:").concat(s||a,", businessID:").concat(t._businessID),Ne.l("".concat(n," ok. ").concat(e)),c.setMessage(e).end(!0),t._setToken()):(c.setMessage("code:".concat(u,", msg:").concat(l)).end(!0),Ne.e("".concat(n," failed. error:"),o))}))):Ne.e("".concat(n," getDeviceToken is not a function"))}},{key:"canIUseOfflinePush",value:function(){return z&&!pt(this._offlinePushPlugin)}},{key:"_setAppShowListener",value:function(){var e=this,t="".concat(this._n,".").concat("_setAppShowListener");pt(this._offlinePushPlugin)?Ne.e("".concat(t," offlinePushPlugin is undefined")):Ze(this._offlinePushPlugin.setAppShowListener)?(new so("_setAppShowListener").end(!0),Ne.l("".concat(t," start")),this._offlinePushPlugin.setAppShowListener((function(n){n=(n||{}).appShow,new so("setAppShowListenerRes").setMessage("appShow:".concat(n)).end(!0),Ne.l("".concat(t," ok. appShow:").concat(n)),e._m.isReady()&&(0===n?(e._getConvUnreadCount(),e._onBackground()):1===n&&e._onForeground())}))):Ne.e("".concat(t," setAppShowListener is not a function"))}},{key:"getDeviceBrand",value:function(){var e;if(!pt(this._offlinePushPlugin)&&Ze(this._offlinePushPlugin.getDeviceType))return e=(this._offlinePushPlugin.getDeviceType()||{}).deviceType,Ne.l("".concat(this._n,".getDeviceBrand ok. deviceType:").concat(e)),e}},{key:"_setToken",value:function(){var e="".concat(this._n,"._setToken"),t=this.get(12),n=1,o="",i="",s=(He(this._deviceToken)&&(n=0),this.getUniAppPlatform()),a=this.getDeviceBrand(),r=(s===k.IOS||s===k.IPAD||s===k.MAC?i=this._deviceToken:s===k.ANDROID&&(o=this._deviceToken),new so("offlinePushSetToken"));return s="deviceToken:".concat(i||o,", businessID:").concat(this._businessID,", ")+"deviceBrand:".concat(a,", isWebUniapp:").concat(this._isWebUniapp,", pushMsg:").concat(n,", platform:").concat(s),r.setMessage("".concat(s)),Ne.l("".concat(e," ").concat(s)),this.req({P:Kn.SET_TOKEN,data:{tokenID:o,pushMsg:n,sdkAppID:t.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:a,deviceToken:i,isWebUniapp:this._isWebUniapp}}).then((function(t){return r.end(),Ne.l("".concat(e," ok")),t})).catch((function(t){return r.setError(t).end(),Ne.e("".concat(e," failed. error:"),t),Rn(t)}))}},{key:"_getConvUnreadCount",value:function(){var e=this;this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(11).getLocalConvList().forEach((function(t){t.type===D.CONV_C2C&&(e._c2cUnreadCount+=t.unreadCount),t.type===D.CONV_GROUP&&(e._groupUnreadCount+=t.unreadCount)}))}},{key:"_onBackground",value:function(){var e=this,t="".concat(this._n,".").concat("_onBackground"),n=new so("_onBackground");this.req({P:Kn.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then((function(o){return n.setMessage("c2cUnreadCount: ".concat(e._c2cUnreadCount,", groupUnreadCount: ").concat(e._groupUnreadCount)).end(),Ne.l("".concat(t," ok")),o})).catch((function(e){n.setError(e).end(),Ne.e("".concat(t," failed. error:"),e)}))}},{key:"_onForeground",value:function(){var e="".concat(this._n,".").concat("_onForeground"),t=new so("_onForeground");this.req({P:Kn.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then((function(n){return t.end(),Ne.l("".concat(e," ok")),n})).catch((function(n){t.setError(n).end(),Ne.e("".concat(e," failed. error:"),n)}))}},{key:"getUniAppPlatform",value:function(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?k.IOS:"android"===e?k.ANDROID:1002===t?k.IPAD:1001===t?k.MAC:void 0}},{key:"reset",value:function(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,Ne.l("".concat(this._n,".reset"))}}]),Fr),_r=(r(wr,bn),xa=g(wr),s(wr,[{key:"registerPlugin",value:function(e){var t,n,o;z?(t="".concat(this._n,".").concat("registerPlugin"),this._pushPlugin=e["tim-push"],this._getDeviceInfo(),n=(o=e.pushConfig||{}).androidConfig,o=o.iOSConfig,Je(n)&&(this._androidPushConfig=n[this._deviceInfo.packageName]),n=(o||{}).iOSBusinessID,this._iOSBusinessID=n,o=!pt(this._pushPlugin),new so("registerPlugin").setMessage(this._pluginName).setMoreMessage("isExisted:".concat(o)).end(!0),Ne.l("".concat(t," ok. pushConfig:").concat(JSON.stringify(e.pushConfig))),o?(this._setAppShowListener(),this._setPushEventReportListener()):Ne.e("".concat(t," ").concat(this._pluginName," is undefined"))):this.warn("TIMPushInUniapp")}},{key:"init",value:function(){this._isWebUniapp=this.getUniAppPlatform(),this._reportEventCacheList(),this._getDeviceToken(),this.get(27).isFeatureEnabledForStat(Math.pow(2,41))}},{key:"_reportEventCacheList",value:function(){var e=this,n="".concat(this._n,".").concat("_reportEventCacheList");Ze(this._pushPlugin.getPushEventCacheList)?(new so("_reportEventCacheList").end(!0),this._pushPlugin.getPushEventCacheList((function(o){var i=o.code,s=o.data.eventList,a=new so("getPushEventCacheListRes");if(a.setCode(i),0!==i)a.setMessage("res:".concat(JSON.stringify(o))).end(!0),Ne.e("".concat(n," failed. error:").concat(JSON.stringify(o)));else{i=s.length<10?"eventList:".concat(JSON.stringify(s)):"eventList.length:".concat(s.length),Ne.l("".concat(n," ok. ").concat(i)),a.setMessage(i).end(!0);for(var r=t(t({},o.data),{},{eventList:[]});0<s.length;)r.eventList=s.splice(0,40),e._pushReport(r)}}))):Ne.e("".concat(this._pluginName,".getPushEventCacheList is not a function"))}},{key:"_getDeviceToken",value:function(){var e,t=this,n="".concat(this._n,".").concat("_getDeviceToken");Ze(this._pushPlugin.getDeviceToken)?(e="androidPushConfig:".concat(JSON.stringify(this._androidPushConfig)," iOSBusinessID:").concat(this._iOSBusinessID),Ne.l("".concat(n," start. ").concat(e)),new so("_getDeviceToken").setMessage("".concat(e)).end(!0),this._pushPlugin.getDeviceToken(this._androidPushConfig,(function(o){var i,s,a,r=o.code,c=o.msg,u=new so("getDeviceTokenRes");if(u.setCode(r),0===r)return i=(r=o.data).deviceToken,s=r.deviceBrand,a=r.deviceType,r=r.bussinessId,t._deviceToken=i,t._businessID=r||t._iOSBusinessID,e="deviceToken:".concat(i," deviceBrand:").concat(s||a," businessID:").concat(t._businessID),Ne.l("".concat(n," ok. ").concat(e)),u.setMessage(e).end(!0),void t._setToken();u.setMessage(c).end(!0),Ne.e("".concat(n," failed. error:").concat(JSON.stringify(o)))}))):Ne.e("".concat(this._pluginName,".getDeviceToken is not a function"))}},{key:"_getDeviceInfo",value:function(){var e="".concat(this._n,".").concat("_getDeviceInfo");if(Ze(this._pushPlugin.getDeviceInfo)){var n=this._pushPlugin.getDeviceInfo(),o=n.code,i=n.data,s=new so("_getDeviceInfo");if(s.setCode(o),0===o)return this._deviceInfo=t(t({},this._deviceInfo),i),this._deviceInfo.pushVersion||(this._deviceInfo.pushVersion="1.0.1"),o="deviceInfo:".concat(JSON.stringify(this._deviceInfo)),Ne.l("".concat(e," ok. ").concat(o)),void s.setMessage(o).end(!0);s.setMessage("deviceInfoRes:".concat(JSON.stringify(n))).end(!0),Ne.e("".concat(e," failed. error:").concat(JSON.stringify(n)))}else Ne.e("".concat(this._pluginName,".getDeviceInfo is not a function"))}},{key:"canIUseTIMPush",value:function(){return z&&!pt(this._pushPlugin)}},{key:"_setAppShowListener",value:function(){var e=this,t="".concat(this._n,".").concat("_setAppShowListener");Ze(this._pushPlugin.setAppShowListener)?(new so("_setAppShowListener").end(!0),Ne.l("".concat(t," start")),this._pushPlugin.setAppShowListener((function(n){n=(n||{}).appShow,new so("setAppShowListenerRes").setMessage("appShow:".concat(n)).end(!0),Ne.l("".concat(t," ok. appShow:").concat(n)),e._m.isReady()&&(0===n?(e._getConvUnreadCount(),e._onBackground()):1===n&&e._onForeground())}))):Ne.e("".concat(this._pluginName,".setAppShowListener is not a function"))}},{key:"_setPushEventReportListener",value:function(){var e=this,t="".concat(this._n,".").concat("_setPushEventReportListener");Ze(this._pushPlugin.setPushEventReportListener)?(new so("_setPushEventReportListener").end(!0),this._pushPlugin.setPushEventReportListener((function(n){var o=n.code,i=n.data,s=i.eventList,a=new so("setPushEventReportListenerRes");if(a.setCode(o),0===o)return o="eventList:".concat(JSON.stringify(s)),Ne.l("".concat(t," ok. ").concat(o)),a.setMessage(o).end(!0),void(e._m.isReady()&&Xe(s)&&0<s.length&&e._pushReport(i));a.setMessage("res:".concat(JSON.stringify(n))).end(!0),Ne.e("".concat(t," failed. error:").concat(JSON.stringify(n)))}))):Ne.e("".concat(this._pluginName,".setPushEventReportListener is not a function"))}},{key:"getDeviceBrand",value:function(){var e;if(!pt(this._pushPlugin)&&Ze(this._pushPlugin.getDeviceType))return e=(this._pushPlugin.getDeviceType()||{}).deviceType,Ne.l("".concat(this._n,".getDeviceBrand ok. deviceType:").concat(e)),e}},{key:"_setToken",value:function(){var e="".concat(this._n,".").concat("_setToken"),n=this.get(12),o=1,i="",s="",a=(He(this._deviceToken)&&(o=0),this.getUniAppPlatform()),r=this.getDeviceBrand(),c=(a===k.IOS||a===k.IPAD||a===k.MAC?s=this._deviceToken:a===k.ANDROID&&(i=this._deviceToken),a=t({tokenID:i,pushMsg:o,sdkAppID:n.getSDKAppID(),businessID:parseInt(this._businessID),deviceBrand:r,deviceToken:s,isWebUniapp:this._isWebUniapp},this._deviceInfo),new so("_setToken"));i="data:".concat(JSON.stringify(a)),c.setMessage("".concat(i)),Ne.l("".concat(e," ").concat(i)),this.req({P:Kn.SET_TOKEN,data:a}).then((function(){c.end(),Ne.w("".concat(e," ok"))})).catch((function(t){c.setError(t).end(),Ne.e("".concat(e," failed. error:"),t),Rn(t)}))}},{key:"_getConvUnreadCount",value:function(){var e=this;this._c2cUnreadCount=0,this._groupUnreadCount=0,this.get(11).getLocalConvList().forEach((function(t){t.type===D.CONV_C2C&&(e._c2cUnreadCount+=t.unreadCount),t.type===D.CONV_GROUP&&(e._groupUnreadCount+=t.unreadCount)}))}},{key:"_onBackground",value:function(){var e=this,t="".concat(this._n,".").concat("_onBackground"),n=new so("_onBackground");this.req({P:Kn.STAT_BACKGROUND,data:{c2cUnreadCount:this._c2cUnreadCount,groupUnreadCount:this._groupUnreadCount,isWebUniapp:this._isWebUniapp}}).then((function(){n.setMessage("c2cUnreadCount:".concat(e._c2cUnreadCount," groupUnreadCount:").concat(e._groupUnreadCount)).end(),Ne.l("".concat(t," ok"))})).catch((function(e){n.setError(e).end(),Ne.e("".concat(t," failed. error:"),e)}))}},{key:"_onForeground",value:function(){var e="".concat(this._n,".").concat("_onForeground"),t=new so("_onForeground");this.req({P:Kn.STAT_FOREGROUND,data:{isWebUniapp:this._isWebUniapp}}).then((function(){t.end(),Ne.l("".concat(e," ok"))})).catch((function(n){t.setError(n).end(),Ne.e("".concat(e," failed. error:"),n)}))}},{key:"_pushReport",value:function(e){var t=this,n="".concat(this._n,".").concat("_pushReport"),o=new so("_pushReport");this.req({P:Kn.PUSH_REPORT,data:{eventList:e.eventList}}).then((function(){o.end(),t._notifyReportSuccess(e)})).catch((function(e){o.setError(e).end(),Ne.e("".concat(n," failed. error:"),e)}))}},{key:"_notifyReportSuccess",value:function(e){!pt(this._pushPlugin)&&Ze(this._pushPlugin.notifyReportSuccess)&&(this._pushPlugin.notifyReportSuccess(e),Ne.l("".concat(this._n,"._notifyReportSuccess ok")))}},{key:"getUniAppPlatform",value:function(){var e=uni.getSystemInfoSync().platform,t=this.getDeviceBrand();return"ios"===e?k.IOS:"android"===e?k.ANDROID:1002===t?k.IPAD:1001===t?k.MAC:void 0}},{key:"reset",value:function(){this._deviceToken="",this._businessID=0,this._c2cUnreadCount=0,this._groupUnreadCount=0,this._isWebUniapp=0,Ne.l("".concat(this._n,".reset"))}}]),wr),hr=(r(br,bn),qa=g(br),s(br,[{key:"init",value:function(){var e=this.get(18).getPlugin("tim-profanity-filter-plugin");e&&(this._plugin=new e({logger:Ne,isArray:Xe,isMap:Ke,isDevMode:this.isDevMode()}),this._getLexicon())}},{key:"onCheckTimer",value:function(){this._plugin&&this._canIUseLexicon&&this.isLoggedIn()&&!this._isFetching&&Date.now()>=this._expiredTime&&this._getLexicon()}},{key:"filterMessage",value:function(e,t){var n=!0;if(!this._plugin||!this._canIUseLexicon)return n;if(t&&t.messageControlInfo&&!0===t.messageControlInfo.excludedFromContentModeration)return n;t=e.type;var o=e.conversationType;if(t!==D.MSG_TEXT&&t!==D.MSG_CUSTOM)return n;var i,s="".concat(this._n,".filterMessage");if(Ne.l("".concat(s)),t===D.MSG_TEXT){if(o===D.CONV_C2C?i="c2c_text_message":o===D.CONV_GROUP&&(i="group_text_message"),!this._isConfigOn(i))return n;var a=(r=this._plugin.filter(e.payload.text)).type,r=r.modifiedText;1===a?n=!1:2===a&&(e.payload.text=r)}else if(t===D.MSG_CUSTOM){if(o===D.CONV_C2C?i="c2c_custom_message":o===D.CONV_GROUP&&(i="group_custom_message"),!this._isConfigOn(i))return n;a=this._plugin.filter(e.payload.data),r=this._plugin.filter(e.payload.description),t=this._plugin.filter(e.payload.extension),1===a.type||1===r.type||1===t.type?n=!1:(2===a.type&&(e.payload.data=a.modifiedText),2===r.type&&(e.payload.description=r.modifiedText),2===t.type&&(e.payload.extension=t.modifiedText))}return Ne.l("".concat(s," done. isAllowedToSend:").concat(n)),n}},{key:"filterText",value:function(e,t){var n="".concat(this._n,".filterText"),o={isAllowedToSend:!0,modifiedText:e};return this._plugin&&this._canIUseLexicon&&this._isConfigOn(t)?(Ne.l("".concat(n)),e=(t=this._plugin.filter(e)).type,t=t.modifiedText,1===e?o.isAllowedToSend=!1:2===e&&(o.modifiedText=t),Ne.l("".concat(n," done. ret:"),o),o):o}},{key:"_getLexicon",value:function(){var e=this,t=new so("profanityFilter"),n="".concat(this._n,"._getLexicon");this._isFetching=!0,this.req({P:Kn.GET_PROFANITY_LIST,data:{startIndex:this._startIndex,version:this._version}}).then((function(o){var i=(o=o.data).errorInfo,s=o.filterConfig,a=o.lexicon,r=o.strToken,c=o.completeFlag,u=o.nextStartIndex,l=o.version,d=(o=o.expiredTime,i.errorCode),p=i.errorMessage;return 0!==d?(e._isFetching=!1,Ne.w("".concat(n," failed. error:"),i),void t.setCode(d).setMessage(p).end()):(e._onFilterConfig(s),e._getToken(r),1===c?(Ne.l("".concat(n," done. version:").concat(l," expiredTime:").concat(o)),e._version=l,e._canIUseLexicon=!0,e._isFetching=!1,e._expiredTime=Date.now()+1e3*o,void e._plugin.onLexiconCompleted(a)):(e._startIndex=u,e._plugin.onLexiconSliced(a),void e._getLexicon()))})).catch((function(o){t.setError(o).end(),e._isFetching=!1,Ne.l("".concat(n," failed. error:"),o)}))}},{key:"_onFilterConfig",value:function(e){var t=this;He(e)||(this._filterConfigMap.clear(),Object.keys(e).forEach((function(n){t._filterConfigMap.set(n,e[n])})),Ne.l("".concat(this._n,"._onFilterConfig. keys:").concat(Array.from(this._filterConfigMap.keys())," values:").concat(Array.from(this._filterConfigMap.values()))))}},{key:"_isConfigOn",value:function(e){return 1===this._filterConfigMap.get(e)}},{key:"_getToken",value:function(e){if(dt(e)){var t=e.length,n="";if(t%2==0)for(var o=0;o<=t-1;o+=2)n=(n+=e[o+1])+e[o];else{for(var i=0;i<t-1;i+=2)n=(n+=e[i+1])+e[i];n+=e[t-1]}this._plugin.onToken(n)}}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._plugin&&(this._plugin.reset(),this._plugin=null),this._filterConfigMap.clear(),this._startIndex=0,this._version=0,this._canIUseLexicon=!1,this._isFetching=!1,this._expiredTime=0}}]),br),gr=(s(Ur,[{key:"_onCloudConfig",value:function(){var e=this,t=this._m.get(23).getCloudConfig("rtc_cmd");pt(t)||((t=JSON.parse(t)).forEach((function(t){e._TRTCCommandList.includes(t)||e._TRTCCommandList.push(t)})),this._setTRTCCommandMap())}},{key:"_setTRTCCommandMap",value:function(){for(var e,t=0,n=this._TRTCCommandList.length;t<n;t++)e=this._TRTCCommandList[t].split(".")[0],this._TRTCCommandMap.set(e,1)}},{key:"onRoomCustomDataReceived",value:function(e){this._m.getOEmitInst().emit(E.ROOM_CUSTOM_DATA_RECEIVED,e)}},{key:"sendTRTCCustomData",value:function(e){var t=e.serviceCommand,n=(e=e.data,"".concat(G.NAME.TUIROOM_SVR,".*"));return pt(t)||(n=t),this._isValidServiceCommand(n)?this._trans({servcmd:n,data:e}):Rn({code:Bn.INVALID_TRTC_CMD})}},{key:"_trans",value:function(e){Ne.d("".concat(this._n,"._trans. options:").concat(JSON.stringify(e)));var t=e.servcmd;return e=e.data,this._m.get(20).trans({servcmd:t,data:dt(e)?JSON.parse(e):e})}},{key:"_isValidServiceCommand",value:function(e){return e.endsWith(".*")?this._TRTCCommandList.includes(e):(e=e.split(".")[0],this._TRTCCommandMap.has(e))}},{key:"isTRTCCommand",value:function(e){return e=e.split(".")[0],this._TRTCCommandMap.has(e)}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset"))}}]),Ur),fr=(s(Gr,[{key:"_init",value:function(){var e,t=this._getStorageModule().getItem(this.TIM_ERROR_ASSISTANCE,!1);if(t){try{e=JSON.parse(t)}catch(e){this._getStorageModule().removeItem(this.TIM_ERROR_ASSISTANCE,!1),Ne.w("".concat(this._n,"._init error:"),e)}e&&(this._needToUpdate(e)?this._fetch():this._fillMap(e.message))}else this._fetch()}},{key:"_needToUpdate",value:function(e){var t=e.localSavedTime;return e=e.localSavedVersion,t=t&&(new Date).getTime()-t>=this.STORAGE_EXPIRES_TIME,e=!e||"3.5.2"!==e,Ne.l("".concat(this._n,"._needToUpdate isTimeout:").concat(t," isDifferentVersion:").concat(e)),t||e}},{key:"_fetch",value:function(){var e,t,n,o,i,s;this._m.get(12).isPrivateNetWork()||(e="https://web.sdk.qcloud.com/im/download/error-message/v3/0.0.7/tim-error-message.txt",t="application/x-www-form-urlencoded;charset=UTF-8",n="".concat(this._n,"._fetch ok in"),o=this,Z?ne.request({url:e,method:"GET",timeout:3e3,header:{"content-type":t},dataType:"text",success:function(e){o._fillAndSave(e.data),Ne.l("".concat(n," mini program"))},fail:function(){}}):(i=new XMLHttpRequest,s=setTimeout((function(){i.abort()}),3e3),i.onreadystatechange=function(){4===i.readyState&&(s&&clearTimeout(s),200!==i.status&&304!==i.status||(Ne.l("".concat(n," browser")),o._fillAndSave(i.responseText)))},i.open("GET",e,!0),i.setRequestHeader("Content-type",t),i.send()))}},{key:"_fillAndSave",value:function(e){this._fillMap(e),this._getStorageModule().setItem(this.TIM_ERROR_ASSISTANCE,JSON.stringify({message:e,localSavedTime:(new Date).getTime(),localSavedVersion:"3.5.2"}),!0,!1)}},{key:"_getStorageModule",value:function(){return this._m.get(13)}},{key:"_fillMap",value:function(e){this._map.clear();for(var t,n,o=e.split(";\n"),i=o.length,s=new RegExp(/'/g),a=0;a<i;a++)if(n=o[a].indexOf(":"),t=o[a].slice(0,n),n=o[a].slice(n+1,o[a].length),!t.startsWith("//")){if(pt(n))continue;this._map.set(t,n.replace(s,""))}}},{key:"get",value:function(e){var t=e.isIntl,n=e.key,o=e.replacement1;return e=e.replacement2,t="".concat(n,t?"_en":"_cn"),!this._map.has(t)&&this._map.has(n)&&(t=n),n="",this._map.has(t)&&(n=this._map.get(t),pt(o)||(n=n.replace("$replacement1",o)),pt(e)||(n=n.replace("$replacement2",e))),n}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset"))}}]),Gr),mr=(s(Pr,[{key:"onNewMessageList",value:function(e){var t=this;e.forEach((function(e){var n=t.getPayloadData(e);n&&t._handleActionType(n,e)}))}},{key:"onMessageModified",value:function(e){var t=this;e.forEach((function(e){var n=t.getPayloadData(e);n&&t._onInvitationModified(n,e)}))}},{key:"getPayloadData",value:function(e){var t="".concat(this._n,".getPayloadData");e=e.payload.data;try{return JSON.parse(e)}catch(s){return Ne.e("".concat(t," JSON parse error. signalingData:").concat(e)),null}}},{key:"_handleActionType",value:function(e,t){switch(e.actionType){case R.ACTION_TYPE_INVITE:this._onNewInvitationReceived(e,t);break;case R.ACTION_TYPE_REJECT_INVITE:this._onInviteeRejected(e);break;case R.ACTION_TYPE_ACCEPT_INVITE:this._onInviteeAccepted(e);break;case R.ACTION_TYPE_CANCEL_INVITE:this._onInvitationCancelled(e);break;case R.ACTION_TYPE_INVITE_TIMEOUT:this._onInvitationTimeout(e)}}},{key:"_genBaseEmitData",value:function(e){return{inviteID:e.inviteID,inviter:e.inviter,groupID:e.groupID,data:e.data||""}}},{key:"_onNewInvitationReceived",value:function(e,n){var o="".concat(this._n,"._onNewInvitationReceived"),i=e.inviteID,s=e.inviteeList,a=e.groupID,r=e.inviter,c=this._sigM.getMyUserID(),u=s.includes(c),l=e.timeout,d=(Te().getTime()-1e3*n.time)/1e3;0<l&&0<d&&d<l&&(l-=d),o="".concat(o," myselfIncluded:").concat(u," groupID:").concat(a," signalObj:").concat(JSON.stringify(e)),Ne.l("".concat(o," timeout:").concat(l,"s delta:").concat(d,"s")),(a&&u||!a)&&((o=this._sigM.getInviteInfo(i))&&o===e||(o||this._sigM.setInviteInfo(i,t(t({},e),{},{message:n})),this._sigM.emitEvent(R.NEW_INVITATION_RECEIVED,t(t({},this._genBaseEmitData(e)),{},{inviteeList:s})),r!==c&&this._sigM.startTimer(t(t({},e),{},{timeout:l}))))}},{key:"_onInviteeRejected",value:function(e){var n="".concat(this._n,"._onInviteeRejected"),o=e.inviteID,i=e.inviter,s=e.groupID,a=this._sigM.hasInviteInfo(o);Ne.l("".concat(n," inviteID:").concat(o," hasInviteID:").concat(a," inviter:").concat(i," groupID:").concat(s)),a&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(R.INVITEE_REJECTED,t(t({},this._genBaseEmitData(e)),{},{invitee:e.inviteeList[0]})))}},{key:"_onInviteeAccepted",value:function(e){var n="".concat(this._n,"._onInviteeAccepted"),o=e.inviteID,i=e.inviter,s=e.groupID,a=this._sigM.hasInviteInfo(o);Ne.l("".concat(n," inviteID:").concat(o," hasInviteID:").concat(a," inviter:").concat(i," groupID:").concat(s)),a&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(R.INVITEE_ACCEPTED,t(t({},this._genBaseEmitData(e)),{},{invitee:e.inviteeList[0]})))}},{key:"_onInvitationCancelled",value:function(e){var t="".concat(this._n,"._onInvitationCancelled"),n=e.inviteID,o=e.inviter,i=e.groupID,s=this._sigM.hasInviteInfo(n);Ne.l("".concat(t," inviteID:").concat(n," hasInviteID:").concat(s," inviter:").concat(o," groupID:").concat(i)),s&&(this._sigM.deleteInviteInfo(n),this._sigM.emitEvent(R.INVITATION_CANCELLED,this._genBaseEmitData(e)))}},{key:"_onInvitationTimeout",value:function(e){var n="".concat(this._n,"._onInvitationTimeout"),o=e.inviteID,i=e.inviter,s=e.groupID,a=e.inviteeList,r=this._sigM.hasInviteInfo(o);Ne.l("".concat(n," inviteID:").concat(o," hasInviteID:").concat(r," inviter:").concat(i," groupID:").concat(s,"  data:").concat(e.data)),r&&(this._sigM.updateInviteInfo(e),this._sigM.emitEvent(R.INVITATION_TIMEOUT,t(t({},this._genBaseEmitData(e)),{},{inviteeList:a,isSelfTimeout:!1})))}},{key:"_onInvitationModified",value:function(e,n){var o="".concat(this._n,"._onInvitationModified"),i=e.inviteID,s=e.data,a=this._sigM.hasInviteInfo(i);Ne.l("".concat(o," inviteID:").concat(i," hasInviteID:").concat(a," data:").concat(s)),a&&(this._sigM.setInviteInfo(i,t(t({},e),{},{message:n})),this._sigM.emitEvent(R.INVITATION_MODIFIED,{inviteID:i,data:s}))}}]),Pr),vr=(s(Nr,[{key:"generateInviteID",value:function(){var e,t=(t=ba)((e=Ua)(32),8)+"-"+t(e(16),4)+"-"+t(16384|e(12),4)+"-"+t(32768|e(14),4)+"-"+t(e(48),12);return Ne.l("".concat(this._n,".generateInviteID inviteID:").concat(t)),t}},{key:"createInviteInfo",value:function(e){var n=this.generateInviteID(),o=(e=this.createInviteCustomData(t(t({},e),{},{inviteID:n}))).groupID,i=e.inviteeList;return o=o||i[0],{customData:e,message:this._sigM.createSignaling(e,o),inviteID:n}}},{key:"_genBaseCustomData",value:function(e){var t=e.data,n=e.inviteID;return{businessID:1,timeout:0,data:void 0===t?"":t,inviteID:void 0===n?"":n,groupID:void 0===(e=e.groupID)?"":e}}},{key:"createInviteCustomData",value:function(e){var n=e.userID,o=void 0===(o=e.timeout)?0:o,i=void 0===(i=e.groupID)?"":i,s=this._sigM.getMyUserID();return s=t(t({},this._genBaseCustomData(e)),{},{actionType:R.ACTION_TYPE_INVITE,inviter:s,inviteeList:i?e.inviteeList:[n],timeout:o}),Ne.l("".concat(this._n,".createInviteCustomData customData:"),s),s}},{key:"createCancelCustomData",value:function(e){var n,o="".concat(this._n,".createCancelCustomData"),i=e.inviteID,s=this._sigM.getMyUserID(),a=(i=this._sigM.getInviteInfo(i)).inviteeList,r=i.groupID;return(i=i.inviter)===s?n=t(t({},this._genBaseCustomData(e)),{},{actionType:R.ACTION_TYPE_CANCEL_INVITE,groupID:r,inviter:s,inviteeList:a}):Ne.e("".concat(o," unmatched inviter:").concat(i," and my userID:").concat(s)),Ne.l("".concat(o," customData:"),n),n}},{key:"createAcceptCustomData",value:function(e){var n,o="".concat(this._n,".createAcceptCustomData"),i=e.inviteID,s=this._sigM.getMyUserID(),a=this._sigM.getInviteInfo(i),r=a.inviter,c=a.groupID;return a.inviteeList.includes(s)?n=t(t({},this._genBaseCustomData(e)),{},{actionType:R.ACTION_TYPE_ACCEPT_INVITE,groupID:c,inviter:r,inviteeList:[s]}):Ne.e("".concat(o," userID:").concat(s," not in inviteeList. inviteID:").concat(i," groupID:").concat(c)),Ne.l("".concat(o," customData:"),n),n}},{key:"createRejectCustomData",value:function(e){var n,o="".concat(this._n,".createRejectCustomData"),i=e.inviteID,s=this._sigM.getMyUserID(),a=this._sigM.getInviteInfo(i),r=a.inviter,c=a.groupID;return a.inviteeList.includes(s)?n=t(t({},this._genBaseCustomData(e)),{},{actionType:R.ACTION_TYPE_REJECT_INVITE,groupID:c,inviter:r,inviteeList:[s]}):Ne.e("".concat(o," userID:").concat(s," not in inviteeList. inviteID:").concat(i," groupID:").concat(c)),Ne.l("".concat(o," customData:"),n),n}},{key:"createTimeoutCustomData",value:function(e){var n="".concat(this._n,".createTimeoutCustomData"),o=e.inviteeList,i=e.inviter,s=void 0!==(s=e.isInviter)&&s,a=this._sigM.getMyUserID();return e=t(t({},this._genBaseCustomData(e)),{},{actionType:R.ACTION_TYPE_INVITE_TIMEOUT,inviter:i,inviteeList:s?o:[a]}),Ne.l("".concat(n," customData:"),e),e}}]),Nr),Ir=(s(Or,[{key:"setCloudConfig",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:20,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:300;this.COUNT=e,this.EXPIRED_TIME=t,Ne.l("".concat(this._n,".setCloudConfig count:").concat(e,", time:").concat(t))}},{key:"getHistorySignaling",value:function(){var e=this,t=this._sigM.get(11).getLocalConvList();He(t)||(this._getC2CSignalingList(),t=this._getValidGroupConvList(t),this._getGroupSignalingList(t).then((function(t){e._handleSignalingList(t)})))}},{key:"_getC2CSignalingList",value:function(){var e=this._sigM.get(6).getMessageListFromUnreadDB();e=this._sigM.filterMessageList(e),this._getRelatedToMeMap(e)}},{key:"_getGroupSignalingList",value:function(e){var t=this;return 0===(e=this._createPromiseList(e)).length?Promise.resolve(this._sortSignaling(this._relatedToMeMap)):this._concurrentGetMessageList(e).then((function(e){var n=new Map;return e.forEach((function(e){e=e.list,e=t._getRelatedToMeMap(e),n=new Map([].concat(m(n),m(e)))})),t._sortSignaling(n)}))}},{key:"_handleSignalingList",value:function(e){He(e)||this._sigM.onNewMessageList(e)}},{key:"_getValidGroupConvList",value:function(e){for(var t=[],n=0,o=e.length;n<o;n++){var i=(a=e[n]).type,s=a.unreadCount,a=a.lastMessage;i=i===D.CONV_GROUP,a=this._isNotExpired(a),i&&s&&a&&t.push(e[n])}return t}},{key:"_isNotExpired",value:function(e){return!(!e||!e.lastTime)&&e.lastTime>De()-this.EXPIRED_TIME}},{key:"_createPromiseList",value:function(e){for(var t=[],n=0;n<e.length;n++){var o=(i=e[n]).conversationID,i=(i=i.unreadCount)<this.COUNT?i:this.COUNT;this._map.set(o,{msgCount:i,list:[]}),i=this._sigM.get(11).getMessageList({conversationID:o}),t.push(i)}return t}},{key:"_concurrentGetMessageList",value:function(e){var t=this,n=[];return Promise.all(e).then((function(e){for(var o=0;o<e.length;o++){var i=(s=e[o]).code,s=s.data;0===i&&0!==s.messageList.length&&(t._handleMessageList(s.messageList),(i=t._relayGetMessageList(s))&&n.push(i))}return 0<n.length?t._concurrentGetMessageList(n):t._map}))}},{key:"_relayGetMessageList",value:function(e){var t=e.messageList,n=e.nextReqMessageID;if(e=e.isCompleted,0===t.length)return null;t=t[0].conversationID;var o=this._map.get(t).msgCount;return 0===o||e?null:this._sigM.get(11).getMessageList({conversationID:t,nextReqMessageID:n,count:o})}},{key:"_handleMessageList",value:function(e){var t=e.length,n=e[0].conversationID,o=(i=this._map.get(n)).msgCount,i=i.list;this._map.set(n,{msgCount:0<o-t?o-t:0,list:i.concat(this._sigM.filterMessageList(e))})}},{key:"_getRelatedToMeMap",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];this._saveRelatedToMe(n)}return this._relatedToMeMap}},{key:"_saveRelatedToMe",value:function(e){var t,n=(t=this._sigM.getPayloadData(e)||{}).actionType,o=void 0===(t=t.inviteID)?"":t;switch(void 0===n?"":n){case R.ACTION_TYPE_INVITE:this._setHistoryInvite(e);break;case R.ACTION_TYPE_REJECT_INVITE:case R.ACTION_TYPE_ACCEPT_INVITE:this._updateHistoryInvite(e);break;case R.ACTION_TYPE_CANCEL_INVITE:this._delHistoryInvite(o);break;case R.ACTION_TYPE_INVITE_TIMEOUT:this._updateHistoryInvite(e)}}},{key:"_setHistoryInvite",value:function(e){var n=this._sigM.getPayloadData(e)||{},o=void 0===(o=n.inviteID)?"":o,i=void 0===(i=n.inviteeList)?[]:i,s=void 0===(s=n.timeout)?0:s,a=this._sigM.getMyUserID();i.includes(a)&&(i=De()-e.time,0<s&&s<i&&0!==s||this._relatedToMeMap.set(o,t(t({},n),{},{messageList:[e]})))}},{key:"_delHistoryInvite",value:function(e){this._relatedToMeMap.has(e)&&this._relatedToMeMap.delete(e)}},{key:"_updateHistoryInvite",value:function(e){var t=void 0===(t=(i=this._sigM.getPayloadData(e)||{}).inviteID)?"":t,n=void 0===(i=i.inviteeList)?[]:i;if(this._relatedToMeMap.has(t)){for(var o=(i=this._relatedToMeMap.get(t)).inviteeList,i=i.messageList,s=0;s<n.length;s++){var a=n[s];o.includes(a)&&o.splice(o.indexOf(a),1)}0===o.length?this._delHistoryInvite(t):i.push(e)}else this._delHistoryInvite(t)}},{key:"_sortSignaling",value:function(e){var t=[];return e.forEach((function(e){t=[].concat(m(t),m(e.messageList))})),t.sort((function(e,t){return e.time-t.time}))}},{key:"reset",value:function(){this._map.clear(),this._relatedToMeMap.clear()}}]),Or),yr=s((function e(t,n){o(this,e),this.businessID=t.businessID||1,this.inviteID=t.inviteID,this.groupID=t.groupID||"",this.inviter=t.inviter||"",this.inviteeList=t.inviteeList||[],this.data=t.data||"",this.actionType=t.actionType||R.ACTION_TYPE_INVITE,this.timeout=t.timeout||0})),Mr=["message"],Cr=["message"],Tr=(r(kr,bn),Fa=g(kr),s(kr,[{key:"onC2CUnreadHandleCompleted",value:function(){this._isC2CUnreadHandleCompleted=!0,this._isCloudConfigCompleted&&this._isConvSyncCompleted&&!this._isSyncCompleted&&this.onReady()}},{key:"onConvSyncCompleted",value:function(){this._isConvSyncCompleted=!0,this._isC2CUnreadHandleCompleted&&this._isCloudConfigCompleted&&!this._isSyncCompleted&&this.onReady()}},{key:"onCloudConfig",value:function(){this._isCloudConfigCompleted=!0;var e=this.getCloudConfig("history_s_count"),t=this.getCloudConfig("history_s_time");pt(e)||(e=Number(e)),pt(t)||(t=Number(t)),this._historySignalingHandler.setCloudConfig(e,t),this._isC2CUnreadHandleCompleted&&this._isConvSyncCompleted&&!this._isSyncCompleted&&this.onReady()}},{key:"_isListenerExisted",value:function(){return-1<this._m.getOEmitInst().eventNames().indexOf(R.NEW_INVITATION_RECEIVED)}},{key:"onReady",value:function(){this._isSyncCompleted=!0;var e=this._isListenerExisted();Ne.l("".concat(this._n,".onReady. isListenerExisted: ").concat(e)),e&&this._historySignalingHandler.getHistorySignaling()}},{key:"onNewMessageList",value:function(e){if(0<(e=this.filterMessageList(e)).length)return this._remoteSignalingHandler.onNewMessageList(e)}},{key:"onMessageModified",value:function(e){if(0<(e=this.filterMessageList(e)).length)return this._remoteSignalingHandler.onMessageModified(e)}},{key:"hasInviteInfo",value:function(e){return this._inviteInfoMap.has(e)}},{key:"getInviteInfo",value:function(e){return this._inviteInfoMap.get(e)}},{key:"setInviteInfo",value:function(e,n){var o=n.message;n=_(n,Mr),Ne.l("".concat(this._n,".setInviteInfo inviteID:").concat(e," data:"),n),this._inviteInfoMap.set(e,t(t({},n),{},{message:o}))}},{key:"deleteInviteInfo",value:function(e){this.hasInviteInfo(e)&&(Ne.l("".concat(this._n,".deleteInviteInfo inviteID:").concat(e,".")),this._inviteInfoMap.delete(e))}},{key:"updateInviteInfo",value:function(e){var t="".concat(this._n,".updateInviteInfo"),n=e.inviteID,o=e.inviter,i=e.inviteeList;e=e.groupID,Ne.l("".concat(t," inviteID:").concat(n," inviter:").concat(o," groupID:").concat(e)),e&&this.hasInviteInfo(n)?(o=i[0],(e=this.getInviteInfo(n).inviteeList).includes(o)&&(e.splice(e.indexOf(o),1),Ne.l("".concat(t," remove ").concat(o,". localInviteeList.length:").concat(e.length))),0===e.length&&this.deleteInviteInfo(n)):this.deleteInviteInfo(n)}},{key:"canIUseSignaling",value:function(){return this._canIUseSignaling}},{key:"emitEvent",value:function(e,t){this.emitOEvt(e,t)}},{key:"addSignalingListener",value:function(e,t,n){this._canIUseSignaling||(this._canIUseSignaling=!0),this._m.getOEmitInst().on(e,t,n)}},{key:"removeSignalingListener",value:function(e,t,n){this._m.getOEmitInst().off(e,t,n),this._isListenerExisted()||(this._canIUseSignaling=!1)}},{key:"invite",value:function(e){var n=this,o="".concat(this._n,".").concat("invite"),i=this._localSignalingHandler.createInviteInfo(e),s=i.message,a=i.customData,r=i.inviteID;return Ne.l("".concat(o," options:").concat(JSON.stringify(e)," inviteID:").concat(r)),this.sendSignaling(s,e).then((function(e){return e&&0===e.code?(n.setInviteInfo(r,t(t({},a),{},{message:s})),n.startTimer(t(t({},a),{},{inviteID:r})),t(t({},e),{},{inviteID:r})):e})).catch((function(e){return Rn(e)}))}},{key:"inviteSync",value:function(e,n,o){var i=this,s="".concat(this._n,".").concat("inviteSync"),a=this._localSignalingHandler.createInviteInfo(e),r=a.message,c=a.customData,u=a.inviteID;return Ne.l("".concat(s," options:").concat(JSON.stringify(e)," inviteID:").concat(u)),this.sendSignaling(r,e).then((function(e){if(e&&0===e.code)return i.setInviteInfo(u,t(t({},c),{},{message:r})),i.startTimer(t(t({},c),{},{inviteID:u})),n&&n({inviteID:u}),{inviteID:u};o&&o(0===e.code,e.message||"")})).catch((function(e){return o&&o(e.code,e.message),Rn(e)})),u}},{key:"_handleImResponse",value:function(e,t,n){t&&0===t.code&&(this._isHandling=!1,n?this.deleteInviteInfo(e.inviteID):this.updateInviteInfo(e))}},{key:"cancel",value:function(e){var n=this,o="".concat(this._n,".").concat("cancel");if(Ne.l("".concat(o," options:").concat(JSON.stringify(e))),!this.hasInviteInfo(e.inviteID)||this._isHandling)return Rn({code:Bn.INVALID_CANCEL_MESSAGE});this._isHandling=!0;var i=this._localSignalingHandler.createCancelCustomData(e);if(!i)return this._isHandling=!1,Rn({code:Bn.SIGNALING_NO_PERMISSION});o=i.groupID;var s=i.inviteeList;return o=o||s[0],s=this.createSignaling(i,o),this.sendSignaling(s,e).then((function(o){return n._handleImResponse(i,o,!0),0===o.code?t(t({},o),{},{inviteID:e.inviteID}):o})).catch((function(e){return Rn(e)}))}},{key:"accept",value:function(e){var n=this,o="".concat(this._n,".").concat("accept");if(Ne.l("".concat(o," options:").concat(JSON.stringify(e))),!this.hasInviteInfo(e.inviteID)||this._isHandling)return Rn({code:Bn.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var i=this._localSignalingHandler.createAcceptCustomData(e);return i?(o=this.createSignaling(i),this.sendSignaling(o,e).then((function(o){return n._handleImResponse(i,o),0===o.code?t(t({},o),{},{inviteID:e.inviteID}):o})).catch((function(e){return Rn(e)}))):(this._isHandling=!1,Rn({code:Bn.SIGNALING_NO_PERMISSION}))}},{key:"reject",value:function(e){var n=this,o="".concat(this._n,".").concat("reject");if(Ne.l("".concat(o," options:").concat(JSON.stringify(e))),!this.hasInviteInfo(e.inviteID)||this._isHandling)return Rn({code:Bn.SIGNALING_INVALID_INVITE_ID});this._isHandling=!0;var i=this._localSignalingHandler.createRejectCustomData(e);return i?(o=this.createSignaling(i),this.sendSignaling(o,e).then((function(o){return n._handleImResponse(i,o,!0),0===o.code?t(t({},o),{},{inviteID:e.inviteID}):o})).catch((function(e){return Rn(e)}))):(this._isHandling=!1,Rn({code:Bn.SIGNALING_NO_PERMISSION}))}},{key:"getSignalingInfo",value:function(e){var t="".concat(this._n,".getSignalingInfo"),n=e.ID,o=e.from,i=e.to,s=this._filterSignaling(e),a=null;return s&&(e=this.getPayloadData(e),a=new yr(e)),e=s?"actionType:".concat(a.actionType):"",Ne.l("".concat(t," messageID:").concat(n," from:").concat(o," to:").concat(i," ")+"".concat(e," isSignaling:").concat(s)),a}},{key:"modifyInvitation",value:function(e){var n=this,o=e.inviteID;if(e=e.data,!this.hasInviteInfo(o))return Rn({code:Bn.SIGNALING_INVALID_INVITE_ID});var i=this.getInviteInfo(o),s=i.message,a=_(i,Cr),r=s.payload.data;return a.data=e,s.payload.data=JSON.stringify(a),this.get(2).modifyRemoteMessage(s).then((function(e){return n.hasInviteInfo(o)&&n.setInviteInfo(o,t(t({},a),{},{message:s})),e})).catch((function(e){return s.payload.data=r,Rn(e)}))}},{key:"_genMsgCtrlInfo",value:function(){var e=void 0===(e=(i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).data)?"":e,t=i.onlineUserOnly,n=void 0===(n=i.inviteID)?"":n,o=i.offlinePushInfo,i=i.actionType,s={_onlineOnlyFlag:!1};return n={onlineUserOnly:(s=n&&this.getInviteInfo(n)?this.getInviteInfo(n).message:s)._onlineOnlyFlag||t||!1,offlinePushInfo:o,messageControlInfo:{excludedFromContentModeration:!0,excludedFromUnreadCount:!1,excludedFromLastMessage:!1}},i===R.ACTION_TYPE_INVITE_TIMEOUT?(s=!!e.match(/excludeTimeoutSignalingFromHistoryMessage/),n.messageControlInfo.excludedFromUnreadCount=s,n.messageControlInfo.excludedFromLastMessage=s,n):(t=!!e.match(/excludeFromHistoryMessage/),o=!!e.match(/excludeOriginalSignalingFromHistoryMessage/),n.messageControlInfo.excludedFromUnreadCount=t||o,n.messageControlInfo.excludedFromLastMessage=t||o,n)}},{key:"sendSignaling",value:function(e,t){var n=this;return this.get(2).sendMessageInstance(e,this._genMsgCtrlInfo(t)).catch((function(e){return n._isHandling=!1,Rn(e)}))}},{key:"filterMessageList",value:function(e){var t=this;return e.filter((function(e){return t._filterSignaling(e)}))}},{key:"getPayloadData",value:function(e){return this._remoteSignalingHandler.getPayloadData(e)}},{key:"createSignaling",value:function(e,t){var n=e.groupID,o=e.inviter;return t={to:t||n||o,conversationType:n?D.CONV_GROUP:D.CONV_C2C,priority:D.MSG_PRIORITY_HIGH,payload:{data:JSON.stringify(e)}},o=this.get(2).createCustomMessage(t),Ne.l("".concat(this._n,".createSignaling. message:"),o),o}},{key:"_filterSignaling",value:function(e){var t,n,o=!1;return e.type&&e.type===D.MSG_CUSTOM&&(t=e.cloudCustomData,e=void 0===(e=e.payload.data)?"":e,t=(void 0===t?"":t).match(/"type":"tsignaling"/),n=e.match(/inviteID/),e=e.match(/actionType/),o=t||n&&e),!!o}},{key:"startTimer",value:function(e){var t,n,o,i=this,s="".concat(this._n,".startTimer"),a=e.timeout,r=e.inviteID,c=e.inviter,u=e.groupID,l=c===this.getMyUserID();Ne.l("".concat(s," timeout:").concat(a," isInviter:").concat(l," groupID:").concat(u)),a<=0||(t=l?a+5:a,n=1,o=setInterval((function(){var a=i._hasLocalInviteInfo(e,l);n<t&&a?++n:(a&&i._sendTimeoutNotice(r,l),Ne.l("".concat(s," end.")),clearInterval(o))}),1e3))}},{key:"_hasLocalInviteInfo",value:function(e,t){var n=e.inviteID;if(e=e.groupID,!this.hasInviteInfo(n))return!1;var o="".concat(this._n,"._hasLocalInviteInfo"),i=this.getInviteInfo(n).inviteeList;return Ne.l("".concat(o," inviteID:").concat(n," inviteeList:").concat(i," groupID:").concat(e)),!e||(t?0<i.length:0<i.length&&i.includes(this.getMyUserID()))}},{key:"_getReceiver",value:function(e,t){var n=t.groupID,o=t.inviteeList;return t=t.inviter,e?n||o[0]:n||t}},{key:"_sendTimeoutNotice",value:function(e,n){var o=this,i=this.getInviteInfo(e),s=this._getReceiver(n,i),a=(Ne.l("".concat(this._n,"._sendTimeoutNotice inviteID:").concat(e," to:").concat(s," isInviter:").concat(n)),this._localSignalingHandler.createTimeoutCustomData(t(t({},i),{},{isInviter:n}))),r=this.createSignaling(a,s);return this.sendSignaling(r,a).then((function(t){var i,s,c;t&&0===t.code&&(t=a.data,i=a.groupID,s=a.inviteeList,c=a.inviter,o.emitEvent(R.INVITATION_TIMEOUT,{data:t,groupID:i,inviteID:e,inviteeList:s,inviter:c,isSelfTimeout:!0,message:r}),n?o.deleteInviteInfo(e):o.updateInviteInfo(a))}))}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._inviteInfoMap.clear(),this._canIUseSignaling=!1,this._isHandling=!1,this._historySignalingHandler.reset(),this._isC2CUnreadHandleCompleted=!1,this._isConvSyncCompleted=!1,this._isSyncCompleted=!1,this._isCloudConfigCompleted=!1}}]),kr),Er=["followDiffList"],Dr=["from"],Rr={NONE:0,FOLLOWERS:1,FOLLOWING:2,MUTUAL:3},Sr=(r(Ar,bn),wa=g(Ar),s(Ar,[{key:"_onCloudConfig",value:function(){var e=this.getCloudConfig("follow_req_count");pt(e)||(e=Number(e),this.DEFAULT_COUNT=e>this.MAX_COUNT?this.MAX_COUNT:e,this._clearFollowList())}},{key:"clearCacheOnReconnected",value:function(){this._clearFollowList()}},{key:"onFollowNotify",value:function(e){var t=this;e=e.dataList||[],Ne.l("".concat(this._n,".onFollowNotify followChangeList:").concat(e.length)),e.forEach((function(e){var n=void 0===(n=e.followDiffList)?[]:n,o=(e=_(e,Er)).from,i=_(e,Dr);n.forEach((function(e){var n=e.isAdd,s=(e=void 0===(e=e.followType)?0:e,t._initFollowInfo());1===n?(i.userID=o,s[e].userInfoList.push(i),s[e].isAdd=!0):(s[e].userInfoList.push(o),s[e].isAdd=!1),t._emitEvent(s)}))}))}},{key:"_initFollowInfo",value:function(){var e={};return Object.values(Rr).forEach((function(t){t!==Rr.NONE&&(e[t]={userInfoList:[],isAdd:!1})})),e}},{key:"_emitEvent",value:function(e){var t=this;Object.keys(e).forEach((function(n){n=Number(n);var o=e[n];0<o.userInfoList.length&&(n===Rr.FOLLOWERS&&(t._clearFollowList(Rr.FOLLOWERS),t.emitOEvt(E.MY_FOLLOWERS_LIST_UPDATED,o)),n===Rr.FOLLOWING&&(t._clearFollowList(Rr.FOLLOWING),t.emitOEvt(E.MY_FOLLOWING_LIST_UPDATED,o)),n===Rr.MUTUAL&&(t._clearFollowList(Rr.MUTUAL),t.emitOEvt(E.MUTUAL_FOLLOWERS_LIST_UPDATED,o)))}))}},{key:"followUser",value:function(e){if(!this.canIUse(U.FOLLOW))return this.noUse("followUser");var t="".concat(this._n,".").concat("followUser"),n="userIDList:".concat(e.length),o=new so("followUser");return o.setMessage(n),Ne.l("".concat(t," ").concat(n)),this.req({P:Kn.FOLLOW,data:{fromAccount:this.getMyUserID(),userIDList:e.map((function(e){return{userID:e}}))}}).then((function(e){return o.end(),Ne.l("".concat(t," ok.")),En(e.data.resultList)})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"unfollowUser",value:function(e){if(!this.canIUse(U.FOLLOW))return this.noUse("unfollowUser");var t="".concat(this._n,".").concat("unfollowUser"),n="userIDList:".concat(e.length),o=new so("unfollowUser");return o.setMessage(n),Ne.l("".concat(t," ").concat(n)),this.req({P:Kn.UNFOLLOW,data:{fromAccount:this.getMyUserID(),userIDList:e}}).then((function(e){return o.end(),Ne.l("".concat(t," ok.")),En(e.data.resultList)})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"getMyFollowersList",value:function(){var e=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMyFollowersList";if(!this.canIUse(U.FOLLOW))return this.noUse(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myFollowersList.has(i)){var s=(r=this._myFollowersList.get(i)).resultList,a=r.nextCursor,r=r.lastUpdateTime;if(Date.now()-r<this.MAX_CATCH_TIME&&0<s.length)return Ne.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Dn({resultList:s,nextCursor:a})}return this._getFollowList(n,Rr.FOLLOWERS).then((function(s){return e._myFollowersList.set(i,t(t({},s),{},{lastUpdateTime:Date.now()})),Ne.l("".concat(e._n,".").concat(o," nextCursor:").concat(n," from remote.")),En(s)}))}},{key:"getMyFollowingList",value:function(){var e=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMyFollowingList";if(!this.canIUse(U.FOLLOW))return this.noUse(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myFollowingList.has(i)){var s=(r=this._myFollowingList.get(i)).resultList,a=r.nextCursor,r=r.lastUpdateTime;if(Date.now()-r<this.MAX_CATCH_TIME&&0<s.length)return Ne.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Dn({resultList:s,nextCursor:a})}return this._getFollowList(n,Rr.FOLLOWING).then((function(s){return e._myFollowingList.set(i,t(t({},s),{},{lastUpdateTime:Date.now()})),Ne.l("".concat(e._n,".").concat(o," nextCursor:").concat(n," from remote.")),En(s)}))}},{key:"getMutualFollowersList",value:function(){var e=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",o="getMutualFollowersList";if(!this.canIUse(U.FOLLOW))return this.noUse(o);var i=n||this.FIRST_PAGE_INDEX;if(this._myMutualFollowersList.has(i)){var s=(r=this._myMutualFollowersList.get(i)).resultList,a=r.nextCursor,r=r.lastUpdateTime;if(Date.now()-r<this.MAX_CATCH_TIME&&0<s.length)return Ne.l("".concat(this._n,".").concat(o," nextCursor:").concat(n," from local.")),Dn({resultList:s,nextCursor:a})}return this._getFollowList(n,Rr.MUTUAL).then((function(s){return e._myMutualFollowersList.set(i,t(t({},s),{},{lastUpdateTime:Date.now()})),Ne.l("".concat(e._n,".").concat(o," nextCursor:").concat(n," from remote.")),En(s)}))}},{key:"_getFollowList",value:function(e,n){var o=this,i=new so("_getFollowList");return i.setMessage("nextCursor:".concat(e," type:").concat(n)),this.req({P:Kn.GET_FOLLOW,data:{fromAccount:this.getMyUserID(),count:this.DEFAULT_COUNT,nextCursor:e,type:n}}).then((function(e){i.end();var n=void 0===(n=(e=e.data).resultList)?[]:n,s=(e=void 0===(e=e.nextCursor)?"":e,[]);return n.forEach((function(e){var n=e.userID,i=e.followTime;e=e.profileList,s.push(t({userID:n,followTime:i},o._handleProfileItem(void 0===e?[]:e)))})),{resultList:s,nextCursor:e}})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(o._n,"._getFollowList failed. error:"),e),Rn(e)}))}},{key:"_handleProfileItem",value:function(e){var t={};return e.forEach((function(e){switch(e.tag){case Ge.NICK:t.nick=e.value;break;case Ge.GENDER:t.gender=e.value;break;case Ge.BIRTHDAY:t.birthday=e.value;break;case Ge.LOCATION:t.location=e.value;break;case Ge.SELFSIGNATURE:t.selfSignature=e.value;break;case Ge.ALLOWTYPE:t.allowType=e.value;break;case Ge.LANGUAGE:t.language=e.value;break;case Ge.AVATAR:t.avatar=e.value;break;case Ge.MESSAGESETTINGS:t.messageSettings=e.value;break;case Ge.ADMINFORBIDTYPE:t.adminForbidType=e.value;break;case Ge.LEVEL:t.level=e.value;break;case Ge.ROLE:t.role=e.value;break;default:t[e.tag]=e.value}})),t}},{key:"getUserFollowInfo",value:function(e){if(!this.canIUse(U.FOLLOW))return this.noUse("getUserFollowInfo");var t=e,n=!1,o=(pt(e)&&(t=[this.getMyUserID()],n=!0),"".concat(this._n,".").concat("getUserFollowInfo")),i=(e="userIDList:".concat(t.length," isGetMyFollowInfo:").concat(n),new so("getUserFollowInfo"));return i.setMessage(e),Ne.l("".concat(o," ").concat(e)),this.req({P:Kn.GET_FOLLOW_INFO,data:{fromAccount:this.getMyUserID(),userIDList:t}}).then((function(e){i.end(),Ne.l("".concat(o," ok.")),e=e.data.followInfoList;var t=[];return(void 0===e?[]:e).forEach((function(e){var n=e.followersCount,o=e.followingCount;e=e.mutualFollowersCount,t.push({followersCount:n,followingCount:o,mutualFollowersCount:e})})),En(t)})).catch((function(e){return i.setError(e).end(),Ne.e("".concat(o," failed. error:"),e),Rn(e)}))}},{key:"checkFollowType",value:function(e){if(!this.canIUse(U.FOLLOW))return this.noUse("checkFollowType");100<e.length&&(e=e.slice(0,100),Ne.w("".concat(t," ").concat(Wt(100))));var t="".concat(this._n,".").concat("checkFollowType"),n="userIDList length:".concat(e.length," "),o=new so("checkFollowType");return o.setMessage(n),Ne.l("".concat(t," ").concat(n)),this.req({P:Kn.CHECK_FOLLOW_TYPE,data:{fromAccount:this.getMyUserID(),userIDList:e}}).then((function(e){o.end(),Ne.l("".concat(t," ok.")),e=e.data.resultList;var n=[];return(void 0===e?[]:e).forEach((function(e){var t=e.userID;e=e.followType,n.push({userID:t,followType:e})})),En(n)})).catch((function(e){return o.setError(e).end(),Ne.e("".concat(t," failed. error:"),e),Rn(e)}))}},{key:"_clearFollowList",value:function(e){if(pt(e))return this._myFollowersList.clear(),this._myFollowingList.clear(),void this._myMutualFollowersList.clear();e!==Rr.FOLLOWERS?e!==Rr.FOLLOWING?e!==Rr.MUTUAL||this._myMutualFollowersList.clear():this._myFollowingList.clear():this._myFollowersList.clear()}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._clearFollowList()}}]),Ar),Lr=Ds((function(e,t){var o="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;t.assign=function(e){for(var t,o,i=Array.prototype.slice.call(arguments,1);i.length;){var s=i.shift();if(s){if("object"!==n(s))throw new TypeError(s+"must be non-object");for(var a in s)t=s,o=a,Object.prototype.hasOwnProperty.call(t,o)&&(e[a]=s[a])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,n,o,i){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+o),i);else for(var s=0;s<o;s++)e[i+s]=t[n+s]},flattenChunks:function(e){for(var t,n,o,i=0,s=0,a=e.length;s<a;s++)i+=e[s].length;for(o=new Uint8Array(i),s=t=0,a=e.length;s<a;s++)n=e[s],o.set(n,t),t+=n.length;return o}},s={arraySet:function(e,t,n,o,i){for(var s=0;s<o;s++)e[i+s]=t[n+s]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,i)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,s))},t.setTyped(o)}));function Ar(e){return o(this,Ar),(e=wa.call(this,e))._n="FollowModule",e._myFollowersList=new Map,e._myFollowingList=new Map,e._myMutualFollowersList=new Map,e.MAX_CATCH_TIME=6e5,e.FIRST_PAGE_INDEX=at(),e.DEFAULT_COUNT=500,e.MAX_COUNT=1e3,e.getIEmitInst().on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function kr(e){o(this,kr),(e=Fa.call(this,e))._n="SignalingModule",e._inviteInfoMap=new Map,e._canIUseSignaling=!1,e._isHandling=!1,e._remoteSignalingHandler=new mr(h(e)),e._localSignalingHandler=new vr(h(e)),e._historySignalingHandler=new Ir(h(e)),e._isC2CUnreadHandleCompleted=!1,e._isConvSyncCompleted=!1,e._isSyncCompleted=!1,e._isCloudConfigCompleted=!1;var t=e.getIEmitInst();return t.on(jo.C2C_UNREAD_HANDLE_COMPLETED,e.onC2CUnreadHandleCompleted,h(e)),t.on(jo.CONV_SYNC_COMPLETED,e.onConvSyncCompleted,h(e)),t.on(jo.CLOUD_CONFIG,e.onCloudConfig,h(e)),e}function Or(e){o(this,Or),this._n="HistorySignalingHandler",this._sigM=e,this.COUNT=20,this.EXPIRED_TIME=300,this._map=new Map,this._relatedToMeMap=new Map}function Nr(e){o(this,Nr),this._n="LocalSignalingHandler",this._sigM=e}function Pr(e){o(this,Pr),this._n="RemoteSignalingHandler",this._sigM=e}function Gr(e){o(this,Gr),this._m=e,this._n="ErrMsgModule",this.TIM_ERROR_ASSISTANCE="tim_error_assistance",this.STORAGE_EXPIRES_TIME=6048e5,this._map=new Map,this._init()}function Ur(e){o(this,Ur),this._m=e,this._n="TransCmdModule",this._TRTCCommandList=["tui_room_svr.*","callkit_records_svr.*","room_engine_srv.*","room_engine_http_srv.*","room_engine_mic.*","live_engine_srv.*","live_engine_http_srv.*","live_engine_pk.*","trtc_ai_service.*","call_engine_srv.*"],this._TRTCCommandMap=new Map,this._setTRTCCommandMap(),this._m.getIEmitInst().on(jo.CLOUD_CONFIG,this._onCloudConfig,this)}function br(e){return o(this,br),(e=qa.call(this,e))._n="ProfanityFilterModule",e._plugin=null,e._filterConfigMap=new Map,e._startIndex=0,e._version=0,e._canIUseLexicon=!1,e._isFetching=!1,e._expiredTime=0,e}function wr(e){var t;return o(this,wr),(t=xa.call(this,e))._m=e,t._n="TIMPushModule",t._pluginName="TIMPush",t._pushPlugin=void 0,t._androidPushConfig={},t._deviceToken="",t._businessID=0,t._iOSBusinessID=0,t._c2cUnreadCount=0,t._groupUnreadCount=0,t._isWebUniapp=0,t._deviceInfo={notificationStatus:0,deviceModel:"",systemVersion:"",pushVersion:"1.0.1",packageName:""},t}function Fr(e){var t;return o(this,Fr),(t=Va.call(this,e))._m=e,t._n="OfflinePushModule",t._offlinePushPlugin=void 0,t._androidPushConfig={huaweiPushBussinessId:"",xiaomiPushBussinessId:"",xiaomiPushAppId:"",xiaomiPushAppKey:"",meizuPushBussinessId:"",meizuPushAppId:"",meizuPushAppKey:"",vivoPushBussinessId:"",fcmPushBussinessId:"",oppoPushBussinessId:"",oppoPushAppKey:"",oppoPushAppSecret:"",honorPushBussinessId:""},t._deviceToken="",t._businessID=0,t._iosBusinessID=0,t._c2cUnreadCount=0,t._groupUnreadCount=0,t._isWebUniapp=0,t}function qr(e){o(this,qr),this._m=e,this._n="CommercialConfigModule",this._expiredTime=0,this._isFetching=!1,this._purchasedFeatureHandler=new lr(this)}function xr(e){o(this,xr),this._commercialConfigM=e,this._n="PurchasedFeatureHandler",this._isCSPluginReported=!1,this._featureMap=new Map}function Vr(e){return o(this,Vr),(e=Ba.call(this,e))._n="WorkerTimerModule",e._isWorkerEnabled=!0,e._workerTimer=null,e._timerID=-1,e._init(),e.getIEmitInst().on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function Br(e){return o(this,Br),(e=Ha.call(this,e))._n="SnsModule",e._friendHandler=new sr(h(e)),e._friendApplicationHandler=new or(h(e)),e._friendGroupHandler=new rr(h(e)),e.getIEmitInst().on(jo.A2KEY_AND_TINYID_UPDATED,e.onContextUpdated,h(e)),e}function Hr(e){o(this,Hr),this._snsM=e,this._n="FriendGroupHandler",this._map=new Map}function Kr(e){o(this,Kr),He(e)||(this.name=e.name||"",this.userIDList=e.userIDList||[],this.count=this.userIDList.length||0)}function Wr(e){o(this,Wr),this._snsM=e,this._n="FriendHandler",this._map=new Map,this._startIdx=0,this._standardSeq=0,this._customSeq=0,this._expirationTime=18e4}function Yr(e,n){o(this,Yr),this.userID=e,this.remark="",this.groupList=[],this.source="",this.addTime=0,this.friendCustomField=[],this.timestamp=0;var i={},s=[];if(i.userID=e,!He(n))for(var a,r="",c=0,u=n.length;c<u;c++)if(r=n[c].tag,a=n[c].value,-1<r.indexOf("Tag_SNS_Custom"))this.friendCustomField.push({key:r,value:a});else if(-1<r.indexOf("Tag_Profile_Custom"))s.push({key:r,value:a});else switch(r){case Ge.NICK:i.nick=a;break;case Ge.GENDER:i.gender=a;break;case Ge.BIRTHDAY:i.birthday=a;break;case Ge.LOCATION:i.location=a;break;case Ge.SELFSIGNATURE:i.selfSignature=a;break;case Ge.ALLOWTYPE:i.allowType=a;break;case Ge.LANGUAGE:i.language=a;break;case Ge.AVATAR:i.avatar=a;break;case Ge.MESSAGESETTINGS:i.messageSettings=a;break;case Ge.ADMINFORBIDTYPE:i.adminForbidType=a;break;case Ge.LEVEL:i.level=a;break;case Ge.ROLE:i.role=a;break;case Ue.REMARK:this.remark=a;break;case Ue.ADDTIME:this.addTime=a;break;case Ue.GROUP:this.groupList=JSON.parse(JSON.stringify(a));break;case Ue.ADDSOURCE:this.source=a;break;case Ue.ADDWORDING:break;default:Ne.l("snsProfileItem unknown tag->",n[c].tag)}this.profile=new ci(t(t({},i),{},{profileCustomField:s}))}function jr(e){o(this,jr),this._snsM=e,this._n="FriendApplicationHandler",this._startTime=0,this._maxLimited=100,this._currentSeq=0,this._map=new Map,this._unreadCount=0}function Jr(e){o(this,Jr),(e=Ka.call(this,e))._n="QualityStatModule",e.TAG="im-ssolog-quality-stat",e.reportIndex=0,e.wholePeriod=!1,e._qualityItems=[Wn,Yn,jn,Jn,zn,Xn,Qn,Zn,$n,eo],e._messageSentItems=[jn,Jn,zn,Xn,Qn],e._messageReceivedItems=[Zn,$n,eo],e.REPORT_INTERVAL=120,e.REPORT_SDKAPPID_BLACKLIST=[],e.REPORT_TINYID_WHITELIST=[],e._statInfoArr=[],e._avgRTT=new Za,e._avgE2EDelay=new Qa,e._rateMessageSent=new $a,e._rateMessageReceived=new er;var t=e.getIEmitInst();return t.on(jo.A2KEY_AND_TINYID_UPDATED,e._onLoginSuccess,h(e)),t.on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function zr(){o(this,zr),this._lastMap=new Map,this._currentMap=new Map}function Xr(){o(this,Xr),this._map=new Map}function Qr(){o(this,Qr),this._n="AvgRTT",this._requestCount=0,this._rttArray=[]}function Zr(){o(this,Zr),this._n="AvgE2EDelay",this._e2eDelayArray=[]}function $r(e){return o(this,$r),(e=Wa.call(this,e))._n="RecoverMsgModule",e.PULL_LIMIT_COUNT=15,e}function ec(e){return o(this,ec),(e=Ya.call(this,e))._n="CloudControlModule",e._cloudConfig=new Map,e._expiredTime=0,e._version=0,e._isFetching=!1,e}function tc(e){return o(this,tc),(e=ja.call(this,e))._n="SessionModule",e._platform=e.getPlatform(),e._pHandler=new Ma(h(e)),e._msgDispatcher=new Ta(h(e)),e._cmdFreqLimitMap=new Map,e._cmdReqInfoMap=new Map,e._serverOverloadInfoMap=new Map,e._incrementalPullContactFlag=!0,e._init(),e.getIEmitInst().on(jo.CLOUD_CONFIG,e._onCloudConfig,h(e)),e}function nc(e,t,n,o){for(var i=65535&e,s=e>>>16&65535,a=0;0!==n;){for(n-=a=2e3<n?2e3:n;s=s+(i=i+t[o++]|0)|0,--a;);i%=65521,s%=65521}return i|s<<16}function oc(e,t,n,o){var i=sc,s=o+n;e^=-1;for(var a=o;a<s;a++)e=e>>>8^i[255&(e^t[a])];return~e}function ic(e,t,n,o,i,s,a,r){var c,u,l,d,p,_,h,g,f,m=r.bits,v=0,I=0,y=0,M=0,C=0,T=0,E=0,D=0,R=0,S=0,L=null,A=0,k=new Lr.Buf16(16),O=new Lr.Buf16(16),N=null,P=0;for(v=0;v<=15;v++)k[v]=0;for(I=0;I<o;I++)k[t[n+I]]++;for(C=m,M=15;1<=M&&0===k[M];M--);if(M<C&&(C=M),0===M)return i[s++]=20971520,i[s++]=20971520,r.bits=1,0;for(y=1;y<M&&0===k[y];y++);for(C<y&&(C=y),v=D=1;v<=15;v++)if((D=(D<<1)-k[v])<0)return-1;if(0<D&&(0===e||1!==M))return-1;for(O[1]=0,v=1;v<15;v++)O[v+1]=O[v]+k[v];for(I=0;I<o;I++)0!==t[n+I]&&(a[O[t[n+I]]++]=I);if(_=0===e?(L=N=a,19):1===e?(L=ac,A-=257,N=rc,P-=257,256):(L=cc,N=uc,-1),v=y,p=s,E=I=S=0,l=-1,d=(R=1<<(T=C))-1,1===e&&852<R||2===e&&592<R)return 1;for(;;){for(f=a[I]<_?(g=0,a[I]):a[I]>_?(g=N[P+a[I]],L[A+a[I]]):(g=96,0),c=1<<(h=v-E),y=u=1<<T;i[p+(S>>E)+(u-=c)]=h<<24|g<<16|f,0!==u;);for(c=1<<v-1;S&c;)c>>=1;if(S=0!==c?(S&c-1)+c:0,I++,0==--k[v]){if(v===M)break;v=t[n+a[I]]}if(C<v&&(S&d)!==l){for(p+=y,D=1<<(T=v-(E=0===E?C:E));T+E<M&&!((D-=k[T+E])<=0);)T++,D<<=1;if(R+=1<<T,1===e&&852<R||2===e&&592<R)return 1;i[l=S&d]=C<<24|T<<16|p-s}}return 0!==S&&(i[p+S]=v-E<<24|64<<16),r.bits=C,0}Lr.assign,Lr.shrinkBuf,Lr.setTyped,Lr.Buf8,Lr.Buf16,Lr.Buf32;var sc=function(){for(var e=[],t=0;t<256;t++){for(var n=t,o=0;o<8;o++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n}return e}(),ac=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],rc=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],cc=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],uc=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function lc(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function dc(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Lr.Buf16(320),this.work=new Lr.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function pc(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Lr.Buf32(852),t.distcode=t.distdyn=new Lr.Buf32(592),t.sane=1,t.back=-1,0):-2}function _c(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,pc(e)):-2}function hc(e,t){var n,o;return e&&e.state?(o=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||15<t)?-2:(null!==o.window&&o.wbits!==t&&(o.window=null),o.wrap=n,o.wbits=t,_c(e))):-2}function gc(e,t){var n;return e?(n=new dc,(e.state=n).window=null,0!==(n=hc(e,t))&&(e.state=null),n):-2}var fc,mc,vc=!0;function Ic(e,t,n,o){var i;return null===(e=e.state).window&&(e.wsize=1<<e.wbits,e.wnext=0,e.whave=0,e.window=new Lr.Buf8(e.wsize)),o>=e.wsize?(Lr.arraySet(e.window,t,n-e.wsize,e.wsize,0),e.wnext=0,e.whave=e.wsize):((i=e.wsize-e.wnext)>o&&(i=o),Lr.arraySet(e.window,t,n-o,i,e.wnext),(o-=i)?(Lr.arraySet(e.window,t,n-o,o,0),e.wnext=o,e.whave=e.wsize):(e.wnext+=i,e.wnext===e.wsize&&(e.wnext=0),e.whave<e.wsize&&(e.whave+=i))),0}var yc={inflateReset:_c,inflateReset2:hc,inflateResetKeep:pc,inflateInit:function(e){return gc(e,15)},inflateInit2:gc,inflate:function(e,t){var n,o,i,s,a,r,c,u,l,d,p,_,h,g,f,m,v,I,y,M,C,T,E,D,R=0,S=new Lr.Buf8(4),L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;12===(n=e.state).mode&&(n.mode=13),a=e.next_out,i=e.output,c=e.avail_out,s=e.next_in,o=e.input,r=e.avail_in,u=n.hold,l=n.bits,d=r,p=c,T=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;l<16;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(2&n.wrap&&35615===u){S[n.check=0]=255&u,S[1]=u>>>8&255,n.check=oc(n.check,S,2,0),l=u=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",n.mode=30;break}if(8!=(15&u)){e.msg="unknown compression method",n.mode=30;break}if(l-=4,C=8+(15&(u>>>=4)),0===n.wbits)n.wbits=C;else if(C>n.wbits){e.msg="invalid window size",n.mode=30;break}n.dmax=1<<C,e.adler=n.check=1,n.mode=512&u?10:12,l=u=0;break;case 2:for(;l<16;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(n.flags=u,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=30;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=30;break}n.head&&(n.head.text=u>>8&1),512&n.flags&&(S[0]=255&u,S[1]=u>>>8&255,n.check=oc(n.check,S,2,0)),l=u=0,n.mode=3;case 3:for(;l<32;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}n.head&&(n.head.time=u),512&n.flags&&(S[0]=255&u,S[1]=u>>>8&255,S[2]=u>>>16&255,S[3]=u>>>24&255,n.check=oc(n.check,S,4,0)),l=u=0,n.mode=4;case 4:for(;l<16;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}n.head&&(n.head.xflags=255&u,n.head.os=u>>8),512&n.flags&&(S[0]=255&u,S[1]=u>>>8&255,n.check=oc(n.check,S,2,0)),l=u=0,n.mode=5;case 5:if(1024&n.flags){for(;l<16;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}n.length=u,n.head&&(n.head.extra_len=u),512&n.flags&&(S[0]=255&u,S[1]=u>>>8&255,n.check=oc(n.check,S,2,0)),l=u=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((_=(_=n.length)>r?r:_)&&(n.head&&(C=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),Lr.arraySet(n.head.extra,o,s,_,C)),512&n.flags&&(n.check=oc(n.check,o,_,s)),r-=_,s+=_,n.length-=_),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===r)break e;for(_=0;C=o[s+_++],n.head&&C&&n.length<65536&&(n.head.name+=String.fromCharCode(C)),C&&_<r;);if(512&n.flags&&(n.check=oc(n.check,o,_,s)),r-=_,s+=_,C)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===r)break e;for(_=0;C=o[s+_++],n.head&&C&&n.length<65536&&(n.head.comment+=String.fromCharCode(C)),C&&_<r;);if(512&n.flags&&(n.check=oc(n.check,o,_,s)),r-=_,s+=_,C)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;l<16;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(u!==(65535&n.check)){e.msg="header crc mismatch",n.mode=30;break}l=u=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=12;break;case 10:for(;l<32;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}e.adler=n.check=lc(u),l=u=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=a,e.avail_out=c,e.next_in=s,e.avail_in=r,n.hold=u,n.bits=l,2;e.adler=n.check=1,n.mode=12;case 12:if(5===t||6===t)break e;case 13:if(n.last){u>>>=7&l,l-=7&l,n.mode=27;break}for(;l<3;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}switch(n.last=1&u,--l,3&(u>>>=1)){case 0:n.mode=14;break;case 1:A=k=void 0;var A,k=n;if(vc){for(fc=new Lr.Buf32(512),mc=new Lr.Buf32(32),A=0;A<144;)k.lens[A++]=8;for(;A<256;)k.lens[A++]=9;for(;A<280;)k.lens[A++]=7;for(;A<288;)k.lens[A++]=8;for(ic(1,k.lens,0,288,fc,0,k.work,{bits:9}),A=0;A<32;)k.lens[A++]=5;ic(2,k.lens,0,32,mc,0,k.work,{bits:5}),vc=!1}if(k.lencode=fc,k.lenbits=9,k.distcode=mc,k.distbits=5,n.mode=20,6!==t)break;u>>>=2,l-=2;break e;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=30}u>>>=2,l-=2;break;case 14:for(u>>>=7&l,l-=7&l;l<32;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",n.mode=30;break}if(n.length=65535&u,l=u=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(_=n.length){if(0===(_=c<(_=r<_?r:_)?c:_))break e;Lr.arraySet(i,o,s,_,a),r-=_,s+=_,c-=_,a+=_,n.length-=_;break}n.mode=12;break;case 17:for(;l<14;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(n.nlen=257+(31&u),u>>>=5,l-=5,n.ndist=1+(31&u),u>>>=5,l-=5,n.ncode=4+(15&u),u>>>=4,l-=4,286<n.nlen||30<n.ndist){e.msg="too many length or distance symbols",n.mode=30;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;l<3;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}n.lens[L[n.have++]]=7&u,u>>>=3,l-=3}for(;n.have<19;)n.lens[L[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,E={bits:n.lenbits},T=ic(0,n.lens,0,19,n.lencode,0,n.work,E),n.lenbits=E.bits,T){e.msg="invalid code lengths set",n.mode=30;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;m=(R=n.lencode[u&(1<<n.lenbits)-1])>>>16&255,v=65535&R,!((f=R>>>24)<=l);){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(v<16)u>>>=f,l-=f,n.lens[n.have++]=v;else{if(16===v){for(D=f+2;l<D;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(u>>>=f,l-=f,0===n.have){e.msg="invalid bit length repeat",n.mode=30;break}C=n.lens[n.have-1],_=3+(3&u),u>>>=2,l-=2}else if(17===v){for(D=f+3;l<D;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}C=0,_=3+(7&(u>>>=f)),u>>>=3,l=l-f-3}else{for(D=f+7;l<D;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}C=0,_=11+(127&(u>>>=f)),u>>>=7,l=l-f-7}if(n.have+_>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=30;break}for(;_--;)n.lens[n.have++]=C}}if(30===n.mode)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=30;break}if(n.lenbits=9,E={bits:n.lenbits},T=ic(1,n.lens,0,n.nlen,n.lencode,0,n.work,E),n.lenbits=E.bits,T){e.msg="invalid literal/lengths set",n.mode=30;break}if(n.distbits=6,n.distcode=n.distdyn,E={bits:n.distbits},T=ic(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,E),n.distbits=E.bits,T){e.msg="invalid distances set",n.mode=30;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(6<=r&&258<=c){e.next_out=a,e.avail_out=c,e.next_in=s,e.avail_in=r,n.hold=u,n.bits=l,K=V=b=U=G=P=N=O=oe=ne=te=ee=$=Z=Q=X=z=J=j=Y=W=H=B=x=q=void 0;var O,N,P,G,U,b,w=e,F=p,q=w.state,x=w.next_in,V=w.input,B=x+(w.avail_in-5),H=w.next_out,K=w.output,W=H-(F-w.avail_out),Y=H+(w.avail_out-257),j=q.dmax,J=q.wsize,z=q.whave,X=q.wnext,Q=q.window,Z=q.hold,$=q.bits,ee=q.lencode,te=q.distcode,ne=(1<<q.lenbits)-1,oe=(1<<q.distbits)-1;t:do{for($<15&&(Z+=V[x++]<<$,$+=8,Z+=V[x++]<<$,$+=8),O=ee[Z&ne];;){if(Z>>>=N=O>>>24,$-=N,0==(N=O>>>16&255))K[H++]=65535&O;else{if(!(16&N)){if(!(64&N)){O=ee[(65535&O)+(Z&(1<<N)-1)];continue}if(32&N){q.mode=12;break t}w.msg="invalid literal/length code",q.mode=30;break t}for(P=65535&O,(N&=15)&&($<N&&(Z+=V[x++]<<$,$+=8),P+=Z&(1<<N)-1,Z>>>=N,$-=N),$<15&&(Z+=V[x++]<<$,$+=8,Z+=V[x++]<<$,$+=8),O=te[Z&oe];;){if(Z>>>=N=O>>>24,$-=N,!(16&(N=O>>>16&255))){if(!(64&N)){O=te[(65535&O)+(Z&(1<<N)-1)];continue}w.msg="invalid distance code",q.mode=30;break t}if(G=65535&O,$<(N&=15)&&(Z+=V[x++]<<$,($+=8)<N&&(Z+=V[x++]<<$,$+=8)),(G+=Z&(1<<N)-1)>j){w.msg="invalid distance too far back",q.mode=30;break t}if(Z>>>=N,$-=N,G>(N=H-W)){if((N=G-N)>z&&q.sane){w.msg="invalid distance too far back",q.mode=30;break t}if(b=Q,(U=0)===X){if(U+=J-N,N<P){for(P-=N;K[H++]=Q[U++],--N;);U=H-G,b=K}}else if(X<N){if(U+=J+X-N,(N-=X)<P){for(P-=N;K[H++]=Q[U++],--N;);if(U=0,X<P){for(P-=N=X;K[H++]=Q[U++],--N;);U=H-G,b=K}}}else if(U+=X-N,N<P){for(P-=N;K[H++]=Q[U++],--N;);U=H-G,b=K}for(;2<P;)K[H++]=b[U++],K[H++]=b[U++],K[H++]=b[U++],P-=3;P&&(K[H++]=b[U++],1<P&&(K[H++]=b[U++]))}else{for(U=H-G;K[H++]=K[U++],K[H++]=K[U++],K[H++]=K[U++],2<(P-=3););P&&(K[H++]=K[U++],1<P&&(K[H++]=K[U++]))}break}}break}}while(x<B&&H<Y);x-=P=$>>3,Z&=(1<<($-=P<<3))-1,w.next_in=x,w.next_out=H,w.avail_in=x<B?B-x+5:5-(x-B),w.avail_out=H<Y?Y-H+257:257-(H-Y),q.hold=Z,q.bits=$,a=e.next_out,i=e.output,c=e.avail_out,s=e.next_in,o=e.input,r=e.avail_in,u=n.hold,l=n.bits,12===n.mode&&(n.back=-1);break}for(n.back=0;m=(R=n.lencode[u&(1<<n.lenbits)-1])>>>16&255,v=65535&R,!((f=R>>>24)<=l);){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(m&&!(240&m)){for(I=f,y=m,M=v;m=(R=n.lencode[M+((u&(1<<I+y)-1)>>I)])>>>16&255,v=65535&R,!(I+(f=R>>>24)<=l);){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}u>>>=I,l-=I,n.back+=I}if(u>>>=f,l-=f,n.back+=f,n.length=v,0===m){n.mode=26;break}if(32&m){n.back=-1,n.mode=12;break}if(64&m){e.msg="invalid literal/length code",n.mode=30;break}n.extra=15&m,n.mode=22;case 22:if(n.extra){for(D=n.extra;l<D;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}n.length+=u&(1<<n.extra)-1,u>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;m=(R=n.distcode[u&(1<<n.distbits)-1])>>>16&255,v=65535&R,!((f=R>>>24)<=l);){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(!(240&m)){for(I=f,y=m,M=v;m=(R=n.distcode[M+((u&(1<<I+y)-1)>>I)])>>>16&255,v=65535&R,!(I+(f=R>>>24)<=l);){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}u>>>=I,l-=I,n.back+=I}if(u>>>=f,l-=f,n.back+=f,64&m){e.msg="invalid distance code",n.mode=30;break}n.offset=v,n.extra=15&m,n.mode=24;case 24:if(n.extra){for(D=n.extra;l<D;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}n.offset+=u&(1<<n.extra)-1,u>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=30;break}n.mode=25;case 25:if(0===c)break e;if(n.offset>(_=p-c)){if((_=n.offset-_)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=30;break}h=_>n.wnext?(_-=n.wnext,n.wsize-_):n.wnext-_,_>n.length&&(_=n.length),g=n.window}else g=i,h=a-n.offset,_=n.length;for(c-=_=c<_?c:_,n.length-=_;i[a++]=g[h++],--_;);0===n.length&&(n.mode=21);break;case 26:if(0===c)break e;i[a++]=n.length,c--,n.mode=21;break;case 27:if(n.wrap){for(;l<32;){if(0===r)break e;r--,u|=o[s++]<<l,l+=8}if(p-=c,e.total_out+=p,n.total+=p,p&&(e.adler=n.check=(n.flags?oc:nc)(n.check,i,p,a-p)),p=c,(n.flags?u:lc(u))!==n.check){e.msg="incorrect data check",n.mode=30;break}l=u=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;l<32;){if(0===r)break e;r--,u+=o[s++]<<l,l+=8}if(u!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=30;break}l=u=0}n.mode=29;case 29:T=1;break e;case 30:T=-3;break e;case 31:return-4;default:return-2}return e.next_out=a,e.avail_out=c,e.next_in=s,e.avail_in=r,n.hold=u,n.bits=l,(n.wsize||p!==e.avail_out&&n.mode<30&&(n.mode<27||4!==t))&&Ic(e,e.output,e.next_out,p-e.avail_out),d-=e.avail_in,p-=e.avail_out,e.total_in+=d,e.total_out+=p,n.total+=p,n.wrap&&p&&(e.adler=n.check=(n.flags?oc:nc)(n.check,i,p,e.next_out-p)),e.data_type=n.bits+(n.last?64:0)+(12===n.mode?128:0)+(20===n.mode||15===n.mode?256:0),(0==d&&0===p||4===t)&&0===T?-5:T},inflateEnd:function(e){if(!e||!e.state)return-2;var t=e.state;return t.window&&(t.window=null),e.state=null,0},inflateGetHeader:function(e,t){var n;return e&&e.state&&2&(n=e.state).wrap?((n.head=t).done=!1,0):-2},inflateSetDictionary:function(e,t){var n,o=t.length;return!e||!e.state||0!==(n=e.state).wrap&&11!==n.mode?-2:11===n.mode&&nc(1,t,o,0)!==n.check?-3:Ic(e,t,o,o)?(n.mode=31,-4):(n.havedict=1,0)},inflateInfo:"pako inflate (from Nodeca project)"},Mc=!0,Cc=!0;try{String.fromCharCode.apply(null,[0])}catch(s){Mc=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(s){Cc=!1}for(var Tc=new Lr.Buf8(256),Ec=0;Ec<256;Ec++)Tc[Ec]=252<=Ec?6:248<=Ec?5:240<=Ec?4:224<=Ec?3:192<=Ec?2:1;function Dc(e,t){for(var n,o,i=t||e.length,s=new Array(2*i),a=0,r=0;r<i;)if((n=e[r++])<128)s[a++]=n;else if(4<(o=Tc[n]))s[a++]=65533,r+=o-1;else{for(n&=2===o?31:3===o?15:7;1<o&&r<i;)n=n<<6|63&e[r++],o--;1<o?s[a++]=65533:n<65536?s[a++]=n:(n-=65536,s[a++]=55296|n>>10&1023,s[a++]=56320|1023&n)}var c=s,u=a;if(u<65534&&(c.subarray&&Cc||!c.subarray&&Mc))return String.fromCharCode.apply(null,Lr.shrinkBuf(c,u));for(var l="",d=0;d<u;d++)l+=String.fromCharCode(c[d]);return l}function Rc(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function Sc(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}Tc[254]=Tc[254]=1;var Lc={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8},Ac={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},kc=Object.prototype.toString;function Oc(e){if(!(this instanceof Oc))return new Oc(e);this.options=Lr.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;if(t.raw&&0<=t.windowBits&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(0<=t.windowBits&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),15<t.windowBits&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Rc,this.strm.avail_out=0,(e=yc.inflateInit2(this.strm,t.windowBits))!==Lc.Z_OK)throw new Error(Ac[e]);if(this.header=new Sc,yc.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=function(e){for(var t,n,o,i,s=e.length,a=0,r=0;r<s;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<s&&56320==(64512&(o=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(o-56320),r++),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Lr.Buf8(a),r=i=0;i<a;r++)55296==(64512&(n=e.charCodeAt(r)))&&r+1<s&&56320==(64512&(o=e.charCodeAt(r+1)))&&(n=65536+(n-55296<<10)+(o-56320),r++),n<128?t[i++]=n:(n<2048?t[i++]=192|n>>>6:(n<65536?t[i++]=224|n>>>12:(t[i++]=240|n>>>18,t[i++]=128|n>>>12&63),t[i++]=128|n>>>6&63),t[i++]=128|63&n);return t}(t.dictionary):"[object ArrayBuffer]"===kc.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(e=yc.inflateSetDictionary(this.strm,t.dictionary))!==Lc.Z_OK))throw new Error(Ac[e])}function Nc(e,t){if((t=new Oc(t)).push(e,!0),t.err)throw t.msg||Ac[t.err];return t.result}Oc.prototype.push=function(e,t){var n,o,i,s,a,r=this.strm,c=this.options.chunkSize,u=this.options.dictionary,l=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?Lc.Z_FINISH:Lc.Z_NO_FLUSH,"string"==typeof e?r.input=function(e){for(var t=new Lr.Buf8(e.length),n=0,o=t.length;n<o;n++)t[n]=e.charCodeAt(n);return t}(e):"[object ArrayBuffer]"===kc.call(e)?r.input=new Uint8Array(e):r.input=e,r.next_in=0,r.avail_in=r.input.length;do{if(0===r.avail_out&&(r.output=new Lr.Buf8(c),r.next_out=0,r.avail_out=c),(n=(n=yc.inflate(r,Lc.Z_NO_FLUSH))===Lc.Z_NEED_DICT&&u?yc.inflateSetDictionary(this.strm,u):n)===Lc.Z_BUF_ERROR&&!0===l&&(n=Lc.Z_OK,l=!1),n!==Lc.Z_STREAM_END&&n!==Lc.Z_OK)return this.onEnd(n),!(this.ended=!0);r.next_out&&(0!==r.avail_out&&n!==Lc.Z_STREAM_END&&(0!==r.avail_in||o!==Lc.Z_FINISH&&o!==Lc.Z_SYNC_FLUSH)||("string"===this.options.to?(i=function(e,t){for(var n=(t=(t=t||e.length)>e.length?e.length:t)-1;0<=n&&128==(192&e[n]);)n--;return!(n<0||0===n)&&n+Tc[e[n]]>t?n:t}(r.output,r.next_out),s=r.next_out-i,a=Dc(r.output,i),r.next_out=s,r.avail_out=c-s,s&&Lr.arraySet(r.output,r.output,i,s,0),this.onData(a)):this.onData(Lr.shrinkBuf(r.output,r.next_out)))),0===r.avail_in&&0===r.avail_out&&(l=!0)}while((0<r.avail_in||0===r.avail_out)&&n!==Lc.Z_STREAM_END);return(o=n===Lc.Z_STREAM_END?Lc.Z_FINISH:o)===Lc.Z_FINISH?(n=yc.inflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Lc.Z_OK):o!==Lc.Z_SYNC_FLUSH||(this.onEnd(Lc.Z_OK),!(r.avail_out=0))},Oc.prototype.onData=function(e){this.chunks.push(e)},Oc.prototype.onEnd=function(e){e===Lc.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Lr.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},$={},(0,Lr.assign)($,{Inflate:Oc,inflate:Nc,inflateRaw:function(e,t){return(t=t||{}).raw=!0,Nc(e,t)},ungzip:Nc},Lc);var Pc,Gc=$,Uc=(s($c,[{key:"inflate",value:function(e){e=new Uint8Array(e).slice(4);var t,n=Date.now();try{t=Gc.inflate(e,{to:"string"}),this._bLogForInflateOK||(this._bLogForInflateOK=!0,new so("inflateOK").end())}catch(e){return this._bLogForInflateError?void 0:(this._bLogForInflateError=!0,void new so("inflateError").setMessage(e).end())}e=e.length+4;var o=t.length;return Ne.d("inflate ok. zipped:".concat(e," unzipped:").concat(o)+" compression ratio:".concat(Math.round(100*(o-e)/o),"% cost:").concat(Date.now()-n)),t}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._bLogForInflateOK=!1,this._bLogForInflateError=!1}}]),$c),bc="Message",wc="User",Fc="Group",qc="GroupMember",xc=["count"],Vc=["conversationID","timePosition","timePeriod"],Bc=["miniBirthday","maxBirthday"],Hc=(a(J={},bc,Kn.CS),a(J,wc,Kn.USER_CS),a(J,Fc,Kn.GRP_CS),a(J,qc,Kn.MBR_CS),J),Kc=(r(Zc,bn),Pc=g(Zc),s(Zc,[{key:"searchCloudMessages",value:function(e){return this.search(bc,e)}},{key:"searchCloudUsers",value:function(e){return this.search(wc,e)}},{key:"searchCloudGroups",value:function(e){return this.search(Fc,e)}},{key:"searchCloudGroupMembers",value:function(e){return this.search(qc,e)}},{key:"search",value:function(e,t){var n=this,o="searchCloud".concat(e,"s"),i="".concat(this._n,".").concat(o);if(!t)return Rn({code:Bn.OPTIONS_IS_EMPTY,message:this.getErrMsg(Bn.OPTIONS_IS_EMPTY,o)});var s=t.keywordList,a=Qe(s),r=t.count;if(t.count&&(r=parseInt(r)),e===bc&&!a&&!Qe(t.senderUserIDList)&&!Qe(t.messageTypeList)||e!==bc&&!a)throw Ne.e("[".concat(o,'] Missing required params: "keywordList".')),new Error("Params validate failed.");var c=Date.now(),u=new so(o),l="keywordList:".concat(s," keywordListMatchType:").concat(t.keywordListMatchType," cursor:").concat(t.cursor," count:").concat(r);return Ne.l("".concat(i," ").concat(l)),this.req({P:Hc[e],data:this._genParams(e,t)}).then((function(o){var s=(a=o.data).code,a=a.message;if(0!==s)return 60020===(r=s)?r="SearchUnable":e!==bc&&27003===s?r="SearchParamsError":e!==bc&&60018===s&&(r="SearchOverLimit"),r=n.getErrMsg(r)||a,a=new Vn({code:s,message:r}),u.setMessage(l).setError(a).end(),Rn(a);n.get(27).isCSPluginEnabled(),a=void 0===(r=(s=o.data).cursor)?"":r;var r=s.totalCount;return s="totalCount:".concat(r," cost:").concat(Jt(c)),En({searchResultList:(Ne.l("".concat(i," ok. cursor:").concat(a," ").concat(s)),u.setMessage("".concat(l," ").concat(s)).end(),s=n._genRes(e,t,o.data)),cursor:a,totalCount:r})})).catch((function(e){return u.setMessage(l).setError(e).end(),Rn(e)}))}},{key:"_genParams",value:function(e,t){var n=t.count,o=_(t,xc);return n&&(o.count=parseInt(n)),e===bc?this._genMsgParams(o):(n=t.keywordList,t=t.keywordListMatchType,o.keywords=n,o.keywordMatchType="and"===t?1:0,e===wc?this._genUserParams(o):o)}},{key:"_genMsgParams",value:function(e){var t=e.conversationID,n=e.timePosition,o=e.timePeriod;return e=_(e,Vc),pt(t)||(Rt(t)&&(e.account=t.replace(D.CONV_C2C,"")),St(t)&&(e.groupID=t.replace(D.CONV_GROUP,""))),je(o)&&0<o&&(je(n)&&0<n?e.startTime=n-o:e.startTime=De()-o),e.startTime&&e.startTime<0&&(e.startTime=void 0),je(n)&&0<n&&(e.endTime=n),e}},{key:"_genUserParams",value:function(e){var t=e.miniBirthday,n=e.maxBirthday;return e=_(e,Bc),je(t)&&(e.miniBirthday=parseInt(t),je(n)||(e.maxBirthday=4294967295)),je(n)&&(e.maxBirthday=parseInt(n)),e}},{key:"_genRes",value:function(e,t,n){switch(e){case bc:return this._genMsgRes(n.searchResult,!t.conversationID);case wc:return this._genUserRes(n.userList);case Fc:return this._genGrpRes(n.groupList);case qc:return this._genMemberRes(n.groupMemberList);default:return[]}}},{key:"_genMsgRes",value:function(e,t){var n=this.get(11);return Xe(e)&&0!==e.length?e.map((function(e){var o=e.groupID,i=e.userID,s=e.messageCount,a=(e=void 0===(e=e.messageList)?[]:e,{conversationID:i=o?"".concat(D.CONV_GROUP).concat(o):"".concat(D.CONV_C2C).concat(i),messageCount:s,messageList:[]});return t&&1<s||0<(s=e.filter((function(e){return!!e}))).length&&(e=n.onRoamingMessage(s,i,!1),o&&e.reverse(),a.messageList=e,a.messageCount=e.length),a})):[]}},{key:"_genUserRes",value:function(e){var t=this.get(4)._profileHandler;if(!Xe(e))return[];for(var n=[],o=0,i=e.length;o<i;o++){var s=(a=e[o]).userID,a=a.profileItems;"@TLS#NOT_FOUND"!==s&&""!==s&&(s=t._update(s,t._getLatestProfileFromResponse(s,a)).latestProfile,n.push(s))}return n}},{key:"_genGrpRes",value:function(e){if(!Xe(e))return[];for(var t=[],n=0,o=e.length;n<o;n++)e[n]&&e[n].groupID&&t.push(new di(e[n]));return t}},{key:"_genMemberRes",value:function(e){if(!Xe(e))return[];for(var t,n,o,i,s,a,r=new Map,c=0,u=e.length;c<u;c++)e[c]&&e[c].userID&&e[c].groupID&&(n=(t=e[c]).groupID,i=t.name,s=t.type,a=t.avatar,o=t.nick,i={groupID:n,name:i,type:s,avatar:a},s={userID:t.userID,nick:o,nameCard:t.nameCard},r.has(n)?((a=r.get(n)).memberList.push(s),r.set(n,a)):r.set(n,{groupInfo:i,memberList:[s]}));return m(r.values())}}]),Zc),Wc=(s(Qc,[{key:"_startTimer",value:function(){var e=this._map.get(24),t=e.isWorkerEnabled();Ne.l("".concat(this._n,".startTimer isWorkerEnabled:").concat(t," seed:").concat(this._checkTimer)),t?e.startWorkerTimer():this._startMainThreadTimer()}},{key:"_startMainThreadTimer",value:function(){this._checkTimer<0&&(this._checkTimer=setInterval(this.onCheckTimer.bind(this),1e3)),Ne.l("".concat(this._n,"._startMainThreadTimer seed:").concat(this._checkTimer))}},{key:"stopTimer",value:function(){var e=this._map.get(24),t=e.isWorkerEnabled();Ne.l("".concat(this._n,".stopTimer isWorkerEnabled:").concat(t," seed:").concat(this._checkTimer)),t?e.stopWorkerTimer():this._stopMainThreadTimer()}},{key:"_stopMainThreadTimer",value:function(){Ne.l("".concat(this._n,"._stopMainThreadTimer")),0<this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=-1,this._checkCount=0)}},{key:"_stopMainThreadSocket",value:function(){Ne.l("".concat(this._n,"._stopMainThreadSocket"));var e=this._map.get(21);e.setIsWorkerEnabled(!0),e.reConnect()}},{key:"_startMainThreadSocket",value:function(){Ne.l("".concat(this._n,"._startMainThreadSocket"));var e=this._map.get(21);e.setIsWorkerEnabled(!1),e.reConnect()}},{key:"onWorkerTimerEnabled",value:function(){Ne.l("".concat(this._n,".onWorkerTimerEnabled, disable main thread timer and socket")),this._stopMainThreadTimer(),this._stopMainThreadSocket()}},{key:"onWorkerTimerDisabled",value:function(){Ne.l("".concat(this._n,".onWorkerTimerDisabled, enable main thread timer and socket")),this._startMainThreadTimer(),this._startMainThreadSocket()}},{key:"onCheckTimer",value:function(){this._checkCount+=1;var e,t=T(this._map);try{for(t.s();!(e=t.n()).done;){var n=f(e.value,2)[1];n.onCheckTimer&&n.onCheckTimer(this._checkCount)}}catch(e){t.e(e)}finally{t.f()}}},{key:"_initReadyList",value:function(){var e=this;this._readyList=[this._map.get(1)],this._readyList.forEach((function(t){t.ready((function(){return e._onModuleReady()}))}))}},{key:"_onModuleReady",value:function(){var e,t,n=!0;this._readyList.forEach((function(e){e.isReady()||(n=!1)})),n&&!this._isReady&&(this._isReady=!0,this._oEmitter.emit(E.SDK_READY),e=Date.now()-this._startLoginTs,Ne.w("SDK is ready. cost ".concat(e," ms")),this._startLoginTs=Date.now(),t=this._ssoLogForReady.getStartTs()+Se,this._ssoLogForReady.setMessage(e).start(t).end())}},{key:"login",value:function(){0===this._startLoginTs&&(Ee(),this._startLoginTs=Date.now(),this._startTimer(),this._map.get(15).start(),this._ssoLogForReady=new so("sdkReady"),this._reason=Bn.LOGGING_IN)}},{key:"onLoginFailed",value:function(){this._startLoginTs=0}},{key:"getOEmitInst",value:function(){return null===this._oEmitter&&(this._oEmitter=new Ss,e=this._oEmitter,Hn=e,this._oEmitter._emit=this._oEmitter.emit,this._oEmitter.emit=function(e,t){var n,o,i=this;this._canIUseSignaling()&&(e===E.MESSAGE_RECEIVED&&this.get(33).onNewMessageList(t),e===E.MESSAGE_MODIFIED&&this.get(33).onMessageModified(t)),e===E.CONVERSATION_LIST_UPDATED||e===E.FRIEND_LIST_UPDATED||e===E.GROUP_LIST_UPDATED||e===E.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?!1!==this._eventThrottling?this._eventThrottleMap.has(e)?(n=Date.now())-(o=this._eventThrottleMap.get(e)).last<=1e3?(-1<o.timeoutID&&clearTimeout(o.timeoutID),o.timeoutID=setTimeout((function(){o.last=Date.now(),i._oEmitter._emit.apply(i._oEmitter,[e,{name:e,data:i._getEventData(e)}])}),1e3)):(o.last=n,this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:this._getEventData(e)}])):(this._eventThrottleMap.set(e,{last:Date.now(),timeoutID:-1}),this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:this._getEventData(e)}])):this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:this._getEventData(e)}]):this._oEmitter._emit.apply(this._oEmitter,[e,{name:e,data:t}])}.bind(this)),this._oEmitter;var e}},{key:"_canIUseSignaling",value:function(){var e=this.get(33);return!!e&&e.canIUseSignaling()}},{key:"_getEventData",value:function(e){return e===E.CONVERSATION_LIST_UPDATED?this._map.get(12).isPartialUpdatedConvs()?this._map.get(11).getPartialUpdatedConvs():this._map.get(11).getLocalConvList():e===E.FRIEND_LIST_UPDATED?this._map.get(8).getLocalFriendList(!1):e===E.GROUP_LIST_UPDATED?this._map.get(7).getLocalGroupList():e===E.TOTAL_UNREAD_MESSAGE_COUNT_UPDATED?this._map.get(11).getTotalUnreadCount():e===E.CONVERSATION_ID_LIST_UPDATED?this._map.get(11).getUpdatedConvIDList():void 0}},{key:"getIEmitInst",value:function(){return null===this._iEmitter&&(this._iEmitter=new Ss,this._iEmitter._emit=this._iEmitter.emit,this._iEmitter.emit=function(e,t){e=ze(t)&&t.data?[e,{name:e,data:t.data}]:[e,{name:e,data:t}],this._iEmitter._emit.apply(this._iEmitter,e)}.bind(this)),this._iEmitter}},{key:"hasModule",value:function(e){return this._map.has(e)}},{key:"get",value:function(e){return this._map.get(e)}},{key:"canIUseModule",value:function(e){return!this._map.get(12).isUsingChatCore()||this._optionalModuleMap.has(e)}},{key:"canIUseInflate",value:function(){return!!this._map.get(37)}},{key:"isReady",value:function(){return this._isReady}},{key:"isIntl",value:function(){return this.get(12).isIntl()}},{key:"getNotReadyReason",value:function(){return this._reason}},{key:"setNotReadyReason",value:function(e){this._reason=e}},{key:"getErrMsg",value:function(e,t,n){return this._map.get(32).get({key:e,replacement1:t,replacement2:n,isIntl:this.isIntl()})}},{key:"warn",value:function(e,t,n){(e=this.getErrMsg(e,t,n))&&Ne.w(e)}},{key:"onError",value:function(e){var t="code:".concat(e.code," message:").concat(e.message);Ne.w("Oops! ".concat(t)),new so("error").setMessage(t).setLevel("error").end(),this.getOEmitInst().emit(E.ERROR,e)}},{key:"restartTimer",value:function(){Ne.l("".concat(this._n,".restartTimer")),this.stopTimer(),this._startTimer();var e=this.get(7);e&&e.restartPolling()}},{key:"getTimerID",value:function(){var e=this._map.get(24);return e.isWorkerEnabled()?e.getTimerID():this._checkTimer}},{key:"getPollingTimerID",value:function(e){return this._map.get(7).getPollingTimerID(e)}},{key:"statTUIKeyFeatures",value:function(e){var t=e.code,n=t+(e=void 0===(e=e.msg)?"":e);this._codeMsgForTUIMap.has(n)||(this._codeMsgForTUIMap.set(n,1),n=this.get(12).getUIPlatform(),new so("tui_key_features").setCode(t).setMessage(e).setUIPlatform(n).end())}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),Ee();var e,t=T(this._map);try{for(t.s();!(e=t.n()).done;){var n=f(e.value,2)[1];n.reset&&n.reset()}}catch(e){t.e(e)}finally{t.f()}this._startLoginTs=0,this._initReadyList(),this._isReady=!1,this.stopTimer(),this._oEmitter.emit(E.SDK_NOT_READY);var o,i=T(this._eventThrottleMap);try{for(i.s();!(o=i.n()).done;){var s=f(o.value,2)[1];-1<s.timeoutID&&clearTimeout(s.timeoutID)}}catch(e){i.e(e)}finally{i.f()}this._eventThrottleMap.clear(),this._codeMsgForTUIMap.clear()}}]),Qc),Yc=(s(Xc,[{key:"defense",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;if("string"!=typeof e)return null;if(0===e.length)return null;if("function"!=typeof t)return null;if(this._funcMap.has(e)&&this._funcMap.get(e).has(t))return this._funcMap.get(e).get(t);this._funcMap.has(e)||this._funcMap.set(e,new Map);var o=null;return this._funcMap.get(e).has(t)?o=this._funcMap.get(e).get(t):(o=this._pack(e,t,n),this._funcMap.get(e).set(t,o)),o}},{key:"defenseOnce",value:function(e,t){return"function"!=typeof t?null:this._pack(e,t,2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0)}},{key:"find",value:function(e,t){return"string"!=typeof e||0===e.length||"function"!=typeof t?null:this._funcMap.has(e)&&this._funcMap.get(e).has(t)?this._funcMap.get(e).get(t):(this._m.warn("ListenerFnNotFound",e),null)}},{key:"delete",value:function(e,t){return"function"==typeof t&&!!this._funcMap.has(e)&&!!this._funcMap.get(e).has(t)&&(this._funcMap.get(e).delete(t),0===this._funcMap.get(e).size&&this._funcMap.delete(e),!0)}},{key:"_pack",value:function(e,t,n){var o=this;return function(){try{t.apply(n,Array.from(arguments))}catch(t){var i=Object.values(E).indexOf(e),s="CallbackError";-1!==i&&(i=Object.keys(E)[i],o._m.warn(s,i,t)),o._reportCount<5&&(new so(s).setMessage("eventName:".concat(e)).setMoreMessage(t.message).end(),o._reportCount+=1)}}}},{key:"destroy",value:function(){this._funcMap.clear()}},{key:"reset",value:function(){Ne.l("".concat(this._n,".reset")),this._reportCount=0}}]),Xc),jc=(s(zc,[{key:"onError",value:function(e){this._m.onError(e)}},{key:"login",value:function(e){return this._m.login(),this._get(1).login(e)}},{key:"logout",value:function(){var e=this;return this._get(1).logout().then((function(t){return e._safetyCallbackFactory.reset(),e._m.reset(),t}))}},{key:"getLoginUser",value:function(){return this._get(1).getLoginUser()}},{key:"getServerTime",value:function(){return Le()}},{key:"isReady",value:function(){return this._m.isReady()}},{key:"isIntl",value:function(){return this._m.isIntl()}},{key:"getNotReadyReason",value:function(){return this._m.getNotReadyReason()}},{key:"getErrMsg",value:function(e,t,n){return this._m.getErrMsg(e,t,n)}},{key:"_get",value:function(e){return this._m.get(e)}},{key:"destroy",value:function(){var e=this,t=this._get(12),n=t.getSDKAppID();return Ne.w("destroy ".concat(n," ").concat(t.getInstanceID())),this.logout().finally((function(){e._safetyCallbackFactory.destroy(),e._m.stopTimer(),e._get(24).terminate(),e._get(21).dealloc(),e._m.getOEmitInst().emit(E.SDK_DESTROY,{SDKAppID:n})}))}},{key:"on",value:function(e,t,n){Ne.d("on","eventName:".concat(e)),this._m.getOEmitInst().on(e,this._safetyCallbackFactory.defense(e,t,n),n)}},{key:"once",value:function(e,t,n){Ne.d("once","eventName:".concat(e)),this._m.getOEmitInst().once(e,this._safetyCallbackFactory.defenseOnce(e,t,n),n||this)}},{key:"off",value:function(e,t,n,o){Ne.d("off","eventName:".concat(e));var i=this._safetyCallbackFactory.find(e,t);null!==i&&(this._m.getOEmitInst().off(e,i,n,o),this._safetyCallbackFactory.delete(e,t))}},{key:"registerPlugin",value:function(e){(pt(e["tim-push"])?pt(e["tim-offline-push-plugin"])?this._get(18):this._get(28):this._get(36)).registerPlugin(e)}},{key:"setLogLevel",value:function(e){var t;e<=0&&((t=this.getErrMsg("TIM_ASCII_ART"))&&console.log(t),(t=this.getErrMsg("API_REFER"))&&(Kt()?console.log("%c ".concat("IM SDK API ->"," %c"),"background:#ff9d00; padding:1px; border-radius:3px; color: #fff","background:transparent",t):console.log("IM SDK API ->",t)),(t=this.getErrMsg("DOCS_GUIDE"))&&console.log(t),t=this.getErrMsg("IOS_WEBVIEW_WARNING"),ve&&t&&console.warn(t)),Ne.setLevel(e)}},{key:"createTextMessage",value:function(e){return this._get(2).createTextMessage(e)}},{key:"createTextAtMessage",value:function(e){return this._get(2).createTextMessage(e)}},{key:"createImageMessage",value:function(e){return this._get(2).createImageMessage(e)}},{key:"createAudioMessage",value:function(e){return this._get(2).createAudioMessage(e)}},{key:"createVideoMessage",value:function(e){return this._get(2).createVideoMessage(e)}},{key:"createCustomMessage",value:function(e){return this._get(2).createCustomMessage(e)}},{key:"createFaceMessage",value:function(e){return this._get(2).createFaceMessage(e)}},{key:"createFileMessage",value:function(e){return this._get(2).createFileMessage(e)}},{key:"createLocationMessage",value:function(e){return this._get(2).createLocationMessage(e)}},{key:"createMergerMessage",value:function(e){return this._get(2).createMergerMessage(e)}},{key:"downloadMergerMessage",value:function(e){return e.type!==D.MSG_MERGER?Rn({code:Bn.MSG_MERGER_TYPE_INVALID}):He(e.payload.downloadKey)?Rn({code:Bn.MSG_MERGER_KEY_INVALID}):this._get(2).downloadMergerMessage(e).catch((function(e){return Rn({code:Bn.MSG_MERGER_DOWNLOAD_FAIL})}))}},{key:"createForwardMessage",value:function(e){return this._get(2).createForwardMessage(e)}},{key:"sendMessage",value:function(e,t){return e instanceof ko?this._get(2).sendMessageInstance(e,t):Rn({code:Bn.MSG_INSTANCE_REQUIRED})}},{key:"callExperimentalAPI",value:function(e,t){return"sendComboMessage"===e?this._get(31).sendMessage(t):"handleGroupInvitation"===e?this._get(7).handleGroupInvitation(t):"isCommercialAbilityEnabled"===e?this._get(27).isFeatureEnabled(t):"isFeatureEnabledForStat"===e?this._get(27).isFeatureEnabledForStat(t):"isIntl"===e?this.isIntl():"sendTRTCCustomData"===e||"sendRoomCustomData"===e?this._get(30).sendTRTCCustomData(t):"getTimerID"===e?this._m.getTimerID():"getPollingTimerID"===e?this._m.getPollingTimerID(t):"setApplicationID"===e?(this._get(12).setApplicationID(t),void this._get(20).updateProtocolConfig()):"getServerConfig"===e?this._get(23).getServerConfig(t):"canIUseModule"===e?this._m.canIUseModule(t):"startMessageLongPolling"===e?this._get(7).startMessageLongPolling(t):"stopMessageLongPolling"===e?this._get(7).stopMessageLongPolling(t):"disableMessagePullOnInvite"===e?this._get(11).disableMsgPullOnInvite(t):"clearLocalMessage"===e?this._get(11).clearMemMsg(t,!1):"setCustomLoginInfo"===e?this._get(12).setCustomLoginInfo(t):"statTUIKeyFeatures"===e?this._m.statTUIKeyFeatures(t):Rn({code:Bn.INVALID_OPERATION})}},{key:"revokeMessage",value:function(e){return this._get(2).revokeMessage(e)}},{key:"resendMessage",value:function(e,t){return e instanceof ko?this._get(2).resendMessage(e,t):Rn({code:Bn.MSG_INSTANCE_REQUIRED})}},{key:"deleteMessage",value:function(e){return this._get(2).deleteMessage(e)}},{key:"translateText",value:function(e){return this._get(2).translateText(e)}},{key:"convertVoiceToText",value:function(e){return this._get(2).convertVoiceToText(e)}},{key:"setMessageExtensions",value:function(e,t){return this._get(3).setMessageExtensions(e,t)}},{key:"getMessageExtensions",value:function(e){return this._get(3).getMessageExtensions(e)}},{key:"deleteMessageExtensions",value:function(e,t){return this._get(3).deleteMessageExtensions(e,t)}},{key:"addMessageReaction",value:function(e,t){return this._get(34).addMessageReaction(e,t)}},{key:"removeMessageReaction",value:function(e,t){return this._get(34).removeMessageReaction(e,t)}},{key:"getMessageReactions",value:function(e){return this._get(34).getMessageReactions(e)}},{key:"getAllUserListOfMessageReaction",value:function(e){return this._get(34).getAllUserListOfMessageReaction(e)}},{key:"modifyMessage",value:function(e){return this._get(2).modifyRemoteMessage(e)}},{key:"getMessageList",value:function(e){return this._get(11).getMessageList(e)}},{key:"getMessageListHopping",value:function(e){return this._get(11).getMessageListHopping(e)}},{key:"sendMessageReadReceipt",value:function(e){return this._get(11).sendReadReceipt(e)}},{key:"getMessageReadReceiptList",value:function(e){return this._get(11).getReadReceiptList(e)}},{key:"getGroupMessageReadMemberList",value:function(e){var t=this._get(7);return t?t.getReadReceiptDetail(e):Rn({code:Bn.NO_MODULE})}},{key:"findMessage",value:function(e){return this._get(11).findMessage(e)}},{key:"setMessageRead",value:function(e){return this._get(11).setMessageRead(e)}},{key:"getConversationList",value:function(e){return this._get(11).getConvList(e)}},{key:"getConversationProfile",value:function(e){return this._get(11).getConversationProfile(e)}},{key:"deleteConversation",value:function(e){return this._get(11).deleteConversation(e)}},{key:"setConversationDraft",value:function(e){return this._get(11).setConvDraft(e)}},{key:"clearHistoryMessage",value:function(e){return this._get(11).clearHistoryMessage(e)}},{key:"pinConversation",value:function(e){return this._get(11).pinConversation(e)}},{key:"setAllMessageRead",value:function(e){return this._get(11).setAllMessageRead(e)}},{key:"setMessageRemindType",value:function(e){return this._get(11).setMessageRemindType(e)}},{key:"setAllReceiveMessageOpt",value:function(e){return this._get(11).setAllRcvMsgOpt(e)}},{key:"getAllReceiveMessageOpt",value:function(){return this._get(11).getAllRcvMsgOpt()}},{key:"getTotalUnreadMessageCount",value:function(){return this._get(11).getTotalUnreadCount()}},{key:"setConversationCustomData",value:function(e){return this._get(11).setConvCustomData(e)}},{key:"markConversation",value:function(e){return this._get(11).markConv(e)}},{key:"getConversationGroupList",value:function(){return this._get(11).getConvGroupList()}},{key:"createConversationGroup",value:function(e){return this._get(11).createConvGroup(e)}},{key:"deleteConversationGroup",value:function(e){return this._get(11).deleteConvGroup(e)}},{key:"renameConversationGroup",value:function(e){return this._get(11).renameConvGroup(e)}},{key:"addConversationsToGroup",value:function(e){return this._get(11).addConvsToGroup(e)}},{key:"deleteConversationsFromGroup",value:function(e){return this._get(11).deleteConvsFromGroup(e)}},{key:"searchCloudMessages",value:function(e){var t=this._get(38);return t?t.searchCloudMessages(e):Rn({code:Bn.NO_MODULE})}},{key:"searchCloudUsers",value:function(e){var t=this._get(38);return t?t.searchCloudUsers(e):Rn({code:Bn.NO_MODULE})}},{key:"searchCloudGroups",value:function(e){var t=this._get(38);return t?t.searchCloudGroups(e):Rn({code:Bn.NO_MODULE})}},{key:"searchCloudGroupMembers",value:function(e){var t=this._get(38);return t?t.searchCloudGroupMembers(e):Rn({code:Bn.NO_MODULE})}},{key:"getMyProfile",value:function(){return this._get(4).getMyProfile()}},{key:"getUserProfile",value:function(e){return this._get(4).getUserProfile(e)}},{key:"updateMyProfile",value:function(e){return this._get(4).updateMyProfile(e)}},{key:"getBlacklist",value:function(){return this._get(4).getLocalBlacklist()}},{key:"addToBlacklist",value:function(e){return this._get(4).addBlacklist(e)}},{key:"removeFromBlacklist",value:function(e){return this._get(4).deleteBlacklist(e)}},{key:"setSelfStatus",value:function(e){return this._get(4).setSelfStatus(e)}},{key:"getUserStatus",value:function(e){return this._get(4).getUserStatus(e)}},{key:"subscribeUserStatus",value:function(e){return this._get(4).subscribeUserStatus(e)}},{key:"unsubscribeUserStatus",value:function(e){return this._get(4).unsubscribeUserStatus(e)}},{key:"getFriendList",value:function(){var e=this._get(8);return e?e.getLocalFriendList():Rn({code:Bn.NO_MODULE})}},{key:"addFriend",value:function(e){var t=this._get(8);return t?t.addFriend(e):Rn({code:Bn.NO_MODULE})}},{key:"deleteFriend",value:function(e){var t=this._get(8);return t?t.deleteFriend(e):Rn({code:Bn.NO_MODULE})}},{key:"checkFriend",value:function(e){var t=this._get(8);return t?t.checkFriend(e):Rn({code:Bn.NO_MODULE})}},{key:"getFriendProfile",value:function(e){var t=this._get(8);return t?t.getFriendProfile(e):Rn({code:Bn.NO_MODULE})}},{key:"updateFriend",value:function(e){var t=this._get(8);return t?t.updateFriend(e):Rn({code:Bn.NO_MODULE})}},{key:"getFriendApplicationList",value:function(){var e=this._get(8);return e?e.getLocalFriendApplicationList():Rn({code:Bn.NO_MODULE})}},{key:"acceptFriendApplication",value:function(e){var t=this._get(8);return t?t.acceptFriendApplication(e):Rn({code:Bn.NO_MODULE})}},{key:"refuseFriendApplication",value:function(e){var t=this._get(8);return t?t.refuseFriendApplication(e):Rn({code:Bn.NO_MODULE})}},{key:"deleteFriendApplication",value:function(e){var t=this._get(8);return t?t.deleteFriendApplication(e):Rn({code:Bn.NO_MODULE})}},{key:"setFriendApplicationRead",value:function(){var e=this._get(8);return e?e.setFriendApplicationRead():Rn({code:Bn.NO_MODULE})}},{key:"getFriendGroupList",value:function(){var e=this._get(8);return e?e.getLocalFriendGroupList():Rn({code:Bn.NO_MODULE})}},{key:"createFriendGroup",value:function(e){var t=this._get(8);return t?t.createFriendGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"deleteFriendGroup",value:function(e){var t=this._get(8);return t?t.deleteFriendGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"addToFriendGroup",value:function(e){var t=this._get(8);return t?t.addToFriendGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"removeFromFriendGroup",value:function(e){var t=this._get(8);return t?t.removeFromFriendGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"renameFriendGroup",value:function(e){var t=this._get(8);return t?t.renameFriendGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"followUser",value:function(e){var t=this._get(35);return t?t.followUser(e):Rn({code:Bn.NO_MODULE})}},{key:"unfollowUser",value:function(e){var t=this._get(35);return t?t.unfollowUser(e):Rn({code:Bn.NO_MODULE})}},{key:"getMyFollowersList",value:function(e){var t=this._get(35);return t?t.getMyFollowersList(e):Rn({code:Bn.NO_MODULE})}},{key:"getMyFollowingList",value:function(e){var t=this._get(35);return t?t.getMyFollowingList(e):Rn({code:Bn.NO_MODULE})}},{key:"getMutualFollowersList",value:function(e){var t=this._get(35);return t?t.getMutualFollowersList(e):Rn({code:Bn.NO_MODULE})}},{key:"getUserFollowInfo",value:function(e){var t=this._get(35);return t?t.getUserFollowInfo(e):Rn({code:Bn.NO_MODULE})}},{key:"checkFollowType",value:function(e){var t=this._get(35);return t?t.checkFollowType(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupList",value:function(){var e=this._get(7);return e?e.getGroupList():Rn({code:Bn.NO_MODULE})}},{key:"getGroupProfile",value:function(e){var t=this._get(7);return t?t.getGroupProfile(e):Rn({code:Bn.NO_MODULE})}},{key:"createGroup",value:function(e){var t=this._get(7);return t?t.createGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"dismissGroup",value:function(e){var t=this._get(7);return t?t.dismissGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"updateGroupProfile",value:function(e){var t=this._get(7);return t?t.updateGroupProfile(e):Rn({code:Bn.NO_MODULE})}},{key:"joinGroup",value:function(e){var t=this._get(7);return t?t.joinGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"quitGroup",value:function(e){var t=this._get(7);return t?t.quitGroup(e):Rn({code:Bn.NO_MODULE})}},{key:"searchGroupByID",value:function(e){var t=this._get(7);return t?t.searchGroupByID(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupOnlineMemberCount",value:function(e){var t=this._get(7);return t?t.getGroupOnlineMemberCount(e):Rn({code:Bn.NO_MODULE})}},{key:"changeGroupOwner",value:function(e){var t=this._get(7);return t?t.changeGroupOwner(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupApplicationList",value:function(){var e=this._get(7);return e?e.getGroupApplicationList():Rn({code:Bn.NO_MODULE})}},{key:"handleGroupApplication",value:function(e){var t=this._get(7);return t?t.handleGroupApplication(e):Rn({code:Bn.NO_MODULE})}},{key:"initGroupAttributes",value:function(e){var t=this._get(7);return t?t.initGroupAttributes(e):Rn({code:Bn.NO_MODULE})}},{key:"setGroupAttributes",value:function(e){var t=this._get(7);return t?t.setGroupAttributes(e):Rn({code:Bn.NO_MODULE})}},{key:"deleteGroupAttributes",value:function(e){var t=this._get(7);return t?t.deleteGroupAttributes(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupAttributes",value:function(e){var t=this._get(7);return t?t.getGroupAttributes(e):Rn({code:Bn.NO_MODULE})}},{key:"setGroupCounters",value:function(e){var t=this._get(7);return t?t.setGroupCounters(e):Rn({code:Bn.NO_MODULE})}},{key:"increaseGroupCounter",value:function(e){var t=this._get(7);return t?t.increaseGroupCounter(e):Rn({code:Bn.NO_MODULE})}},{key:"decreaseGroupCounter",value:function(e){var t=this._get(7);return t?t.decreaseGroupCounter(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupCounters",value:function(e){var t=this._get(7);return t?t.getGroupCounters(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupMemberList",value:function(e){var t=this._get(7);return t?t.getGroupMemberList(e):Rn({code:Bn.NO_MODULE})}},{key:"getGroupMemberProfile",value:function(e){var t=this._get(7);return t?t.getGroupMemberProfile(e):Rn({code:Bn.NO_MODULE})}},{key:"addGroupMember",value:function(e){var t=this._get(7);return t?t.addGroupMember(e):Rn({code:Bn.NO_MODULE})}},{key:"deleteGroupMember",value:function(e){var t=this._get(7);return t?t.deleteGroupMember(e):Rn({code:Bn.NO_MODULE})}},{key:"setGroupMemberMuteTime",value:function(e){var t=this._get(7);return t?t.setGroupMemberMuteTime(e):Rn({code:Bn.NO_MODULE})}},{key:"setGroupMemberRole",value:function(e){var t=this._get(7);return t?t.setGroupMemberRole(e):Rn({code:Bn.NO_MODULE})}},{key:"setGroupMemberNameCard",value:function(e){var t=this._get(7);return t?t.setGroupMemberNameCard(e):Rn({code:Bn.NO_MODULE})}},{key:"setGroupMemberCustomField",value:function(e){var t=this._get(7);return t?t.setGroupMemberCustomField(e):Rn({code:Bn.NO_MODULE})}},{key:"markGroupMemberList",value:function(e){var t=this._get(7);return t?t.markGroupMemberList(e):Rn({code:Bn.NO_MODULE})}},{key:"getJoinedCommunityList",value:function(){return this._get(10).getJoinedCommunityList()}},{key:"createTopicInCommunity",value:function(e){return this._get(10).createTopicInCommunity(e)}},{key:"deleteTopicFromCommunity",value:function(e){return this._get(10).deleteTopicFromCommunity(e)}},{key:"updateTopicProfile",value:function(e){return this._get(10).updateTopicProfile(e)}},{key:"getTopicList",value:function(e){return this._get(10).getTopicList(e)}},{key:"addSignalingListener",value:function(e,t,n){var o=this._get(33);o&&o.addSignalingListener(e,this._safetyCallbackFactory.defense(e,t,n),n)}},{key:"removeSignalingListener",value:function(e,t,n){var o,i=this._safetyCallbackFactory.find(e,t);null===i||(o=this._get(33))&&(o.removeSignalingListener(e,i,n),this._safetyCallbackFactory.delete(e,t))}},{key:"invite",value:function(e){var t=this._get(33);return t?t.invite(e):Rn({code:Bn.NO_MODULE})}},{key:"inviteSync",value:function(e,t,n){var o=this._get(33);return o?o.inviteSync(e,t,n):""}},{key:"inviteInGroup",value:function(e){var t=this._get(33);return t?t.invite(e):Rn({code:Bn.NO_MODULE})}},{key:"inviteInGroupSync",value:function(e,t,n){var o=this._get(33);return o?o.inviteSync(e,t,n):""}},{key:"cancel",value:function(e){var t=this._get(33);return t?t.cancel(e):Rn({code:Bn.NO_MODULE})}},{key:"accept",value:function(e){var t=this._get(33);return t?t.accept(e):Rn({code:Bn.NO_MODULE})}},{key:"reject",value:function(e){var t=this._get(33);return t?t.reject(e):Rn({code:Bn.NO_MODULE})}},{key:"getSignalingInfo",value:function(e){var t=this._get(33);return t?t.getSignalingInfo(e):null}},{key:"modifyInvitation",value:function(e){var t=this._get(33);return t?t.modifyInvitation(e):Rn({code:Bn.NO_MODULE})}}]),zc),Jc={login:1,logout:1,getLoginUser:1,destroy:1,on:1,off:1,ready:1,setLogLevel:1,joinGroup:1,quitGroup:1,registerPlugin:1,getGroupOnlineMemberCount:1,isReady:1,addSignalingListener:1,removeSignalingListener:1,callExperimentalAPI:1};function zc(e){o(this,zc),e={SDKAppID:e.SDKAppID,unlimitedAVChatRoom:e.unlimitedAVChatRoom||!1,scene:e.scene||"",oversea:e.oversea||!1,instanceID:Ot(),devMode:e.devMode||!1,testEnv:e.testEnv||!1,proxyServer:e.proxyServer||void 0,fileUploadProxy:e.fileUploadProxy||void 0,fileDownloadProxy:e.fileDownloadProxy||e.fileUploadProxy||void 0,eventThrottling:!1!==e.eventThrottling,partialUpdatedConversations:!0===e.partialUpdatedConversations,disableIndependentDomain:!0===e.disableIndependentDomain,modules:e.modules||void 0},this._m=new Wc(e),this._safetyCallbackFactory=new Yc(this._m)}function Xc(e){o(this,Xc),this._funcMap=new Map,this._m=e,this._n="SafetyCallback",this._reportCount=0}function Qc(e){var t=this;o(this,Qc);var n,i=new so("sdkConstruct"),s=(this._n="ModuleManager",this._isReady=!1,this._reason=Bn.USER_NOT_LOGGED_IN,this._startLoginTs=0,this._map=new Map,this._optionalModuleMap=new Map,this._codeMsgForTUIMap=new Map,this._iEmitter=null,this._oEmitter=null,this._checkCount=0,this._checkTimer=-1,this._map.set(12,new Fi(this,e)),this._map.set(37,new Uc(this)),this._map.set(15,new ys(this)),this._map.set(27,new dr(this)),this._map.set(23,new za(this)),this._map.set(24,new ur(this)),this._map.set(26,new tr(this)),this._map.set(21,new va(this)),this._map.set(20,new Ja(this)),this._map.set(1,new xi(this)),this._map.set(2,new Ks(this)),this._map.set(3,new Ws(this)),this._map.set(34,new Ys(this)),this._map.set(31,new js(this)),this._map.set(4,new wi(this)),this._map.set(6,new Yo(this)),this._map.set(11,new fi(this)),this._map.set(7,new Ai(this)),this._map.set(10,new Ni(this)),this._map.set(13,new gs(this)),this._map.set(32,new fr(this)),this._map.set(14,new ms(this)),this._map.set(17,new ks(this)),this._map.set(18,new Js(this)),this._map.set(19,new zs(this)),this._map.set(25,new Xa(this)),this._map.set(8,new cr(this)),this._map.set(28,new pr(this)),this._map.set(36,new _r(this)),this._map.set(29,new hr(this)),this._map.set(30,new gr(this)),this._map.set(33,new Tr(this)),this._map.set(35,new Sr(this)),this._map.set(38,new Kc(this)),this._eventThrottleMap=new Map,this._eventThrottling=e.eventThrottling,this._map.get(12).isPartialUpdatedConvs()&&(this._eventThrottling=!1),ze(e.modules)?(Object.keys(e.modules).forEach((function(o){n=e.modules[o],"group-module"===o?t._map.set(7,new n(t)):"relationship-module"===o?t._map.set(8,new n(t)):"signaling-module"===o?t._map.set(33,new n(t)):"follow-module"===o?t._map.set(35,new n(t)):"cloud-search-module"===o&&t._map.set(38,new n(t)),t._optionalModuleMap.set(o,1)})),this._map.get(12).setUsingChatCore(!0)):this._map.has(7)||this._map.get(12).setUsingChatCore(!0),e.instanceID),a=e.SDKAppID,r=this._map.get(12).isIntl(),c=this._map.get(12).isUsingChatCore();s="instanceID:".concat(s," SDKAppID:").concat(a," isIntl:").concat(r," isUsingChatCore:").concat(c," host:").concat(Nt())+" isIOSWebView:".concat(ve," platform:").concat(ie," canIUseInflate:").concat(this.canIUseInflate())+" workerAvailable:".concat(ge," eventThrottling:").concat(this._eventThrottling," UserAgent:").concat(oe),so.bindEventStatModule(this._map.get(14)),so.bindNetMonitorModule(this._map.get(15)),i.setMessage("".concat(s," ").concat(function(){var e="";if(Z)try{var t=ne.getSystemInfoSync(),n=t.model,o=t.version,i=t.system,s=t.platform,a=t.SDKVersion;e="model:".concat(n," version:").concat(o," system:").concat(i," platform:").concat(s," SDKVersion:").concat(a)}catch(t){e=""}return e}())).end(),Ne.i("SDK ".concat(s)),Vn.prototype._getErrMsg=this.getErrMsg.bind(this),this._readyList=void 0,this._ssoLogForReady=null,this._initReadyList()}function Zc(e){return o(this,Zc),(e=Pc.call(this,e))._n="CSModule",e}function $c(e){o(this,$c),this._m=e,this._n="InflateModule",this._bLogForInflateOK=!1,this._bLogForInflateError=!1}var eu={};return(X={}).create=function(e){var n,o,i,s="TencentCloudChat.create",a=0;if(je(i=e.SDKAppID))a=i;else if(a=parseInt(i),isNaN(i))return Ne.e("".concat(s," failed. Failed to parse the SDKAppID, please check the arguments")),null;return a&&eu[a]?eu[a]:(Ne.l("".concat(s)),(i=new jc(t(t({},e),{},{SDKAppID:a}))).on(E.SDK_DESTROY,(function(e){eu[e.data.SDKAppID]=null,delete eu[e.data.SDKAppID]})),n=i,o=Object.create(null),Object.keys(xn).forEach((function(e){var t;n[e]&&(t=new S,o[e]=function(){var o=Array.from(arguments);return t.use((function(t,o){var i=function(e,t){if(e.isReady()||1===Jc[t])return!0;var n={code:n=e.getNotReadyReason(),message:"".concat(e.getErrMsg(n)," | ").concat(t," | ").concat(e.getErrMsg(Bn.SDK_IS_NOT_READY))};return e.onError(n),n}(n,e);return!0===i?o():Rn(i)})).use((function(t,n){if(!0===function(e,t,n){if(void 0===t)return!0;var o=!0;if(ze(t))Object.keys(t).forEach((function(i){var s=1===e.length?e[0][i]:void 0;o=!!Xt(s,t[i],n,i)&&o}));else if(Xe(t))for(var i=0;i<t.length;i++)o=!!Xt(e[i],t[i],n,t[i].name)&&o;if(o)return o;throw new Error("Params validate failed.")}(t,qn[e],e))return n()})).use((function(t,o){return n[e].apply(n,t)})),t.run(o)})})),e=o,eu[a]=e,qn.hookGetAPITips(i.getErrMsg.bind(i)),Ne.l("".concat(s," ok")),e)},X.TYPES=D,X.EVENT=E,X.TSignaling=R,X.VERSION="3.5.2",Ne.l("TencentCloudChat.VERSION:".concat(X.VERSION)),X}();var ge=he;class fe{constructor(e,t){if(this.trtcCloud=e,t){const{userId:n,sdkAppId:o,seq:i}=t;this.seq=i,e._log&&(this.logger=e._log.createLogger({id:`roomEngine${i}`,userId:n,sdkAppId:o}))}else this.logger=e._log;this.logger||(this.logger={debug:t=>{e.logger&&e.logger.debug?e.logger.debug(t):console.debug(this.getTime(),t)},info:t=>{e.logger&&e.logger.info?e.logger.info(t):console.info(this.getTime(),t)},warn:t=>{e.logger&&e.logger.warn?e.logger.warn(t):console.warn(this.getTime(),t)},error:t=>{e.logger&&e.logger.error?e.logger.error(t):console.error(this.getTime(),t)}})}getLogMessage(e){try{return e.map((e=>"string"!=typeof e?JSON.stringify(e):e)).join(" ")}catch(t){return e}}update(e){const{userId:t,sdkAppId:n}=e;this.trtcCloud._log&&this.trtcCloud._log.createLogger&&(this.logger=this.trtcCloud._log.createLogger({id:`roomEngine${this.seq}`,userId:t,sdkAppId:n}))}debug(...e){const t=this.getLogMessage(e);this.logger.debug(t)}info(...e){const t=this.getLogMessage(e);this.logger&&this.logger.info&&this.logger.info(t)}warn(...e){const t=this.getLogMessage(e);this.logger&&this.logger.warn&&this.logger.warn(t)}error(...e){const t=this.getLogMessage(e);this.logger&&this.logger.error&&this.logger.error(t)}getTime(){const e=new Date;return`${e.toLocaleTimeString("en-US",{hour12:!1})}.${function(e){let t;switch(e.toString().length){case 1:t=`00${e}`;break;case 2:t=`0${e}`;break;default:t=e}return t}(e.getMilliseconds())}`}}const me=new de;class ve{constructor(e){const{Module:t,logger:n,globalEvent:o}=e;this.conferenceInvitationManager||(this.logger=n,this.conferenceInvitationManager=t,this.globalEvent=o)}static getInstance(e){return ve.instance||(ve.instance=new ve(e)),ve.instance}JSCallNativeFunctionPromise(e,t){return new Promise(((n,o)=>{const i=t=>{const i=b(t);0===i.code?(this.logger.info(`conferenceInvitationManager.${e} success`,i.data),n(i.data)):(this.logger.warn(`conferenceInvitationManager.${e} fail. `,i),o(new w(i)))};try{if(!t)return this.conferenceInvitationManager[e](i);this.conferenceInvitationManager[e](t,i)}catch(s){this.logger.warn(`conferenceInvitationManager.${e} error. `,s.code,s.message),o(new w({code:s.code||exports.TUIErrorCode.ERR_FAILED,message:s.message}))}}))}JSCallNativeFunctionSync(e,t){return this.conferenceInvitationManager[e](t)}inviteUsers(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceInvitationManager.inviteUsers with options: ",e),yield this.JSCallNativeFunctionPromise("inviteUsers",e)}))}cancelInvitation(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceInvitationManager.cancelInvitation with options: ",e),yield this.JSCallNativeFunctionPromise("cancelInvitation",e)}))}accept(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceInvitationManager.accept with options: ",e),yield this.JSCallNativeFunctionPromise("accept",e)}))}reject(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceInvitationManager.reject with options: ",e),yield this.JSCallNativeFunctionPromise("reject",e)}))}getInvitationList(e){return t(this,void 0,void 0,(function*(){return this.logger.info("conferenceInvitationManager.getInvitationList with options: ",e),yield this.JSCallNativeFunctionPromise("getInvitationList",e)}))}static once(e,t){"ready"===e&&t()}on(e,t){me.on(e,t),this.setObserver(e)}setObserver(e){this.logger.info(`listen for event: ${e}`),this.globalEvent.addEventListener(e,(t=>{"{}"===JSON.stringify(t)?me.emit(e):me.emit(e,t),this.logger.info(`conferenceInvitationManager received event: [${e}] ${JSON.stringify(t)}`)}))}off(e,t){me.off(e,t)}}const Ie=new de;class ye{constructor(e){const{Module:t,logger:n,globalEvent:o}=e;this.conferenceListManager||(this.logger=n,this.conferenceListManager=t,this.globalEvent=o)}static getInstance(e){return ye.instance||(ye.instance=new ye(e)),ye.instance}JSCallNativeFunctionPromise(e,t){return new Promise(((n,o)=>{const i=t=>{const i=b(t);0===i.code?(this.logger.info(`conferenceInvitationManager.${e} success`,i.data),n(i.data)):(this.logger.warn(`conferenceInvitationManager.${e} fail. `,i),o(new w(i)))};try{if(!t)return this.conferenceListManager[e](i);this.conferenceListManager[e](t,i)}catch(s){this.logger.warn(`conferenceInvitationManager.${e} error. `,s.code,s.message),o(new w({code:s.code||exports.TUIErrorCode.ERR_FAILED,message:s.message}))}}))}JSCallNativeFunctionSync(e,t){return this.conferenceListManager[e](t)}scheduleConference(e){return t(this,void 0,void 0,(function*(){const{scheduleStartTime:t,scheduleEndTime:n,scheduleAttendees:o=[],reminderSecondsBeforeStart:i=0,roomId:s,roomName:a,roomType:r,maxSeatCount:c,isSeatEnabled:u=!1,seatMode:l=exports.TUISeatMode.kFreeToTake,isMicrophoneDisableForAllUser:d,isScreenShareDisableForAllUser:p,isCameraDisableForAllUser:_,isMessageDisableForAllUser:h,password:g=""}=e;delete e.password,this.logger.info("conferenceListManager.scheduleConference with options: ",e);const f={conferenceInfo:{basicRoomInfo:{roomId:s,roomType:r,name:a,isSeatEnabled:u,seatMode:l,isMicrophoneDisableForAllUser:d,isScreenShareDisableForAllUser:p,isCameraDisableForAllUser:_,isMessageDisableForAllUser:h,maxSeatCount:c,password:g},scheduleStartTime:t,scheduleEndTime:n,scheduleAttendees:o,reminderSecondsBeforeStart:i}};yield this.JSCallNativeFunctionPromise("scheduleConference",f)}))}cancelConference(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceListManager.cancelConference with options: ",e),yield this.JSCallNativeFunctionPromise("cancelConference",e)}))}updateConferenceInfo(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceListManager.updateConferenceInfo with options: ",e),yield this.JSCallNativeFunctionPromise("updateConferenceInfo",e)}))}fetchScheduledConferenceList(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceListManager.fetchScheduledConferenceList with options: ",e);const{cursor:t,count:n,statusArray:o}=e,i={cursor:t,count:n,status:o};return console.log(i),yield this.JSCallNativeFunctionPromise("fetchScheduledConferenceList",i)}))}fetchAttendeeList(e){return t(this,void 0,void 0,(function*(){return this.logger.info("conferenceListManager.fetchAttendeeList with options: ",e),yield this.JSCallNativeFunctionPromise("fetchAttendeeList",e)}))}addAttendeesByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceListManager.addAttendeesByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("addAttendeesByAdmin",e)}))}removeAttendeesByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("conferenceListManager.removeAttendeesByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("removeAttendeesByAdmin",e)}))}static once(e,t){"ready"===e&&t()}on(e,t){Ie.on(e,t),this.setObserver(e)}setObserver(e){this.logger.info(`listen for event: ${e}`),this.globalEvent.addEventListener(e,(t=>{"{}"===JSON.stringify(t)?Ie.emit(e):Ie.emit(e,t),this.logger.info(`conferenceInvitationManager received event: [${e}] ${JSON.stringify(t)}`)}))}off(e,t){Ie.off(e,t)}}var Me,Ce,Te,Ee,De,Re,Se,Le,Ae,ke,Oe,Ne,Pe,Ge,Ue,be,we,Fe,qe;ye.ROOM_NAME=1,ye.SCHEDULED_START_TIME=65536,ye.SCHEDULED_END_TIME=1<<17,exports.TRTCVideoResolution=void 0,(Me=exports.TRTCVideoResolution||(exports.TRTCVideoResolution={}))[Me.TRTCVideoResolution_120_120=1]="TRTCVideoResolution_120_120",Me[Me.TRTCVideoResolution_160_160=3]="TRTCVideoResolution_160_160",Me[Me.TRTCVideoResolution_270_270=5]="TRTCVideoResolution_270_270",Me[Me.TRTCVideoResolution_480_480=7]="TRTCVideoResolution_480_480",Me[Me.TRTCVideoResolution_160_120=50]="TRTCVideoResolution_160_120",Me[Me.TRTCVideoResolution_240_180=52]="TRTCVideoResolution_240_180",Me[Me.TRTCVideoResolution_280_210=54]="TRTCVideoResolution_280_210",Me[Me.TRTCVideoResolution_320_240=56]="TRTCVideoResolution_320_240",Me[Me.TRTCVideoResolution_400_300=58]="TRTCVideoResolution_400_300",Me[Me.TRTCVideoResolution_480_360=60]="TRTCVideoResolution_480_360",Me[Me.TRTCVideoResolution_640_480=62]="TRTCVideoResolution_640_480",Me[Me.TRTCVideoResolution_960_720=64]="TRTCVideoResolution_960_720",Me[Me.TRTCVideoResolution_160_90=100]="TRTCVideoResolution_160_90",Me[Me.TRTCVideoResolution_256_144=102]="TRTCVideoResolution_256_144",Me[Me.TRTCVideoResolution_320_180=104]="TRTCVideoResolution_320_180",Me[Me.TRTCVideoResolution_480_270=106]="TRTCVideoResolution_480_270",Me[Me.TRTCVideoResolution_640_360=108]="TRTCVideoResolution_640_360",Me[Me.TRTCVideoResolution_960_540=110]="TRTCVideoResolution_960_540",Me[Me.TRTCVideoResolution_1280_720=112]="TRTCVideoResolution_1280_720",Me[Me.TRTCVideoResolution_1920_1080=114]="TRTCVideoResolution_1920_1080",exports.TRTCVideoStreamType=void 0,(Ce=exports.TRTCVideoStreamType||(exports.TRTCVideoStreamType={}))[Ce.TRTCVideoStreamTypeBig=0]="TRTCVideoStreamTypeBig",Ce[Ce.TRTCVideoStreamTypeSmall=1]="TRTCVideoStreamTypeSmall",Ce[Ce.TRTCVideoStreamTypeSub=2]="TRTCVideoStreamTypeSub",exports.TRTCVideoFillMode=void 0,(Te=exports.TRTCVideoFillMode||(exports.TRTCVideoFillMode={}))[Te.TRTCVideoFillMode_Fill=0]="TRTCVideoFillMode_Fill",Te[Te.TRTCVideoFillMode_Fit=1]="TRTCVideoFillMode_Fit",exports.TRTCVideoMirrorType=void 0,(Ee=exports.TRTCVideoMirrorType||(exports.TRTCVideoMirrorType={}))[Ee.TRTCVideoMirrorType_Auto=0]="TRTCVideoMirrorType_Auto",Ee[Ee.TRTCVideoMirrorType_Enable=1]="TRTCVideoMirrorType_Enable",Ee[Ee.TRTCVideoMirrorType_Disable=2]="TRTCVideoMirrorType_Disable",exports.TRTCBeautyStyle=void 0,(De=exports.TRTCBeautyStyle||(exports.TRTCBeautyStyle={}))[De.TRTCBeautyStyleSmooth=0]="TRTCBeautyStyleSmooth",De[De.TRTCBeautyStyleNature=1]="TRTCBeautyStyleNature",exports.TRTCAppScene=void 0,(Re=exports.TRTCAppScene||(exports.TRTCAppScene={}))[Re.TRTCAppSceneVideoCall=0]="TRTCAppSceneVideoCall",Re[Re.TRTCAppSceneLIVE=1]="TRTCAppSceneLIVE",Re[Re.TRTCAppSceneAudioCall=2]="TRTCAppSceneAudioCall",Re[Re.TRTCAppSceneVoiceChatRoom=3]="TRTCAppSceneVoiceChatRoom",exports.TRTCRoleType=void 0,(Se=exports.TRTCRoleType||(exports.TRTCRoleType={}))[Se.TRTCRoleAnchor=20]="TRTCRoleAnchor",Se[Se.TRTCRoleAudience=21]="TRTCRoleAudience",exports.TRTCAudioQuality=void 0,(Le=exports.TRTCAudioQuality||(exports.TRTCAudioQuality={}))[Le.TRTCAudioQualityDefault=0]="TRTCAudioQualityDefault",Le[Le.TRTCAudioQualitySpeech=1]="TRTCAudioQualitySpeech",Le[Le.TRTCAudioQualityMusic=3]="TRTCAudioQualityMusic";exports.TRTCDeviceState=void 0,(Ae=exports.TRTCDeviceState||(exports.TRTCDeviceState={}))[Ae.TRTCDeviceStateAdd=0]="TRTCDeviceStateAdd",Ae[Ae.TRTCDeviceStateRemove=1]="TRTCDeviceStateRemove",Ae[Ae.TRTCDeviceStateActive=2]="TRTCDeviceStateActive",exports.TRTCDeviceType=void 0,(ke=exports.TRTCDeviceType||(exports.TRTCDeviceType={}))[ke.TRTCDeviceTypeUnknow=-1]="TRTCDeviceTypeUnknow",ke[ke.TRTCDeviceTypeMic=0]="TRTCDeviceTypeMic",ke[ke.TRTCDeviceTypeSpeaker=1]="TRTCDeviceTypeSpeaker",ke[ke.TRTCDeviceTypeCamera=2]="TRTCDeviceTypeCamera";exports.TRTCVideoRotation=void 0,(Oe=exports.TRTCVideoRotation||(exports.TRTCVideoRotation={}))[Oe.TRTCVideoRotation0=0]="TRTCVideoRotation0",Oe[Oe.TRTCVideoRotation90=1]="TRTCVideoRotation90",Oe[Oe.TRTCVideoRotation180=2]="TRTCVideoRotation180",Oe[Oe.TRTCVideoRotation270=3]="TRTCVideoRotation270";exports.TRTCQuality=void 0,(Ne=exports.TRTCQuality||(exports.TRTCQuality={}))[Ne.TRTCQuality_Unknown=0]="TRTCQuality_Unknown",Ne[Ne.TRTCQuality_Excellent=1]="TRTCQuality_Excellent",Ne[Ne.TRTCQuality_Good=2]="TRTCQuality_Good",Ne[Ne.TRTCQuality_Poor=3]="TRTCQuality_Poor",Ne[Ne.TRTCQuality_Bad=4]="TRTCQuality_Bad",Ne[Ne.TRTCQuality_Vbad=5]="TRTCQuality_Vbad",Ne[Ne.TRTCQuality_Down=6]="TRTCQuality_Down";exports.TRTCVideoResolutionMode=void 0,(Pe=exports.TRTCVideoResolutionMode||(exports.TRTCVideoResolutionMode={}))[Pe.TRTCVideoResolutionModeLandscape=0]="TRTCVideoResolutionModeLandscape",Pe[Pe.TRTCVideoResolutionModePortrait=1]="TRTCVideoResolutionModePortrait",exports.TRTCVideoQosPreference=void 0,(Ge=exports.TRTCVideoQosPreference||(exports.TRTCVideoQosPreference={}))[Ge.TRTCVideoQosPreferenceSmooth=1]="TRTCVideoQosPreferenceSmooth",Ge[Ge.TRTCVideoQosPreferenceClear=2]="TRTCVideoQosPreferenceClear",exports.TRTCQosControlMode=void 0,(Ue=exports.TRTCQosControlMode||(exports.TRTCQosControlMode={}))[Ue.TRTCQosControlModeClient=0]="TRTCQosControlModeClient",Ue[Ue.TRTCQosControlModeServer=1]="TRTCQosControlModeServer";class xe{constructor(e=new ArrayBuffer(0),t=0,n=0,o=0){this.buffer=e,this.length=t,this.width=n,this.height=o}}exports.TRTCLogLevel=void 0,(be=exports.TRTCLogLevel||(exports.TRTCLogLevel={}))[be.TRTCLogLevelVerbose=0]="TRTCLogLevelVerbose",be[be.TRTCLogLevelDebug=1]="TRTCLogLevelDebug",be[be.TRTCLogLevelInfo=2]="TRTCLogLevelInfo",be[be.TRTCLogLevelWarn=3]="TRTCLogLevelWarn",be[be.TRTCLogLevelError=4]="TRTCLogLevelError",be[be.TRTCLogLevelFatal=5]="TRTCLogLevelFatal",be[be.TRTCLogLevelNone=6]="TRTCLogLevelNone",exports.TRTCScreenCaptureSourceType=void 0,(we=exports.TRTCScreenCaptureSourceType||(exports.TRTCScreenCaptureSourceType={}))[we.TRTCScreenCaptureSourceTypeUnknown=-1]="TRTCScreenCaptureSourceTypeUnknown",we[we.TRTCScreenCaptureSourceTypeWindow=0]="TRTCScreenCaptureSourceTypeWindow",we[we.TRTCScreenCaptureSourceTypeScreen=1]="TRTCScreenCaptureSourceTypeScreen",we[we.TRTCScreenCaptureSourceTypeCustom=2]="TRTCScreenCaptureSourceTypeCustom";exports.TRTCTranscodingConfigMode=void 0,(Fe=exports.TRTCTranscodingConfigMode||(exports.TRTCTranscodingConfigMode={}))[Fe.TRTCTranscodingConfigMode_Unknown=0]="TRTCTranscodingConfigMode_Unknown",Fe[Fe.TRTCTranscodingConfigMode_Manual=1]="TRTCTranscodingConfigMode_Manual",Fe[Fe.TRTCTranscodingConfigMode_Template_PureAudio=2]="TRTCTranscodingConfigMode_Template_PureAudio",Fe[Fe.TRTCTranscodingConfigMode_Template_PresetLayout=3]="TRTCTranscodingConfigMode_Template_PresetLayout",Fe[Fe.TRTCTranscodingConfigMode_Template_ScreenSharing=4]="TRTCTranscodingConfigMode_Template_ScreenSharing",Fe[Fe.TRTC_TranscodingConfigMode_Unknown=5]="TRTC_TranscodingConfigMode_Unknown",Fe[Fe.TRTC_TranscodingConfigMode_Manual=6]="TRTC_TranscodingConfigMode_Manual",Fe[Fe.TRTC_TranscodingConfigMode_Template_PureAudio=7]="TRTC_TranscodingConfigMode_Template_PureAudio",Fe[Fe.TRTC_TranscodingConfigMode_Template_PresetLayout=8]="TRTC_TranscodingConfigMode_Template_PresetLayout",Fe[Fe.TRTC_TranscodingConfigMode_Template_ScreenSharing=9]="TRTC_TranscodingConfigMode_Template_ScreenSharing";exports.TRTCMixInputType=void 0,(qe=exports.TRTCMixInputType||(exports.TRTCMixInputType={}))[qe.TRTCMixInputTypeUndefined=0]="TRTCMixInputTypeUndefined",qe[qe.TRTCMixInputTypeAudioVideo=1]="TRTCMixInputTypeAudioVideo",qe[qe.TRTCMixInputTypePureVideo=2]="TRTCMixInputTypePureVideo",qe[qe.TRTCMixInputTypePureAudio=3]="TRTCMixInputTypePureAudio";const Ve=new fe({}),Be=uni.requireNativePlugin("TencentCloud-TUIRoomEngine"),He=uni.requireNativePlugin("globalEvent"),Ke=ie;let We=1;const Ye=new de;class je{constructor(){this.roomId="",this.localVideoQuality=exports.TUIVideoQuality.kVideoQuality_720p,this.localAudioQuality=exports.TUIAudioQuality.kAudioProfileDefault,this.roomEngine||(this.roomEngine=Be,this.logger=new fe({},{sdkAppId:je.sdkAppId,userId:je.userId,seq:We}),We+=1)}static JSCallNativeFunctionPromise(e,t){return new Promise(((n,o)=>{const i=t=>{const i=b(t);0===i.code?(Ve.info(`roomEngine.${e} success`,i),n(i)):(console.warn(`roomEngine.${e} fail. `,i),o(new w(i)))};try{t?Be[e](t,i):Be[e](i)}catch(s){console.warn(`roomEngine.${e} error. `,s.code,s.message),o(new w({code:s.code||exports.TUIErrorCode.ERR_FAILED,message:s.message}))}}))}static JSCallNativeFunctionSync(e,t){return Be[e](t)}JSCallNativeFunctionPromise(e,t){return new Promise(((n,o)=>{const i=t=>{const i=b(t);0===i.code?(this.logger.info(`roomEngine.${e} success`,i.data),n(i.data)):(this.logger.warn(`roomEngine.${e} fail. `,i),o(new w(i)))};try{if(!t)return this.roomEngine[e](i);this.roomEngine[e](t,i)}catch(s){this.logger.warn(`roomEngine.${e} error. `,s.code,s.message),o(new w({code:s.code||exports.TUIErrorCode.ERR_FAILED,message:s.message}))}}))}JSCallNativeFunctionSync(e,t){return this.roomEngine[e](t)}JSCallNativeRequestFunctionPromise(e,t){const{requestCallback:n}=t;return new Promise(((o,i)=>{const s=t=>{this.logger.info(`roomEngine.${e} success with request:`,t),o(t)},a=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestAccepted});n(t)},r=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestRejected});n(t)},c=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestCancelled});n(t)},u=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestTimeout});n(t)},l=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestError});i(new w(t))};try{this.roomEngine[e](t,a,r,c,u,l,s)}catch(d){console.error(`roomEngine.${e} error. `,d.code,d.message),i(new w({code:d.code||exports.TUIErrorCode.ERR_FAILED,message:d.message}))}}))}static login(e){return t(this,void 0,void 0,(function*(){const{sdkAppId:t,userId:n,userSig:o,tim:i}=e;je.userId=n,je.sdkAppId=t,Ve.info("TUIRoomEngine.login with options: ",e),yield this.JSCallNativeFunctionPromise("login",e),i?je.tim=i:(je.tim=ge.create({SDKAppID:t}),je.tim.login({userID:n,userSig:o}))}))}static setSelfInfo(e){return t(this,void 0,void 0,(function*(){Ve.info("TUIRoomEngine.setSelfInfo with options: ",e);const{userName:t,avatarUrl:n,customInfo:o}=e,i={userName:t,avatarUrl:n,customInfo:JSON.stringify(o)};yield this.JSCallNativeFunctionPromise("setSelfInfo",i)}))}static getTIM(){return je.tim}static getSelfInfo(){return t(this,void 0,void 0,(function*(){return yield this.JSCallNativeFunctionSync("getSelfInfo")}))}static logout(){return t(this,void 0,void 0,(function*(){Ve.info("TUIRoomEngine.logout."),yield this.JSCallNativeFunctionPromise("logout")}))}createRoom(e){return t(this,void 0,void 0,(function*(){const{roomId:t,roomName:n,roomType:o,maxSeatCount:i,isSeatEnabled:s=!1,seatMode:a=exports.TUISeatMode.kFreeToTake,isMicrophoneDisableForAllUser:r,isScreenShareDisableForAllUser:c,isCameraDisableForAllUser:u,isMessageDisableForAllUser:l,password:d=""}=e;this.roomId=t,delete e.password,this.logger.info("roomEngine.createRoom with options: ",e);const p={roomInfo:{roomId:t,roomType:o,roomName:n,isSeatEnabled:s,seatMode:a,isMicrophoneDisableForAllUser:r,isScreenShareDisableForAllUser:c,isCameraDisableForAllUser:u,isMessageDisableForAllUser:l,maxSeatCount:i,password:d}};yield this.JSCallNativeFunctionPromise("createRoom",p)}))}enterRoom(e){return t(this,void 0,void 0,(function*(){const{roomId:t,roomType:n=exports.TUIRoomType.kConference,options:o={}}=e;delete e.options,this.logger.info("roomEngine.enterRoom with options: ",e),this.roomId=t,this.logger.info({sdkAppId:je.sdkAppId,userId:je.userId});return yield this.JSCallNativeFunctionPromise("enterRoom",e)}))}destroyRoom(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.destroyRoom"),yield this.JSCallNativeFunctionPromise("destroyRoom")}))}exitRoom(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.exitRoom");yield this.JSCallNativeFunctionPromise("exitRoom",{syncWaiting:!1})}))}fetchRoomInfo(e){return t(this,void 0,void 0,(function*(){return new Promise(((t,n)=>{const o=e=>{const o=b(e);if(0===o.code){this.logger.info("roomEngine.fetchRoomInfo success",o.data);const e=Object.assign(Object.assign({},o.data),{roomOwner:o.data.ownerId});t(e)}else this.logger.warn("roomEngine.fetchRoomInfo fail. ",o),n(new w(o))};try{return e?this.roomEngine.fetchRoomInfoById(e,o):this.roomEngine.fetchRoomInfo(o)}catch(i){this.logger.warn("roomEngine.fetchRoomInfo error. ",i.code,i.message),n(new w({code:i.code||exports.TUIErrorCode.ERR_FAILED,message:i.message}))}}))}))}updateRoomNameByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.updateRoomNameByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("updateRoomNameByAdmin",e)}))}updateRoomSeatModeByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.updateRoomSeatModeByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("updateRoomSeatModeByAdmin",e)}))}updateRoomPasswordByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.updateRoomPasswordByAdmin"),yield this.JSCallNativeFunctionPromise("updateRoomPasswordByAdmin",e)}))}getUserList(e){return t(this,void 0,void 0,(function*(){const t={nextSequence:e&&e.nextSequence||0};return yield this.JSCallNativeFunctionPromise("getUserList",t)}))}getUserInfo(e){return t(this,void 0,void 0,(function*(){return yield this.JSCallNativeFunctionPromise("getUserInfo",e)}))}setCustomInfoForUser(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.setCustomInfoForUser with options: ",e),yield this.JSCallNativeFunctionPromise("setCustomInfoForUser",e)}))}setLocalVideoView(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.setLocalVideoView"),this.JSCallNativeFunctionSync("setLocalVideoView")}))}openLocalCamera(e={isFrontCamera:!0}){return t(this,void 0,void 0,(function*(){if("android"===uni.getSystemInfoSync().platform){if((yield ce.requestAndroidPermission("android.permission.CAMERA"))!==se)throw new w({code:exports.TUIErrorCode.ERR_CAMERA_NOT_AUTHORIZED,message:"permission denied"})}this.logger.info("roomEngine.openLocalCamera",e);const{isFrontCamera:t}=e,n={isFront:t?1:0,quality:this.localVideoQuality};yield this.JSCallNativeFunctionPromise("openLocalCamera",n)}))}closeLocalCamera(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.closeLocalCamera"),yield this.JSCallNativeFunctionSync("closeLocalCamera")}))}openLocalMicrophone(){return t(this,void 0,void 0,(function*(){if("android"===uni.getSystemInfoSync().platform){if((yield ce.requestAndroidPermission("android.permission.RECORD_AUDIO"))!==se)throw new w({code:exports.TUIErrorCode.ERR_MICROPHONE_NOT_AUTHORIZED,message:"permission denied"})}this.logger.info("roomEngine.openLocalMicrophone");const e={quality:this.localAudioQuality};try{return yield this.JSCallNativeFunctionPromise("openLocalMicrophone",e)}catch(t){if("you have been muted the audio"===t.message||"open microphone need apply to admin"===t.message)return void this.logger.warn(t);throw t}}))}closeLocalMicrophone(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.closeLocalMicrophone"),yield this.JSCallNativeFunctionSync("closeLocalMicrophone")}))}updateVideoQuality(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.updateVideoQuality with options: ",e);const{quality:t}=e;this.localVideoQuality=t,yield this.JSCallNativeFunctionPromise("updateVideoQuality",e)}))}setVideoResolutionMode(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.setVideoResolutionMode with options: ",e),yield this.JSCallNativeFunctionSync("setVideoResolutionMode",e)}))}updateVideoQualityEx(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.updateVideoQualityEx with options: ",e);const{streamType:t,encoderParams:n}=e;n&&n.videoResolution&&t===exports.TUIVideoStreamType.kCameraStream&&(this.localVideoQuality=n&&n.videoResolution);const o={streamType:t,encoderParams:n};yield this.JSCallNativeFunctionSync("updateVideoQualityEx",o)}))}updateAudioQuality(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.updateAudioQuality with options: ",e);const{quality:t}=e;this.localAudioQuality=t,yield this.JSCallNativeFunctionSync("updateAudioQuality",e)}))}startPushLocalVideo(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.startPushLocalVideo"),yield this.JSCallNativeFunctionSync("startPushLocalVideo")}))}stopPushLocalVideo(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.stopPushLocalVideo"),yield this.JSCallNativeFunctionSync("stopPushLocalVideo")}))}startPushLocalAudio(){return t(this,void 0,void 0,(function*(){this.logger.warn("roomEngine.startPushLocalAudio is deprecated since v1.5.0, please use roomEngine.muteLocalAudio."),yield this.JSCallNativeFunctionPromise("startPushLocalAudio")}))}stopPushLocalAudio(){return t(this,void 0,void 0,(function*(){this.logger.warn("roomEngine.stopPushLocalAudio is deprecated since v1.5.0, please use roomEngine.muteLocalAudio."),yield this.JSCallNativeFunctionPromise("stopPushLocalAudio")}))}muteLocalAudio(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.muteLocalAudio"),yield this.JSCallNativeFunctionPromise("muteLocalAudio")}))}unmuteLocalAudio(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.unmuteLocalAudio"),yield this.JSCallNativeFunctionPromise("unmuteLocalAudio")}))}setRemoteVideoView(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.setRemoteVideoView with options: ",e),yield this.JSCallNativeFunctionSync("setRemoteVideoView",e)}))}startPlayRemoteVideo(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.startPlayRemoteVideo with options: ",e);const{userId:t,streamType:n}=e;return new Promise(((e,o)=>{const i={userId:t,streamType:n,playingCallback:t=>{console.log("roomEngine startPlayRemoteVideo playingCallback",t),e()},loadingCallback:e=>{console.log("roomEngine startPlayRemoteVideo loadingCallback",e)},errorCallback:e=>{console.log("roomEngine startPlayRemoteVideo errorCallback",e),o()}};try{this.roomEngine.startPlayRemoteVideo(i)}catch(s){console.error("roomEngine.startPlayRemoteVideo error. ",s.code,s.message);const e=new w({code:s.code||exports.TUIErrorCode.ERR_FAILED,message:s.message});o(e)}}))}))}stopPlayRemoteVideo(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.stopPlayRemoteVideo with options: ",e),yield this.JSCallNativeFunctionSync("stopPlayRemoteVideo",e)}))}muteRemoteAudioStream(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.muteRemoteAudioStream with options",e),yield this.JSCallNativeFunctionSync("muteRemoteAudioStream",e)}))}openRemoteDeviceByAdmin(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.openRemoteDeviceByAdmin with options: ",e),e.requestCallback||(e.requestCallback=()=>{}),yield this.JSCallNativeRequestFunctionPromise("openRemoteDeviceByAdmin",e)}))}applyToAdminToOpenLocalDevice(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.applyToAdminToOpenLocalDevice with options: ",e),e.requestCallback||(e.requestCallback=()=>{}),yield this.JSCallNativeRequestFunctionPromise("applyToAdminToOpenLocalDevice",e)}))}closeRemoteDeviceByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.closeRemoteDeviceByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("closeRemoteDeviceByAdmin",e)}))}cancelRequest(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.cancelRequest with options: ",e),yield this.JSCallNativeFunctionPromise("cancelRequest",e)}))}responseRemoteRequest(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.responseRemoteRequest with options: ",e),yield this.JSCallNativeFunctionPromise("responseRemoteRequest",e)}))}disableDeviceForAllUserByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.disableDeviceForAllUserByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("disableDeviceForAllUserByAdmin",e)}))}disableSendingMessageForAllUser(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.disableSendingMessageForAllUser with options: ",e),yield this.JSCallNativeFunctionPromise("disableSendingMessageForAllUser",e)}))}disableSendingMessageByAdmin(e){return t(this,void 0,void 0,(function*(){yield this.JSCallNativeFunctionPromise("disableSendingMessageByAdmin",e)}))}changeUserRole(e){return t(this,void 0,void 0,(function*(){const{userId:t,userRole:n}=e,o={userId:t,role:n};this.logger.info("roomEngine.changeUserRole with options: ",o),yield this.JSCallNativeFunctionPromise("changeUserRole",o)}))}changeUserNameCard(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.changeUserNameCard with options: ",e),yield this.JSCallNativeFunctionPromise("changeUserNameCard",e)}))}kickRemoteUserOutOfRoom(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.kickRemoteUserOutOfRoom with options: ",e),yield this.JSCallNativeFunctionPromise("kickRemoteUserOutOfRoom",e)}))}setMaxSeatCount(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.setMaxSeatCount with options: ",e),yield this.JSCallNativeFunctionPromise("setMaxSeatCount",e)}))}getSeatList(){return t(this,void 0,void 0,(function*(){return yield this.JSCallNativeFunctionPromise("getSeatList")}))}takeSeat(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.takeSeat with options: ",e),e.requestCallback||(e.requestCallback=()=>{});const{seatIndex:t,timeout:n,requestCallback:o}=e;let i=!0,s={content:"",requestAction:0,requestId:"",timestamp:0,userId:"",userName:"",nameCard:"",avatarUrl:""};return new Promise(((t,n)=>{const a=e=>{""===e.requestId?(i=!1,s=e):(this.logger.info("roomEngine.takeSeat success with requestId:",e),t(e))},r=e=>{const n=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestAccepted});if(o(n),!i)return this.logger.info("roomEngine.takeSeat success without request."),void t(s)},c=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestRejected});o(t)},u=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestCancelled});o(t)},l=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestTimeout});o(t)},d=e=>{const t=Object.assign(Object.assign({},e),{requestCallbackType:exports.TUIRequestCallbackType.kRequestError});n(new w(t))};try{this.roomEngine.takeSeat(e,r,c,u,l,d,a)}catch(p){console.error("roomEngine.takeSeat error. ",p.code,p.message),n(new w({code:p.code||exports.TUIErrorCode.ERR_FAILED,message:p.message}))}}))}))}moveToSeat(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.moveToSeat with options:",e),yield this.JSCallNativeFunctionPromise("moveToSeat",e)}))}leaveSeat(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.leaveSeat"),yield this.JSCallNativeFunctionPromise("leaveSeat")}))}takeUserOnSeatByAdmin(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.takeUserOnSeatByAdmin with options: ",e),e.requestCallback||(e.requestCallback=()=>{}),yield this.JSCallNativeRequestFunctionPromise("takeUserOnSeatByAdmin",e)}))}kickUserOffSeatByAdmin(e){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.kickUserOffSeatByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("kickUserOffSeatByAdmin",e)}))}lockSeatByAdmin(e){return t(this,void 0,void 0,(function*(){return this.logger.info("roomEngine.lockSeatByAdmin with options: ",e),yield this.JSCallNativeFunctionPromise("lockSeatByAdmin",e)}))}getSeatApplicationList(){return t(this,void 0,void 0,(function*(){return yield this.JSCallNativeFunctionPromise("getSeatApplicationList")}))}getMediaDeviceManager(){return this.deviceManager||(this.deviceManager=pe.getInstance({logger:this.logger,Module:this.roomEngine})),this.deviceManager}startScreenSharing(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.startScreenSharing"),yield this.JSCallNativeFunctionSync("startScreenCapture")}))}stopScreenSharing(){return t(this,void 0,void 0,(function*(){this.logger.info("roomEngine.stopScreenSharing"),yield this.JSCallNativeFunctionSync("stopScreenCapture")}))}getTRTCCloud(){return this.trtcCloud||(this.trtcCloud=_e.getInstance({logger:this.logger,Module:this.roomEngine})),this.trtcCloud}getConferenceListManager(){return this.conferenceListManager||(this.conferenceListManager=ye.getInstance({logger:this.logger,Module:this.roomEngine,globalEvent:He})),this.conferenceListManager}getConferenceInvitationManager(){return this.conferenceInvitationManager||(this.conferenceInvitationManager=ve.getInstance({logger:this.logger,Module:this.roomEngine,globalEvent:He})),this.conferenceInvitationManager}static callExperimentalAPI(e){return t(this,void 0,void 0,(function*(){Ve.info("TUIRoomEngine.callExperimentalAPI",e);const t=b(e);if(t===e)return;const{api:n,params:o}=t;if(n&&o)if("setFramework"===n)yield je.handleSetFramework(o);else yield je.JSCallNativeFunctionPromise("callExperimentalAPI",{jsonStr:e})}))}static setViewBackgroundColor(e){return t(this,void 0,void 0,(function*(){Ve.info("TUIRoomEngine.setViewBackgroundColor",e);const t=JSON.stringify({api:"setViewBackgroundColor",params:e});yield je.JSCallNativeFunctionPromise("callTRTCExperimentalAPI",{jsonStr:t})}))}static handleSetFramework(e){return t(this,void 0,void 0,(function*(){const{component:t,language:n}=e,o={TUIRoomEngine:16,TUIRoomKit:18,TIMRoomKit:19,TUILiveKit:21,VoiceRoom:22,EngineLive:23,Classroom:24},i={vue2:5,vue3:6},s={framework:{[ie]:11}[Ke]};if(o[t]&&(s.component=o[t]),i[n]&&(s.language=i[n]),s){const e={jsonStr:JSON.stringify({api:"setFramework",params:s})};yield je.JSCallNativeFunctionPromise("callExperimentalAPI",e)}}))}static once(e,t){"ready"===e&&t()}on(e,t){Ye.on(e,t),this.setObserver(e)}transformParams(e,t){let n={};if(e===exports.TUIRoomEvents.onUserVoiceVolumeChanged)n.userVolumeList=[],Object.keys(t.volumeMap).forEach((e=>{n.userVolumeList.push({userId:e,volume:t.volumeMap[e]})}));else n=t;return n}setObserver(e){this.logger.info(`listen for event: ${e}`),He.addEventListener(e,(t=>{if("{}"===JSON.stringify(t))Ye.emit(e);else{const n=this.transformParams(e,t);Ye.emit(e,n)}[exports.TUIRoomEvents.onUserVoiceVolumeChanged,exports.TUIRoomEvents.onUserNetworkQualityChanged,exports.TUIRoomEvents.onReceiveTextMessage,exports.TUIRoomEvents.onReceiveCustomMessage].includes(e)||(e!==exports.TUIRoomEvents.onSeatListChanged?this.logger.info(`RoomEngine received event: [${e}] ${JSON.stringify(t)}`):this.logger.info(`RoomEngine received event: [onSeatListChanged] {seatedList: ${JSON.stringify(t)}, leftList: ${JSON.stringify(t)}}`))}))}off(e,t){Ye.off(e,t)}}e([j(ae.createRoom)],je.prototype,"createRoom",null),e([j(ae.enterRoom)],je.prototype,"enterRoom",null),e([j(ae.updateRoomNameByAdmin)],je.prototype,"updateRoomNameByAdmin",null),e([j(ae.updateRoomSeatModeByAdmin)],je.prototype,"updateRoomSeatModeByAdmin",null),e([j(ae.updateRoomPasswordByAdmin)],je.prototype,"updateRoomPasswordByAdmin",null),e([j(ae.getUserList)],je.prototype,"getUserList",null),e([j(ae.getUserInfo)],je.prototype,"getUserInfo",null),e([j(ae.setCustomInfoForUser)],je.prototype,"setCustomInfoForUser",null),e([Y(ae.setLocalVideoView)],je.prototype,"setLocalVideoView",null),e([j(ae.openLocalCamera)],je.prototype,"openLocalCamera",null),e([j(ae.updateVideoQuality)],je.prototype,"updateVideoQuality",null),e([j(ae.setVideoResolutionMode)],je.prototype,"setVideoResolutionMode",null),e([j(ae.updateVideoQualityEx)],je.prototype,"updateVideoQualityEx",null),e([j(ae.updateAudioQuality)],je.prototype,"updateAudioQuality",null),e([Y(ae.setRemoteVideoView)],je.prototype,"setRemoteVideoView",null),e([Y(ae.startPlayRemoteVideo)],je.prototype,"startPlayRemoteVideo",null),e([j(ae.stopPlayRemoteVideo)],je.prototype,"stopPlayRemoteVideo",null),e([Y(ae.muteRemoteAudioStream)],je.prototype,"muteRemoteAudioStream",null),e([j(ae.openRemoteDeviceByAdmin)],je.prototype,"openRemoteDeviceByAdmin",null),e([j(ae.applyToAdminToOpenLocalDevice)],je.prototype,"applyToAdminToOpenLocalDevice",null),e([j(ae.closeRemoteDeviceByAdmin)],je.prototype,"closeRemoteDeviceByAdmin",null),e([j(ae.cancelRequest)],je.prototype,"cancelRequest",null),e([j(ae.responseRemoteRequest)],je.prototype,"responseRemoteRequest",null),e([j(ae.disableDeviceForAllUserByAdmin)],je.prototype,"disableDeviceForAllUserByAdmin",null),e([j(ae.disableSendingMessageForAllUser)],je.prototype,"disableSendingMessageForAllUser",null),e([j(ae.disableSendingMessageByAdmin)],je.prototype,"disableSendingMessageByAdmin",null),e([j(ae.changeUserRole)],je.prototype,"changeUserRole",null),e([j(ae.changeUserNameCard)],je.prototype,"changeUserNameCard",null),e([j(ae.kickRemoteUserOutOfRoom)],je.prototype,"kickRemoteUserOutOfRoom",null),e([j(ae.setRoomMaxSeatCount)],je.prototype,"setMaxSeatCount",null),e([j(ae.takeSeat)],je.prototype,"takeSeat",null),e([j(ae.takeUserOnSeatByAdmin)],je.prototype,"takeUserOnSeatByAdmin",null),e([j(ae.kickUserOffSeatByAdmin)],je.prototype,"kickUserOffSeatByAdmin",null),e([j(ae.lockSeatByAdmin)],je.prototype,"lockSeatByAdmin",null),e([j(ae.startScreenSharing)],je.prototype,"startScreenSharing",null),e([j(ae.stopScreenSharing)],je.prototype,"stopScreenSharing",null),e([j(ae.login),Q()],je,"login",null),e([j(ae.setSelfInfo)],je,"setSelfInfo",null),e([Q()],je,"logout",null),je.callExperimentalAPI(JSON.stringify({api:"setFramework",params:{component:"TUIRoomEngine"}})),exports.Rect=class{constructor(e=0,t=0,n=0,o=0){this.left=e,this.top=t,this.right=n,this.bottom=o}},exports.TRTCCloud=_e,exports.TRTCDeviceInfo=class{constructor(e="",t="",n="",o="",i=""){this.deviceId=e,this.deviceName=t,this.kind=n,this.label=o,this.groupId=i}},exports.TRTCImageBuffer=xe,exports.TRTCLocalStatistics=class{constructor(e=0,t=0,n=0,o=0,i=0,s=0,a=exports.TRTCVideoStreamType.TRTCVideoStreamTypeBig){this.width=e,this.height=t,this.frameRate=n,this.videoBitrate=o,this.audioSampleRate=i,this.audioBitrate=s,this.streamType=a}},exports.TRTCMixUser=class{constructor(e="",t="",n=null,o=0,i=!1,s=exports.TRTCVideoStreamType.TRTCVideoStreamTypeBig,a=exports.TRTCMixInputType.TRTCMixInputTypeUndefined,r=0){this.userId=e,this.roomId=t,this.rect=n,this.zOrder=o,this.pureAudio=i,this.streamType=s,this.inputType=a,this.renderMode=r}},exports.TRTCNetworkQosParam=class{constructor(e=exports.TRTCVideoQosPreference.TRTCVideoQosPreferenceClear,t=exports.TRTCQosControlMode.TRTCQosControlModeServer){this.preference=e,this.controlMode=t}},exports.TRTCParams=class{constructor(e=0,t="",n="",o=0,i="",s=exports.TRTCRoleType.TRTCRoleAnchor,a=null,r=null,c=null,u=null,l=30){this.sdkAppId=e,this.userId=t,this.userSig=n,this.roomId=o,this.strRoomId=i,this.role=s,this.privateMapKey=a,this.streamId=c,this.userDefineRecordId=u,this.frameWorkType=l}},exports.TRTCPublishCDNParam=class{constructor(e=0,t=0,n=null){this.appId=e,this.bizId=t,this.url=n}},exports.TRTCQualityInfo=class{constructor(e="",t=exports.TRTCQuality.TRTCQuality_Unknown){this.userId=e,this.quality=t}},exports.TRTCRenderParams=class{constructor(e=exports.TRTCVideoRotation.TRTCVideoRotation0,t=exports.TRTCVideoFillMode.TRTCVideoFillMode_Fit,n=exports.TRTCVideoMirrorType.TRTCVideoMirrorType_Disable){this.rotation=e,this.fillMode=t,this.mirrorType=n}},exports.TRTCScreenCaptureSourceInfo=class{constructor(e=exports.TRTCScreenCaptureSourceType.TRTCScreenCaptureSourceTypeUnknown,t="",n="",o=new xe,i=new xe,s=!1){this.type=e,this.sourceId=t,this.sourceName=n,this.thumbBGRA=o,this.iconBGRA=i,this.isMinimizeWindow=s}},exports.TRTCStatistics=class{constructor(e=0,t=0,n=0,o=0,i=0,s=0,a=0,r=[],c=0,u=0){this.upLoss=e,this.downLoss=t,this.appCpu=n,this.systemCpu=o,this.rtt=i,this.receivedBytes=s,this.sentBytes=a,this.localStatisticsArray=r,this.localStatisticsArraySize=c,this.remoteStatisticsArraySize=u}},exports.TRTCTranscodingConfig=class{constructor(e=exports.TRTCTranscodingConfigMode.TRTCTranscodingConfigMode_Unknown,t=0,n=0,o=0,i=0,s=0,a=15,r=2,c=0,u="",l=64,d=48e3,p=1,_=[],h=""){this.mode=e,this.appId=t,this.bizId=n,this.videoWidth=o,this.videoHeight=i,this.videoBitrate=s,this.videoFramerate=a,this.videoGOP=r,this.backgroundColor=c,this.backgroundImage=u,this.audioSampleRate=l,this.audioBitrate=d,this.audioChannels=p,this.mixUsersArray=_,this.mixUsersArraySize=_.length,this.streamId=h}},exports.TRTCVideoEncParam=class{constructor(e=exports.TRTCVideoResolution.TRTCVideoResolution_640_360,t=15,n=550){this.videoResolution=e,this.videoFps=t,this.videoBitrate=n}},exports.TRTCVolumeInfo=class{constructor(e="",t=0){this.userId=e,this.volume=t}},exports.TUIConferenceInvitationManager=ve,exports.TUIConferenceListManager=ye,exports.TUIRoomDeviceManager=pe,exports.TUIRoomEngine=je,exports.default=je;
